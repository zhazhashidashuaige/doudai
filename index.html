<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>EPhone - Êô∫ËÉΩËÅäÂ§©Â∫îÁî®</title>
    
    <!-- ‚ñº‚ñº‚ñº PWAÂÖ®Â±èÈÖçÁΩÆ ‚ñº‚ñº‚ñº -->
    <!-- 1. PWA ManifestÊñá‰ª∂ -->
    <link rel="manifest" href="manifest.json">
    
    <!-- 2. ËãπÊûúËÆæÂ§áÂÖ®Â±èÊîØÊåÅ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EPhone">
    
    <!-- 3. ÂÆâÂçìËÆæÂ§áÂÖ®Â±èÊîØÊåÅ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007bff">
    
    <!-- 4. Â∫îÁî®ÂõæÊ†áÈÖçÁΩÆ -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="icon-57x57.png">
    <link rel="apple-touch-icon" sizes="29x29" href="icon-29x29.png">
    <link rel="apple-touch-icon" href="icon-180x180.png">
    <meta name="msapplication-TileImage" content="icon-144x144.png">
    <meta name="msapplication-TileColor" content="#007bff">
    
    <!-- 5. Èò≤Ê≠¢Áº©ÊîæÂíåÈÄâÊã© -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- ‚ñ≤‚ñ≤‚ñ≤ PWAÈÖçÁΩÆÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- PWA Service Worker Ê≥®ÂÜå -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                });
            });
        }
        
        // PWAÂÆâË£ÖÊèêÁ§∫
        let deferredPrompt;
        let installButton;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA: ÂÆâË£ÖÊèêÁ§∫ÂèØÁî®');
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        // Ê£ÄÊµãÊòØÂê¶Â∑≤ÂÆâË£Ö
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA: Â∫îÁî®Â∑≤ÂÆâË£Ö');
            if (installButton) {
                installButton.remove();
            }
            showInstallSuccessMessage();
        });
        
        function showInstallButton() {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòæÁ§∫ËøáÂÆâË£ÖÊåâÈíÆ
            if (document.getElementById('pwa-install-btn')) {
                return;
            }
            
            installButton = document.createElement('button');
            installButton.id = 'pwa-install-btn';
            installButton.innerHTML = 'üì± ÂÆâË£ÖÂà∞Ê°åÈù¢';
            installButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0,123,255,0.4);
                transition: all 0.3s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                animation: slideInRight 0.5s ease-out;
            `;
            
            // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
            installButton.addEventListener('mouseenter', () => {
                installButton.style.transform = 'translateY(-2px)';
                installButton.style.boxShadow = '0 6px 20px rgba(0,123,255,0.6)';
            });
            
            installButton.addEventListener('mouseleave', () => {
                installButton.style.transform = 'translateY(0)';
                installButton.style.boxShadow = '0 4px 15px rgba(0,123,255,0.4)';
            });
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`PWA: Áî®Êà∑ÈÄâÊã© ${outcome}`);
                    deferredPrompt = null;
                    installButton.remove();
                }
            });
            
            document.body.appendChild(installButton);
            
            // 10ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                if (installButton && installButton.parentNode) {
                    installButton.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => {
                        if (installButton && installButton.parentNode) {
                            installButton.remove();
                        }
                    }, 500);
                }
            }, 10000);
        }
        
        function showInstallSuccessMessage() {
            const successMsg = document.createElement('div');
            successMsg.innerHTML = '‚úÖ Â∫îÁî®Â∑≤ÊàêÂäüÂÆâË£ÖÂà∞Ê°åÈù¢ÔºÅ';
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(40,167,69,0.4);
                animation: slideInRight 0.5s ease-out;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 500);
                }
            }, 3000);
        }
        
        // Ê∑ªÂä†CSSÂä®Áîª
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Ê£ÄÊµãÊòØÂê¶Âú®ÂÖ®Â±èÊ®°Âºè
        function checkFullscreenMode() {
            if (window.matchMedia('(display-mode: fullscreen)').matches) {
                console.log('Â∫îÁî®Âú®ÂÖ®Â±èÊ®°ÂºèËøêË°å');
                document.body.classList.add('fullscreen-mode');
            } else if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('Â∫îÁî®Âú®Áã¨Á´ãÊ®°ÂºèËøêË°å');
                document.body.classList.add('standalone-mode');
            }
        }
        
        // ÊâãÊú∫ÊµèËßàÂô®ÂÖ®Â±èÈÄÇÈÖç - ÈÅøÂÖçÂØºËà™Êù°ÈÅÆÊå°
        function adaptMobileFullscreen() {
            const phoneScreen = document.getElementById('phone-screen');
            if (phoneScreen) {
                // ‰ΩøÁî®100%ËÄå‰∏çÊòØ100vhÔºåÈÅøÂÖçÂØºËà™Êù°ÈÅÆÊå°
                phoneScreen.style.width = '100%';
                phoneScreen.style.height = '100%';
                
                // Á°Æ‰øùÂÜÖÂÆπÂå∫Âüü‰∏ç‰ºöË¢´ÂØºËà™Êù°ÈÅÆÊå°
                const chatInputArea = document.getElementById('chat-input-area');
                if (chatInputArea) {
                    // ‰∏∫Â∫ïÈÉ®ËæìÂÖ•Âå∫ÂüüÊ∑ªÂä†ÂÆâÂÖ®ËæπË∑ù
                    chatInputArea.style.paddingBottom = 'env(safe-area-inset-bottom, 0px)';
                }
                
                console.log('Â∑≤Â∫îÁî®ÊâãÊú∫ÊµèËßàÂô®ÂÖ®Â±èÈÄÇÈÖç');
                console.log('ËßÜÂè£Â∞∫ÂØ∏:', window.innerWidth + 'x' + window.innerHeight);
                console.log('ÂÖÉÁ¥†Â∞∫ÂØ∏:', phoneScreen.offsetWidth + 'x' + phoneScreen.offsetHeight);
            }
        }
        
        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        function handleResize() {
            adaptMobileFullscreen();
            checkFullscreenMode();
        }
        
        window.addEventListener('load', () => {
            adaptMobileFullscreen();
            checkFullscreenMode();
        });
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);
    </script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
               /* ‚ñº‚ñº‚ñº SafariÈîÆÁõòÈÄÇÈÖçÔºöËØ∑Áî®‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢Êéâ‰Ω†Áé∞ÊúâÁöÑ html, body, Âíå #phone-screen Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* --- ËØ∑Áî®‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢Êéâ‰Ω†Áé∞ÊúâÁöÑ html, body, Âíå #phone-screen Ê†∑Âºè --- */
        
        /* 1. ÈáçÁΩÆ html ÂÖÉÁ¥† - ÊâãÊú∫ÊµèËßàÂô®ÈÄÇÈÖç */
        html {
            -webkit-text-size-adjust: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* 2. ËÆæÁΩÆ body ‰∏∫ÂÖ®Â±èÁîªÂ∏É - ÊâãÊú∫ÊµèËßàÂô®ÈÄÇÈÖç */
        body {
            margin: 0;
            padding: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5;
            height: 100%;
            overflow: hidden;
            position: relative;
            /* ÊâãÊú∫ÊµèËßàÂô®‰ºòÂåñ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- Start of Replacement Code --- */
        
        #phone-screen {
            /* ÊâãÊú∫ÊµèËßàÂô®ÂÖ®Â±èÈÄÇÈÖç - ÈÅøÂÖçÂØºËà™Êù°ÈÅÆÊå° */
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* PWAÂÖ®Â±èÊ®°Âºè‰ºòÂåñ - Áî±‰∫éÂ∑≤‰ΩøÁî®viewportÂçï‰ΩçÔºåËøôÈáå‰∏ªË¶ÅÂ§ÑÁêÜÁâπÊÆäÊ†∑Âºè */
        .fullscreen-mode #phone-screen,
        .standalone-mode #phone-screen {
            /* ‰øùÊåÅviewportÂçï‰ΩçËÆæÁΩÆ */
            border-radius: 0;
            box-shadow: none;
        }
        
        /* ÂÖ®Â±èÊ®°Âºè‰∏ãÁöÑÁä∂ÊÄÅÊ†èÈÄÇÈÖç */
        .fullscreen-mode .status-bar,
        .standalone-mode .status-bar {
            padding-top: env(safe-area-inset-top);
        }
        
        /* ÂÖ®Â±èÊ®°Âºè‰∏ãÁöÑÂ∫ïÈÉ®ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖç */
        .fullscreen-mode .chat-input-area,
        .standalone-mode .chat-input-area {
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }
        
        /* ÈöêËóèPWAÂÆâË£ÖÊåâÈíÆÂú®ÂÖ®Â±èÊ®°Âºè‰∏ã */
        .fullscreen-mode #pwa-install-btn,
        .standalone-mode #pwa-install-btn {
            display: none !important;
        }
        
        /* ViewportÂçï‰ΩçÂÖ®Â±èÊñπÊ≥ï - Á°Æ‰øùÊâÄÊúâÂÆπÂô®ÈÉΩ‰ΩøÁî®viewportÂçï‰Ωç */
        * {
            box-sizing: border-box;
        }
        
        /* Á°Æ‰øù‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü‰πü‰ΩøÁî®viewportÂçï‰Ωç */
        .main-content {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ËÅäÂ§©Ê∂àÊÅØÂå∫ÂüüÈÄÇÈÖçviewport */
        #chat-messages {
            width: 100%;
            height: calc(100vh - 120px); /* ÂáèÂéªËæìÂÖ•Âå∫ÂüüÈ´òÂ∫¶ */
            overflow-y: auto;
        }
        
        /* ËÅäÂ§©ÂàóË°®Âå∫ÂüüÈÄÇÈÖçviewport */
        #chat-list-screen {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Á°Æ‰øùÊâÄÊúâÂ±èÂπïÈÉΩÈÄÇÈÖçÊâãÊú∫ÊµèËßàÂô® */
        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
        }
        
        /* ÊâãÊú∫ÊµèËßàÂô®ÂÖ®Â±è‰ºòÂåñ */
        @media screen and (max-width: 768px) {
            #phone-screen {
                /* Âú®ÊâãÊú∫ËÆæÂ§á‰∏äÁ°Æ‰øùÂÆåÂÖ®Â°´Êª°Â±èÂπï */
                min-height: 100vh;
                min-height: -webkit-fill-available; /* Safari ÊîØÊåÅ */
            }
            
            /* Á°Æ‰øùËÅäÂ§©Ê∂àÊÅØÂå∫ÂüüÂú®ÊâãÊú∫‰∏äÊúâË∂≥Â§üÁ©∫Èó¥ */
            #chat-messages {
                height: calc(100vh - 140px); /* ‰∏∫ËæìÂÖ•Âå∫ÂüüÁïôÂá∫Á©∫Èó¥ */
                height: calc(-webkit-fill-available - 140px); /* Safari ÊîØÊåÅ */
            }
            
            /* ÊâãÊú∫ÊµèËßàÂô®Â∫ïÈÉ®ÂÆâÂÖ®Âå∫Âüü */
            #chat-input-area {
                padding-bottom: max(8px, env(safe-area-inset-bottom, 8px));
            }
        }
        
        #chat-input-area {
            flex-shrink: 0;
            padding: 8px;
            /* ÊâãÊú∫ÊµèËßàÂô®ÈÄÇÈÖç - ÈÅøÂÖçÂØºËà™Êù°ÈÅÆÊå° */
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 20px)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            /* Á°Æ‰øùÂú®ÊâãÊú∫ÊµèËßàÂô®‰∏≠ÂèØËßÅ */
            position: relative;
            z-index: 10;
            gap: 5px;
        }
        
        /* --- End of Replacement Code --- */
/* --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëËøôÊòØÊéßÂà∂Áä∂ÊÄÅÊ†èÊòæÈöêÁöÑÊñ∞Ê†∑Âºè --- */

/* 1. ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåÁä∂ÊÄÅÊ†è‰æùÁÑ∂ÊòØÈöêËóèÁöÑ */
#status-bar {
    display: none;
    /* (ÂéüÊúâÁöÑÂÖ∂‰ªñÊ†∑ÂºèÔºåÂ¶ÇÈ¢úËâ≤„ÄÅÂ≠ó‰ΩìÁ≠âÔºå‰øùÊåÅ‰∏çÂèòÂç≥ÂèØ) */
    padding: 0 20px;
    height: 40px;
    color: white;
    background-color: transparent; /* ËÉåÊôØÁî±Áà∂ÂÖÉÁ¥†ÊéßÂà∂ */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    pointer-events: none; /* ËÆ©ÁÇπÂáªÂèØ‰ª•Á©øÈÄè */
}

/* 2. ÂΩì #phone-screen ÂÖÉÁ¥†Êã•Êúâ .status-bar-visible Ëøô‰∏™ class Êó∂ÔºåÊòæÁ§∫Áä∂ÊÄÅÊ†è */
#phone-screen.status-bar-visible #status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        
        .header, .qzone-header {
            position: relative;
            z-index: 15;
            flex-shrink: 0;
            padding: 15px 20px;
            /* Ê†∏ÂøÉÔºö‰ΩøÁî® calc() Ëá™Âä®Âä†‰∏äÈ°∂ÈÉ®ÁöÑÂÆâÂÖ®Ë∑ùÁ¶ª */
            padding-top: calc(15px + env(safe-area-inset-top)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        
        #status-bar { 
            display: none; 
        }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        
        .header .action-btn {
            font-size: 16px; /* ‰∏ìÈó®‰∏∫‚Äú‰∏ä‰º†‚Äù„ÄÅ‚Äú+‚ÄùÁ≠âÊñáÂ≠óÊåâÈíÆÁº©Â∞èÂ≠óÂè∑ */
            font-weight: 600; /* ÂèØ‰ª•Âä†Á≤ó‰∏ÄÁÇπËÆ©ÂÆÉÊõ¥Ê∏ÖÊô∞ */
        }
        
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô„Äê‰∏ÄÊï¥Âùó‰ª£Á†Å„ÄëÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊÇ®Áé∞ÊúâÁöÑ #home-screen, #clock-container, Âíå #app-grid Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* --- Start of Replacement Code --- */
        
        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            padding-left: 20px;
            padding-right: 20px;
            /* We remove vertical padding here to rely on margins */
        }
        
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: 0 3px 8px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            flex-shrink: 0;
            /* This is the key: pushes the clock down from the top edge */
            margin-top: calc(60px + env(safe-area-inset-top));
        }
        
        /* --- End of Replacement Code --- */
        
        /* 3. Â∞ÜAppÂõæÊ†áÁΩëÊ†º‰Ωú‰∏∫‰∏Ä‰∏™Êï¥‰ΩìÔºåÁî® margin ‰ªéÂ±èÂπïÂ∫ïÈÉ®Êé®‰∏äÊù• */
        #app-grid {
            margin-top: auto; /* Ëá™Âä®Ë¥¥Á¥ßÂ∫ïÈÉ® */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            /* ÂÖ≥ÈîÆÔºö‰ΩøÁî® margin-bottom Êä¨È´òÂõæÊ†áÔºåÈÄÇÈÖçÂ∫ïÈÉ®‚ÄúÂ∞èÈªëÊù°‚Äù */
            margin-bottom: calc(30px + env(safe-area-inset-bottom)); 
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        #main-time {
            font-size: 88px; /* Êé®ËçêÔºöÁ®çÂæÆË∞ÉÂ§ß‰∏ÄÁÇπÁÇπÔºåÊõ¥Êé•ËøëiOSÈîÅÂ±èÁöÑÊÑüËßâ */
            font-weight: 600; /* Ê†∏ÂøÉ‰øÆÊîπ1ÔºöÂ∞ÜÂ≠ó‰Ωì‰ªé‚ÄúÁ∫§ÁªÜ(200)‚ÄùÊîπ‰∏∫‚ÄúÁ≤ó‰Ωì(600)‚ÄùÔºåËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰∏ÄÊ≠• */
            letter-spacing: -2px; /* Êé®ËçêÔºöÁ®çÂæÆÊî∂Á¥ßÂ≠óÈó¥Ë∑ùÔºåËÆ©Êï∞Â≠óÁúãËµ∑Êù•Êõ¥Á¥ßÂáë */
            /* Ê†∏ÂøÉ‰øÆÊîπ2ÔºöÊåáÂÆöÂ≠ó‰ΩìÔºå‰ºòÂÖà‰ΩøÁî®ËãπÊûúÁ≥ªÁªüÂ≠ó‰Ωì */
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
        }
        #main-date { 
            font-size: 22px; /* Á®çÂæÆÊîæÂ§ß‰∏ÄÁÇπÊõ¥ÂçèË∞É */
            font-weight: normal; /* ËãπÊûúÈ£éÊ†ºÁöÑÂ∏∏ËßÑ‰ΩìÊó•Êúü */
        }
        
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        /* ‰øÆÊîπÂêéÁöÑ #world-book-list Ê†∑Âºè */
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 80px;
            margin-top: -80px;
        }
        
        /* ‰øÆÊîπÂêéÁöÑ #chat-list Ê†∑ÂºèÔºåÂéªÊéâ‰∫Ü padding Âíå margin */
        #chat-list {
            flex-grow: 1;
            background-color: var(--secondary-bg);
            padding-top: 80px; 
            padding-bottom: 90px; /* ‰∏∫Â∫ïÈÉ®ÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥ */
            box-sizing: border-box;
        }
        
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        
        /* ‚ñº‚ñº‚ñº Áî®ËøôÂùó‰ª£Á†ÅÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ #chat-messages Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden; /* Ê†∏ÂøÉ‰øÆÊ≠£1: Âº∫Âà∂Á¶ÅÊ≠¢Ê∞¥Âπ≥ÊªöÂä®/ÊãñÂä® */
            padding: 10px 15px; /* Ê†∏ÂøÉ‰øÆÊ≠£2: Â∞ÜÂ∑¶Âè≥ÂÜÖËæπË∑ùÂ¢ûÂä†Âà∞15pxÔºåÊèê‰æõÊõ¥Â§öÂëºÂê∏Á©∫Èó¥ */
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box; /* Á°Æ‰øùÂÜÖËæπË∑ùËÆ°ÁÆóÊ≠£Á°Æ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        
        .message-wrapper.ai .sender-name {
            margin-left: 50px; /* Á®çÂæÆË∞ÉÊï¥Ôºå‰∏éÂ§¥ÂÉèÂØπÈΩê */
            margin-bottom: 3px;
            position: absolute; /* ËÆ©ÂÆÉËÑ±Á¶ªÊµÅÔºåÈÅøÂÖçÂΩ±ÂìçÊ∞îÊ≥°ÂØπÈΩê */
            top: -16px;       /* ÂÆö‰ΩçÂà∞Ê∞îÊ≥°‰∏äÊñπ */
            left: 0;
        }
        
        /* === „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÂ∏ÉÂ±Ä‰∏éÊó∂Èó¥Êà≥Ê†∑Âºè === */
        
        /* 1. Ê∂àÊÅØÂçïÂÖÉÁöÑÊÄªÂÆπÂô® (ÈáçÊûÑ) */
        .message-wrapper {
            display: flex;          /* ‰ΩøÁî®FlexÂ∏ÉÂ±Ä */
            gap: 8px;               /* Ê∞îÊ≥°ÂíåÊó∂Èó¥Êà≥‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            align-items: flex-end;  /* Ê†∏ÂøÉÔºöËÆ©Ê∞îÊ≥°ÂíåÊó∂Èó¥Êà≥Â∫ïÈÉ®ÂØπÈΩê */
            position: relative;
            max-width: 90%;         /* ÂèØ‰ª•Á®çÂæÆÊîæÂÆΩ‰∏ÄÁÇπÔºåÂõ†‰∏∫Êó∂Èó¥Êà≥Áé∞Âú®Âú®Â§ñÈù¢‰∫Ü */
        }
        
        /* 2. AIÊ∂àÊÅØÂçïÂÖÉÈù†Â∑¶ */
        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row; /* Â§¥ÂÉè„ÄÅÊ∞îÊ≥°„ÄÅÊó∂Èó¥Êà≥Ôºå‰ªéÂ∑¶Âà∞Âè≥ÊéíÂàó */
        }
        
        /* 3. Áî®Êà∑Ê∂àÊÅØÂçïÂÖÉÈù†Âè≥ */
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse; /* Êó∂Èó¥Êà≥„ÄÅÊ∞îÊ≥°„ÄÅÂ§¥ÂÉèÔºå‰ªéÂè≥Âà∞Â∑¶ÊéíÂàó */
        }
        
        /* 4. Ê∞îÊ≥°ÂíåÂ§¥ÂÉèÁöÑÁõ¥Êé•ÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
            min-width: 0; /* <-- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂÖÅËÆ∏Ê∞îÊ≥°ÂÆπÂô®Ëá™Ë∫´Êî∂Áº© */
        }
        
        .timestamp {
            /* ÁßªÈô§ÊóßÁöÑ position: absolute */
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            white-space: nowrap; /* Èò≤Ê≠¢Êó∂Èó¥Êç¢Ë°å */
            margin-bottom: 5px;  /* ËÆ©ÂÆÉÂíåÊ∞îÊ≥°Â∫ïÈÉ®ÊúâËΩªÂæÆÁöÑÂØπÈΩêÂÅèÁßªÔºåÊõ¥ÁæéËßÇ */
            flex-shrink: 0;      /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
        }
        
        .message-bubble.selected::after { content: '‚úî'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        
        
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 15;
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Ê†∏ÂøÉÔºö‰∏∫Â∫ïÈÉ®Â¢ûÂä†ÂÆâÂÖ®Ë∑ùÁ¶ª */
            padding-bottom: env(safe-area-inset-bottom);
        }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        /* --- ËØ∑Áî®ËøôÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ #chat-input Ê†∑Âºè --- */
#chat-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    /* Ê†∏ÂøÉ‰øÆÊîπ 1: ËÆæÁΩÆ‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÈ´òÂ∫¶Ôºå‰æãÂ¶Ç 40px */
    height: 40px; 
    /* Ê†∏ÂøÉ‰øÆÊîπ 2: ÁßªÈô§ max-height Â±ûÊÄß */
    /* max-height: 100px; */ 
    resize: none;
    /* Ê†∏ÂøÉ‰øÆÊîπ 3: ÂΩìÂÜÖÂÆπË∂ÖÂá∫È´òÂ∫¶Êó∂ÔºåÊòæÁ§∫ÊªöÂä®Êù° */
    overflow-y: auto; 
    box-sizing: border-box; /* Êé®ËçêÊ∑ªÂä†ÔºåÁ°Æ‰øùÂÜÖËæπË∑ùËÆ°ÁÆóÊ≠£Á°Æ */
}
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }
        #notification-bar.visible {
            /* ÂÖ≥ÈîÆÔºöÂú®YËΩ¥ÂõûÂà∞Âéü‰ΩçÁöÑÂêåÊó∂Ôºå‰øùÊåÅXËΩ¥ÁöÑÂ±Ö‰∏≠ÂèòÊç¢ */
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        /* ‚ñº‚ñº‚ñº SafariÂºπÁ™óÈò≤ÊîæÂ§ß‰øÆÊ≠£ÔºöËØ∑Áî®ËøôÂùóÊñ∞Ê†∑ÂºèÊõøÊç¢ÊóßÁöÑ .custom-modal-body input Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        .custom-modal-body input {
            width: 100%;
            padding: 8px 12px; /* Êé®ËçêÔºöÁ®çÂæÆÂ¢ûÂä†ÂÜÖËæπË∑ùÔºåËÆ©ËæìÂÖ•Ê°ÜÊõ¥Â•ΩÁúã */
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px; /* Ê†∏ÂøÉ‰øÆÊ≠£Ôºö‰ªé 14px ÊèêÈ´òÂà∞ 16px Èò≤Ê≠¢Ëá™Âä®ÊîæÂ§ß */
            box-sizing: border-box;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect {
            position: relative;
            -webkit-user-select: none; /* ÂÖºÂÆπ Safari */
            user-select: none;
        }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        
        .checkboxes-container {
            display: none;
            position: absolute;
            /* Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏çÂÜç‰ΩøÁî® topÔºåËÄåÊòØÁî® margin-top Êù•ÂàõÈÄ†Èó¥Ë∑ùÔºåÊõ¥Á®≥ÂÆö */
            top: 100%; 
            margin-top: 5px; /* <-- Êñ∞Â¢ûÔºöÂêë‰∏ãÊé®ÂºÄ5ÂÉèÁ¥†ÁöÑË∑ùÁ¶ª */
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 101;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        
        .checkboxes-container label {
            display: block;
            padding: 12px 15px; /* <-- ‰øÆÊîπÔºöÂ¢ûÂä†‰∫Ü‰∏ä‰∏ãÂíåÂ∑¶Âè≥ÁöÑÂÜÖËæπË∑ùÔºåËÆ©ÊØè‰∏ÄË°åÊõ¥È´òÊõ¥ÂÆΩ */
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
            font-size: 15px; /* <-- Êñ∞Â¢ûÔºöÂ∞ÜÂ≠ó‰ΩìÂ§ßÂ∞è‰ªéÈªòËÆ§ÂÄºÊîæÂ§ßÂà∞15px */
        }
        
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration {
            /* --- Ê†∏ÂøÉ‰øÆÊ≠£ --- */
            font-size: var(--chat-font-size, 13px);
            /* --- ‰øÆÊ≠£ÁªìÊùü --- */
            font-weight: 500;
            color: var(--text-secondary);
        }
        .message-bubble.user .voice-duration { color: #3e6224; }
        
        /* ‚ñº‚ñº‚ñº Áî®ËøôÂùó‰ª£Á†ÅÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ .message-bubble .content Ê†∑Âºè ‚ñº‚ñº‚ñº */
        /* ÈÄöÁî®ÂÜÖÂÆπÂå∫Ê†∑ÂºèÔºå‰∏∫Êó∂Èó¥Êà≥ÂíåÂ≠ó‰ΩìÂ§ßÂ∞èÂÅöÂáÜÂ§á */
        .message-bubble .content {
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
            word-break: break-word; /* Ê†∏ÂøÉ‰øÆÊ≠£: Âº∫Âà∂ÈïøÂçïËØçÊàñURLÊç¢Ë°åÔºåÈò≤Ê≠¢ÊíëÁ†¥Ê∞îÊ≥° */
        
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === Ê∞îÊ≥°‰∏ªÈ¢òÊ†∑Âºè === */
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
              
        .message-bubble::after {
            content: "";
            position: absolute;
            width: 20px;  
            height: 20px; 
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 1; 
            z-index: 1;
        }
              
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        
        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'üêæ'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
       .playlist-body {
    flex-grow: 1;
    overflow-y: auto;
    /* Ê†∏ÂøÉ‰øÆÂ§çÔºöÂ∞Ü padding-bottom ÊòæËëóÂ¢ûÂ§ßÔºåÁ°Æ‰øùÊúÄÂêé‰∏ÄÊù°Ê≠åÊõ≤‰∏ç‰ºöË¢´ÈÅÆÊå° */
    /* ÂêåÊó∂‰ΩøÁî® box-sizing Á°Æ‰øùÂÜÖËæπË∑ùËÆ°ÁÆóÊ≠£Á°Æ */
    padding: 10px 0 80px 0;
    box-sizing: border-box;
}
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }
        
        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }
        
        /* ËøôÊòØ‰Ω†Ë¶ÅÊ∑ªÂä†ÁöÑÊñ∞Ê†∑Âºè */
        #font-preview {
            transition: font-family 0.3s ease;}
        
        /* === ËÅäÂ§©ÂàóË°®ÁïåÈù¢Êñ∞Â¢ûÊ†∑Âºè (ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑ) === */
        #chat-list-screen {
        }
        
        .chat-list-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1; 
        }
        .chat-list-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 2; 
        }
        
        #messages-view {
            overflow-y: auto; 
        }
        
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        /* === Âä®ÊÄÅÁïåÈù¢ (QZone) Ê†∑Âºè (ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑ) === */
        #qzone-screen {
            background-color: #f0f2f5;
        }
        
        .qzone-header {
            /* position: absolute;  <-- ÊääËøô‰∏™ÊîπÊàê relative */
            position: relative;
            z-index: 10; /* z-index ‰øùÊåÅÔºåÊàñËÄÖÂèØ‰ª•Êõ¥È´ò */
            flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            padding: 15px 20px;
            padding-top: 45px;
            background-color: rgba(247, 247, 247, 0.7); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .qzone-header .back-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--accent-color);
        }
        
        .qzone-header span:nth-child(2) { /* "Â•ΩÂèãÂä®ÊÄÅ"ÊñáÂ≠ó */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
            /* padding-top: 80px;  <-- Âà†Èô§Ëøô‰∏™ÔºåÂõ†‰∏∫header‰∏çÂÜçÊòØabsolute‰∫Ü */
        }
        
        .qzone-profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        
        .qzone-banner-container {
            width: 100%;
            height: 180px; /* ËÉåÊôØÊùøÈ´òÂ∫¶ */
            position: relative;
        }
        
        #qzone-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .qzone-user-info {
            position: absolute;
            bottom: -30px; /* ËÆ©Â§¥ÂÉèÂíåÊòµÁß∞Âå∫ÂüüÂêë‰∏ãÂÅèÁßªÔºå‰∏ÄÂçäÂú®ËÉåÊôØÊùøÂÜÖÔºå‰∏ÄÂçäÂú®Â§ñ */
            left: 20px;
            display: flex;
            align-items: flex-end; /* ËÆ©ÊòµÁß∞ÂíåÂ§¥ÂÉèÂ∫ïÈÉ®ÂØπÈΩê */
            gap: 10px;
        }
        
        .qzone-avatar-container {
            position: relative;
        }
        
        #qzone-avatar-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        
        #qzone-nickname {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            padding-bottom: 5px; /* ÂæÆË∞É‰ΩçÁΩÆ */
        }
        
        /* ÁºñËæëÊåâÈíÆÁöÑÈÄöÁî®Ê†∑Âºè */
        .qzone-edit-btn {
            position: absolute;
            background-color: rgba(0,0,0,0.4);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        #change-qzone-banner-btn {
            bottom: 10px;
            right: 10px;
        }
        
        #change-qzone-avatar-btn {
            bottom: 5px;
            right: 5px;
        }
        
        #change-qzone-nickname-btn {
            font-size: 14px;
            padding: 2px 6px;
            margin-left: 5px; /* ‰∏éÊòµÁß∞ÁöÑÈó¥Ë∑ù */
            color: var(--text-primary);
            background-color: rgba(255,255,255,0.7);
            border-radius: 5px;
            position: relative; /* ËÑ±Á¶ªflexÂ∏ÉÂ±ÄÁöÑÂØπÈΩê */
            bottom: 5px; /* ÂæÆË∞ÉÂûÇÁõ¥‰ΩçÁΩÆ */
        }
        
        /* === ËÆ©ÁºñËæëÂäüËÉΩÊõ¥‚ÄúÈöêÂΩ¢‚Äù === */
        #qzone-banner-container,
        #qzone-avatar-container,
        #qzone-nickname {
            cursor: pointer; /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫‰∏∫ÂèØÁÇπÂáªÊâãÂäø */
            transition: opacity 0.2s;
        }
        #qzone-banner-container:hover,
        #qzone-avatar-container:hover,
        #qzone-nickname:hover {
            opacity: 0.85; /* ÊÇ¨ÂÅúÊó∂Á®çÂæÆÂèòÊöóÔºåÁªôÁî®Êà∑ÂèçÈ¶à */
        }
        /* ÈöêËóèÊéâÊóßÁöÑ„ÄÅÁã¨Á´ãÁöÑÁºñËæëÊåâÈíÆ */
        .qzone-edit-btn {
            display: none;
        }
        
        /* === ÊéßÂà∂ Header Âíå Bottom Nav ÁöÑÊòæÈöê === */
        /* ÈªòËÆ§ÈöêËóèÂä®ÊÄÅÁïåÈù¢ÁöÑ Header */
        #qzone-screen .qzone-header {
            display: none;
        }
        /* ÂΩìÂä®ÊÄÅËßÜÂõæÊøÄÊ¥ªÊó∂ÔºåÊòæÁ§∫ÂÆÉÁöÑHeader */
        #qzone-screen.active .qzone-header {
            display: flex;
        }
        
        /* ÂΩìËøõÂÖ•Âä®ÊÄÅËßÜÂõæÊó∂ÔºåÈöêËóè‰∏ªHeaderÂíåÂ∫ïÈÉ®ÂØºËà™Ê†è */
        #chat-list-screen.in-qzone-view > .header,
        #chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
            display: none;
        }
        
        .chat-list-item:first-child,
        .chat-group-container:first-child {
            margin-top: 10px; 
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ÊääÊâÄÊúâËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === Âä®ÊÄÅÂäüËÉΩÊ†èÊ†∑Âºè === */
        .qzone-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin: 40px 15px 15px 15px; /* ‰∏äËæπË∑ùÊõ¥Â§ßÔºå‰∏∫ÊµÆÂä®ÁöÑÂ§¥ÂÉèÁïôÂá∫Á©∫Èó¥ */
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .action-item {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        
        /* Áî®‰º™ÂÖÉÁ¥†ÂàõÂª∫ÂàÜÈöîÁ∫ø */
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }
        
        /* === Âä®ÊÄÅÂ∏ñÂ≠êÂàóË°®Ê†∑Âºè === */
        #qzone-posts-list {
            padding: 0 15px 20px 15px; /* Â∑¶Âè≥ÂíåÂ∫ïÈÉ®ÁïôÂá∫ËæπË∑ù */
            display: flex;
            flex-direction: column;
            gap: 20px; /* Â∏ñÂ≠ê‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        }
        
        .qzone-post-item {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .post-header .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .post-info {
            display: flex;
            flex-direction: column;
        }
        
        .post-info .post-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .post-info .post-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .post-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap; /* ËÆ©Êç¢Ë°åÁ¨¶ÁîüÊïà */
            word-break: break-word; /* Èò≤Ê≠¢ÈïøÂçïËØçÊ∫¢Âá∫ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº Êñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞Êú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === ÂèëÂ∏ÉÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÊ†∑Âºè === */
        #post-public-text {
            min-height: 80px; /* Á°Æ‰øùÊñáÊú¨ÂüüÊúâË∂≥Â§üÁöÑÈ´òÂ∫¶ */
            resize: vertical;
        }
        
        .post-image-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9; /* ‰øùÊåÅ16:9ÁöÑÈ¢ÑËßàÊØî‰æã */
            background-color: #f0f2f5;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none; /* ÈªòËÆ§ÈöêËóè */
            justify-content: center;
            align-items: center;
        }
        .post-image-preview-container.visible {
            display: flex; /* ‰∏ä‰º†ÂêéÊòæÁ§∫ */
        }
        
        #post-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        #post-remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            border: 2px solid white;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        .post-image-upload-options {
            display: flex;
            gap: 10px;
        }
        
        .post-image-upload-options button {
            flex: 1;
            margin-top: 0;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº Êñ∞Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* === ÂèëÂ∏ÉÂä®ÊÄÅÊ®°ÊÄÅÊ°Ü - Ê®°ÂºèÂàáÊç¢Ê†∑Âºè === */
        .post-mode-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .mode-btn.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .post-mode-content {
            display: none; /* ÈªòËÆ§ÈÉΩÈöêËóè */
        }
        
        .post-mode-content.active {
            display: block; /* ÊøÄÊ¥ªÁöÑÊâçÊòæÁ§∫ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === Áõ∏ÂÜåÈ°µÈù¢ËÉåÊôØËâ≤ === */
        #album-screen {
            background-color: #f0f2f5; /* ‰ΩøÁî®‰∏Ä‰∏™ÊüîÂíåÁöÑÊµÖÁÅ∞Ëâ≤ÔºåÊØîÁ∫ØÁôΩÊõ¥Êä§Áúº */
        }
        
        /* === Áõ∏ÂÜåÈ°µÈù¢ÁΩëÊ†ºÂ∏ÉÂ±Ä === */
        #album-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* ÊØèË°åÊòæÁ§∫2‰∏™Áõ∏ÂÜå */
            gap: 15px;
        }
        
        /* === Áõ∏ÂÜåÈ°πÁõÆÊ†∑Âºè (ÁæéÂåñ) === */
        .album-item {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px; /* ÁªôÊï¥‰∏™È°πÁõÆ‰πüÂä†‰∏™ÂúÜËßí */
        }
        
        .album-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .album-cover {
            aspect-ratio: 1 / 1; /* ‰øùÊåÅÂ∞ÅÈù¢‰∏∫Ê≠£ÊñπÂΩ¢ */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f0f2f5; /* Â∞ÅÈù¢Âä†ËΩΩÂâçÁöÑÂç†‰ΩçÈ¢úËâ≤ */
        }
        
        .album-info {
            text-align: center;
        }
        
        .album-name {
            font-weight: 500;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Èò≤Ê≠¢ÈïøÂêçÂ≠óÊç¢Ë°å */
        }
        
        .album-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ CSS Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === Áõ∏ÂÜåÁÖßÁâáËØ¶ÊÉÖÈ°µ === */
        #album-photos-screen {
            background-color: #f0f2f5;
        }
        
        #photos-grid-page {
            padding: 15px;
            display: grid;
            /* ÊØèË°åÊòæÁ§∫3Âº†ÁÖßÁâáÔºåÂπ∂‰øùÊåÅÈó¥Ë∑ù */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-item {
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçÂà†Èô§ÊåâÈíÆ */
            aspect-ratio: 1 / 1; /* ‰øùÊåÅÁÖßÁâá‰∏∫Ê≠£ÊñπÂΩ¢ */
            border-radius: 6px;
            overflow: hidden; /* Èò≤Ê≠¢ÂõæÁâáÊ∫¢Âá∫ÂúÜËßí */
            background-color: #e9ecef; /* ÂõæÁâáÂä†ËΩΩÂâçÁöÑÂç†‰ΩçÁ¨¶È¢úËâ≤ */
        }
        
        .photo-item .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ‰øùËØÅÂõæÁâáÂ°´Êª°ÂÆπÂô®‰∏î‰∏çÂèòÂΩ¢ */
            cursor: pointer;
        }
        
        /* Âà†Èô§ÊåâÈíÆÁöÑÊ†∑Âºè */
        .photo-item .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0; /* ÈªòËÆ§ÈöêËóè */
            transition: opacity 0.2s ease;
        }
        
        /* Èº†Ê†áÊÇ¨ÂÅúÂú®ÁÖßÁâá‰∏äÊó∂ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ */
        .photo-item:hover .photo-delete-btn {
            opacity: 1;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === ÂõæÁâáÊü•ÁúãÂô®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè === */
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1002;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        
        .photo-viewer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        
        #photo-viewer-image {
            max-width: 90vw;  /* ÂõæÁâáÊúÄÂ§ßÂÆΩÂ∫¶‰∏∫ËßÜÂè£ÁöÑ90% */
            max-height: 85vh; /* ÂõæÁâáÊúÄÂ§ßÈ´òÂ∫¶‰∏∫ËßÜÂè£ÁöÑ85% */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* ‰∏∫ÂõæÁâáÁöÑÂàáÊç¢Ê∑ªÂä†‰∏ÄÁÇπÂπ≥ÊªëÁöÑÊ∑°ÂÖ•Ê∑°Âá∫ÊïàÊûú */
            transition: opacity 0.2s ease-in-out;
        }
        
        /* ÂÖ≥Èó≠ÊåâÈíÆ */
        #photo-viewer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 200;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px black;
        }
        
        /* Â∑¶Âè≥ÂØºËà™ÁÆ≠Â§¥ */
        #photo-viewer-modal .nav-arrow {
            position: absolute; /* Áé∞Âú®Êàë‰ª¨Áî®ÁªùÂØπÂÆö‰ΩçÊù•ÊéßÂà∂ÁÆ≠Â§¥ */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px; /* Âú®ÊâãÊú∫Â±èÂπï‰∏äÔºåÂèØ‰ª•Á®çÂæÆÂ∞è‰∏ÄÁÇπ */
            font-weight: 100;
            cursor: pointer;
            padding: 10px; /* Ë∞ÉÊï¥ÂÜÖËæπË∑ù */
        -webkit-user-select: none; /* ÂÖºÂÆπ Safari */
            user-select: none;
            transition: color 0.2s;
            z-index: 1003; /* Á°Æ‰øùÁÆ≠Â§¥Âú®ÊúÄ‰∏äÂ±Ç */
        }
        
        #photo-viewer-prev-btn {
            left: 5px; /* ÂÆö‰ΩçÂ∑¶ÁÆ≠Â§¥ */
        }
        
        #photo-viewer-next-btn {
            right: 5px; /* ÂÆö‰ΩçÂè≥ÁÆ≠Â§¥ */
        }
        
        #photo-viewer-modal .nav-arrow:hover {
            color: white;
        }
        
        /* ÂΩìÁÆ≠Â§¥Ë¢´Á¶ÅÁî®Êó∂ÔºàÊØîÂ¶ÇÁ¨¨‰∏ÄÂº†ÊàñÊúÄÂêé‰∏ÄÂº†Ôºâ */
        #photo-viewer-modal .nav-arrow:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: default;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÂùóÊñ∞CSSÊõøÊç¢Êéâ‰∏ä‰∏ÄÁâàÁöÑ‰∫§‰∫íÂå∫CSS ‚ñº‚ñº‚ñº */
        
        /* === Â∏ñÂ≠êÂÜÖÂÆπÂå∫ - Áõ∏ÂØπÂÆö‰ΩçÂÆπÂô® === */
        /* === Â∏ñÂ≠êÂÜÖÂÆπÂå∫ === */
        .post-main-content {
            /* ÂÆÉÁé∞Âú®Âè™ÊòØ‰∏Ä‰∏™ÊôÆÈÄöÁöÑÂÜÖÂÆπÂÆπÂô®Ôºå‰∏çÂÜçÈúÄË¶ÅÁâπÊÆäÊ†∑Âºè‰∫Ü */
        }
        
        /* === Â∏ñÂ≠ê‰∫íÂä®ÂõæÊ†áÂå∫ (Êñ∞Ê†∑Âºè) === */
        .post-feedback-icons {
            display: flex;
            justify-content: flex-end; /* ËÆ©ÂõæÊ†áÈù†Âè≥ÂØπÈΩê */
            align-items: center;
            gap: 12px;
            padding: 8px 0; /* Ê†∏ÂøÉ‰øÆÊîπÔºöÁªôÂõæÊ†áÂå∫Âüü‰∏ä‰∏ãÂêÑ8pxÁöÑÁïôÁôΩ */
        }
        
        .action-icon {
            cursor: pointer;
            color: var(--text-secondary); /* ÈªòËÆ§ÁÅ∞Ëâ≤ */
            transition: all 0.2s ease-in-out;
        }
        
        .action-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* ÂõæÊ†áÊøÄÊ¥ª(ÁÇπËµû/Êî∂ËóèÂêé)ÁöÑÊ†∑Âºè */
        .action-icon.active {
            color: #ff5252; /* ÊøÄÊ¥ªÂêéÂèòÁ∫¢Ëâ≤ */
            transform: scale(1.1); /* ËΩªÂæÆÊîæÂ§ß */
        }
        
        .action-icon.active.favorite {
            color: #ffc107; /* Êî∂ËóèÁî®ÈªÑËâ≤ */
        }
        
        .action-icon.active svg {
            fill: currentColor; /* ÊøÄÊ¥ªÂêéÂ°´ÂÖÖÈ¢úËâ≤ */
        }
        
        /* ÁÇπÂáªÊó∂ÁöÑÂä®ÁîªÊïàÊûú */
        .animate-like {
            animation: like-bounce 0.4s ease-in-out;
        }
        
        @keyframes like-bounce {
            0%   { transform: scale(1); }
            25%  { transform: scale(0.8); }
            50%  { transform: scale(1.2); }
            75%  { transform: scale(1.05); }
            100% { transform: scale(1.1); }
        }
        
        
        /* === Â∏ñÂ≠êÂ∫ïÈÉ®ËØÑËÆ∫Âå∫Ê†∑Âºè (Áé∞Âú®ÊòØÁã¨Á´ãÈÉ®ÂàÜ) === */
        .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0; /* Áî®‰∏ÄÊù°ÊµÖËâ≤Á∫øÂàÜÈöî */
            display: flex;
            align-items: center;
            gap: 8px; /* Ë∞ÉÊï¥Êï¥‰ΩìÈó¥Ë∑ù */
        }
        
        /* ËØÑËÆ∫Âå∫ÂÆπÂô® */
        .comment-section {
            flex-grow: 1; /* Âç†ÊçÆÂ§ßÈÉ®ÂàÜÁ©∫Èó¥ */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .comment-section .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        /* ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†Êñ∞Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .comment-section {
            position: relative; /* Ê†∏ÂøÉ‰øÆÊ≠£Ôºö‰∏∫ÂºπÁ™óÂª∫Á´ãÂÆö‰ΩçÁöÑÈîöÁÇπ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº SafariÈò≤ÊîæÂ§ß‰øÆÊ≠£ÔºöËØ∑Áî®‰∏ãÈù¢Ëøô‰∏§ÂùóÊñ∞Ê†∑ÂºèÔºåÊõøÊç¢ÊóßÁöÑ .comment-input Âíå .comment-send-btn Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        .comment-section .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background-color: #f0f2f5;
            border-radius: 14px;
            font-size: 16px; /* Ê†∏ÂøÉ‰øÆÊ≠£Ôºö‰ªé 13px ÊèêÈ´òÂà∞ 16px Èò≤Ê≠¢Ëá™Âä®ÊîæÂ§ß */
            outline: none;
        }
        
        /* (Êé®Ëçê) ÂêåÊó∂Ë∞ÉÊï¥ÂèëÈÄÅÊåâÈíÆÔºå‰øùÊåÅËßÜËßâÁªü‰∏Ä */
        .comment-send-btn {
            flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            padding: 8px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 14px;
            font-size: 16px; /* ‰ªé 13px Ë∞ÉÊï¥‰∏∫ 16px */
            font-weight: 500;
            cursor: pointer;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === Êú™ËØªÊ∂àÊÅØÂ∞èÁ∫¢ÁÇπÈÄöÁî®Ê†∑Âºè === */
        .unread-indicator {
            position: absolute;
            top: -8px;      
            right: -15px;    
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background-color: #ff3b30;
            color: white;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: none;
            z-index: 1;
        }
        
        /* ËÅäÂ§©ÁïåÈù¢ËøîÂõûÊåâÈíÆ‰∏äÁöÑÂ∞èÁ∫¢ÁÇπ (Âè™ÊòæÁ§∫ÁÇπÔºå‰∏çÊòæÁ§∫Êï∞Â≠ó) */
        .back-btn-indicator {
            top: 0;
            right: -8px; /* ÊîæÂà∞ËøîÂõûÁÆ≠Â§¥Âè≥‰∏äËßí */
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            border-radius: 50%;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === ËØÑËÆ∫ÂàóË°®ÂÆπÂô® === */
        .post-comments-container {
            padding: 10px 0; /* ‰∏ä‰∏ãÁïôÁôΩ */
            display: flex;
            flex-direction: column;
            gap: 8px; /* ËØÑËÆ∫‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            font-size: 13px; /* Áªü‰∏ÄËØÑËÆ∫Âå∫Â≠ó‰ΩìÂ§ßÂ∞è */
        }
        
        /* ÊØè‰∏ÄÊù°ËØÑËÆ∫ */
        .comment-item {
            line-height: 1.5;
        }
        
        /* ËØÑËÆ∫ËÄÖÁöÑÂêçÂ≠óÔºåÂä†Á≤óÂπ∂‰ΩøÁî®‰∏ªÈ¢òËâ≤ */
        .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            margin-right: 5px; /* ÂíåËØÑËÆ∫ÂÜÖÂÆπ‰πãÈó¥ÁïôÁÇπÁ©∫Èöô */
        }
        
        /* ËØÑËÆ∫ÂÜÖÂÆπ */
        .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === Â∏ñÂ≠êÁÇπËµûÂå∫ÂüüÊ†∑Âºè === */
        .post-likes-section {
            display: flex;
            align-items: center;
            gap: 6px; /* ÂõæÊ†áÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
            padding: 8px 10px; /* ÂÜÖËæπË∑ù */
            font-size: 13px;
            color: var(--accent-color); /* ‰ΩøÁî®‰∏ªÈ¢òËìùËâ≤ */
            background-color: #f0f5fa; /* Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑËÉåÊôØËâ≤ */
            border-top: 1px solid #e9eef3;
            border-bottom: 1px solid #e9eef3;
            margin-top: 5px; /* Âíå‰∏äÊñπÁöÑÂõæÊ†á‰øùÊåÅ‰∏ÄÁÇπË∑ùÁ¶ª */
        }
        
        .post-likes-section .like-icon {
            width: 16px;
            height: 16px;
            fill: currentColor; /* ËÆ©SVGÂõæÊ†áÁªßÊâøÁà∂ÂÖÉÁ¥†ÁöÑÈ¢úËâ≤ */
            flex-shrink: 0; /* Èò≤Ê≠¢ÂõæÊ†áË¢´ÂéãÁº© */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === @ÊèêÂèä ÂºπÂá∫ËèúÂçïÊ†∑Âºè === */
        .at-mention-popup {
            position: absolute; /* Áõ∏ÂØπ‰∫éÁà∂ÂÖÉÁ¥†ÂÆö‰Ωç */
            bottom: 100%; /* ÊòæÁ§∫Âú®ËæìÂÖ•Ê°ÜÁöÑ‰∏äÊñπ */
            left: 40px; /* ÂíåËæìÂÖ•Ê°ÜÂ∑¶‰æßÂØπÈΩê (ËÄÉËôë‰∫ÜÂ§¥ÂÉèÂÆΩÂ∫¶) */
            width: calc(100% - 40px); /* ÂÆΩÂ∫¶ÂíåËæìÂÖ•Ê°ÜÂ∑Æ‰∏çÂ§ö */
            max-height: 120px;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            display: none; /* ÈªòËÆ§ÈöêËóè */
        }
        
        .at-mention-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid #f0f0f0;
        }
        
        .at-mention-item:last-child {
            border-bottom: none;
        }
        
        .at-mention-item:hover {
            background-color: #f5f5f5;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢ËøôÊÆµ„ÄêÊñ∞Ê†∑Âºè„ÄëÊõøÊç¢Êéâ‰Ω†Áé∞ÊúâÁöÑ #favorites-list Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ËÆ©Êî∂ËóèËßÜÂõæÊàê‰∏∫‰∏Ä‰∏™flexÂÆπÂô®, ‰ªé‰∏äÂà∞‰∏ãÊéíÂàó */
        #favorites-view {
            display: flex;
            flex-direction: column;
        }
        
        /* Á°Æ‰øùÊî∂ËóèÈ°µÁöÑheaderÈ´òÂ∫¶Âõ∫ÂÆöÔºå‰∏çË¢´ÂéãÁº© */
        #favorites-view > .header {
            flex-shrink: 0;
        }
        
        /* === Êî∂ËóèÂàóË°®Ê†∑Âºè (‰øÆÊ≠£Âêé) === */
        #favorites-list {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; /* <-- Êñ∞Â¢ûËøôË°åÔºåÁ¶ÅÊ≠¢Ê∞¥Âπ≥ÊªöÂä® */
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        .favorite-item-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçÂà†Èô§ÊåâÈíÆ */
        }
        
        /* Âç°ÁâáÂ§¥ÈÉ®ÔºåÂåÖÂê´Â§¥ÂÉè„ÄÅÂêçÂ≠óÂíåÊù•Ê∫ê */
        .fav-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .fav-card-header .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .fav-card-header .info {
            flex-grow: 1;
        }
        
        .fav-card-header .name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .fav-card-header .source {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Âç°ÁâáÂÜÖÂÆπ */
        .fav-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .fav-card-content .chat-image {
            margin-top: 8px; /* ÂõæÁâáÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
        }
        
        /* Âà†Èô§ÊåâÈíÆ */
        .fav-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 28px;
            text-align: center;
        }
        
        .fav-delete-btn:hover {
            background-color: #e9ecef;
            color: #ff3b30;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === ÊêúÁ¥¢Ê†èÊ†∑Âºè === */
        .search-bar-container {
            padding: 10px 15px;
            background-color: #f9f9f9; /* ÂíåÂàóË°®ËÉåÊôØËâ≤‰øùÊåÅ‰∏ÄËá¥ */
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçÊ∏ÖÈô§ÊåâÈíÆ */
            flex-shrink: 0;
        }
        
        #favorites-search-input {
            width: 100%;
            padding: 10px 30px 10px 15px; /* Âè≥‰æßÁïôÂá∫Ê∏ÖÈô§ÊåâÈíÆÁöÑ‰ΩçÁΩÆ */
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 18px; /* ÂúÜËßíÁü©ÂΩ¢ÔºåÊõ¥Áé∞‰ª£Âåñ */
            background-color: var(--secondary-bg);
            box-sizing: border-box;
            outline: none;
        }
        #favorites-search-input:focus {
            border-color: var(--accent-color);
        }
        
        .search-clear-btn {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === ËÅäÂ§©ÁïåÈù¢Â§öÈÄâÊìç‰ΩúÊ†è‰ºòÂåñ === */
        #chat-interface-screen .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        #chat-interface-screen .selection-controls .action-btn {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
        }
        
        /* === Êî∂ËóèÈ°µÈù¢Â§öÈÄâÊ®°ÂºèÊ†∑Âºè === */
        #favorites-view.selection-mode .favorite-item-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* ÈÄâÊã©Ê°ÜÁöÑÊ†∑Âºè */
        .favorite-item-card::before {
            content: '';
            position: absolute;
            left: -25px; /* ÊääÂÆÉÊîæÂú®Âç°ÁâáÂ∑¶ËæπÂ§ñÈù¢ */
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: white;
            transition: all 0.2s ease;
            opacity: 0; /* ÈªòËÆ§ÈöêËóè */
        }
        
        /* ËøõÂÖ•ÈÄâÊã©Ê®°ÂºèÊó∂ÔºåÂç°ÁâáÂêëÂè≥ÁßªÂä®ÔºåÈú≤Âá∫ÈÄâÊã©Ê°Ü */
        #favorites-view.selection-mode .favorite-item-card {
            transform: translateX(35px);
        }
        #favorites-view.selection-mode .favorite-item-card::before {
            opacity: 1;
        }
        
        /* ÈÄâ‰∏≠ÂêéÁöÑÊ†∑Âºè */
        #favorites-view.selection-mode .favorite-item-card.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        
        /* Â∫ïÈÉ®Êìç‰ΩúÊ†è (ÁªàÊûÅ‰øÆÊ≠£Áâà) */
        #favorites-action-bar {
            position: absolute; /* ‚òÖ Êîπ‰∏∫ absoluteÔºåÁõ∏ÂØπ‰∫é #phone-screen ÂÆö‰Ωç */
            bottom: 0;
            left: 0;
            right: 0;           /* ‚òÖ Êñ∞Â¢û right: 0ÔºåÂíå left: 0 ‰∏ÄËµ∑ÊíëÊª°ÂÆΩÂ∫¶ */
            width: auto;        /* ‚òÖ Êîπ‰∏∫ autoÔºåËÆ© left/right ÂÜ≥ÂÆöÂÆΩÂ∫¶ */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* ÈÄÇÈÖçiPhoneÂ∫ïÈÉ®ÂÆâÂÖ®Âå∫ */
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none;
            /* max-width Â∑≤Áªè‰∏çÈúÄË¶Å‰∫ÜÔºåÂõ†‰∏∫Áà∂ÂÖÉÁ¥†Â∑≤ÁªèÈôêÂà∂‰∫ÜÂÆΩÂ∫¶ */
        }
        
        #favorites-action-bar .action-bar-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        
        /* === „Äê‰øÆÊ≠£„ÄëËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Êéß‰ª∂ÂàáÊç¢ÈÄªËæë === */
        
        /* ÈªòËÆ§Áä∂ÊÄÅÔºöÈöêËóèÂ§öÈÄâÊéß‰ª∂ */
        #chat-interface-screen .header .selection-controls {
            display: none;
        }
        
        /* ÈªòËÆ§Áä∂ÊÄÅÔºöÊòæÁ§∫ÈªòËÆ§Êéß‰ª∂ÔºåÂπ∂ËÆ©ÂÆÉÊíëÊª°Êï¥‰∏™Â§¥ÈÉ® */
        #chat-interface-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* ÂΩìËøõÂÖ•Â§öÈÄâÊ®°ÂºèÊó∂ÔºöÈöêËóèÈªòËÆ§Êéß‰ª∂ */
        #chat-interface-screen.selection-mode .header .default-controls {
            display: none;
        }
        
        /* ÂΩìËøõÂÖ•Â§öÈÄâÊ®°ÂºèÊó∂ÔºöÊòæÁ§∫Â§öÈÄâÊéß‰ª∂ÔºåÂπ∂ËÆ©ÂÆÉÊíëÊª°Êï¥‰∏™Â§¥ÈÉ® */
        #chat-interface-screen.selection-mode .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
/* === ‰øÆÊ≠£ÔºöÊîæÂ§ßÊâÄÊúâ‰∏ªË¶ÅÁöÑ‚Äú+‚ÄùÂè∑ÊåâÈíÆ === */
        #add-chat-btn,
        #add-world-book-btn,
        #create-album-btn-page,
        #create-new-npc-btn { /* <-- Âú®ËøôÈáåÊ∑ªÂä†‰∫ÜÊñ∞ÁöÑÊåâÈíÆID */
            font-size: 28px;   /* ÊòæËëóÂ¢ûÂ§ßÂ≠ó‰ΩìÂ§ßÂ∞èÔºå‰ΩøÂÖ∂ËßÜËßâ‰∏ä‰∏éÊóÅËæπÁöÑÂõæÊ†áÂåπÈÖç */
            font-weight: 300;  /* ‰ΩøÁî®Êõ¥ÁªÜÁöÑÂ≠óÈáçÔºåËÆ©Âä†Âè∑ÁúãËµ∑Êù•Êõ¥Ê∏ÖÁàΩÔºå‰∏çÊòæÁ≤óÁ¨® */
            position: relative;/* ÂÖÅËÆ∏ËøõË°å‰ΩçÁΩÆÂæÆË∞É */
            top: -1px;         /* Â≠ó‰ΩìÊîæÂ§ßÂêéÔºåÈÄöÂ∏∏ÈúÄË¶ÅÁ®çÂæÆÂêë‰∏äÁßªÂä®‰∏ÄÁÇπÔºå‰ΩøÂÖ∂ËßÜËßâ‰∏äÊõ¥Â±Ö‰∏≠ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* È¢ÑËßàÂå∫ÂÆπÂô®Ê†∑Âºè */
        #settings-preview-area {
            width: 100%;
            height: 180px; /* Áªô‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÈ´òÂ∫¶ */
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
            display: flex;
            flex-direction: column;
            gap: 10px; /* È¢ÑËßàÊ∞îÊ≥°‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            border: 1px solid var(--border-color);
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçËÉåÊôØ */
        }
        
        /* È¢ÑËßàÂå∫ÁöÑËÉåÊôØÔºåÂèØ‰ª•ÂíåÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÂêåÊ≠• */
        #settings-preview-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.8;
        }
        
        /* ËÆ©È¢ÑËßàÊ∞îÊ≥°Âú®ËÉåÊôØ‰πã‰∏ä */
        #settings-preview-area .message-wrapper {
            position: relative;
            z-index: 2;
        }
        
        /* È¢ÑËßàÂå∫ÂÜÖ‰ΩøÁî®ÁöÑÂ§¥ÂÉèË¶ÅÂ∞è‰∏ÄÁÇπ */
        #settings-preview-area .message-bubble .avatar {
            width: 30px;
            height: 30px;
        }
        
        #settings-preview-area .message-bubble .timestamp {
            display: none; /* È¢ÑËßàÂå∫‰∏çÈúÄË¶ÅÊòæÁ§∫Êó∂Èó¥Êà≥ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        .existing-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .existing-group-item .group-name {
            font-weight: 500;
        }
        
        .existing-group-item .delete-group-btn {
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        .chat-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        
        .chat-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        
        .chat-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        
        .chat-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        
        .chat-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .chat-group-content {
            max-height: 1000px; /* ‰∏Ä‰∏™Ë∂≥Â§üÂ§ßÁöÑÂÄº */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        .chat-group-content.collapsed {
            max-height: 0;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁöÑÂÆπÂô® */
        .format-helpers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; /* ‰∏é‰∏ãÊñπÁöÑÊñáÊú¨Ê°ÜÊãâÂºÄË∑ùÁ¶ª */
            flex-wrap: wrap; /* Â¶ÇÊûúÊåâÈíÆÂ§™Â§öÂèØ‰ª•Êç¢Ë°å */
        }
        
        /* Âçï‰∏™Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁöÑÊ†∑Âºè */
        .format-btn {
            background-color: #e9ecef;
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 16px; /* ËÉ∂ÂõäÂΩ¢Áä∂ÔºåÊõ¥ÂèãÂ•Ω */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .format-btn:hover {
            background-color: #dcdfe3;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ‚Äú‚Ä¶‚ÄùÊåâÈíÆÁöÑÊ†∑Âºè */
        .post-actions-btn {
            margin-left: auto; /* ÂÖ≥ÈîÆÔºöËÆ©ÂÆÉËá™Âä®Èù†Âà∞ÊúÄÂè≥Ëæπ */
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
        }
        .post-actions-btn:hover {
            background-color: #f0f0f0;
        }
        
        /* Âä®ÊÄÅÁºñËæëÊ®°ÊÄÅÊ°ÜÁöÑÊ†∑Âºè (ÂÆÉÂ∞ÜÂ§çÁî®Áé∞ÊúâÁöÑÊìç‰ΩúËèúÂçïÊ†∑Âºè) */
        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            border-bottom: 1px solid #dbdbdb;
            padding: 14px;
            font-size: 18px;
        }
        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }
        #post-actions-modal #cancel-post-action-btn {
            margin-top: 8px;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* Áªü‰∏ÄÈáçÁΩÆËΩ¨Ë¥¶Âç°ÁâáÂÜÖÊâÄÊúâÊñáÂ≠óÁöÑÁâπÊïàÂíåÈ¢úËâ≤ */
        #chat-messages .transfer-card .transfer-title,
        #chat-messages .transfer-card .transfer-amount,
        #chat-messages .transfer-card .transfer-note {
            text-shadow: none !important; /* Âº∫Âà∂ÁßªÈô§‰ªª‰ΩïÂèëÂÖâÊàñÈò¥ÂΩ±ÊïàÊûú */
            color: white !important;      /* Âº∫Âà∂ÈîÅÂÆöÊñáÂ≠óÈ¢úËâ≤‰∏∫ÁôΩËâ≤ */
        }
        
        /* ÂàÜÂà´ÈîÅÂÆöÂêÑËá™ÁöÑÂ≠ó‰ΩìÂ§ßÂ∞èÂíåÂ≠óÈáçÔºåÈò≤Ê≠¢Ë¢´ÁØ°Êîπ */
        #chat-messages .transfer-card .transfer-title {
            font-size: 16px !important;
            font-weight: 600 !important;
        }
        
        #chat-messages .transfer-card .transfer-amount {
            font-size: 28px !important;
            font-weight: bold !important;
        }
        
        #chat-messages .transfer-card .transfer-note {
            font-size: 13px !important;
            opacity: 0.9 !important;
        }
        
        /* ‚ñº‚ñº‚ñº ËøôÊòØÊñ∞Â¢ûÁöÑÊ†∑ÂºèÔºåÁî®‰∫é‰øÆÊ≠£ÊâÄÊúâÂ§¥ÈÉ®Ê†áÈ¢òÁöÑÂ±Ö‰∏≠ÈóÆÈ¢ò ‚ñº‚ñº‚ñº */
        .header > span:nth-child(2),
        #chat-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% - 2px)); /* Âú®-50%ÁöÑÂü∫Á°Ä‰∏äÔºåÂÜçÂêëÂ∑¶Êé®2ÂÉèÁ¥† */
            
            /* (ÂèØÈÄâ‰ΩÜÊé®Ëçê) Èò≤Ê≠¢ÈïøÊ†áÈ¢ò‰∏é‰∏§ËæπÊåâÈíÆÈáçÂè† */
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèØËßÜÂåñÊ∂àÊÅØÁºñËæëÂô®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #message-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .message-editor-block textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .message-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* Ë¶ÜÁõñÈªòËÆ§ÁöÑ margin-bottom */
        }
        
        .message-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .contact-picker-item .name {
            font-weight: 500;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #member-management-list {
            padding: 0; /* ÁßªÈô§ÈªòËÆ§paddingÔºåËÆ©ÂàóË°®È°πÊíëÊª° */
        }
        
        .member-management-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .member-management-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .member-management-item .name {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .member-management-item .remove-member-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        #member-management-actions {
            flex-shrink: 0;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        #member-management-actions button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        #member-management-actions #create-new-member-btn {
            background-color: #4cd964; /* Êñ∞Âª∫Áî®ÁªøËâ≤Ôºå‰ª•Á§∫Âå∫ÂàÜ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñ‰ª£‰ªòÂç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        
        .waimai-card {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .waimai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .waimai-header .icon {
            width: 20px;
            height: 20px;
        }
        
        .waimai-header .title-group {
            display: flex;
            align-items: baseline;
            font-size: 14px;
            color: #8a8a8a;
        }
        .waimai-header .title-group .brand {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }
        .waimai-header .title-group .separator {
            margin: 0 5px;
        }
        
        .waimai-catchphrase {
            font-size: 13px;
            color: #1f1f1f;
            padding: 12px;
        }
        
        .waimai-main {
            background-color: #FFD66B; /* Ê©ôÈªÑËâ≤ËÉåÊôØ */
            padding: 12px;
            text-align: center;
        }
        
        .waimai-main .request-title {
            font-size: 12px;
            color: #856404;
            margin-bottom: 8px;
        }
        
        .waimai-main .payment-box {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 10px;
        }
        
        .waimai-main .payment-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        
        .waimai-main .amount {
            font-size: 32px;
            font-weight: 700;
            color: #1f1f1f;
            margin: 4px 0 12px 0;
        }
        
        .waimai-main .countdown-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        .waimai-main .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }
        .waimai-main .countdown-timer span {
            background-color: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .waimai-details-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background-color: #FFC33A;
            color: #49380a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñÂìçÂ∫îÁä∂ÊÄÅÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* === ÂêåÊÑèÊîØ‰ªòÂêéÁöÑÊ†∑Âºè === */
        .message-bubble.status-paid .waimai-card {
            border: 2px solid #28a745; /* ÁªøËâ≤ËæπÊ°Ü */
        }
        .message-bubble.status-paid .waimai-main .request-title::before {
            content: '‚úÖ  ';
        }
        .message-bubble.status-paid .waimai-main .request-title {
            color: #155724;
            font-weight: 600;
            /* ÈáçÂÜô request-title ÁöÑÂÜÖÂÆπ */
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû" !important;
            display: block;
            margin-bottom: 15px;
        }
        
        .message-bubble.status-paid .payment-box {
            display: none; /* ÈöêËóèÊîØ‰ªòËØ¶ÊÉÖ */
        }
        .message-bubble.status-paid .waimai-details-btn {
            background-color: #28a745;
            color: white;
        }
        
        /* === ÊãíÁªùÊîØ‰ªòÂêéÁöÑÊ†∑Âºè === */
        .message-bubble.status-rejected .waimai-card {
            border: 2px solid #dc3545; /* Á∫¢Ëâ≤ËæπÊ°Ü */
            opacity: 0.8;
        }
        .message-bubble.status-rejected .waimai-main {
            background-color: #e9ecef;
        }
        .message-bubble.status-rejected .waimai-main .request-title::before {
            content: '‚ùå ';
        }
        .message-bubble.status-rejected .waimai-main .request-title {
            color: #721c24;
            font-weight: 600;
            /* ÈáçÂÜô request-title ÁöÑÂÜÖÂÆπ */
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç" !important;
            display: block;
            margin-bottom: 15px;
        }
        .message-bubble.status-rejected .payment-box {
            display: none; /* ÈöêËóèÊîØ‰ªòËØ¶ÊÉÖ */
        }
         .message-bubble.status-rejected .waimai-details-btn {
            background-color: #6c757d;
            color: white;
        }
        
        /* Âº∫Âà∂ÈáçÂÜô request-title ÂÜÖÂÆπÁöÑÊäÄÂ∑ß */
        .message-bubble[class*="status-"] .request-title {
            font-size: 0; /* ÈöêËóèÂéüÂßãÊñáÊú¨ */
        }
        .message-bubble[class*="status-"] .request-title::after {
            font-size: 14px; /* ËÆ©‰º™ÂÖÉÁ¥†ÊòæÁ§∫Êñ∞ÊñáÊú¨ */
        }
        .message-bubble.status-paid .request-title::after {
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû";
        }
        .message-bubble.status-rejected .request-title::after {
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç";
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÁöÑÁî®Êà∑Êìç‰ΩúÊåâÈíÆÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .waimai-user-actions {
            display: flex;
            gap: 10px;
            padding: 0 12px 12px 12px; /* Âú®Âç°ÁâáÂ∫ïÈÉ®ÁïôÂá∫Á©∫Èó¥ */
            background-color: #fff;
        }
        
        .waimai-user-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .waimai-pay-btn {
            background-color: #28a745;
            border-color: #1f7a33;
            color: white;
        }
        .waimai-pay-btn:hover {
            background-color: #218838;
        }
        
        .waimai-decline-btn {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #495057;
        }
        .waimai-decline-btn:hover {
            background-color: #e2e6ea;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === „ÄêÊñ∞Â¢û„ÄëÁªü‰∏ÄËÆæÁΩÆÈ°µÈù¢ÁöÑËÉåÊôØËâ≤ (Â∑≤‰øÆÊ≠£) === */
        #api-settings-screen,
        #font-settings-screen,
        #wallpaper-screen,
        #memories-view,
        #contact-picker-screen,
        #member-management-screen,
        #world-book-editor-screen {  
            background-color: var(--secondary-bg);
        }
        
        /* Á°Æ‰øùËøô‰∫õÈ°µÈù¢ÁöÑÂÜÖÂÆπÂå∫ËÉΩÊ≠£Á°ÆÊªöÂä® */
        #api-settings-screen .form-container,
        #font-settings-screen .form-container,
        #wallpaper-screen .form-container {
            padding-top: 100px;
            margin-top: -80px;
            background-color: var(--secondary-bg);
        }
        
        /* Â£ÅÁ∫∏ËÆæÁΩÆÈ°µÈù¢ÁöÑÈ¢ÑËßàÂå∫ÊØîËæÉÁâπÊÆäÔºåÈúÄË¶ÅÈ¢ùÂ§ñË∞ÉÊï¥ */
        #wallpaper-screen .form-container {
            align-items: center; /* ‰øùÊåÅÂÜÖÂÆπÂ±Ö‰∏≠ */
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊù•ÁîµËØ∑Ê±Ç‰∏éËßÜÈ¢ëÈÄöËØùÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* --- Êù•ÁîµËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü --- */
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.5);
        }
        
        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }
        
        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        
        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .call-action-btn:active {
            transform: scale(0.9);
        }
        
        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        
        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
        }
        
        /* --- ËßÜÈ¢ëÈÄöËØùÁïåÈù¢ --- */
      /* ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó„ÄêÊúÄÁªàÁªìÊûÑÈáçÂÜôÁâà„ÄëÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢ÊâÄÊúâÊóßÁöÑ video-call Áõ∏ÂÖ≥CSS ‚ñº‚ñº‚ñº */

/* 1. ÈÄöËØùÂ±èÂπïÊÄªÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex; /* ‚òÖ Ê†∏ÂøÉÔºöÂÆÉ‰æùÁÑ∂ÊòØflexÂÆπÂô® */
    flex-direction: column;
    overflow: hidden;
}

/* 2. È°∂ÈÉ®Ê†èÂíåÂ∫ïÈÉ®ÊéßÂà∂Ê†è (‰øùÊåÅ‰∏çÂèò) */
.video-call-top-bar, .video-call-controls {
    position: absolute;
    left: 0;
    width: 100%;
    z-index: 10;
    box-sizing: border-box;
    pointer-events: none; /* ËÆ©ÂÆÉ‰ª¨‰∏çÂΩ±Âìç‰∏ãÊñπÂÜÖÂÆπÁöÑÁÇπÂáª */
}
.video-call-top-bar {
    top: 0;
    padding: 15px 20px 30px; /* Â¢ûÂä†Â∫ïÈÉ®padding */
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    text-align: center;
}
.video-call-controls {
    bottom: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    pointer-events: all; /* ÊéßÂà∂ÊåâÈíÆÈúÄË¶ÅËÉΩÁÇπÂáª */
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}

/* 3. „ÄêÊ†∏ÂøÉÈáçÊûÑ„ÄëÈªòËÆ§ÊñáÂ≠óÈÄöËØùÁöÑÊÄªÂÆπÂô® */
#text-call-interface {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

/* 4. „ÄêÊ†∏ÂøÉÈáçÊûÑ„ÄëÂ§¥ÂÉèÂå∫Âüü */
.video-call-avatar-area {
    flex-shrink: 0; /* ‚òÖ Ê†∏ÂøÉÔºöÈ´òÂ∫¶Èõ∑Êâì‰∏çÂä®ÔºåÁªù‰∏çÂéãÁº© */
    display: flex;
    justify-content: center;
    align-items: center;
    padding-top: 100px; /* ‚òÖ Ê†∏ÂøÉÔºö‰∏éÈ°∂ÈÉ®Áä∂ÊÄÅÊ†èÊãâÂºÄË∑ùÁ¶ª */
    padding-bottom: 20px; /* ‚òÖ Ê†∏ÂøÉÔºö‰∏é‰∏ãÊñπÊ∞îÊ≥°Âå∫ÊãâÂºÄË∑ùÁ¶ª */
}

/* 5. „ÄêÊ†∏ÂøÉÈáçÊûÑ„ÄëÊ∞îÊ≥°Âå∫Âüü */
#video-call-main {
    flex-grow: 1; /* ‚òÖ Ê†∏ÂøÉÔºöÂç†ÊçÆÊâÄÊúâÂâ©‰ΩôÁöÑÂûÇÁõ¥Á©∫Èó¥ */
    min-height: 0; /* ‚òÖ Ê†∏ÂøÉÔºö‰∏Ä‰∏™Èò≤Ê≠¢flexÊ∫¢Âá∫ÁöÑÈáçË¶Å‰øùÈô©‰∏ù */
    margin: 0 15px 130px 15px; /* ‚òÖ Ê†∏ÂøÉÔºöÂÆö‰πâÂõõÂë®ËæπÁïåÔºåÂ∫ïÈÉ®ÁïôË∂≥Á©∫Èó¥ÁªôÊåâÈíÆ */
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.08); /* Á®çÂæÆË∞É‰∫Æ‰∏ÄÁÇπËÉåÊôØ */
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

/* 6. Â§¥ÂÉèÁΩëÊ†ºÂíåÂ§¥ÂÉèÊú¨Ë∫´Ê†∑Âºè (ÂæÆË∞É) */
#participant-avatars-grid {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
}
.participant-avatar-wrapper {
    text-align: center;
}
.participant-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 13px;
    color: #ccc;
}
.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

/* 7. ÊéßÂà∂ÊåâÈíÆÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
.control-btn {
    width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer;
    background-repeat: no-repeat; background-position: center;
    transition: transform 0.2s, background-color 0.2s;
    pointer-events: all;
}
.control-btn:active { transform: scale(0.9); }
.control-btn.speak-btn { background-color: rgba(255,255,255,0.2); background-size: 55%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'); }
.control-btn.hangup-btn { background-color: #ff3b30; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>'); }
.control-btn.join-btn { background-color: #007bff; background-size: 50%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>'); }

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÂØπËØùÊ∞îÊ≥°Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .call-message-bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            word-break: break-word;
            white-space: pre-wrap;
        }
        
        .call-message-bubble.ai-speech {
            background-color: rgba(255, 255, 255, 0.15);
            align-self: flex-start; /* AIÂèëË®ÄÈù†Â∑¶ */
        }
        
        .call-message-bubble.user-speech {
            background-color: #4cd964; /* Áî®Êà∑ÂèëË®ÄÁî®ÁªøËâ≤ÔºåÁ±ª‰ººÂæÆ‰ø° */
            align-self: flex-end;   /* Áî®Êà∑ÂèëË®ÄÈù†Âè≥ */
            text-align: left; /* Á°Æ‰øùÁî®Êà∑Ê∞îÊ≥°ÂÜÖÁöÑÊñáÂ≠óÊòØÂ∑¶ÂØπÈΩêÁöÑ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„ÄëÊ≠£Âú®ÂëºÂè´ÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #outgoing-call-screen {
            background-color: #1c1c1e;
            color: white;
            justify-content: center; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
            align-items: center;   /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
        }
        
        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .outgoing-call-actions {
            margin-top: 50px; /* Âíå‰∏äÊñπÊñáÂ≠óÊãâÂºÄË∑ùÁ¶ª */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* 1. Âä®ÊÄÅÂ∏ñÂ≠êÁöÑÂ§ñÂ±ÇÂÆπÂô®ÔºåÊàë‰ª¨ÈúÄË¶ÅÂÆÉÊù•ÂÆö‰ΩçÂíåË£ÅÂâ™ */
        .qzone-post-container {
            position: relative; /* ËÆ©ÂÜÖÈÉ®ÁöÑÂà†Èô§ÊåâÈíÆÂèØ‰ª•Áõ∏ÂØπ‰∫éÂÆÉÂÆö‰Ωç */
            overflow: hidden;   /* ÈöêËóèÊéâË∂ÖÂá∫ÈÉ®ÂàÜÁöÑÂà†Èô§ÊåâÈíÆ */
            border-radius: 12px;/* ÂíåÂÜÖÈÉ®Âç°Áâá‰øùÊåÅ‰∏ÄËá¥ÁöÑÂúÜËßí */
        }
        
        /* 2. ÂèØÊªëÂä®ÁöÑÂÜÖÂÆπÂç°ÁâáÔºåÂ¢ûÂä†‰∏Ä‰∏™Âπ≥ÊªëÁöÑËøáÊ∏°ÊïàÊûú */
        .qzone-post-item {
            transition: transform 0.3s ease;
            background-color: var(--secondary-bg); /* Á°Æ‰øùÂÆÉÊúâËÉåÊôØËâ≤ÔºåËÉΩÁõñ‰Ωè‰∏ãÈù¢ÁöÑÂà†Èô§ÊåâÈíÆ */
            position: relative; /* Á°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç */
            z-index: 2;
        }
        
        /* 3. „ÄêÊ†∏ÂøÉ„ÄëËøôÂ∞±ÊòØÈÇ£‰∏™‚ÄúÂà†Èô§‚ÄùÊåâÈíÆÁöÑÊ†∑ÂºèÔºÅ*/
        .qzone-post-delete-action {
            position: absolute; /* ÁªùÂØπÂÆö‰ΩçÔºåËÑ±Á¶ªÊñáÊ°£ÊµÅ */
            top: 0;
            right: 0;
            bottom: 0;
            width: 90px; /* Âà†Èô§ÊåâÈíÆÁöÑÂÆΩÂ∫¶ */
            background-color: #ff3b30; /* ÊÇ®ÊÉ≥Ë¶ÅÁöÑÁ∫¢Ëâ≤ËÉåÊôØ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            z-index: 1; /* Á°Æ‰øùÂÆÉÂú®Âç°Áâá‰∏ãÈù¢ */
        }
        
        /* 4. ÂΩìÂç°ÁâáÂ∑¶ÊªëÊó∂ÔºåÊääÂÆÉÂêëÂ∑¶ÁßªÂä®ÔºåÈú≤Âá∫Âà†Èô§ÊåâÈíÆ */
        .qzone-post-item.swiped {
            transform: translateX(-90px); /* ÁßªÂä®ÁöÑË∑ùÁ¶ªÂíåÂà†Èô§ÊåâÈíÆÁöÑÂÆΩÂ∫¶‰∏ÄËá¥ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‚ÄúÊãç‰∏ÄÊãç‚ÄùÊ†∑ÂºèÔºåÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* 1. ‚ÄúÊãç‰∏ÄÊãç‚ÄùÁöÑÂ±èÂπïÈúáÂä®Âä®Áîª */
        @keyframes pat-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        
        .pat-animation {
            animation: pat-shake 0.4s ease-in-out;
        }
        
        /* 2. ‚ÄúÊãç‰∏ÄÊãç‚ÄùÁ≥ªÁªüÊèêÁ§∫Ê∂àÊÅØÁöÑÊ†∑Âºè */
        .system-message {
            align-self: center; /* Â±Ö‰∏≠ÊòæÁ§∫ */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ËÆ©‚ÄúÊãç‰∏ÄÊãç‚ÄùÁ±ªÂûãÁöÑ wrapper Â±Ö‰∏≠ */
        .message-wrapper.system-pat {
            justify-content: center;
            align-self: center;
            margin: 5px 0;
            max-width: 80%;
        }
        /* ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÊ∂àÊÅØÊ∞îÊ≥°ÁöÑÊ†∑Âºè */
        .message-bubble.system-bubble {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === ‰øÆÊ≠£ÔºöËÆ©È°∂ÈÉ®Êìç‰ΩúÊ†èÂèØ‰ª•Ê®™ÂêëÊªöÂä® === */
        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;
        
            /* --- Ê†∏ÂøÉ‰ª£Á†ÅÂºÄÂßã --- */
            overflow-x: auto;      
            flex-wrap: nowrap;     
            -webkit-overflow-scrolling: touch; 
        
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        
        #chat-input-actions-top::-webkit-scrollbar {
            display: none; 
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Áä∂ÊÄÅÊ†èÊ†∑Âºè === */
        
        /* 1. Ê†áÈ¢òÂíåÁä∂ÊÄÅÁöÑÊÄªÂÆπÂô®Ôºå‰ΩøÁî®flexÂ∏ÉÂ±ÄËÆ©ÂÆÉ‰ª¨ÂûÇÁõ¥ÊéíÂàó */
        #chat-header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
            gap: 2px; /* Ê†áÈ¢òÂíåÁä∂ÊÄÅ‰πãÈó¥ÁöÑÂæÆÂ∞èÈó¥Ë∑ù */
            
            /* ‰∏∫‰∫ÜËÆ©ÂÆÉËÉΩÂú®flexÂ∏ÉÂ±Ä‰∏≠Ê≠£Á°ÆÂ±Ö‰∏≠ */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 60%;
        }
        
        /* 2. ‰∏ªÊ†áÈ¢òÁöÑÊ†∑ÂºèÂæÆË∞É */
        #chat-header-title {
            font-size: 16px; /* ÂèØ‰ª•Á®çÂæÆÁº©Â∞è‰∏ÄÁÇπÔºåÁªôÁä∂ÊÄÅÊ†èÁïôÂá∫Á©∫Èó¥ */
            font-weight: 600;
            position: static; /* Ë¶ÜÁõñÊéâÊóßÁöÑabsoluteÂÆö‰Ωç */
            transform: none;  /* Ë¶ÜÁõñÊéâÊóßÁöÑtransform */
            /* ‰øùËØÅÈïøÊ†áÈ¢ò‰πüËÉΩÊ≠£Á°ÆÊòæÁ§∫ÁúÅÁï•Âè∑ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* 3. Áä∂ÊÄÅÊ†èÂÆπÂô® */
        #chat-header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        
        /* 4. Áä∂ÊÄÅÂ∞èÂúÜÁÇπ */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #4cd964; /* ÈªòËÆ§ÁªøËâ≤Ôºå‰ª£Ë°®Âú®Á∫ø */
            transition: background-color 0.3s ease;
        }
        
        /* ÂΩìAIÁä∂ÊÄÅ‰∏∫‚ÄúÂøôÁ¢å‚ÄùÊàñ‚ÄúÁ¶ªÂºÄ‚ÄùÊó∂ÔºåËÆ©ÂúÜÁÇπÂèòÁÅ∞Ëâ≤ */
        #chat-header-status.busy .status-dot {
            background-color: #cccccc;
        }
        
        /* 5. Áä∂ÊÄÅÊñáÊú¨ */
        .status-text {
            font-weight: 500;
        }
        
        /* === „ÄêÂÖ®Êñ∞ÁæéÂåñÁâà„ÄëÂõûÂøÜÂç°ÁâáÊ†∑Âºè === */
        
        /* 1. Âç°ÁâáÊÄªÂÆπÂô®ÔºöËøôÈáåË¥üË¥£ÂÆö‰πâÊï¥‰ΩìÁöÑËÉåÊôØËâ≤ÂíåËæπÊ°Ü */
        .memory-card {
            background-color: #fffaf0; /* Áªü‰∏ÄÁöÑ„ÄÅÊ∏©ÊöñÁöÑÁ±≥ÈªÑËâ≤ËÉåÊôØ */
            border-radius: 12px;
            padding: 15px; /* Âú®Âç°ÁâáÂõõÂë®ÁïôÂá∫ÂÜÖËæπË∑ù */
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            border-left: 5px solid #ffb74d; 
            display: flex; /* ËÆ©ÂÆÉÊàê‰∏∫flexÂÆπÂô®ÔºåÊñπ‰æøÂÜÖÈÉ®ÂÖÉÁ¥†ÊéíÂàó */
            flex-direction: column; /* ËÆ©Â§¥ÈÉ®ÂíåÂÜÖÂÆπÂûÇÁõ¥Â†ÜÂè† */
            gap: 8px; /* Âú®Â§¥ÈÉ®ÂíåÂÜÖÂÆπ‰πãÈó¥ÂàõÈÄ†‰∏Ä‰∏™Ëá™ÁÑ∂ÁöÑÈó¥Ë∑ù */
        }
        
        /* 2. Â§¥ÈÉ®ÂÆπÂô®ÔºöÁé∞Âú®Âè™Ë¥üË¥£Â∏ÉÂ±ÄÂíåÂàÜÂâ≤Á∫ø */
        .memory-card .header {
            border-bottom: 1px solid rgba(217, 129, 0, 0.15); /* ÂàÜÂâ≤Á∫øÈ¢úËâ≤ÂèØ‰ª•Á®çÂæÆÂä†Ê∑±‰∏ÄÁÇπ */
            padding-bottom: 8px; 
        }
        
        /* 3. Êó•ÊúüÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .header .date {
            font-size: 11px;
            color: #a1887f;
            margin-bottom: 4px; 
        }
        
        /* 4. ‰ΩúËÄÖÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .header .author {
            font-weight: 600;
            color: #d98100;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 5. ÂÜÖÂÆπÂå∫Ê†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .content {
            font-size: 14px;
            line-height: 1.7;
            color: #5d4037;
            white-space: pre-wrap;
        }
        
        /* === „ÄêÂÖ®Êñ∞„ÄëÁ∫¶ÂÆö/ÂÄíËÆ°Êó∂Âç°ÁâáÊ†∑Âºè === */
        .countdown-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        .countdown-card::before {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        .countdown-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .countdown-card .timer {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .countdown-card .target-date {
            font-size: 12px;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
        }
        
        /* === „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÈîÅÂÆöÈÅÆÁΩ©Â±ÇÊ†∑Âºè === */
        #chat-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 150; /* ÊØîËæìÂÖ•Ê°ÜÈ´òÔºåÊØîË¥¥Á∫∏Èù¢Êùø‰Ωé */
            display: none; /* ÈªòËÆ§ÈöêËóè */
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        #chat-lock-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #chat-lock-content .lock-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        #chat-lock-content .lock-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
        }
        #chat-lock-content .lock-action-btn.secondary {
            background-color: transparent;
            color: var(--accent-color);
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        
        .red-packet-card {
            width: 220px;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700; /* ÈáëËâ≤ÊñáÂ≠ó */
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }
        
        .red-packet-card::before {
            content: 'üßß';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }
        
        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .rp-icon {
            width: 20px;
            height: 20px;
        }
        
        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖËØ¶ÊÉÖÂàóË°®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .rp-details-item:last-child {
            border-bottom: none;
        }
        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }
        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }
        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ÊäïÁ•®Âç°ÁâáÂú®Ê∂àÊÅØÊ∞îÊ≥°‰∏≠ÁöÑÊ†∑Âºè */
        
        /* ÊäïÁ•®Âç°Áâá‰∏ª‰Ωì */
        .poll-card {
            width: 250px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .poll-card.closed {
            background-color: #e9ecef; /* ÁªìÊùüÂêéÂèòÁÅ∞ */
        }
        
        /* ÊäïÁ•®ÈóÆÈ¢ò */
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* ÊäïÁ•®ÈÄâÈ°πÂàóË°® */
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Âçï‰∏™ÊäïÁ•®ÈÄâÈ°π */
        .poll-option-item {
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        
        .poll-card:not(.closed) .poll-option-item:hover {
            background-color: #f0f8ff;
        }
        
        /* Áî®Êà∑Â∑≤ÊäïÁ•®ÁöÑÈÄâÈ°πÊ†∑Âºè */
        .poll-option-item.voted {
            border-color: var(--accent-color);
            background-color: #e7f3ff;
            font-weight: 500;
        }
        
        /* ÊäïÁ•®ËøõÂ∫¶Êù° */
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }
        
        /* ÈÄâÈ°πÂÜÖÂÆπÔºàÊñáÂ≠óÂíåÁ•®Êï∞ÔºâÔºåÁ°Æ‰øùÂú®ËøõÂ∫¶Êù°‰πã‰∏ä */
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-text {
            font-size: 14px;
        }
        
        .poll-option-votes {
            font-size: 13px;
            color: #8a8a8a;
            font-weight: 500;
        }
        
        /* ÊäïÁ•®Âç°ÁâáÂ∫ïÈÉ® */
        .poll-footer {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .poll-total-votes {
            font-weight: 500;
        }
        
        .poll-action-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .poll-card.closed .poll-action-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        
        /* ÂàõÂª∫ÊäïÁ•®Ê®°ÊÄÅÊ°ÜÁöÑÈÄâÈ°πËæìÂÖ• */
        .poll-option-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-option-input-wrapper input {
            flex-grow: 1;
        }
        .poll-option-input-wrapper .remove-option-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #ff3b30;
            border: none;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©Â§¥ÈÉ®‚ÄúÊ≠£Âú®ËæìÂÖ•‚ÄùÁä∂ÊÄÅÊ†∑Âºè === */
        #chat-header-title.typing-status {
            color: var(--text-secondary);
            animation: typing-pulse 1.5s infinite;
            font-style: italic;
        }
        
        @keyframes typing-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        #chat-header-title {
            transition: opacity 0.2s ease-in-out;
        }
        
        @keyframes message-pop-in {
          from {
            opacity: 0;
            transform: translateY(15px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .message-wrapper.animate-in {
          animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
          }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAppÂõæÊ†áËÆæÁΩÆÊ†∑Âºè ‚ñº‚ñº‚ñº */
        #icon-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 20px;
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        .icon-setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .icon-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .icon-preview:active {
            transform: scale(0.95);
        }
        
        .change-icon-btn {
            padding: 4px 10px;
            font-size: 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñËßÇËÆæÁΩÆÈ°µÈù¢Â∏ÉÂ±Ä‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
        
        /* 1. ‰øÆÊ≠£ÊªöÂä®ÈóÆÈ¢ò */
        #wallpaper-screen .form-container {
            /* Ê†∏ÂøÉ‰øÆÊ≠£1: Ëß£ÂÜ≥flexÂ∏ÉÂ±Ä‰∏ãÁöÑÊªöÂä®ÂÜ≤Á™ÅÔºåËÆ©ÊªöÂä®Êù°ËÉΩÊ≠£Â∏∏Âá∫Áé∞ */
            min-height: 0; 
        }
        
        /* 2. ‰øÆÊ≠£Â£ÅÁ∫∏È¢ÑËßàË¢´ÂéãÊâÅÁöÑÈóÆÈ¢ò */
        #wallpaper-preview {
            /* Ê†∏ÂøÉ‰øÆÊ≠£2: Èò≤Ê≠¢È¢ÑËßàÊ°ÜË¢´ËøáÂ§öÁöÑÂÜÖÂÆπÊå§ÂéãÂèòÂΩ¢ÔºåËÆ©ÂÆÉ‰øùÊåÅËá™Â∑±ÁöÑÈ´òÂ∫¶ */
            flex-shrink: 0; 
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàÜ‰∫´ÈìæÊé•ÂäüËÉΩÊ†∑Âºè (Êó†ÂõæÁâà) ‚ñº‚ñº‚ñº */
        
        /* 1. ÊµèËßàÂô®ÁïåÈù¢ËÉåÊôØËâ≤ÂíåÂÜÖÂÆπÂå∫Ê†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        #browser-screen {
            background-color: #f8f9fa;
        }
        #browser-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        #browser-content .article-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        #browser-content .article-meta {
            font-size: 13px;
            color: #8a8a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        #browser-content .article-body {
            white-space: pre-wrap;
            word-break: break-word;
        }
        #browser-content .article-body p {
            margin-bottom: 1em;
        }
        
        /* 2. ËÅäÂ§©Ê∞îÊ≥°‰∏≠ÁöÑÈìæÊé•Âç°ÁâáÊ†∑Âºè (Êó†ÂõæÁâà) */
        
        
        .link-share-card {
            width: 210px; 
            background-color: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-share-card:hover {
            background-color: #f9f9f9;
        }
        
        .link-share-card .title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .description {
            font-size: 13px;
            color: #8a8a8a;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-share-card .footer {
            display: flex; /* ËÆ©ÂõæÊ†áÂíåÊñáÂ≠óÊ∞¥Âπ≥ÂØπÈΩê */
            align-items: center;
            gap: 6px; /* ÂõæÊ†áÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px; /* Âíå‰∏äÈù¢ÁöÑÊèèËø∞ÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
        }
        .link-share-card .footer-icon{
            width: 14px;
            height: 14px;
            flex-shrink: 0; /* Èò≤Ê≠¢ÂõæÊ†áË¢´ÂéãÁº© */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ÂçïÊù°ËØÑËÆ∫ÁöÑÂÆπÂô®ÔºåÁé∞Âú®ÈúÄË¶ÅÁõ∏ÂØπÂÆö‰Ωç */
        .comment-item {
            position: relative;
            padding-right: 25px; /* Âú®Âè≥‰æßÁïôÂá∫Âà†Èô§ÊåâÈíÆÁöÑÁ©∫Èó¥ */
        }
        
        /* ËØÑËÆ∫Âà†Èô§ÊåâÈíÆÁöÑÊ†∑Âºè */
        .comment-delete-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0; /* ÈªòËÆ§ÈöêËóè */
        }
        
        /* Èº†Ê†áÊÇ¨ÂÅúÂú®ËØÑËÆ∫‰∏äÊó∂ÔºåÊòæÁ§∫Âà†Èô§ÊåâÈíÆ */
        .comment-item:hover .comment-delete-btn {
            opacity: 1;
        }
        
        .comment-delete-btn:hover {
            background-color: #f0f0f0;
            color: #ff3b30;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ÊääËøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑCSSÔºåÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëÂ§úÈó¥Ê®°ÂºèÊ†∑Âºè === */
        
        /* Ê†∏ÂøÉÔºöÂΩì #phone-screen Êã•Êúâ .dark-mode Á±ªÊó∂ÔºåÊøÄÊ¥ª‰ª•‰∏ãÊâÄÊúâÊ†∑Âºè */
        
        /* 1. ÂÖ®Â±ÄËÉåÊôØÂíåÊñáÊú¨È¢úËâ≤ */
        #phone-screen.dark-mode {
            --secondary-bg: #1c1c1e; /* ‰∏ªË¶ÅÂç°ÁâáËÉåÊôØËâ≤ */
            --border-color: #38383a;  /* ËæπÊ°ÜÈ¢úËâ≤ */
            --text-primary: #ffffff;   /* ‰∏ªË¶ÅÊñáÂ≠óÈ¢úËâ≤ */
            --text-secondary: #8d8d92; /* Ê¨°Ë¶ÅÊñáÂ≠ó/ÂõæÊ†áÈ¢úËâ≤ */
        }
        
        /* 2. ÂêÑ‰∏™È°µÈù¢ÁöÑ‰∏ªËÉåÊôØËâ≤ */
        #phone-screen.dark-mode #chat-list-screen,
        #phone-screen.dark-mode #qzone-screen .qzone-content,
        #phone-screen.dark-mode #memories-view {
            background-color: #000000;
        }
        
        /* 3. ËÅäÂ§©ÂàóË°® */
        #phone-screen.dark-mode #chat-list {
            background-color: #000000;
        }
        #phone-screen.dark-mode .chat-list-item {
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .chat-group-header {
            background-color: #1c1c1e; /* ‰ªéÁôΩËâ≤Êîπ‰∏∫Ê∑±ÁÅ∞Ëâ≤ */
            border-bottom: 1px solid #38383a; /* ÁªôÂÆÉ‰∏Ä‰∏™ÁªÜÂæÆÁöÑ‰∏ãËæπÊ°Ü */
        }
        #phone-screen.dark-mode .chat-list-item .name,
        #phone-screen.dark-mode .chat-group-header .group-name {
            color: #ffffff;
        }
        #phone-screen.dark-mode .chat-list-item:hover {
            background-color: #1c1c1e;
        }
        
        /* 4. È°∂ÈÉ®/Â∫ïÈÉ®ÂØºËà™Ê†è */
        #phone-screen.dark-mode .header,
        #phone-screen.dark-mode .qzone-header {
            background-color: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
        #phone-screen.dark-mode .header .back-btn,
        #phone-screen.dark-mode .header .action-btn,
        #phone-screen.dark-mode .header .save-btn {
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-list-bottom-nav {
            background-color: rgba(25, 25, 25, 0.9);
            border-top-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .nav-item.active {
            color: #ffffff;
        }
        
        /* 5. ËÅäÂ§©ÁïåÈù¢ */
        #phone-screen.dark-mode #chat-input-area {
            background-color: rgba(5, 5, 5, 0.8);
            border-top: none;
        }
        #phone-screen.dark-mode #chat-input {
            background-color: #3e3e42;
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .chat-action-icon-btn {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
        }
        #phone-screen.dark-mode #send-btn {
            background-color: var(--accent-color);
        }
        
        /* 6. Âä®ÊÄÅ (QZone) ÁïåÈù¢ */
        #phone-screen.dark-mode .qzone-actions-bar,
        #phone-screen.dark-mode .qzone-post-item {
            background-color: #1c1c1e;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }
        #phone-screen.dark-mode .action-item:not(:last-child)::after {
            background-color: #333;
        }
        #phone-screen.dark-mode .post-footer,
        #phone-screen.dark-mode .post-likes-section {
            border-top-color: #333;
        }
        #phone-screen.dark-mode .post-likes-section {
            background-color: rgba(0, 123, 255, 0.1);
        }
        #phone-screen.dark-mode .comment-input {
            background-color: #333;
            color: #ffffff;
        }
        #phone-screen.dark-mode .comment-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .post-actions-btn:hover {
            background-color: #333;
        }
        #phone-screen.dark-mode .at-mention-popup {
            background-color: #1c1c1e;
            border-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item {
            border-bottom-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item:hover {
            background-color: #333;
        }
        
        /* 7. ÂõûÂøÜÂΩïÁïåÈù¢ */
        #phone-screen.dark-mode .memory-card {
            background-color: #1c1c1e;
            border-left-color: #e6a753;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
        }
        #phone-screen.dark-mode .memory-card .header {
            background-color: #2c2c2e;
            border-bottom-color: #38383a;
            margin: -15px -15px 8px -15px;
            padding: 12px 15px;
            border-radius: 12px 12px 0 0;
        }
        #phone-screen.dark-mode .memory-card .header .date,
        #phone-screen.dark-mode .memory-card .header .author,
        #phone-screen.dark-mode .memory-card .content {
            color: #e0e0e0;
        }
        
        /* 8. ÂÖ∂‰ªñËÆæÁΩÆÂíåÂàóË°®È°µ */
        #phone-screen.dark-mode #api-settings-screen,
        #phone-screen.dark-mode #font-settings-screen,
        #phone-screen.dark-mode #wallpaper-screen,
        #phone-screen.dark-mode #contact-picker-screen,
        #phone-screen.dark-mode #member-management-screen,
        #phone-screen.dark-mode #world-book-editor-screen,
        #phone-screen.dark-mode #world-book-list,
        #phone-screen.dark-mode .list-item:hover,
        #phone-screen.dark-mode .list-container,
        #phone-screen.dark-mode .form-container {
            background-color: #000000;
        }
        #phone-screen.dark-mode .form-group input, 
        #phone-screen.dark-mode .form-group select, 
        #phone-screen.dark-mode .form-group textarea {
            background-color: #1c1c1e;
            color: #ffffff;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .form-button-secondary {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ÊääËøô‰∏ÄÊï¥Âùó„ÄêÂÖ®Êñ∞ÁöÑ‰øÆÊ≠£CSS„ÄëÔºåÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëÂ§úÈó¥Ê®°ÂºèËßÜËßâ‰øÆÊ≠£ === */
        
        /* 1. ‰øÆÊ≠£Âä®ÊÄÅÂç°ÁâáÂÜÖÁöÑÊñáÂ≠óÈ¢úËâ≤ */
        #phone-screen.dark-mode .qzone-post-item .post-nickname,
        #phone-screen.dark-mode .qzone-post-item .post-content {
            color: #f0f0f0; /* ‰ªéÊ∑±ÁÅ∞Ëâ≤Êîπ‰∏∫Êòé‰∫ÆÁöÑÊµÖÁÅ∞Ëâ≤ */
        }
        
        /* 2. ‰øÆÊ≠£Êî∂ËóèÂç°ÁâáÂÜÖÁöÑÊñáÂ≠óÈ¢úËâ≤ */
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
        #phone-screen.dark-mode .favorite-item-card .fav-card-content {
            color: #f0f0f0; /* ÂêåÊ†∑Êîπ‰∏∫ÊµÖÁÅ∞Ëâ≤ */
        }
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
            color: #8d8d92; /* Êù•Ê∫êÊñáÂ≠óÁî®Ê¨°Ë¶ÅÁÅ∞Ëâ≤ */
        }
        
        /* 3. ‰øÆÊ≠£Êî∂ËóèÈ°µÁöÑÊêúÁ¥¢Ê†èËÉåÊôØÂíåËæìÂÖ•Ê°ÜÊ†∑Âºè */
        #phone-screen.dark-mode .search-bar-container {
            background-color: #000000; /* ÂÆπÂô®ËÉåÊôØÂèò‰∏∫Á∫ØÈªë */
        }
        #phone-screen.dark-mode #favorites-search-input {
            background-color: #1c1c1e; /* ËæìÂÖ•Ê°ÜËÉåÊôØÂèò‰∏∫Ê∑±ÁÅ∞ */
            border-color: #38383a;     /* ËæπÊ°ÜÈ¢úËâ≤ÂèòÊöó */
            color: #ffffff;            /* ËæìÂÖ•ÊñáÂ≠óÂèò‰∏∫ÁôΩËâ≤ */
        }
        #phone-screen.dark-mode #favorites-search-input::placeholder {
            color: #8d8d92; /* Âç†‰ΩçÁ¨¶ÊñáÂ≠óÈ¢úËâ≤ÂèòÊöó */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ÊääËøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑCSSÔºåÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëiOSÈ£éÊ†ºÁöÑToggle SwitchÂºÄÂÖ≥Ê†∑Âºè === */
        
        /* 1. ÂºÄÂÖ≥ÁöÑÂÆπÂô® */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        
        /* 2. ÈöêËóèÊéâÂéüÂßãÁöÑ checkbox ËæìÂÖ•Ê°Ü */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        /* 3. ÂºÄÂÖ≥ÁöÑËÉåÊôØÔºàÈÇ£‰∏™Ê§≠ÂúÜÔºâ */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9eb; /* ÂÖ≥Èó≠Êó∂ÁöÑËÉåÊôØËâ≤ */
            transition: .4s;
            border-radius: 34px;
        }
        
        /* 4. ÂºÄÂÖ≥‰∏äÁöÑÂúÜÁÇπ */
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* 5. „ÄêÊ†∏ÂøÉ„ÄëÂΩì checkbox Ë¢´ÈÄâ‰∏≠Êó∂ÔºàÂç≥ÂºÄÂêØÁä∂ÊÄÅÔºâ */
        input:checked + .slider {
            background-color: #34c759; /* ÂºÄÂêØÊó∂ÁöÑËÉåÊôØËâ≤ÔºàiOSÁªøËâ≤Ôºâ*/
        }
        
        input:checked + .slider:before {
            transform: translateX(20px); /* ËÆ©ÂúÜÁÇπÊªëÂä®Âà∞Âè≥Ëæπ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§çÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§çÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. ËæìÂÖ•Ê°Ü‰∏äÊñπÁöÑ‚ÄúÂõûÂ§çÈ¢ÑËßàÊ†è‚Äù */
        #reply-preview-bar {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            padding: 8px 12px;
            margin: 0 8px 8px 8px; /* ÂíåËæìÂÖ•Ê°ÜÂë®Âõ¥ÁöÑËæπË∑ù‰øùÊåÅ‰∏ÄËá¥ */
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--accent-color);
            border-radius: 6px;
            position: relative;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        #phone-screen.dark-mode #reply-preview-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .reply-preview-content .sender {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .reply-preview-content .text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* Á°Æ‰øùÁúÅÁï•Âè∑ÁîüÊïà */
            max-width: 95%;
        }
        
        #cancel-reply-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 2. Ê∂àÊÅØÊ∞îÊ≥°ÂÜÖÈÉ®ÁöÑ‚ÄúÂºïÁî®Ê∂àÊÅØÂùó‚Äù */
        .quoted-message {
            padding: 6px 10px;
            margin-bottom: 6px;
            background-color: rgba(0, 0, 0, 0.04);
            border-left: 2px solid var(--accent-color);
            border-radius: 4px;
            font-size: 0.9em; /* Â≠ó‰ΩìÊØîÊ≠£ÊñáÂ∞è‰∏ÄÁÇπ */
            opacity: 0.8;
        }
        
        #phone-screen.dark-mode .quoted-message {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: #a0cff1;
        }
        
        .quoted-message .quoted-sender {
            font-weight: 600;
            color: var(--accent-color);
        }
        #phone-screen.dark-mode .quoted-message .quoted-sender {
            color: #a0cff1;
        }
        
        .quoted-message .quoted-content {
            color: var(--text-secondary);
            white-space: normal;     /* Ê†∏ÂøÉ‰øÆÊ≠£1: ÂÖÅËÆ∏ÊñáÊú¨Ê≠£Â∏∏Êç¢Ë°å */
            word-break: break-word;  /* Ê†∏ÂøÉ‰øÆÊ≠£2: Âº∫Âà∂ÈïøÂçïËØçÊàñËøûÁª≠Â≠óÁ¨¶Êñ≠ÂºÄÔºåÈò≤Ê≠¢Ê∫¢Âá∫ */
            display: block;
        }
        
        /* === Â≠ó‰ΩìÈ¢ÑËßàÊ°ÜÊ†∑Âºè (‰øÆÊ≠£Âêé) === */
        
        /* ÈªòËÆ§ÔºàÊó•Èó¥Ê®°ÂºèÔºâÁöÑÊ†∑Âºè */
        #font-preview {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9; /* Êó•Èó¥Ê®°ÂºèÁöÑÊµÖÁÅ∞Ëâ≤ËÉåÊôØ */
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* È¢ÑËßàÊ°ÜÈáåÁöÑÊñáÂ≠óÈ¢úËâ≤ÔºåÈªòËÆ§ÊòØÈªëËâ≤ */
        #font-preview p {
            color: var(--text-primary);
        }
        
        /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑ‰øÆÊ≠£Ê†∑Âºè */
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e; /* Ê∑±ÁÅ∞Ëâ≤ËÉåÊôØ */
            border-color: #38383a;     /* ÊöóËâ≤ËæπÊ°Ü */
        }
        
        /* Â§úÈó¥Ê®°Âºè‰∏ãÔºåÈ¢ÑËßàÊ°ÜÈáåÁöÑÊñáÂ≠óÂèò‰∏∫ÁôΩËâ≤ */
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ≤æËá¥ÁâàËΩ¨Ë¥¶Êìç‰ΩúÂºπÁ™óÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .transfer-actions-content {
            background-color: #fff0f5; /* Á≤âÂ´©ÁöÑËÉåÊôØËâ≤ */
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); /* Á≤âËâ≤Èò¥ÂΩ± */
            text-align: center;
            position: relative;
            border: 1px solid #ffcce0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .transfer-actions-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b; /* Ê∑±Á≤âËâ≤Ê†áÈ¢ò */
            margin-bottom: 15px;
        }
        
        .transfer-actions-body p {
            font-size: 15px;
            color: #555;
            margin: 0 0 25px 0;
            line-height: 1.5;
        }
        
        .transfer-actions-footer {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .transfer-actions-footer .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }
        
        .transfer-actions-footer .action-btn:active {
            transform: scale(0.95);
        }
        
        .transfer-actions-footer .action-btn.accept {
            background: linear-gradient(135deg, #ff85b3, #ff69b4);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
        }
        
        .transfer-actions-footer .action-btn.decline {
            background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .transfer-actions-content .cancel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: #a35c7b;
            font-size: 20px;
            line-height: 28px;
            cursor: pointer;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* === Êú™ËØªÊ∂àÊÅØÁ∫¢ÁÇπÊ†∑Âºè === */
        .unread-count-wrapper {
            flex-shrink: 0;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px; /* ËÆ©Á∫¢ÁÇπÂíåÂêçÂ≠óÂ∑Æ‰∏çÂ§öÈ´ò */
        }
        
        .unread-count {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background-color: #ff3b30; /* iOS È£éÊ†ºÁöÑÁ∫¢Ëâ≤ */
            color: white;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            text-align: center;
            border-radius: 10px; /* ÂúÜËßíÁü©ÂΩ¢ */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            display: none; /* ÈªòËÆ§ÈöêËóè */
            justify-content: center;
            align-items: center;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄöËØùËÆ∞ÂΩïÈ°µÈù¢‰∏éÂç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* Á°Æ‰øùÈ°µÈù¢ËÉåÊôØËâ≤Áªü‰∏Ä */
        #call-history-screen {
            background-color: #f0f2f5;
        }
        
        /* ÈÄöËØùËÆ∞ÂΩïÂç°ÁâáÊ†∑Âºè */
        .call-record-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 5px solid var(--accent-color);
        }
        .call-record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        /* Âç°ÁâáÂ§¥ÈÉ®ÔºöÂåÖÂê´Êó•ÊúüÂíåÊó∂Èïø */
        .call-record-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .call-record-card .card-header .duration {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Âç°Áâá‰∏ª‰ΩìÔºöÂèÇ‰∏éËÄÖÂ§¥ÂÉè */
        .call-record-card .card-body {
            display: flex;
            align-items: center;
        }
        .call-record-card .participants-avatars {
            display: flex;
            align-items: center;
        }
        .call-record-card .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* ËÆ©Â§¥ÂÉèÊúâ‰∏Ä‰∏™ÊºÇ‰∫ÆÁöÑÂ†ÜÂè†ÊïàÊûú */
        .call-record-card .participant-avatar:not(:first-child) {
            margin-left: -12px;
        }
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        /* --- ÈÄöËØùËØ¶ÊÉÖÂºπÁ™óÊ†∑Âºè --- */
        #transcript-modal-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
        }
        .transcript-entry {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            line-height: 1.5;
            word-break: break-word;
        }
        .transcript-entry.user {
            background-color: #dcf8c6; /* Á±ª‰ººÂæÆ‰ø°ÁöÑÁªøËâ≤ */
            align-self: flex-end;
        }
        .transcript-entry.assistant {
            background-color: #ffffff;
            align-self: flex-start;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        #chat-list-title {
            cursor: pointer;
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄöËØùËÆ∞ÂΩïÂç°ÁâáÁæéÂåñÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        .call-record-card .card-body {
            /* Â∞Ü body Êîπ‰∏∫ flex Â∏ÉÂ±ÄÔºåËÆ©Ê†áÈ¢òÂíåÂèÇ‰∏éËÄÖ‰ø°ÊÅØÂûÇÁõ¥ÊéíÂàó */
            display: flex;
            flex-direction: column;
            gap: 8px; /* Ê†áÈ¢òÂíåÂèÇ‰∏éËÄÖ‰ø°ÊÅØ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        }
        
        .call-record-card .custom-title {
            font-size: 16px;
            font-weight: 600; /* Âä†Á≤óÔºåËÆ©ÂÆÉÂÉè‰∏™Ê†áÈ¢ò */
            color: var(--text-primary);
            padding-bottom: 8px; /* Ê†áÈ¢ò‰∏ãÁöÑÁïôÁôΩ */
            border-bottom: 1px solid var(--border-color); /* Âú®Ê†áÈ¢ò‰∏ãÂä†‰∏ÄÊù°ÂàÜÂâ≤Á∫ø */
            margin-bottom: 4px; /* Âíå‰∏ãÈù¢ÁöÑÂèÇ‰∏éËÄÖ‰ø°ÊÅØÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
        }
        
        .call-record-card .participants-info {
            /* Ëøô‰∏™Êñ∞ÂÆπÂô®ËÆ©Â§¥ÂÉèÂíå‚Äú‰∏éxx‚ÄùËÉΩÊ∞¥Âπ≥ÂØπÈΩê */
            display: flex;
            align-items: center;
        }
        
        /* ÂèÇ‰∏éËÄÖÂêçÂ≠óÁöÑÊ†∑ÂºèÂæÆË∞ÉÔºåËÆ©ÂÆÉ‰∏çÈÇ£‰πàÁ™ÅÂá∫ */
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 500; /* ‰∏çÂÜçÂä†Á≤ó */
            font-size: 14px; /* Á®çÂæÆÂ∞è‰∏ÄÁÇπ */
            color: var(--text-secondary); /* ‰ΩøÁî®Ê¨°Ë¶ÅÊñáÂ≠óÈ¢úËâ≤ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπÁöÑÊ†∑Âºè */
        .voice-transcript {
            font-size: 14px;         /* ÊñáÂ≠óÂ§ßÂ∞è */
            line-height: 1.6;        /* Ë°åÈ´òÔºåËÆ©Â§öË°åÊñáÊú¨Êõ¥ÊòìËØª */
            color: var(--text-secondary); /* ‰ΩøÁî®Ê¨°Ë¶ÅÊñáÂ≠óÈ¢úËâ≤Ôºå‰∏éËØ≠Èü≥Êù°Âå∫ÂàÜ */
            padding: 8px 12px;       /* ÂÜÖËæπË∑ù */
            margin-top: 6px;         /* Âíå‰∏äÊñπÁöÑËØ≠Èü≥Êù°ÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
            background-color: rgba(0, 0, 0, 0.04); /* Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑËÉåÊôØÔºåÊõ¥ÊúâÂ±ÇÊ¨°ÊÑü */
            border-radius: 6px;      /* ÂúÜËßí */
            word-break: break-word;  /* Á°Æ‰øùÈïøÊñáÊú¨ËÉΩÊ≠£Â∏∏Êç¢Ë°å */
            display: none;           /* ÈªòËÆ§ÈöêËóè */
        }
        
        #phone-screen.dark-mode .voice-transcript {
            background-color: rgba(255, 255, 255, 0.1); /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑËÉåÊôØËâ≤ */
        }
        
        /* 2. ÊóãËΩ¨Âä†ËΩΩÂä®ÁîªÁöÑÊ†∑Âºè */
        .loading-spinner {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: var(--accent-color); /* ÊóãËΩ¨ÈÉ®ÂàÜÁöÑÈ¢úËâ≤ */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 8px; /* ÂíåÊ≥¢ÂΩ¢Âõæ„ÄÅÊó∂Èïø‰øùÊåÅ‰∏ÄÁÇπÈó¥Ë∑ù */
        }
        
        /* 3. ÂÆö‰πâÊóãËΩ¨Âä®Áîª */
        @keyframes spin {
            to {
        transform: rotate(360deg);
            }
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàÜ‰∫´ËÆ∞ÂΩïÊü•ÁúãÂô®Ê†∑Âºè‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
        #shared-history-viewer-content {
            display: flex;
            flex-direction: column; /* ËÆ©Ê∞îÊ≥°ÂûÇÁõ¥ÊéíÂàó */
            gap: 20px; /* Âú®ÊØè‰∏™Ê∞îÊ≥°‰πãÈó¥Â¢ûÂä†20ÂÉèÁ¥†ÁöÑÈó¥Ë∑ù */
            padding: 15px; /* Âú®ÂÆπÂô®ÂõõÂë®‰πüÂ¢ûÂä†‰∏Ä‰∫õÂÜÖËæπË∑ùÔºåÈÅøÂÖçÊ∞îÊ≥°Ë¥¥Ëæπ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊí≠ÊîæÂô®ÂíåÊ≠åËØçÊ†∑Âºè ‚ñº‚ñº‚ñº */
        #music-player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
            background-color: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-50px);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        #music-player-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .music-player-window { 
            width: 70%; 
            min-height: 420px;
            background-color: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-radius: 25px; 
            box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
            border: 1px solid rgba(255, 255, 255, 0.18); 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #1f1f1f; 
            position: relative;
            justify-content: space-between;
            padding-bottom: 15px;
        }
        
        .music-player-top-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            width: calc(100% - 30px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-left-cluster {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #music-return-btn, #music-exit-btn {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #555;
            padding: 5px;
            line-height: 1;
        }
        #music-exit-btn {
            font-size: 24px;
            font-weight: 400;
        }
        
        .music-progress-bar-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .time-display {
            font-size: 11px;
            color: #888;
            width: 35px;
            text-align: center;
            flex-shrink: 0;
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #e5e5e5;
            border-radius: 2.5px;
            cursor: pointer;
        }
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background-color: #333;
            border-radius: 2.5px;
        }
        
        #music-lyrics-container {
            width: 100%;
            height: 192px;
            overflow: hidden;
            position: relative;
            -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
            mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
        }
        
        #music-lyrics-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .lyric-line {
            padding: 4px 0;
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            transition: all 0.5s ease;
            opacity: 0.7;
            transform: scale(0.95);
        }
        
        .lyric-line.active {
            font-size: 16px;
            color: #000;
            opacity: 1;
            transform: scale(1);
        }
        
        .music-player-controls-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .music-controls {
            margin-top: 0;
        }
        
        #music-return-btn, #music-exit-btn, #music-playlist-btn {
            position: relative;
        }
        
        #music-return-btn { top: -2px; }
        #music-playlist-btn { top: -3px; }
        
        .playlist-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .playlist-action-btn {
            font-size: 18px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .playlist-action-btn:hover { color: #000; }
        .delete-track-btn { font-size: 24px; color: #ff3b30; }
        .delete-track-btn:hover { color: #c00; }
        .lyrics-btn { font-weight: 500; }
        
        /* --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁ°Æ‰øùÂ§¥ÂÉèÂ∞∫ÂØ∏ --- */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%;
            object-fit: cover;
            flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊí§ÂõûÊ∂àÊÅØÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. Êí§ÂõûÊ∂àÊÅØÁöÑÂç†‰ΩçÁ¨¶Ê†∑Âºè */
        .recalled-message-placeholder {
            align-self: center; /* Â±Ö‰∏≠ÊòæÁ§∫ */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* ËÆ©ÂÆÉÁúãËµ∑Êù•ÂèØ‰ª•ÁÇπÂáª */
        }
        
        /* 2. Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÈÄÇÈÖç */
        #phone-screen.dark-mode .recalled-message-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        /* 3. AIÊí§ÂõûÊ∂àÊÅØÊó∂ÁöÑÂä®ÁîªÊïàÊûú */
        @keyframes recall-animation {
          from {
            opacity: 1;
            transform: scale(1);
          }
          to {
            opacity: 0;
            transform: scale(0.8);
          }
        }
        
        .message-wrapper.recalled-animation {
          animation: recall-animation 0.3s ease-out forwards;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊí§ÂõûÊ∂àÊÅØÊ†∑Âºè‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
        
        /* Âº∫Âà∂Êí§ÂõûÊ∂àÊÅØÁöÑÂç†‰ΩçÁ¨¶‰∏çÊç¢Ë°åÔºåÂπ∂‰øùÊåÅÂÜÖÂÆπÂ±Ö‰∏≠ */
        .recalled-message-placeholder {
            white-space: nowrap; /* Ê†∏ÂøÉÔºöÁ¶ÅÊ≠¢ÊñáÊú¨Êç¢Ë°å */
            display: inline-block; /* ËÆ©ËÉåÊôØÊ†πÊçÆÂÜÖÂÆπËá™ÈÄÇÂ∫îÂÆΩÂ∫¶ */
            padding: 4px 12px;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏ñÁïå‰π¶ÂàÜÁ±ªÂàóË°®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .world-book-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .world-book-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        .world-book-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        .world-book-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        .world-book-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .world-book-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        .world-book-group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .world-book-group-content.collapsed {
            max-height: 0;
        }
        #phone-screen.dark-mode .world-book-group-header {
            background-color: #1c1c1e;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÁΩÆÈ°∂Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .chat-list-item.pinned {
            background-color: #f0f2f5; /* Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑ„ÄÅ‰∏çÂêåÁöÑËÉåÊôØËâ≤ */
        }
        
        #phone-screen.dark-mode .chat-list-item.pinned {
            background-color: #2c2c2e; /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÁΩÆÈ°∂ËÉåÊôØËâ≤ */
        }
        /* ‚ñº‚ñº‚ñº ‰øÆÂ§çËæìÂÖ•Ê°ÜÈÅÆÊå°ÊåâÈíÆÁöÑÂ∏ÉÂ±ÄÈóÆÈ¢ò ‚ñº‚ñº‚ñº */
        #chat-input-area {
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Èò≤Ê≠¢Êï¥‰∏™ËæìÂÖ•Âå∫Ë¢´ÊÑèÂ§ñÂéãÁº© */
            background-color: var(--secondary-bg); /* Á°Æ‰øùËÉåÊôØËâ≤Áªü‰∏ÄÔºåÈÅøÂÖçÈÄèÊòéÈáçÂè† */
        }
        
        #chat-input-actions-top {
            flex-shrink: 0; /* Èò≤Ê≠¢ÊåâÈíÆË°åË¢´ÂéãÁº© */
            padding-bottom: 8px; /* Â¢ûÂä†‰∏ÄÁÇπÂíåËæìÂÖ•Ê°ÜÁöÑÈó¥Ë∑ùÔºåÊîπÂñÑËßÇÊÑü */
        }
        
        #chat-input-main-row {
            flex-shrink: 0; /* Èò≤Ê≠¢ËæìÂÖ•Ê°ÜË°åË¢´ÂéãÁº© */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ËÅä@ÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëËØ∑Áî®ËøôÊÆµ‰ª£Á†ÅÊõøÊç¢ÊÇ®Áé∞ÊúâÁöÑ #chat-input-area Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #chat-input-area {
            position: relative; /* ‰øùÊåÅÁõ∏ÂØπÂÆö‰ΩçÔºå‰Ωú‰∏∫ÂºπÁ™óÁöÑ‚ÄúÈîöÁÇπ‚Äù */
            z-index: 20;      /* „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊèêÂçáÊï¥‰∏™ËæìÂÖ•Âå∫ÁöÑÂ±ÇÁ∫ß */
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* 2. ÂÆö‰πâËÅäÂ§©@ÂºπÁ™óÁöÑÂÖ∑‰Ωì‰ΩçÁΩÆÂíåÊ†∑Âºè */
        #chat-at-mention-popup {
            bottom: 100%; /* ÊòæÁ§∫Âú®Êï¥‰∏™ËæìÂÖ•Âå∫ÁöÑ‰∏äÊñπ */
            left: 8px;    /* ‰∏éËæìÂÖ•Âå∫Â∑¶ËæπÂÜÖËæπË∑ùÂØπÈΩê */
            right: 8px;   /* ‰∏éËæìÂÖ•Âå∫Âè≥ËæπÂÜÖËæπË∑ùÂØπÈΩê */
            width: auto;  /* ÂÆΩÂ∫¶Ëá™Âä®ÊíëÊª° */
            margin-bottom: 5px; /* ÂíåËæìÂÖ•Âå∫ÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
            /* ÂÖ∂‰ªñÊ†∑ÂºèÂ∞ÜÂ§çÁî® .at-mention-popup ÁöÑÁé∞ÊúâÊ†∑Âºè */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÂÖ¨ÂëäÊùøÂºπÁ™óÊ†∑Âºè ‚ñº‚ñº‚ñº */
        #announcement-board-modal .modal-content {
            height: 70%;
            background-color: #f0f2f5;
        }
        #announcement-board-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; /* ÂÖ¨Âëä‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        }
        #announcement-board-content .message-wrapper {
            max-width: 100%; /* ËÆ©ÂÖ¨ÂëäÊ∂àÊÅØÂèØ‰ª•ÊíëÊª°ÂÆΩÂ∫¶ */
            align-self: center;
        }
        #announcement-board-content .timestamp {
            display: none; /* ÂÖ¨ÂëäÊùøÂÜÖ‰∏çÊòæÁ§∫Êó∂Èó¥Êà≥ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÂç°ÁâáÁÆ°ÁêÜÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .announcement-item-wrapper {
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçÊìç‰ΩúÊåâÈíÆ */
            padding: 10px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .announcement-item-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            border-radius: 50%;
        }
        .announcement-item-actions:hover {
            background-color: #f0f0f0;
        }
        .pinned-indicator {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 28px;
            height: 28px;
            background-color: #ffc107;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËΩ¨ÂèëÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. ËΩ¨ÂèëÂêéÁöÑÂä®ÊÄÅÔºåÂÜÖÂµåÁöÑÂéüÂßãÂÜÖÂÆπÂÆπÂô® */
        .reposted-content-wrapper {
            background-color: #f7f7f8;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        /* Âú®Â§úÈó¥Ê®°Âºè‰∏ãÔºå‰∏∫ÂÜÖÂµåÂÆπÂô®Êèê‰æõ‰∏Ä‰∏™Ê∑±Ëâ≤ËÉåÊôØ */
        #phone-screen.dark-mode .reposted-content-wrapper {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        
        /* 2. ÁßªÈô§ÂÜÖÂµåÂéüÂßãÂÜÖÂÆπÁöÑÂ∫ïÈÉ®‰∫íÂä®Âå∫ÔºåÈÅøÂÖçÊ∑∑Ê∑Ü */
        .reposted-content-wrapper .post-footer,
        .reposted-content-wrapper .post-feedback-icons,
        .reposted-content-wrapper .post-likes-section {
            display: none;
        }
        
        /* 3. ËÆ©ÂÜÖÂµåÂÜÖÂÆπÁöÑÂ§¥ÈÉ®‰ø°ÊÅØÁ®çÂæÆÁ¥ßÂáë‰∏Ä‰∫õ */
        .reposted-content-wrapper .post-header {
            margin-bottom: 8px;
        }
        .reposted-content-wrapper .post-avatar {
            width: 32px;
            height: 32px;
        }
        .reposted-content-wrapper .post-nickname {
            font-size: 14px;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

             
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ±‰∫´‰ΩçÁΩÆÂç°ÁâáÊ†∑Âºè (ÂæÆ‰ø°È£éÊ†º V2 - ÊîØÊåÅÂõæÁâáËÉåÊôØ) ‚ñº‚ñº‚ñº */
        
        /* 1. Âç°ÁâáÊÄªÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
        .location-share-card {
            width: 230px;
            border-radius: 10px;
            overflow: hidden; 
            background-color: #fff;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            cursor: pointer; /* ËÆ©Âç°ÁâáÁúãËµ∑Êù•ÂèØ‰ª•ÁÇπÂáª */
        }
        
        /* 2. ‰∏äÂçäÈÉ®ÂàÜÔºöÁôΩËâ≤ÊñáÂ≠óÂå∫ (‰øùÊåÅ‰∏çÂèò) */
        .card-text-area {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-text-primary {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-text-secondary {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        /* 3. ‰∏ãÂçäÈÉ®ÂàÜÔºö„ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú∞Âõæ/ÂõæÁâáÂå∫ */
        .card-map-area {
            height: 100px; /* Â¢ûÂä†È´òÂ∫¶‰ª•Êõ¥Â•ΩÂú∞Â±ïÁ§∫ÂõæÁâá */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* ÂõæÁâáËÉåÊôØÁöÑÂÖ≥ÈîÆÊ†∑Âºè */
            background-size: cover;
            background-position: center;
            
            /* ÈªòËÆ§ÁöÑÁ∫ØËâ≤ËÉåÊôØ (ÂΩìÊ≤°ÊúâÊèê‰æõÂõæÁâáÊó∂ÁîüÊïà) */
            background-color: #FFF0F5; /* AIÁöÑÂç°ÁâáÁî®ÊüîÂíåÁ≤âËâ≤ */
        }
        
        /* 4. Áî®Êà∑ÂèëÈÄÅÁöÑÂç°ÁâáÔºåÂú∞ÂõæÂå∫ÈªòËÆ§Áî®ÊüîÂíåÁªøËâ≤ */
        .message-bubble.user .location-share-card .card-map-area {
            background-color: #F0FFF8;
        }
        
        /* 5. „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÁæéÂåñÂõæÈíâÂõæÊ†áÔºåÂ¢ûÂä†Èò¥ÂΩ±‰ΩøÂÖ∂Êõ¥Á™ÅÂá∫ */
        .card-pin-icon {
            font-size: 40px;
            color: #FF6B6B; /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞ÜÈ¢úËâ≤‰ªé white Êîπ‰∏∫ÊÇ®ÂñúÊ¨¢ÁöÑ‰ªªÊÑèÈ¢úËâ≤ */
        
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAI ËßíËâ≤Ë°åÂä®ÂëºÂê∏ÁÅØÊïàÊûú ‚ñº‚ñº‚ñº */
        @keyframes breathing-light {
            0% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
            50% {
        box-shadow: 0 0 18px 4px rgba(0, 123, 255, 0.8);
            }
            100% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
        }
        
        .chat-list-item .avatar.is-acting {
            /* Ê†∏ÂøÉÔºöÂ∫îÁî®ÂëºÂê∏ÁÅØÂä®Áîª */
            animation: breathing-light 2s ease-in-out infinite;
            /* (ÂèØÈÄâ) ÂêåÊó∂Ê∑ªÂä†‰∏Ä‰∏™Â∏∏‰∫ÆÁöÑËæπÊ°ÜÔºåËÆ©ÊïàÊûúÊõ¥ÊòéÊòæ */
            border: 1.5px solid rgba(0, 123, 255, 0.7);
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂä®ÊÄÅËØÑËÆ∫Âå∫Ë°®ÊÉÖÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* === „ÄêÂÖ®Êñ∞„ÄëËØÑËÆ∫Âå∫Ë°®ÊÉÖÊåâÈíÆÊ†∑Âºè (‰∏éaction-iconÈ£éÊ†ºÁªü‰∏Ä) === */
        .comment-sticker-btn {
            /* 1. ÈáçÁΩÆÊåâÈíÆÈªòËÆ§Ê†∑Âºè */
            background: none;
            border: none;
            padding: 5px; /* Â¢ûÂä†‰∏ÄÁÇπÂèØÁÇπÂáªÂå∫Âüü */
            cursor: pointer;
            
            /* 2. ‰∏éÂÖ∂‰ªñÂõæÊ†áÈ¢úËâ≤ÂíåËøáÊ∏°ÊïàÊûúÂØπÈΩê */
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        
            /* 3. ‰ΩøÁî®FlexÂ∏ÉÂ±ÄËÆ©ÂÜÖÈÉ®ÁöÑSVGÂÆåÁæéÂ±Ö‰∏≠ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comment-sticker-btn:hover {
            color: var(--text-primary); /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÂèòËâ≤ÔºåÊèê‰æõÂèçÈ¶à */
        }
        
        /* 4. ÂÆö‰πâSVGÂõæÊ†áÁöÑÊ†∑ÂºèÔºå‰∏éÁÇπËµû/ËΩ¨ÂèëÂõæÊ†áÂÆåÂÖ®‰∏ÄËá¥ */
        .comment-sticker-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* 2. ËØÑËÆ∫Âå∫Ë°®ÊÉÖÈù¢ÊùøÂÆπÂô® */
        #qzone-sticker-panel {
            position: absolute; /* ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÔºåÁî±JSÊéßÂà∂‰ΩçÁΩÆ */
            width: 280px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1010; /* Á°Æ‰øùÂú®ÂÖ∂‰ªñÂÖÉÁ¥†‰πã‰∏ä */
            display: none; /* ÈªòËÆ§ÈöêËóè */
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 3. Èù¢ÊùøÂÜÖÁöÑË°®ÊÉÖÁΩëÊ†º (‰∏çÂèò) */
        #qzone-sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }
        
        #qzone-sticker-grid .sticker-item {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: white;
            border-radius: 8px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        
        /* 4. ËØÑËÆ∫Âå∫ÈáåÁöÑË°®ÊÉÖÂõæÁâáÊ†∑Âºè (Â∞∫ÂØ∏‰øÆÊ≠£Âêé) */
        .comment-text .comment-sticker {
            max-width: 100px;  /* ÂáèÂ∞èÊúÄÂ§ßÂÆΩÂ∫¶ */
            max-height: 100px; /* ÂáèÂ∞èÊúÄÂ§ßÈ´òÂ∫¶ */
            display: block;
            background-color: transparent;
        }
        
        /* 5. „ÄêÊñ∞Â¢û„Äë‰ºòÂåñÔºöÂΩìËØÑËÆ∫ÂÜÖÂÆπÊòØË°®ÊÉÖÊó∂ÔºåË∞ÉÊï¥Èó¥Ë∑ù */
        .comment-item .comment-text:has(.comment-sticker) {
            /* Â¶ÇÊûú .comment-text ÂÜÖÈÉ®Âè™ÊúâË°®ÊÉÖÔºåÂ∞±ÁßªÈô§ÊñáÂ≠óË°åÈ´òÂ∏¶Êù•ÁöÑÈ¢ùÂ§ñËæπË∑ù */
            line-height: 1;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* === Â§¥ÂÉèÊ°ÜÈÄâÊã©Ê®°ÊÄÅÊ°ÜÊ†∑Âºè === */
        .change-frame-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        #avatar-frame-modal .modal-content {
            height: 70%;
        }
        
        #avatar-frame-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .frame-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .frame-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        
        .frame-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .frame-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }
        
        .frame-item {
            aspect-ratio: 1 / 1;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            padding: 5px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .frame-item.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        
        .frame-item .preview-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .frame-item .preview-frame {
            position: absolute;
            top: -7px;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        
        /* ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÊõøÊç¢ÊâÄÊúâÊóßÁöÑÂ§¥ÂÉèÁõ∏ÂÖ≥Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. Â§¥ÂÉèÊúÄÂ§ñÂ±ÇÂÆπÂô®ÔºåË¥üË¥£Âç†‰ΩçÂíåÂä®ÊÄÅÂèòÂÆΩ */
        .avatar-group {
            width: 34px;
            flex-shrink: 0; /* Á°Æ‰øùÂú®flexÂ∏ÉÂ±Ä‰∏≠‰∏çË¢´ÂéãÁº© */
            position: relative;
            transition: width 0.2s ease;
        }
        /* ÂΩì‰Ω©Êà¥Â§¥ÂÉèÊ°ÜÊó∂ÔºåÂ§ñÂ±ÇÂÆπÂô®ÂèòÂÆΩÔºå‰∏∫Êõ¥Â§ßÁöÑÂ§¥ÂÉèÊ°ÜÂàõÈÄ†Á©∫Èó¥ */
        .avatar-group.has-frame {
            width: 42px; 
        }
        
        /* 2. Âü∫Á°ÄÁöÑ„ÄÅÊó†Ê°ÜÁöÑÂ§¥ÂÉèÊ†∑Âºè */
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%; /* ÈªòËÆ§ÁöÑÊñπÂúÜÂΩ¢Â§¥ÂÉè */
            object-fit: cover;
        }
        
        /* 3. Â∏¶Ê°ÜÂ§¥ÂÉèÁöÑ‚ÄúÂÜÖÈÉ®ÂÆπÂô®‚Äù */
        .avatar-with-frame {
            position: relative; /* ÂÖ≥ÈîÆÔºö‰∏∫ÂÜÖÈÉ®ÁöÑÂ§¥ÂÉèÂíåÊ°ÜÊèê‰æõÂÆö‰ΩçÈîöÁÇπ */
            width: 38px;
            height: 38px;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        /* „ÄêÊ†∏ÂøÉ„ÄëÂΩìÊúâÊ°ÜÊó∂ÔºåËøô‰∏™ÂÜÖÈÉ®ÂÆπÂô®‰πüÂèòÂ§ßÔºåËÆ©ÈáåÈù¢ÁöÑÂõæÁâáÂèØ‰ª•Êõ¥Â§ß */
        .avatar-group.has-frame .avatar-with-frame {
            width: 43px;
            height: 43px;
        }
        
        /* 4. Â∏¶Ê°ÜÂ§¥ÂÉè‰∏≠ÁöÑ‚ÄúÂ§¥ÂÉèÂõæÁâáÊú¨Ë∫´‚Äù */
        .avatar-with-frame .avatar-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* ÂÆΩÂ∫¶ÊíëÊª°ÂÖ∂Áà∂ÂÆπÂô® (.avatar-with-frame) */
            height: 100%;/* È´òÂ∫¶‰πüÊíëÊª° */
            border-radius: 50%; /* ‰Ω©Êà¥Â§¥ÂÉèÊ°ÜÊó∂ÔºåÂõæÁâáÊú¨Ë∫´Âèò‰∏∫ÂúÜÂΩ¢‰ª•Êõ¥Â•ΩÂú∞ÈÄÇÈÖç */
            object-fit: cover;
            z-index: 1; /* Á°Æ‰øùÂú®Â§¥ÂÉèÊ°Ü‰∏ãÊñπ */
        }
        
        /* 5. ‚ÄúÂ§¥ÂÉèÊ°ÜÂõæÁâáÊú¨Ë∫´‚Äù */
        .avatar-with-frame .avatar-frame {
            position: absolute;
            width: 120%;  
            height: 120%; 
        
            /* --- ËøôÂ∞±ÊòØÁ°Æ‰øùÂÆåÁæéÂåÖË£πÂíåÂ±Ö‰∏≠ÁöÑÂÖ≥ÈîÆ‰ª£Á†Å --- */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* --- ÂÖ≥ÈîÆ‰ª£Á†ÅÁªìÊùü --- */
            z-index: 2; /* Á°Æ‰øùÂú®Â§¥ÂÉèÂõæÁâá‰∏äÊñπ */
            pointer-events: none; /* ËÆ©Èº†Ê†á‰∫ã‰ª∂ÂèØ‰ª•Á©øÈÄèÂ§¥ÂÉèÊ°ÜÔºåÁÇπÂà∞‰∏ãÈù¢ÁöÑÂ§¥ÂÉè */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÊñπÊ°à„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÊõøÊç¢ÊâÄÊúâÊóßÁöÑÂ§¥ÂÉèÂíåÊ∞îÊ≥°Áõ∏ÂÖ≥Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. Âº∫Âà∂Â§ñÂ±ÇÊ∞îÊ≥°ÂÆπÂô®(.message-bubble)Êàê‰∏∫‰∏Ä‰∏™ÁúüÊ≠£ÁöÑ‚ÄúÂºπÊÄß‚ÄùÈ°πÁõÆ„ÄÇ*/
        /* ËøôËÆ©ÂÆÉÂèØ‰ª•Ê≠£Á°ÆÂú∞‰∏∫ÊóÅËæπÁöÑ‚ÄúÊó∂Èó¥Êà≥‚ÄùÊî∂Áº©„ÄÇ*/
        .message-bubble {
            flex: 1;          /* ÂÖ≥ÈîÆ‰øÆÂ§ç‚ë†: ËÆ©ÂÆÉÂ°´ÂÖÖÊâÄÊúâÂèØÁî®Á©∫Èó¥ (flex-grow: 1, flex-shrink: 1) */
            min-width: 0;     /* ÂÖ≥ÈîÆ‰øÆÂ§ç‚ë°: ÂÖÅËÆ∏ÂÆÉÊî∂Áº©Ëá≥ÊØîÂÖ∂ÂÜÖÂÆπÊõ¥Â∞èÔºåËøôÊòØËß£ÂÜ≥Ê≠§Á±ªÈóÆÈ¢òÁöÑÊ†∏ÂøÉÊäÄÂ∑ß */
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
        }
        
        .message-bubble.user { 
            flex-direction: row-reverse; 
        }
        
        /* 2. Âº∫Âà∂ÂÜÖÂ±ÇÂÜÖÂÆπÂå∫(.content)‰πüÊàê‰∏∫‰∏Ä‰∏™‚ÄúÂºπÊÄß‚ÄùÈ°πÁõÆ„ÄÇ*/
        /* ËøôËÆ©ÂÆÉÂèØ‰ª•Ê≠£Á°ÆÂú∞‰∏∫ÊóÅËæπÁöÑ‚ÄúÂ§¥ÂÉè‚ÄùÊî∂Áº©„ÄÇ*/
        .message-bubble .content {
            flex: 1;          /* ÂÖ≥ÈîÆ‰øÆÂ§ç‚ë¢: ËÆ©ÂÜÖÂÆπÂå∫Â°´ÂÖÖÊ∞îÊ≥°ÂÜÖÁöÑÊâÄÊúâÂèØÁî®Á©∫Èó¥ */
            min-width: 0;     /* ÂÖ≥ÈîÆ‰øÆÂ§ç‚ë£: ÂêåÊ†∑ÂÖÅËÆ∏ÂÆÉÊî∂Áº©ÔºåÈò≤Ê≠¢ÈïøÊñáÊú¨ÊíëÁ†¥Â∏ÉÂ±Ä */
            word-break: break-all !important; /* ÂÖ≥ÈîÆ‰øÆÂ§ç‚ë§: ‰ΩøÁî®ÊúÄÂº∫ÂäõÁöÑÊç¢Ë°åÊ®°ÂºèÔºåÁ°Æ‰øùÈïø‰∏≤Â≠óÁ¨¶ËÉΩË¢´Êà™Êñ≠ */
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
        }
        
        /* 3. ÂÜçÊ¨°Á°Æ‰øùÂ§¥ÂÉèÂÆπÂô®ÁªùÂØπ‰∏çÊî∂Áº© (‰Ωú‰∏∫ÊúÄÁªà‰øùÈô©) */
        .message-bubble .avatar-group {
            flex-shrink: 0 !important;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÊñπÊ°àÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÁªàÊûÅÂº∫Âà∂‰øÆÊ≠£„ÄëËØ∑Â∞ÜËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ <style> ÁöÑÊúÄÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ‰ΩøÁî®IDÈÄâÊã©Âô®Âíå!importantÔºåÂº∫Âà∂ÊèêÂçáËøôÊù°ËßÑÂàôÁöÑ‰ºòÂÖàÁ∫ßÂà∞ÊúÄÈ´òÔºå
           ‰ª•Ë¶ÜÁõñ‰ªª‰ΩïÂèØËÉΩÂ≠òÂú®ÁöÑÊú™Áü•ÂÜ≤Á™ÅÊ†∑Âºè„ÄÇ*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂç°Áâá/ÁâπÊÆäÂÜÖÂÆπÂ±Ö‰∏≠‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈöêËóèËÅäÂ§©ÂàóË°®‰∏≠ÁöÑÂ§¥ÂÉèÊ°Ü (ÊúÄÁªà‰øÆÊ≠£Áâà) ‚ñº‚ñº‚ñº */
        
        /* 1. Âú®ËÅäÂ§©ÂàóË°®Â±èÂπï‰∏≠ÔºåÁõ¥Êé•ÈöêËóèÂ§¥ÂÉèÊ°ÜÂõæÁâá */
        #chat-list-screen .avatar-frame {
            display: none;
        }
        
        /* 2. Âº∫Âà∂ÊâÄÊúâÂ§¥ÂÉèÁöÑÊúÄÂ§ñÂ±ÇÂÆπÂô®ÔºåÂú®ÂàóË°®È°µÈÉΩ‰øùÊåÅ 45px ÁöÑÊ≠£Á°ÆÂ∞∫ÂØ∏ */
        #chat-list-screen .avatar-group {
            width: 45px;
            height: 45px;
        }
        
        /* 3. Â¶ÇÊûú‰∏Ä‰∏™Â§¥ÂÉèÊòØÂ∏¶Ê°ÜÁªìÊûÑÔºå‰πüÂº∫Âà∂ÂÖ∂ÂÜÖÈÉ®ÂÆπÂô®ÂíåÂõæÁâáÈÄÇÂ∫î 45px ÁöÑÂ∞∫ÂØ∏ */
        #chat-list-screen .avatar-group.has-frame .avatar-with-frame,
        #chat-list-screen .avatar-group.has-frame .avatar-img {
            width: 45px;
            height: 45px;
        }
        
        /* 4. Á°Æ‰øùÊâÄÊúâÂ§¥ÂÉèÂú®ÂàóË°®È°µÈÉΩÊòØÂúÜÂΩ¢ÁöÑÔºå‰øùÊåÅÁªü‰∏Ä */
        #chat-list-screen .avatar-img,
        #chat-list-screen .avatar {
            border-radius: 50%;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ¢ûÂä†ËÅäÂ§©ÂàóË°®Â§¥ÂÉè‰∏éÊñáÂ≠óÁöÑÈó¥Ë∑ù ‚ñº‚ñº‚ñº */
        
        /* 1. Âº∫Âà∂‰∏∫ËÅäÂ§©ÂàóË°®‰∏≠ÁöÑÂ§¥ÂÉèÂÆπÂô®ËÆæÁΩÆÂè≥ËæπË∑ù */
        /*    ËøôÂ∞ÜË¶ÜÁõñ‰ªª‰ΩïÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÊ†∑ÂºèÔºåÂπ∂Á°Æ‰øùÈó¥Ë∑ùÁîüÊïà */
        #chat-list .chat-list-item .avatar-group {
            margin-right: 15px !important; /* Ê†∏ÂøÉÔºöÂ¢ûÂä†Âè≥ËæπË∑ùÔºåÂ∞ÜÊñáÂ≠óÊé®ÂºÄ */
        }
        
        /* 2. (ÂèØÈÄâ‰ΩÜÊé®Ëçê) Á°Æ‰øùÊóßÁöÑÂ§¥ÂÉèÊ†∑Âºè‰∏çÂÜçÂπ≤Êâ∞Â∏ÉÂ±Ä */
        #chat-list .chat-list-item .avatar {
            margin-right: 0; /* ÁßªÈô§ÊóßÁöÑËæπË∑ùÔºåÈò≤Ê≠¢ÈáçÂ§çËÆ°ÁÆó */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂä®ÊÄÅËØÑËÆ∫Âå∫ÂõûÂ§çÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ËÆ©ËØÑËÆ∫È°πÂú®Èº†Ê†áÊÇ¨ÂÅúÊó∂È´ò‰∫ÆÔºåÂπ∂ÊòæÁ§∫ÊâãÂûãÂÖâÊ†á */
        .comment-item {
            cursor: pointer;
            transition: background-color 0.2s;
            /* ‰ΩøÁî®FlexÂ∏ÉÂ±ÄÔºåËÆ©ËØÑËÆ∫ÂÜÖÂÆπÂíåÂà†Èô§ÊåâÈíÆËÉΩÊ≠£Á°ÆÂØπÈΩê */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px; /* ÂÜÖÂÆπÂíåÂà†Èô§ÊåâÈíÆÁöÑÈó¥Ë∑ù */
            padding: 4px 6px; /* Â¢ûÂä†‰∏ÄÁÇπÂÜÖËæπË∑ùÔºåÊñπ‰æøÁÇπÂáª */
            margin: 0 -6px; /* ÊäµÊ∂àÂÜÖËæπË∑ùÔºå‰øùÊåÅËßÜËßâÂØπÈΩê */
            border-radius: 4px;
        }
        
        .comment-item:hover {
            background-color: #f0f2f5;
        }
        
        /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÊÇ¨ÂÅúÊïàÊûú */
        #phone-screen.dark-mode .comment-item:hover {
            background-color: #2c2c2e;
        }
        
        /* ËØÑËÆ∫ÂÜÖÂÆπÊñáÊú¨ÁöÑÂÆπÂô® */
        .comment-item .comment-text {
            flex-grow: 1; /* Âç†ÊçÆ‰∏ªË¶ÅÁ©∫Èó¥ */
            word-break: break-word; /* Á°Æ‰øùÈïøÂÜÖÂÆπËÉΩÊç¢Ë°å */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®‰∫éÂÖºÂÆπÊóßÊ†ºÂºèËØÑËÆ∫ÁöÑÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .legacy-comment-item {
            line-height: 1.5;
            padding: 4px 6px; /* ÂíåÊñ∞Ê†∑Âºè‰øùÊåÅ‰∏ÄËá¥ÁöÑÂÜÖËæπË∑ù */
            color: var(--text-secondary); /* Áî®Ê¨°Ë¶ÅÈ¢úËâ≤ÊòæÁ§∫Ôºå‰ª•Á§∫Âå∫Âà´ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂç°Áâá/ÁâπÊÆäÂÜÖÂÆπÂ±Ö‰∏≠‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÁªàÊûÅÂº∫Âà∂‰øÆÊ≠£„ÄëËØ∑Â∞ÜËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ <style> ÁöÑÊúÄÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* ‰ΩøÁî®IDÈÄâÊã©Âô®Âíå!importantÔºåÂº∫Âà∂ÊèêÂçáËøôÊù°ËßÑÂàôÁöÑ‰ºòÂÖàÁ∫ßÂà∞ÊúÄÈ´òÔºå
           ‰ª•Ë¶ÜÁõñ‰ªª‰ΩïÂèØËÉΩÂ≠òÂú®ÁöÑÊú™Áü•ÂÜ≤Á™ÅÊ†∑Âºè„ÄÇ*/
        
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 43px !important;
            height: 43px !important;
        }
        
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêSafari/iOS ÊúÄÁªàÂç°ÁâáÂ∏ÉÂ±Ä‰øÆÂ§ç„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº */
        
        /* 
          Á¨¨‰∏ÄÊ≠•Ôºö„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë
          Ëøô‰∏™ÈÄâÊã©Âô®‰ºö‰∏ÄÊ¨°ÊÄßÈÄâ‰∏≠ÊâÄÊúâÂåÖÂê´ÁâπÊÆäÂç°ÁâáÁöÑÊ∂àÊÅØÊ∞îÊ≥°ÂÆπÂô®(.message-bubble)„ÄÇ
          Êàë‰ª¨ÂëäËØâÂÆÉ‰∏çË¶ÅÂÜçÂº∫Âà∂Êãâ‰º∏ÔºåËÄåÊòØÊ†πÊçÆÂÜÖÈÉ®Âç°ÁâáÁöÑÂ§ßÂ∞èËá™ÈÄÇÂ∫îÂÆΩÂ∫¶„ÄÇ
        */
        .message-bubble.is-sticker,
        .message-bubble.is-voice-message,
        .message-bubble.is-transfer,
        .message-bubble.is-ai-image,
        .message-bubble.is-waimai-request,
        .message-bubble.is-red-packet,
        .message-bubble.is-poll,
        .message-bubble.is-link-share,
        .message-bubble.is-location-share {
            flex: initial; /* Ë¶ÜÁõñÊéâÈÄöÁî®ÁöÑ flex: 1ÔºåËøôÊòØËß£ÂÜ≥ÈóÆÈ¢òÁöÑÂÖ≥ÈîÆÔºåËÆ©Ê∞îÊ≥°Êú¨Ë∫´‰∏çÂÜçÊãâ‰º∏ */
            min-width: auto; /* ÂêåÊ†∑ÈáçÁΩÆ min-widthÔºåÂÖÅËÆ∏ÂÖ∂Ëá™Áî±Êî∂Áº© */
        }
        
        /* 
          Á¨¨‰∫åÊ≠•Ôºö‰øùÊåÅÂØπÂç°ÁâáÂÜÖÈÉ® .content Âå∫ÂüüÁöÑÊ†∑ÂºèÈáçÁΩÆ„ÄÇ
          Êàë‰ª¨ÁßªÈô§ÂÆÉÁöÑËÉåÊôØÂíåÂÜÖËæπË∑ùÔºåËÆ©Âç°ÁâáËá™Â∑±Ë¥üË¥£Â§ñËßÇ„ÄÇ
        */
        .message-bubble.is-sticker .content,
        .message-bubble.is-voice-message .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-ai-image .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-link-share .content,
        .message-bubble.is-location-share .content {
            /* ‰øùÊåÅËøô‰∏™Â•Ω‰π†ÊÉØÔºåÁ°Æ‰øùÂÜÖÂÆπÂå∫‰πü‰∏çÊãâ‰º∏ */
            flex: initial; 
            
            /* ÁßªÈô§ÊâÄÊúâÂèØËÉΩÂπ≤Êâ∞Âç°ÁâáÊòæÁ§∫ÁöÑÊ†∑Âºè */
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÁªàÊûÅÁâà„ÄëÁæ§ÂÖ¨ÂëäÂØπÈΩê‰øÆÂ§ç (Âº∫Âà∂ÊâÄÊúâÂÜÖÂÆπÈù†Â∑¶) ‚ñº‚ñº‚ñº */
        
        /* 
          Á¨¨‰∏ÄÊ≠•ÔºöÂº∫Âà∂ÊâÄÊúâÊ∂àÊÅØÂùóÔºàÊó†ËÆ∫ÊòØAIËøòÊòØÁî®Êà∑ÔºâÈÉΩÂú®ÂÖ¨ÂëäÊùøÂÜÖÈù†Â∑¶ÂØπÈΩê„ÄÇ
          ËøôÁ°Æ‰øù‰∫ÜAIÂíåÁî®Êà∑ÁöÑÊ∂àÊÅØÂùóÂú®ÂûÇÁõ¥ÊñπÂêë‰∏äÊòØÂØπÈΩêÁöÑ„ÄÇ
        */
        #announcement-board-content .message-wrapper {
            align-self: flex-start !important;
        }
        
        /* 
          Á¨¨‰∫åÊ≠•ÔºöËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰∏ÄÊ≠•ÔºÅ
          Êàë‰ª¨‰∏ìÈó®ÈíàÂØπÁî®Êà∑ÁöÑÊ∂àÊÅØÊ∞îÊ≥°ÔºåÂº∫Âà∂Â∞ÜÂÖ∂ÂÜÖÈÉ®ÁöÑÂÖÉÁ¥†È°∫Â∫èÔºàÂ§¥ÂÉèÂíåÂÜÖÂÆπÔºâ
          ‰ªé‚ÄúÂèçÂêë‚ÄùÊÅ¢Â§ç‰∏∫‚ÄúÊ≠£Âêë‚ÄùÔºå‰ΩøÂÖ∂‰∏éAIÁöÑÊ∂àÊÅØÊ∞îÊ≥°Â∏ÉÂ±ÄÂÆåÂÖ®‰∏ÄËá¥„ÄÇ
        */
        #announcement-board-content .message-bubble.user {
            flex-direction: row !important;
        }
        
        /* 
          Á¨¨‰∏âÊ≠• (ÂèØÈÄâ‰ΩÜÊé®Ëçê): 
          ÂêåÊó∂ÔºåÊàë‰ª¨‰πüÂº∫Âà∂Â∞ÜÁî®Êà∑Ê∂àÊÅØÂùóÂ§ñÈÉ®ÁöÑÊó∂Èó¥Êà≥ÂíåÊ∞îÊ≥°È°∫Â∫èÊÅ¢Â§çÊ≠£Â∏∏Ôºå
          ‰ª•Èò≤Êú™Êù•ÂèØËÉΩÂá∫Áé∞ÁöÑÂ∏ÉÂ±ÄÈóÆÈ¢ò„ÄÇ
        */
        #announcement-board-content .message-wrapper.user {
            flex-direction: row !important;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÁªàÊûÅ‰øÆÂ§ç„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢Êéâ‰Ω†‰∏ä‰∏ÄÊ¨°Á≤òË¥¥ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº */
        
        /* === ËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®ÊµÆÂä®‰∏éÂ±ÇÁ∫ßÁªàÊûÅ‰øÆÂ§ç === */
        
        /* 
          ËøôÊ¨°ÁöÑ‰øÆÂ§çÊúâ‰∏§‰∏™ÂÖ≥ÈîÆÁÇπÔºö
          1. ‰æùÁÑ∂‰ΩøÁî® absolute ÂÆö‰ΩçËÆ©Â§¥ÈÉ®ÊµÆÂä®Ëµ∑Êù•„ÄÇ
          2. È¢ùÂ§ñÁªôÂÆÉ‰∏Ä‰∏™ÈùûÂ∏∏È´òÁöÑ z-index Âπ∂Áî® !important Ê†áËÆ∞Ôºå
             Ëµã‰∫àÂÆÉ‚ÄúËá≥È´òÊó†‰∏ä‚ÄùÁöÑÊùÉÂäõÔºåÂº∫Âà∂ÂÆÉÂéãÂà∂È°µÈù¢‰∏ä‰ªª‰ΩïÂÖ∂‰ªñÂÖÉÁ¥†„ÄÇ
        */
        
        /* 1. Âº∫Âà∂ËÅäÂ§©ÁïåÈù¢ÁöÑÂ§¥ÈÉ®Âèò‰∏∫ÁªùÂØπÂÆö‰ΩçÔºåÂπ∂Ëµã‰∫à‰∏Ä‰∏™ÊûÅÈ´òÁöÑÂ±ÇÁ∫ß */
        #chat-interface-screen > .header {
            position: absolute !important; /* Ê†∏ÂøÉ‰øÆÊ≠£1: ËÑ±Á¶ªÊñáÊ°£ÊµÅÔºåÊµÆÂä®Ëµ∑Êù• */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100 !important; /* Ê†∏ÂøÉ‰øÆÊ≠£2: Ëµã‰∫à‰∏Ä‰∏™ÈùûÂ∏∏È´òÁöÑ z-indexÔºåÂéãÂà∂‰∏ÄÂàá */
        }
        
        /* 2. ‰øÆÊ≠£ËÅäÂ§©ÂÜÖÂÆπÂå∫ÁöÑÂ∏ÉÂ±ÄÔºåÁßªÈô§‰∏çÂÜçÈúÄË¶ÅÁöÑË¥üÂ§ñËæπË∑ùÔºåËÆ©‰∏∫Â§¥ÈÉ®È¢ÑÁïôÁöÑ padding ÁîüÊïà */
        #chat-interface-screen #chat-messages {
            margin-top: 0 !important; /* Ê†∏ÂøÉ‰øÆÊ≠£3: ÁßªÈô§Áî®‰∫é‚Äú‰∏äÊãâ‚ÄùÁöÑË¥üÂ§ñËæπË∑ù */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§ç‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàËß£ÂÜ≥ÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊéâÊâÄÊúâÊóßÁöÑ‰øÆÂ§ç‰ª£Á†Å ‚ñº‚ñº‚ñº */
        
        /* === ËÅäÂ§©ÁïåÈù¢Â∏ÉÂ±Ä‰∏éÂ±ÇÁ∫ßÁªàÊûÅ‰øÆÂ§ç === */
        
        /* 
          Á¨¨‰∏ÄÈÉ®ÂàÜÔºö‰øÆÂ§çÈü≥‰πêÊí≠ÊîæÂô®Ë¢´ÈÅÆÊå°ÁöÑÈóÆÈ¢ò
          Êàë‰ª¨ÁªôÊí≠ÊîæÂô®‰∏Ä‰∏™ÊØîÂ§¥ÈÉ®Êõ¥È´òÁöÑ z-indexÔºåËÆ©ÂÆÉËÉΩÊ≠£Á°ÆÂú∞Ë¶ÜÁõñÊâÄÊúâÂÜÖÂÆπ„ÄÇ
        */
        #music-player-overlay {
            z-index: 200 !important;
        }
        
        /* 
          Á¨¨‰∫åÈÉ®ÂàÜÔºöÂΩªÂ∫ïÈáçÊûÑËÅäÂ§©È°µÈù¢ÁöÑÂ∏ÉÂ±ÄÔºåËß£ÂÜ≥ÂÆΩÂ∫¶ÂíåÈÅÆÊå°ÈóÆÈ¢ò
          Êàë‰ª¨Â∞ÜÈááÁî®ÊúÄÁ®≥ÂÆö„ÄÅÊúÄÁé∞‰ª£ÁöÑÂ∏ÉÂ±ÄÊñπÂºèÔºö
          - Â§¥ÈÉ®ÂíåËæìÂÖ•Ê°ÜÈÉΩ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÔºåÂàÜÂà´‚ÄúÈíâ‚ÄùÂú®Â±èÂπïÁöÑÈ°∂ÈÉ®ÂíåÂ∫ïÈÉ®„ÄÇ
          - ËÅäÂ§©ÂÜÖÂÆπÂå∫ÂàôÂç†ÊçÆÊï¥‰∏™Â±èÂπïÁöÑÈ´òÂ∫¶ÔºåÂπ∂ÈÄöËøáÂÜÖËæπË∑ùÔºàpaddingÔºâ‰∏∫Â§¥ÈÉ®ÂíåËæìÂÖ•Ê°ÜÁïôÂá∫Á©∫Èó¥„ÄÇ
          ËøôÊ†∑ÂèØ‰ª•ÂÆåÁæéÂÆûÁé∞ÂÜÖÂÆπÂú®ÈÄèÊòéÈ°∂/Â∫ïÈÉ®‰πã‰∏ãÊªöÂä®ÁöÑÁæéËßÇÊïàÊûúÔºå‰∏î‰∏ç‰ºöÂÜçÂá∫Áé∞ÂÆΩÂ∫¶ËÆ°ÁÆóÈîôËØØ„ÄÇ
        */
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢ÊâÄÊúâÊóßÁöÑËÅäÂ§©ÁïåÈù¢Â∏ÉÂ±ÄCSS ‚ñº‚ñº‚ñº */
        
        /* 1. Á°Æ‰øùËÅäÂ§©ÁïåÈù¢ÂÆπÂô®ÊòØÂèØÈù†ÁöÑÂÆö‰ΩçÈîöÁÇπ */
        #chat-interface-screen {
            position: relative !important;
            height: 100%;
            width: 100%;
            overflow: hidden; /* Èò≤Ê≠¢‰ªª‰ΩïÊÑèÂ§ñÊ∫¢Âá∫ */
        }
        
        /* 2. Âº∫Âà∂„ÄêÂ§¥ÈÉ®„ÄëÁªùÂØπÂÆö‰ΩçÔºåÂπ∂‚ÄúÈíâ‚ÄùÂú®Â±èÂπïÈ°∂ÈÉ® */
        #chat-interface-screen > .header {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0; /* ‰ΩøÁî® left/right ÊíëÊª°ÂÆΩÂ∫¶ÔºåÊØî width:100% Êõ¥ÂèØÈù† */
            width: auto !important; 
            z-index: 100 !important; /* Ëµã‰∫à‰∏Ä‰∏™ÈùûÂ∏∏È´òÁöÑÂ±ÇÁ∫ßÔºåÁ°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç */
        }
        
        /* 3. Âº∫Âà∂„ÄêËæìÂÖ•Ê°Ü„Äë‰πüÁªùÂØπÂÆö‰ΩçÔºåÂπ∂‚ÄúÈíâ‚ÄùÂú®Â±èÂπïÂ∫ïÈÉ® */
        #chat-interface-screen #chat-input-area {
            position: absolute !important;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto !important;
            z-index: 100 !important;
            /* Ê†∏ÂøÉÔºö‰∏∫ËæìÂÖ•Ê°ÜÊú¨Ë∫´Ê∑ªÂä†ÈÄÇÈÖç‚ÄúÂ∞èÈªëÊù°‚ÄùÁöÑÂ∫ïÈÉ®ÂÜÖËæπË∑ù */
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
        }
        
        /* 4. „ÄêÊ†∏ÂøÉ„ÄëÈáçÊñ∞ÂÆö‰πâ„ÄêËÅäÂ§©ÂÜÖÂÆπÂå∫„ÄëÁöÑÂ∏ÉÂ±Ä */
        #chat-interface-screen #chat-messages {
            /* ËÆ©ÂÆÉÂ°´Êª°Êï¥‰∏™Â±èÂπï */
            height: 100% !important; 
            width: 100% !important;
            
            /* ÂÖÅËÆ∏ÂÖ∂ÂÜÖÂÆπÂûÇÁõ¥ÊªöÂä® */
            overflow-y: auto !important; 
            
            /* Á°Æ‰øù padding ÁöÑËÆ°ÁÆóÊñπÂºèÊ≠£Á°Æ */
            box-sizing: border-box !important; 
            
            /* ÁßªÈô§ÊâÄÊúâÂèØËÉΩÂπ≤Êâ∞Â∏ÉÂ±ÄÁöÑ margin */
            margin-top: 0 !important; 
        
            /* ÂÖ≥ÈîÆÔºö‰ΩøÁî®ÂÜÖËæπË∑ù‰∏∫È°∂ÈÉ®ÁöÑ‚ÄúÂ§¥ÈÉ®‚ÄùÂíåÂ∫ïÈÉ®ÁöÑ‚ÄúËæìÂÖ•Ê°Ü‚ÄùÁïôÂá∫Á©∫Èó¥ */
            /* ËøôÊ†∑ÂÜÖÂÆπÂ∞±‰ºöÂú®ÂçäÈÄèÊòéÁöÑÈ°∂/Â∫ïÈÉ®‰πã‰∏ãÊªöÂä®ÔºåÊïàÊûúÁæéËßÇ‰∏îÁ≤æÂáÜ */
            padding-top: 150px !important;  /* ‰∏∫Â§¥ÈÉ®È¢ÑÁïôÁ∫¶110pxÁ©∫Èó¥ */
            padding-bottom: 150px !important; /* ‰∏∫ËæìÂÖ•Ê°ÜÈ¢ÑÁïôÁ∫¶120pxÁ©∫Èó¥ */
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§ç‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÂä®ÊÄÅÂ∑≤Âà†Èô§‚ÄùÊèêÁ§∫Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .post-deleted-placeholder {
            align-self: center;
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; /* ÂÖ≥ÈîÆÔºöËÆ©ÂÆÉÁúãËµ∑Êù•ÂèØ‰ª•ÁÇπÂáª */
        }
        
        #phone-screen.dark-mode .post-deleted-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Ê∂ÇÈªëÔºàÂâßÈÄèÔºâÂäüËÉΩÊ∑ªÂä†ÁöÑÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .spoiler {
            background-color: #333; /* Ê∂ÇÈªëÁöÑËÉåÊôØËâ≤ */
            color: #333;           /* Ê∂ÇÈªëÁöÑÊñáÂ≠óÈ¢úËâ≤Ôºå‰ΩøÂÖ∂‰∏éËÉåÊôØËûç‰∏∫‰∏Ä‰Ωì */
            padding: 0 4px;         /* ËΩªÂæÆÁöÑÂ∑¶Âè≥ÂÜÖËæπË∑ùÔºå‰ΩøÂÖ∂Êõ¥ÁæéËßÇ */
            border-radius: 4px;     /* ÂúÜËßí */
            cursor: pointer;        /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫‰∏∫ÂèØÁÇπÂáªÁöÑÊâãÂûã */
            transition: all 0.2s ease-in-out; /* ËÆ©ÊòæÁ§∫/ÈöêËóèÊïàÊûúÊõ¥Âπ≥Êªë */
        }
        
        /* Èº†Ê†áÊÇ¨ÂÅúÊàñÁÇπÂáªÊó∂ÔºåÊÅ¢Â§çËÉåÊôØÂíåÊñáÂ≠óÈ¢úËâ≤‰ª•ÊòæÁ§∫ÂÜÖÂÆπ */
        .spoiler:hover, .spoiler:active {
            background-color: #e0e0e0; /* ÊòæÁ§∫Êó∂Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑËÉåÊôØËâ≤ */
            color: inherit;           /* ÊÅ¢Â§ç‰∏∫Ê≠£Â∏∏ÁöÑÊñáÂ≠óÈ¢úËâ≤ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈïøÊúüËÆ∞ÂøÜÁÆ°ÁêÜÊåâÈíÆÁæéÂåñÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .memory-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px; /* Â¢ûÂä†‰∏ÄÁÇπÂèØÁÇπÂáªÂå∫ÂüüÔºåÊñπ‰æøÁî®Êà∑Êìç‰Ωú */
            border-radius: 50%; /* ÂúÜÂΩ¢ËÉåÊôØ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .memory-action-btn svg {
            width: 18px;  /* ËÆ©ÂõæÊ†áÊØîÈ°∂ÈÉ®ÁöÑÁ®çÂ∞è‰∏ÄÁÇπÔºåÊõ¥ÊòæÁ≤æËá¥ */
            height: 18px;
            stroke: var(--text-secondary); /* ÈªòËÆ§‰ΩøÁî®Ê¨°Ë¶ÅÊñáÂ≠óÁöÑÁÅ∞Ëâ≤ */
            transition: stroke 0.2s;
        }
        
        .memory-action-btn:hover {
            background-color: #e9ecef; /* Èº†Ê†áÊÇ¨ÂÅúÊó∂Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑËÉåÊôØËâ≤ */
        }
        
        /* Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÊÇ¨ÂÅúÊïàÊûú */
        #phone-screen.dark-mode .memory-action-btn:hover {
            background-color: #38383a;
        }
        
        /* ÁºñËæëÊåâÈíÆÊÇ¨ÂÅúÊó∂ÔºåÂõæÊ†áÂèò‰∏∫ËìùËâ≤ */
        .memory-action-btn.edit-memory-btn:hover svg {
            stroke: var(--accent-color);
        }
        
        /* Âà†Èô§ÊåâÈíÆÊÇ¨ÂÅúÊó∂ÔºåÂõæÊ†áÂèò‰∏∫Âç±Èô©ÁöÑÁ∫¢Ëâ≤ */
        .memory-action-btn.delete-memory-btn:hover svg {
            stroke: #ff3b30;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË°®ÊÉÖÊâπÈáèÂà†Èô§ÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºå‰∏∫Ë°®ÊÉÖÈ°πÊ∑ªÂä†‰∏Ä‰∏™ÈÄâ‰∏≠Ê°Ü */
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºåË¢´ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÈ°πÔºåÊòæÁ§∫ËìùËâ≤ËæπÊ°Ü */
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        
        /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºåÊÄªÊòØÊòæÁ§∫Âà†Èô§ÊåâÈíÆ */
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        
        /* Â∫ïÈÉ®ÊâπÈáèÂà†Èô§Êìç‰ΩúÊ†è */
        #sticker-action-bar {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
        }
        
        #sticker-action-bar button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßíËâ≤Ê¥ûÂØü‰∏éÂéÜÂè≤ËÆ∞ÂΩïÊ†∑Âºè (V5 - Â∏ÉÂ±ÄÁæéÂåñÁâà) ‚ñº‚ñº‚ñº */
        
        /* 1. ÂºπÁ™óËÉåÊôØ */
        #character-profile-modal {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        /* 2. Âç°Áâá‰∏ª‰ΩìÂÜÖÂÆπÂå∫ */
        .character-profile-content {
            width: 320px;
            height: 75vh;
            max-height: 580px;
            background-color: #f0f2f5;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂ¢ûÂä†È°∂ÈÉ®ÁöÑÂÜÖËæπË∑ùÔºåËÆ©Â§¥ÈÉ®‰ø°ÊÅØÊõ¥ËàíÂ±ï */
            padding-top: 40px; 
        }
        
        /* 3. Âè≥‰∏äËßí‚ÄúÊü•ÁúãÂéÜÂè≤‚ÄùÂõæÊ†áÊåâÈíÆ (‰øùÊåÅ‰∏çÂèò) */
        #profile-history-icon-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            padding: 0;
            z-index: 10;
        }
        #profile-history-icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        #profile-history-icon-btn svg { width: 20px; height: 20px; stroke: #b0b0b0; stroke-width: 2; }
        
        /* 4. ‰∏ªËµÑÊñôÈ°µ‰∏éÂéÜÂè≤ËÆ∞ÂΩïÈ°µÁöÑÂÆπÂô® */
        #profile-main-content, #profile-thoughts-history-view {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        
        /* 5. ‰∏ªËµÑÊñôÈ°µÁã¨ÊúâÁöÑÊ†∑Âºè */
        #profile-main-content {
            padding: 0 25px 25px 25px; /* ÁßªÈô§‰∫ÜÈ°∂ÈÉ®paddingÔºåÂõ†‰∏∫ÂÆÉÂ∑≤Âú®Áà∂ÂÖÉÁ¥†‰∏≠ÂÆö‰πâ */
            /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÊòæËëóÂ¢ûÂä†Âç°Áâá‰πãÈó¥ÁöÑÂûÇÁõ¥Èó¥Ë∑ùÔºåËß£ÂÜ≥‚ÄúÊå§‚ÄùÁöÑÈóÆÈ¢ò */
            gap: 20px; 
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. Â§¥ÈÉ®‰ø°ÊÅØÂå∫ */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„Äë‰∏∫Â§¥ÈÉ®‰∏ãÊñπÂ¢ûÂä†ÊòéÁ°ÆÁöÑËæπË∑ù */
            margin-bottom: 10px; 
        }
        #profile-avatar { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
        .profile-info { display: flex; flex-direction: column; }
        #profile-name { font-size: 20px; font-weight: 600; color: #1f1f1f; }
        #profile-id { font-size: 14px; color: #8a8a8a; }
        
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞V2Áâà„ÄëÂøÉÂ£∞‰∏éÊï£ËÆ∞Âç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */

/* 1. Âç°ÁâáÈÄöÁî®ÂÆπÂô®Ê†∑Âºè */
.profile-section {
    background-color: #ffffff; /* Âπ≤ÂáÄÁöÑÁôΩËâ≤ËÉåÊôØ */
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); /* ÊüîÂíåÁöÑÂç°ÁâáÈò¥ÂΩ± */
    display: flex;
    flex-direction: column;
    gap: 12px; /* Â§¥ÈÉ®ÂíåÂÜÖÂÆπÂå∫ÁöÑÈó¥Ë∑ù */
    flex-shrink: 0;
}

/* 2. Âç°ÁâáÂ§¥ÈÉ®ÂÆπÂô® */
.profile-section-header {
    display: flex;
    align-items: center;
    gap: 10px; /* ÂõæÊ†áÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0; /* ‰∏ÄÊù°Á≤æËá¥ÁöÑÂàÜÂâ≤Á∫ø */
}

/* 3. Âç°ÁâáÂ§¥ÈÉ®ÂõæÊ†áÊ†∑Âºè */
.profile-section-icon {
    font-size: 20px;
    opacity: 0.5;
}

/* 4. Âç°ÁâáÂ§¥ÈÉ®Ê†áÈ¢òÊñáÂ≠ó ("ÂøÉÂ£∞", "Êï£ËÆ∞") */
.profile-section label {
    font-size: 15px;
    font-weight: 600;
    color: #555; /* ÊØî‰πãÂâçÊõ¥Ê∑±ÁöÑÈ¢úËâ≤ÔºåÊõ¥ÊúâË¥®ÊÑü */
    margin: 0; /* ÁßªÈô§ÊóßÁöÑËæπË∑ù */
}

/* 5. Âç°ÁâáÂÜÖÂÆπÂå∫ÊñáÂ≠ó (‰øùÊåÅ‰∏çÂèò) */
.profile-section p {
    font-size: 15px;
    color: #333;
    line-height: 1.7;
    margin: 0;
    white-space: pre-wrap;
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /* 10. ÂéÜÂè≤ËÆ∞ÂΩïÈ°µÈù¢ÁâπÂÆöÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        #profile-thoughts-history-view { display: none; padding: 0 25px 25px 25px; }
        #profile-thoughts-history-view .profile-header { justify-content: space-between; padding-bottom: 15px; }
        #profile-thoughts-history-view .profile-header span { font-size: 18px; font-weight: 600; }
        #history-back-btn { width: 36px; height: 36px; background: none; border: none; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; padding: 0; }
        #history-back-btn:hover { background-color: rgba(0,0,0,0.05); }
        #history-back-btn svg { width: 22px; height: 22px; stroke: #a0a0a0; stroke-width: 2.5; }
        
        /* 11. ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°® (‰øùÊåÅ‰∏çÂèò) */
        #thoughts-history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-right: -10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .thought-card { background-color: #ffffff; border-radius: 16px; padding: 15px 20px; border: 1px solid #eee; }
        .thought-header { font-size: 12px; color: #b0b0b0; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .thought-content .label { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #a0a0a0; font-size: 13px; margin-bottom: 6px; }
        .thought-content .label svg { width: 16px; height: 16px; }
        .thought-content .text { font-size: 14px; color: #555; line-height: 1.7; white-space: pre-wrap; padding-left: 22px; }
        .thought-content .jottings { margin-top: 15px; }
        
        /* 12. ÈöêËóèÊªöÂä®Êù° (‰øùÊåÅ‰∏çÂèò) */
        #profile-main-content::-webkit-scrollbar,
        #thoughts-history-list::-webkit-scrollbar { display: none; }
        #profile-main-content, #thoughts-history-list { -ms-overflow-style: none; scrollbar-width: none; }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂØºÊºîÂâ™ËæëÂÆ§Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #ai-response-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-response-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        
        .ai-response-editor-block textarea {
            width: 100%;
            min-height: 80px; /* ÈªòËÆ§Áªô‰∏Ä‰∏™Êõ¥Â§ßÁöÑÈ´òÂ∫¶ */
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px; /* ‰ΩøÁî®Â∞è‰∏ÄÁÇπÁöÑÂ≠ó‰ΩìÔºåÊñπ‰æøÊü•ÁúãJSON */
            font-family: monospace; /* ‰ΩøÁî®Á≠âÂÆΩÂ≠ó‰ΩìÔºåËÆ©JSONÂØπÈΩêÊõ¥ÁæéËßÇ */
            box-sizing: border-box;
        }
        
        .ai-response-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; /* Ë¶ÜÁõñÈªòËÆ§ÁöÑ margin-bottom */
        }
        
        .ai-response-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        
        #phone-screen.dark-mode .ai-response-editor-block {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .ai-response-editor-block textarea {
            background-color: #1c1c1e;
            color: #f0f0f0;
            border-color: #4a4a4e;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫ø‰∏ãÊ®°ÂºèÊ∂àÊÅØÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .offline-dialogue {
            /* ÂØπËØùÈÉ®ÂàÜÂèØ‰ª•‰øùÊåÅÈªòËÆ§Ê†∑ÂºèÔºåÊàñËÄÖÁ®ç‰ΩúÂº∫Ë∞É */
            font-weight: 500;
        }
        .offline-description {
            display: block; /* Á°Æ‰øùÊèèÂÜôÂè¶Ëµ∑‰∏ÄË°åÊàñÂ§öË°å */
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 4px; /* ÂíåÂØπËØùÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
            white-space: pre-wrap; /* ÂÖÅËÆ∏ÊèèÂÜô‰∏≠ÁöÑÊç¢Ë°åÁ¨¶ÁîüÊïà */
            line-height: 1.6;
        }
        
        #phone-screen.dark-mode .offline-description {
            color: #a0a0a0; /* Â§úÈó¥Ê®°Âºè‰∏ã‰ΩøÁî®Êõ¥ÊüîÂíåÁöÑÁÅ∞Ëâ≤ */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂºïÁî®Ë∑≥ËΩ¨È´ò‰∫ÆÊïàÊûú ‚ñº‚ñº‚ñº */
        
        /* 1. ‰∏∫Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÂÜÖÂÆπÂå∫Ê∑ªÂä†‰∏Ä‰∏™Âπ≥ÊªëÁöÑËÉåÊôØËâ≤ËøáÊ∏°ÊïàÊûú */
        .message-bubble .content {
            transition: background-color 0.5s ease-out;
        }
        
        /* 2. ÂÆö‰πâÈ´ò‰∫ÆÊó∂ÁöÑËÉåÊôØËâ≤ */
        /*    Êàë‰ª¨‰ΩøÁî® !important Êù•Á°Æ‰øùÂÆÉËÉΩË¶ÜÁõñÊéâÊâÄÊúâ‰∏ªÈ¢òÁöÑÈªòËÆ§È¢úËâ≤ */
        .message-bubble.highlighted .content {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂ∏ÉÂ±ÄÁªàÊûÅ‰øÆÂ§ç„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑCSSÔºåÊõøÊç¢ÊéâÊÇ®ÊóßÁöÑÊâÄÊúâ‰∫îÂ≠êÊ£ãÁõ∏ÂÖ≥Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* ‚ñº‚ñº‚ñº „ÄêËæπÊ°ÜÁªàÊûÅ‰øÆÂ§çV2„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑCSSÔºåÊõøÊç¢ÊéâÊÇ®ÊóßÁöÑÊâÄÊúâ‰∫îÂ≠êÊ£ãÁõ∏ÂÖ≥Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 1. Ê£ãÁõòÁöÑÂ§ñÈÉ®ÂÆπÂô® (Ë¥üË¥£ÂÆö‰ΩçÂíåÂä®ÁîªÁ™óÂè£) */
        #gomoku-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 350px;
            z-index: 50;
            pointer-events: none; /* ËÆ©ÁÇπÂáªÂèØ‰ª•Á©øÈÄè */
            overflow: hidden;     /* „ÄêÊ†∏ÂøÉ„ÄëÈöêËóèÊéâÊªëÂá∫Â±èÂπïÂ§ñÁöÑÂÜÖÂÆπ */
            display: none;        /* ÈªòËÆ§‰∏çÊòæÁ§∫ÔºåÁî±JSÊéßÂà∂ */
        }
        
        /* ‚ñº‚ñº‚ñº „ÄêÈÅÆÁΩ©ÁªàÊûÅ‰øÆÂ§ç„ÄëËØ∑Áî®ËøôÊï¥ÂùóÂÖ®Êñ∞ÁöÑCSSÔºåÊõøÊç¢ÊéâÊÇ®ÊóßÁöÑ #gomoku-content-wrapper Ê†∑Âºè ‚ñº‚ñº‚ñº */
        
        /* 2. Ê£ãÁõòÁöÑÂÜÖÈÉ®ÂåÖË£ÖÂô® (Ë¥üË¥£Â§ñËßÇÂíåÂÜÖÂÆπÂ∏ÉÂ±Ä) */
        #gomoku-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* „ÄêÊ†∏ÂøÉ„ÄëÁßªÈô§ÊâÄÊúâËÉåÊôØÂíåÊïàÊûúÔºå‰ΩøÂÖ∂ÂÆåÂÖ®ÈÄèÊòé */
            background-color: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            /* --- ÂÖ∂‰ªñÂ∏ÉÂ±ÄÊ†∑Âºè‰øùÊåÅ‰∏çÂèò --- */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            transform: translateY(-100%);
            pointer-events: auto;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        #phone-screen.dark-mode #gomoku-content-wrapper {
            background-color: rgba(28, 28, 30, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* ÂΩìÊ£ãÁõòÂèØËßÅÊó∂ÔºåÂ∞ÜÂÜÖÈÉ®ÂåÖË£ÖÂô®ÊªëÂÖ•ËßÜÂõæ */
        #gomoku-overlay.visible #gomoku-content-wrapper {
            transform: translateY(0);
        }
        
        /* 3. ËÅäÂ§©Ê∂àÊÅØÂå∫ (‰øùÊåÅ‰∏çÂèò) */
        #chat-messages {
            transition: padding-top 0.3s ease-out;
        }
        
        /* 4. Ê£ãÁõòÁîªÂ∏ÉÂíåÊéßÂà∂ÊåâÈíÆ (‰øùÊåÅ‰∏çÂèò) */
        #gomoku-board {
            background-color: #e4b591;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        
        #gomoku-controls {
            width: 100%;
            text-align: center;
            flex-shrink: 0;
        }
        
        #close-gomoku-btn {
            padding: 6px 15px;
            border-radius: 15px;
            border: 1px solid var(--text-secondary);
            background-color: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
        }
        #phone-screen.dark-mode #close-gomoku-btn {
            background-color: rgba(0,0,0,0.2);
            border-color: var(--text-secondary);
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÊ£ãÁõò‰∫§‰∫íÁªàÊûÅ‰øÆÂ§ç„ÄëËØ∑Â∞ÜËøôÊï¥ÂùóCSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊúÄÊú´Â∞æ ‚ñº‚ñº‚ñº */
        
        /* 
          Á¨¨‰∏ÄÊ≠•Ôºö„ÄêÊ†∏ÂøÉ„ÄëËÆ©Ê£ãÁõòÁöÑÂ∑®Â§ßÈÄèÊòéÂÆπÂô®‚ÄúÁ©øÈÄè‚ÄùÊâÄÊúâÈº†Ê†á/Ëß¶Êë∏ÁÇπÂáª„ÄÇ
          ËøôÊ†∑ÊÇ®Â∞±ÂèØ‰ª•ÁÇπÂáªÂà∞ÂÆÉ‰∏ãÊñπÁöÑËÅäÂ§©Ê∂àÊÅØ‰∫Ü„ÄÇ
        */
        #gomoku-overlay {
            pointer-events: none;
        }
        
        /* 
          Á¨¨‰∫åÊ≠•ÔºöÁé∞Âú®ÔºåÊàë‰ª¨ÂøÖÈ°ª‚ÄúÊÅ¢Â§ç‚ÄùÊ£ãÁõòÂíåÊåâÈíÆÊú¨Ë∫´ÁöÑÂèØÁÇπÂáªÊÄß„ÄÇ
          Êàë‰ª¨Â∞ÜÂÆÉ‰ª¨ËÆæÁΩÆ‰∏∫ autoÔºåËøôÊ†∑ÂÆÉ‰ª¨Â∞±ÂèàËÉΩÂìçÂ∫îÊÇ®ÁöÑÊìç‰Ωú‰∫Ü„ÄÇ
        */
        #gomoku-board,
        #gomoku-controls {
            pointer-events: auto;
        }
        
        /* --- ËØ∑Áî®ËøôÊï¥Âùó„ÄêÊúÄÁªàÂ∏ÉÂ±Ä‰øÆÂ§çÁâà„Äë‰ª£Á†ÅÔºåÊõøÊç¢‰ªé #product-grid Âà∞ .product-footer ÁöÑÊâÄÊúâÁõ∏ÂÖ≥Ê†∑Âºè --- */
        
        #product-grid {
            flex-grow: 1; 
            overflow-y: auto; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            padding-bottom: 80px;
            /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„Äë: ÁßªÈô§ align-items: startÔºåÊÅ¢Â§çGridÈªòËÆ§ÁöÑÊãâ‰º∏ÂØπÈΩêÔºåÁ°Æ‰øùÂç°ÁâáÁ≠âÈ´ò */
        }
        
        .product-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            display: flex;         /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„Äë: ÂøÖÈ°ªÊòØFlexÂÆπÂô®ÔºåÊâçËÉΩÊéßÂà∂ÂÜÖÈÉ®ÂÖÉÁ¥† */
            flex-direction: column;
        
            cursor: pointer;
            position: relative;
        }
        
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }
        
        /* --- ËØ∑Áî®ËøôÊï¥Âùó„ÄêÊúÄÁªàÁ¥ßÂáëÂ∏ÉÂ±ÄÁâà„Äë‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ .product-info, .product-name, Âíå .product-footer Ê†∑Âºè --- */
        
        .product-info {
            padding: 12px 10px;
            flex-grow: 1;      /* ‰øùÊåÅÔºöËÆ©‰ø°ÊÅØÂå∫Â°´Êª°ÔºåÁ°Æ‰øùÊâÄÊúâÂç°ÁâáÁ≠âÈ´ò */
            display: flex;
            flex-direction: column;
        }
        
        .product-name {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
            min-height: 36px;
            /* ÁßªÈô§ÊâÄÊúâflex-growÂ±ûÊÄßÔºåËÆ©ÂÆÉÂè™Âç†ÊçÆËá™Â∑±ÈúÄË¶ÅÁöÑÈ´òÂ∫¶ */
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;      /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÔºö‰∏çÂÜç‰ΩøÁî® autoÔºåËÄåÊòØËÆæÁΩÆ‰∏Ä‰∏™Âõ∫ÂÆöÁöÑ„ÄÅËæÉÂ∞èÁöÑÈ°∂ÈÉ®Èó¥Ë∑ù */
        }
        
        /* --- ÊõøÊç¢ÁªìÊùü --- */
        
        
        
        
        
        /* --- ÊõøÊç¢ÁªìÊùü --- */
        
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #ff5722;
        }
        .product-price::before { content: '¬•'; font-size: 12px; }
        
        .add-to-cart-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* --- ÁÆ°ÁêÜÊ®°ÂºèÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) --- */
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }
        #shopping-screen.management-mode .product-management-overlay {
            display: flex;
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        #shopping-screen.management-mode .product-footer {
            display: none;
        }
        
        
        /* --- Ë¥≠Áâ©ËΩ¶È°µ (ÂæÆË∞É) --- */
        #cart-title {
            position: static;
            transform: none;
        }
        #cart-items-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .cart-item {
            display: flex; align-items: flex-start; gap: 12px; background-color: white;
            padding: 12px; border-radius: 12px;
        }
        .cart-item-checkbox { margin-top: 28px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .cart-item-info { flex-grow: 1; display: flex; flex-direction: column; }
        .cart-item-name { font-weight: 500; font-size: 14px; line-height: 1.4; }
        .cart-item-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px;}
        .cart-item-price { color: #ff5722; font-weight: bold; font-size: 16px; }
        .quantity-control { display: flex; align-items: center; gap: 4px; }
        .quantity-btn {
            width: 26px; height: 26px; border: none; background-color: #f7f8fa;
            border-radius: 4px; font-weight: 500; cursor: pointer; color: #666;
        }
        .quantity-display { font-weight: 500; min-width: 30px; text-align: center; }
        
        #cart-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; display: flex;
            justify-content: space-between; align-items: center; padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: white; border-top: 1px solid var(--border-color); box-sizing: border-box;
        }
        #cart-footer .select-all-label { display: flex; align-items: center; gap: 5px; }
        #cart-footer .cart-summary { text-align: right; }
        #cart-footer .cart-subtext { font-size: 11px; color: #999; }
        #checkout-btn {
            padding: 10px 25px; border: none; border-radius: 20px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white; font-size: 15px; font-weight: 500; cursor: pointer;
        }
        
        /* --- Á§ºÁâ©Âç°Áâá & Â∞èÁ•® (Ê†∑Âºè‰∏çÂèò) --- */
        .gift-card {
            width: 220px; /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞Ü max-width Êîπ‰∏∫Âõ∫ÂÆöÁöÑ width */
            box-sizing: border-box; 
            border-radius: 12px; 
            background-color: #fff; 
            border: 1px solid #eee; 
            padding: 12px;
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        .gift-header { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .gift-header-icon { width: 20px; height: 20px; color: #ff9800; }
        .gift-header-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .gift-items-preview { padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .gift-preview-item { display: flex; align-items: center; gap: 8px; }
        .gift-preview-img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .gift-preview-name { flex-grow: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gift-preview-quantity { font-size: 12px; color: var(--text-secondary); }
        .gift-footer { font-size: 12px; color: var(--text-secondary); text-align: right; }
        #gift-receipt-body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 15px; background-color: #f7f8fa; }
        .receipt-header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .receipt-header h3 { margin: 0 0 5px 0; font-size: 20px; }
        .receipt-header p { margin: 0; font-size: 12px; color: #888; }
        .receipt-items-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .receipt-items-table th, .receipt-items-table td { padding: 10px 5px; font-size: 13px; }
        .receipt-items-table thead th { border-bottom: 1px solid #333; text-align: left; }
        .receipt-items-table .item-name { width: 50%; }
        .receipt-items-table .item-qty { text-align: center; }
        .receipt-items-table .item-price, .receipt-items-table .item-subtotal { text-align: right; }
        .receipt-total { padding-top: 15px; border-top: 1px solid #333; text-align: right; font-size: 16px; font-weight: bold; }
        .receipt-footer { text-align: center; margin-top: 25px; font-size: 12px; color: #888; }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº (ÂèØÈÄâÔºå‰ΩÜÊé®Ëçê) ‰∏∫ÂïÜÂìÅÁÆ°ÁêÜÊ®°ÂºèÊ∑ªÂä†Êñ∞Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .product-item {
            position: relative; /* ‰∏∫‰∫ÜÂÆö‰ΩçÈÅÆÁΩ©Â±Ç */
        }
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; /* ÈªòËÆ§ÈöêËóè */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 5;
        }
        #shopping-screen.management-mode .product-management-overlay {
            display: flex; /* Âú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÊòæÁ§∫ */
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºåÈöêËóè‚ÄúÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶‚ÄùÊåâÈíÆ */
        #shopping-screen.management-mode .add-to-cart-btn {
            display: none;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÊ£ÄÊü•Âπ∂Ê∑ªÂä†„ÄëÂç°Áâá/ÁâπÊÆäÂÜÖÂÆπÊ∞îÊ≥°Â∏ÉÂ±ÄËßÑÂàô ‚ñº‚ñº‚ñº */
        .message-bubble.is-card-like {
            flex: initial; /* Ë¶ÜÁõñÈÄöÁî®ÁöÑ flex: 1ÔºåËÆ©Ê∞îÊ≥°Êú¨Ë∫´‰∏çÂÜçÊãâ‰º∏ */
            min-width: auto; /* ÂÖÅËÆ∏ÂÖ∂Ëá™Áî±Êî∂Áº© */
        }
        .message-bubble.is-card-like .content {
            flex: initial; 
            padding: 0;
            background: transparent;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰øÆÂ§çË¥≠Áâ©ËΩ¶ÂõæÊ†áÂØπÈΩêÈóÆÈ¢ò ‚ñº‚ñº‚ñº */
        #go-to-cart-btn {
            display: flex;
            align-items: center; /* Ê†∏ÂøÉÔºöÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê */
            gap: 4px; /* Âú®ÂõæÊ†áÂíåÊï∞Â≠ó‰πãÈó¥Â¢ûÂä†‰∏ÄÁÇπÈó¥Ë∑ù */
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Á§ºÁâ©Êé•Êî∂‰∫∫ÂàóË°®Ê∑ªÂä†Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #gift-recipient-list .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #gift-recipient-list .contact-picker-item:last-child {
            border-bottom: none;
        }
        #gift-recipient-list .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        #gift-recipient-list .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        #gift-recipient-list .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        #gift-recipient-list .contact-picker-item .name {
            font-weight: 500;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ≠åËØçÊ†èÊõøÊç¢ÂøÉÁéáÊòæÁ§∫Âô®Ê†∑Âºè (ÊúÄÁªàÁâà) ‚ñº‚ñº‚ñº */
        
        /* 1. ÂΩªÂ∫ïÈöêËóèÊóßÁöÑÂøÉÁéáÊòæÁ§∫Âô®Ôºå‰∏çÂÜçÈúÄË¶ÅÂÆÉ‰∫Ü */
        #ai-heart-rate-display {
            display: none !important;
        }
        
        /* 2. ‰∏∫Ê≠åËØçÊ†èÂ∫îÁî®Êñ∞ÁöÑÊ†∑ÂºèÔºå‰ΩøÂÖ∂Â§ñËßÇÂíåÂÆö‰Ωç‰∏éÂéüÂøÉÁéáÊòæÁ§∫Âô®ÂÆåÂÖ®‰∏ÄËá¥ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ≠åËØçÊ†è‰ΩçÁΩÆÊéßÂà∂Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #global-lyrics-bar {
            /* Ê†∏ÂøÉÂÆö‰ΩçÔºöÁªùÂØπÂÆö‰Ωç */
            position: absolute;
            z-index: 20;
        
            /* Â§ñËßÇÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 12px;
            
            /* Âä®ÁîªÊïàÊûú (‰øùÊåÅ‰∏çÂèò) */
            opacity: 0;
            visibility: hidden;
            /* „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰∏∫‰ΩçÁΩÆÂ±ûÊÄßÊ∑ªÂä†Âπ≥ÊªëËøáÊ∏° */
            transition: opacity 0.4s ease, visibility 0.4s ease, top 0.3s ease, bottom 0.3s ease, left 0.3s ease, right 0.3s ease, transform 0.3s ease;
        
            /* ÈôÑÂä†Ê†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 65%;
        }
        
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 3. ÂΩìJSÊ∑ªÂä†.visibleÁ±ªÊó∂ÔºåÊòæÁ§∫Ê≠åËØçÊ†è */
        #global-lyrics-bar.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* 4. ÈÄÇÈÖçÂ§úÈó¥Ê®°Âºè */
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏ñÁïå‰π¶È°µÈù¢ÁæéÂåñÊ†∑Âºè (V2 - È°µÁ≠æÂàáÊç¢Áâà) ‚ñº‚ñº‚ñº */
        
        /* 1. Á°Æ‰øù‰∏ñÁïå‰π¶È°µÈù¢ËÉåÊôØËâ≤Áªü‰∏Ä */
        #world-book-screen {
            background-color: #f0f2f5;
            display: flex; /* Êîπ‰∏∫flexÂ∏ÉÂ±ÄÔºåËÆ©Â§¥ÈÉ®„ÄÅÈ°µÁ≠æ„ÄÅÂÜÖÂÆπÂå∫ÂûÇÁõ¥ÊéíÂàó */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #world-book-screen {
            background-color: #000000;
        }
        
        /* 2. È°µÁ≠æÊ†èÊ†∑Âºè */
        #world-book-tabs {
            display: flex;
            overflow-x: auto; /* Â¶ÇÊûúÂàÜÁ±ªÂ§™Â§öÔºåÂèØ‰ª•Ê®™ÂêëÊªöÂä® */
            padding: 10px 15px 0 15px;
            flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        
            /* ÈöêËóèÊªöÂä®Êù° */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #world-book-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        
        
        /* 3. Âçï‰∏™È°µÁ≠æÊåâÈíÆÊ†∑Âºè */
        .world-book-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; /* ËÆ©Â∫ïËæπÊ°Ü‰∏éÂÆπÂô®ËæπÊ°ÜÈáçÂêà */
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* Èò≤Ê≠¢ÂàÜÁ±ªÂêçÊç¢Ë°å */
        }
        
        /* 4. ÊøÄÊ¥ªÁöÑÈ°µÁ≠æÊ†∑Âºè */
        .world-book-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .world-book-tab.active {
            color: #ffffff;
        }
        
        
        /* 5. ÂÜÖÂÆπÂå∫ÊÄªÂÆπÂô®ÔºåË¥üË¥£ÊªöÂä® */
        #world-book-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. Âçï‰∏™ÂàÜÁ±ªÁöÑÂÜÖÂÆπÈù¢ÊùøÔºå‰ΩøÁî®GridÂ∏ÉÂ±ÄÁæéÂåñ */
        .world-book-category-pane {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            grid-template-columns: repeat(2, 1fr); /* ÊØèË°åÊòæÁ§∫2Êú¨‰π¶ */
            gap: 15px;
            padding: 15px;
        }
        
        /* 7. ÊøÄÊ¥ªÁöÑÂÜÖÂÆπÈù¢Êùø */
        .world-book-category-pane.active {
            display: grid;
        }
        
/* 8. ÁæéÂåñÂêéÁöÑ‰∏ñÁïå‰π¶Âç°ÁâáÊ†∑Âºè */
.world-book-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px; /* Ê†áÈ¢òÂíåÂÜÖÂÆπÁöÑÈó¥Ë∑ù */
    word-break: break-all; /* <<< Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ∑ªÂä†Ëøô‰∏ÄË°å */
}
        
        .world-book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .world-book-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .world-book-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Èò≤Ê≠¢ÈïøÊ†áÈ¢òÊ∫¢Âá∫ */
        }
        
        .world-book-card .card-content-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            /* Â§öË°åÁúÅÁï•ÊïàÊûú */
            display: -webkit-box;
            -webkit-line-clamp: 3; /* ÊúÄÂ§öÊòæÁ§∫3Ë°å */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ∏≤ÊüìÂô®È°µÈù¢ÁæéÂåñÊ†∑Âºè (V2 - È°µÁ≠æÂàáÊç¢Áâà) ‚ñº‚ñº‚ñº */
        
        /* 1. Á°Æ‰øùÊ∏≤ÊüìÂô®È°µÈù¢ËÉåÊôØËâ≤Áªü‰∏Ä */
        #rendering-rules-screen {
            background-color: #f0f2f5;
            display: flex; /* Êîπ‰∏∫flexÂ∏ÉÂ±ÄÔºåËÆ©ÂÖÉÁ¥†ÂûÇÁõ¥ÊéíÂàó */
            flex-direction: column;
        }
        
        #phone-screen.dark-mode #rendering-rules-screen {
            background-color: #000000;
        }
        
        /* 2. È°µÁ≠æÊ†èÊ†∑Âºè (‰ªø‰∏ñÁïå‰π¶) */
        #rules-tabs {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #rules-tabs::-webkit-scrollbar {
            display: none;
        }
        
        /* 3. Âçï‰∏™È°µÁ≠æÊåâÈíÆÊ†∑Âºè */
        .rules-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        
        /* 4. ÊøÄÊ¥ªÁöÑÈ°µÁ≠æÊ†∑Âºè */
        .rules-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .rules-tab.active {
            color: #ffffff;
        }
        
        /* 5. ÂÜÖÂÆπÂå∫ÊÄªÂÆπÂô® */
        #rules-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* 6. Âçï‰∏™ÂàÜÁ±ªÁöÑÂÜÖÂÆπÈù¢Êùø (GridÂ∏ÉÂ±Ä) */
        .rules-category-pane {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            grid-template-columns: repeat(2, 1fr); /* ÊØèË°åÊòæÁ§∫2‰∏™ */
            gap: 15px;
            padding: 15px;
        }
        
        .rules-category-pane.active {
            display: grid;
        }
        
        /* 7. ÁæéÂåñÂêéÁöÑËßÑÂàôÂç°ÁâáÊ†∑Âºè */
        .rule-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Ê†áÈ¢òÂíåÂÜÖÂÆπÁöÑÈó¥Ë∑ù */
            border-left: 5px solid #6c757d; /* ÈªòËÆ§Áªô‰∏Ä‰∏™ÁÅ∞Ëâ≤ËæπÊ°Ü */
        }
        .rule-card.enabled {
            border-left-color: #28a745; /* ÂêØÁî®ÁöÑËßÑÂàôÁî®ÁªøËâ≤ËæπÊ°Ü */
        }
        
        .rule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .rule-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .rule-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rule-card .card-content-preview {
            font-size: 12px;
            font-family: monospace; /* ‰ΩøÁî®Á≠âÂÆΩÂ≠ó‰ΩìÔºåÊòæÁ§∫Ê≠£ÂàôÊõ¥Ê∏ÖÊô∞ */
            color: var(--text-secondary);
            background-color: #f0f2f5;
            padding: 5px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        #phone-screen.dark-mode .rule-card .card-content-preview {
            background-color: #2c2c2e;
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ÁæéÂåñÁâà„ÄëÈáçÊñ∞ÁîüÊàêÂõûÂ§çÊåâÈíÆÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .control-btn.regenerate-btn {
            /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞ÜËÉåÊôØËâ≤Êîπ‰∏∫‰∏éÂÖ∂‰ªñÂäüËÉΩÊåâÈíÆ‰∏ÄËá¥ÁöÑÂçäÈÄèÊòéÁÅ∞Ëâ≤ */
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%; /* ÂõæÊ†áÂ§ßÂ∞è‰øùÊåÅ‰∏çÂèò */
            /* SVGÂõæÊ†á‰øùÊåÅ‰∏çÂèòÔºå‰æùÁÑ∂ÊòØÊàë‰ª¨ÁöÑÂà∑Êñ∞ÂõæÊ†á */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>');
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊé®ËøõÂâßÊÉÖÊåâÈíÆÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .control-btn.propel-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>');
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØËß£ÂÜ≥HTML‰ª£Á†ÅË¢´Ê∞îÊ≥°Ê†∑Âºè‚ÄúÂéãÁº©‚ÄùÁöÑÊ†∏ÂøÉCSS ‚ñº‚ñº‚ñº */

/* ÂΩì‰∏Ä‰∏™Ê∂àÊÅØÊ∞îÊ≥°Ë¢´Ê†áËÆ∞‰∏∫ is-raw-html Êó∂ */
.message-bubble.is-raw-html .content {
    padding: 0 !important; /* Âº∫Âà∂ÁßªÈô§ÊâÄÊúâÂÜÖËæπË∑ù */
    background: transparent !important; /* Âº∫Âà∂ËÉåÊôØÈÄèÊòé */
    border: none !important; /* Âº∫Âà∂ÁßªÈô§ËæπÊ°Ü */
    box-shadow: none !important; /* Âº∫Âà∂ÁßªÈô§Èò¥ÂΩ± */
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈò≤Ê≠¢ÈïøÊåâÊó∂Ëß¶ÂèëËìùËâ≤ÊñáÊú¨ÈÄâ‰∏≠ ‚ñº‚ñº‚ñº */

#phone-screen {
    /* Ê†∏ÂøÉÂ±ûÊÄßÔºåÈÄÇÁî®‰∫éÂ§ßÂ§öÊï∞Áé∞‰ª£ÊµèËßàÂô® */
    user-select: none;

    /* ÂÖºÂÆπÊóßÁâà Safari, iOS Safari, Chrome */
    -webkit-user-select: none;

    /* ÂÖºÂÆπÊóßÁâà Firefox */
    -moz-user-select: none;

    /* ÂÖºÂÆπ Internet Explorer/Edge */
    -ms-user-select: none;

    /* Èò≤Ê≠¢Âú® iOS ‰∏äÈïøÊåâÈìæÊé•„ÄÅÂõæÁâáÊó∂ÂºπÂá∫ËèúÂçï */
    -webkit-touch-callout: none;
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº Ê≠•È™§ 2ÔºöÁî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÔºåÊõøÊç¢ÊéâÊâÄÊúâÊóßÁöÑ‰∏ªÂ±èÂπïÂíå‰∏™‰∫∫ËµÑÊñôÁõ∏ÂÖ≥CSS ‚ñº‚ñº‚ñº */

/* --- 1. ÈöêËóèÊâÄÊúâÊóßÁöÑ‰∏ªÂ±èÂπïÂÖÉÁ¥† --- */
#home-screen #clock-container,
#home-screen #app-grid,
#home-screen #home-widgets-container {
    display: none !important;
}

/* --- 2. „ÄêÊúÄÁªà‰øÆÂ§ç„ÄëÈáçÊñ∞ÂÆö‰πâ‰∏ªÂ±èÂπïÂ∏ÉÂ±Ä --- */

#home-screen {
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    /* ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ∑ªÂä†‰∏ãÈù¢Ëøô‰∏§Ë°å ‚ñº‚ñº‚ñº */
    background-size: cover;
    background-position: center;
    /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%;
}

/* --- ÊõøÊç¢Ëøô‰∏ÄÊï¥Âùó‰ª£Á†Å --- */
/* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ #main-content-area Ê†∑Âºè ‚ñº‚ñº‚ñº */

#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    /* Ê†∏ÂøÉ‰øÆÊîπ1ÔºöÂ∞ÜÂç°ÁâáÂíå‰∏ãÊñπÂõæÊ†áÁöÑÈó¥Ë∑ù‰ªé60pxÁº©Â∞èÂà∞30px */
    gap: 30px; 
    align-items: center;
    /* Ê†∏ÂøÉ‰øÆÊîπ2ÔºöÂ∞ÜÈ°∂ÈÉ®ÁöÑÂ§ñËæπË∑ù‰ªé40pxÁº©Â∞èÂà∞20pxÔºåÁªôÂ±èÂπïÈ°∂ÈÉ®ÁïôÂá∫‰∏ÄÁÇπÂëºÂê∏Á©∫Èó¥Âç≥ÂèØ */
    margin-top: 20px; 
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàËß£ÂÜ≥ÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊâÄÊúâÊóßÁöÑ‰∏™‰∫∫ËµÑÊñôÂç°ÁâáÁõ∏ÂÖ≥CSS ‚ñº‚ñº‚ñº */

/* 1. Âç°ÁâáÂ§ñÂ±ÇÂÆπÂô®ÔºöËøôÊòØÊâÄÊúâÂÜÖÈÉ®ÂÖÉÁ¥†ÂÆö‰ΩçÁöÑ‚ÄúÈîöÁÇπ‚Äù */
#profile-widget {
    position: relative; /* ÂÖ≥ÈîÆÔºöËÆ©ÂÜÖÈÉ®ÁöÑÂ§¥ÂÉèÂíå‰º™ÂÖÉÁ¥†ÂèØ‰ª•Áõ∏ÂØπ‰∫éÂÆÉËøõË°åÁªùÂØπÂÆö‰Ωç */
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}

/* 2. ËÉåÊôØÂ§¥ÂõæÔºöÂè™ÁªôÈ°∂ÈÉ®ËÆæÁΩÆÂúÜËßí */
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; /* Âè™ÁªôÈ°∂ÈÉ®ËÆæÁΩÆÂúÜËßí */
    position: relative;
    z-index: 1; /* ËÆ©Â§¥ÂõæÂú®‰∏ãÊñπ */
}

/* 3. Â§¥ÂÉèÂÆπÂô®ÔºöÁ≤æÁ°ÆÂÆö‰ΩçÔºå‰ΩøÂÖ∂‰∏≠ÂøÉÁ∫ø‰∏éÂ§¥ÂõæÂ∫ïÈÉ®ÂØπÈΩê */
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; 
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; 
    padding: 4px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; /* Â§¥ÂÉèÂ±ÇÁ∫ßÊúÄÈ´òÔºåÂéã‰Ωè‰∏ÄÂàá */
}

#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* 4. ÁôΩËâ≤‰ø°ÊÅØÂç°ÁâáÔºö‰ΩøÁî®Ë¥üÂ§ñËæπË∑ùÂÆûÁé∞Êó†ÁºùÊãºÊé• */
#profile-widget .profile-info {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* --- ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ --- */
    
    /* 1. ‰ΩøÁî®Ë¥üÂ§ñËæπË∑ùÔºåÂ∞ÜÂç°ÁâáÂêë‰∏äÁßªÂä®24pxÔºàÁ≠â‰∫éÂÖ∂ÂúÜËßíÂçäÂæÑÔºâ */
    margin-top: -24px; 
    
    /* 2. ‰∏∫Â§¥ÂÉèÁöÑ‰∏ãÂçäÈÉ®ÂàÜÂíå‰∏äÊñπÁöÑË¥üËæπË∑ùÔºåÂÖ±ÂêåÁïôÂá∫Á≤æÁ°ÆÁöÑÁ©∫Èó¥ */
    /* 40px (Â§¥ÂÉèÂçäÂæÑ) + 10px (È¢ùÂ§ñÈó¥Ë∑ù) + 24px (ÊäµÊ∂àË¥üËæπË∑ù) = 74px */
    padding-top: 44px; 
    
    /* --- ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÂ§çÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ --- */
    
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; /* ËÆ©‰ø°ÊÅØÂç°Âú®Â§¥Âõæ‰πã‰∏äÔºå‰ΩÜÂú®Â§¥ÂÉè‰πã‰∏ã */
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* 5. Âº∫Âà∂Á¶ÅÁî®‰ªª‰ΩïÂèØËÉΩÊÆãÁïôÁöÑÊóß‰º™ÂÖÉÁ¥†Ê†∑Âºè */
#profile-widget::before {
    display: none !important;
}

/* (Ëøô‰∏™ÊòØÂ§¥ÂÉèÂõæÁâáÊú¨Ë∫´ÁöÑÊ†∑ÂºèÔºå‰øùÊåÅ‰∏çÂèò) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* 5. Âº∫Âà∂Á¶ÅÁî®‰ªª‰ΩïÂèØËÉΩÊÆãÁïôÁöÑÊóß‰º™ÂÖÉÁ¥†Ê†∑Âºè */
#profile-widget::before {
    display: none !important;
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* (Ëøô‰∏™ÊòØÂ§¥ÂÉèÂõæÁâáÊú¨Ë∫´ÁöÑÊ†∑ÂºèÔºå‰øùÊåÅ‰∏çÂèò) */
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */



/* (‰ª•‰∏ã‰∏∫‰∏™‰∫∫ËµÑÊñôÂÜÖÈÉ®ÊñáÂ≠óÊ†∑ÂºèÔºå‰øùÊåÅ‰∏çÂèò) */
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}

/* --- (‰ªéËøôÈáåÂºÄÂßãÔºåÂêéÈù¢ÁöÑÊâÄÊúâÊ†∑ÂºèÈÉΩ‰øùÊåÅ‰∏çÂèòÂç≥ÂèØ) --- */
#desktop-layout {
    display: grid;
    grid-template-columns: 1fr 1.1fr;
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.widget-header {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 5px 5px;
}
.desktop-widget {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 18px;
    padding: 12px 15px;
    /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞ÜÈ¢úËâ≤‰ªé white Êîπ‰∏∫Êé•ËøëÈªëËâ≤ÁöÑÊ∑±ÁÅ∞Ëâ≤ */
    color: #1f1f1f; 
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
}
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÁßªÈô§Á¨¨‰∏Ä‰∏™Â∞èÁªÑ‰ª∂ËÉåÊôØÊ°ÜÁöÑÊ†∑Âºè ‚ñº‚ñº‚ñº */

.desktop-widget.text-only {
    background-color: transparent; /* Â∞ÜËÉåÊôØËâ≤ËÆæ‰∏∫ÈÄèÊòé */
    border: none;                  /* ÁßªÈô§ËæπÊ°Ü */
    padding: 0;                    /* ÁßªÈô§ÂÜÖËæπË∑ùÔºåÈÅøÂÖçÂ§ö‰ΩôÁöÑÁ©∫ÁôΩ */
    box-shadow: none;              /* Á°Æ‰øùÊ≤°ÊúâÈò¥ÂΩ± */
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
.desktop-widget.icon-left { justify-content: flex-start; gap: 10px; }
/* This is the NEW code */
.desktop-widget.icon-right {
    justify-content: flex-end; /* Pushes both items to the right */
    gap: 10px;                 /* Adds a nice space between the text and the avatar */
}
.desktop-widget img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.desktop-widget p, .desktop-widget span { margin: 0; }
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    align-content: start;
}
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content;
    flex-shrink: 0;
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 0;
}
.desktop-app-icon .label {
    color: #333; font-size: 13px; font-weight: 500;
}
.desktop-app-icon:active .icon-bg-desktop {
    transform: scale(0.9);
}
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0.9;
}
/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØ‰∏∫Â∞èÁªÑ‰ª∂ÁºñËæëÂäüËÉΩÊ∑ªÂä†ÁöÑÊ†∑Âºè ‚ñº‚ñº‚ñº */

/* ‰∏∫ÂèØÁºñËæëÁöÑÂÖÉÁ¥†Ê∑ªÂä†ÂèØÁÇπÂáªÁöÑÂÖâÊ†áÂíåËøáÊ∏°ÊïàÊûú */
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

/* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÔºåÊòæÁ§∫‰∏Ä‰∏™ÂçäÈÄèÊòéÁöÑËôöÁ∫øÂ§ñÊ°ÜÔºåÂπ∂ËΩªÂæÆÂèòÊöóÔºåÊèê‰æõËßÜËßâÂèçÈ¶à */
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    opacity: 0.9;
    border-radius: 4px; /* ËÆ©Â§ñÊ°Ü‰πüÊúâ‰∏ÄÁÇπÂúÜËßí */
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñº‚ñº‚ñº „ÄêÊñπÊ°àAÔºö‰ªÖËÉåÊôØÊ∏êÂèòÔºåÊñáÂ≠ó‰øùÊåÅÂÆû‰Ωì„Äë(ÂèØËÉΩÂØºËá¥Â∫ïÈÉ®ÊñáÂ≠óÂèØËØªÊÄß‰∏ãÈôç) ‚ñº‚ñº‚ñº */

#profile-widget .profile-info {
    /* 1. Â∞ÜÂç°ÁâáÊú¨Ë∫´ÁöÑËÉåÊôØËÆæ‰∏∫ÈÄèÊòé */
    background: transparent !important;
    /* 2. Âª∫Á´ãÂÆö‰Ωç‰∏ä‰∏ãÊñáÔºåËÆ©‰º™ÂÖÉÁ¥†ÂèØ‰ª•Áõ∏ÂØπ‰∫éÂÆÉÂÆö‰Ωç */
    position: relative;
    z-index: 1; /* Á°Æ‰øùÊñáÂ≠óÂÜÖÂÆπÂú®ËÉåÊôØ‰πã‰∏ä */
}

#profile-widget .profile-info::before {
    /* 3. ÂàõÂª∫‰∏Ä‰∏™‰º™ÂÖÉÁ¥†‰Ωú‰∏∫Êñ∞ÁöÑËÉåÊôØÂ±Ç */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* 4. Â∞ÜÂéüÊú¨ÁöÑÁôΩËâ≤ËÉåÊôØÂíåÂúÜËßíÂ∫îÁî®Âà∞Ëøô‰∏™ËÉåÊôØÂ±Ç‰∏ä */
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    
    /* 5. „ÄêÊ†∏ÂøÉ„ÄëÂè™ÂØπËøô‰∏™ËÉåÊôØÂ±ÇÂ∫îÁî®Ê∏êÂèòÊ∂àÂ§±ÊïàÊûú */
    mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    
    /* 6. Â∞ÜËÉåÊôØÂ±ÇÊîæÂà∞ÊñáÂ≠óÂÜÖÂÆπÁöÑÂêéÈù¢ */
    z-index: -1;
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ËÆæÁΩÆÈ°µÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
#chat-settings-screen {
    /* Á°Æ‰øùÈ°µÈù¢ÊòØ Flex ÂÆπÂô®ÔºåËÆ©ÂÜÖÂÆπÂå∫ÂèØ‰ª•Ê≠£Á°ÆÂú∞Êãâ‰º∏ */
    display: flex;
    flex-direction: column;
    background-color: #f0f2f5; /* ‰∏éÂÖ∂‰ªñËÆæÁΩÆÈ°µ‰øùÊåÅ‰∏ÄËá¥ÁöÑËÉåÊôØËâ≤ */
}

#phone-screen.dark-mode #chat-settings-screen {
     background-color: #000000; /* Â§úÈó¥Ê®°ÂºèËÉåÊôØ */
}

#chat-settings-screen .form-container {
    flex-grow: 1;      /* Ê†∏ÂøÉÔºöËÆ©ÂÜÖÂÆπÂå∫Âç†ÊçÆÊâÄÊúâÂâ©‰ΩôÁ©∫Èó¥ */
    overflow-y: auto;  /* Ê†∏ÂøÉÔºöÁ°Æ‰øùÂÜÖÂÆπËøáÈïøÊó∂ÂèØ‰ª•ÊªöÂä® */
    padding-top: 100px;  /* ‰∏∫ÊµÆÂä®ÁöÑ Header ÁïôÂá∫Ë∂≥Â§üÁöÑÈ°∂ÈÉ®Á©∫Èó¥ */
    margin-top: -80px;   /* Â∞ÜÂÜÖÂÆπÂå∫Âêë‰∏äÊãâÔºå‰ΩøÂÖ∂ÂèØ‰ª•ÊªöÂä®Âà∞ Header ‰∏ãÊñπ */
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëBGMÊêúÁ¥¢ÁªìÊûúÂºπÁ™óÊ†∑Âºè ‚ñº‚ñº‚ñº */

.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}

.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈü≥‰πêÊí≠ÊîæÂô®‰∏ìËæëÂ∞ÅÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
#music-player-cover {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: cover;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    margin-bottom: 25px; /* Âú®Â∞ÅÈù¢ÂíåÊ†áÈ¢ò‰πãÈó¥Â¢ûÂä†Èó¥Ë∑ù */
    transition: opacity 0.5s ease-in-out; /* ËÆ©ÂõæÁâáÂàáÊç¢Êó∂ÊúâÊ∑°ÂÖ•Ê∑°Âá∫ÊïàÊûú */
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰ªøÁΩëÊòì‰∫ëÂî±Áâá/Ê≠åËØçÂàáÊç¢Ê†∑Âºè ‚ñº‚ñº‚ñº */

/* 1. ÂàáÊç¢ÁöÑÊÄªÂÆπÂô®ÔºåË¥üË¥£ÂÆö‰ΩçÂíåÂ§ßÂ∞è */
#music-visual-container {
    position: relative;
    width: 220px;
    height: 220px;
    margin-bottom: 25px;
    cursor: pointer;
}

/* 2. Âî±ÁâáÂíåÊ≠åËØçËßÜÂõæÁöÑÈÄöÁî®Ê†∑ÂºèÔºåËÆ©ÂÆÉ‰ª¨ÈáçÂè†Âú®‰∏ÄËµ∑ */
#vinyl-view, #inline-lyrics-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    /* Ê†∏ÂøÉÔºö‰∏∫ÂàáÊç¢ÊïàÊûúÊ∑ªÂä†Âπ≥ÊªëÁöÑËøáÊ∏°Âä®Áîª */
    transition: opacity 0.5s ease, transform 0.5s ease;
}

/* 3. ÈªëËÉ∂Âî±ÁâáËßÜÂõæÁöÑ‰∏ìÂ±ûÊ†∑Âºè */
#vinyl-view {
    background-color: #222;
    border-radius: 50%;
    padding: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
}
#vinyl-view #music-player-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    margin: 0; /* ÁßªÈô§ÊóßÁöÑÂ§ñËæπË∑ù */
}

/* 4. ÂÜÖËÅîÊ≠åËØçËßÜÂõæÁöÑ‰∏ìÂ±ûÊ†∑Âºè */
#inline-lyrics-view {
    /* ÈªòËÆ§Áä∂ÊÄÅÔºöÂÆåÂÖ®ÈÄèÊòéÔºåËΩªÂæÆÊîæÂ§ßÔºå‰∏î‰∏çÂèØÁÇπÂáª */
    opacity: 0;
    transform: scale(1.1);
    pointer-events: none;
    padding: 10px;
    box-sizing: border-box;
}

/* 5. „ÄêÊ†∏ÂøÉ„ÄëÂàáÊç¢ÈÄªËæë */
/* ÂΩìÂÆπÂô®Êã•Êúâ .lyrics-active Á±ªÊó∂... */
#music-visual-container.lyrics-active #vinyl-view {
    /* ...Âî±ÁâáËßÜÂõæÊ∂àÂ§± */
    opacity: 0;
    transform: scale(0.9);
}
#music-visual-container.lyrics-active #inline-lyrics-view {
    /* ...Ê≠åËØçËßÜÂõæÂá∫Áé∞ */
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}

/* 6. Ê≠åËØçÂÆπÂô®ÁöÑÊ†∑Âºè (‰∏é‰πãÂâçÁ±ª‰ººÔºå‰ΩÜÊúâÂæÆË∞É) */
#inline-lyrics-view #music-lyrics-container {
    width: 100%;
    height: 100%;
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈ°∂ÈÉ®Ê≠åÊõ≤‰ø°ÊÅØÂå∫ÂüüÊ†∑Âºè ‚ñº‚ñº‚ñº */

/* 1. Êñ∞ÁöÑÈ°∂ÈÉ®‰ø°ÊÅØÂÆπÂô® */
#music-info-top {
    text-align: center; /* ËÆ©ÊâÄÊúâÊñáÂ≠óÂ±Ö‰∏≠ */
    flex-shrink: 0;
    margin-bottom: 20px; /* Âú®‰ø°ÊÅØÂíåÂî±Áâá‰πãÈó¥Â¢ûÂä†‰∏Ä‰∫õÈó¥Ë∑ù */
}

/* 2. ÁßªÈô§ÊóßÁöÑ„ÄÅÂ§ö‰ΩôÁöÑËæπË∑ùÔºåÈÅøÂÖçÂèåÈáçÈó¥Ë∑ù */
#music-player-song-title,
#music-player-artist,
#music-time-counter {
    margin-bottom: 5px; /* Áªü‰∏ÄËÆæÁΩÆ‰∏Ä‰∏™ËæÉÂ∞èÁöÑË°åÈó¥Ë∑ù */
}

/* 3. Ë∞ÉÊï¥Âî±ÁâáÂÆπÂô®ÁöÑÂ§ñËæπË∑ù */
#music-visual-container {
    margin-bottom: 15px; /* ÈÄÇÂΩìÂáèÂ∞èÂî±ÁâáÂíåËøõÂ∫¶Êù°ÁöÑË∑ùÁ¶ª */
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈªëËÉ∂Âî±ÁâáÊóãËΩ¨Âä®Áîª ‚ñº‚ñº‚ñº */

/* 1. ÂÆö‰πâ‰∏Ä‰∏™Âêç‰∏∫ "spin-vinyl" ÁöÑÊóãËΩ¨Âä®Áîª */
@keyframes spin-vinyl {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* 2. ÂàõÂª∫‰∏Ä‰∏™ .spinning Á±ªÔºåÂ∫îÁî®Ëøô‰∏™Âä®Áîª */
/*    Êàë‰ª¨Â∏åÊúõÂÆÉÊó†Èôê„ÄÅÂåÄÈÄüÂú∞ÊóãËΩ¨ */
#vinyl-view.spinning {
  animation: spin-vinyl 12s linear infinite;
}
/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂçïË°åÊ≠åËØçÊòæÁ§∫Ê†∑Âºè ‚ñº‚ñº‚ñº */

#single-lyric-display {
    /* 1. Â∞∫ÂØ∏‰∏éÂÆö‰Ωç */
    height: 40px;          /* Áªô‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÈ´òÂ∫¶ÔºåÈò≤Ê≠¢ÊñáÂ≠óÊç¢Ë°åÊó∂Â∏ÉÂ±ÄË∑≥Âä® */
    line-height: 40px;     /* ÂûÇÁõ¥Â±Ö‰∏≠ */
    width: 100%;           /* ÂÆΩÂ∫¶ÊíëÊª° */
    margin-top: 15px;      /* Âíå‰∏äÊñπÁöÑÂî±ÁâáÊãâÂºÄ‰∏Ä‰∫õË∑ùÁ¶ª */
    
    /* 2. ÊñáÂ≠óÂ§ñËßÇ */
    text-align: center;    /* ÊñáÂ≠óÂ±Ö‰∏≠ */
    font-size: 14px;       /* Â≠ó‰ΩìÂ§ßÂ∞è */
    color: #333;           /* Â≠ó‰ΩìÈ¢úËâ≤ */
    font-weight: 500;      /* Â≠ó‰ΩìÁ®çÂæÆÂä†Á≤ó‰∏ÄÁÇπ */

    /* 3. ÊïàÊûú‰∏éÂä®Áîª */
    transition: opacity 0.3s ease; /* ËÆ©ÊñáÂ≠óÂàáÊç¢Êó∂ÊúâÊ∑°ÂÖ•Ê∑°Âá∫ÊïàÊûú */
    white-space: nowrap;           /* Âº∫Âà∂‰∏çÊç¢Ë°å */
    overflow: hidden;              /* Ë∂ÖÂá∫ÈÉ®ÂàÜÈöêËóè */
    text-overflow: ellipsis;       /* Ë∂ÖÂá∫ÈÉ®ÂàÜÊòæÁ§∫ÁúÅÁï•Âè∑ */
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàáÊç¢Âà∞ÂÖ®Â±èÊ≠åËØçÊó∂ÔºåÈöêËóèÂçïË°åÊ≠åËØçÈ¢ÑËßà ‚ñº‚ñº‚ñº */

#music-visual-container.lyrics-active + #single-lyric-display {
    /* Ê†∏ÂøÉÔºö‰ΩøÁî® display: none; Â∞ÜÂÖ∂ÂΩªÂ∫ïÈöêËóèÔºå‰∏çÂç†Á©∫Èó¥ */
    display: none;
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂä®ÊÄÅËØÑËÆ∫Âå∫NPCÊâãÂä®Ëß¶ÂèëÊåâÈíÆÊ†∑Âºè ‚ñº‚ñº‚ñº */

.npc-comment-trigger-btn {
    /* 1. Âü∫Á°ÄÊ†∑ÂºèÈáçÁΩÆ */
    background: none;
    border: none;
    padding: 0;
    margin: 0 8px; /* ÂíåÂèëÈÄÅÊåâÈíÆÊãâÂºÄË∑ùÁ¶ª */
    cursor: pointer;
    
    /* 2. Â§ñËßÇÂíåÂ∞∫ÂØ∏ (‰ªøÁÖßÂÖ∂‰ªñÂõæÊ†áÊåâÈíÆ) */
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.04);
    
    /* 3. FlexÂ∏ÉÂ±ÄËÆ©ÂõæÊ†áÂÆåÁæéÂ±Ö‰∏≠ */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* 4. ËøáÊ∏°ÊïàÊûú */
    transition: background-color 0.2s;
    flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
}

/* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÁöÑÊïàÊûú */
.npc-comment-trigger-btn:hover {
    background-color: rgba(0, 0, 0, 0.08);
}

/* ÊåâÈíÆÂÜÖÈÉ®SVGÂõæÊ†áÁöÑÊ†∑Âºè */
.npc-comment-trigger-btn svg {
    width: 22px;
    height: 22px;
    stroke: var(--text-secondary); /* ‰ΩøÁî®Ê¨°Ë¶ÅÊñáÂ≠óÈ¢úËâ≤ */
}
/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÂèØËßÜÂåñÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */

/* 1. ÂèØËßÜÂåñÁïåÈù¢ÁöÑÊÄªÂÆπÂô®ÔºåÁ°Æ‰øùÂÆÉËÉΩË¶ÜÁõñÊï¥‰∏™Â±èÂπï */
#visual-call-interface {
    width: 100%;
    height: 100%;
    position: relative; /* ËÆ©ÂÜÖÈÉ®ÂÖÉÁ¥†ÂèØ‰ª•Áõ∏ÂØπ‰∫éÂÆÉÂÆö‰Ωç */
    overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
    background-color: #1c1c1e; /* Ê∑±Ëâ≤ËÉåÊôØ */
    display: flex; /* ‰ΩøÁî®flexÂ∏ÉÂ±ÄÔºåÊñπ‰æøÂÜÖÂÆπÊéíÂàó */
    flex-direction: column;
}

/* 2. ËßÜÈ¢ëËÉåÊôØÂ±ÇÔºåÁî®‰∫éÊîæÁΩÆÂ§ßÂ∞èÂõæ */
.video-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Á°Æ‰øùÂÆÉÂú®ÊúÄÂ∫ïÂ±Ç */
}

/* 3. Â§ßÂ∞èÂõæÁöÑÈÄöÁî®ÂÆπÂô®Ê†∑Âºè */
.video-container {
    position: absolute;
    background-color: #000;
    overflow: hidden;
    transition: all 0.3s ease-in-out; /* ‰∏∫ÂàáÊç¢ÈïúÂ§¥Ê∑ªÂä†Âä®Áîª */
}
.video-container img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ‰øùËØÅÂõæÁâáÂ°´Êª°ÂÆπÂô®‰∏î‰∏çÂèòÂΩ¢ */
}

/* 4. Â§ßÂõæÊ†∑Âºè (ÈªòËÆ§Âç†Êª°ÂÖ®Â±è) */
#video-main-view {
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

/* 5. Â∞èÂõæÊ†∑Âºè (Áîª‰∏≠Áîª) */
#video-pip-view {
    top: 60px; /* Ë∑ùÁ¶ªÈ°∂ÈÉ®‰∏ÄÊÆµË∑ùÁ¶ª */
    right: 15px;
    width: 100px; /* Â∞èÁ™óÂÆΩÂ∫¶ */
    height: 178px; /* Â∞èÁ™óÈ´òÂ∫¶ (‰øùÊåÅÁ´ñÂ±èÊØî‰æã) */
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer; /* ÊèêÁ§∫Áî®Êà∑ÂèØ‰ª•ÁÇπÂáª */
}

/* 6. ËÅäÂ§©Ê∞îÊ≥°Âå∫Âüü (Ë¶ÜÁõñÂú®ËßÜÈ¢ë‰πã‰∏ä) */
#video-call-messages-visual {
    position: relative;
    z-index: 5; /* Â±ÇÁ∫ßÊØîËßÜÈ¢ëÈ´ò */
    flex-grow: 1; /* Âç†ÊçÆÈô§‰∫ÜÈ°∂ÈÉ®ÂíåÂ∫ïÈÉ®Ê†è‰πãÂ§ñÁöÑÊâÄÊúâÁ©∫Èó¥ */
    padding: 15px;
    overflow-y: auto; /* ÂÜÖÂÆπÂ§ö‰∫ÜÂèØ‰ª•ÊªöÂä® */
    display: flex;
    flex-direction: column;
    gap: 15px;
    /* ÂÖ≥ÈîÆÔºö‰∏∫‰∫Ü‰∏çËÆ©ÊªöÂä®Êù°ÂΩ±ÂìçÁæéËßÇÔºåÊääÂÆÉÈöêËóèÊéâ */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE 10+ */
}
#video-call-messages-visual::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera*/
}

/* ‚ñº‚ñº‚ñº Áî®Ëøô„Äê‰∏ÄÂ∞èÂùó„Äë‰ª£Á†ÅÔºåÊõøÊç¢ÊéâÊóßÁöÑÊ∞îÊ≥°Ê†∑ÂºèÔºåÂÆûÁé∞„ÄêÊó†Ê®°Á≥ä„ÄëÊïàÊûú ‚ñº‚ñº‚ñº */

/* 7. „ÄêÊó†Ê®°Á≥ä„ÄëÈ´òÊ∏ÖÈÄèÊòéËÅäÂ§©Ê∞îÊ≥° */
.visual-call-bubble {
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    line-height: 1.5;
    word-break: break-word;
    color: white;

    /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÂΩªÂ∫ïÁßªÈô§ backdrop-filter (Ê®°Á≥ä) ÊïàÊûú */

    /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÊèê‰æõ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂçäÈÄèÊòéÈªëËâ≤ËÉåÊôØÔºå‰ª•Ë°¨ÊâòÊñáÂ≠ó */
    background-color: rgba(0, 0, 0, 0.3); /* ËøôÊòØ‰∏Ä‰∏™ÂÖ≥ÈîÆÂÄºÔºåÂèØ‰ª•Âú® 0.2 (Êõ¥ÈÄè) Âà∞ 0.4 (Êõ¥Ê∑±) ‰πãÈó¥ÂæÆË∞É */

    /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî®Êõ¥Ê∏ÖÊô∞ÁöÑËæπÊ°ÜÊù•ÂÆö‰πâÊ∞îÊ≥°ËΩÆÂªì */
    border: 1px solid rgba(255, 255, 255, 0.25);

    /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÂº∫ÂåñÊñáÂ≠óÈò¥ÂΩ±ÔºåÁ°Æ‰øùÂú®‰ªª‰ΩïÊ∏ÖÊô∞ËÉåÊôØ‰∏ãÈÉΩÁªùÂØπÂèØËØª */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
}

.visual-call-bubble.user {
    align-self: flex-end;
    /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÁî®Êà∑Ê∞îÊ≥°‰πü‰ΩøÁî®Êó†Ê®°Á≥äÁöÑÂçäÈÄèÊòéËÉåÊôØ */
    background-color: rgba(40, 160, 70, 0.3); /* ‰ΩøÁî®‰∏Ä‰∏™Êõ¥Ê∑±ÁöÑÁªøËâ≤Êù•‰øùËØÅÂØπÊØîÂ∫¶ */
    border-color: rgba(255, 255, 255, 0.3);
}

/* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

.visual-call-bubble.ai {
    align-self: flex-start; /* AIÁöÑÂèëË®ÄÈù†Â∑¶ */
}

/* 8. È°∂ÈÉ®ÂíåÂ∫ïÈÉ®Ê†èÁöÑÂ±ÇÁ∫ßË¶ÅÊúÄÈ´ò */
#visual-call-interface .video-call-top-bar,
#visual-call-interface .video-call-controls {
    z-index: 10;
}

/* 9. Êñ∞Â¢ûÁöÑÊéßÂà∂ÊåâÈíÆÂõæÊ†á (‰ΩøÁî®SVG) */
.control-btn.reroll-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>');
    background-size: 50%;
}
.control-btn.switch-camera-btn {
    background-color: rgba(255,255,255,0.2);
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>');
    background-size: 50%;
}

/* 10. ÊåÇÊñ≠ÊåâÈíÆÈúÄË¶Å‰∏Ä‰∏™Êñ∞IDÊù•Âå∫ÂàÜ */
#hang-up-btn-visual {
    /* Ê†∑ÂºèÁªßÊâøËá™ .hangup-btnÔºåÊó†ÈúÄÈ¢ùÂ§ñÊ∑ªÂä† */
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
    </style>
</head>
<body>
    <div id="phone-screen">
        <div id="status-bar">
            <span id="status-bar-time">12:00</span>
            <div id="status-bar-battery" class="battery-container">
                <span class="battery-text">--%</span>
                <div class="battery-icon">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>
        <div id="notification-bar"><img id="notification-avatar" src="">
            <div id="notification-content">
                <div class="name"></div>
                <div class="message"></div>
            </div>
        </div>
<!-- ‚ñº‚ñº‚ñº Ê≠•È™§ 1ÔºöÁî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊÇ®Áé∞ÊúâÁöÑ <div id="home-screen" ...> ... </div> ‚ñº‚ñº‚ñº -->

<div id="home-screen" class="screen active">
    <!-- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞Ü‰∏™‰∫∫ËµÑÊñôÂíå‰∏≠Èó¥Â∏ÉÂ±ÄÂåÖË£πÂú®‰∏Ä‰∏™ÂÆπÂô®‰∏≠ -->
    <div id="main-content-area">
        <!-- ‰∏™‰∫∫ËµÑÊñôÁªÑ‰ª∂ -->
        <div id="profile-widget">
            <!-- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç1„ÄëÊõ¥Êç¢‰∏∫‰∏ÄÂº†ÂèØ‰ª•Ê≠£Â∏∏ÊòæÁ§∫ÁöÑËÉåÊôØÂõæ -->
            <img id="profile-banner-img" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
            <div class="profile-avatar-container">
                <!-- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„ÄëÊõ¥Êç¢‰∏∫‰∏ÄÂº†ÂèØ‰ª•Ê≠£Â∏∏ÊòæÁ§∫ÁöÑÂ§¥ÂÉè -->
                <img id="profile-avatar-img" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image">
            </div>
            <div class="profile-info">
                <p id="profile-username" class="editable-text">@ insonneve ü™¶</p>
                <p id="profile-sub-username" class="editable-text">@ insonneve</p>
                <p id="profile-bio" class="editable-text">‰Ω†Â•ΩÂÉèËøáÂæóÂæàÂ•Ω Ëø´‰∏çÂèäÂæÖÁöÑÊäπÂéªÊàëÂ≠òÂú®ÁöÑÁóïËøπ</p>
                <p id="profile-location" class="editable-text">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></svg>
                    <span>ÂåóÊµ∑ÈÅì</span>
                </p>
            </div>
        </div>

        <!-- ‰∏≠Èó¥Â∏ÉÂ±ÄÁΩëÊ†º -->
        <div id="desktop-layout">
            <!-- Â∑¶‰æßÂ∞èÁªÑ‰ª∂Âàó -->
            <div id="desktop-widget-column">
                <div class="desktop-widget text-only">
                    <p id="widget-text-1" class="editable-text">Be fearless in pursuit of happiness</p>
                </div>
                <div class="desktop-widget icon-left">
                    <img id="widget-avatar-1" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                    <span id="widget-text-2" class="editable-text">Dare to be different</span>
                </div>
                <div class="desktop-widget icon-right">
                    <span id="widget-text-3" class="editable-text">* Keep your spirit free</span>
                    <img id="widget-avatar-2" src="https://i.imgur.com/5A0tE9a.jpeg" class="editable-image">
                </div>
                
            </div>
            <!-- Âè≥‰æßAppÂõæÊ†áÂÆπÂô® -->
            <div id="desktop-app-container">
                <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div>
                    <span class="label">QQ</span>
                </div>
                <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="‰∏ñÁïå‰π¶"></div>
                    <span class="label">‰∏ñÁïå‰π¶</span>
                </div>
                <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="Â§ñËßÇËÆæÁΩÆ"></div>
                    <span class="label">Â§ñËßÇËÆæÁΩÆ</span>
                </div>
                <div class="desktop-app-icon" onclick="openRenderingRulesScreen()">
                    <div class="icon-bg-desktop"><img id="icon-img-renderer" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="Ê∏≤ÊüìÂô®"></div>
                    <span class="label">Ê∏≤ÊüìÂô®</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Â∫ïÈÉ® Dock Â∫îÁî® -->
    <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIËÆæÁΩÆ"></div>
            <span class="label">APIËÆæÁΩÆ</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Â≠ó‰Ωì"></div>
            <span class="label">Â≠ó‰Ωì</span>
        </div>

    
    </div>
</div>

<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ world-book-screen ‚ñº‚ñº‚ñº -->
        <div id="world-book-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span>‰∏ñÁïå‰π¶</span>
                <div class="header-actions">
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂ∞ÜÊñáÂ≠óÊåâÈíÆÊõøÊç¢‰∏∫SVGÂõæÊ†á -->
                    <span class="action-btn" id="manage-world-book-categories-btn" title="ÁÆ°ÁêÜÂàÜÁ±ª">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </span>
                    <span class="action-btn" id="add-world-book-btn">+</span>
                </div>
            </div>
            <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂÖ®Êñ∞ÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÂå∫ÁªìÊûÑ -->
            <div id="world-book-tabs"></div>
            <div id="world-book-content-container"></div>
        </div>
        <!-- ‚ñº‚ñº‚ñº „ÄêËØ∑Â∞ÜËøô‰∏™Áº∫Â§±ÁöÑ‰ª£Á†ÅÂùó„ÄëÁ≤òË¥¥Âà∞ id="world-book-screen" ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
        <div id="world-book-editor-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span>
                <span id="world-book-editor-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
                <span class="save-btn" id="save-world-book-btn">‰øùÂ≠ò</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="world-book-name-input">‰π¶Âêç</label>
                    <input type="text" id="world-book-name-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...">
                </div>
                <div class="form-group">
                    <label for="world-book-category-select">ÂàÜÁ±ª</label>
                    <select id="world-book-category-select"></select>
                </div>
                <!-- ÁºñËæëÂô®Âå∫Âüü -->
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label>ÂÜÖÂÆπÊù°ÁõÆ</label>
                    <!-- Ëøô‰∏™ÂÆπÂô®Â∞ÜÁî®Êù•Âä®ÊÄÅË£ÖËΩΩÊâÄÊúâÂèØÁºñËæëÁöÑÊù°ÁõÆÂùó -->
                    <div id="world-book-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;">
                        <!-- JS ‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂÜÖÂÆπ -->
                    </div>
                </div>
                <!-- Ê∑ªÂä†Êñ∞Êù°ÁõÆÁöÑÊåâÈíÆ -->
                <button id="add-world-book-entry-btn" class="form-button form-button-secondary"> [+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ </button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢ËøôÊÆµ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ id="api-settings-screen" ÁöÑ div ‚ñº‚ñº‚ñº -->
        <div id="api-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span>API ËÆæÁΩÆ</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- „Äê„Äê„ÄêÂÖ®Êñ∞ÔºöAPIÈ¢ÑËÆæÁÆ°ÁêÜ„Äë„Äë„Äë -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API È¢ÑËÆæÁÆ°ÁêÜ</h3>
                <div class="form-group">
                    <label for="api-preset-select">ÈÄâÊã©ÊàñÂàáÊç¢È¢ÑËÆæ</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="api-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">‰øùÂ≠ò</button>
                        <button id="delete-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">Âà†Èô§</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- ‰∏ªAPIËÆæÁΩÆ -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">‰∏ªAPIËÆæÁΩÆ (Áî®‰∫éËÅäÂ§©)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> ÊèêÁ§∫: Ëã•Ë¶Å‰ΩøÁî®‚ÄúÂèëÈÄÅÂõæÁâá‚ÄùÂäüËÉΩ, ËØ∑Âä°ÂøÖÈÄâÊã©ÊîØÊåÅVision(ËßÜËßâ)ÁöÑÊ®°Âûã, Â¶Ç<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>Êàñ<code
                        style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>„ÄÇ </p>
                <div class="form-group">
                    <label for="proxy-url">Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)</label>
                    <input type="text" id="proxy-url" placeholder="‰æãÂ¶Ç: https://api.openai.com">
                </div>
                <div class="form-group">
                    <label for="api-key">ÂØÜÈí• (API Key)</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="model-select">Ê®°Âûã</label>
                    <select id="model-select"></select>
                </div>
                <button class="form-button" id="fetch-models-btn">ÊãâÂèñ‰∏ªÊ®°Âûã</button>
                <!-- ÂâØAPIËÆæÁΩÆ -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">ÂâØAPIËÆæÁΩÆ (Áî®‰∫éÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> ÊÇ®ÂèØ‰ª•Âú®Ê≠§ÈÖçÁΩÆ‰∏Ä‰∏™Áã¨Á´ãÁöÑ„ÄÅÂèØËÉΩÊàêÊú¨Êõ¥‰ΩéÁöÑAPIÔºå‰∏ìÈó®Áî®‰∫éÂêéÂè∞ÁöÑÈïøÊúüËÆ∞ÂøÜÊÄªÁªì‰ªªÂä°Ôºå‰ª•ËäÇÁúÅ‰∏ªAPIÁöÑË¥πÁî®„ÄÇÂ¶ÇÊûúÁïôÁ©∫ÔºåÂ∞ÜÈªòËÆ§‰ΩøÁî®‰∏ªAPIËøõË°åÊÄªÁªì„ÄÇ </p>
                <div class="form-group">
                    <label for="secondary-proxy-url">ÂâØÂèç‰ª£Âú∞ÂùÄ</label>
                    <input type="text" id="secondary-proxy-url" placeholder="‰æãÂ¶Ç: https://api.groq.com/openai">
                </div>
                <div class="form-group">
                    <label for="secondary-api-key">ÂâØÂØÜÈí•</label>
                    <input type="password" id="secondary-api-key" placeholder="gsk_...">
                </div>
                <div class="form-group">
                    <label for="secondary-model-select">ÂâØÊ®°Âûã</label>
                    <select id="secondary-model-select"></select>
                </div>
                <button class="form-button form-button-secondary" id="fetch-secondary-models-btn">ÊãâÂèñÂâØÊ®°Âûã</button>
                <!-- ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆ -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆ</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="background-activity-switch" style="margin-bottom: 0;"> ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä® <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;"> Ë≠¶ÂëäÔºöÊ≠§ÂäüËÉΩ‰ºöÊòæËëóÂ¢ûÂä†APIË∞ÉÁî®ÂíåË¥πÁî®ÔºÅ </p>
                    </label>
                    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="background-interval-input" style="margin-bottom: 0;"> ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (Áßí) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> Âª∫ËÆÆÂÄº 60-300„ÄÇÂÄºË∂äÂ§ßÔºåË¥πÁî®Ë∂ä‰ΩéÔºå‰ΩÜËßíËâ≤ÂèçÂ∫îË∂äÊÖ¢„ÄÇ </p>
                    </label>
                    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <label for="block-cooldown-input" style="margin-bottom: 0;"> AIË¢´ÊãâÈªëÂêéÂÜ∑ÈùôÊúü (Â∞èÊó∂) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> Ë¢´ÊãâÈªëË∂ÖËøáËøô‰∏™Êó∂Èó¥ÂêéÔºåAIÊâçÊúâÂá†ÁéáÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ </p>
                    </label>
                    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
                </div>
                <!-- ‰øùÂ≠ò‰∏éÂØºÂÖ•ÂØºÂá∫ -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <button class="form-button" id="save-api-settings-btn" style="margin-top: 20px;">‰øùÂ≠òÊâÄÊúâËÆæÁΩÆ</button>
                <button class="form-button" id="export-data-btn">ÂØºÂá∫Êï∞ÊçÆ</button>
                <button class="form-button" id="import-btn">ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂</button>
<!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥‰∏ãÈù¢ÁöÑÊñ∞ÊåâÈíÆ‰ª£Á†Å ‚ñº‚ñº‚ñº -->
<button class="form-button form-button-secondary" id="cleanup-data-btn" style="background-color: #ffebee; color: #c62828; border-color: #ef9a9a; margin-top: 10px;">Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆ</button>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                <input id="import-data-input" type="file" accept="application/json" hidden>

            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢ËøôÊÆµ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ chat-list-screen ‚ñº‚ñº‚ñº -->
        <div id="chat-list-screen" class="screen">
            <!-- ‰∏ªÂ§¥ÈÉ® (Âè™Âú®Ê∂àÊÅØÂàóË°®ÊòæÁ§∫) -->
            <div class="header" id="main-chat-list-header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span id="chat-list-title">Ê∂àÊÅØ</span>
                <div class="header-actions">
                    <span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg></span>
                    <span class="action-btn" id="add-chat-btn">+</span>
                </div>
            </div>
            <!-- Ê∂àÊÅØÂàóË°®ËßÜÂõæ -->
            <div id="messages-view" class="chat-list-view active">
                <div id="chat-list">
                    <!-- JS‰ºöÂú®ËøôÈáåÁîüÊàêËÅäÂ§©ÂàóË°® -->
                </div>
            </div>
            <!-- Âä®ÊÄÅÁïåÈù¢ËßÜÂõæ -->
            <div id="qzone-screen" class="chat-list-view">
                <div class="qzone-header">
                    <span class="back-btn" id="qzone-back-btn">‚Äπ</span> <!-- Ëøô‰∏™ÊåâÈíÆÁé∞Âú®Âè™Ë¥üË¥£‰ªéÂä®ÊÄÅËøîÂõû -->
                    <span>Â•ΩÂèãÂä®ÊÄÅ</span>
                </div>
                <div class="qzone-content">
                    <div class="qzone-profile-header">
                        <div id="qzone-banner-container" class="qzone-banner-container">
                            <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="ËÉåÊôØ">
                            <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                        </div>
                        <div class="qzone-user-info">
                            <div id="qzone-avatar-container" class="qzone-avatar-container">
                                <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="Â§¥ÂÉè">
                                <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                            </div>
                            <span id="qzone-nickname">{{user}}</span>
                        </div>
                    </div>
                    <div class="qzone-actions-bar">
                        <div class="action-item" id="create-shuoshuo-btn"><span>ËØ¥ËØ¥</span></div>
                        <div class="action-item" id="create-post-btn"><span>Âä®ÊÄÅ</span></div>
                        <div class="action-item" id="open-album-btn"><span>Áõ∏ÂÜå</span></div>
                    </div>
                    <div id="qzone-posts-list"></div>
                </div>
            </div>
            <!-- Êî∂ËóèÁïåÈù¢ËßÜÂõæ -->
            <div id="favorites-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="favorites-back-btn">‚Äπ</span>
                    <span>ÊàëÁöÑÊî∂Ëóè</span>
                    <!-- Êñ∞Â¢ûÁöÑÁºñËæëÊåâÈíÆ -->
                    <span class="action-btn" id="favorites-edit-btn">ÁºñËæë</span>
                </div>
                <!-- „ÄêÊñ∞Â¢û„ÄëÊêúÁ¥¢Ê†èÂÆπÂô® -->
                <div class="search-bar-container">
                    <input type="search" id="favorites-search-input" placeholder="ÊêúÁ¥¢Êî∂ËóèÁöÑÊ†áÈ¢ò„ÄÅÂÜÖÂÆπÊàñ‰ΩúËÄÖ...">
                    <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">√ó</button>
                </div>
                <div id="favorites-list" class="list-container">
                    <!-- Êî∂ËóèÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
                <!-- Êñ∞Â¢ûÔºöÊî∂ËóèÈ°µÂ∫ïÈÉ®Êìç‰ΩúÊ†è -->
                <div id="favorites-action-bar" style="display: none;">
                    <button id="favorites-delete-selected-btn" class="action-bar-btn">Âà†Èô§ (0)</button>
                </div>
            </div>
            <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂõûÂøÜÂΩïÁïåÈù¢ËßÜÂõæ ‚ñº‚ñº‚ñº -->
            <div id="memories-view" class="chat-list-view">
                <div class="header">
                    <span class="back-btn" id="memories-back-btn">‚Äπ</span>
                    <span>Êàë‰ª¨ÁöÑÂõûÂøÜ</span>
                    <span class="action-btn" id="add-countdown-btn">+</span>
                </div>
                <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                    <!-- ÂõûÂøÜÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
            <div id="chat-list-bottom-nav">
                <div class="nav-item active" data-view="messages-view">
                    <span>Ê∂àÊÅØ</span>
                </div>
                <div class="nav-item" data-view="qzone-screen">
                    <span>Âä®ÊÄÅ</span>
                </div>
                <!-- ‚ñº‚ñº‚ñº Âú®‚ÄúÂä®ÊÄÅ‚ÄùÂíå‚ÄúÊî∂Ëóè‚Äù‰πãÈó¥ÔºåÂä†ÂÖ•Ëøô‰∏™Êñ∞È°µÁ≠æ ‚ñº‚ñº‚ñº -->
                <div class="nav-item" data-view="memories-view">
                    <span>ÂõûÂøÜ</span>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                <div class="nav-item" data-view="favorites-view">
                    <span>Êî∂Ëóè</span>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢Âå∫ÂüüÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ id="chat-list-screen" ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
        <div id="album-screen" class="screen">
            <!-- 1. È°µÈù¢Â§¥ÈÉ®ÔºåÂåÖÂê´ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò -->
            <div class="header">
                <span class="back-btn" id="album-back-btn">‚Äπ</span>
                <span>ÊàëÁöÑÁõ∏ÂÜå</span>
                <span class="action-btn" id="create-album-btn-page">+</span>
            </div>
            <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
            <div class="list-container">
                <div id="album-grid-page">
                    <!-- Áõ∏ÂÜåÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ id="album-screen" ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
        <div id="album-photos-screen" class="screen">
            <!-- 1. È°µÈù¢Â§¥ÈÉ® -->
            <div class="header">
                <span class="back-btn" id="album-photos-back-btn">‚Äπ</span>
                <span id="album-photos-title">Áõ∏ÂÜåÂêçÁß∞</span>
                <span class="action-btn" id="album-upload-photo-btn">‰∏ä‰º†</span>
            </div>
            <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
            <div class="list-container">
                <div id="photos-grid-page">
                    <!-- ÁÖßÁâáÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
                <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
                <div id="photo-viewer-modal" class="modal">
                    <!-- 1. ÂÖ≥Èó≠ÊåâÈíÆ -->
                    <button id="photo-viewer-close-btn">√ó</button>
                    <!-- 2. ‰∏ä‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
                    <button id="photo-viewer-prev-btn" class="nav-arrow">‚Äπ</button>
                    <!-- 3. ÂõæÁâáÂÆπÂô® -->
                    <div class="photo-viewer-content">
                        <img id="photo-viewer-image" src="" alt="ÂÖ®Â±èÁÖßÁâáÈ¢ÑËßà">
                    </div>
                    <!-- 4. ‰∏ã‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
                    <button id="photo-viewer-next-btn" class="nav-arrow">‚Ä∫</button>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº Á≤òË¥¥Âà∞ #album-photos-screen ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
        <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
        <div id="chat-interface-screen" class="screen">
            <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™‰∫îÂ≠êÊ£ãÂÆπÂô®Á≤òË¥¥Âà∞ËÅäÂ§©ÁïåÈù¢(chat-interface-screen)ÁöÑ„ÄêÊúÄÈ°∂ÈÉ®„Äë ‚ñº‚ñº‚ñº -->
            <div id="gomoku-overlay">
                <div id="gomoku-content-wrapper">
                    <canvas id="gomoku-board"></canvas>
                    <div id="gomoku-controls">
                        <button id="close-gomoku-btn">Êî∂Ëµ∑Ê£ãÁõò</button>
                    </div>
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div class="header">
                <div class="default-controls">
                    <span class="back-btn" id="back-to-list-btn">‚Äπ</span>
                    <div id="global-lyrics-bar"></div>

                    <div id="chat-header-title-wrapper">
                        <span id="chat-header-title">ËÅäÂ§©ÂØπË±°</span>
                        <div id="chat-header-status">
                            <span class="status-dot"></span>
                            <span class="status-text">Âú®Á∫ø</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢‰Ω†Áé∞ÊúâÁöÑ id="open-memory-screen-btn" ÁöÑ span Ê†áÁ≠æ ‚ñº‚ñº‚ñº -->
                        <span class="action-btn" id="open-memory-screen-btn" title="ÈïøÊúüËÆ∞ÂøÜ">
                            <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰ΩøÁî®SVGÂõæÊ†áÊõøÊç¢ÂéüÊù•ÁöÑÂõæÁâá -->
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M12 6L9 9L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 5V19C21 20.1046 20.1046 21 19 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                        <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="‰∏ÄËµ∑Âê¨"></span>
                        <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"><img src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="ËÆæÁΩÆ"></span>
                    </div>
                </div>
                <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÊõøÊç¢‰Ω†ÂéüÊù•ÁöÑ .selection-controls div ‚ñº‚ñº‚ñº -->
                <div class="selection-controls">
                    <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                    <span id="selection-count"></span>
                    <div class="header-actions">
                        <span id="selection-screenshot-btn" class="action-btn">ÈïøÊà™Âõæ</span>
                        <span id="selection-favorite-btn" class="action-btn">Êî∂Ëóè</span>
                        <span id="selection-share-btn" class="action-btn">ÂàÜ‰∫´</span>
                        <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊóßÊåâÈíÆÈáçÂëΩÂêçÔºåÂäüËÉΩ‰∏çÂèò -->
                        <span id="selection-soft-delete-btn" class="action-btn">Âà†Èô§(ÈÄöÁü•AI)</span>
                        <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÊñ∞Â¢û‰∏Ä‰∏™Á∫¢Ëâ≤ÁöÑ„ÄÅÊõ¥Âº∫ÂäõÁöÑÂà†Èô§ÊåâÈíÆ -->
                        <span id="selection-erase-btn" class="action-btn" style="color: #ff3b30;">ÂΩªÂ∫ïÂà†Èô§</span>
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            </div>
            <div id="chat-messages">
                <div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>
            </div>
            <div id="chat-input-area">
                <div id="chat-at-mention-popup" class="at-mention-popup"></div>
                <div id="reply-preview-bar">
                    <div class="reply-preview-content">
                        <div class="sender">ÂõûÂ§ç xxx:</div>
                        <div class="text">Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØÂÜÖÂÆπ...</div>
                    </div>
                    <span id="cancel-reply-btn">√ó</span>
                </div>
                <div id="chat-input-actions-top">
                    <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="Ë°®ÊÉÖÈù¢Êùø">+</button>
                    <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅÁÖßÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg></button>
                    <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="‰∏ä‰º†ÂõæÁâá">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                    <button id="transfer-btn" class="chat-action-icon-btn action-button" title="ËΩ¨Ë¥¶">Ôø•</button>
                    <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅËØ≠Èü≥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <path d="M12 19v4"></path>
                            <path d="M8 23h8"></path>
                        </svg></button>
                    <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg></button>
                    <button id="video-call-btn" class="chat-action-icon-btn action-button" title="ËßÜÈ¢ëÈÄöËØù"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg></button>
                    <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="Áæ§ËßÜÈ¢ëÈÄöËØù"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg></button>
                    <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="ÂèëËµ∑ÊäïÁ•®"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6h10"></path>
                            <path d="M6 6h.01"></path>
                            <path d="M8 12h10"></path>
                            <path d="M6 12h.01"></path>
                            <path d="M8 18h10"></path>
                            <path d="M6 18h.01"></path>
                        </svg></button>
                    <button id="share-link-btn" class="chat-action-icon-btn action-button" title="ÂàÜ‰∫´ÈìæÊé•"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
                        </svg></button>
                    <button id="share-location-btn" class="chat-action-icon-btn action-button" title="ÂÖ±‰∫´‰ΩçÁΩÆ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg></button>
                    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÊåâÈíÆÔºåÁ≤òË¥¥Âà∞ id="chat-input-actions-top" ÂÆπÂô®ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
                    <button id="gomoku-btn" class="chat-action-icon-btn action-button" title="‰∫îÂ≠êÊ£ã">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="4"></circle>
                            <circle cx="12" cy="12" r="7"></circle>
                        </svg>
                    </button>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <!-- ‚ñº‚ñº‚ñº Âú®‚ÄúË°®ÊÉÖÈù¢Êùø‚ÄùÊåâÈíÆÂêéÔºåÁ≤òË¥¥Ëøô‰∏™Êñ∞ÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                    <button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="Ë¥≠Áâ©">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </button>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂçïËÅä‰∏ìÁî®ÁöÑ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÊåâÈíÆ (QÂºπÂõæÊ†áÁâà) ‚ñº‚ñº‚ñº -->
                    <button id="pat-btn" class="chat-action-icon-btn action-button" title="Êãç‰∏Ä-Êãç" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 5.02c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M14.5 11.02c0 .83-.67 1.5-1.5 1.5v0c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5v0c.83 0 1.5.67 1.5 1.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M5.5 14.52l-1.92-1.92c-.34-.34-.34-.89 0-1.23l3.58-3.58c.34-.34.89-.34 1.23 0l1.92 1.92c.34.34.34.89 0 1.23l-3.58 3.58c-.34.34-.89.34-1.23 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÊåâÈíÆÔºåÁ≤òË¥¥Âà∞ id="chat-input-actions-top" ÂÆπÂô®ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
                    <button id="edit-last-response-btn" class="chat-action-icon-btn action-button" title="ÂØºÊºîÊ®°ÂºèÔºöÁºñËæëAI‰∏ä‰∏ÄËΩÆÁöÑÂÆåÊï¥ÂìçÂ∫î">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                        <!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞ÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                        <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞ÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                        <button id="propel-btn" class="chat-action-icon-btn action-button" title="Êé®ËøõÂâßÊÉÖ" style="display: flex;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="13 19 22 12 13 5 13 19"></polygon>
                                <polygon points="2 19 11 12 2 5 2 19"></polygon>
                            </svg>
                        </button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <button id="show-announcement-board-btn" class="chat-action-icon-btn action-button" title="Áæ§ÂÖ¨ÂëäÊùø" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21.782 6.132a1 1 0 0 0-1.053-.08l-4.729 2.489a1 1 0 0 0-.5.88v4.158a1 1 0 0 0 .5.88l4.729 2.489a1 1 0 0 0 1.053-.08a1 1 0 0 0 .499-.921V7.052a1 1 0 0 0-.499-.92zm-6 3.207L11 7.05v9.9l4.782-2.281V9.339zM10 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6V6z" />
                        </svg>
                    </button>
                </div>
                <div id="chat-input-main-row">
                    <textarea id="chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                    <div id="input-actions-wrapper">
                        <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="Á≠âÂæÖÂõûÂ§ç"></button>
                        <button id="send-btn" class="action-button">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>
            <div id="chat-lock-overlay">
                <div id="chat-lock-content"></div>
            </div>
            <div id="sticker-panel">
                <div id="sticker-panel-header">
                    <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                    <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
                    <div style="display: flex; gap: 10px;">
                        <span class="panel-btn" id="manage-stickers-btn">ÁÆ°ÁêÜ</span>
                        <span class="panel-btn" id="add-sticker-batch-btn">ÊâπÈáè</span>
                        <span class="panel-btn" id="add-sticker-url-btn">URL</span>
                        <span class="panel-btn" id="upload-sticker-btn">‰∏ä‰º†</span>
                    </div>
                </div>
                <div id="sticker-grid"></div>
            </div>
            <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
<div id="music-player-overlay">
    <!-- ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ .music-player-window ‚ñº‚ñº‚ñº -->
    <div class="music-player-window">
        <div class="music-player-top-actions">
            <div class="top-left-cluster">
                <button id="music-return-btn">‚Äπ</button>
                <button id="music-exit-btn">√ó</button>
            </div>
            <span id="music-playlist-btn">‚ò∞</span>
        </div>

        <!-- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞ÜÊ≠åÊõ≤‰ø°ÊÅØÁßªÂä®Âà∞Âî±Áâá‰∏äÊñπÔºåÂπ∂Áî®‰∏Ä‰∏™ÂÆπÂô®ÂåÖË£π -->
        <div id="music-info-top">
            <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div>
            <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
            <div id="music-player-artist">...</div>
        </div>

        <!-- Âî±Áâá/Ê≠åËØçÂàáÊç¢ÂÆπÂô®‰øùÊåÅ‰∏çÂèò -->
        <div id="music-visual-container">
            <div id="vinyl-view">
                <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art">
            </div>
            <div id="inline-lyrics-view">
                <div id="music-lyrics-container">
                    <div id="music-lyrics-list">
                        <!-- JS ‰ºöÂú®ËøôÈáåÂ°´ÂÖÖÊ≠åËØç -->
                    </div>
                </div>
            </div>
        </div>
    <div id="single-lyric-display">‚ô™ ‚ô™ ‚ô™</div>
        <!-- Â∫ïÈÉ®ÊéßÂà∂Âå∫Âüü‰øùÊåÅ‰∏çÂèò -->
        <div class="music-player-controls-wrapper">
            <div class="music-progress-bar-container">
                <div id="music-current-time" class="time-display">0:00</div>
                <div class="progress-bar">
                    <div id="music-progress-fill" class="progress-bar-fill"></div>
                </div>
                <div id="music-total-time" class="time-display">0:00</div>
            </div>
            <div class="music-controls">
                <button id="music-prev-btn">‚óÄ</button>
                <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button>
                <button id="music-next-btn">‚ñ∂</button>
                <button id="music-mode-btn">È°∫Â∫è</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
</div>
            <div id="music-playlist-panel">
                <div class="playlist-header">
                    <span class="panel-btn" id="close-playlist-btn">ËøîÂõû</span>
                    <span>Êí≠ÊîæÂàóË°®</span>
                    <div>
                     <span class="panel-btn" id="cleanup-songs-btn">Ê∏ÖÁêÜ</span>
                        <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span>
                        <span class="panel-btn" id="add-song-url-btn">URL</span>
        <span class="panel-btn" id="add-song-search-btn">ÊêúÁ¥¢</span>
                        <span class="panel-btn" id="import-netease-playlist-btn">ÁΩëÊòì‰∫ë</span>
                        <span class="panel-btn" id="view-import-history-btn">ÂéÜÂè≤</span>
                        <span class="panel-btn" id="fix-unplayable-songs-btn">‰øÆÂ§ç</span>
                    </div>
                </div>
                <div class="playlist-body" id="playlist-body"></div>
            </div>
            <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
            <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
        </div>
        <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥Âùó„ÄêÂ∑≤‰øÆÂ§ç„ÄëÁöÑ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†Áé∞ÊúâÁöÑ id="wallpaper-screen" ÁöÑÈÇ£Êï¥‰∏™ <div> ‚ñº‚ñº‚ñº -->
        <div id="wallpaper-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span>Â§ñËßÇËÆæÁΩÆ</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <!-- Â£ÅÁ∫∏ËÆæÁΩÆÈÉ®ÂàÜ -->
                <div id="wallpaper-preview">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†</div>
                <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">‰∏ä‰º†Â£ÅÁ∫∏</button>
                <input type="file" id="wallpaper-upload-input" accept="image/*">
                <!-- Â§úÈó¥Ê®°ÂºèÂºÄÂÖ≥ -->
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="theme-toggle-switch" style="margin-bottom: 0;">Â§úÈó¥Ê®°Âºè</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle-switch">
                        <span class="slider"></span>
                    </label>
                </div>
<!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥‰∏ãÈù¢ÁöÑÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº -->
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="status-bar-toggle-switch" style="margin-bottom: 0;">ÊòæÁ§∫È°∂ÈÉ®Áä∂ÊÄÅÊ†è</label>
    <label class="toggle-switch">
        <input type="checkbox" id="status-bar-toggle-switch">
        <span class="slider"></span>
    </label>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊï¥Âùó„ÄêÂÖ®Êñ∞‰ª£Á†Å„ÄëÔºåÁ≤òË¥¥Âà∞‚ÄúApp ÂõæÊ†áËÆæÁΩÆ‚ÄùÊ®°ÂùóÁöÑÂâçÈù¢ (ÈÇ£Êù° <hr> Ê†áÁ≠æ‰πãÂâç) ‚ñº‚ñº‚ñº -->
<hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
<div style="width:100%; text-align: left; margin-bottom: 15px;">
    <label style="font-weight: 500; color: var(--text-secondary);">Ê∂àÊÅØÊèêÁ§∫Èü≥</label>
</div>
<div class="form-group" style="width:100%;">
    <label for="notification-sound-url-input">ÊèêÁ§∫Èü≥Êñá‰ª∂ URL (.mp3, .wav, .ogg)</label>
    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
        <input type="text" id="notification-sound-url-input" placeholder="ÁïôÁ©∫Âàô‰ΩøÁî®ÈªòËÆ§ÊèêÁ§∫Èü≥" style="flex-grow: 1;">
        <button id="test-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">‚ñ∂</button>
        <button id="reset-sound-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ÈáçÁΩÆ</button>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                <!-- App ÂõæÊ†áËÆæÁΩÆÂå∫Âüü -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div style="width:100%; text-align: left; margin-bottom: 15px;">
                    <label style="font-weight: 500; color: var(--text-secondary);">App ÂõæÊ†áËÆæÁΩÆ</label>
                </div>
                <div id="icon-settings-grid">
                    <!-- ÂõæÊ†áËÆæÁΩÆÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
                <!-- „Äê„Äê„ÄêËøôÂ∞±ÊòØË°•‰∏äÁöÑ„ÄÅÁº∫Â§±ÁöÑÂÖ®Â±ÄCSSËæìÂÖ•Ê°ÜÔºÅ„Äë„Äë„Äë -->
                <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
                <div class="form-group" style="width:100%;">
                    <label for="global-css-input"> ÂÖ®Â±ÄÁæéÂåñÊ†∑Âºè (CSS) <button id="reset-global-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">ÈáçÁΩÆ</button>
                    </label>
                    <textarea id="global-css-input" rows="6" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* Á§∫‰æãÔºöÂ∞ÜÊâÄÊúâÈ°∂ÈÉ®Ê†èÂèò‰∏∫Á≤âËâ≤ */
.header, .qzone-header {
  background-color: rgba(255, 192, 203, 0.8) !important;
  color: #a35c7b !important;
    /* ‰ΩøÁî® env(safe-area-inset-top) Ëá™Âä®Ëé∑ÂèñÈ°∂ÈÉ®ÂÆâÂÖ®Ë∑ùÁ¶ª */
    padding-top: calc(15px + env(safe-area-inset-top));
}

/* Á§∫‰æãÔºöËÆ©Âä®ÊÄÅÂå∫ÁöÑËÉåÊôØ‰πüÂèòÁ≤â */
#qzone-screen .qzone-content {
    background-color: #fff0f5 !important;
}"></textarea>
                </div>
                <!-- JSONÂØºÂÖ•ÂØºÂá∫ÊåâÈíÆ -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="form-button form-button-secondary" id="export-json-btn" style="flex: 1;">ÂØºÂá∫JSONÁæéÂåñ</button>
                    <button class="form-button form-button-secondary" id="import-json-btn" style="flex: 1;">ÂØºÂÖ•JSONÁæéÂåñ</button>
                </div>
                
                <!-- JSONÁæéÂåñÈÖçÁΩÆÂàóË°® -->
                <div class="form-group" style="margin-top: 20px;">
                    <label>Â∑≤‰øùÂ≠òÁöÑÁæéÂåñÈÖçÁΩÆ</label>
                    <div id="json-configs-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                        <!-- JSONÈÖçÁΩÆÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                
                <!-- ‰øùÂ≠òÊåâÈíÆ -->
                <button class="form-button" id="save-wallpaper-btn" style="margin-top: 20px;">‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ</button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàÜ‰∫´ÈìæÊé•ÂäüËÉΩ HTML ‚ñº‚ñº‚ñº -->
        <div id="browser-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="browser-back-btn">‚Äπ</span>
                <span id="browser-title"></span>
                <span style="width: 30px;"></span>
            </div>
            <div id="browser-content" class="list-container">
                <!-- ÊñáÁ´†ÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <div id="font-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span>Â≠ó‰ΩìËÆæÁΩÆ</span>
                <span class="action-btn" id="batch-import-fonts-btn">ÊâπÈáèÂØºÂÖ•</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label for="font-url-input">Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)</label>
                    <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
                </div>
                <div class="form-group">
                    <label>ÂÆûÊó∂È¢ÑËßà</label>
                    <div id="font-preview">
                        <p style="font-size: 20px; margin: 0 0 10px 0;">‰Ω†Â•Ω‰∏ñÁïå Hello World</p>
                        <p style="margin: 0;">ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ</p>
                    </div>
                </div>
                <button class="form-button" id="save-font-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
                <button class="form-button form-button-secondary" id="reset-font-btn">ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì</button>
                
                <!-- Â≠ó‰ΩìÂ∫ìÁÆ°ÁêÜÂå∫Âüü -->
                <div class="form-group" style="margin-top: 30px;">
                    <label>Â≠ó‰ΩìÂ∫ìÁÆ°ÁêÜ</label>
                    <div id="font-library-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                        <!-- Â≠ó‰ΩìÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄâÊã©ËÅîÁ≥ª‰∫∫‰ª•ÂàõÂª∫Áæ§ËÅäÁöÑÂ±èÂπï ‚ñº‚ñº‚ñº -->
        <div id="contact-picker-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="cancel-contact-picker-btn">ÂèñÊ∂à</span>
                <span>ÈÄâÊã©ËÅîÁ≥ª‰∫∫</span>
                <span class="save-btn" id="confirm-contact-picker-btn">ÂÆåÊàê(0)</span>
            </div>
            <div class="list-container" id="contact-picker-list">
                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÂ±èÂπï ‚ñº‚ñº‚ñº -->
        <div id="member-management-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="back-from-member-management">‚Äπ</span>
                <span>Áæ§ÊàêÂëòÁÆ°ÁêÜ</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="list-container" id="member-management-list">
                <!-- Áé∞ÊúâÊàêÂëòÂàóË°®‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div id="member-management-actions">
                <button id="add-existing-contact-btn">‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†</button>
                <button id="create-new-member-btn">ÂàõÂª∫Áæ§ÂÜÖÊñ∞ÊàêÂëò</button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëNPCÁÆ°ÁêÜÂ±èÂπï ‚ñº‚ñº‚ñº -->
<div id="npc-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-npc-management">‚Äπ</span>
        <span id="npc-management-title">NPC ÁÆ°ÁêÜ</span>
        <!-- Ê†∏ÂøÉ‰øÆÊîπÔºöÊàë‰ª¨Â∞Ü‚ÄúÂàõÂª∫‚ÄùÊåâÈíÆÊîæÂú®‰∫ÜËøôÈáå -->
        <div class="header-actions">
            <span class="action-btn" id="create-new-npc-btn">+</span>
        </div>
    </div>
    <div class="list-container" id="npc-management-list">
        <!-- NPCÂàóË°®‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
    </div>
    <!-- ËøôÈáåÁöÑÊóßÊåâÈíÆÂÆπÂô®Â∑≤Ë¢´ÁßªÈô§ -->
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊù•ÁîµËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
        <div id="incoming-call-modal" class="modal">
            <div class="incoming-call-content">
                <img id="caller-avatar" class="caller-avatar" src="">
                <div id="caller-name" class="caller-name"></div>
                <div class="caller-text">ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù</div>
                <div class="incoming-call-actions">
                    <div class="action-button-wrapper">
                        <button id="decline-call-btn" class="call-action-btn decline"></button>
                        <span>ÊãíÁªù</span>
                    </div>
                    <div class="action-button-wrapper">
                        <button id="accept-call-btn" class="call-action-btn accept"></button>
                        <span>Êé•Âê¨</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµ„ÄêÂÖ®Êñ∞Áæ§ËÅäÂÖºÂÆπÁªìÊûÑ„ÄëÁöÑ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†ÊóßÁöÑ #video-call-screen ‚ñº‚ñº‚ñº -->
        <!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢Êéâ‰Ω†Êñá‰ª∂‰∏≠ÊóßÁöÑ #video-call-screen ÂèäÂÖ∂ÊâÄÊúâÂÜÖÂÆπ ‚ñº‚ñº‚ñº -->
<div id="video-call-screen" class="screen">
    <!-- Ëøô‰∏™ screen ÂêåÊó∂‰∏∫‰∏§ÁßçÊ®°ÂºèÊúçÂä° -->

    <!-- ======================================================= -->
    <!-- Ê®°Âºè‰∏ÄÔºöÂÖ®Êñ∞ÁöÑ„ÄêÂèØËßÜÂåñ„ÄëËßÜÈ¢ëÈÄöËØùÁïåÈù¢ -->
    <!-- ======================================================= -->
    <div id="visual-call-interface" style="display: none;"> <!-- ÈªòËÆ§ÈöêËóè -->
        <!-- 1. ËßÜÈ¢ëËÉåÊôØÂ±Ç (Â§ßÂõæÂíåÂ∞èÂõæÈÉΩÂú®ËøôÈáå) -->
        <div class="video-background">
            <!-- Â§ßÂõæÂÆπÂô® -->
            <div id="video-main-view" class="video-container">
                <img src="" alt="‰∏ªËßÜÈ¢ëÁîªÈù¢">
            </div>
            <!-- Â∞èÂõæÂÆπÂô® (Áîª‰∏≠Áîª) -->
            <div id="video-pip-view" class="video-container pip">
                <img src="" alt="Â∞èÁ™óËßÜÈ¢ëÁîªÈù¢">
            </div>
        </div>

        <!-- 2. È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
        <div class="video-call-top-bar">
            <span id="visual-call-timer">00:00</span>
        </div>

        <!-- 3. ËÅäÂ§©Ê∞îÊ≥°ÊòæÁ§∫Âå∫Âüü -->
        <div id="video-call-messages-visual" class="video-call-main">
            <!-- ËÅäÂ§©Ê∞îÊ≥°‰ºöÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>

        <!-- 4. Â∫ïÈÉ®ÊéßÂà∂Ê†è -->
        <div class="video-call-controls">
            <!-- Èáç-rollÊåâÈíÆ -->
            <button id="reroll-call-btn" class="control-btn reroll-btn" title="ÈáçÊñ∞ÁîüÊàê"></button>
            <!-- ÂèëË®ÄÊåâÈíÆ -->
            <button id="user-speak-btn-visual" class="control-btn speak-btn" title="ÂèëË®Ä"></button>
            <!-- ÂàáÊç¢ÈïúÂ§¥ÊåâÈíÆ -->
            <button id="switch-camera-btn" class="control-btn switch-camera-btn" title="ÂàáÊç¢ÈïúÂ§¥"></button>
            <!-- ÊåÇÊñ≠ÊåâÈíÆ -->
            <button id="hang-up-btn-visual" class="control-btn hangup-btn"></button>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- Ê®°Âºè‰∫åÔºö‰Ω†ÂéüÊù•ÁöÑ„ÄêÁ∫ØÊñáÂ≠ó„ÄëËØ≠Èü≥ÈÄöËØùÁïåÈù¢ (Êàë‰ª¨ÊääÂÆÉ‰øùÁïô‰∏ãÊù•‰Ωú‰∏∫ÈªòËÆ§ÈÄâÈ°π) -->
    <!-- ======================================================= -->
    <div id="text-call-interface" style="display: none;"> <!-- ÈªòËÆ§ÈöêËóè -->
        <div class="video-call-top-bar">
            <span id="call-timer">00:00</span>
        </div>
        <div class="video-call-avatar-area">
            <div id="participant-avatars-grid">
                <!-- JS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂ§¥ÂÉè -->
            </div>
        </div>
        <div id="video-call-main" class="video-call-main">
            <!-- ÂØπËØùÂÜÖÂÆπ‰ºöÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="video-call-controls">
            <!-- „ÄêÊñ∞Â¢û„Äë‰∏∫ÊóßÊ®°Âºè‰πüÂä†‰∏äÈáçrollÊåâÈíÆ -->
            <button id="reroll-call-btn-text" class="control-btn reroll-btn" title="ÈáçÊñ∞ÁîüÊàê"></button>
            <button id="user-speak-btn" class="control-btn speak-btn"></button>
            <button id="hang-up-btn" class="control-btn hangup-btn"></button>
            <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„ÄëÊ≠£Âú®ÂëºÂè´ÁïåÈù¢ ‚ñº‚ñº‚ñº -->
        <div id="outgoing-call-screen" class="screen">
            <div class="outgoing-call-content">
                <img id="outgoing-call-avatar" class="caller-avatar" src="">
                <div id="outgoing-call-name" class="caller-name"></div>
                <div class="caller-text">Ê≠£Âú®ÂëºÂè´...</div>
                <div class="outgoing-call-actions">
                    <button id="cancel-call-btn" class="call-action-btn decline"></button>
                    <span>ÂèñÊ∂à</span>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄöËØùËÆ∞ÂΩïÈ°µÈù¢ ‚ñº‚ñº‚ñº -->
        <div id="call-history-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="call-history-back-btn">‚Äπ</span>
                <span id="call-history-title">ÈÄöËØùËÆ∞ÂΩï</span>
                <span style="width: 30px;"></span> <!-- Âç†‰ΩçÁ¨¶Ôºå‰øùÊåÅÊ†áÈ¢òÂ±Ö‰∏≠ -->
            </div>
            <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                <!-- ÈÄöËØùËÆ∞ÂΩïÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË¥≠Áâ©ÂäüËÉΩÁõ∏ÂÖ≥È°µÈù¢‰∏éÂºπÁ™ó (V4.0 - ‰ªøÊ∑òÂÆùÁªàÊûÅÁâà) ‚ñº‚ñº‚ñº -->
        <div id="shopping-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="shopping-back-btn">‚Äπ</span>
                <span>Ë¥≠Áâ©‰∏≠ÂøÉ</span>
                <div class="header-actions">
                    <!-- ‚ÄúÁÆ°ÁêÜ‚ÄùÊåâÈíÆÂ∑≤ÊõøÊç¢‰∏∫SVGÂõæÊ†á -->
                    <span class="action-btn" id="manage-products-btn" title="ÁÆ°ÁêÜÂïÜÂìÅ">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </span>
                    <!-- Êñ∞Â¢ûÁöÑ‚ÄúÊ∑ªÂä†ÂïÜÂìÅ‚ÄùSVGÂõæÊ†áÊåâÈíÆ -->
                    <span class="action-btn" id="add-new-product-btn" title="Ê∑ªÂä†Êñ∞ÂïÜÂìÅ">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </span>
                    <!-- Ë¥≠Áâ©ËΩ¶ÊåâÈíÆ‰øùÊåÅ‰∏çÂèò -->
                    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞SVGÂõæÊ†áÁâà„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑË¥≠Áâ©ËΩ¶ÂõæÊ†á ‚ñº‚ñº‚ñº -->
                    <span class="action-btn" id="go-to-cart-btn" title="Êü•ÁúãË¥≠Áâ©ËΩ¶">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                        <span id="cart-count">0</span>
                    </span>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div id="product-grid" class="list-container">
                <!-- ÂïÜÂìÅÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        <!-- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÂïÜÂìÅËØ¶ÊÉÖÈ°µ -->
        <div id="product-detail-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="product-detail-back-btn">‚Äπ</span>
                <span>ÂïÜÂìÅËØ¶ÊÉÖ</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="product-detail-content" class="list-container">
                <!-- ËØ¶ÊÉÖÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div id="product-detail-footer">
                <button class="footer-btn add-to-cart-detail-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                <button class="footer-btn buy-now-btn">Á´ãÂç≥Ë¥≠‰π∞</button>
            </div>
        </div>
        <div id="cart-screen" class="screen">
            <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµÊñ∞‰ª£Á†ÅÊõøÊç¢Ë¥≠Áâ©ËΩ¶È°µÈù¢ÁöÑHeader ‚ñº‚ñº‚ñº -->
            <div class="header">
                <span class="back-btn" id="cart-back-btn">‚Äπ</span>
                <span id="cart-title">Ë¥≠Áâ©ËΩ¶(0)</span>
                <span class="action-btn" id="clear-cart-btn">Ê∏ÖÁ©∫</span> <!-- Â∞Ü‚ÄúÁÆ°ÁêÜ‚ÄùÊõøÊç¢‰∏∫‚ÄúÊ∏ÖÁ©∫‚ÄùÂäüËÉΩ -->
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div id="cart-items-list" class="list-container">
                <!-- Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div id="cart-footer">
                <label class="select-all-label"><input type="checkbox" id="select-all-cart-items"> ÂÖ®ÈÄâ</label>
                <div class="cart-summary">
                    <div id="cart-total">ÂêàËÆ°: ¬•0.00</div>
                    <span class="cart-subtext">‰∏çÂê´ËøêË¥π</span>
                </div>
                <button id="checkout-btn">ÁªìÁÆó(0)</button>
            </div>
        </div>
        <div id="product-editor-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span id="product-editor-title">Ê∑ªÂä†ÂïÜÂìÅ</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ÂïÜÂìÅÂõæÁâá</label>
                        <div class="avatar-upload">
                            <img id="product-image-preview" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg">
                            <button onclick="document.getElementById('product-image-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                            <input type="file" id="product-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="product-name-input">ÂïÜÂìÅÂêçÁß∞</label>
                        <input type="text" id="product-name-input">
                    </div>
                    <div class="form-group">
                        <label for="product-price-input">‰ª∑Ê†º (ÂÖÉ)</label>
                        <input type="number" id="product-price-input" min="0" step="0.01">
                    </div>
                    <!-- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÂïÜÂìÅÊèèËø∞ËæìÂÖ•Ê°Ü -->
                    <div class="form-group">
                        <label for="product-description-input">ÂïÜÂìÅÊèèËø∞</label>
                        <textarea id="product-description-input" rows="4" placeholder="ËØ¶ÁªÜ‰ªãÁªç‰∏Ä‰∏ãËøô‰∏™ÂïÜÂìÅ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-product-editor-btn">ÂèñÊ∂à</button>
                    <button class="save" id="save-product-btn">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
        <div id="gift-receipt-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Ë¥≠Áâ©Â∞èÁ•®</span>
                </div>
                <div class="modal-body" id="gift-receipt-body">
                    <!-- Â∞èÁ•®ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="modal-footer">
                    <button class="save" id="close-receipt-btn" style="width:100%;">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    </div>
    </div>
    <input type="file" id="import-card-input" accept=".json,.png" style="display: none;">
<!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ËÆæÁΩÆÈ°µÈù¢ÁªìÊûÑ ‚ñº‚ñº‚ñº -->
<div id="chat-settings-screen" class="screen">
    <!-- 1. È°µÈù¢ÁöÑÂ§¥ÈÉ®ÔºåÂåÖÂê´ËøîÂõûÂíå‰øùÂ≠òÊåâÈíÆ -->
    <div class="header">
        <span class="back-btn" onclick="showScreen('chat-interface-screen')">‚Äπ</span>
        <span>ËÅäÂ§©ËÆæÁΩÆ</span>
        <span class="save-btn" id="save-chat-settings-btn">‰øùÂ≠ò</span>
    </div>

    <!-- 2. È°µÈù¢ÁöÑÂÜÖÂÆπÂÆπÂô®ÔºåÁé∞Âú®ÂèØ‰ª•ÊªöÂä®‰∫Ü -->
    <div class="form-container">
        <!-- 
          ËøôÈáåÁöÑÂÜÖÂÆπÂ∞±ÊòØ‰Ω†ÂéüÊù• modal-body ÈáåÁöÑÊâÄÊúâ form-group„ÄÇ
          Êàë‰ª¨Â∑≤ÁªèÂ∞ÜÂÆÉ‰ª¨ÂéüÂ∞Å‰∏çÂä®Âú∞ÁßªÂä®Âà∞ËøôÈáå‰∫Ü„ÄÇ
        -->
        <div class="form-group" id="chat-name-group"><label for="chat-name-input">Â§áÊ≥®Âêç / Áæ§Âêç</label><input type="text" id="chat-name-input"></div>
        <div class="form-group" id="my-nickname-group">
            <label for="my-nickname-input">ÊàëÁöÑÊòµÁß∞</label>
            <input type="text" id="my-nickname-input">
        </div>
        <div class="form-group" id="assign-group-section" style="display: none;">
            <label for="assign-group-select">Â•ΩÂèãÂàÜÁªÑ</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="assign-group-select" style="flex-grow: 1;"></select>
                <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ÁÆ°ÁêÜÂàÜÁªÑ</button>
            </div>
        </div>
        <div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">ÊàëÁöÑÁæ§ÊòµÁß∞</label><input type="text" id="my-group-nickname-input"></div>
        <div class="form-group" id="ai-cooldown-group">
            <label for="ai-action-cooldown-input"> Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIÂú®ÂêéÂè∞‰∏ªÂä®ÂèëÊ∂àÊÅØÊàñÂä®ÊÄÅÁöÑÊúÄÂ∞èÈó¥Èöî„ÄÇ </p>
            </label>
            <input type="number" id="ai-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
        <div class="form-group" id="group-cooldown-group">
            <label for="group-action-cooldown-input"> Áæ§ËÅäË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> AIÂú®ÂêéÂè∞‰∏ªÂä®Âú®Áæ§ÂÜÖË°åÂä®ÁöÑÊúÄÂ∞èÈó¥Èöî„ÄÇ </p>
            </label>
            <input type="number" id="group-action-cooldown-input" min="1" value="10" style="width: 80px; text-align: center;">
        </div>
        <div class="form-group" id="group-avatar-group">
            <label>Áæ§Â§¥ÂÉè</label>
            <div class="avatar-upload">
                <img id="group-avatar-preview">
                <button onclick="document.getElementById('group-avatar-input').click()">‰∏ä‰º†Áæ§Â§¥ÂÉè</button>
                <button id="manage-group-avatar-library-btn">ÁÆ°ÁêÜÂ§¥ÂÉèÂ∫ì</button>
                <input type="file" id="group-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="world-book-link-group">
            <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ÂèØÂ§öÈÄâ)</label>
            <div class="custom-multiselect">
                <div class="select-box">
                    <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                    <span class="arrow-down">‚ñº</span>
                </div>
                <div id="world-book-checkboxes-container" class="checkboxes-container">
                </div>
            </div>
        </div>
<!-- Á≤òË¥¥Âà∞ ‚ÄúÂØπÊñπ‰∫∫ËÆæ‚Äù (ai-persona-group) ÁöÑ form-group ‰πãÂêé -->
<div class="form-group" id="npc-management-group">
    <label>‰∏ìÂ±ûNPCÁÆ°ÁêÜ</label>
    <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
        ‰∏∫ËØ•ËßíËâ≤Ê∑ªÂä†‰∏ìÂ±ûÁöÑNPCÔºåÂΩìTAÂèëÂ∏ÉÂä®ÊÄÅÊó∂ÔºåËøô‰∫õNPC‰ºöËá™Âä®ËøõË°åËØÑËÆ∫„ÄÇ
    </p>
    <button id="manage-npcs-btn" class="form-button form-button-secondary" style="margin-top: 10px;">ÁÆ°ÁêÜNPC</button>
</div>
        <div class="form-group" id="lyrics-position-group" style="display: none;">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <label>Ê≠åËØçÊ†è‰ΩçÁΩÆ</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">
                <div>
                    <label for="lyrics-vertical-pos" style="font-size: 0.9em; color: var(--text-secondary);">ÂûÇÁõ¥‰ΩçÁΩÆ</label>
                    <select id="lyrics-vertical-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="top">È°∂ÈÉ®</option>
                        <option value="bottom">Â∫ïÈÉ®</option>
                    </select>
                </div>
                <div>
                    <label for="lyrics-horizontal-pos" style="font-size: 0.9em; color: var(--text-secondary);">Ê∞¥Âπ≥ÂØπÈΩê</label>
                    <select id="lyrics-horizontal-pos" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <option value="left">Â±ÖÂ∑¶</option>
                        <option value="center">Â±Ö‰∏≠</option>
                        <option value="right">Â±ÖÂè≥</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label for="lyrics-offset-input" style="font-size: 0.9em; color: var(--text-secondary);">ÂûÇÁõ¥ÂÅèÁßª (px)</label>
                <input type="number" id="lyrics-offset-input" value="10" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
        </div>
        <div class="form-group" id="offline-mode-group">
            <hr style="opacity: 0.3; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label for="offline-mode-toggle" style="margin-bottom: 0;"> ÂêØÁî®Á∫ø‰∏ãÊ®°Âºè <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ÂºÄÂêØÂêé, AIÁöÑÂõûÂ§çÂ∞ÜÂèò‰∏∫ÂåÖÂê´„ÄåÂØπËØù„ÄçÂíå<i style="color: #666;">Âä®‰Ωú/ÁéØÂ¢ÉÊèèÂÜô</i>ÁöÑÂâßÊÉÖÊ®°Âºè„ÄÇ </p>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="offline-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="offline-mode-options" style="display: none; margin-top: 15px;">
                <label for="offline-min-length-input">ÂõûÂ§çÂ≠óÊï∞ËåÉÂõ¥</label>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                    <input type="number" id="offline-min-length-input" value="100" style="width: 80px; text-align: center;">
                    <span>Âà∞</span>
                    <input type="number" id="offline-max-length-input" value="300" style="width: 80px; text-align: center;">
                    <span>Â≠ó</span>
                </div>
            </div>
        </div>
        <div class="form-group" id="linked-memory-group">
            <label for="link-memory-toggle">ÊåÇËΩΩÂÖ∂‰ªñËÅäÂ§©ËÆ∞ÂøÜ</label>
            <input type="checkbox" id="link-memory-toggle" style="width: auto; height: 20px; vertical-align: middle; margin-left: 10px;">
            <div id="linked-memory-selection" style="display: none; margin-top: 10px;">
                <label>ÈÄâÊã©Ë¶ÅÊåÇËΩΩËÆ∞ÂøÜÁöÑËÅäÂ§© (ÂèØÂ§öÈÄâ):</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                        <span class="arrow-down">‚ñº</span>
                    </div>
                    <div id="linked-chats-checkboxes-container" class="checkboxes-container" style="max-height: 120px;">
                    </div>
                </div>
                <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> ‚Ä¢ ÊåÇËΩΩÁöÑËÆ∞ÂøÜ‰ºö‰ª•‚ÄúÂèÇËÄÉËÆ∞ÂøÜ‚ÄùÁöÑÂΩ¢ÂºèÊèê‰æõÁªôAIÔºå‰∏ç‰ºöÁõ¥Êé•ÊòæÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢„ÄÇ<br> ‚Ä¢ Âª∫ËÆÆÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩ3-10ËΩÆËÆ∞ÂøÜÔºåÈÅøÂÖçÂΩ±ÂìçÂìçÂ∫îÈÄüÂ∫¶„ÄÇ </p>
            </div>
        </div>
        <div class="form-group" id="ai-original-name-group">
            <label for="ai-original-name-input">ÂØπÊñπÊú¨Âêç (AIËØÜÂà´Áî®)</label>
            <input type="text" id="ai-original-name-input">
        </div>
        <div class="form-group" id="ai-persona-group"><label for="ai-persona">ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div>
        <div class="form-group" id="ai-avatar-group"><label>ÂØπÊñπÂ§¥ÂÉè</label>
            <div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">‰∏ä‰º†ÂØπÊñπÂ§¥ÂÉè</button><button id="manage-ai-avatar-library-btn">ÁÆ°ÁêÜÂ§¥ÂÉèÂ∫ì</button><button class="change-frame-btn" data-type="ai">Êõ¥Êç¢Â§¥ÂÉèÊ°Ü</button>
                <input type="file" id="ai-avatar-input" accept="image/*">
            </div>
        </div>
        <!-- ‚ñº‚ñº‚ñº Êää‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥Âùó„Äë‰ª£Á†ÅÔºåÁ≤òË¥¥Âà∞ id="ai-avatar-group" ÁöÑÈÇ£‰∏™ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
<div class="form-group" id="video-call-settings-group">
    <hr style="opacity: 0.2; margin: 20px 0;">
    <label>ËßÜÈ¢ëÈÄöËØùÁïåÈù¢ËÆæÁΩÆ</label>
    
    <!-- 1. ÂäüËÉΩÂºÄÂÖ≥ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span>ÂêØÁî®ÂèØËßÜÂåñÁïåÈù¢</span>
        <label class="toggle-switch">
            <input type="checkbox" id="visual-video-call-switch">
            <span class="slider"></span>
        </label>
    </div>

    <!-- 2. ÂõæÁâá‰∏ä‰º†Âå∫ (ÈªòËÆ§ÈöêËóè) -->
    <div id="video-call-image-uploads" style="display: none;">
        <div class="form-group">
            <label>ÂØπÊñπÁöÑËßÜÈ¢ëÁîªÈù¢</label>
            <div class="avatar-upload">
                <img id="char-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('char-video-image-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                <input type="file" id="char-video-image-input" accept="image/*" hidden>
            </div>
        </div>
        <div class="form-group">
            <label>ÊàëÁöÑËßÜÈ¢ëÁîªÈù¢</label>
            <div class="avatar-upload">
                <img id="user-video-image-preview" style="border-radius: 8px; width: 80px; height: 142px;">
                <button onclick="document.getElementById('user-video-image-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                <input type="file" id="user-video-image-input" accept="image/*" hidden>
            </div>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <div class="form-group" id="my-persona-group"><label for="my-persona">ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div>
        <div class="form-group" id="switch-greeting-group" style="display: none;">
            <label>ÂàáÊç¢ÂºÄÂú∫ (‰ºöÊ∏ÖÁ©∫ÂΩìÂâçÂØπËØù)</label>
            <button id="switch-greeting-btn" class="form-button form-button-secondary" style="margin-top: 5px;">ÈÄâÊã©ÂÖ∂‰ªñÂºÄÂú∫ÊïÖ‰∫ã...</button>
        </div>
        <div class="form-group" id="my-avatar-group">
            <label>ÊàëÁöÑÂ§¥ÂÉè</label>
            <div class="avatar-upload">
                <img id="my-avatar-preview">
                <button onclick="document.getElementById('my-avatar-input').click()">‰∏ä‰º†ÊàëÁöÑÂ§¥ÂÉè</button>
                <button id="manage-my-avatar-library-btn">ÁÆ°ÁêÜÂ§¥ÂÉèÂ∫ì</button>
                <button class="change-frame-btn" data-type="my">Êõ¥Êç¢Â§¥ÂÉèÊ°Ü</button>
                <button id="open-persona-library-btn">È¢ÑËÆæ</button>
                <input type="file" id="my-avatar-input" accept="image/*">
            </div>
        </div>
        <div class="form-group" id="group-members-group"><label>Áæ§ÊàêÂëò‰∫∫ËÆæ</label>
            <div id="group-members-settings"></div>
            <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">ÁÆ°ÁêÜÁæ§ÊàêÂëò</button>
        </div>
        <div class="form-group">
            <label for="max-memory">Áü≠ÊúüËÆ∞ÂøÜÔºà‰∏ä‰∏ãÊñáÔºâÊù°Êï∞</label>
            <input type="number" id="max-memory" value="10">
        </div>
        <div class="form-group">
            <label for="linked-memory-count">ÊåÇËΩΩËÆ∞ÂøÜÊù°Êï∞</label>
            <input type="number" id="linked-memory-count" value="10">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px; line-height: 1.5;"> ‚Ä¢ ÊØèÊ¨°Ë∞ÉÁî®Êó∂Ôºå‰ªéÊØè‰∏™‚ÄúÊåÇËΩΩÁöÑËÅäÂ§©‚Äù‰∏≠ÊèêÂèñÊúÄÂêéÂá†Êù°ËÆ∞ÂΩï‰Ωú‰∏∫ÂèÇËÄÉËÆ∞ÂøÜ„ÄÇ <br> ‚Ä¢ Âª∫ËÆÆÂÄº 5-20„ÄÇÂÄºË∂äÂ§ßËÆ∞ÂøÜË∂äÂÖ®Ôºå‰ΩÜAPIË¥πÁî®Ë∂äÈ´ò„ÄÅÂìçÂ∫îË∂äÊÖ¢„ÄÇ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
            <label for="auto-memory-toggle" style="margin-bottom: 0;"> ÂêØÁî®Ëá™Âä®ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ÂºÄÂêØÂêéÔºåAI‰ºöÂú®ÂØπËØùËææÂà∞‰∏ÄÂÆöÈïøÂ∫¶Êó∂ÔºåËá™Âä®Â∞ÜÂÜÖÂÆπÊèêÁÇº‰∏∫ÈïøÊúüËÆ∞ÂøÜ„ÄÇ </p>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="auto-memory-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="form-group">
            <label for="auto-memory-interval">Ëá™Âä®ÊÄªÁªìÈó¥ÈöîÔºàÊ∂àÊÅØÊù°Êï∞Ôºâ</label>
            <input type="number" id="auto-memory-interval" min="10" value="20" style="width: 80px; text-align: center;">
            <p style="font-size: 12px; color: #8a8a8a; margin-top: 8px;"> Âª∫ËÆÆÂÄº 15-30„ÄÇÂÄºË∂äÂ∞èÔºåÊÄªÁªìË∂äÈ¢ëÁπÅÔºå‰ΩÜAPIË¥πÁî®‰πüË∂äÈ´ò„ÄÇ </p>
        </div>
        <hr style="opacity: 0.3; margin: 20px 0;">
        <div class="form-group">
            <label>ËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò <button id="reset-theme-btn" type="button">ÈáçÁΩÆ</button></label>
            <div class="theme-selector">
                <label><input type="radio" name="theme-select" value="default" id="theme-default"> ÈªòËÆ§</label>
                <label><input type="radio" name="theme-select" value="pink_blue"> Á≤âËìù</label>
                <label><input type="radio" name="theme-select" value="blue_white"> ËìùÁôΩ</label>
                <label><input type="radio" name="theme-select" value="purple_yellow"> Á¥´ÈªÑ</label>
                <label><input type="radio" name="theme-select" value="black_white"> ÈªëÁôΩ</label>
                <label><input type="radio" name="theme-select" value="yellow_white"> ÈªÑÁôΩ</label>
                <label><input type="radio" name="theme-select" value="red_black"> Á∫¢Èªë</label>
                <label><input type="radio" name="theme-select" value="blue_yellow"> ËìùÈªÑ</label>
                <label><input type="radio" name="theme-select" value="pink_yellow"> Á≤âÈªÑ</label>
                <label><input type="radio" name="theme-select" value="pink_purple"> Á≤âÁ¥´</label>
                <label><input type="radio" name="theme-select" value="gray_white"> ÁÅ∞ÁôΩ</label>
                <label><input type="radio" name="theme-select" value="blue_green"> ËìùÁªø</label>
                <label><input type="radio" name="theme-select" value="pink_white"> Á≤âÁôΩ</label>
                <label><input type="radio" name="theme-select" value="pink_black"> Á≤âÈªë</label>
                <label><input type="radio" name="theme-select" value="pink_green"> Á≤âÁªø</label>
                <label><input type="radio" name="theme-select" value="green_black"> ÁªøÈªë</label>
            </div>
        </div>
        <div class="form-group">
            <label for="font-size-slider">ËÅäÂ§©Â≠ó‰ΩìÂ§ßÂ∞è <span id="font-size-value">13px</span></label>
            <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
        </div>
        <div class="form-group">
            <label for="custom-css-input"> Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè (CSS) <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">ÈáçÁΩÆ</button>
            </label>
            <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 16px; resize: vertical;" placeholder="/* Á§∫‰æãÔºö‰∏∫‚ÄúÊàë‚ÄùÁöÑÊ∞îÊ≥°Ê∑ªÂä†Ê∏êÂèòËÉåÊôØÂíåÈò¥ÂΩ± */ .message-bubble.user .content { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 15px 4px 15px 15px; }"></textarea>
        </div>
        <div class="form-group">
            <label>ÂÆûÊó∂È¢ÑËßà</label>
            <div id="settings-preview-area"></div>
        </div>
        <div class="form-group">
            <label>ËÅäÂ§©ËÉåÊôØ</label>
            <div class="bg-upload-container">
                <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">‰∏ä‰º†ËÉåÊôØÂõæ</button>
                <button type="button" id="remove-bg-btn">ÁßªÈô§ËÉåÊôØ</button>
            </div>
            <img id="bg-preview" class="bg-preview-img">
            <input type="file" id="bg-input" accept="image/*" style="display: none;">
        </div>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
        <button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">ÊãâÈªëÂØπÊñπ</button>
        <button class="form-button form-button-secondary" id="clear-chat-btn">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <div id="persona-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span><button id="add-persona-preset-btn" class="action-button">Ê∑ªÂä†</button></div>
            <div class="modal-body">
                <div id="persona-library-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button></div>
        </div>
    </div>
    <div id="persona-editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span></div>
            <div class="modal-body">
                <div class="form-group"><label>È¢ÑËÆæÂ§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label><textarea id="preset-persona-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">ÂèñÊ∂à</button><button class="save" id="save-persona-preset-btn">‰øùÂ≠ò</button></div>
        </div>
    </div>
    <div id="member-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ÁºñËæëÁæ§ÊàêÂëò</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="member-name-input">ÂêçÂ≠ó</label><input type="text" id="member-name-input"></div>
                <div class="form-group"><label for="member-persona-input">‰∫∫ËÆæ</label><textarea id="member-persona-input" rows="4"></textarea></div>
                <div class="form-group"><label>Â§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><button class="change-frame-btn" data-type="member">Êõ¥Êç¢Â§¥ÂÉèÊ°Ü</button><input type="file" id="member-avatar-input" accept="image/*"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">ÂèñÊ∂à</button><button class="save" id="save-member-settings-btn">‰øùÂ≠ò</button></div>
        </div>
    </div>
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">ÂèñÊ∂à</button>
                <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ÁºñËæëÈ¢ÑËÆæ</button>
                <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="999999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                <input type="text" id="transfer-note" placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>
    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>
    <audio id="audio-player" style="display:none;"></audio>
<!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢ËøôÊÆµ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ id="create-post-modal" ÁöÑ div ‚ñº‚ñº‚ñº -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>ÂèëÂ∏ÉÂä®ÊÄÅ</span>
        </div>
        <div class="modal-body">
            <!-- ÂÖ¨ÂºÄÊñáÂ≠óËæìÂÖ•Âå∫ -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ"></textarea>
            </div>
            <!-- === Ê®°ÂºèÂàáÊç¢ÂºÄÂÖ≥ (Êñ∞Â¢û) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">‰∏ä‰º†ÂõæÁâá</button>
                <button id="switch-to-text-image-mode" class="mode-btn">‰ΩøÁî®ÊñáÂ≠óÂõæ</button>
            </div>
            <!-- ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂèØËßÅËåÉÂõ¥ËÆæÁΩÆ ‚ñº‚ñº‚ñº -->
            <div class="form-group">
                <label>ÂèØËßÅËåÉÂõ¥</label>
                <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
                    <label><input type="radio" name="visibility" value="public" checked> ÂÖ¨ÂºÄ</label>
                    <label><input type="radio" name="visibility" value="include"> ÊåáÂÆöÂàÜÁªÑÂèØËßÅ</label>
                </div>
                <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                    <!-- ÂàÜÁªÑÂ§öÈÄâÊ°ÜÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <!-- === ÂõæÁâáÊ®°ÂºèÂå∫Âüü === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
                    <div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="ÂõæÁâáÈ¢ÑËßà">
                        <button id="post-remove-image-btn">√ó</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">Êú¨Âú∞‰∏ä‰º†</button>
                        <button id="post-use-url-btn" class="form-button-secondary">ÁΩëÁªúURL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>ÂõæÁâáÊèèËø∞ (ÂøÖÂ°´ÔºåÁªôAIÁúã)</label>
                    <input type="text" id="post-image-description" placeholder="ÁÆÄÂçïÊèèËø∞ÂõæÁâáÂÜÖÂÆπÔºåÂ∏ÆÂä©AIÁêÜËß£">
                </div>
            </div>
            <!-- === ÊñáÂ≠óÂõæÊ®°ÂºèÂå∫Âüü (Êñ∞Â¢û) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>ÊñáÂ≠óÂõæ (ÁªôAIÁêÜËß£Áî®ÁöÑÊèèËø∞ÔºåÁÇπÂáªÂõæÁâáÂêéÂèØËßÅ)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="Âú®ËøôÈáåÂÜô‰∏ãÂõæÁâáÊèèËø∞..."></textarea>
                </div>
                <!-- ======================================================= -->
                <!-- ‚ñº‚ñº‚ñº „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë„Äë„ÄëËøôÂ∞±ÊòØ‰∏∫ÊÇ®Êñ∞Â¢ûÁöÑAIÈÖçÂõæÂºÄÂÖ≥ ‚ñº‚ñº‚ñº -->
                <!-- ======================================================= -->
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="post-use-ai-image-toggle" style="margin-bottom: 0;">
                        ‰ΩøÁî®AIÁîüÊàêÈÖçÂõæ
                        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                            ÂºÄÂêØÂêéÂ∞ÜÊ†πÊçÆ‰∏äÊñπÊèèËø∞ÁîüÊàêÂõæÁâáÔºåÂÖ≥Èó≠Âàô‰ΩøÁî®ÈªòËÆ§Âç†‰ΩçÂõæ„ÄÇ
                        </p>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="post-use-ai-image-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ „Äê„Äê„Äê‰øÆÊîπÁªìÊùü„Äë„Äë„Äë ‚ñ≤‚ñ≤‚ñ≤ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">ÂèñÊ∂à</button>
            <button class="save" id="confirm-create-post-btn">ÂèëÂ∏É</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÁöÑÊ®°ÊÄÅÊ°ÜHTMLÁ≤òË¥¥Âà∞ÊâÄÊúâÂÖ∂‰ªñÊ®°ÊÄÅÊ°Ü‰πãÂêé ‚ñº‚ñº‚ñº -->
    <div id="group-management-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ÁÆ°ÁêÜÂ•ΩÂèãÂàÜÁªÑ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Êñ∞Âª∫ÂàÜÁªÑ</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name-input" placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç..." style="flex-grow: 1;">
                        <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">Ê∑ªÂä†</button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- ÂàÜÁªÑÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-manager-btn" style="width: 100%;">ÂÆåÊàê</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞HTMLÁ≤òË¥¥Âà∞ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
    <div id="message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <!-- Êñ∞ÁöÑÊìç‰ΩúÊåâÈíÆ -->
                <button id="edit-message-btn">ÁºñËæëÊ∂àÊÅØ</button>
                <button id="copy-message-btn">Â§çÂà∂ÊñáÊú¨</button>
                <button id="recall-message-btn">Êí§Âõû</button>
                <button id="publish-to-announcement-btn" style="display: none;">ÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùø</button>
                <button id="quote-message-btn">ÂºïÁî®</button>
                <button id="select-message-btn">ËøõÂÖ•Â§öÈÄâ</button>
                <!-- ÂèñÊ∂àÊåâÈíÆ -->
                <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞HTMLÁ≤òË¥¥Âà∞ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
    <div id="post-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-post-btn">ÁºñËæëÂä®ÊÄÅ</button>
                <button id="copy-post-btn">Â§çÂà∂ÂÜÖÂÆπ</button>
                <button id="cancel-post-action-btn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèØËßÜÂåñÊ∂àÊÅØÁºñËæëÂô®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="message-editor-modal" class="modal">
        <div class="modal-content" style="height: 75%;">
            <div class="modal-header">
                <span>ÁºñËæë‰∏éÊãÜÂàÜÊ∂àÊÅØ</span>
            </div>
            <div class="modal-body" id="message-editor-body">
                <!-- ÁºñËæëÂô®ÂÆπÂô®ÔºåJS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊñáÊú¨Ê°Ü -->
                <div id="message-editor-container"></div>
                <!-- Ê∑ªÂä†Êñ∞Ê∂àÊÅØÁöÑÊåâÈíÆ -->
                <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] Ê∑ªÂä†‰∏ã‰∏ÄÊù°Ê∂àÊÅØ </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-advanced-editor-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-advanced-editor-btn">‰øùÂ≠òÊõ¥Êîπ</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÂØºÊºîÂâ™ËæëÂÆ§‚ÄùÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="ai-response-editor-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span>ÂØºÊºîÂâ™ËæëÂÆ§ (AI‰∏ä‰∏ÄËΩÆÂìçÂ∫î)</span>
            </div>
            <div class="modal-body" id="ai-response-editor-body">
                <!-- ÂØºÊºîÂâ™ËæëÂô®ÂÆπÂô®ÔºåJS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊñáÊú¨Ê°Ü -->
                <div id="ai-response-editor-container" style="display: flex; flex-direction: column; gap: 15px;"></div>
                <!-- Ê∑ªÂä†Êñ∞Ê∂àÊÅØÁöÑÊåâÈíÆ -->
                <button id="add-ai-response-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] Ê∑ªÂä†‰∏Ä‰∏™Êñ∞Âä®‰Ωú </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-ai-response-editor-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-ai-response-editor-btn">Â∫îÁî®‰øÆÊîπ</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <div id="repost-modal" class="modal">
        <div id="custom-modal" style="width: 280px;">
            <div class="custom-modal-header">ËΩ¨ÂèëÂä®ÊÄÅ</div>
            <div class="custom-modal-body">
                <textarea id="repost-comment-input" placeholder="ËØ∑ËæìÂÖ•ËΩ¨ÂèëËØÑËÆ∫ (ÂèØÈÄâ)" style="width: 100%; min-height: 60px; resize: vertical; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 16px; box-sizing: border-box;"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button id="repost-cancel-btn">ÂèñÊ∂à</button>
                <button id="repost-confirm-btn" class="confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÊ∂àÊÅØÊìç‰ΩúËèúÂçï ‚ñº‚ñº‚ñº -->
    <div id="call-message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-call-message-btn">ÁºñËæë</button>
                <button id="delete-call-message-btn" class="btn-danger">Âà†Èô§</button>
                <button id="cancel-call-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="waimai-request-modal" class="modal">
        <div class="modal-content" style="width: 290px;">
            <div class="modal-header">
                <span>ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="waimai-product-info">ÂïÜÂìÅ‰ø°ÊÅØ</label>
                    <input type="text" id="waimai-product-info" placeholder="‰æãÂ¶ÇÔºö‰∏ÄÊùØÊù®ÊûùÁîòÈú≤">
                </div>
                <div class="form-group">
                    <label for="waimai-amount">‰ª£‰ªòÈáëÈ¢ù (ÂÖÉ)</label>
                    <input type="number" id="waimai-amount" placeholder="‰æãÂ¶ÇÔºö21" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="waimai-cancel-btn">ÂèñÊ∂à</button>
                <button class="save" id="waimai-confirm-btn">ÂèëËµ∑ËØ∑Ê±Ç</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊñ∞Âª∫Á∫¶ÂÆö/ÂÄíËÆ°Êó∂Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="create-countdown-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>Êñ∞Âª∫Á∫¶ÂÆö</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="countdown-title-input">Á∫¶ÂÆöÊ†áÈ¢ò</label>
                    <input type="text" id="countdown-title-input" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁîüÊó•">
                </div>
                <div class="form-group">
                    <label for="countdown-date-input">Á∫¶ÂÆöÊó•Êúü‰∏éÊó∂Èó¥</label>
                    <input type="datetime-local" id="countdown-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-countdown-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-countdown-btn">‰øùÂ≠òÁ∫¶ÂÆö</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="red-packet-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂèëÁ∫¢ÂåÖ</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- 1. È°µÁ≠æÂàáÊç¢ -->
                <div class="frame-tabs">
                    <div id="rp-tab-group" class="frame-tab active">ÊãºÊâãÊ∞îÁ∫¢ÂåÖ</div>
                    <div id="rp-tab-direct" class="frame-tab">‰∏ìÂ±ûÁ∫¢ÂåÖ</div>
                </div>
                <!-- 2. ÊãºÊâãÊ∞îÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
                <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                    <div class="form-group">
                        <label>ÊÄªÈáëÈ¢ù (ÂÖÉ)</label>
                        <input type="number" id="rp-group-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Á∫¢ÂåÖ‰∏™Êï∞</label>
                        <input type="number" id="rp-group-count" placeholder="Â°´ÂÜôÁ∫¢ÂåÖ‰∏™Êï∞">
                    </div>
                    <div class="form-group">
                        <label>Á•ùÁ¶èËØ≠</label>
                        <input type="text" id="rp-group-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                    </div>
                    <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                    <button id="send-group-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>
                <!-- 3. ‰∏ìÂ±ûÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
                <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                    <div class="form-group">
                        <label>ÂèëÈÄÅÁªô</label>
                        <select id="rp-direct-receiver"></select>
                    </div>
                    <div class="form-group">
                        <label>ÈáëÈ¢ù (ÂÖÉ)</label>
                        <input type="number" id="rp-direct-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Á•ùÁ¶èËØ≠</label>
                        <input type="text" id="rp-direct-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                    </div>
                    <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                    <button id="send-direct-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="red-packet-details-modal" class="modal">
        <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
            <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
                <div style="text-align: center; width: 100%;">
                    <div id="rp-details-sender" style="font-size: 16px;"></div>
                    <div style="font-size: 13px; opacity: 0.8;">ÁöÑÁ∫¢ÂåÖ</div>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
                <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                    <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                    <span style="font-size: 18px; color: #E44D44;">ÂÖÉ</span>
                </div>
                <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
                <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    <!-- È¢ÜÂèñËØ¶ÊÉÖÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-rp-details-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫ÊäïÁ•®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="create-poll-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂèëËµ∑ÊäïÁ•®</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="poll-question-input">ÊäïÁ•®ÈóÆÈ¢ò</label>
                    <textarea id="poll-question-input" rows="2" placeholder="‰æãÂ¶ÇÔºö‰ªäÊôöÊàë‰ª¨Áúã‰ªÄ‰πàÁîµÂΩ±Ôºü"></textarea>
                </div>
                <div class="form-group">
                    <label>ÊäïÁ•®ÈÄâÈ°π (Ëá≥Â∞ë2È°π)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- ÊäïÁ•®ÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>
                    <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ Ê∑ªÂä†ÈÄâÈ°π</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-poll-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-poll-btn">ÂèëËµ∑ÊäïÁ•®</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="ai-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="ai-avatar-library-title">ÂØπÊñπÁöÑÂ§¥ÂÉèÂ∫ì</span>
                <div class="header-actions">
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞Ü‰∏Ä‰∏™ÊåâÈíÆÊãÜÂàÜ‰∏∫‰∏§‰∏™ -->
                    <button id="add-ai-avatar-batch-btn" class="action-button">ÊâπÈáè</button>
                    <button id="add-ai-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-ai-avatar-upload-btn" class="action-button">‰∏ä‰º†</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- Â§¥ÂÉèÂ∫ìÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="my-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="my-avatar-library-title">ÊàëÁöÑÂ§¥ÂÉèÂ∫ì</span>
                <div class="header-actions">
                    <button id="add-my-avatar-batch-btn" class="action-button">ÊâπÈáè</button>
                    <button id="add-my-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-my-avatar-upload-btn" class="action-button">‰∏ä‰º†</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                    <!-- ‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-my-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <div id="group-avatar-library-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†Áé∞ÊúâÁöÑ #group-avatar-library-modal .modal-header ‚ñº‚ñº‚ñº -->
            <div class="modal-header">
                <span id="group-avatar-library-title">Áæ§Â§¥ÂÉèÂ∫ì</span>
                <div class="header-actions">
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞Ü‰∏Ä‰∏™ÊåâÈíÆÊãÜÂàÜ‰∏∫‰∏§‰∏™ -->
                    <button id="add-group-avatar-batch-btn" class="action-button">ÊâπÈáè</button>
                    <button id="add-group-avatar-url-btn" class="action-button">URL</button>
                    <button id="add-group-avatar-upload-btn" class="action-button">‰∏ä‰º†</button>
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <div class="modal-body" style="padding: 15px;">
                <div id="group-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <div id="chat-list-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="chat-list-action-pin"></button> <button id="chat-list-action-delete" class="btn-danger">Âà†Èô§ËÅäÂ§©</button>
                <button id="chat-list-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®Êà∑ÂàÜ‰∫´ÈìæÊé•Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂàÜ‰∫´ÈìæÊé•</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="link-title-input">Ê†áÈ¢ò</label>
                    <input type="text" id="link-title-input" placeholder="ËæìÂÖ•ÊñáÁ´†ÊàñÈìæÊé•ÁöÑÊ†áÈ¢ò">
                </div>
                <div class="form-group">
                    <label for="link-description-input">ÊëòË¶Å (ÂèØÈÄâ)</label>
                    <textarea id="link-description-input" rows="2" placeholder="ÁÆÄÂçïÊèèËø∞‰∏Ä‰∏ãÈìæÊé•ÂÜÖÂÆπ"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">Êù•Ê∫êÂêçÁß∞ (ÂèØÈÄâ)</label>
                    <input type="text" id="link-source-input" placeholder="‰æãÂ¶ÇÔºöÁü•‰πéÊó•Êä•„ÄÅBÁ´ô">
                </div>
                <div class="form-group">
                    <label for="link-content-input">ÂÆåÊï¥ÂÜÖÂÆπ (ÂèØÈÄâÔºåÁî®‰∫éÊµèËßàÂô®ÂÜÖÊòæÁ§∫)</label>
                    <textarea id="link-content-input" rows="4" placeholder="Á≤òË¥¥ÊàñËæìÂÖ•ÂÆåÊï¥ÁöÑÊñáÁ´†ÂÜÖÂÆπ"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-link-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-share-link-btn">ÂàÜ‰∫´</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ≤æËá¥ÁâàËΩ¨Ë¥¶Êìç‰ΩúÂºπÁ™ó ‚ñº‚ñº‚ñº -->
    <div id="transfer-actions-modal" class="modal">
        <div class="transfer-actions-content">
            <div class="transfer-actions-header">ËØ∑ÈÄâÊã©Êìç‰Ωú</div>
            <div class="transfer-actions-body">
                <p>‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™ <strong id="transfer-sender-name"></strong> ÁöÑ‰∏ÄÁ¨îËΩ¨Ë¥¶„ÄÇ</p>
            </div>
            <div class="transfer-actions-footer">
                <button id="transfer-action-decline" class="action-btn decline">ÊÆãÂøçÊãíÁªù</button>
                <button id="transfer-action-accept" class="action-btn accept">ÂºÄÂøÉÊî∂‰∏ã</button>
            </div>
            <button id="transfer-action-cancel" class="cancel-btn">√ó</button>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄöËØùËÆ∞ÂΩïËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="call-transcript-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span id="transcript-modal-title">ÈÄöËØùËØ¶ÊÉÖ</span>
            </div>
            <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5;">
                <!-- ÈÄöËØùÊñáÂ≠óËÆ∞ÂΩïÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">Âà†Èô§ËÆ∞ÂΩï</button>
                <!-- „Äê„Äê„ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë„Äë„Äë -->
                <button class="save" id="manual-summarize-btn" style="background-color: #ffc107; border-color: #ffc107;">ÊâãÂä®ÊÄªÁªì</button>
                <button class="save" id="close-transcript-modal-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàÜ‰∫´ÁõÆÊ†áÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="share-target-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>ÂàÜ‰∫´Âà∞...</span>
            </div>
            <div class="modal-body" id="share-target-list" style="padding: 0;">
                <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-target-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-share-target-btn">Á°ÆËÆ§ÂàÜ‰∫´</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàÜ‰∫´ËÆ∞ÂΩïÊü•ÁúãÂô®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="shared-history-viewer-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span id="shared-history-viewer-title">ËÅäÂ§©ËÆ∞ÂΩï</span>
            </div>
            <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;">
                <!-- ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÊ∞îÊ≥°Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <div class="modal-footer">
                <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏ñÁïå‰π¶ÂàÜÁ±ªÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="world-book-category-manager-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ÁÆ°ÁêÜ‰∏ñÁïå‰π¶ÂàÜÁ±ª</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-category-name-input" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..." style="flex-grow: 1;">
                        <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">Ê∑ªÂä†</button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- ÂàÜÁ±ªÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-category-manager-btn" style="width: 100%;">ÂÆåÊàê</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <div id="announcement-board-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Áæ§ÂÖ¨ÂëäÊùø</span>
            </div>
            <div id="announcement-board-content">
            </div>
            <div class="modal-footer">
                <button class="save" id="close-announcement-board-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <div id="announcement-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="announcement-action-pin">ÁΩÆÈ°∂ÂÖ¨Âëä</button>
                <button id="announcement-action-delete" class="btn-danger">Âà†Èô§ÂÖ¨Âëä</button>
                <button id="announcement-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈïøÊúüËÆ∞ÂøÜÁÆ°ÁêÜÂÖ®Â±èÈ°µÈù¢ ‚ñº‚ñº‚ñº -->
    <div id="long-term-memory-screen" class="screen">
        <div class="header">
            <span class="back-btn" id="memory-screen-back-btn">‚Äπ</span>
            <span>ÈïøÊúüËÆ∞ÂøÜ</span>
            <div class="header-actions">
                <span class="action-btn" id="refine-memory-btn-header">Á≤æÁÇº</span>
                <span class="action-btn" id="summarize-recent-btn-header">ÊÄªÁªì</span>
                <span class="action-btn" id="add-manual-memory-btn-header">+</span>
            </div>
        </div>
        <div class="list-container" id="memory-list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5;">
            <!-- ÈïøÊúüËÆ∞ÂøÜÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <input type="file" id="ai-avatar-upload-input" accept="image/*" hidden>
    <input type="file" id="group-avatar-upload-input" accept="image/*" hidden>
    <script>
// ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥‰∏ãÈù¢ÁöÑÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, 'findLastIndex', {
    value: function(predicate) {
      if (this == null) {
        throw new TypeError('Cannot read property \'findLastIndex\' of null or undefined');
      }
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      let o = Object(this);
      let len = o.length >>> 0;
      let thisArg = arguments[1];
      let k = len - 1;
      while (k >= 0) {
        let kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return k;
        }
        k--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ... ÂÖ∂‰ªñÂÖ®Â±ÄÂèòÈáè
        let activeMessageTimestamp = null;
        let activeTransferTimestamp = null; // <-- Á°Æ‰øùËøôË°åÂú®ËøôÈáåÔºåÂπ∂‰∏îÂè™Êúâ‰∏ÄË°å
        // ‚ñº‚ñº‚ñº Âú®‰∏ãÊñπÁ≤òË¥¥Êñ∞ÂèòÈáè ‚ñº‚ñº‚ñº
        let lastRawAiResponse = ''; // Áî®‰∫éÂ≠òÂÇ®AI‰∏ä‰∏ÄËΩÆÁöÑÂéüÂßãÂìçÂ∫îÂ≠óÁ¨¶‰∏≤
        let lastResponseTimestamps = []; // Áî®‰∫éÂ≠òÂÇ®‰∏ä‰∏ÄËΩÆÂìçÂ∫îÁîüÊàêÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        let currentQzoneReplyContext = null;
        // ...
                const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
            // geminiÂ¶ÇÊûúÊòØÂ§ö‰∏™ÂØÜÈí•, ÈÇ£‰πàÈöèÊú∫Ëé∑Âèñ‰∏Ä‰∏™
            function getRandomValue(str) {
                // Ê£ÄÊü•Â≠óÁ¨¶‰∏≤ÊòØÂê¶ÂåÖÂê´ÈÄóÂè∑
                if (str.includes(',')) {
                    // Áî®ÈÄóÂè∑ÂàÜÈöîÂ≠óÁ¨¶‰∏≤Âπ∂ÁßªÈô§Â§ö‰ΩôÁ©∫Ê†º
                    const arr = str.split(',').map(item => item.trim());
                    // ÁîüÊàêÈöèÊú∫Á¥¢Âºï (0 Âà∞ arr.length-1)
                    const randomIndex = Math.floor(Math.random() * arr.length);
                    // ËøîÂõûÈöèÊú∫ÂÖÉÁ¥†
                    return arr[randomIndex];
                }
                // Ê≤°ÊúâÈÄóÂè∑ÂàôÁõ¥Êé•ËøîÂõûÂéüÂ≠óÁ¨¶‰∏≤
                return str;
            }
            function isImage(content) {
                if(content.image_url && content.image_url.url){
                    let currentImageData = content.image_url.url
                    // ÊèêÂèñBase64Êï∞ÊçÆÔºàÂéªÊéâÂâçÁºÄÔºâ
                    const base64Data = currentImageData.split(',')[1];
                    // Ê†πÊçÆÂõæÁâáÁ±ªÂûãËé∑ÂèñMIMEÁ±ªÂûã
                    const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
                    return [
                        {text: 'Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá'},
                        {
                            inline_data: {
                                mime_type: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }
                return []
            }
        
        
        /**
         * „ÄêV3.0 | ËØäÊñ≠Â¢ûÂº∫Áâà„Äë‰ªéGeminiÊàñÂÖºÂÆπOpenAIÁöÑAPIÂìçÂ∫î‰∏≠ÂÆâÂÖ®Âú∞ÊèêÂèñÊñáÊú¨ÂÜÖÂÆπ
         * @param {object} data - ‰ªé response.json() Ëß£ÊûêÂêéÁöÑÊï∞ÊçÆÂØπË±°
         * @returns {string} - ÊèêÂèñÂà∞ÁöÑÊñáÊú¨ÂÜÖÂÆπ
         * @throws {Error} - Â¶ÇÊûúÂìçÂ∫îÊ†ºÂºè‰∏çÊ≠£Á°ÆÊàñË¢´Â±èËîΩÔºåÂàôÊäõÂá∫‰∏Ä‰∏™Â∏¶ÊúâËØ¶ÁªÜÂéüÂõ†ÁöÑÈîôËØØ
         */
        function getGeminiResponseText(data) {
            // 1. Ê£ÄÊü•ÊòØÂê¶ÊòØÂÖºÂÆπOpenAIÁöÑÂìçÂ∫îÊ†ºÂºè
            if (data.choices && Array.isArray(data.choices) && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                return data.choices[0].message.content;
            }
        
            // 2. Ê£ÄÊü•ÊòØÂê¶ÊòØÊàêÂäüÁöÑ„ÄÅÊ†áÂáÜÁöÑÂéüÁîüGeminiÂìçÂ∫îÊ†ºÂºè
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            }
        
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉÂçáÁ∫ßÔºöÂÖ®Èù¢ÁöÑÈîôËØØËØäÊñ≠„Äë„Äë„Äë ---
            console.error("APIËøîÂõû‰∫ÜÈùûÈ¢ÑÊúüÁöÑÊ†ºÂºè:", data);
            let errorReason = "AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊú™Áü•Ê†ºÂºè„ÄÇ";
        
            // 3a. ËØäÊñ≠ÊòØÂê¶ÊòØÂõ†‰∏∫ÂÜÖÂÆπÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ (GeminiÂÆòÊñπAPIÊúÄÂ∏∏ËßÅÁöÑÈóÆÈ¢ò)
            // ËøôÁßçÊÉÖÂÜµdata.candidatesÊòØÂ≠òÂú®ÁöÑÔºå‰ΩÜÈáåÈù¢Ê≤°Êúâcontent
            if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
                const safetyRatings = data.candidates[0].safetyRatings;
                const blockedCategories = safetyRatings
                    .filter(r => r.probability !== 'NEGLIGIBLE' && r.probability !== 'LOW')
                    .map(r => `${r.category} (Ê¶ÇÁéá: ${r.probability})`)
                    .join(', ');
                errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ„ÄÇËß¶ÂèëÁ±ªÂà´: ${blockedCategories || 'Êú™Áü•'}`;
            }
            // 3b. ËØäÊñ≠Âè¶‰∏ÄÁßçÂÜÖÂÆπÂÆâÂÖ®Â±èËîΩÊ†ºÂºè (promptFeedback)
            else if (data.promptFeedback?.blockReason) {
                const reason = data.promptFeedback.blockReason;
                const details = data.promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ');
                errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ (ÂéüÂõ†: ${reason})„ÄÇËØ¶ÊÉÖ: ${details || 'Êó†'}`;
            } 
            // 3c. ËØäÊñ≠ÊòØÂê¶ÊòØÂÖ∂‰ªñÁ±ªÂûãÁöÑAPIÈîôËØØ
            else if (data.error) {
                errorReason = `APIÈîôËØØ: ${data.error.message}`;
            }
            
            // 4. ÊäõÂá∫‰∏Ä‰∏™Â∏¶ÊúâËØ¶ÁªÜ‰ø°ÊÅØÁöÑÈîôËØØ
            throw new Error(errorReason);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
// ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàËØÜÂõæ‰øÆÂ§çÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÂÖºÂÆπÊÄßÊõ¥Âº∫ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ toGeminiRequestData ‚ñº‚ñº‚ñº
function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision) {
    const roleType = {
        user: 'user',
        assistant: 'model',
        system: 'user'
    };

    // --- 1. Â∞Ü systemInstruction Ê®°ÊãüÊàêÁ¨¨‰∏ÄÊ¨°Áî®Êà∑ÂØπËØùÔºåÊûÅÂ§ßÊèêÈ´òÂÖºÂÆπÊÄß ---
    const contents = [
        {
            role: 'user',
            parts: [{ text: systemInstruction }]
        },
        {
            role: 'model',
            parts: [{ text: 'Â•ΩÁöÑÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇÊàë‰ºö‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåËÆæÂÆö„ÄÇ' }]
        },
        // --- 2. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊô∫ËÉΩÂú∞Â§ÑÁêÜÊØè‰∏ÄÊù°Ê∂àÊÅØÔºåÊûÑÂª∫Ê≠£Á°ÆÁöÑ parts Êï∞ÁªÑ ---
        ...messagesForDecision.map((item) => {
            const parts = [];
            // a. Â¶ÇÊûú content ÊòØ‰∏Ä‰∏™Êï∞ÁªÑÔºåËØ¥ÊòéÂèØËÉΩÊòØÂ§çÊùÇÊ∂àÊÅØÔºàÊñáÊú¨+ÂõæÁâáÔºâ
            if (Array.isArray(item.content)) {
                item.content.forEach(part => {
                    if (part.type === 'text') {
                        parts.push({ text: part.text });
                    } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {
                        // b. Ê≠£Á°ÆÂú∞‰ªé Base64 URL ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆÂíåÁ±ªÂûã
                        const currentImageData = part.image_url.url;
                        const base64Data = currentImageData.split(',')[1];
                        const mimeTypeMatch = currentImageData.match(/^data:(.*);base64/);
                        if (mimeTypeMatch && base64Data) {
                            parts.push({
                                inline_data: {
                                    mime_type: mimeTypeMatch[1],
                                    data: base64Data
                                }
                            });
                        }
                    }
                });
            } else {
                // c. Â¶ÇÊûú content ÊòØÊôÆÈÄöÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•‰Ωú‰∏∫ÊñáÊú¨Â§ÑÁêÜ
                parts.push({ text: String(item.content) });
            }
            return { role: roleType[item.role], parts: parts };
        })
    ];

    // --- 3. ËøîÂõûÊúÄÁªàÊûÑÂª∫Â•ΩÁöÑ„ÄÅÂÆåÂÖ®Á¨¶Âêà Gemini API ËßÑËåÉÁöÑËØ∑Ê±ÇÊï∞ÊçÆ ---
    return {
        url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
        data: {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: contents,
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 4000,
                },
            })
        }
    };
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            document.addEventListener('DOMContentLoaded', () => {
        
                // ===================================================================
                // 1. ÊâÄÊúâÂèòÈáèÂíåÂ∏∏ÈáèÂÆö‰πâ
                // ===================================================================
                const db = new Dexie('GeminiChatDB');
        const avatarFrames = [ { id: 'none', url: '', name: 'Êó†' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
              { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
            { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },
        
          { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
          
          
        { id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
        { id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
          { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
          { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
          
          ];
                // --- Â∑≤‰øÆÊ≠£ ---
               // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú® state ÂØπË±°‰∏≠ÂàùÂßãÂåñ cache Â±ûÊÄß
let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null, cache: { songs: new Map(), lyrics: new Map() } };
                // --- ‰øÆÊ≠£ÁªìÊùü ---
        
        let thoughtsHistoryRenderCount = 0;
        const THOUGHTS_RENDER_WINDOW = 15; // ÊØèÊ¨°Âä†ËΩΩ15Êù°ÂéÜÂè≤ËÆ∞ÂΩï
        // ‚ñº‚ñº‚ñº Âú®JSÈ°∂ÈÉ®ÔºåÂèòÈáèÂÆö‰πâÂå∫ÔºåÊ∑ªÂä†Ëøô‰∏™Êñ∞ÂèòÈáè ‚ñº‚ñº‚ñº
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Âä®ÊÄÅÂàÜÈ°µÂä†ËΩΩÊ∑ªÂä†ÁöÑÂèòÈáè ‚ñº‚ñº‚ñº
        let qzonePostsRenderCount = 0;
        const QZONE_RENDER_WINDOW = 10; // ÊØèÊ¨°Âä†ËΩΩ10Êù°Âä®ÊÄÅ
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        let qzonePostsCache = []; // Áî®‰∫éÁºìÂ≠òÂ∑≤Âä†ËΩΩÁöÑÂä®ÊÄÅÂ∏ñÂ≠êÊï∞ÊçÆ
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        let musicState = { 
            isActive: false, 
            activeChatId: null, 
            isPlaying: false, 
            playlist: [], 
            currentIndex: -1, 
            playMode: 'order', 
            totalElapsedTime: 0, 
            timerId: null,
            // „ÄêÊñ∞Â¢û„ÄëÊ≠åËØçÁõ∏ÂÖ≥Áä∂ÊÄÅ
            parsedLyrics: [],      // ÂΩìÂâçÊ≠åÊõ≤Ëß£ÊûêÂêéÁöÑÊ≠åËØçÊï∞ÁªÑ
            currentLyricIndex: -1  // ÂΩìÂâçÈ´ò‰∫ÆÁöÑÊ≠åËØçË°åÁ¥¢Âºï
        };
        let qzoneStickerPanelState = {
            isOpen: false,
            activePostId: null,
            panelEl: null,
            gridEl: null
        };
                const audioPlayer = document.getElementById('audio-player');
                let newWallpaperBase64 = null;
                let isSelectionMode = false;
                let selectedMessages = new Set();
                let editingMemberId = null;
                let editingWorldBookId = null;
               let editingRuleId = null; // Áî®‰∫éÂ≠òÂÇ®Ê≠£Âú®ÁºñËæëÁöÑËßÑÂàôID
                let editingPersonaPresetId = null;
                let currentReplyContext = null;
        let waimaiTimers = {}; // Áî®‰∫éÂ≠òÂÇ®Â§ñÂçñÂÄíËÆ°Êó∂
        
        let activeMessageTimestamp = null;
        // ‚ñº‚ñº‚ñº Âú®‰∏ãÊñπÁ≤òË¥¥Êñ∞ÂèòÈáè ‚ñº‚ñº‚ñº
        let shoppingCart = []; // Êï∞ÊçÆÁªìÊûÑÂ∞ÜÂèò‰∏∫ [{ productId: 123, quantity: 1 }, ...]
        let editingProductId = null; // Áî®‰∫éÂ≠òÂÇ®Ê≠£Âú®ÁºñËæëÁöÑÂïÜÂìÅID
        let activeProductId = null; // Áî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊü•ÁúãÁöÑÂïÜÂìÅID
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Âä®ÊÄÅËØÑËÆ∫Âå∫ÂõûÂ§çÂäüËÉΩÊ∑ªÂä†ÁöÑÁä∂ÊÄÅÂèòÈáè ‚ñº‚ñº‚ñº
        let currentQzoneReplyContext = null; // Áî®‰∫éÂ≠òÂÇ®ÂõûÂ§ç‰∏ä‰∏ãÊñá { postId, replyToName, replyToDisplayName }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        let activePostId = null; // <-- Êñ∞Â¢ûÔºöÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÂä®ÊÄÅID
        
                let photoViewerState = {
                    isOpen: false,
                    photos: [], // Â≠òÂÇ®ÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâáURL
                    currentIndex: -1, // ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑÁÖßÁâáÁ¥¢Âºï
                };
        
                let unreadPostsCount = 0;
        
                let isFavoritesSelectionMode = false;
                let selectedFavorites = new Set()
        
        let simulationIntervalId = null;
        
                const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
                const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
                const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
                const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
                let notificationTimeout;
// Âú®‰Ω†ÁöÑJSÈ°∂ÈÉ®ÂèòÈáèÂÆö‰πâÂå∫ÔºåÊ∑ªÂä†Ëøô‰∏™Êñ∞Â∏∏Èáè
const DEFAULT_NOTIFICATION_SOUND = 'https://www.myinstants.com/media/sounds/notification-sound-2.mp3'; // ÈªòËÆ§ÁöÑÂæÆ‰ø°ÊèêÁ§∫Èü≥
        // ‚ñº‚ñº‚ñº Âú®JSÈ°∂ÈÉ®ÔºåÂèòÈáèÂÆö‰πâÂå∫ÔºåÊ∑ªÂä†Ëøô‰∏™Êñ∞ÂèòÈáè ‚ñº‚ñº‚ñº
        let gomokuState = {}; // Áî®‰∫éÂ≠òÂÇ®ÊØè‰∏™ËÅäÂ§©ÁöÑ‰∫îÂ≠êÊ£ãÁä∂ÊÄÅ
        let originalChatMessagesPaddingTop = null; // Áî®‰∫éÂ≠òÂÇ®Ê∂àÊÅØÂå∫ÁöÑÂéüÂßãÈ°∂ÈÉ®ÂÜÖËæπË∑ù
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ DEFAULT_APP_ICONS Â∏∏Èáè ‚ñº‚ñº‚ñº
        const DEFAULT_APP_ICONS = {
            'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
            'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†Êñ∞ÁöÑ‰∏ÄË°å ‚ñº‚ñº‚ñº
            'renderer': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg',
            // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
            'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
            'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg'
        };
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        let repostTargetId = null; // Áî®‰∫éÂ≠òÂÇ®ÂΩìÂâçË¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID
                const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
                const MESSAGE_RENDER_WINDOW = 50;
                let currentRenderedCount = 0;
                let lastKnownBatteryLevel = 1;
                let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
                let batteryAlertTimeout;
                const dynamicFontStyle = document.createElement('style');
                dynamicFontStyle.id = 'dynamic-font-style';
                document.head.appendChild(dynamicFontStyle);
        
                const modalOverlay = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalConfirmBtn = document.getElementById('custom-modal-confirm');
                const modalCancelBtn = document.getElementById('custom-modal-cancel');
                let modalResolve;
        
                function showCustomModal() { 
                    modalOverlay.classList.add('visible'); 
                }
        
                function hideCustomModal() { 
                    modalOverlay.classList.remove('visible'); 
                    modalConfirmBtn.classList.remove('btn-danger'); 
                    if (modalResolve) modalResolve(null); 
                }
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ†πÊçÆ‰øùÂ≠òÁöÑËÆæÁΩÆÔºåÂ∫îÁî®Ê≠åËØçÊ†èÁöÑCSSÊ†∑Âºè
         * @param {object} chat - ÂΩìÂâçÁöÑËÅäÂ§©ÂØπË±°
         */
        function applyLyricsBarPosition(chat) {
            const lyricsBar = document.getElementById('global-lyrics-bar');
            // Â¶ÇÊûúËÅäÂ§©Ê≤°ÊúâËÆæÁΩÆÔºåÂàô‰ΩøÁî®ÈªòËÆ§ÂÄº
            const settings = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
            
            // ÈáçÁΩÆÊâÄÊúâÂèØËÉΩÂΩ±Âìç‰ΩçÁΩÆÁöÑÂ±ûÊÄß
            lyricsBar.style.top = 'auto';
            lyricsBar.style.bottom = 'auto';
            lyricsBar.style.left = 'auto';
            lyricsBar.style.right = 'auto';
            lyricsBar.style.transform = 'none';
        
            // 1. ËÆæÁΩÆÂûÇÁõ¥‰ΩçÁΩÆÂíåÂÅèÁßªÈáè
            if (settings.vertical === 'top') {
                lyricsBar.style.top = `${settings.offset}px`;
            } else { // 'bottom'
                lyricsBar.style.bottom = `${settings.offset}px`;
            }
            
            // 2. ËÆæÁΩÆÊ∞¥Âπ≥ÂØπÈΩê
            switch (settings.horizontal) {
                case 'left':
                    lyricsBar.style.left = '15px'; // ÁïôÂá∫‰∏Ä‰∫õËæπË∑ù
                    break;
                case 'right':
                    lyricsBar.style.right = '15px'; // ÁïôÂá∫‰∏Ä‰∫õËæπË∑ù
                    break;
                case 'center':
                default:
                    lyricsBar.style.left = '50%';
                    lyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
        }
        // ‚ñº‚ñº‚ñº ÊääËøô‰∏™„ÄêÂÖ®Êñ∞ÁöÑÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊú¨Âú∞‰∏ä‰º†Áæ§Â§¥ÂÉèÂπ∂Áî±ÂâØAPIËØÜÂà´ÁöÑÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑‰ªéÊú¨Âú∞‰∏ä‰º†Áæ§Â§¥ÂÉèÁöÑÊµÅÁ®ã
         * @param {Event} event - Êñá‰ª∂ËæìÂÖ•Ê°ÜÁöÑ change ‰∫ã‰ª∂ÂØπË±°
         */
        async function handleLocalGroupAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. ËØªÂèñÊñá‰ª∂‰∏∫ Base64
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. ÂºπÂá∫ÊèêÁ§∫ÔºåÂºÄÂßãËØÜÂõæ
            await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Áæ§Â§¥ÂÉèÂëΩÂêç...");
        
            try {
                // 3. Ë∞ÉÁî®ÈÄöÁî®ÁöÑAPIËØÜÂõæÂáΩÊï∞Ëé∑ÂèñÊèèËø∞
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
                }
        
                // 4. Â∞ÜÊèèËø∞‰Ωú‰∏∫ÂêçÂ≠óÔºåÂíåÂõæÁâáURL‰∏ÄËµ∑Â≠òÂÖ•Áæ§Â§¥ÂÉèÂ∫ì
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.groupAvatarLibrary) {
                    chat.settings.groupAvatarLibrary = [];
                }
                chat.settings.groupAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ‰øùÂ≠òÂπ∂Âà∑Êñ∞
                await db.chats.put(chat);
                renderGroupAvatarLibrary();
                await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Áæ§Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù`);
        
            } catch (error) {
                console.error("Êú¨Âú∞Áæ§Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
                await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
            } finally {
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÊ∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•Ê°Ü
                event.target.value = null;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞ÂäüËÉΩÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊú¨Âú∞‰∏ä‰º†Â§¥ÂÉèÂπ∂Áî±ÂâØAPIËØÜÂà´ÁöÑÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑‰ªéÊú¨Âú∞‰∏ä‰º†Â§¥ÂÉèÁöÑÊµÅÁ®ã
         * @param {Event} event - Êñá‰ª∂ËæìÂÖ•Ê°ÜÁöÑ change ‰∫ã‰ª∂ÂØπË±°
         */
        async function handleLocalAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            // 1. ËØªÂèñÊñá‰ª∂‰∏∫ Base64ÔºåËøôÊòØÂèëÈÄÅÁªôAPIÂíåÂ≠òÂÇ®ÁöÑÂøÖË¶ÅÊ†ºÂºè
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            // 2. ÂºπÂá∫ÊèêÁ§∫ÔºåÂºÄÂßãËØÜÂõæ
            await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Â§¥ÂÉèÂëΩÂêç...");
        
            try {
                // 3. Ë∞ÉÁî®APIËé∑ÂèñÂõæÁâáÊèèËø∞ÔºàËøô‰∏™ÊèèËø∞Â∞Ü‰Ωú‰∏∫Â§¥ÂÉèÁöÑÂêçÂ≠óÔºâ
                const description = await getAvatarDescriptionFromApi(base64Url);
                
                if (!description) {
                    throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
                }
        
                // 4. Â∞ÜÊèèËø∞‰Ωú‰∏∫ÂêçÂ≠óÔºåÂíåÂõæÁâáURL‰∏ÄËµ∑Â≠òÂÖ•Â§¥ÂÉèÂ∫ì
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.aiAvatarLibrary) {
                    chat.settings.aiAvatarLibrary = [];
                }
                chat.settings.aiAvatarLibrary.push({ name: description, url: base64Url });
                
                // 5. ‰øùÂ≠òÂπ∂Âà∑Êñ∞
                await db.chats.put(chat);
                renderAiAvatarLibrary();
                await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù`);
        
            } catch (error) {
                console.error("Êú¨Âú∞Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
                await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
            } finally {
                // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÈÉΩÊ∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•Ê°ÜÔºå‰ª•‰æø‰∏ãÊ¨°ËÉΩÈÄâÊã©Âêå‰∏Ä‰∏™Êñá‰ª∂
                event.target.value = null;
            }
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëË∞ÉÁî®ÔºàÂâØÔºâAPIÊù•Ëé∑ÂèñÂõæÁâáÁöÑÊèèËø∞
         * @param {string} base64Url - ÂõæÁâáÁöÑ Base64 Data URL
         * @returns {Promise<string>} - ËøîÂõûAIÁîüÊàêÁöÑÂõæÁâáÊèèËø∞
         */
        async function getAvatarDescriptionFromApi(base64Url) {
            // Êô∫ËÉΩÈÄâÊã©APIÔºö‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÂ¶ÇÊûúÊú™ÈÖçÁΩÆÂàôËá™Âä®ÂõûÈÄÄÂà∞‰∏ªAPI
            const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
            const { proxyUrl, apiKey, model } = useSecondaryApi 
                ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
                : state.apiConfig;
        
            if (!proxyUrl || !apiKey || !model) {
                throw new Error("‰∏ªAPIÂíåÂâØAPIÂùáÊú™ÈÖçÁΩÆÊàñÈÖçÁΩÆ‰∏çÂÆåÊï¥„ÄÇ");
            }
        
            const prompt = "ËØ∑‰∏∫ËøôÂº†ÂõæÁâáËµ∑‰∏Ä‰∏™ÁÆÄÊ¥ÅÁöÑ„ÄÅÈÄÇÂêà‰Ωú‰∏∫Â§¥ÂÉèÂ∫ìÊ†áÁ≠æÁöÑÂêçÂ≠ó„ÄÇ‰æãÂ¶ÇÔºö‚ÄúÂæÆÁ¨ëËá™Êãç‚Äù„ÄÅ‚ÄúÈò≥ÂÖâ‰∏ãÁöÑÁå´Âí™‚Äù„ÄÅ‚ÄúËìùÂèëÂä®Êº´Â∞ëÂ•≥‚Äù„ÄÇËØ∑Áõ¥Êé•ÂõûÁ≠îÂêçÂ≠óÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑËß£Èáä„ÄÇ";
            
            let isGemini = proxyUrl.includes('generativelanguage');
            let response;
        
            if (isGemini) {
                const mimeType = base64Url.match(/^data:(.*);base64/)[1];
                const base64Data = base64Url.split(',')[1];
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }]
                };
                response = await fetch(`${proxyUrl}/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
        
            } else { // OpenAI ÂÖºÂÆπ Vision API
                const payload = {
                    model: model,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: base64Url } }
                        ]
                    }],
                    max_tokens: 50 // ÈôêÂà∂ËæìÂá∫ÈïøÂ∫¶
                };
                response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify(payload)
                });
            }
        
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
            }
        
            const data = await response.json();
            let description = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
            
            // Ê∏ÖÁêÜAIÂèØËÉΩËøîÂõûÁöÑÂ§ö‰ΩôÂ≠óÁ¨¶
            return description.trim().replace(/["'‚Äú‚Äù‚Äò‚Äô]/g, '');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞ÂäüËÉΩÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂΩìÂçïËÅäËßíËâ≤ÁöÑÂêçÁß∞Ë¢´‰øÆÊîπÂêéÔºåËá™Âä®ÂêåÊ≠•ÂÖ∂Âú®ÊâÄÊúâÁæ§ËÅä‰∏≠ÁöÑ‰ø°ÊÅØ
         * @param {object} characterChat - Ë¢´‰øÆÊîπ‰∫ÜÂêçÁß∞ÁöÑ„ÄêÂçïËÅä„ÄëchatÂØπË±°
         */
        async function syncCharacterNameInGroups(characterChat) {
            // 1. ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù‰º†ÂÖ•ÁöÑÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂçïËÅäÂØπË±°
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterNameInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
                return;
            }
        
            const characterId = characterChat.id;
            const newRemarkName = characterChat.name;        // ËøôÊòØËßíËâ≤Êñ∞ÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë
            const newOriginalName = characterChat.originalName;  // ËøôÊòØËßíËâ≤Êñ∞ÁöÑ„ÄêÊú¨Âêç„Äë
        
            console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂêçÁß∞‰ø°ÊÅØ...`);
        
            // 2. ÈÅçÂéÜÂÜÖÂ≠ò‰∏≠ÊâÄÊúâÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÊâæÂá∫ÊâÄÊúâÁæ§ËÅä
            for (const chatId in state.chats) {
                const groupChat = state.chats[chatId];
                
                // 3. Á≠õÈÄâÂá∫Áæ§ËÅäÔºåÂπ∂Á°Æ‰øùÂÆÉÊúâÊàêÂëòÂàóË°®
                if (groupChat.isGroup && groupChat.members) {
                    // 4. Âú®Áæ§ËÅä‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÊàêÂëò
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                    // Â¶ÇÊûúÂú®Ëøô‰∏™Áæ§ÈáåÊâæÂà∞‰∫ÜËØ•ÊàêÂëò
                    if (memberToUpdate) {
                        let needsDbUpdate = false; // Ê†áËÆ∞ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÔºå‰ª•‰ºòÂåñÊÄßËÉΩ
                        
                        // 5. ÂØπÊØîÂπ∂Êõ¥Êñ∞Áæ§ÂÜÖÊòµÁß∞ (groupNickname)ÔºåÂÆÉÂ∫îËØ•‰∏éÂçïËÅäÁöÑÂ§áÊ≥®Âêç(name)‰øùÊåÅ‰∏ÄËá¥
                        if (memberToUpdate.groupNickname !== newRemarkName) {
                            memberToUpdate.groupNickname = newRemarkName;
                            needsDbUpdate = true;
                        }
        
                        // 6. ÂØπÊØîÂπ∂Êõ¥Êñ∞Áæ§ÂÜÖÁöÑÊú¨Âêç (originalName)
                        if (memberToUpdate.originalName !== newOriginalName) {
                            memberToUpdate.originalName = newOriginalName;
                            needsDbUpdate = true;
                        }
        
                        // 7. Â¶ÇÊûúÊúâ‰ªª‰ΩïÊõ¥Êñ∞ÔºåÂ∞±ÊääËøô‰∏™„ÄêÊï¥‰∏™Áæ§ËÅäÂØπË±°„Äë‰πü‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ì
                        if (needsDbUpdate) {
                            await db.chats.put(groupChat);
                            console.log(`ÊàêÂäüÂ∞ÜÁæ§ËÅä "${groupChat.name}" ‰∏≠ÁöÑÊàêÂëò‰ø°ÊÅØÊõ¥Êñ∞`);
                        }
                    }
                }
            }
        }
        
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞Á≤òË¥¥Âà∞ syncCharacterNameInGroups ÁöÑ‰∏ãÊñπ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂΩìÂçïËÅäËßíËâ≤ÁöÑÂ§¥ÂÉèË¢´‰øÆÊîπÂêéÔºåËá™Âä®ÂêåÊ≠•ÂÖ∂Âú®ÊâÄÊúâÁæ§ËÅä‰∏≠ÁöÑÂ§¥ÂÉè‰ø°ÊÅØ
         * @param {object} characterChat - Ë¢´‰øÆÊîπ‰∫ÜÂ§¥ÂÉèÁöÑ„ÄêÂçïËÅä„ÄëchatÂØπË±°
         */
        async function syncCharacterAvatarInGroups(characterChat) {
            // 1. ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°
            if (!characterChat || characterChat.isGroup) {
                console.warn("syncCharacterAvatarInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
                return;
            }
        
            const characterId = characterChat.id;
            const newAvatar = characterChat.settings.aiAvatar; // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ§¥ÂÉèURL
        
            console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂ§¥ÂÉè...`);
        
            // 2. ÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÊâæÂá∫ÊâÄÊúâÁæ§ËÅä
            for (const groupChat of Object.values(state.chats)) {
                if (groupChat.isGroup && groupChat.members) {
                    // 3. Âú®Áæ§ËÅä‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÊàêÂëò
                    const memberToUpdate = groupChat.members.find(m => m.id === characterId);
                    
                    // 4. Â¶ÇÊûúÊâæÂà∞‰∫ÜËØ•ÊàêÂëòÔºåÂπ∂‰∏îÂ§¥ÂÉè‰ø°ÊÅØ‰∏ç‰∏ÄËá¥ÔºåÂ∞±Êõ¥Êñ∞ÂÆÉ
                    if (memberToUpdate && memberToUpdate.avatar !== newAvatar) {
                        memberToUpdate.avatar = newAvatar; // Â∞ÜÊñ∞Â§¥ÂÉèÂêåÊ≠•Âà∞Áæ§ÊàêÂëòÊï∞ÊçÆ‰∏≠
                        
                        // 5. „ÄêËá≥ÂÖ≥ÈáçË¶Å„ÄëÂ∞Ü‰øÆÊîπÂêéÁöÑ„ÄêÊï¥‰∏™Áæ§ËÅäÂØπË±°„ÄëÂ≠òÂõûÊï∞ÊçÆÂ∫ì
                        await db.chats.put(groupChat);
                        console.log(`ÊàêÂäüÂ∞ÜËßíËâ≤ ${characterId} ÁöÑÊñ∞Â§¥ÂÉèÂêåÊ≠•Âà∞Áæ§ËÅä "${groupChat.name}"`);
                    }
                }
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÊõ¥Êô∫ËÉΩÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ getDisplayNameInGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞ | Â∑≤‰øÆÂ§çÁî®Êà∑ËØÜÂà´ÈóÆÈ¢ò„ÄëÊ†πÊçÆËßíËâ≤Êú¨ÂêçÔºåÂú®ÊåáÂÆöÁæ§ËÅä‰∏≠Ëé∑ÂèñÂÖ∂Ê≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞ÔºàÁæ§ÊòµÁß∞Ôºâ
         * @param {object} groupChat - ÂΩìÂâçÁöÑÁæ§ËÅäÂØπË±°
         * @param {string} originalName - ËßíËâ≤ÁöÑÊú¨Âêç (e.g., "Â∞èÂèØÁà±", "Êñπ‰∫¶Ê•∑")
         * @returns {string} - ËØ•ËßíËâ≤Âú®Ê≠§Áæ§ËÅä‰∏≠ÁöÑÁæ§ÊòµÁß∞ÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂàôËøîÂõûÂÖ∂Êú¨Âêç
         */
        function getDisplayNameInGroup(groupChat, originalName) {
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÂ¶ÇÊûú‰ø°ÊÅØ‰∏çÂÖ®ÂàôÁõ¥Êé•ËøîÂõû
            if (!groupChat || !groupChat.isGroup || !originalName) {
                return originalName;
            }
        
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë„Äë„Äë ---
        
            // Ê≠•È™§1Ôºö‰ºòÂÖàÊ£ÄÊü•Ëøô‰∏™‚ÄúÊú¨Âêç‚ÄùÊòØ‰∏çÊòØ„ÄêÁî®Êà∑Ëá™Â∑±„ÄëÁöÑÂÖ®Â±ÄÊú¨Âêç
            // Áî®Êà∑ÁöÑÂÖ®Â±ÄÊú¨ÂêçÂ≠òÂÇ®Âú® qzoneSettings.nickname ‰∏≠
            const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
            if (originalName === userOriginalName) {
                // Â¶ÇÊûúÊòØÁî®Êà∑ÔºåÂ∞±ËøîÂõûÁî®Êà∑Âú®„ÄêËøô‰∏™Áæ§ËÅä‰∏≠„ÄëÁöÑ‰∏ìÂ±ûÊòµÁß∞
                return groupChat.settings.myNickname || 'Êàë';
            }
        
            // Ê≠•È™§2ÔºöÂ¶ÇÊûú‰∏çÊòØÁî®Êà∑ÔºåÂÜçÂà∞Áæ§ÊàêÂëòÂàóË°®ÈáåÂéªÊü•ÊâæÂØπÂ∫îÁöÑAIËßíËâ≤
            const member = groupChat.members.find(m => m.originalName === originalName);
            
            // Ê≠•È™§3ÔºöÂ¶ÇÊûúÊâæÂà∞‰∫ÜAIÊàêÂëòÔºåÂ∞±ËøîÂõûTAÁöÑÁæ§ÊòµÁß∞ÔºõÂ¶ÇÊûúÈÉΩÊâæ‰∏çÂà∞ÔºåÂ∞±ËøîÂõûÂéüÂßãÂêçÂ≠ó‰Ωú‰∏∫‰øùÂ∫ï
            return member ? member.groupNickname : originalName;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº

/**
 * „ÄêÂÖ®Êñ∞ | Áªü‰∏ÄÂÖ•Âè£„ÄëÂ§ÑÁêÜNPCËá™Âä®ËØÑËÆ∫ÁöÑÊ†∏ÂøÉÈÄªËæë
 * @param {object} authorChar - Âä®ÊÄÅÁöÑÂèëÂ∏ÉËÄÖÔºàNPCÁöÑ‰∏ª‰∫∫Ôºâ
 * @param {object} post - ÂàöÂàöË¢´‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÁöÑÂä®ÊÄÅÂØπË±° (ÂøÖÈ°ªÂåÖÂê´ID)
 */
async function handleNpcCommenting(authorChar, post) {
    // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùËßíËâ≤Â≠òÂú®„ÄÅ‰∏çÊòØÁæ§ËÅä„ÄÅÂπ∂‰∏îÊúâNPC
    if (authorChar && !authorChar.isGroup && authorChar.npcs && authorChar.npcs.length > 0) {
        console.log(`Ê£ÄÊµãÂà∞ËßíËâ≤ "${authorChar.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅÔºåÊ≠£Âú®‰∏∫ÂÖ∂ ${authorChar.npcs.length} ‰∏™NPCÁîüÊàêËØÑËÆ∫...`);
        
        // Ë∞ÉÁî®Êàë‰ª¨‰πãÂâçÂàõÂª∫ÁöÑ‚ÄúËØÑËÆ∫ÂØºÊºî‚ÄùÂáΩÊï∞ÔºåÂπ∂ËÆ©ÂÆÉÂú®ÂêéÂè∞ÊâßË°å
        // ËøôÊ†∑‰∏ç‰ºöÈòªÂ°ûUIÁöÑÂà∑Êñ∞
        generateAllNpcCommentsInOneCall(authorChar, post).then(() => {
            // ÂΩìÊâÄÊúâNPCËØÑËÆ∫ÈÉΩÁîüÊàêÂπ∂‰øùÂ≠òÂêéÔºåÂ¶ÇÊûúÁî®Êà∑Ê≠£Âú®ÁúãÂä®ÊÄÅÈ°µÔºåÂ∞±Âà∑Êñ∞ÈÇ£‰∏ÄÊù°Âä®ÊÄÅ
            if (document.getElementById('qzone-screen').classList.contains('active')) {
                 updateSinglePostInDOM(post.id);
            }
        });
    }
}

// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº

/**
 * „ÄêÂÖ®Êñ∞ | È´òÊïàÁâà„ÄëÂú®‰∏ÄÊ¨°APIË∞ÉÁî®‰∏≠Ôºå‰∏∫ÊâÄÊúâNPCÁîüÊàêÈíàÂØπÁâπÂÆöÂä®ÊÄÅÁöÑËØÑËÆ∫
 * @param {object} ownerChar - Âä®ÊÄÅÁöÑÂèëÂ∏ÉËÄÖÔºàNPCÁöÑ‰∏ª‰∫∫Ôºâ
 * @param {object} post - ÂàöÂàöÂèëÂ∏ÉÁöÑÂä®ÊÄÅÂØπË±°
 */
async function generateAllNpcCommentsInOneCall(ownerChar, post) {
    // 1. ÂÆâÂÖ®Ê£ÄÊü•
    if (!ownerChar || !post || !ownerChar.npcs || ownerChar.npcs.length === 0) {
        return;
    }

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        console.error("APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ï‰∏∫NPCÁîüÊàêËØÑËÆ∫„ÄÇ");
        return;
    }

    // 2. ÂáÜÂ§áÊåá‰ª§ÂÜÖÂÆπ
    let postContentSummary = (post.publicText || post.content || post.imageDescription || post.hiddenContent || "").substring(0, 150);
    const npcsListForPrompt = ownerChar.npcs.map(npc => `- **${npc.name}**: ${npc.persona}`).join('\n');

    // --- „Äê„Äê„ÄêÊ†∏ÂøÉÊñ∞Â¢ûÔºö‰∏∫NPCÂä†ËΩΩ‰∏ñÁïå‰π¶„Äë„Äë„Äë ---
    let worldBookContentForNpcs = '';
    // Ê£ÄÊü•‰∏ª‰∫∫ÊòØÂê¶ÂÖ≥ËÅî‰∫Ü‰∏ñÁïå‰π¶
    if (ownerChar.settings.linkedWorldBookIds && ownerChar.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = ownerChar.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            if (!worldBook || !Array.isArray(worldBook.content)) return '';

            // Ê†ºÂºèÂåñ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
            const formattedEntries = worldBook.content
                .filter(entry => entry.enabled !== false)
                .map(entry => `\n- ${entry.content}`)
                .join('');

            return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶„Ää${worldBook.name}„Äã‰∏≠ÁöÑËÆæÂÆö:\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        
        if (linkedContents) {
            worldBookContentForNpcs = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (‰Ω†Âíå‰Ω†‰∏ª‰∫∫ÁöÑÂÖ±ÂêåËÉåÊôØÁü•ËØÜÔºåÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${linkedContents}\n`;
        }
    }
    // --- „Äê„Äê„ÄêÊñ∞Â¢ûÁªìÊùü„Äë„Äë„Äë ---


    // 3. „ÄêÊ†∏ÂøÉ„ÄëÊûÑÂª∫‰∏Ä‰∏™Âº∫Â§ßÁöÑ„ÄÅÁ±ª‰ººÁæ§ËÅäÁöÑ‚ÄúËØÑËÆ∫Âå∫ÂØºÊºî‚ÄùÊåá‰ª§
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™‚ÄúËØÑËÆ∫Âå∫ÂØºÊºî‚Äù„ÄÇ‰Ω†ÁöÑ‰∏ª‰∫∫‚Äú${ownerChar.name}‚ÄùÁöÑÂä®ÊÄÅ‰∏ãÂàöÂàöÊúâ‰∫Ü‰∏Ä‰∫õÊñ∞ËØÑËÆ∫„ÄÇ‰Ω†ÈúÄË¶ÅÊâÆÊºîTAÊâã‰∏ãÁöÑÊâÄÊúâNPCÔºåÂπ∂Ê†πÊçÆÊØè‰∏™NPCÁöÑÊÄßÊ†ºËÆæÂÆöÔºåÂØπ„ÄêÊï¥‰∏™ËØÑËÆ∫Âå∫„ÄëÁöÑÁé∞Áä∂ÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂèçÂ∫î„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„Äê‰∫íÂä®ÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑ‰∫íÂä®ÁõÆÊ†áÊòØ„ÄêÊï¥‰∏™ËØÑËÆ∫Âå∫„ÄëÔºåËÄå‰∏çÂè™ÊòØ‰∏ªÊ•ºÔºÅ‰Ω†ÂèØ‰ª•Ôºö
    - ÂõûÂ§ç‰∏ª‰∫∫Ôºà${ownerChar.name}ÔºâÁöÑÂä®ÊÄÅ„ÄÇ
    - ÂõûÂ§çÁî®Êà∑Ôºà${state.qzoneSettings.nickname}ÔºâÁöÑËØÑËÆ∫„ÄÇ
    - ÂõûÂ§çÂÖ∂‰ªñNPCÁöÑËØÑËÆ∫„ÄÇ
    - ‰∫íÁõ∏ÁÇπËµû„ÄÇ
2.  **„Äê„Äê„ÄêË°å‰∏∫Â§öÊ†∑ÊÄß„Äë„Äë**: NPC‰∏ç‰∏ÄÂÆöÈÉΩË¶ÅÂèëÊñáÂ≠óËØÑËÆ∫„ÄÇÊ†πÊçÆ‰ªñ‰ª¨ÁöÑÊÄßÊ†ºÔºåÊúâ‰∫õ‰∫∫ÂèØËÉΩÂè™‰ºö„ÄêÁÇπËµû„ÄëÔºåÊúâ‰∫õ‰∫∫ÂèØËÉΩÂè™‰ºöÂèë‰∏Ä‰∏™„ÄêË°®ÊÉÖÂåÖ„Äë„ÄÇ
3.  **„Äê„Äê„ÄêËæìÂá∫Ê†ºÂºè„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇÊØè‰∏™ÂÖÉÁ¥†‰ª£Ë°®‰∏Ä‰∏™NPCÁöÑË°åÂä®„ÄÇ
4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÊö¥Èú≤‰Ω†ÊòØNPCÊàñAI„ÄÇ

# ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑË°åÂä®Êåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **ÊñáÂ≠óËØÑËÆ∫**: \`{"type": "comment", "name": "NPCÁöÑÂêçÂ≠ó", "commentText": "ËØÑËÆ∫ÂÜÖÂÆπ"}\`
-   **Ë°®ÊÉÖËØÑËÆ∫**: \`{"type": "comment", "name": "NPCÁöÑÂêçÂ≠ó", "stickerUrl": "https://...", "stickerMeaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
-   **ÂõûÂ§çËØÑËÆ∫**: \`{"type": "comment", "name": "NPCÁöÑÂêçÂ≠ó", "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑÂêçÂ≠ó(ÂèØ‰ª•ÊòØ‰∏ª‰∫∫„ÄÅÁî®Êà∑ÊàñÂÖ∂‰ªñNPC)", "commentText": "ÂõûÂ§çÁöÑÂÜÖÂÆπ"}\`
-   **ÁÇπËµûÂä®ÊÄÅ**: \`{"type": "like", "name": "NPCÁöÑÂêçÂ≠ó"}\`
${worldBookContentForNpcs}

# ‰Ω†ÁöÑNPCËßíËâ≤ÂàóË°®Âíå‰∫∫ËÆæ
${npcsListForPrompt}

# ‰Ω†ÁöÑ‰∏ª‰∫∫
- **ÂßìÂêç**: ${ownerChar.name}
- **Ë∫´‰ªΩ**: Âä®ÊÄÅÁöÑÂèëÂ∏ÉËÄÖ

# Áî®Êà∑
- **ÂßìÂêç**: ${state.qzoneSettings.nickname}
- **Ë∫´‰ªΩ**: ÂèÇ‰∏éËØÑËÆ∫ÁöÑËÆøÂÆ¢

# ‰Ω†ÁöÑ‰∏ª‰∫∫ÂèëÂ∏ÉÁöÑÂä®ÊÄÅÂÜÖÂÆπ
"${postContentSummary}"

# ÂΩìÂâçÂÆåÊï¥ÁöÑËØÑËÆ∫Âå∫ (ËøôÊòØ‰Ω†ÂÜ≥Á≠ñÁöÑÊúÄÈáçË¶Å‰æùÊçÆÔºÅ)
${post.comments && post.comments.length > 0 ? post.comments.map(c => `- **${c.commenterName}**: ${c.text}`).join('\n') : '(ÊöÇÊó†ËØÑËÆ∫)'}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÂØºÊºîÂ∑•‰ΩúÔºåÁîüÊàê‰∏Ä‰∏™ÁîüÂä®ÁöÑ„ÄÅÂåÖÂê´‰∫íÂä®ÁöÑËØÑËÆ∫Âå∫JSONÊï∞ÁªÑ„ÄÇ
`;

    try {
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "ËØ∑ÂºÄÂßãÁîüÊàêËØÑËÆ∫Âå∫ÂÜÖÂÆπ„ÄÇ" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "ËØ∑ÂºÄÂßãÁîüÊàêËØÑËÆ∫Âå∫ÂÜÖÂÆπ„ÄÇ"}],
                    temperature: 0.95, // ÊèêÈ´ò‰∏ÄÁÇπÊ∏©Â∫¶ÔºåËÆ©ËØÑËÆ∫Êõ¥Â§öÊ†∑Âåñ
                })
            });

        if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const commentActions = parseAiResponse(aiResponseContent); // Â§çÁî®Êàë‰ª¨Âº∫Â§ßÁöÑËß£ÊûêÂáΩÊï∞

        // 4. Â§ÑÁêÜËøîÂõûÁöÑÊåá‰ª§Êï∞ÁªÑ
        if (Array.isArray(commentActions) && commentActions.length > 0) {
            // ‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑpostÂØπË±°ÔºåÈò≤Ê≠¢Âπ∂ÂèëÂÜ≤Á™Å
            const currentPost = await db.qzonePosts.get(post.id);
            if (!currentPost.comments) currentPost.comments = [];

// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ forEach Âæ™ÁéØ ‚ñº‚ñº‚ñº
commentActions.forEach(action => {
    if (!action.type || !action.name) return; // Ë∑≥ËøáÊó†ÊïàÊåá‰ª§

    // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁÇπËµûÊåá‰ª§
    if (action.type === 'like') {
        if (!currentPost.likes) currentPost.likes = [];
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁÇπËµûÔºåÈÅøÂÖçÈáçÂ§ç
        if (!currentPost.likes.includes(action.name)) {
            currentPost.likes.push(action.name);
        }
    } 
    // Â§ÑÁêÜËØÑËÆ∫Êåá‰ª§ (ÈÄªËæë‰∏çÂèò)
    else if (action.type === 'comment') {
        currentPost.comments.push({
            commenterName: action.name,
            text: action.commentText || action.stickerUrl,
            meaning: action.stickerMeaning || null,
            timestamp: Date.now() + Math.random(),
            replyTo: action.replyTo || null
        });
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            
            // ‰∏ÄÊ¨°ÊÄßÂ∞ÜÊâÄÊúâÊñ∞ËØÑËÆ∫Êõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì
            await db.qzonePosts.put(currentPost);
            console.log(`ÊàêÂäü‰∏∫Âä®ÊÄÅ #${post.id} ÊâπÈáèÁîüÊàê‰∫Ü ${commentActions.length} Êù°NPCËØÑËÆ∫„ÄÇ`);
        }

    } catch (error) {
        console.error(`‰∏∫Âä®ÊÄÅ #${post.id} ÊâπÈáèÁîüÊàêNPCËØÑËÆ∫Â§±Ë¥•:`, error);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂàáÊç¢Ê∏≤ÊüìËßÑÂàôÁöÑÂàÜÁ±ªÈ°µÁ≠æ
         * @param {string} categoryId - Ë¶ÅÂàáÊç¢Âà∞ÁöÑÂàÜÁ±ªID ('global' Êàñ ËÅäÂ§©ID)
         */
        function switchRuleCategory(categoryId) {
            // ÂàáÊç¢È°µÁ≠æÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // ÂàáÊç¢ÂÜÖÂÆπÈù¢ÊùøÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            document.querySelectorAll('.rules-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ†πÊçÆËßíËâ≤ÁöÑÊú¨ÂêçÔºåÂú®Êï¥‰∏™Â∫îÁî®‰∏≠Êü•ÊâæÂÖ∂Ê≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞
         * @param {string} originalName - ËßíËâ≤ÁöÑÊú¨Âêç (e.g., "ÊùéÊòüËæ∞")
         * @returns {string} - ËØ•ËßíËâ≤ÁöÑÂ§áÊ≥®Âêç/Áæ§ÊòµÁß∞/Áî®Êà∑ÊòµÁß∞ÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂàôËøîÂõûÂÖ∂Êú¨Âêç
         */
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞„ÄÅÊõ¥Êô∫ËÉΩ„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ getDisplayNameByOriginalName ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ†πÊçÆËßíËâ≤ÁöÑÊú¨ÂêçÊàñÊõæÁî®ÂêçÔºåÂú®Êï¥‰∏™Â∫îÁî®‰∏≠Êü•ÊâæÂÖ∂Ê≠£Á°ÆÁöÑ„ÄêÂΩìÂâçÊòæÁ§∫ÂêçÁß∞„Äë
         * @param {string} nameIdentifier - ËßíËâ≤ÁöÑÊú¨Âêç Êàñ ÂÇ®Â≠òÂú®ÊóßÊï∞ÊçÆ‰∏≠ÁöÑÊõæÁî®Âêç
         * @returns {string} - ËØ•ËßíËâ≤ÁöÑ„ÄêÂΩìÂâç„ÄëÂ§áÊ≥®Âêç/Áæ§ÊòµÁß∞/Áî®Êà∑ÊòµÁß∞ÔºåÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂàôËøîÂõû‰º†ÂÖ•ÁöÑÊ†áËØÜÁ¨¶
         */
        function getDisplayNameByOriginalName(nameIdentifier) {
            // 1. Â¶ÇÊûú‰º†ÂÖ•ÁöÑÊòØÁ©∫ÂÄºÔºåÁõ¥Êé•ËøîÂõû
            if (!nameIdentifier) return '';
        
            // 2. Ê£ÄÊü•ÊòØ‰∏çÊòØÁî®Êà∑Ëá™Â∑±
            if (state.qzoneSettings && nameIdentifier === state.qzoneSettings.nickname) {
                return state.qzoneSettings.nickname;
            }
            
            // 3. „Äê‰∏ªË¶ÅÊü•ÊâæÊñπÂºè„Äë: ÈÄöËøá‚ÄúÊú¨Âêç‚Äù (originalName) Êü•Êâæ„ÄÇ
            // ËøôÊòØÊúÄÊ†áÂáÜ„ÄÅÊúÄÂèØÈù†ÁöÑÊñπÂºèÔºåÈÄÇÁî®‰∫éÊâÄÊúâÊñ∞ÂàõÂª∫ÁöÑÊï∞ÊçÆ„ÄÇ
            let characterChat = Object.values(state.chats).find(chat => !chat.isGroup && chat.originalName === nameIdentifier);
            if (characterChat) {
                return characterChat.name; // Â¶ÇÊûúÊâæÂà∞ÔºåËøîÂõûËØ•ËßíËâ≤„ÄêÂΩìÂâç„ÄëÁöÑÂ§áÊ≥®Âêç
            }
        
            // 4. „ÄêÂÖºÂÆπÊóßÊï∞ÊçÆ„Äë: Â¶ÇÊûúÈÄöËøá‚ÄúÊú¨Âêç‚ÄùÊ≤°ÊâæÂà∞ÔºåÂ∞±Â∞ùËØïÊää‰º†ÂÖ•ÁöÑÂêçÂ≠óÂΩì‰Ωú‰∏Ä‰∏™„ÄêÊóßÁöÑÂ§áÊ≥®Âêç„ÄëÂéªÂéÜÂè≤ËÆ∞ÂΩïÈáåÊü•Êâæ„ÄÇ
            characterChat = Object.values(state.chats).find(chat => 
                !chat.isGroup && 
                (chat.nameHistory && chat.nameHistory.includes(nameIdentifier))
            );
            if (characterChat) {
                return characterChat.name; // Â¶ÇÊûúÂú®ÂéÜÂè≤ËÆ∞ÂΩïÈáåÊâæÂà∞‰∫ÜÔºåÂêåÊ†∑ËøîÂõûËØ•ËßíËâ≤„ÄêÂΩìÂâç„ÄëÁöÑÂ§áÊ≥®Âêç
            }
        
            // 5. „ÄêÊúÄÁªàÂ§áÁî®ÊñπÊ°à„Äë: Â¶ÇÊûú‰ª•‰∏äÊñπÊ≥ïÈÉΩÊâæ‰∏çÂà∞ÔºåËØ¥ÊòéËøôÂèØËÉΩÊòØ‰∏Ä‰∏™ÈùûÂ∏∏ÊóßÁöÑÊï∞ÊçÆÔºåÊàñËÄÖËßíËâ≤Â∑≤Ë¢´Âà†Èô§„ÄÇ
            // Ê≠§Êó∂ÔºåÁõ¥Êé•ËøîÂõûÂÇ®Â≠òÂú®ËØÑËÆ∫ÈáåÁöÑÈÇ£‰∏™ÂêçÂ≠óÔºåËá≥Â∞ëËÉΩ‰øùËØÅÊúâÂÜÖÂÆπÊòæÁ§∫„ÄÇ
            return nameIdentifier;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅÊõ¥Êô∫ËÉΩÁöÑ„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ processMentions ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜAIÁîüÊàêÁöÑÊñáÊú¨ÔºåÂ∞ÜÁâπÊÆäÁöÑ@Âç†‰ΩçÁ¨¶ÊõøÊç¢‰∏∫Ê≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞
         * @param {string} text - AIÁîüÊàêÁöÑ„ÄÅÂèØËÉΩÂåÖÂê´ @[[Êú¨Âêç]] Âç†‰ΩçÁ¨¶ÁöÑÂéüÂßãÊñáÊú¨
         * @param {object|null} chat - ÂΩìÂâçÁöÑËÅäÂ§©ÂØπË±° (Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÂàôÁî®‰∫éÊü•ÊâæÁæ§ÊòµÁß∞)
         * @returns {string} - Â§ÑÁêÜÂÆåÊàêÂêéÔºåÂØπÁî®Êà∑ÂèãÂ•ΩÁöÑÊòæÁ§∫ÊñáÊú¨
         */
        function processMentions(text, chat = null) {
            // Â¶ÇÊûúÊñáÊú¨Êó†ÊïàÊàñ‰∏çÂåÖÂê´@Ê†áËÆ∞ÔºåÁõ¥Êé•ËøîÂõû‰ª•ÊèêÈ´òÊÄßËÉΩ
            if (!text || typeof text !== 'string' || !text.includes('@[[')) {
                return text; 
            }
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÁöÑÂÖ®Â±ÄÂåπÈÖçÔºå‰∏ÄÊ¨°ÊÄßÂ§ÑÁêÜÊâÄÊúâ@ÊèêÂèä
            return text.replace(/@\[\[([^\]]+)\]\]/g, (match, originalName) => {
                const trimmedOriginalName = originalName.trim();
                let displayName;
                
                // „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÂ¶ÇÊûúÊèê‰æõ‰∫ÜËÅäÂ§©ÂØπË±°ÔºåÂπ∂‰∏îÊòØÁæ§ËÅä
                if (chat && chat.isGroup) {
                    // Â∞±Ë∞ÉÁî®Êàë‰ª¨Áé∞ÊúâÁöÑ„ÄÅÂº∫Â§ßÁöÑ getDisplayNameInGroup ÂáΩÊï∞
                    // Ëøô‰∏™ÂáΩÊï∞‰ºöËá™Âä®‰ºòÂÖàÊü•ÊâæÁæ§ÊòµÁß∞ÔºåÊâæ‰∏çÂà∞ÂÜçÁî®Êú¨Âêç
                    displayName = getDisplayNameInGroup(chat, trimmedOriginalName);
                } else {
                    // Â¶ÇÊûúÊòØÁßÅËÅäÊàñÊ≤°ÊúâÊèê‰æõËÅäÂ§©ÂØπË±°ÔºåÂ∞±‰ΩøÁî®ÂÖ®Â±ÄÊü•ÊâæÂáΩÊï∞
                    displayName = getDisplayNameByOriginalName(trimmedOriginalName);
                }
                
                // ËøîÂõûËΩ¨Êç¢ÂêéÁöÑ„ÄÅÂ∏¶@ÁöÑÊ≠£Á°ÆÊòµÁß∞
                return `@${displayName}`;
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂÆåÊï¥ÂáΩÊï∞ÔºåÊõøÊç¢ÊéâÊÇ®Áé∞ÊúâÁöÑ showCustomConfirm ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
        
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ÂáΩÊï∞Ë¢´Ë∞ÉÁî®Êó∂ÔºåÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊåâÈíÆÂÖÉÁ¥†
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
        
                cancelBtn.style.display = 'block';
        
                confirmBtn.textContent = options.confirmText || 'Á°ÆÂÆö';
                cancelBtn.textContent = options.cancelText || 'ÂèñÊ∂à';
        
                if (options.confirmButtonClass) {
                    confirmBtn.classList.add(options.confirmButtonClass);
                } else {
                    // Á°Æ‰øù‰πãÂâçÁöÑÂç±Èô©Êìç‰ΩúÊ†∑ÂºèË¢´ÁßªÈô§
                    confirmBtn.classList.remove('btn-danger');
                }
        
                // ‰∏∫ÊúÄÊñ∞ÁöÑÊåâÈíÆÁªëÂÆöÊú¨Ê¨°ÁöÑÁÇπÂáª‰∫ã‰ª∂
                confirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                function showCustomAlert(title, message) {
                    return new Promise(resolve => {
                        modalResolve = resolve;
                        modalTitle.textContent = title;
                        modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                        modalCancelBtn.style.display = 'none';
                        modalConfirmBtn.textContent = 'Â•ΩÁöÑ';
                        modalConfirmBtn.onclick = () => {
                            modalCancelBtn.style.display = 'block'; 
                            modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                            resolve(true); 
                            hideCustomModal();
                        };
                        showCustomModal();
                    });
                }
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂÆåÊï¥ÂáΩÊï∞ÔºåÊõøÊç¢ÊéâÊÇ®Áé∞ÊúâÁöÑ showCustomPrompt ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                const inputId = 'custom-prompt-input';
                
                const inputHtml = type === 'textarea' 
                    ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                    : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
                
                modalBody.innerHTML = extraHtml + inputHtml;
                const input = document.getElementById(inputId);
        
                modalBody.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const templateStr = btn.dataset.template;
                        if (templateStr) {
                            try {
                                const templateObj = JSON.parse(templateStr);
                                input.value = JSON.stringify(templateObj, null, 2);
                                input.focus();
                            } catch(e) { console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e); }
                        }
                    });
                });
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ÂáΩÊï∞Ë¢´Ë∞ÉÁî®Êó∂ÔºåÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊåâÈíÆÂÖÉÁ¥†
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
                
                // ‰∏∫ÊúÄÊñ∞ÁöÑÊåâÈíÆÁªëÂÆöÊú¨Ê¨°ÁöÑÁÇπÂáª‰∫ã‰ª∂
                confirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                cancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÂÖ®Êñ∞„ÄëÁöÑÂáΩÊï∞‰ª£Á†ÅÁ≤òË¥¥Âà∞ showCustomPrompt ÂáΩÊï∞ÁöÑÂêéÈù¢ ‚ñº‚ñº‚ñº
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÊõ¥ÂÅ•Â£ÆÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ showChoiceModal ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂ∑≤‰øÆÂ§ç„ÄëÊòæÁ§∫‰∏Ä‰∏™ÂåÖÂê´Â§ö‰∏™ÈÄâÈ°πÁöÑÊìç‰ΩúËèúÂçïÊ®°ÊÄÅÊ°Ü
         * @param {string} title - Ê®°ÊÄÅÊ°ÜÁöÑÊ†áÈ¢ò
         * @param {Array<object>} options - ÊåâÈíÆÈÄâÈ°πÊï∞ÁªÑ, e.g., [{ text: 'ÊåâÈíÆÊñáÂ≠ó', value: 'ËøîÂõûÂÄº' }]
         * @returns {Promise<string|null>} - ËøîÂõûÁî®Êà∑ÁÇπÂáªÊåâÈíÆÁöÑvalueÔºåÂ¶ÇÊûúÂèñÊ∂àÂàôËøîÂõûnull
         */
        function showChoiceModal(title, options) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal-overlay');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalBody = document.getElementById('custom-modal-body');
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                // 1. ËÆæÁΩÆÊ†áÈ¢òÂíåÊ∏ÖÁ©∫ÂÜÖÂÆπÂå∫
                modalTitle.textContent = title;
                modalBody.innerHTML = ''; 
                
                // 2. Âä®ÊÄÅÂàõÂª∫ÈÄâÈ°πÊåâÈíÆ
                modalFooter.innerHTML = ''; 
                modalFooter.style.flexDirection = 'column';
        
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.onclick = () => {
                        // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨‰∏çÂÜçË∞ÉÁî® hideCustomModalÔºåËÄåÊòØÁõ¥Êé•ÊéßÂà∂
                        modal.classList.remove('visible');
                        resolve(option.value);
                    };
                    modalFooter.appendChild(button);
                });
        
                // 3. Ê∑ªÂä†‰∏Ä‰∏™Ê†áÂáÜÁöÑÂèñÊ∂àÊåâÈíÆ
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ÂèñÊ∂à';
                cancelButton.style.marginTop = '8px';
                cancelButton.style.borderRadius = '8px';
                cancelButton.style.backgroundColor = '#f0f0f0';
                cancelButton.onclick = () => {
                    modal.classList.remove('visible');
                    resolve(null); // Áî®Êà∑ÂèñÊ∂àÔºåËøîÂõû null
                };
                modalFooter.appendChild(cancelButton);
        
                // 4. ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                modal.classList.add('visible');
        
            }).finally(() => {
                // 5. „Äê„Äê„ÄêËøôÂ∞±ÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÂ§çÔºÅ„Äë„Äë„Äë
                // Êó†ËÆ∫Áî®Êà∑ÊòØÈÄâÊã©‰∫ÜÈÄâÈ°πËøòÊòØÂèñÊ∂àÔºåÊúÄÂêéÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂ∞ÜÊ®°ÊÄÅÊ°ÜÁöÑÈ°µËÑöÊÅ¢Â§ç‰∏∫ÂéüÂßãÁöÑ„ÄÅÂäüËÉΩÂÆåÊï¥ÁöÑÁä∂ÊÄÅ„ÄÇ
                const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        
                modalFooter.style.flexDirection = 'row'; // ÊÅ¢Â§çÊ∞¥Âπ≥Â∏ÉÂ±Ä
                // ÈáçÊñ∞ÂàõÂª∫ÂéüÂßãÁöÑ‚ÄúÂèñÊ∂à‚ÄùÂíå‚ÄúÁ°ÆÂÆö‚ÄùÊåâÈíÆ
                modalFooter.innerHTML = `
                    <button id="custom-modal-cancel">ÂèñÊ∂à</button>
                    <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
                `;
        
                // „ÄêÈáçË¶Å„Äë‰∏∫Êñ∞ÂàõÂª∫ÁöÑÊåâÈíÆÈáçÊñ∞ÁªëÂÆöÂÆÉ‰ª¨ÊúÄÂü∫Êú¨ÁöÑÈªòËÆ§‰∫ã‰ª∂ÔºÅ
                document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                // Ê≥®ÊÑèÔºöÊàë‰ª¨‰∏çÈúÄË¶Å‰∏∫‚ÄúÁ°ÆÂÆö‚ÄùÊåâÈíÆÁªëÂÆöÈªòËÆ§‰∫ã‰ª∂ÔºåÂõ†‰∏∫ showCustomConfirm Âíå showCustomPrompt 
                // ÊØèÊ¨°Ë∞ÉÁî®Êó∂ÈÉΩ‰ºö‰∏∫ÂÆÉÂä®ÊÄÅÁªëÂÆöÊñ∞ÁöÑ onclick ‰∫ã‰ª∂ÔºåËøôÊ≠£ÊòØÊàë‰ª¨ÊÉ≥Ë¶ÅÁöÑË°å‰∏∫„ÄÇ
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™„ÄêÂÖ®Êñ∞„ÄëÁöÑÂáΩÊï∞Á≤òË¥¥Âà∞ showChoiceModal ÂáΩÊï∞ÁöÑÂêéÈù¢ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëËé∑ÂèñÊ≠åËØçÂÜÖÂÆπÔºàÊîØÊåÅÊñá‰ª∂ÂíåÁ≤òË¥¥ÔºåÂπ∂‰øÆÂ§çÁ≤òË¥¥Ê†ºÂºèÔºâ
         * @returns {Promise<string|null>} ËøîÂõûÊ≠åËØçÊñáÊú¨Â≠óÁ¨¶‰∏≤ÔºåÂ¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÂàôËøîÂõûnull
         */
        async function getLrcContent() {
            // 1. ÂºπÂá∫ÈÄâÊã©Ê°Ü
            const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [
                { text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)', value: 'file' },
                { text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨', value: 'paste' }
            ]);
        
            // 2. Ê†πÊçÆÁî®Êà∑ÁöÑÈÄâÊã©ÊâßË°å‰∏çÂêåÊìç‰Ωú
            if (choice === 'file') {
                // Áî®Êà∑ÈÄâÊã©Êñá‰ª∂ÔºöËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèòÔºåÂÆÉÂ∑•‰ΩúÊ≠£Â∏∏
                return new Promise(resolve => {
                    const lrcInput = document.getElementById('lrc-upload-input');
                    const lrcChangeHandler = (e) => {
                        const lrcFile = e.target.files[0];
                        if (lrcFile) {
                            const reader = new FileReader();
                            reader.onload = (readEvent) => resolve(readEvent.target.result);
                            reader.onerror = () => resolve(""); // Âá∫ÈîôÊó∂ËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
                            reader.readAsText(lrcFile);
                        } else {
                            resolve(null); // Áî®Êà∑ÂÖ≥Èó≠‰∫ÜÊñá‰ª∂ÈÄâÊã©Ê°Ü
                        }
                        lrcInput.removeEventListener('change', lrcChangeHandler);
                        lrcInput.value = ''; // ÈáçÁΩÆinputÔºå‰ª•‰æø‰∏ãÊ¨°ËÉΩÈÄâÊã©ÂêåÂêçÊñá‰ª∂
                    };
                    lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
                    lrcInput.click();
                });
            } else if (choice === 'paste') {
                // Áî®Êà∑ÈÄâÊã©Á≤òË¥¥ÔºöÂºπÂá∫ÊñáÊú¨ËæìÂÖ•Ê°Ü
                const pastedText = await showCustomPrompt(
                    'Á≤òË¥¥Ê≠åËØç',
                    'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...',
                    '',
                    'textarea' // ‰ΩøÁî®Â§öË°åÊñáÊú¨Ê°Ü
                );
                
                // --- ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáå ‚òÖ‚òÖ‚òÖ ---
                if (pastedText) {
                    // Âú®Ëß£Êûê‰πãÂâçÔºåËá™Âä®‰∏∫ÊØè‰∏™Êó∂Èó¥Êà≥ÂâçÊ∑ªÂä†Êç¢Ë°åÁ¨¶
                    // Ëøô‰ºö‰øÆÂ§çÂçïË°åÁ≤òË¥¥ÁöÑÈóÆÈ¢ò
                    const formattedText = pastedText.replace(/\[/g, '\n[').trim();
                    return formattedText;
                }
                return pastedText; // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÔºåËøôÈáå‰ºöËøîÂõû null
                // --- ‚òÖ‚òÖ‚òÖ ‰øÆÂ§çÁªìÊùü ‚òÖ‚òÖ‚òÖ ---
        
            } else {
                // Áî®Êà∑ÁÇπÂáª‰∫Ü‚ÄúÂèñÊ∂à‚Äù
                return null;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                // ===================================================================
                // 2. Êï∞ÊçÆÂ∫ìÁªìÊûÑÂÆö‰πâ
                // ===================================================================
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ V29 ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ db.version(...) ‰ª£Á†ÅÂùó ‚ñº‚ñº‚ñº
            db.version(31).stores({
            chats: '&id, isGroup, groupId, isPinned',
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name, categoryId',
            worldBookCategories: '++id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            qzoneSettings: '&id',
            qzonePosts: '++id, timestamp', 
            qzoneAlbums: '++id, name, createdAt',
            qzonePhotos: '++id, albumId',
            favorites: '++id, type, timestamp, originalTimestamp',
            qzoneGroups: '++id, name',
            memories: '++id, chatId, timestamp, type, targetDate',
            callRecords: '++id, chatId, timestamp, customName',
            shoppingProducts: '++id, name, description',
            apiPresets: '++id, name',
                renderingRules: '++id, name, chatId',
                fonts: '++id, name, url, isActive',
                jsonConfigs: '++id, name, config, createdAt'
        }).upgrade(tx => {
            // Ëøô‰∏™ÂçáÁ∫ßÂáΩÊï∞‰ºöËá™Âä®Â§ÑÁêÜÊï∞ÊçÆËøÅÁßª
            console.log('Êï∞ÊçÆÂ∫ìÂçáÁ∫ßÂà∞ÁâàÊú¨31ÔºåÊ∑ªÂä†jsonConfigsË°®');
            return tx.table('worldBooks').toCollection().modify(book => {
                // Á°Æ‰øù content Â≠óÊÆµÊòØÊï∞ÁªÑ
                if (typeof book.content === 'string' && book.content.trim() !== '') {
                    book.content = [{
                        keys: [],
                        comment: '‰ªéÊóßÁâàÊú¨ËøÅÁßªÁöÑÊù°ÁõÆ',
                        content: book.content
                    }];
                } else if (!Array.isArray(book.content)) {
                    book.content = [];
                }

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰∏∫ÊâÄÊúâÊù°ÁõÆÊ∑ªÂä† enabled Â±ûÊÄßÔºåÈªòËÆ§‰∏∫ true
                book.content.forEach(entry => {
                    if (typeof entry.enabled === 'undefined') {
                        entry.enabled = true;
                    }
                });
            });
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                // ===================================================================
                // 3. ÊâÄÊúâÂäüËÉΩÂáΩÊï∞ÂÆö‰πâ
                // ===================================================================
        
                function showScreen(screenId) {
                    if (screenId === 'chat-list-screen') {
                        window.renderChatListProxy(); 
                        switchToChatListView('messages-view');
                    }
                    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
                    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
                    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screenToShow = document.getElementById(screenId);
                    if (screenToShow) screenToShow.classList.add('active');
                    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
                    if (screenId === 'font-settings-screen') {
                        document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                        applyCustomFont(state.globalSettings.fontUrl || '', true);
                    // Ê∏≤ÊüìÂ≠ó‰ΩìÂ∫ìÂàóË°®
                    renderFontLibrary();
                }
                
                if (screenId === 'appearance-settings-screen') {
                    // Ê∏≤ÊüìJSONÈÖçÁΩÆÂàóË°®ÂíåÂõæÊ†áËÆæÁΩÆ
                    console.log('ËøõÂÖ•Â§ñËßÇËÆæÁΩÆÈ°µÈù¢ÔºåÂºÄÂßãÊ∏≤ÊüìJSONÈÖçÁΩÆÂàóË°®ÂíåÂõæÊ†áËÆæÁΩÆ');
                    renderJsonConfigsList();
                    renderIconSettings();
                    }
                }
                window.updateListenTogetherIconProxy = () => {};
        
                function switchToChatListView(viewId) {
                    const chatListScreen = document.getElementById('chat-list-screen');
                    const views = {
                        'messages-view': document.getElementById('messages-view'),
                        'qzone-screen': document.getElementById('qzone-screen'),
                        'favorites-view': document.getElementById('favorites-view'),
                'memories-view': document.getElementById('memories-view') // <-- Êñ∞Â¢ûËøô‰∏ÄË°å
            };
                    const mainHeader = document.getElementById('main-chat-list-header');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è
        
                    if (isFavoritesSelectionMode) {
                        document.getElementById('favorites-edit-btn').click(); 
                    }
        
                    // ÈöêËóèÊâÄÊúâËßÜÂõæ
                    Object.values(views).forEach(v => v.classList.remove('active'));
                    // ÊòæÁ§∫ÁõÆÊ†áËßÜÂõæ
                    if (views[viewId]) {
                        views[viewId].classList.add('active');
                    }
        
                    // Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÈ´ò‰∫Æ
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.view === viewId);
                    });
                    
                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÁªü‰∏ÄÁÆ°ÁêÜÊâÄÊúâUIÂÖÉÁ¥†ÁöÑÊòæÈöê ‚ñº‚ñº‚ñº
                    if (viewId === 'messages-view') {
                        mainHeader.style.display = 'flex';
                        mainBottomNav.style.display = 'flex';
                    } else {
                        mainHeader.style.display = 'none';
                        mainBottomNav.style.display = 'none';
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            if (viewId !== 'memories-view') {
                activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                activeCountdownTimers = [];
            }
        
                    // Ê†πÊçÆËßÜÂõæIDÊâßË°åÁâπÂÆöÁöÑÊ∏≤Êüì/Êõ¥Êñ∞ÈÄªËæë
                    switch (viewId) {
                        case 'qzone-screen':
                            views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                            updateUnreadIndicator(0);
                            renderQzoneScreen();
                            renderQzonePosts();
                            break;
                        case 'favorites-view':
                            views['favorites-view'].style.backgroundColor = '#f9f9f9';
                            renderFavoritesScreen();
                            break;
                        case 'messages-view':
                            // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËøîÂõûÊ∂àÊÅØÂàóË°®Êó∂Ë¶ÅÊâßË°åÁöÑÈÄªËæë
                            break;
                    }
                }
                
                function renderQzoneScreen() {
                    if (state && state.qzoneSettings) {
                        const settings = state.qzoneSettings;
                        document.getElementById('qzone-nickname').textContent = settings.nickname;
                        document.getElementById('qzone-avatar-img').src = settings.avatar;
                        document.getElementById('qzone-banner-img').src = settings.banner;
                    }
                }
                window.renderQzoneScreenProxy = renderQzoneScreen;
        
                async function saveQzoneSettings() {
                    if (db && state.qzoneSettings) {
                        await db.qzoneSettings.put(state.qzoneSettings);
                    }
                }
        
                function formatPostTimestamp(timestamp) {
                    if (!timestamp) return '';
                    const now = new Date();
                    const date = new Date(timestamp);
                    const diffSeconds = Math.floor((now - date) / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    if (diffMinutes < 1) return 'ÂàöÂàö';
                    if (diffMinutes < 60) return `${diffMinutes}ÂàÜÈíüÂâç`;
                    if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    if (now.getFullYear() === year) {
                        return `${month}-${day} ${hours}:${minutes}`;
                    } else {
                        return `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏â‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞ | ÊÄßËÉΩÊ†∏ÂøÉ | Â∑≤ÈõÜÊàêMarkdown„ÄëÊ†πÊçÆÂ∏ñÂ≠êÊï∞ÊçÆÔºåÂàõÂª∫ÊàñÊõ¥Êñ∞Âçï‰∏™Â∏ñÂ≠êÁöÑHTMLÂÖÉÁ¥†
         * @param {object} post - Âçï‰∏™Â∏ñÂ≠êÁöÑÊï∞ÊçÆÂØπË±°
         * @returns {HTMLElement} - ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂêéÁöÑÂ∏ñÂ≠êÂÆπÂô®DOMÂÖÉÁ¥†
         */
        function createOrUpdatePostElement(post) {
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                const authorChat = state.chats[post.authorId];
                authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                authorNickname = authorChat.name;
            } else {
                authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
                authorAvatar = defaultAvatar;
            }
        
            function renderOriginalPostContent(targetPost) {
                let innerContentHtml = '';
                // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';
        
                if (targetPost.type === 'shuoshuo') {
                    // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                    innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
                } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                    innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
                } else if (targetPost.type === 'text_image') {
                    innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
                }
                return innerContentHtml;
            }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${parseMarkdown(post.repostComment).replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'Âéü‰ΩúËÄÖ';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('„ÄÅ');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} ËßâÂæóÂæàËµû</span></div>`;
            }
        
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                         </div>`;
        
                    } else {
                        // ‚ñº‚ñº‚ñº Â∑≤‰∏∫ÊóßÊ†ºÂºèËØÑËÆ∫Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${parseMarkdown(String(comment))}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id);
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">‚Ä¶</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
 <!-- „Äê„Äê„ÄêÊ†∏ÂøÉÊñ∞Â¢ûÔºöÊâãÂä®Ëß¶ÂèëNPCËØÑËÆ∫ÁöÑÊåâÈíÆ„Äë„Äë„Äë -->
       <button class="npc-comment-trigger-btn" title="ÊâãÂä®Ëß¶ÂèëNPCËØÑËÆ∫">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
    </button>
                    <button class="comment-send-btn">ÂèëÈÄÅ</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>Âà†Èô§</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * „ÄêÂÖ®Êñ∞ | Â¢ûÈáèÊõ¥Êñ∞ÂáΩÊï∞„ÄëÂè™Êõ¥Êñ∞Âçï‰∏™Â∏ñÂ≠êÔºåËÄå‰∏çÊòØÈáçÁªòÊï¥‰∏™ÂàóË°®
         * @param {number} postId - ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÂ∏ñÂ≠êÁöÑID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // Â¶ÇÊûúÂ∏ñÂ≠êË¢´Âà†‰∫ÜÔºåÂ∞±‰ªéDOM‰∏≠ÁßªÈô§
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) postContainer.remove();
                return;
            }
        
            // Êõ¥Êñ∞ÁºìÂ≠ò
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) qzonePostsCache[cacheIndex] = postData;
            
            // Êõ¥Êñ∞Êî∂ËóèÁä∂ÊÄÅ
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // Ë∞ÉÁî®Ê†∏ÂøÉÂáΩÊï∞Êù•Êõ¥Êñ∞DOM
            createOrUpdatePostElement(postData);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞ formatPostTimestamp ÂáΩÊï∞ÁöÑÂêéÈù¢ ‚ñº‚ñº‚ñº
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            const minutes = Math.floor(seconds / 60);
            if (minutes < 2) return 'ÂàöÂàö';
            if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;
            const days = Math.floor(hours / 24);
            return `${days}Â§©Ââç`;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏§‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞ | ÊÄßËÉΩÊ†∏ÂøÉ„ÄëÊ†πÊçÆÂ∏ñÂ≠êÊï∞ÊçÆÔºåÂàõÂª∫ÊàñÊõ¥Êñ∞Âçï‰∏™Â∏ñÂ≠êÁöÑHTMLÂÖÉÁ¥†
         * @param {object} post - Âçï‰∏™Â∏ñÂ≠êÁöÑÊï∞ÊçÆÂØπË±°
         * @returns {HTMLElement} - ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂêéÁöÑÂ∏ñÂ≠êÂÆπÂô®DOMÂÖÉÁ¥†
         */
        function createOrUpdatePostElement(post) {
            const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
            const isUpdating = !!existingPostContainer;
            
            // Â¶ÇÊûúÊòØÊõ¥Êñ∞ÔºåÂ∞±Áõ¥Êé•Áî®ÊóßÁöÑÂÆπÂô®ÔºõÂ¶ÇÊûúÊòØÊñ∞Âª∫ÔºåÂ∞±ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ
            const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
            if (!isUpdating) {
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;
            }
        
            // --- ÂêéÁª≠ÁöÑHTMLÊûÑÂª∫ÈÄªËæë‰∏éÊÇ®ÊóßÁöÑ renderQzonePosts ÂáΩÊï∞ÂÆåÂÖ®Áõ∏Âêå ---
            // (Êàë‰ª¨Âè™ÊòØÊääÂÆÉ‰ªé‰∏Ä‰∏™Â§ßÂæ™ÁéØÈáåÊäΩÁ¶ªÂá∫Êù•ÔºåÂèòÊàê‰∏Ä‰∏™Áã¨Á´ãÁöÑ„ÄÅÂèØÂ§çÁî®ÁöÑÂáΩÊï∞)
            const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
            if (!isUpdating) {
                postEl.className = 'qzone-post-item';
            }
        
            let authorAvatar = '', authorNickname = '', commentAvatar = state.qzoneSettings.avatar; 
        
    // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1ÔºöÂú®ËøôÈáåËé∑ÂèñÂèëÂ∏ñ‰∫∫ÂØπË±°„Äë ---
    const authorChar = post.authorId !== 'user' ? state.chats[post.authorId] : null;

    if (post.authorId === 'user') {
        authorAvatar = state.qzoneSettings.avatar;
        authorNickname = state.qzoneSettings.nickname;
    } else if (authorChar) {
        authorAvatar = authorChar.settings.aiAvatar || defaultAvatar;
        authorNickname = authorChar.name;
    } else {
        authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
        authorAvatar = defaultAvatar;
    }
        
            function renderOriginalPostContent(targetPost) {
                let innerContentHtml = '';
                const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';
        
                if (targetPost.type === 'shuoshuo') {
                    innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
                } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {
                        const postImageUrl = targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : (targetPost.imageUrl || 'https://i.postimg.cc/KYr2qRCK/1.jpg');
    innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
} else if (targetPost.type === 'text_image') {
    const postImageUrl = targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
                }
                return innerContentHtml;
            }
        
            let mainContentHtml;
        
            if (post.type === 'repost') {
                const repostCommentHtml = post.repostComment ? `<div class="post-content">${post.repostComment.replace(/\n/g, '<br>')}</div>` : '';
                let originalAuthorAvatar = defaultAvatar;
                let originalAuthorNickname = 'Âéü‰ΩúËÄÖ';
                if (post.originalPost.authorId === 'user') {
                    originalAuthorAvatar = state.qzoneSettings.avatar;
                    originalAuthorNickname = state.qzoneSettings.nickname;
                } else {
                    const originalAuthorChat = state.chats[post.originalPost.authorId];
                    if (originalAuthorChat) {
                        originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
                    }
                    originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
                }
                mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
            } else {
                mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
            }
        
            let likesHtml = '';
            if (post.likes && post.likes.length > 0) {
                const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('„ÄÅ');
                likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} ËßâÂæóÂæàËµû</span></div>`;
            }
        
        // ‚ñº‚ñº‚ñº Âú® createOrUpdatePostElement ÂáΩÊï∞‰∏≠ÔºåÊâæÂà∞ let commentsHtml = ''; Âπ∂Áî®‰∏ãÈù¢ËøôÊï¥ÂùóÊõøÊç¢ ‚ñº‚ñº‚ñº
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach((comment, index) => {
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç1„ÄëÊ£ÄÊü•ÊòØÂê¶ÊòØÊñ∞ÁöÑ„ÄÅÂåÖÂê´ commenterName ÁöÑÂØπË±°Ê†ºÂºè
                    if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                        const commenterOriginalName = comment.commenterName;
                        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„Äë‰ΩøÁî®Êàë‰ª¨ÂÖ®Êñ∞ÁöÑÂáΩÊï∞Êù•ÂÆûÊó∂Êü•ÊâæÊúÄÊñ∞ÁöÑÊòæÁ§∫ÂêçÁß∞ÔºÅ
                        const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                        
                        let innerCommentContent;
                        if (STICKER_REGEX.test(comment.text)) {
                            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                        } else {
                            innerCommentContent = parseMarkdown(comment.text);
                        }
        
                        let commentLineHtml = '';
                        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç3„ÄëÂõûÂ§çÁöÑÁõÆÊ†á‰πü‰ΩøÁî®Êñ∞ÂáΩÊï∞Êù•Êü•ÊâæÂêçÂ≠ó
                        if (comment.replyTo) {
                            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                        } else {
                            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                        }
                        
                        commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                         </div>`;
        
                    } else {
                        // „ÄêÂÖºÂÆπÊóßÊï∞ÊçÆ„ÄëÂ¶ÇÊûúËøòÊòØÊóßÁöÑÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÔºåÂ∞±ÂéüÊ†∑ÊòæÁ§∫
                        commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${String(comment)}</span>
                                         </div>`;
                    }
                });
                commentsHtml += '</div>';
            }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            const userOriginalName = state.qzoneSettings.nickname;
            const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
            const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id); // ‰ªé state ËØªÂèñ
        
            let repostIconHtml = '';
            if (post.type !== 'repost') {
                repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
            }
    // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2ÔºöÂú®ËøôÈáåËøõË°åÂà§Êñ≠„Äë ---
    const canHaveNpcComments = authorChar && !authorChar.isGroup && authorChar.npcs && authorChar.npcs.length > 0;

    // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ3ÔºöÊ†πÊçÆ‰∏äÈù¢ÁöÑÂà§Êñ≠ÁªìÊûúÔºåÂÜ≥ÂÆöÊòØÂê¶ÁîüÊàêÊåâÈíÆÁöÑHTML„Äë ---
    const npcButtonHtml = canHaveNpcComments ? `
        <button class="npc-comment-trigger-btn" title="ÊâãÂä®Ëß¶ÂèëNPCËØÑËÆ∫">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </button>
    ` : ''; // Â¶ÇÊûú‰∏çÊª°Ë∂≥Êù°‰ª∂ÔºåÂ∞±ÁîüÊàê‰∏Ä‰∏™Á©∫Â≠óÁ¨¶‰∏≤            
            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">‚Ä¶</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
          ${npcButtonHtml} <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ4ÔºöÂú®ËøôÈáåÊèíÂÖ•ÊåâÈíÆHTML„Äë -->
                    <button class="comment-send-btn">ÂèëÈÄÅ</button>
                </div>
            `;
        
            if (!isUpdating) {
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>Âà†Èô§</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
            }
            
            return postContainer;
        }
        
        /**
         * „ÄêÂÖ®Êñ∞ | Â¢ûÈáèÊõ¥Êñ∞ÂáΩÊï∞„ÄëÂè™Êõ¥Êñ∞Âçï‰∏™Â∏ñÂ≠êÔºåËÄå‰∏çÊòØÈáçÁªòÊï¥‰∏™ÂàóË°®
         * @param {number} postId - ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÂ∏ñÂ≠êÁöÑID
         */
        async function updateSinglePostInDOM(postId) {
            const postData = await db.qzonePosts.get(postId);
            if (!postData) {
                // Â¶ÇÊûúÂ∏ñÂ≠êË¢´Âà†‰∫ÜÔºåÂ∞±‰ªéDOM‰∏≠ÁßªÈô§
                const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
                if (postContainer) {
                    postContainer.remove();
                }
                return;
            }
        
            // Êõ¥Êñ∞ÁºìÂ≠ò
            const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
            if (cacheIndex > -1) {
                qzonePostsCache[cacheIndex] = postData;
            }
            
            // Êõ¥Êñ∞Êî∂ËóèÁä∂ÊÄÅ
            const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // Ë∞ÉÁî®Ê†∏ÂøÉÂáΩÊï∞Êù•Êõ¥Êñ∞DOM
            createOrUpdatePostElement(postData);
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ | È´òÊÄßËÉΩÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂáΩÊï∞ÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderQzonePosts ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞ | ÂàÜÈ°µÂä†ËΩΩÁâà„ÄëÊ∏≤ÊüìÂä®ÊÄÅÂàóË°®
         */
        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;
        
            // 1. ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÂà∞ÁºìÂ≠ò‰∏≠Ôºå‰ΩÜ‰∏çÁ´ãÂç≥Ê∏≤Êüì
            const [postsFromDb, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().filter(post => !post.isDeleted).toArray(),
                db.favorites.where('type').equals('qzone_post').toArray()
            ]);
            qzonePostsCache = postsFromDb;
            state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
        
            // 2. Ê∏ÖÁ©∫ÂàóË°®
            postsListEl.innerHTML = '';
        
            if (qzonePostsCache.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</p>';
                return;
            }
        
            // 3. Âè™Ê∏≤ÊüìÁ¨¨‰∏ÄÈ°µÁöÑÂä®ÊÄÅ
            const initialPosts = qzonePostsCache.slice(0, QZONE_RENDER_WINDOW);
            const fragment = document.createDocumentFragment();
            initialPosts.forEach(post => {
                const postElement = createOrUpdatePostElement(post);
                fragment.appendChild(postElement);
            });
            postsListEl.appendChild(fragment);
            
            // 4. Êõ¥Êñ∞Â∑≤Ê∏≤ÊüìÁöÑÊï∞Èáè
            qzonePostsRenderCount = initialPosts.length;
        
            // 5. Â¶ÇÊûúËøòÊúâÊõ¥Â§öÂä®ÊÄÅÔºåÂ∞±Ê∑ªÂä†‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
            if (qzonePostsCache.length > qzonePostsRenderCount) {
                appendLoadMorePostsButton(postsListEl);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫‰∏Ä‰∏™‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆÂπ∂Ê∑ªÂä†Âà∞ÂàóË°®Êú´Â∞æ
         * @param {HTMLElement} container - Ë¶ÅÊ∑ªÂä†ÊåâÈíÆÁöÑÂÆπÂô®
         */
        function appendLoadMorePostsButton(container) {
            const button = document.createElement('button');
            button.id = 'load-more-qzone-btn'; // ‰ΩøÁî®Êñ∞IDÔºåÈÅøÂÖç‰∏éËÅäÂ§©ËÆ∞ÂΩïÁöÑÊåâÈíÆÂÜ≤Á™Å
            button.textContent = 'Âä†ËΩΩÊõ¥Â§öÂä®ÊÄÅ';
            button.className = 'load-more-btn'; // Â§çÁî®ËÅäÂ§©È°µÈù¢ÁöÑÊåâÈíÆÊ†∑Âºè
            container.appendChild(button);
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂä†ËΩΩÊõ¥Â§öÂä®ÊÄÅËÆ∞ÂΩï
         */
        function loadMoreQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;
        
            // ÁßªÈô§ÊóßÁöÑ‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
            const loadMoreBtn = document.getElementById('load-more-qzone-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            // ËÆ°ÁÆó‰∏ã‰∏ÄÈ°µË¶ÅÂä†ËΩΩÁöÑÊï∞ÊçÆ
            const nextSliceStart = qzonePostsRenderCount;
            const nextSliceEnd = qzonePostsRenderCount + QZONE_RENDER_WINDOW;
            const postsToAppend = qzonePostsCache.slice(nextSliceStart, nextSliceEnd);
            
            // Ê∏≤ÊüìÂπ∂ËøΩÂä†Âà∞ÂàóË°®Êú´Â∞æ
            const fragment = document.createDocumentFragment();
            postsToAppend.forEach(post => {
                const postElement = createOrUpdatePostElement(post);
                fragment.appendChild(postElement);
            });
            postsListEl.appendChild(fragment);
        
            // Êõ¥Êñ∞Â∑≤Ê∏≤ÊüìÁöÑÊï∞Èáè
            qzonePostsRenderCount += postsToAppend.length;
        
            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÂÜçÊ¨°Ê∑ªÂä†ÊåâÈíÆ
            if (qzonePostsCache.length > qzonePostsRenderCount) {
                appendLoadMorePostsButton(postsListEl);
            }
        }
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂä®ÊÄÅËØÑËÆ∫Âå∫Ë°®ÊÉÖÈù¢ÊùøÁÆ°ÁêÜÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        function openQzoneStickerPanel(postId, buttonElement) {
            const panel = qzoneStickerPanelState.panelEl;
            const grid = qzoneStickerPanelState.gridEl;
        
            // 1. Â°´ÂÖÖË°®ÊÉÖ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            grid.innerHTML = '';
            if (state.userStickers.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">ËØ∑ÂÖàÂú®ËÅäÂ§©ÁïåÈù¢ÁöÑ<br>Ë°®ÊÉÖÈù¢Êùø‰∏≠Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</p>';
            } else {
                state.userStickers.forEach(sticker => {
                    const item = document.createElement('div');
                    item.className = 'sticker-item';
                    item.style.backgroundImage = `url(${sticker.url})`;
                    item.title = sticker.name;
                    grid.appendChild(item);
                });
            }
        
            // --- ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÊô∫ËÉΩÂÆö‰ΩçÈÄªËæë ‚ñº‚ñº‚ñº ---
        
            // 2. Ëé∑ÂèñÂøÖË¶ÅÁöÑÂ∞∫ÂØ∏Âíå‰ΩçÁΩÆ‰ø°ÊÅØ
            const btnRect = buttonElement.getBoundingClientRect();
            const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();
            
            panel.style.display = 'flex'; // ÂÖàÊòæÁ§∫Âá∫Êù•ÊâçËÉΩËé∑ÂèñÂ∞∫ÂØ∏
            const panelRect = panel.getBoundingClientRect();
            const panelHeight = panelRect.height;
            const panelWidth = panelRect.width;
        
            // 3. ËÆ°ÁÆóÂûÇÁõ¥‰ΩçÁΩÆ (‰øùÊåÅ‰∏çÂèòÔºåÊÄªÊòØÂá∫Áé∞Âú®ÊåâÈíÆ‰∏äÊñπ)
            panel.style.top = `${btnRect.top - panelHeight - 5 - phoneScreenRect.top}px`;
        
            // 4. ËÆ°ÁÆóÂπ∂Âà§Êñ≠Ê∞¥Âπ≥‰ΩçÁΩÆ
            const desiredLeftPosition = btnRect.left - phoneScreenRect.left;
        
            // Â¶ÇÊûúÈù¢ÊùøÁöÑÂ∑¶‰æß‰ΩçÁΩÆ + Ëá™Ë∫´ÂÆΩÂ∫¶ > ÊâãÊú∫Â±èÂπïÂÆΩÂ∫¶ÔºåËØ¥Êòé‰ºöË∂ÖÂá∫
            if (desiredLeftPosition + panelWidth > phoneScreenRect.width) {
                // Â¶ÇÊûú‰ºöË∂ÖÂá∫ÔºåÂàôÊîπ‰∏∫Ë¥¥ÁùÄÂ±èÂπïÂè≥‰æßËæπÁºòÊòæÁ§∫ (Áïô5pxËæπË∑ù)
                panel.style.left = 'auto';
                panel.style.right = '5px';
            } else {
                // Â¶ÇÊûú‰∏ç‰ºöË∂ÖÂá∫ÔºåÂàôÊ≠£Â∏∏ÂØπÈΩêÊåâÈíÆÂ∑¶‰æß
                panel.style.left = `${desiredLeftPosition}px`;
                panel.style.right = 'auto';
            }
            
            // --- ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ ---
        
            // 5. Êõ¥Êñ∞Áä∂ÊÄÅ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            qzoneStickerPanelState.isOpen = true;
            qzoneStickerPanelState.activePostId = postId;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞ openQzoneStickerPanel ÂáΩÊï∞ÁöÑÂêéÈù¢ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂÖ≥Èó≠Âä®ÊÄÅËØÑËÆ∫Âå∫ÁöÑË°®ÊÉÖÈù¢Êùø
         */
        function closeQzoneStickerPanel() {
            // Ê£ÄÊü•Áä∂ÊÄÅÔºåÁ°Æ‰øùÈù¢ÊùøÊòØÊâìÂºÄÁöÑ
            if (qzoneStickerPanelState.isOpen) {
                // ÈöêËóèÈù¢ÊùøDOMÂÖÉÁ¥†
                qzoneStickerPanelState.panelEl.style.display = 'none';
                
                // ÈáçÁΩÆÁä∂ÊÄÅÂèòÈáè
                qzoneStickerPanelState.isOpen = false;
                qzoneStickerPanelState.activePostId = null;
            }
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊñ∞‰ª£Á†ÅÂùó„ÄëÊõøÊç¢ÊóßÁöÑ sendQzoneStickerComment ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞ÂçáÁ∫ßÁâà„ÄëÂèëÈÄÅÂä®ÊÄÅË°®ÊÉÖËØÑËÆ∫ÔºåÂπ∂ÂëäÁü•AIÂÖ∂Âê´‰πâ
         * @param {number} postId - Â∏ñÂ≠êID
         * @param {object} sticker - ÂÆåÊï¥ÁöÑË°®ÊÉÖÂØπË±° { url, name }
         */
        async function sendQzoneStickerComment(postId, sticker) {
            if (!sticker || !sticker.url) return;
        
            const post = await db.qzonePosts.get(postId);
            if (!post) {
                console.error("sendQzoneStickerComment: Êâæ‰∏çÂà∞Â∏ñÂ≠ê:", postId);
                return;
            }
        
            if (!post.comments) {
                post.comments = [];
            }
            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§çÔºöÂú®ËøôÈáå‰∏∫ÊÇ®ÂèëÈÄÅÁöÑË°®ÊÉÖ‰πüÊ∑ªÂä† meaning Â≠óÊÆµ ‚ñº‚ñº‚ñº
            const newComment = {
                commenterName: state.qzoneSettings.nickname,
                text: sticker.url,
                meaning: sticker.name, // ‰øùÂ≠òË°®ÊÉÖÁöÑÂê´‰πâ
                timestamp: Date.now()
            };
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            post.comments.push(newComment);
        
            await db.qzonePosts.update(postId, { comments: post.comments });
        
            closeQzoneStickerPanel();
            await renderQzonePosts();
            
            const postSummary = (post.publicText || post.content || `[ÂõæÁâáÂä®ÊÄÅ]`).substring(0, 30);
            
            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§çÔºöÈÄöÁü•AIÊó∂ÔºåÊòéÁ°ÆÂëäÁü•Ë°®ÊÉÖÁöÑÂê´‰πâ ‚ñº‚ñº‚ñº
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (!chat.isGroup) {
                    const intelligentPrompt = `[Á≥ªÁªüÊèêÁ§∫Ôºö'${state.qzoneSettings.nickname}' Âú®‰Ω†ÁöÑÂä®ÊÄÅ(ID: ${postId}, ÂÜÖÂÆπÊëòË¶Å: ‚Äú${postSummary}‚Äù)‰∏ãÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${sticker.name}‚Äù„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;
                    
                    const historyMessage = { 
                        role: 'system', 
                        content: intelligentPrompt, 
                        timestamp: Date.now(), 
                        isHidden: true 
                    };
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøô‰∏â‰∏™ÂáΩÊï∞ÊòØËΩ¨ÂèëÂäüËÉΩÁöÑÊ†∏ÂøÉÔºåËØ∑Â∞ÜÂÆÉ‰ª¨Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄËΩ¨ÂèëËØÑËÆ∫ÁöÑÊ®°ÊÄÅÊ°Ü
         * @param {number} postId - Ë¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅÁöÑID
         */
        function openRepostModal(postId) {
            repostTargetId = postId;
            document.getElementById('repost-comment-input').value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('repost-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèËΩ¨ÂèëÊ®°ÊÄÅÊ°Ü
         */
        function hideRepostModal() {
            document.getElementById('repost-modal').classList.remove('visible');
            repostTargetId = null;
        }
        
        /**
         * Â§ÑÁêÜÁ°ÆËÆ§ËΩ¨ÂèëÁöÑÈÄªËæë
         */
        async function handleConfirmRepost() {
            if (!repostTargetId) return;
        
            const comment = document.getElementById('repost-comment-input').value.trim();
            const originalPost = await db.qzonePosts.get(repostTargetId);
        
            if (!originalPost) {
                alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞Ë¶ÅËΩ¨ÂèëÁöÑÂéüÂßãÂä®ÊÄÅ„ÄÇ");
                hideRepostModal();
                return;
            }
        
            const newPost = {
                type: 'repost', // Ê†áËÆ∞‰∏∫ËΩ¨ÂèëÁ±ªÂûã
                timestamp: Date.now(),
                authorId: 'user', // ËΩ¨ÂèëËÄÖÊ∞∏ËøúÊòØÂΩìÂâçÁî®Êà∑
                repostComment: comment,
                originalPost: originalPost, // Â∞ÜÂéüÂßãÂä®ÊÄÅÂÆåÊï¥Âú∞ÂµåÂÖ•Êñ∞Âä®ÊÄÅ‰∏≠
                visibleGroupIds: null // ËΩ¨ÂèëÁöÑÂä®ÊÄÅÈªòËÆ§ÂØπÊâÄÊúâ‰∫∫ÂèØËßÅ
            };
        
            await db.qzonePosts.add(newPost);
            hideRepostModal();
            await renderQzonePosts();
            alert('ËΩ¨ÂèëÊàêÂäüÔºÅ');
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤             
        // ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢Ëøô‰∏™„ÄêÊõ¥Êñ∞ÂêéÁöÑ„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†‰ª£Á†Å‰∏≠ÊóßÁöÑ displayFilteredFavorites ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        function displayFilteredFavorites(items) {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';
        
            if (items.length === 0) {
                const searchTerm = document.getElementById('favorites-search-input').value;
                const message = searchTerm ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êî∂Ëóè' : '‰Ω†ÁöÑÊî∂ËóèÂ§πÊòØÁ©∫ÁöÑÔºå<br>Âø´ÂéªÂä®ÊÄÅÊàñËÅäÂ§©‰∏≠Êî∂ËóèÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂêßÔºÅ';
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                return;
            }
        
            for (const item of items) {
                const card = document.createElement('div');
                card.className = 'favorite-item-card';
                card.dataset.favid = item.id;
        
                let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';
        
                if (item.type === 'qzone_post') {
                    const post = item.content;
                    sourceText = 'Êù•Ëá™Âä®ÊÄÅ';
                    let authorAvatar = defaultAvatar, authorNickname = 'Êú™Áü•Áî®Êà∑';
        
                    if (post.authorId === 'user') {
                        authorAvatar = state.qzoneSettings.avatar;
                        authorNickname = state.qzoneSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                        authorNickname = state.chats[post.authorId].name;
                    }
        
                    headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                    
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                    } else if (post.type === 'image_post' && post.imageUrl) {
    const postImageUrl = post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : (post.imageUrl || 'https://i.postimg.cc/KYr2qRCK/1.jpg');
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
} else if (post.type === 'text_image') {
    const postImageUrl = post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                    }
        
                    // ‚ñº‚ñº‚ñº Êñ∞Â¢û/‰øÆÊîπÁöÑ‰ª£Á†ÅÂºÄÂßã ‚ñº‚ñº‚ñº
                    
                    // 1. ÊûÑÈÄ†ÁÇπËµûÂå∫ÂüüÁöÑHTML
                    let likesHtml = '';
                    // Ê£ÄÊü• post ÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú® likes Êï∞ÁªÑÂπ∂‰∏î‰∏ç‰∏∫Á©∫
                    if (post.likes && post.likes.length > 0) {
                        // Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞±ÂàõÂª∫ÁÇπËµûÂå∫ÂüüÁöÑ div
                        likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('„ÄÅ')} ËßâÂæóÂæàËµû</span>
                            </div>`;
                    }
        
                    // 2. ÊûÑÈÄ†ËØÑËÆ∫Âå∫ÂüüÁöÑHTML
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÂêë‰∏ãÂÖºÂÆπÁöÑ‰ª£Á†ÅÂùóÊõøÊç¢ÊóßÁöÑ if(post.comments...) ÈÄªËæë ‚ñº‚ñº‚ñº
        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
            commentsHtml = '<div class="post-comments-container">';
            post.comments.forEach((comment, index) => {
                // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂú®ËøôÈáåÂà§Êñ≠ËØÑËÆ∫ÁöÑÊï∞ÊçÆÊ†ºÂºè ---
                if (typeof comment === 'object' && comment !== null && comment.commenterName) {
                    // --- ËøôÊòØÊñ∞Ê†ºÂºèÁöÑ„ÄÅÂäüËÉΩÂÆåÊï¥ÁöÑËØÑËÆ∫ ---
                    const commenterOriginalName = comment.commenterName;
                    const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);
                    
                    let innerCommentContent;
                    if (STICKER_REGEX.test(comment.text)) {
                        innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
                    } else {
                        innerCommentContent = comment.text;
                    }
        
                    let commentLineHtml = '';
                    if (comment.replyTo) {
                        const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
                    } else {
                        commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
                    }
                    
                    commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                        <div class="comment-text">${commentLineHtml}</div>
                                        <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                     </div>`;
        
                } else {
                    // --- ËøôÊòØÊóßÊ†ºÂºèÁöÑ„ÄÅÂè™ÂÅöÊòæÁ§∫ÁöÑËØÑËÆ∫ ---
                    // Êàë‰ª¨ÊääÂÆÉÊ∏≤ÊüìÊàê‰∏Ä‰∏™Ê≤°Êúâ‰∫§‰∫í„ÄÅÊ≤°ÊúâdataÂ±ûÊÄßÁöÑÁÆÄÂçïdivÔºå‰ªéËÄåÈÅøÂÖçÊä•Èîô
                    commentsHtml += `<div class="legacy-comment-item">
                                        <span class="comment-text">${String(comment)}</span>
                                     </div>`;
                }
            });
            commentsHtml += '</div>';
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // 3. Â∞ÜÁÇπËµûÂíåËØÑËÆ∫ÁöÑHTMLÁªÑÂêàÂà∞ footerHtml ‰∏≠
                    footerHtml = `${likesHtml}${commentsHtml}`;
                    
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û/‰øÆÊîπÁöÑ‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        } else if (item.type === 'chat_message') {
            const msg = item.content;
            const chat = state.chats[item.chatId];
            if (!chat) continue; 
        
            sourceText = `Êù•Ëá™‰∏é ${chat.name} ÁöÑËÅäÂ§©`;
            const isUser = msg.role === 'user';
            let senderName, senderAvatar;
        
            if (isUser) {
                // Áî®Êà∑Ê∂àÊÅØÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
                senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
            } else { // AI/ÊàêÂëòÊ∂àÊÅØ
                 if (chat.isGroup) {
                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    // Êàë‰ª¨Áé∞Âú®‰ΩøÁî® originalName ÂéªÂåπÈÖçÔºåËÄå‰∏çÊòØÊóßÁöÑ name
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    
                    senderName = msg.senderName;
                    // Âõ†‰∏∫Áé∞Âú®ËÉΩÊ≠£Á°ÆÊâæÂà∞ member ÂØπË±°‰∫ÜÔºåÊâÄ‰ª•‰πüËÉΩÊ≠£Á°ÆËé∑ÂèñÂà∞‰ªñÁöÑÂ§¥ÂÉè
                    senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                } else {
                    // ÂçïËÅäÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
                    senderName = chat.name;
                    senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
            }
        
            // ÂêéÁª≠ÊãºÊé• headerHtml Âíå contentHtml ÁöÑÈÄªËæëÈÉΩ‰øùÊåÅ‰∏çÂèò
            headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
            
            if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
        }
                
                // ‚ñº‚ñº‚ñº ‰øÆÊîπÊúÄÁªàÁöÑHTMLÊãºÊé•ÔºåÂä†ÂÖ• footerHtml ‚ñº‚ñº‚ñº
                card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`; // <-- ÊääÊàë‰ª¨Êñ∞ÂàõÂª∫ÁöÑ footerHtml ÊîæÂú®ËøôÈáå
                    
                listEl.appendChild(card);
            }
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢Âå∫ÂüüÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                /**
                 * „ÄêÈáçÊûÑÂêéÁöÑÂáΩÊï∞„Äë: Ë¥üË¥£ÂáÜÂ§áÊï∞ÊçÆÂπ∂Ëß¶ÂèëÊ∏≤Êüì
                 */
                async function renderFavoritesScreen() {
                    // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÂπ∂ÁºìÂ≠ò
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
                    
                    // 2. Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÂπ∂ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
                    const searchInput = document.getElementById('favorites-search-input');
                    const clearBtn = document.getElementById('favorites-search-clear-btn');
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
        
                    // 3. ÊòæÁ§∫ÊâÄÊúâÊî∂ËóèÈ°π
                    displayFilteredFavorites(allFavoriteItems);
                }
        
                // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                function resetCreatePostModal() {
                    document.getElementById('post-public-text').value = '';
                    document.getElementById('post-image-preview').src = '';
                    document.getElementById('post-image-description').value = '';
                    document.getElementById('post-image-preview-container').classList.remove('visible');
                    document.getElementById('post-image-desc-group').style.display = 'none';
                    document.getElementById('post-local-image-input').value = '';
                    document.getElementById('post-hidden-text').value = '';
                    document.getElementById('switch-to-image-mode').click();
                }
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÊ∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÁöÑÊ†∏ÂøÉÂäüËÉΩÔºåËØ∑ÂÆåÊï¥Á≤òË¥¥ ‚ñº‚ñº‚ñº
/**
 * „ÄêÂÖ®Êñ∞„Äë‰∏ÄÈîÆÊ∏ÖÁêÜÊï∞ÊçÆÂ∫ì‰∏≠ÊâÄÊúâ‰∏éÂ∑≤Âà†Èô§ËßíËâ≤ÊàñËÅäÂ§©Áõ∏ÂÖ≥ÁöÑÂ≠§Á´ãÊï∞ÊçÆ
 */
async function cleanupRedundantData() {
    // 1. È¶ñÂÖàÔºåÂêëÁî®Êà∑ÊòæÁ§∫‰∏Ä‰∏™Â∏¶Êúâ‰∏•ÈáçË≠¶ÂëäÁöÑÁ°ÆËÆ§Ê°Ü
    const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºü',
        'Ê≠§Êìç‰ΩúÂ∞ÜÊâ´ÊèèÊï¥‰∏™Êï∞ÊçÆÂ∫ìÔºåÁßªÈô§ÊâÄÊúâ‰∏éÂ∑≤Âà†Èô§ËßíËâ≤ÊàñËÅäÂ§©Áõ∏ÂÖ≥ÁöÑÂ≠§Á´ãÊï∞ÊçÆÔºàÂ¶ÇÂä®ÊÄÅ„ÄÅËØÑËÆ∫„ÄÅËÆ∞ÂøÜÁ≠âÔºâ„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºå‰ΩÜÈÄöÂ∏∏ÊòØÂÆâÂÖ®ÁöÑ„ÄÇ</strong><br><br>Âª∫ËÆÆÂú®Êìç‰ΩúÂâçÂÖàÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩ„ÄÇ',
        { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§Ê∏ÖÁêÜ' }
    );

    if (!confirmed) return; // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÔºåÂàô‰∏≠Ê≠¢Êìç‰Ωú

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂºÄÂßãÊ∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");
    console.log("ÂÜó‰ΩôÊï∞ÊçÆÊ∏ÖÁêÜÊµÅÁ®ãÂ∑≤ÂêØÂä®...");

    // Áî®‰∫éÁªüËÆ°Ê∏ÖÁêÜÁªìÊûúÁöÑÂØπË±°
    let cleanupCounts = {
        posts: 0,
        likes: 0,
        comments: 0,
        memories: 0,
        callRecords: 0,
        renderingRules: 0,
        groupMembers: 0,
        chatLinks: 0,
    };

    try {
        // ‰ΩøÁî®Êï∞ÊçÆÂ∫ì‰∫ãÂä°Êù•Á°Æ‰øùÊâÄÊúâÊìç‰ΩúË¶Å‰πàÂÖ®ÈÉ®ÊàêÂäüÔºåË¶Å‰πàÂÖ®ÈÉ®Â§±Ë¥•Ôºå‰øùËØÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄß
        await db.transaction('rw', db.tables, async () => {
            // Ê≠•È™§ A: Âª∫Á´ãÊâÄÊúâÊúâÊïàËÅäÂ§©ÂíåËßíËâ≤ÁöÑ‚ÄúÁôΩÂêçÂçï‚Äù
            const allChats = await db.chats.toArray();
            const existingChatIds = new Set(allChats.map(c => c.id));
            const existingOriginalNames = new Set(allChats.filter(c => !c.isGroup).map(c => c.originalName));
            existingOriginalNames.add(state.qzoneSettings.nickname || '{{user}}'); // ÊääÁî®Êà∑Ëá™Â∑±‰πüÂä†Âà∞ÁôΩÂêçÂçï

            // Ê≠•È™§ B: ÈÄê‰∏ÄÊ∏ÖÁêÜÂêÑ‰∏™Êï∞ÊçÆË°®
            
            // Ê∏ÖÁêÜÂä®ÊÄÅ (QZone Posts)
            const allPosts = await db.qzonePosts.toArray();
            for (const post of allPosts) {
                let postModified = false;
                // Âà†Èô§‰ΩúËÄÖ‰∏çÂ≠òÂú®ÁöÑÂä®ÊÄÅ
                if (post.authorId !== 'user' && !existingChatIds.has(post.authorId)) {
                    await db.qzonePosts.delete(post.id);
                    cleanupCounts.posts++;
                    console.log(`Âà†Èô§‰∫ÜÂ≠§Á´ãÂä®ÊÄÅ (ID: ${post.id})Ôºå‰ΩúËÄÖ ${post.authorId} Â∑≤‰∏çÂ≠òÂú®„ÄÇ`);
                    continue; // Â∏ñÂ≠êÂ∑≤Âà†Èô§ÔºåË∑≥ËøáÂêéÁª≠Â§ÑÁêÜ
                }

                // Ê∏ÖÁêÜÁÇπËµûÂàóË°®‰∏≠ÁöÑÊó†ÊïàÁî®Êà∑
                if (post.likes && post.likes.length > 0) {
                    const originalLikeCount = post.likes.length;
                    post.likes = post.likes.filter(name => existingOriginalNames.has(name));
                    if (post.likes.length < originalLikeCount) {
                        cleanupCounts.likes += (originalLikeCount - post.likes.length);
                        postModified = true;
                    }
                }

                // Ê∏ÖÁêÜËØÑËÆ∫ÂàóË°®‰∏≠ÁöÑÊó†ÊïàÁî®Êà∑
                if (post.comments && post.comments.length > 0) {
                    const originalCommentCount = post.comments.length;
                    post.comments = post.comments.filter(comment => {
                        if (typeof comment === 'object' && comment.commenterName) {
                            return existingOriginalNames.has(comment.commenterName);
                        }
                        return true; // ‰øùÁïôÊó†Ê≥ïÂà§Êñ≠ÁöÑÊóßÊ†ºÂºèËØÑËÆ∫
                    });
                     if (post.comments.length < originalCommentCount) {
                        cleanupCounts.comments += (originalCommentCount - post.comments.length);
                        postModified = true;
                    }
                }
                
                if (postModified) {
                    await db.qzonePosts.put(post);
                }
            }

            // Ê∏ÖÁêÜËÆ∞ÂøÜ (Memories)
            await db.memories.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.memories += c);
            
            // Ê∏ÖÁêÜÈÄöËØùËÆ∞ÂΩï (Call Records)
            await db.callRecords.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.callRecords += c);

            // Ê∏ÖÁêÜÊ∏≤ÊüìËßÑÂàô (Rendering Rules)
            const allRules = await db.renderingRules.toArray();
            for(const rule of allRules) {
                if (rule.chatId !== 'global' && !existingChatIds.has(rule.chatId)) {
                    await db.renderingRules.delete(rule.id);
                    cleanupCounts.renderingRules++;
                }
            }

            // Ê∏ÖÁêÜÁæ§ËÅä‰∏≠ÁöÑÊó†ÊïàÊàêÂëòÂíåËÅäÂ§©‰∏≠ÁöÑÊó†ÊïàÈìæÊé•
            for (const chat of allChats) {
                 let chatModified = false;
                 // Ê∏ÖÁêÜÁæ§ÊàêÂëò
                 if (chat.isGroup && chat.members) {
                     const originalMemberCount = chat.members.length;
                     chat.members = chat.members.filter(member => existingChatIds.has(member.id));
                     if (chat.members.length < originalMemberCount) {
                        cleanupCounts.groupMembers += (originalMemberCount - chat.members.length);
                        chatModified = true;
                     }
                 }
                 // Ê∏ÖÁêÜÊó†ÊïàÁöÑÊåÇËΩΩËÆ∞ÂøÜÈìæÊé•
                 if (chat.settings?.linkedMemoryChatIds?.length > 0) {
                     const originalLinkCount = chat.settings.linkedMemoryChatIds.length;
                     chat.settings.linkedMemoryChatIds = chat.settings.linkedMemoryChatIds.filter(id => existingChatIds.has(id));
                     if (chat.settings.linkedMemoryChatIds.length < originalLinkCount) {
                        cleanupCounts.chatLinks += (originalLinkCount - chat.settings.linkedMemoryChatIds.length);
                        chatModified = true;
                     }
                 }
                 if(chatModified) {
                     await db.chats.put(chat);
                 }
            }
        }); // ‰∫ãÂä°ÁªìÊùü

        // 2. ÂêëÁî®Êà∑Êä•ÂëäÊ∏ÖÁêÜÁªìÊûú
        let summary = "‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºÅ\n\n";
        let cleanedSomething = false;
        Object.entries(cleanupCounts).forEach(([key, value]) => {
            if (value > 0) {
                const keyMap = {
                    posts: 'Âä®ÊÄÅ', likes: 'ÁÇπËµû', comments: 'ËØÑËÆ∫', memories: 'ËÆ∞ÂøÜ',
                    callRecords: 'ÈÄöËØùËÆ∞ÂΩï', renderingRules: 'Ê∏≤ÊüìËßÑÂàô',
                    groupMembers: 'Áæ§ÊàêÂëò', chatLinks: 'ËÆ∞ÂøÜÈìæÊé•'
                };
                summary += `- Ê∏ÖÁêÜ‰∫Ü ${value} Êù°Êó†ÊïàÁöÑ${keyMap[key] || key}„ÄÇ\n`;
                cleanedSomething = true;
            }
        });
        if (!cleanedSomething) {
            summary = "‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºåÊú™ÂèëÁé∞‰ªª‰ΩïÂÜó‰ΩôÊï∞ÊçÆ„ÄÇ";
        }
        summary += "\nÂª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Á°Æ‰øùÊâÄÊúâÊõ¥ÊîπÁîüÊïà„ÄÇ";

        await showCustomAlert("Êìç‰ΩúÊàêÂäü", summary);
        
        // 3. Âª∫ËÆÆÁî®Êà∑Âà∑Êñ∞È°µÈù¢
        const confirmedReload = await showCustomConfirm("Âà∑Êñ∞È°µÈù¢Ôºü", "‰∏∫‰∫ÜÁ°Æ‰øùÊâÄÊúâÊï∞ÊçÆÂêåÊ≠•ÔºåÂª∫ËÆÆÁ´ãÂç≥Âà∑Êñ∞È°µÈù¢„ÄÇ");
        if(confirmedReload) {
            location.reload();
        }

    } catch (error) {
        console.error("Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÊó∂Âá∫Èîô:", error);
        await showCustomAlert('Ê∏ÖÁêÜÂ§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤        
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÂØºÂá∫ÂáΩÊï∞‰øÆÂ§çÁâà„Äë ‚ñº‚ñº‚ñº
        async function exportBackup() {
            try {
                const backupData = {
                    version: 1, 
                    timestamp: Date.now()
                };
        
                const [
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ËøôÈáåÊ∑ªÂä†Áº∫Â§±ÁöÑÂèòÈáè„Äë
                    renderingRules, fonts, jsonConfigs
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.worldBooks.toArray(),
                    db.userStickers.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.personaPresets.toArray(),
                    db.musicLibrary.get('main'),
                    db.qzoneSettings.get('main'),
                    db.qzonePosts.toArray(),
                    db.qzoneAlbums.toArray(),
                    db.qzonePhotos.toArray(),
                    db.favorites.toArray(),
                    db.qzoneGroups.toArray(),
                    db.memories.toArray(),
                    db.worldBookCategories.toArray(),
                    db.apiPresets.toArray(),
                    db.shoppingProducts.toArray(),
                    db.callRecords.toArray(),
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2ÔºöÂú®ËøôÈáåÊ∑ªÂä†ÂØπÊñ∞Êï∞ÊçÆË°®ÁöÑËØªÂèñ„Äë
                    db.renderingRules.toArray(),
                    db.fonts.toArray(),
                    db.jsonConfigs.toArray()
                ]);
        
                Object.assign(backupData, {
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories, worldBookCategories,
                    apiPresets, shoppingProducts, callRecords,
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç3ÔºöÂ∞ÜÊñ∞Êï∞ÊçÆÊ∑ªÂä†Âà∞Â§á‰ªΩÂØπË±°‰∏≠„Äë
                    renderingRules, fonts, jsonConfigs
                });
                
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = Object.assign(document.createElement('a'), {
                    href: url,
                    download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                });
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');
        
            } catch (error) {
                console.error("ÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
                await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
            }
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤ÂåÖÂê´ memories„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ importBackup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÂØºÂÖ•ÂáΩÊï∞‰øÆÂ§çÁâà„Äë ‚ñº‚ñº‚ñº
        async function importBackup(file) {
            if (!file) return;
        
            const confirmed = await showCustomConfirm(
                '‰∏•ÈáçË≠¶ÂëäÔºÅ',
                'ÂØºÂÖ•Â§á‰ªΩÂ∞ÜÂÆåÂÖ®Ë¶ÜÁõñÊÇ®ÂΩìÂâçÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨ËÅäÂ§©„ÄÅÂä®ÊÄÅ„ÄÅËÆæÁΩÆÁ≠â„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅÊÇ®Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü',
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (!confirmed) return;
        
            try {
                const text = await file.text();
                const data = JSON.parse(text);
        
                await db.transaction('rw', db.tables, async () => {
                    for (const table of db.tables) {
                        await table.clear();
                    }
        
                    if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏ñÁïå‰π¶ÊóßÁâàÊú¨Êï∞ÊçÆÂÖºÂÆπ‰ª£Á†Å ‚ñº‚ñº‚ñº
if (data.worldBooks && Array.isArray(data.worldBooks)) {
    console.log("Ê≠£Âú®Ê£ÄÊü•‰∏ñÁïå‰π¶Êï∞ÊçÆÊ†ºÂºè‰ª•Á°Æ‰øùÂÖºÂÆπÊÄß...");
    data.worldBooks.forEach(book => {
        // Ê£ÄÊü• content Â≠óÊÆµÊòØÂê¶ÊòØÊóßÁöÑÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
        if (typeof book.content === 'string') {
            console.log(`Ê£ÄÊµãÂà∞ÊóßÊ†ºÂºèÁöÑ‰∏ñÁïå‰π¶: "${book.name}"ÔºåÊ≠£Âú®Ëá™Âä®ËøÅÁßª...`);
            
            // Â∞ÜÊóßÁöÑÂ≠óÁ¨¶‰∏≤ÂÜÖÂÆπ‰øùÂ≠ò‰∏ãÊù•
            const oldContentString = book.content;

            // „ÄêÊ†∏ÂøÉËΩ¨Êç¢„ÄëÂ∞ÜÂ≠óÁ¨¶‰∏≤ÊõøÊç¢‰∏∫Êñ∞ÁöÑÊï∞ÁªÑÊ†ºÂºè
            book.content = [{
                keys: [], // ÈªòËÆ§‰∏∫Á©∫ÂÖ≥ÈîÆËØç
                comment: "‰ªéÊóßÁâàÊú¨Ëá™Âä®ËøÅÁßªÁöÑÊù°ÁõÆ", // Ê∑ªÂä†‰∏Ä‰∏™Â§áÊ≥®
                content: oldContentString, // Â∞ÜÊóßÁöÑÊñáÊú¨ÊîæÂÖ•Êñ∞ÁªìÊûÑ‰∏≠
                enabled: true // ÈªòËÆ§ÂêØÁî®
            }];
        }
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
                    if (Array.isArray(data.worldBookCategories)) await db.worldBookCategories.bulkPut(data.worldBookCategories);
                    if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
                    if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
                    if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
                    if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
                    if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
                    if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
                    if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
                    if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories);
                    
                    if (Array.isArray(data.apiPresets)) await db.apiPresets.bulkPut(data.apiPresets);
                    if (Array.isArray(data.shoppingProducts)) await db.shoppingProducts.bulkPut(data.shoppingProducts);
                    if (Array.isArray(data.callRecords)) await db.callRecords.bulkPut(data.callRecords);
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§çÔºöÂú®ËøôÈáåÊ∑ªÂä†ÂØπÊ∏≤ÊüìËßÑÂàôÊï∞ÊçÆÁöÑÂÜôÂÖ•Êìç‰Ωú„Äë
                    if (Array.isArray(data.renderingRules)) await db.renderingRules.bulkPut(data.renderingRules);
                    // „ÄêÊñ∞Â¢ûÔºöÊ∑ªÂä†ÂØπÂ≠ó‰ΩìÂíåJSONÈÖçÁΩÆÁöÑÂØºÂÖ•ÊîØÊåÅ„Äë
                    if (Array.isArray(data.fonts)) await db.fonts.bulkPut(data.fonts);
                    if (Array.isArray(data.jsonConfigs)) await db.jsonConfigs.bulkPut(data.jsonConfigs);
        
                    if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
                    if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
                    if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
                    if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
                });
        
                // ÂØºÂÖ•ÊàêÂäüÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÂπ∂Ê∏≤ÊüìÁïåÈù¢
                await loadAllDataFromDB();
                
                // ÈáçÊñ∞Ê∏≤ÊüìÁõ∏ÂÖ≥ÁïåÈù¢
                if (typeof renderJsonConfigsList === 'function') {
                    await renderJsonConfigsList();
                }
                if (typeof renderIconSettings === 'function') {
                    renderIconSettings();
                }
                if (typeof renderFontLibrary === 'function') {
                    await renderFontLibrary();
                }
                
                await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅÂåÖÊã¨JSONÁæéÂåñÈÖçÁΩÆÂíåÂ≠ó‰ΩìËÆæÁΩÆ„ÄÇ');
                
                // Âª∂ËøüÂà∑Êñ∞‰ª•Á°Æ‰øùÊï∞ÊçÆÂÆåÂÖ®Âä†ËΩΩ
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
        
            } catch (error) {
                console.error("ÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
                await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè: ${error.message}`);
            }
        }
        
                function applyCustomFont(fontUrl, isPreviewOnly = false) {
                    if (!fontUrl) {
                        dynamicFontStyle.innerHTML = '';
                        document.getElementById('font-preview').style.fontFamily = '';
                        return;
                    }
                    const fontName = 'custom-user-font';
                    const newStyle = `
                        @font-face {
                          font-family: '${fontName}';
                          src: url('${fontUrl}');
                          font-display: swap;
                        }`;
                    if (isPreviewOnly) {
                        const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                        previewStyle.id = 'preview-font-style';
                        previewStyle.innerHTML = newStyle;
                        if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
                    } else {
                        dynamicFontStyle.innerHTML = `
                            ${newStyle}
                            body {
                              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            }`;
                    }
                }
        
                async function resetToDefaultFont() {
                    dynamicFontStyle.innerHTML = ''; 
                    state.globalSettings.fontUrl = '';
                    await db.globalSettings.put(state.globalSettings);
                    document.getElementById('font-url-input').value = '';
                    document.getElementById('font-preview').style.fontFamily = '';
                    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì„ÄÇ');
                }
        
// ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤ÂΩªÂ∫ï‰øÆÂ§çÊï∞ÊçÆËøÅÁßªÂíåËØ≠Ê≥ïÈîôËØØ„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ loadAllDataFromDB ÂáΩÊï∞ ‚ñº‚ñº‚ñº
async function loadAllDataFromDB() {
    const [
        chatsArr, apiConfig, globalSettings, userStickers, worldBooks,
        musicLib, personaPresets, qzoneSettings, initialFavorites,
        allMemories, fonts, jsonConfigs
    ] = await Promise.all([
        db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
        db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
        db.personaPresets.toArray(), db.qzoneSettings.get('main'), db.favorites.orderBy('timestamp').reverse().toArray(),
        db.memories.toArray(), db.fonts.toArray(), db.jsonConfigs.toArray()
    ]);

    chatsArr.forEach(chat => {
        if (!chat.settings.lyricsPosition) {
            chat.settings.lyricsPosition = { vertical: 'top', horizontal: 'center', offset: 10 };
        }
        if (!chat.isGroup && !chat.settings.myAvatarLibrary) {
            chat.settings.myAvatarLibrary = [];
        }
        if (!chat.isGroup && typeof chat.originalName === 'undefined') {
            chat.originalName = chat.name;
        }
    });

    state.chats = chatsArr.reduce((acc, chat) => {
        if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
        if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
            chat.members.forEach(member => {
                if (typeof member.originalName === 'undefined') {
                    member.originalName = member.name;
                    member.groupNickname = member.name;
                    delete member.name;
                }
            });
        }
        
        if (!chat.settings) chat.settings = {};
        if (typeof chat.settings.actionCooldownMinutes === 'undefined') {
            chat.settings.actionCooldownMinutes = 10;
        }
        if (!chat.isGroup && !chat.status) chat.status = { text: 'Âú®Á∫ø', lastUpdate: Date.now(), isBusy: false };
        if (!chat.isGroup && !chat.relationship) chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
        if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) { if (!chat.settings) chat.settings = {}; chat.settings.aiAvatarLibrary = []; }
        if (chat.isGroup) { (chat.members || []).forEach(member => { if (typeof member.avatarFrame === 'undefined') member.avatarFrame = ''; }); }
        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; }
        if (typeof chat.isPinned === 'undefined') chat.isPinned = false;
        if (!chat.isGroup && typeof chat.settings.myNickname === 'undefined') {
            chat.settings.myNickname = 'Êàë';
        }
        if (chat.isGroup && chat.members) {
            let needsUpdate = false;
            chatsArr.forEach(c => {
                 if (c.id === chat.id && c.originalName) {
                    delete c.originalName;
                 }
            });
            chat.members.forEach(member => {
                const originalCharacter = chatsArr.find(c => c.id === member.id);
                if (originalCharacter && originalCharacter.settings) {
                    const correctFrame = originalCharacter.settings.aiAvatarFrame || '';
                    if (member.avatarFrame !== correctFrame) {
                        member.avatarFrame = correctFrame;
                        needsUpdate = true;
                    }
                } else if (typeof member.avatarFrame === 'undefined') {
                    member.avatarFrame = '';
                    needsUpdate = true;
                }
            });
            if (needsUpdate) db.chats.put(chat);
        }
        if (!chat.settings.enableAutoMemory) chat.settings.enableAutoMemory = false;
        if (!chat.settings.autoMemoryInterval) chat.settings.autoMemoryInterval = 20;
        if (!chat.longTermMemory) chat.longTermMemory = [];
        if (!chat.lastMemorySummaryTimestamp) chat.lastMemorySummaryTimestamp = 0;
        if (!chat.isGroup) {
            if (typeof chat.settings.isOfflineMode === 'undefined') chat.settings.isOfflineMode = false;
            if (typeof chat.settings.offlineMinLength === 'undefined') chat.settings.offlineMinLength = 100;
            if (typeof chat.settings.offlineMaxLength === 'undefined') chat.settings.offlineMaxLength = 300;
            if (typeof chat.heartfeltVoice === 'undefined') chat.heartfeltVoice = '...';
            if (typeof chat.randomJottings === 'undefined') chat.randomJottings = '...';
            if (!Array.isArray(chat.thoughtsHistory)) {
                chat.thoughtsHistory = [];
            }
        }
        acc[chat.id] = chat;
        return acc;
    }, {});

    const memoriesToUpdate = [];
    allMemories.forEach(memory => {
        if (memory.type === 'ai_generated' && memory.authorName && !memory.authorId) {
            const foundChat = chatsArr.find(c => !c.isGroup && c.originalName === memory.authorName);
            
            if (foundChat) {
                memory.authorId = foundChat.id;
                memoriesToUpdate.push(memory);
            } else {
                 const fallbackChat = chatsArr.find(c => !c.isGroup && c.name === memory.authorName);
                 if(fallbackChat) {
                    memory.authorId = fallbackChat.id;
                    memoriesToUpdate.push(memory);
                 }
            }
        }
    });

    if (memoriesToUpdate.length > 0) {
        await db.memories.bulkPut(memoriesToUpdate);
    }

    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '', secondaryProxyUrl: '', secondaryApiKey: '', secondaryModel: '' };
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ V2 ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ state.globalSettings ÂàùÂßãÂåñ‰ª£Á†Å ‚ñº‚ñº‚ñº
state.globalSettings = globalSettings || { 
    id: 'main', 
    showStatusBar: false, // <-- Êñ∞Â¢ûËøô‰∏ÄË°åÔºåÈªòËÆ§ÂÖ≥Èó≠
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60, 
    blockCooldownHours: 1, 
    appIcons: { ...DEFAULT_APP_ICONS },
    globalCss: '',
    notificationSoundUrl: '',
    widgetData: {} // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊñ∞Â¢û‰∏Ä‰∏™Á©∫ÂØπË±°
};
// Á°Æ‰øùÂç≥‰Ωø‰ªéÊóßÊï∞ÊçÆÂ∫ìÂä†ËΩΩÔºåËøô‰∏™Â±ûÊÄß‰πüÂ≠òÂú®
if (!state.globalSettings.widgetData) {
    state.globalSettings.widgetData = {};
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
    // „Äê„Äê„ÄêËøôÂ∞±ÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÂ§çÔºÅ„Äë„Äë„Äë
    // ‰∏ãÈù¢ËøôË°å‰ª£Á†ÅÁ°Æ‰øù‰∫ÜÂç≥‰ΩøÊòØ‰ªéÊóßÊï∞ÊçÆÂ∫ìÂä†ËΩΩÁöÑÊï∞ÊçÆÔºå‰πüËÉΩÊã•Êúâ appIcons Ëøô‰∏™Â±ûÊÄßÔºåÈÅøÂÖç‰∫ÜÂêéÁª≠‰ª£Á†ÅÂá∫Èîô„ÄÇ
    state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };
    if (!state.globalSettings.globalCss) state.globalSettings.globalCss = '';
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };
    allFavoriteItems = initialFavorites || [];
    
    // Â≠òÂÇ®Â≠ó‰ΩìÂíåJSONÈÖçÁΩÆÊï∞ÊçÆ
    state.fonts = fonts || [];
    state.jsonConfigs = jsonConfigs || [];
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }
        
                function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        
         // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Áî®Ëøô‰∏™Êõ¥ÂèØÈù†ÁöÑÁâàÊú¨ÔºåÊõøÊç¢ÊóßÁöÑ showNotification ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function showNotification(chatId, messageContent) {
    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
    playNotificationSound();
    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            clearTimeout(notificationTimeout);
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // 1. Ëé∑ÂèñÈÄöÁü•Ê†èÂÖÉÁ¥†
            const bar = document.getElementById('notification-bar');
            
            // 2. Â°´ÂÖÖÂÜÖÂÆπ
            document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
            document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
            document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
            
            // 3. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰ΩøÁî®‚ÄúÂº∫Âà∂ÈáçÊéí‚ÄùÊäÄÂ∑ßÔºåÁ°Æ‰øùÂä®ÁîªÊØèÊ¨°ÈÉΩËÉΩËß¶Âèë
            // ÂÖàÁßªÈô§classÔºåËÆ©ÂÆÉÂõûÂà∞ÂàùÂßãÁöÑ‚ÄúÈöêËóè‚ÄùÁä∂ÊÄÅ
            bar.classList.remove('visible');
            
            // Ëøô‰∏ÄË°åÊòØÂÖ≥ÈîÆÔºÅÂÆÉ‰ºöÂº∫Âà∂ÊµèËßàÂô®ÈáçÊñ∞ËÆ°ÁÆóÂÖÉÁ¥†Â∏ÉÂ±ÄÔºå‰ªéËÄå‚ÄúÈáçÁΩÆ‚ÄùÂä®ÁîªÁä∂ÊÄÅ„ÄÇ
            void bar.offsetWidth; 
            
            // ÂÜçÊ¨°Ê∑ªÂä†classÔºåÊµèËßàÂô®‰ºöËÆ§‰∏∫ËøôÊòØ‰∏Ä‰∏™Êñ∞ÁöÑÁä∂ÊÄÅÂèòÂåñÔºå‰ªéËÄåÂπ≥ÊªëÂú∞ÊâßË°åCSSËøáÊ∏°Âä®Áîª„ÄÇ
            bar.classList.add('visible');
            
            // 4. ‰∏∫ÈÄöÁü•Ê†èÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂Ôºà‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÊ∏ÖÈô§ÊóßÁõëÂê¨Âô®Ôºâ
            const newBar = bar.cloneNode(true);
            bar.parentNode.replaceChild(newBar, bar);
            newBar.addEventListener('click', () => {
                openChat(chatId);
                newBar.classList.remove('visible');
            });
        
            // 5. ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÂú®4ÁßíÂêéËá™Âä®ÈöêËóèÈÄöÁü•
            notificationTimeout = setTimeout(() => {
                newBar.classList.remove('visible');
            }, 4000);
        }
        
               function updateClock() { 
    const now = new Date(); 
    const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); 
    const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); 
    
    // document.getElementById('main-time').textContent = timeString; // Ê≥®ÈáäÊéâËøôË°å
    document.getElementById('status-bar-time').textContent = timeString; 
    // document.getElementById('main-date').textContent = dateString; // Ê≥®ÈáäÊéâËøôË°å
}
        
        
        /**
         * „ÄêÁªàÊûÅÂÅ•Â£ÆÁâà„ÄëËß£ÊûêAIËøîÂõûÁöÑ„ÄÅÂèØËÉΩÊ†ºÂºè‰∏çËßÑËåÉÁöÑÂìçÂ∫îÂÜÖÂÆπ
         * @param {string} content - AIËøîÂõûÁöÑÂéüÂßãÂ≠óÁ¨¶‰∏≤
         * @returns {Array} - ‰∏Ä‰∏™Ê†áÂáÜÂåñÁöÑÊ∂àÊÅØÂØπË±°Êï∞ÁªÑ
         */
        function parseAiResponse(content) {
            const trimmedContent = content.trim();
        
            // ÊñπÊ°à1Ôºö„ÄêÊúÄ‰ºòÂÖà„ÄëÂ∞ùËØï‰Ωú‰∏∫Ê†áÂáÜÁöÑ„ÄÅÂçï‰∏ÄÁöÑJSONÊï∞ÁªÑËß£Êûê
            // ËøôÊòØÊúÄÁêÜÊÉ≥„ÄÅÊúÄÈ´òÊïàÁöÑÊÉÖÂÜµ
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed)) {
                        console.log("Ëß£ÊûêÊàêÂäüÔºöÊ†áÂáÜJSONÊï∞ÁªÑÊ†ºÂºè„ÄÇ");
                        return parsed;
                    }
                } catch (e) {
                    // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåËØ¥ÊòéÂÆÉËôΩÁÑ∂ÁúãËµ∑Êù•ÂÉè‰∏™Êï∞ÁªÑÔºå‰ΩÜÂÜÖÈÉ®Ê†ºÂºèÊúâÈóÆÈ¢ò„ÄÇ
                    // Ê≠§Êó∂Êàë‰ª¨‰∏çÊä•ÈîôÔºåËÄåÊòØÁªßÁª≠Â∞ùËØï‰∏ãÈù¢ÁöÑ‚ÄúÂº∫ÂäõËß£Êûê‚ÄùÊñπÊ°à„ÄÇ
                    console.warn("Ê†áÂáÜJSONÊï∞ÁªÑËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÂº∫ÂäõËß£Êûê...");
                }
            }
        
            // ÊñπÊ°à2Ôºö„ÄêÂº∫ÂäõËß£Êûê„Äë‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÔºå‰ªéÊ∑∑‰π±ÁöÑÂ≠óÁ¨¶‰∏≤‰∏≠ÊèêÂèñÂá∫ÊâÄÊúâÁã¨Á´ãÁöÑJSONÂØπË±°
            // ËøôËÉΩÂÆåÁæéËß£ÂÜ≥ÊÇ®ÈÅáÂà∞ÁöÑ "(Timestamp: ...)[{...}](Timestamp: ...)[{...}]" ËøôÁßçÊ†ºÂºè
            const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
        
            if (jsonMatches) {
                const results = [];
                for (const match of jsonMatches) {
                    try {
                        // Â∞ùËØïËß£ÊûêÊØè‰∏Ä‰∏™Ë¢´Êàë‰ª¨‚ÄúÊè™‚ÄùÂá∫Êù•ÁöÑJSONÂ≠óÁ¨¶‰∏≤
                        const parsedObject = JSON.parse(match);
                        results.push(parsedObject);
                    } catch (e) {
                        // Â¶ÇÊûúÊüê‰∏™ÁâáÊÆµ‰∏çÊòØÊúâÊïàÁöÑJSONÔºåÂ∞±ÂøΩÁï•ÂÆÉÔºåÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™
                        console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†ÊïàÁöÑJSONÁâáÊÆµ:", match);
                    }
                }
        
                // Â¶ÇÊûúÊàë‰ª¨ÊàêÂäüÊèêÂèñÂá∫‰∫ÜËá≥Â∞ë‰∏Ä‰∏™ÊúâÊïàÁöÑJSONÂØπË±°ÔºåÂ∞±ËøîÂõûËøô‰∏™ÁªìÊûú
                if (results.length > 0) {
                    console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñÊ®°Âºè„ÄÇ");
                    return results;
                }
            }
            
            // ÊñπÊ°à3Ôºö„ÄêÊúÄÁªàÂ§áÁî®„ÄëÂ¶ÇÊûú‰ª•‰∏äÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•‰∫ÜÔºåËØ¥ÊòéAIËøîÂõûÁöÑÂèØËÉΩÂ∞±ÊòØÁ∫ØÊñáÊú¨
            // Êàë‰ª¨Â∞ÜÂéüÂßãÁöÑ„ÄÅÊú™Â§ÑÁêÜÁöÑÂÜÖÂÆπÔºåÂåÖË£ÖÊàê‰∏Ä‰∏™Ê†áÂáÜÁöÑÊñáÊú¨Ê∂àÊÅØÂØπË±°ËøîÂõûÔºåÁ°Æ‰øùÁ®ãÂ∫è‰∏ç‰ºöÂ¥©Ê∫É
            console.error("ÊâÄÊúâËß£ÊûêÊñπÊ°àÂùáÂ§±Ë¥•ÔºÅÂ∞ÜËøîÂõûÂéüÂßãÊñáÊú¨„ÄÇ");
            return [{ type: 'text', content: content }];
        }
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ†πÊçÆÂΩìÂâçÊó∂Èó¥Ëé∑Âèñ‰∏ÄÂ§©‰∏≠ÁöÑÈóÆÂÄôËØ≠
         * @returns {string} - ËøîÂõûÂ¶Ç "ÂáåÊô®", "Êó©‰∏ä", "‰∏ãÂçà", "Êôö‰∏ä" Á≠âÂ≠óÁ¨¶‰∏≤
         */
        function getTimeOfDayGreeting(date = new Date()) { // ÂÖÅËÆ∏‰º†ÂÖ•‰∏Ä‰∏™Êó•ÊúüÂØπË±°
            const hour = date.getHours(); // ‰ΩøÁî®‰º†ÂÖ•ÁöÑÊó•ÊúüÂØπË±°Êù•Ëé∑ÂèñÂ∞èÊó∂
            if (hour >= 0 && hour < 5) {
                return "ÂáåÊô®";
            } else if (hour >= 5 && hour < 9) {
                return "Êó©‰∏ä";
            } else if (hour >= 9 && hour < 13) {
                return "‰∏äÂçà";
            } else if (hour >= 13 && hour < 18) {
                return "‰∏ãÂçà";
            } else if (hour >= 18 && hour < 24) {
                return "Êôö‰∏ä";
            }
            return "Áé∞Âú®"; // ÈªòËÆ§ÊÉÖÂÜµ
        }
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAPIÈ¢ÑËÆæÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩAPIÈ¢ÑËÆæÔºåÂπ∂Â°´ÂÖÖÂà∞‰∏ãÊãâÈÄâÊã©Ê°Ü‰∏≠
         */
        async function loadApiPresetsDropdown() {
            const selectEl = document.getElementById('api-preset-select');
            selectEl.innerHTML = '<option value="current">ÂΩìÂâçÈÖçÁΩÆ (Êú™‰øùÂ≠ò)</option>';
            
            const presets = await db.apiPresets.toArray();
            presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectEl.appendChild(option);
            });
        
            // Ê£ÄÊü•ÂΩìÂâçÈÖçÁΩÆÊòØÂê¶‰∏éÊüê‰∏™È¢ÑËÆæÂÆåÂÖ®ÂåπÈÖç
            const currentConfig = state.apiConfig;
            let matchingPresetId = null;
            for (const preset of presets) {
                if (
                    preset.proxyUrl === currentConfig.proxyUrl &&
                    preset.apiKey === currentConfig.apiKey &&
                    preset.model === currentConfig.model &&
                    preset.secondaryProxyUrl === currentConfig.secondaryProxyUrl &&
                    preset.secondaryApiKey === currentConfig.secondaryApiKey &&
                    preset.secondaryModel === currentConfig.secondaryModel
                ) {
                    matchingPresetId = preset.id;
                    break;
                }
            }
        
            if (matchingPresetId) {
                selectEl.value = matchingPresetId;
            } else {
                selectEl.value = 'current';
            }
        }
        
        /**
         * ÂΩìÁî®Êà∑‰ªé‰∏ãÊãâÊ°ÜÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæÊó∂ÔºåÂä†ËΩΩËØ•È¢ÑËÆæÁöÑÈÖçÁΩÆ
         */
        async function handlePresetSelectionChange() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            // Â¶ÇÊûúÈÄâÊã©ÁöÑÊòØ‚ÄúÂΩìÂâçÈÖçÁΩÆ‚ÄùÔºåÂàô‰∏çÂÅö‰ªª‰Ωï‰∫ã
            if (isNaN(selectedId)) {
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (preset) {
                // Â∞ÜÈ¢ÑËÆæÁöÑÈÖçÁΩÆÂä†ËΩΩÂà∞ÂΩìÂâçÁöÑÂÖ®Â±ÄÁä∂ÊÄÅ‰∏≠
                state.apiConfig = {
                    id: 'main',
                    proxyUrl: preset.proxyUrl,
                    apiKey: preset.apiKey,
                    model: preset.model,
                    secondaryProxyUrl: preset.secondaryProxyUrl,
                    secondaryApiKey: preset.secondaryApiKey,
                    secondaryModel: preset.secondaryModel
                };
                // Â∞ÜÂä†ËΩΩÁöÑÈÖçÁΩÆ‰øùÂ≠ò‰∏∫ÂΩìÂâçÊ≠£Âú®‰ΩøÁî®ÁöÑÈÖçÁΩÆ
                await db.apiConfig.put(state.apiConfig);
                // ÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ËÆæÁΩÆÈ°µÈù¢‰ª•ÊòæÁ§∫Êñ∞Âä†ËΩΩÁöÑÈÖçÁΩÆ
                renderApiSettings();
                // Ëá™Âä®‰∏∫Êñ∞Âä†ËΩΩÁöÑÈÖçÁΩÆÊãâÂèñÊ®°ÂûãÂàóË°®
                document.getElementById('fetch-models-btn').click();
                if (preset.secondaryProxyUrl && preset.secondaryApiKey) {
                    document.getElementById('fetch-secondary-models-btn').click();
                }
                alert(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ ‚Äú${preset.name}‚Äù`);
            }
        }
        
        /**
         * Â∞ÜÂΩìÂâçËæìÂÖ•Ê°Ü‰∏≠ÁöÑÈÖçÁΩÆ‰øùÂ≠ò‰∏∫‰∏Ä‰∏™Êñ∞ÁöÑÈ¢ÑËÆæ
         */
        async function saveApiPreset() {
            const name = await showCustomPrompt('‰øùÂ≠ò API È¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
            if (!name || !name.trim()) return;
        
            // ‰ªéËæìÂÖ•Ê°ÜËØªÂèñÂΩìÂâçÈÖçÁΩÆ
            const presetData = {
                name: name.trim(),
                proxyUrl: document.getElementById('proxy-url').value.trim(),
                apiKey: document.getElementById('api-key').value.trim(),
                model: document.getElementById('model-select').value,
                secondaryProxyUrl: document.getElementById('secondary-proxy-url').value.trim(),
                secondaryApiKey: document.getElementById('secondary-api-key').value.trim(),
                secondaryModel: document.getElementById('secondary-model-select').value
            };
        
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÈ¢ÑËÆæ
            const existingPreset = await db.apiPresets.where('name').equals(presetData.name).first();
            if (existingPreset) {
                const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${presetData.name}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;
                presetData.id = existingPreset.id; // ÊåáÂÆöID‰ª•Ë¶ÜÁõñÊóßÊï∞ÊçÆ
            }
        
            await db.apiPresets.put(presetData);
            await loadApiPresetsDropdown(); // Âà∑Êñ∞‰∏ãÊãâÂàóË°®
            alert('API È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
        }
        
        /**
         * Âà†Èô§ÂΩìÂâçÈÄâ‰∏≠ÁöÑÈ¢ÑËÆæ
         */
        async function deleteApiPreset() {
            const selectEl = document.getElementById('api-preset-select');
            const selectedId = parseInt(selectEl.value);
        
            if (isNaN(selectedId)) {
                alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
                return;
            }
        
            const preset = await db.apiPresets.get(selectedId);
            if (!preset) return;
        
            const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.apiPresets.delete(selectedId);
                await loadApiPresetsDropdown(); // Âà∑Êñ∞‰∏ãÊãâÂàóË°®
                alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderApiSettings ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function renderApiSettings() { 
            // 1. Ê∏≤ÊüìÂΩìÂâçÈÖçÁΩÆÂà∞ËæìÂÖ•Ê°Ü
            document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
            document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
            document.getElementById('secondary-proxy-url').value = state.apiConfig.secondaryProxyUrl || '';
            document.getElementById('secondary-api-key').value = state.apiConfig.secondaryApiKey || '';
            document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
            document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
            document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
        
            // 2. „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÂä†ËΩΩÂπ∂Ê∏≤ÊüìÈ¢ÑËÆæ‰∏ãÊãâËèúÂçï
            loadApiPresetsDropdown();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                window.renderApiSettingsProxy = renderApiSettings;
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞ÁâàÊú¨„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ renderChatList ‚ñº‚ñº‚ñº
        async function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            chatListEl.innerHTML = '';
        
            // 1. Ëé∑ÂèñÊâÄÊúâËÅäÂ§©Âπ∂ËøõË°å„ÄêÂ§öÁ∫ßÊéíÂ∫è„Äë
            const allChats = Object.values(state.chats).sort((a, b) => {
                // ËßÑÂàô1ÔºöÊåâ isPinned ÈôçÂ∫èÊéíÔºàtrueÁöÑÂú®ÂâçÔºâ
                const pinDiff = (b.isPinned || false) - (a.isPinned || false);
                if (pinDiff !== 0) return pinDiff;
        
                // ËßÑÂàô2ÔºöÂ¶ÇÊûúÁΩÆÈ°∂Áä∂ÊÄÅÁõ∏ÂêåÔºåÂàôÊåâÊúÄÊñ∞Ê∂àÊÅØÊó∂Èó¥ÈôçÂ∫èÊéí
                return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
            });
            
            // 2. Ëé∑ÂèñÊâÄÊúâÂàÜÁªÑ
            const allGroups = await db.qzoneGroups.toArray();
        
            if (allChats.length === 0) {
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>';
                return;
            }
        
            // 3. ‰∏∫ÊØè‰∏™ÂàÜÁªÑÊâæÂà∞ÂÖ∂ÂÜÖÈÉ®ÊúÄÊñ∞ÁöÑÊ∂àÊÅØÊó∂Èó¥Êà≥
            allGroups.forEach(group => {
                const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
                group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
            });
        
            // 4. Ê†πÊçÆËøô‰∏™ÊúÄÊñ∞ÁöÑÊó∂Èó¥Êà≥Êù•ÂØπ‚ÄúÂàÜÁªÑÊú¨Ë∫´‚ÄùËøõË°åÊéíÂ∫è
            allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        
            // 5. Áé∞Âú®ÔºåÊàë‰ª¨ÊåâÁÖßÊéíÂ•ΩÂ∫èÁöÑÂàÜÁªÑÊù•Ê∏≤Êüì
            allGroups.forEach(group => {
                const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
                if (groupChats.length === 0) return;
        
                const groupContainer = document.createElement('div');
                groupContainer.className = 'chat-group-container';
                groupContainer.innerHTML = `
                    <div class="chat-group-header">
                        <span class="arrow">‚ñº</span>
                        <span class="group-name">${group.name}</span>
                    </div>
                    <div class="chat-group-content"></div>
                `;
                const contentEl = groupContainer.querySelector('.chat-group-content');
                groupChats.forEach(chat => {
                    const item = createChatListItem(chat);
                    contentEl.appendChild(item);
                });
                chatListEl.appendChild(groupContainer);
            });
        
            // 6. ÊúÄÂêéÔºåÊ∏≤ÊüìÊâÄÊúâÁæ§ËÅäÂíåÊú™ÂàÜÁªÑÁöÑÂ•ΩÂèã
            const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
            ungroupedOrGroupChats.forEach(chat => {
                const item = createChatListItem(chat);
                chatListEl.appendChild(item);
            });
        
            // ‰∏∫ÊâÄÊúâÂàÜÁªÑÊ†áÈ¢òÊ∑ªÂä†ÊäòÂè†‰∫ã‰ª∂
            document.querySelectorAll('.chat-group-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    header.nextElementSibling.classList.toggle('collapsed');
                });
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤ÂçáÁ∫ßHTMLÁªìÊûÑÂπ∂‰øÆÂ§çÁÇπÂáªÈóÆÈ¢ò„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊÇ®Áé∞ÊúâÁöÑ createChatListItem ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function createChatListItem(chat) {
            const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
            let lastMsgDisplay;
        
            if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
                lastMsgDisplay = `<span style="color: #ff8c00;">[Â•ΩÂèãÁî≥ËØ∑] ${chat.relationship.applicationReason || 'ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã'}</span>`;
            }
            else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                lastMsgDisplay = `<span style="color: #dc3545;">[‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]</span>`;
            }
           // Âú® createChatListItem ÂáΩÊï∞‰∏≠...
        // ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ if(chat.isGroup) {...} else {...} Âà§Êñ≠ ‚ñº‚ñº‚ñº
        if (chat.isGroup) {
            if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[Á≥ªÁªüÊ∂àÊÅØ] ${lastMsgObj.content}`; }
            else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[ËΩ¨Ë¥¶]'; }
            else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ÁÖßÁâá]'; }
            else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[ËØ≠Èü≥]'; }
            else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]'; }
            else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[ÂõæÁâá]`; }
            else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Ê†πÊçÆAIÁöÑÊú¨Âêç(senderName)ÊâæÂà∞ÂÆÉÂú®Áæ§ÈáåÁöÑÊòµÁß∞(groupNickname)
            if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
                const senderMember = chat.members.find(m => m.originalName === lastMsgObj.senderName);
                const senderDisplayName = senderMember ? senderMember.groupNickname : lastMsgObj.senderName;
                lastMsgDisplay = `${senderDisplayName}: ${lastMsgDisplay}`;
            }
        } else {
            // ÂçïËÅäÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
            const statusText = chat.status?.text || 'Âú®Á∫ø';
            lastMsgDisplay = `[${statusText}]`;
        }
        
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            if (chat.isPinned) {
                item.classList.add('pinned');
            }
        
            // ‚ñº‚ñº‚ñº ‰ªéËøôÈáåÂºÄÂßãÊòØÊ†∏ÂøÉ‰øÆÊîπÔºö‰∏∫ËÅäÂ§©ÂàóË°®‰πüÁîüÊàêÂ∏¶Ê°ÜÂ§¥ÂÉèÁöÑHTMLÁªìÊûÑ ‚ñº‚ñº‚ñº
            const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
            // Áæ§ËÅäÂàóË°®È°πÊöÇÊó∂‰∏çÊòæÁ§∫Â§¥ÂÉèÊ°ÜÔºåÂè™‰∏∫ÂçïËÅäÊòæÁ§∫
            const avatarFrameSrc = chat.isGroup ? '' : (chat.settings.aiAvatarFrame || '');
        
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `
                    <div class="avatar-with-frame">
                        <img src="${avatar || defaultAvatar}" class="avatar-img">
                        <img src="${avatarFrameSrc}" class="avatar-frame">
                    </div>
                `;
            } else {
                // Ê≥®ÊÑèÔºöËøôÈáåÁöÑ class ‰æùÁÑ∂ÊòØ 'avatar'Ôºå‰ª•ÂÖºÂÆπÊóßÁöÑCSSÊ†∑Âºè
                avatarHtml = `<img src="${avatar || defaultAvatar}" class="avatar">`;
            }
        
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            // ‰ΩøÁî®‰∏éËÅäÂ§©ÁïåÈù¢‰∏ÄËá¥ÁöÑ .avatar-group ÂÆπÂô®
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;
            // ‚ñ≤‚ñ≤‚ñ≤ HTMLÁªìÊûÑÂçáÁ∫ßÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            item.innerHTML = `
                ${avatarGroupHtml}
                <div class="info">
                    <div class="name-line">
                        <span class="name">${chat.name}</span>
                        ${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}
                    </div>
                    <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
                </div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            `;
            
            const unreadCount = chat.unreadCount || 0;
            const unreadEl = item.querySelector('.unread-count');
            if (unreadCount > 0) {
                unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                unreadEl.style.display = 'inline-flex';
            } else {
                unreadEl.style.display = 'none';
            }
            
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÂºÄÂßã‰øÆÊîπ ‚ñº‚ñº‚ñº
            const avatarGroupEl = item.querySelector('.avatar-group');
            if (avatarGroupEl) {
                avatarGroupEl.style.cursor = 'pointer';
                // Â∞Ü 'click' ‰∫ã‰ª∂Êîπ‰∏∫ 'dblclick'
                avatarGroupEl.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const nameToPat = chat.isGroup ? chat.name : chat.originalName;
                    handleUserPat(chat.id, nameToPat);
                });
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            
            const infoEl = item.querySelector('.info');
            if (infoEl) {
                infoEl.addEventListener('click', () => openChat(chat.id));
            }
        
            addLongPressListener(item, async (e) => {
                const action = await showChatListActions(chat);
                switch (action) {
                    case 'pin':
                        chat.isPinned = !chat.isPinned;
                        await db.chats.put(chat);
                        renderChatList();
                        break;
                    case 'delete':
                        const deleteConfirmed = await showCustomConfirm(
                            'Âà†Èô§ÂØπËØù', 
                            `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, 
                            { confirmButtonClass: 'btn-danger' }
                        );
                        if (deleteConfirmed) {
                            if (musicState.isActive && musicState.activeChatId === chat.id) {
                                await endListenTogetherSession(false);
                            }
                            delete state.chats[chat.id];
                            if (state.activeChatId === chat.id) {
                                state.activeChatId = null;
                            }
                            await db.chats.delete(chat.id);
                            renderChatList();
                        }
                        break;
                    default:
                        break;
                }
            });
            return item;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÊõ¥ÂÅ•Â£ÆÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderChatInterface ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function renderChatInterface(chatId) { // <--- ÂÖ≥ÈîÆ‰øÆÊîπ1ÔºöÂ∞ÜÂáΩÊï∞Â£∞Êòé‰∏∫ async
            cleanupWaimaiTimers();
            const chat = state.chats[chatId];
            if (!chat) return;
        
            
            exitSelectionMode();
            
            const messagesContainer = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const lockOverlay = document.getElementById('chat-lock-overlay');
            const lockContent = document.getElementById('chat-lock-content');
        
            messagesContainer.dataset.theme = chat.settings.theme || 'default';
            const fontSize = chat.settings.fontSize || 13;
            messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
            applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
            
            document.getElementById('chat-header-title').textContent = chat.name;
            const statusContainer = document.getElementById('chat-header-status');
            const statusTextEl = statusContainer.querySelector('.status-text');
        
            if (chat.isGroup) {
                statusContainer.style.display = 'none';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
            } else {
                statusContainer.style.display = 'flex';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
                statusTextEl.textContent = chat.status?.text || 'Âú®Á∫ø';
                statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
            }
            
            lockOverlay.style.display = 'none';
            chatInputArea.style.visibility = 'visible';
            lockContent.innerHTML = '';
        
            if (!chat.isGroup && chat.relationship.status !== 'friend') {
                lockOverlay.style.display = 'flex';
                chatInputArea.style.visibility = 'hidden';
                
                let lockHtml = '';
                switch (chat.relationship.status) {
                    // ... (ÁúÅÁï•ÊâÄÊúâ case, ÈÄªËæë‰∏çÂèò) ...
                     case 'blocked_by_user':
                        // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπÔºöÂú®ËøôÈáåÂä†ÂÖ•ËØäÊñ≠Èù¢Êùø„Äë ---
                        const isSimulationRunning = simulationIntervalId !== null;
                        const blockedTimestamp = chat.relationship.blockedTimestamp;
                        const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                        const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                        const timeSinceBlock = Date.now() - blockedTimestamp;
                        const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                        const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));
        
                        lockHtml = `
                            <span class="lock-text">‰Ω†Â∑≤Â∞Ü‚Äú${chat.name}‚ÄùÊãâÈªë„ÄÇ</span>
                            <button id="unblock-btn" class="lock-action-btn">Ëß£Èô§ÊãâÈªë</button>
                            <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                <strong style="color: #333;">„ÄêÂºÄÂèëËÄÖËØäÊñ≠Èù¢Êùø„Äë</strong><br>
                                - ÂêéÂè∞Ê¥ªÂä®ÊÄªÂºÄÂÖ≥: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤ÂºÄÂêØ</span>' : '<span style="color: red;">Â∑≤ÂÖ≥Èó≠</span>'}<br>
                                - Á≥ªÁªüÂøÉË∑≥ËÆ°Êó∂Âô®: ${isSimulationRunning ? '<span style="color: green;">ËøêË°å‰∏≠</span>' : '<span style="color: red;">Êú™ËøêË°å</span>'}<br>
                                - ÂΩìÂâçËßíËâ≤Áä∂ÊÄÅ: <strong>${chat.relationship.status}</strong><br>
                                - ÈúÄË¶ÅÂÜ∑Èùô(Â∞èÊó∂): <strong>${cooldownHours}</strong><br>
                                - ÂÜ∑ÈùôÊúüÊòØÂê¶ÁªìÊùü: ${isCooldownOver ? '<span style="color: green;">ÊòØ</span>' : `<span style="color: orange;">Âê¶ (ËøòÂâ©Á∫¶ ${timeRemainingMinutes} ÂàÜÈíü)</span>`}<br>
                                - Ëß¶ÂèëÊù°‰ª∂: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤Êª°Ë∂≥ÔºåÁ≠âÂæÖ‰∏ãÊ¨°Á≥ªÁªüÂøÉË∑≥</span>' : '<span style="color: red;">Êú™Êª°Ë∂≥</span>'}
                            </div>
                            <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°Â•ΩÂèãÁî≥ËØ∑Ê£ÄÊµã</button>
                        `;
                        // --- „Äê‰øÆÊîπÁªìÊùü„Äë ---
                        break;
                    case 'blocked_by_ai':
                        lockHtml = `
                            <span class="lock-text">‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫Ü„ÄÇ</span>
                            <button id="apply-friend-btn" class="lock-action-btn">ÈáçÊñ∞Áî≥ËØ∑Âä†‰∏∫Â•ΩÂèã</button>
                        `;
                        break;
                    
                    case 'pending_user_approval':
                        lockHtml = `
                            <span class="lock-text">‚Äú${chat.name}‚ÄùËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèãÔºö<br><i>‚Äú${chat.relationship.applicationReason}‚Äù</i></span>
                            <button id="accept-friend-btn" class="lock-action-btn">Êé•Âèó</button>
                            <button id="reject-friend-btn" class="lock-action-btn secondary">ÊãíÁªù</button>
                        `;
                        break;
        
                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë‰øÆÂ§çÂΩì‰Ω†Áî≥ËØ∑ÂêéÔºå‰Ω†ÁúãÂà∞ÁöÑÁïåÈù¢
                    case 'pending_ai_approval':
                        lockHtml = `<span class="lock-text">Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÈÄöËøá...</span>`;
                        break;
                }
                lockContent.innerHTML = lockHtml;
            }
            messagesContainer.innerHTML = '';
            
            const chatScreen = document.getElementById('chat-interface-screen');
            chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
            
            const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
            chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
            
            const history = chat.history;
            const totalMessages = history.length;
            currentRenderedCount = 0;
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
            // --- ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÂ∞±Âú®ËøôÈáå ‚òÖ‚òÖ‚òÖ ---
            let lastTimestamp = 0;
            const fragment = document.createDocumentFragment();

            for (const msg of initialMessages) {
                // Ê£ÄÊü•‰∏é‰∏ä‰∏ÄÊù°Ê∂àÊÅØÁöÑÊó∂Èó¥Èó¥Èöî
                if (lastTimestamp > 0 && (msg.timestamp - lastTimestamp > 600000)) {
                    fragment.appendChild(createSystemTimestampElement(msg.timestamp));
                }
                const messageEl = await createMessageElement(msg, chat, true);
                if (messageEl) {
                    fragment.appendChild(messageEl);
                }
                lastTimestamp = msg.timestamp; // Êõ¥Êñ∞Êó∂Èó¥Êà≥
            }
            messagesContainer.appendChild(fragment);
            // --- ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ ---
        
            currentRenderedCount = initialMessages.length;
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
            
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.style.display = 'none';
            typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
            messagesContainer.appendChild(typingIndicator);
            
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        
        // ‚ñº‚ñº‚ñº „ÄêÈ¢ÑÈò≤ÊÄß‰øÆÂ§ç„ÄëËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨ÊõøÊç¢ÊóßÁöÑ loadMoreMessages ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function loadMoreMessages() { // <--- ÂÖ≥ÈîÆ‰øÆÊîπ1ÔºöÂ∞ÜÂáΩÊï∞Â£∞Êòé‰∏∫ async
            const messagesContainer = document.getElementById('chat-messages');
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            const totalMessages = chat.history.length;
            const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW;
            const nextSliceEnd = totalMessages - currentRenderedCount;
            const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd);
            
            const oldScrollHeight = messagesContainer.scrollHeight;
            
            // ‚ñº‚ñº‚ñº ÂÖ≥ÈîÆ‰øÆÊîπ2ÔºöÂ∞Ü forEach ÊõøÊç¢‰∏∫ for...of Âæ™ÁéØ ‚ñº‚ñº‚ñº
            for (const msg of messagesToPrepend.reverse()) {
                await prependMessage(msg, chat); // <-- ‰ΩøÁî® await Á≠âÂæÖ
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            currentRenderedCount += messagesToPrepend.length;
            const newScrollHeight = messagesContainer.scrollHeight;
            messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight);
            
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÊñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderWallpaperScreen ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function renderWallpaperScreen() { 
            const preview = document.getElementById('wallpaper-preview'); 
            const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
            if (bg && bg.startsWith('data:image')) { 
                preview.style.backgroundImage = `url(${bg})`; 
                preview.textContent = ''; 
            } else if(bg) { 
                preview.style.backgroundImage = bg; 
                preview.textContent = 'ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤'; 
            }
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåË∞ÉÁî®ÂõæÊ†áÊ∏≤ÊüìÂáΩÊï∞
            renderIconSettings();
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
            document.getElementById('global-css-input').value = state.globalSettings.globalCss || '';
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
    document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
              document.getElementById('status-bar-toggle-switch').checked = state.globalSettings.showStatusBar || false;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                window.renderWallpaperScreenProxy = renderWallpaperScreen;
        
                function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøô‰∏™ÂáΩÊï∞Áî®‰∫éÂ§ÑÁêÜ‰∏ñÁïå‰π¶È°µÁ≠æÁöÑÁÇπÂáªÂàáÊç¢ ‚ñº‚ñº‚ñº
        function switchWorldBookCategory(categoryId) {
            // 1. ÂàáÊç¢È°µÁ≠æÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
            });
            // 2. ÂàáÊç¢ÂÜÖÂÆπÈù¢ÊùøÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            document.querySelectorAll('.world-book-category-pane').forEach(pane => {
                pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
            });
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderWorldBookScreen ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function renderWorldBookScreen() {
            const tabsContainer = document.getElementById('world-book-tabs');
            const contentContainer = document.getElementById('world-book-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            // 1. ÂêåÊó∂Ëé∑ÂèñÊâÄÊúâ‰π¶Á±çÂíåÊâÄÊúâÂàÜÁ±ª
            const [books, categories] = await Promise.all([
                db.worldBooks.toArray(),
                db.worldBookCategories.orderBy('name').toArray()
            ]);
        
            state.worldBooks = books; // Á°Æ‰øùÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆÊòØÂêåÊ≠•ÁöÑ
        
            if (books.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>';
                return;
            }
        
            // --- 2. ÂàõÂª∫Âπ∂Ê∑ªÂä†‚ÄúÂÖ®ÈÉ®‚ÄùÈ°µÁ≠æÂíåÂÖ∂ÂÜÖÂÆπÈù¢Êùø ---
            const allTab = document.createElement('button');
            allTab.className = 'world-book-tab active';
            allTab.textContent = 'ÂÖ®ÈÉ®';
            allTab.dataset.categoryId = 'all';
            tabsContainer.appendChild(allTab);
        
            const allPane = document.createElement('div');
            allPane.className = 'world-book-category-pane active';
            allPane.dataset.categoryId = 'all';
            contentContainer.appendChild(allPane);
        
            // --- 3. ÂàõÂª∫Âπ∂Ê∑ªÂä†ÂêÑ‰∏™ÂàÜÁ±ªÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÈù¢Êùø ---
            categories.forEach(category => {
                const categoryTab = document.createElement('button');
                categoryTab.className = 'world-book-tab';
                categoryTab.textContent = category.name;
                categoryTab.dataset.categoryId = String(category.id);
                tabsContainer.appendChild(categoryTab);
        
                const categoryPane = document.createElement('div');
                categoryPane.className = 'world-book-category-pane';
                categoryPane.dataset.categoryId = String(category.id);
                contentContainer.appendChild(categoryPane);
            });
            
            // --- 4. ÂàõÂª∫Âπ∂Ê∑ªÂä†‚ÄúÊú™ÂàÜÁ±ª‚ÄùÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÈù¢Êùø (Â¶ÇÊûúÈúÄË¶Å) ---
            const hasUncategorized = books.some(book => !book.categoryId);
            if (hasUncategorized) {
                const uncategorizedTab = document.createElement('button');
                uncategorizedTab.className = 'world-book-tab';
                uncategorizedTab.textContent = 'Êú™ÂàÜÁ±ª';
                uncategorizedTab.dataset.categoryId = 'uncategorized';
                tabsContainer.appendChild(uncategorizedTab);
            
                const uncategorizedPane = document.createElement('div');
                uncategorizedPane.className = 'world-book-category-pane';
                uncategorizedPane.dataset.categoryId = 'uncategorized';
                contentContainer.appendChild(uncategorizedPane);
            }
        
            // --- 5. ÈÅçÂéÜ‰π¶Á±çÔºåÂ∞ÜÂÆÉ‰ª¨Â°´ÂÖÖÂà∞ÂØπÂ∫îÁöÑÂÜÖÂÆπÈù¢Êùø‰∏≠ ---
            books.forEach(book => {
                let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';
                if (Array.isArray(book.content) && book.content.length > 0) {
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    contentPreview = book.content;
                }
        
                const card = document.createElement('div');
                card.className = 'world-book-card';
                card.innerHTML = `
                    <div class="card-title">${book.name}</div>
                    <div class="card-content-preview">${contentPreview}</div>
                `;
                
                // ‰∏∫Âç°ÁâáÊú¨Ë∫´Ê∑ªÂä†ÁÇπÂáªÂíåÈïøÊåâ‰∫ã‰ª∂
                const cardClickHandler = () => openWorldBookEditor(book.id);
                const cardLongPressHandler = async () => { 
                    const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                };
        
                card.addEventListener('click', cardClickHandler);
                addLongPressListener(card, cardLongPressHandler);
        
                // ÂÖãÈöÜÂç°ÁâáÂπ∂ÊäïÊîæÂà∞‚ÄúÂÖ®ÈÉ®‚ÄùÈù¢Êùø
                const clonedCardForAll = card.cloneNode(true);
                clonedCardForAll.addEventListener('click', cardClickHandler);
                addLongPressListener(clonedCardForAll, cardLongPressHandler);
                allPane.appendChild(clonedCardForAll);
                
                // Â∞ÜÂéüÂßãÂç°ÁâáÊäïÊîæÂà∞ÂØπÂ∫îÁöÑÂàÜÁ±ªÈù¢Êùø
                const categoryKey = book.categoryId ? String(book.categoryId) : 'uncategorized';
                const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 6. ‰∏∫ÊâÄÊúâÈ°µÁ≠æÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ ---
            document.querySelectorAll('.world-book-tab').forEach(tab => {
                tab.addEventListener('click', () => switchWorldBookCategory(tab.dataset.categoryId));
            });
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÊúÄÁªà‰øÆÂ§çÁâà„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ createWorldBookGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêV2.0 | Â∑≤‰øÆÂ§çÈ¢ÑËßàBUG„ÄëÂàõÂª∫‰∏Ä‰∏™ÂàÜÁ±ªÁöÑÂàÜÁªÑDOM
         * @param {string} groupName - ÂàÜÁ±ªÂêçÁß∞
         * @param {Array} books - ËØ•ÂàÜÁ±ª‰∏ãÁöÑ‰π¶Á±çÊï∞ÁªÑ
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑÂàÜÁªÑÂÆπÂô®
         */
        function createWorldBookGroup(groupName, books) {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'world-book-group-container';
            
            groupContainer.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">‚ñº</span>
                    <span class="group-name">${groupName}</span>
                </div>
                <div class="world-book-group-content"></div>
            `;
        
            const contentEl = groupContainer.querySelector('.world-book-group-content');
            books.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN')); // Êåâ‰π¶ÂêçÊéíÂ∫è
            
            books.forEach(book => {
                // ‚ñº‚ñº‚ñº „Äê„Äê„ÄêËøôÂ∞±ÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÂ§çÔºÅ„Äë„Äë„Äë ‚ñº‚ñº‚ñº
                let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';
                
                // 1. Ê£ÄÊü• book.content ÊòØÂê¶ÊòØÊàë‰ª¨Êñ∞ÁöÑ‚ÄúÊù°ÁõÆÊï∞ÁªÑ‚ÄùÊ†ºÂºè
                if (Array.isArray(book.content) && book.content.length > 0) {
                    // Â¶ÇÊûúÊòØÔºåÂ∞±‰ªéÁ¨¨‰∏Ä‰∏™Êù°ÁõÆÁöÑÂÜÖÂÆπ‰∏≠ÊèêÂèñÈ¢ÑËßà
                    // Êàë‰ª¨‰πü‰ºòÂÖà‰ΩøÁî®Á¨¨‰∏Ä‰∏™Êù°ÁõÆÁöÑ comment ‰Ωú‰∏∫È¢ÑËßàÔºåÂõ†‰∏∫ÂÆÉÊõ¥ÁÆÄÊ¥Å
                    const firstEntry = book.content[0];
                    contentPreview = firstEntry.comment || firstEntry.content || '';
                } 
                // 2. Âê¶ÂàôÔºåÂ∞±Ê£ÄÊü•ÂÆÉÊòØÂê¶ÊòØÊóßÁöÑ‚ÄúÂ≠óÁ¨¶‰∏≤‚ÄùÊ†ºÂºè
                else if (typeof book.content === 'string' && book.content.trim() !== '') {
                    // Â¶ÇÊûúÊòØÔºåÂ∞±ÂÉè‰ª•Ââç‰∏ÄÊ†∑Â§ÑÁêÜ
                    contentPreview = book.content;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.bookId = book.id;
                // Áé∞Âú®ÔºåÊàë‰ª¨‰ΩøÁî®Â§ÑÁêÜÂ•ΩÁöÑ contentPreview Êù•ÁîüÊàêHTMLÔºåÂπ∂Á°Æ‰øùÂÆÉÊòØ‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤
                item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${String(contentPreview).substring(0, 50)}</div>
                `;
                item.addEventListener('click', () => openWorldBookEditor(book.id));
                addLongPressListener(item, async () => { 
                    const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                });
                contentEl.appendChild(item);
            });
        
            return groupContainer;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                window.renderWorldBookScreenProxy = renderWorldBookScreen;
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Â∑≤‰øÆÂ§çBUGÁöÑÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ openWorldBookEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function openWorldBookEditor(bookId) {
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜÂàáÊç¢Â±èÂπïÁöÑÊìç‰ΩúÁßªÂä®Âà∞ÂáΩÊï∞ÁöÑÊúÄÂâçÈù¢
            // ËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùÂú®Êìç‰ΩúDOMÂÖÉÁ¥†‰πãÂâçÔºåÂÆÉ‰ª¨ÊâÄÂú®ÁöÑÂ±èÂπïÂ∑≤ÁªèÊòØÊøÄÊ¥ªÁä∂ÊÄÅ
            showScreen('world-book-editor-screen');
        
            editingWorldBookId = bookId;
            const [book, categories] = await Promise.all([
                db.worldBooks.get(bookId),
                db.worldBookCategories.toArray()
            ]);
        
            // Â¶ÇÊûúÂú®ÂàáÊç¢Â±èÂπïÂêéÂèëÁé∞‰π¶Á±ç‰∏çÂ≠òÂú®ÔºåÂàôÂÆâÂÖ®ËøîÂõûÂàóË°®È°µ
            if (!book) {
                console.error("Â∞ùËØïÊâìÂºÄ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑ‰∏ñÁïå‰π¶ÔºåID:", bookId);
                showScreen('world-book-screen');
                return;
            }
        
            // Áé∞Âú®ÔºåÂõ†‰∏∫Â±èÂπïÂ∑≤ÊòæÁ§∫ÔºåÊâÄ‰ª•ÂèØ‰ª•ÂÆâÂÖ®Âú∞Êìç‰ΩúËøô‰∫õÂÖÉÁ¥†‰∫Ü
            document.getElementById('world-book-editor-title').textContent = book.name;
            document.getElementById('world-book-name-input').value = book.name;
        
            // ÂàÜÁ±ª‰∏ãÊãâËèúÂçïÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
            const selectEl = document.getElementById('world-book-category-select');
            selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (book.categoryId === cat.id) option.selected = true;
                selectEl.appendChild(option);
            });
        
            // Âä®ÊÄÅÊ∏≤ÊüìÊù°ÁõÆÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
            const entriesContainer = document.getElementById('world-book-entries-container');
            entriesContainer.innerHTML = ''; 
        
            if (Array.isArray(book.content) && book.content.length > 0) {
                book.content.forEach(entry => {
                    const block = createWorldBookEntryBlock(entry);
                    entriesContainer.appendChild(block);
                });
            } else {
                entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">ËøòÊ≤°ÊúâÂÜÖÂÆπÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
            }
        
            // ‰∏çÂÜçÈúÄË¶ÅÂú®ÂáΩÊï∞Êú´Â∞æË∞ÉÁî® showScreenÔºåÂõ†‰∏∫ÂÆÉÂ∑≤ÁªèÂú®ÂºÄÂ§¥Ë¢´Ë∞ÉÁî®‰∫Ü
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderStickerPanel ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function renderStickerPanel() { 
            const grid = document.getElementById('sticker-grid'); 
            grid.innerHTML = ''; 
            if (state.userStickers.length === 0) { 
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Â§ß‰∫∫ËØ∑ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÊàñ‚Äú‰∏ä‰º†‚ÄùÊù•Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂêßÔºÅ</p>'; 
                return; 
            } 
            state.userStickers.forEach(sticker => { 
                const item = document.createElement('div'); 
                item.className = 'sticker-item'; 
                item.style.backgroundImage = `url(${sticker.url})`; 
                item.title = sticker.name;
                item.dataset.stickerId = sticker.id; // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫ÊØè‰∏™Ë°®ÊÉÖÈ°πÊ∑ªÂä†ID
        
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊ†πÊçÆÊòØÂê¶Â§Ñ‰∫éÁÆ°ÁêÜÊ®°ÂºèÔºåÂÜ≥ÂÆöÁÇπÂáªË°å‰∏∫
                item.addEventListener('click', () => {
                    if (isStickerManagementMode) {
                        handleStickerSelection(item);
                    } else {
                        sendSticker(sticker);
                    }
                });
        
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰∏∫Âçï‰∏™Âà†Èô§ÊåâÈíÆÊ∑ªÂä†ÈÄªËæë
                const deleteBtn = document.createElement('div'); 
                deleteBtn.className = 'delete-btn'; 
                deleteBtn.innerHTML = '&times;'; 
                deleteBtn.onclick = async (e) => { 
                    e.stopPropagation(); 
                    const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        await db.userStickers.delete(sticker.id); 
                        state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); 
                        renderStickerPanel(); 
                    } 
                }; 
                item.appendChild(deleteBtn);
                
                grid.appendChild(item); 
            }); 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË°®ÊÉÖÊâπÈáèÂà†Èô§Ê†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        let isStickerManagementMode = false;
        let selectedStickers = new Set();
        
        /**
         * ÂàáÊç¢Ë°®ÊÉÖÈù¢ÊùøÁöÑÁÆ°ÁêÜÊ®°Âºè
         */
        function toggleStickerManagementMode() {
            isStickerManagementMode = !isStickerManagementMode;
            const grid = document.getElementById('sticker-grid');
            const manageBtn = document.getElementById('manage-stickers-btn');
            const actionBar = document.getElementById('sticker-action-bar');
        
            grid.classList.toggle('management-mode', isStickerManagementMode);
            
            if (isStickerManagementMode) {
                manageBtn.textContent = 'ÂÆåÊàê';
                actionBar.style.display = 'block';
                selectedStickers.clear();
                updateDeleteStickerButton();
            } else {
                manageBtn.textContent = 'ÁÆ°ÁêÜ';
                actionBar.style.display = 'none';
                // ÈÄÄÂá∫Êó∂Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Ê†∑Âºè
                grid.querySelectorAll('.sticker-item.selected').forEach(item => item.classList.remove('selected'));
            }
        }
        
        /**
         * Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆ‰∏äÁöÑËÆ°Êï∞
         */
        function updateDeleteStickerButton() {
            const btn = document.getElementById('delete-selected-stickers-btn');
            btn.textContent = `Âà†Èô§ (${selectedStickers.size})`;
        }
        
        /**
         * Â§ÑÁêÜÁî®Êà∑ÁÇπÂáªÈÄâÊã©ÊàñÂèñÊ∂àÈÄâÊã©Ë°®ÊÉÖ
         * @param {HTMLElement} item - Ë¢´ÁÇπÂáªÁöÑË°®ÊÉÖDOMÂÖÉÁ¥†
         */
        function handleStickerSelection(item) {
            if (!isStickerManagementMode) return; // Âè™ÊúâÂú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÊâçÁîüÊïà
        
            const stickerId = item.dataset.stickerId;
            if (!stickerId) return;
        
            item.classList.toggle('selected');
        
            if (selectedStickers.has(stickerId)) {
                selectedStickers.delete(stickerId);
            } else {
                selectedStickers.add(stickerId);
            }
            updateDeleteStickerButton();
        }
        
        /**
         * ÊâßË°åÊâπÈáèÂà†Èô§Êìç‰Ωú
         */
        async function executeBatchDeleteStickers() {
            if (selectedStickers.size === 0) return;
            
            const confirmed = await showCustomConfirm(
                'Á°ÆËÆ§Âà†Èô§',
                `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedStickers.size} ‰∏™Ë°®ÊÉÖÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedStickers];
                
                // ‰ªéÊï∞ÊçÆÂ∫ìÊâπÈáèÂà†Èô§
                await db.userStickers.bulkDelete(idsToDelete);
                
                // ‰ªéÂÜÖÂ≠òÁä∂ÊÄÅ‰∏≠ËøáÊª§ÊéâË¢´Âà†Èô§ÁöÑË°®ÊÉÖ
                state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));
                
                // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°ÂºèÂπ∂Âà∑Êñ∞ÂàóË°®
                toggleStickerManagementMode();
                renderStickerPanel();
                
                await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞ÂäüËÉΩÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖÁöÑÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊâìÂºÄÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖÁöÑÂºπÁ™ó
         */
        async function openBatchStickerImportModal() {
            const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÂºÄÂøÉ‚Äî‚Äîhttps://example.com/happy.png\nÈöæËøá‚Äî‚Äîhttps://example.com/sad.jpg\nÊÉäËÆ∂‚Äî‚Äîhttps://example.com/surprised.gif`;
            
            const pastedText = await showCustomPrompt(
                'ÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖ',
                placeholderText,
                '',
                'textarea'
            );
        
            if (pastedText && pastedText.trim()) {
                await handleBatchStickerImport(pastedText);
            }
        }
        
        /**
         * „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÂ§ÑÁêÜÁ≤òË¥¥ÁöÑÊñáÊú¨ÔºåËß£ÊûêÂπ∂Â≠òÂÖ•Êï∞ÊçÆÂ∫ì
         * @param {string} text - Áî®Êà∑Á≤òË¥¥ÁöÑÊñáÊú¨ÂÜÖÂÆπ
         */
        async function handleBatchStickerImport(text) {
            const lines = text.trim().split('\n');
            const newStickers = [];
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
        
                if (!trimmedLine || trimmedLine.includes('Â°´ÂÖ•')) {
                    continue; 
                }
        
                // Ëß£ÊûêÊñ∞Ê†ºÂºèÔºöÂêçÁß∞‚Äî‚ÄîÂÆåÊï¥ÈìæÊé•
                const match = trimmedLine.match(/^(.+?)‚Äî‚Äî(.+)$/);
                
                if (match) {
                    const name = match[1].trim();
                    const url = match[2].trim();
                    
                    // È™åËØÅURLÊ†ºÂºè
                    if (url.startsWith('http://') || url.startsWith('https://')) {
                    newStickers.push({
                        id: 'sticker_' + Date.now() + Math.random(), // Á°Æ‰øùIDÂîØ‰∏Ä
                        name: name,
                            url: url
                    });
                    } else {
                        errorCount++;
                        console.warn('ÊâπÈáèÂØºÂÖ•URLÊ†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                    }
                } else {
                    errorCount++;
                    console.warn('ÊâπÈáèÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                }
            }
        
            if (errorCount > 0) {
                await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Á≥ªÁªüË∑≥Ëøá„ÄÇ`);
            }
        
            if (newStickers.length > 0) {
                await db.userStickers.bulkAdd(newStickers);
                state.userStickers.push(...newStickers);
                renderStickerPanel(); // Âà∑Êñ∞Ë°®ÊÉÖÈù¢Êùø
                await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newStickers.length} ‰∏™Êñ∞Ë°®ÊÉÖÔºÅ`);
            } else if (errorCount === 0) {
                alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®Á≤òË¥¥ÁöÑÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞ÂäüËÉΩÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊªöÂä®Âà∞Âπ∂È´ò‰∫ÆÊòæÁ§∫ÂéüÂßãÊ∂àÊÅØ
         * @param {number} originalTimestamp - Ë¶ÅË∑≥ËΩ¨Âà∞ÁöÑÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function scrollToOriginalMessage(originalTimestamp) {
            // 1. ÊûÑÂª∫ÈÄâÊã©Âô®ÔºåÁ≤æÁ°ÆÊü•ÊâæÂéüÂßãÊ∂àÊÅØÁöÑ DOM ÂÖÉÁ¥†
            const selector = `.message-bubble[data-timestamp="${originalTimestamp}"]`;
            const originalMessageBubble = document.querySelector(selector);
        
            // 2. Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶Âú®ÂΩìÂâçÂ±èÂπï‰∏ä
            if (originalMessageBubble) {
                // 3. Â¶ÇÊûúÊâæÂà∞‰∫ÜÔºåÂ∞±Âπ≥ÊªëÂú∞ÊªöÂä®Âà∞ÂÆÉÁöÑ‰ΩçÁΩÆ
                originalMessageBubble.scrollIntoView({
                    behavior: 'smooth', // Âπ≥ÊªëÊªöÂä®
                    block: 'center'     // Â∞ΩÈáèËÆ©ÂÆÉÂÅúÂú®Â±èÂπï‰∏≠Â§Æ
                });
        
                // 4. Ê∑ªÂä†È´ò‰∫ÆÊïàÊûúÔºåÂπ∂Âú®1.5ÁßíÂêéËá™Âä®ÁßªÈô§
                originalMessageBubble.classList.add('highlighted');
                setTimeout(() => {
                    // Âú®ÁßªÈô§ÂâçÂÜçÊ¨°Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®ÔºåÈÅøÂÖçÂú®Áî®Êà∑Âø´ÈÄüÂàáÊç¢È°µÈù¢Êó∂Âá∫Èîô
                    if (document.body.contains(originalMessageBubble)) {
                        originalMessageBubble.classList.remove('highlighted');
                    }
                }, 1500); // È´ò‰∫ÆÊåÅÁª≠1.5Áßí
        
            } else {
                // 5. Â¶ÇÊûúÂú®ÂΩìÂâçÂä†ËΩΩÁöÑÊ∂àÊÅØ‰∏≠Êâæ‰∏çÂà∞ÔºåÁªôÁî®Êà∑‰∏Ä‰∏™ÊèêÁ§∫
                alert("ÂéüÂßãÊ∂àÊÅØÂ∞öÊú™Âä†ËΩΩÔºåËØ∑Âêë‰∏äÊªëÂä®Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩïÂêéÂÜçËØï„ÄÇ");
            }
        }
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ createMessageElement ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function createMessageElement(msg, chat) {
        
            // --- (Á≥ªÁªüÊ∂àÊÅØÂíåÊí§ÂõûÊ∂àÊÅØÁöÑÂ§ÑÁêÜÈÄªËæë‰øùÊåÅ‰∏çÂèò) ---
            if (msg.type === 'recalled_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble recalled-message-placeholder';
                bubble.dataset.timestamp = msg.timestamp; 
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
            else if (msg.type === 'post_deleted_notice') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat';
                wrapper.dataset.timestamp = msg.timestamp; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble post-deleted-placeholder'; 
                bubble.dataset.postId = msg.postId;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) {
                        toggleMessageSelection(msg.timestamp);
                    }
                });
                return wrapper;
            }
        
            if (msg.isHidden) {
                return null;
            }
        
            if (msg.type === 'pat_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat'; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble system-bubble'; 
                bubble.dataset.timestamp = msg.timestamp;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                return wrapper;
            }
        
            // --- (Âü∫Á°ÄDOMÂÖÉÁ¥†ÂáÜÂ§áÈÄªËæë‰øùÊåÅ‰∏çÂèò) ---
            const isUser = msg.role === 'user';
            const myNickname = chat.settings.myNickname || 'Êàë';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
        
            if (chat.isGroup && !isUser) {
                const member = chat.members.find(m => m.originalName === msg.senderName);
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'Êú™Áü•ÊàêÂëò');
                wrapper.appendChild(senderNameDiv);
            }
        
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;
        
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);
        
            let avatarSrc, avatarFrameSrc = '';
            if (isUser) {
                avatarSrc = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrameSrc = chat.settings.myAvatarFrame || '';
            } else {
                if (chat.isGroup) {
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    if (member) {
                        const characterProfile = state.chats[member.id];
                        avatarSrc = member.avatar || (characterProfile ? characterProfile.settings.aiAvatar : defaultGroupMemberAvatar);
                        avatarFrameSrc = member.avatarFrame || (characterProfile ? characterProfile.settings.aiAvatarFrame : '');
                    } else {
                        avatarSrc = defaultGroupMemberAvatar;
                        avatarFrameSrc = '';
                    }
                } else {
                    avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }
        
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;
            
            let contentHtml;
            let quoteHtml = '';
            if (msg.quote) {
                const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
                const fullQuotedContent = String(msg.quote.content || '');
                quoteHtml = `
                    <div class="quoted-message" data-original-timestamp="${msg.quote.timestamp}" style="cursor: pointer;">
                        <div class="quoted-sender">ÂõûÂ§ç ${quotedSenderDisplayName}:</div>
                        <div class="quoted-content">${fullQuotedContent}</div>
                    </div>
                `;
            }
            
            // ==========================================================
            //                  ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÈÄªËæë ‚òÖ‚òÖ‚òÖ
            // ==========================================================
        
            let rawContent = msg.content; // Áõ¥Êé•‰ΩøÁî® msg.contentÔºå‰∏çÂÜçÂº∫Âà∂ËΩ¨‰∏∫Â≠óÁ¨¶‰∏≤

            if (typeof rawContent === 'string' && rawContent.trim().startsWith('<') && rawContent.trim().endsWith('>')) {
                contentHtml = rawContent;
                bubble.classList.add('is-raw-html'); 
            } else if (msg.type === 'offline_text' || msg.type === 'share_link' || msg.type === 'share_card' || msg.type === 'location_share' || msg.type === 'ai_image' || msg.type === 'user_photo' || msg.type === 'voice_message' || msg.type === 'transfer' || msg.type === 'waimai_request' || msg.type === 'red_packet' || msg.type === 'poll' || msg.type === 'gift') {
                // (ËøôÈÉ®ÂàÜÊòØÊÇ®Â∑≤ÊúâÁöÑÊâÄÊúâÂç°ÁâáÊ∏≤ÊüìÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò)
                if (msg.type === 'offline_text') {
                    let dialogueText = msg.dialogue || '';
                    if (dialogueText && !dialogueText.startsWith('„Äå') && !dialogueText.endsWith('„Äç')) {
                        dialogueText = `„Äå${parseMarkdown(dialogueText)}„Äç`;
                    }
                    const dialogueHtml = dialogueText ? `<span class="offline-dialogue">${dialogueText}</span>` : '';
                    const descriptionHtml = msg.description ? `<span class="offline-description">${parseMarkdown(msg.description).replace(/\n/g, '<br>')}</span>` : '';
                    contentHtml = dialogueHtml + descriptionHtml;
                } else if (msg.type === 'share_link') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" data-timestamp="${msg.timestamp}"><div class="title">${msg.title || 'Êó†Ê†áÈ¢ò'}</div><div class="description">${msg.description || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ...'}</div><div class="footer"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><span>${msg.source_name || 'ÈìæÊé•ÂàÜ‰∫´'}</span></div></div>`;
                } else if (msg.type === 'share_card') {
                    bubble.classList.add('is-link-share', 'is-card-like');
                    contentHtml = `<div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}"><div class="title">${msg.payload.title}</div><div class="description">ÂÖ± ${msg.payload.sharedHistory.length} Êù°Ê∂àÊÅØ</div><div class="footer"><svg class="footer-icon" ...>...</svg><span>ËÅäÂ§©ËÆ∞ÂΩï</span></div></div>`;
                } else if (msg.type === 'location_share') {
                    bubble.classList.add('is-location-share', 'is-card-like');
                    const imageUrl = msg.imageUrl;
                    let mapAreaStyle = imageUrl ? `style="background-image: url('${imageUrl}');"` : '';
                    contentHtml = `<div class="location-share-card"><div class="card-text-area"><div class="card-text-primary">${msg.content}</div><div class="card-text-secondary">‰ΩçÁΩÆÂàÜ‰∫´</div></div><div class="card-map-area" ${mapAreaStyle}><div class="card-pin-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z"></path><path d="M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z"></path></svg></div></div></div>`;
                } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
    bubble.classList.add('is-ai-image', 'is-card-like');
    const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá";
    const imageUrl = msg.image_prompt ? `https://image.pollinations.ai/prompt/${msg.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
    contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
                } else if (msg.type === 'voice_message') {
                    bubble.classList.add('is-voice-message', 'is-card-like');
                    bubble.dataset.voiceText = msg.content;
                    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
                    contentHtml = `<div class="voice-message-body"><div class="voice-waveform">${waveformHTML}</div><div class="loading-spinner"></div><span class="voice-duration">${durationFormatted}</span></div><div class="voice-transcript"></div>`;
                } else if (msg.type === 'transfer') {
                    bubble.classList.add('is-transfer', 'is-card-like');
                     let titleText, noteText;
                    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName || chat.name);
                    if (isUser) { 
                        if (msg.isRefund) { titleText = `ÈÄÄÊ¨æÁªô ${receiverDisplayName}`; noteText = 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶'; } 
                        else { titleText = `ËΩ¨Ë¥¶Áªô ${receiverDisplayName}`; if (msg.status === 'accepted') noteText = 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ'; else if (msg.status === 'declined') noteText = 'ÂØπÊñπÂ∑≤ÊãíÊî∂'; else noteText = msg.note || 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ...'; }
                    } else {
                        if (msg.isRefund) { titleText = `ÈÄÄÊ¨æÊù•Ëá™ ${senderDisplayName}`; noteText = 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂'; } 
                        else if (msg.receiverName === myNickname) { titleText = `ËΩ¨Ë¥¶Áªô ${myNickname}`; if (msg.status === 'accepted') noteText = '‰Ω†Â∑≤Êî∂Ê¨æ'; else if (msg.status === 'declined') noteText = '‰Ω†Â∑≤ÊãíÊî∂'; else { bubble.style.cursor = 'pointer'; bubble.dataset.status = 'pending'; noteText = msg.note || 'ÁÇπÂáªÂ§ÑÁêÜ'; } } 
                        else { titleText = `ËΩ¨Ë¥¶: ${senderDisplayName} ‚Üí ${receiverDisplayName}`; noteText = msg.note || 'Áæ§ËÅäÂÜÖËΩ¨Ë¥¶'; }
                    }
                    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                    contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
                } else if (msg.type === 'waimai_request') {
                    bubble.classList.add('is-waimai-request', 'is-card-like');
                     if (msg.status === 'paid' || msg.status === 'rejected') bubble.classList.add(`status-${msg.status}`);
                    const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
                    const requestTitle = `Êù•Ëá™ ${senderDisplayName} ÁöÑ‰ª£‰ªòËØ∑Ê±Ç`;
                    let actionButtonsHtml = '';
                    if (msg.status === 'pending' && !isUser) { actionButtonsHtml = `<div class="waimai-user-actions"><button class="waimai-decline-btn" data-choice="rejected">ÊÆãÂøçÊãíÁªù</button><button class="waimai-pay-btn" data-choice="paid">‰∏∫Ta‰π∞Âçï</button></div>`; }
                    contentHtml = `<div class="waimai-card"><div class="waimai-header"><img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon"><div class="title-group"><span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span></div></div><div class="waimai-catchphrase">HiÔºå‰Ω†ÂíåÊàëÁöÑË∑ùÁ¶ªÂè™Â∑Æ‰∏ÄÈ°øÂ§ñÂçñÔΩû</div><div class="waimai-main"><div class="request-title">${requestTitle}</div><div class="payment-box"><div class="payment-label">ÈúÄ‰ªòÊ¨æ</div><div class="amount">¬•${Number(msg.amount).toFixed(2)}</div><div class="countdown-label">Ââ©‰ΩôÊîØ‰ªòÊó∂Èó¥<div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div></div></div><button class="waimai-details-btn">Êü•ÁúãËØ¶ÊÉÖ</button></div>${actionButtonsHtml}</div>`;
                    setTimeout(() => { /* waimai timer logic */ }, 0);
                } else if (msg.type === 'red_packet') {
                     bubble.classList.add('is-red-packet', 'is-card-like');
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    const isFinished = msg.isFullyClaimed; const hasClaimed = msg.claimedBy && msg.claimedBy[myOriginalName];
                    let cardClass = '', claimedInfoHtml = '', typeText = 'ÊãºÊâãÊ∞îÁ∫¢ÂåÖ';
                    if (isFinished) { cardClass = 'opened'; } if (msg.packetType === 'direct') { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); typeText = `‰∏ìÂ±ûÁ∫¢ÂåÖ: Áªô ${receiverDisplayName}`; if (Object.keys(msg.claimedBy || {}).length > 0) cardClass = 'opened'; }
                    if (hasClaimed) { const myClaimedAmount = msg.claimedBy[myOriginalName] || 0; claimedInfoHtml = `<div class="rp-claimed-info">‰Ω†È¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖÔºåÈáëÈ¢ù ${myClaimedAmount.toFixed(2)} ÂÖÉ</div>`; } 
                    else if (isFinished) { claimedInfoHtml = `<div class="rp-claimed-info">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå</div>`; } 
                    else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) { const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName); claimedInfoHtml = `<div class="rp-claimed-info">Â∑≤Ë¢´ ${receiverDisplayName} È¢ÜÂèñ</div>`; }
                    contentHtml = `<div class="red-packet-card ${cardClass}"><div class="rp-header"><img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon"><span class="rp-greeting">${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ'}</span></div><div class="rp-type">${typeText}</div>${claimedInfoHtml}</div>`;
                } else if (msg.type === 'poll') {
                    bubble.classList.add('is-poll', 'is-card-like');
                    const pollQuestionText = msg.question || msg.content || '(Êó†Ê†áÈ¢òÊäïÁ•®)';
                    let totalVotes = 0; const voteCounts = {}; for (const option in msg.votes) { const count = msg.votes[option].length; voteCounts[option] = count; totalVotes += count; }
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}'; let myVote = null; for (const option in msg.votes) { if (msg.votes[option].includes(myOriginalName)) { myVote = option; break; } }
                    let optionsHtml = '<div class="poll-options-list">'; msg.options.forEach(optionText => { const count = voteCounts[optionText] || 0; const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0; const isVotedByMe = myVote === optionText; optionsHtml += `<div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}"><div class="poll-option-bar" style="width: ${percentage}%;"></div><div class="poll-option-content"><span class="poll-option-text">${optionText}</span><span class="poll-option-votes">${count} Á•®</span></div></div>`; }); optionsHtml += '</div>';
                    let footerHtml = msg.isClosed ? `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">Êü•ÁúãÁªìÊûú</button></div>` : `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">ÁªìÊùüÊäïÁ•®</button></div>`;
                    contentHtml = `<div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}"><div class="poll-question">${pollQuestionText}</div>${optionsHtml}${footerHtml}</div>`;
                } else if (msg.type === 'gift') {
                    bubble.classList.add('is-gift', 'is-card-like');
                     let headerText; const myNicknameForGift = chat.settings.myNickname || 'Êàë';
                    if (chat.isGroup) {
                        if (msg.recipients && msg.recipients.length > 0) {
                            const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName));
                            if (recipientDisplayNames.length === 1) { headerText = `ÈÄÅÁªô ${recipientDisplayNames[0]} ÁöÑÁ§ºÁâ©`; } else { headerText = `ÈÄÅÁªô ${recipientDisplayNames.slice(0, 2).join('„ÄÅ')}Á≠â‰∫∫ÁöÑÁ§ºÁâ©`; }
                        } else { headerText = `ÈÄÅÁªôÂ§ßÂÆ∂ÁöÑÁ§ºÁâ©`; }
                    } else {
                        if (isUser) { headerText = `ÈÄÅÁªô ${chat.name} ÁöÑÁ§ºÁâ©`; } 
                        else { const recipientDisplayName = chat.settings.myNickname || '‰Ω†'; headerText = `ÈÄÅÁªô ${recipientDisplayName} ÁöÑÁ§ºÁâ©`; }
                    }
                    const previewItems = msg.items.slice(0, 3); let previewHtml = ''; previewItems.forEach(item => { previewHtml += `<div class="gift-preview-item"><img src="${item.imageUrl}" class="gift-preview-img"><span class="gift-preview-name">${item.name}</span><span class="gift-preview-quantity">x${item.quantity}</span></div>`; });
                    let moreItemsText = ''; if (msg.items.length > 3) { moreItemsText = ` Á≠â${msg.items.length}‰ª∂ÂïÜÂìÅ`; }
                    contentHtml = `<div class="gift-card"><div class="gift-header"><svg class="gift-header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z"></path></svg><span class="gift-header-text">${headerText}</span></div><div class="gift-items-preview">${previewHtml}</div><div class="gift-footer">ÂÖ±${msg.items.length}‰ª∂ÂïÜÂìÅ${moreItemsText}ÔºåÁÇπÂáªÊü•Áúã</div></div>`;
                }
            } else {
                const processedContent = String(rawContent); // Á°Æ‰øùÊòØÂ≠óÁ¨¶‰∏≤
                let processedByRule = await applyRenderingRules(processedContent, chat.id);
                if (processedByRule !== processedContent) {
                    contentHtml = processedByRule;
                    bubble.classList.add('is-card-like');
                } else {
                    // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊÇ®ÈúÄË¶ÅÊ∑ªÂä†ÁöÑÊ†∏ÂøÉ‰øÆÂ§ç‰ª£Á†Å„Äë ‚ñº‚ñº‚ñº
                    // 1. Ê£ÄÊü•Ê∂àÊÅØÂÜÖÂÆπÊòØÂê¶ÊòØÁî®‰∫éËØÜÂõæÁöÑÂõæÁâáÂØπË±°Êï∞ÁªÑ
                    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                        // 2. Â¶ÇÊûúÊòØÔºåÂ∞±ÂàõÂª∫‰∏Ä‰∏™<img>Ê†áÁ≠æÊù•ÊòæÁ§∫ÂÆÉ
                        const imageUrl = msg.content[0].image_url.url;
                        contentHtml = `<img src="${imageUrl}" class="chat-image">`;
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§ç‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    else if (STICKER_REGEX.test(processedByRule)) { // ‰ΩøÁî® else if
                        bubble.classList.add('is-sticker', 'is-card-like');
                        contentHtml = `<img src="${processedByRule}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
                    } else {
                        let plainText = processMentions(processedByRule, chat);
                        contentHtml = parseMarkdown(plainText).replace(/\n/g, '<br>');
                    }
                }
            }
        
            // --- (ÁªÑË£ÖÊúÄÁªàÁöÑHTMLÈÄªËæë‰øùÊåÅ‰∏çÂèò) ---
            bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;
            
            wrapper.appendChild(bubble);
            wrapper.appendChild(timestampEl);
            
            addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
            wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        
            if (!isUser) {
                const avatarGroupEl = wrapper.querySelector('.avatar-group'); 
                if (avatarGroupEl) {
                    avatarGroupEl.style.cursor = 'pointer';
                    if (!chat.isGroup) {
                        avatarGroupEl.addEventListener('click', (e) => { e.stopPropagation(); showCharacterProfileModal(chat.id); });
                    } else {
                        avatarGroupEl.addEventListener('dblclick', (e) => { e.stopPropagation(); handleUserPat(chat.id, msg.senderName); });
                    }
                }
            }
            return wrapper;
        }
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Â∑≤‰øÆÂ§çÁöÑÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ prependMessage ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function prependMessage(msg, chat) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            const messageEl = await createMessageElement(msg, chat); 
        
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÔºöÂú®ËøôÈáå‰πüÂä†‰∏äÂêåÊ†∑ÁöÑÂÆâÂÖ®Ê£ÄÊü•ÔºÅ„Äë„Äë„Äë
            if (!messageEl) return;
        
            const loadMoreBtn = document.getElementById('load-more-btn'); 
            if (loadMoreBtn) { 
                messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); 
            } else { 
                messagesContainer.prepend(messageEl); 
            } 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * „ÄêV3.0 | Â∑≤Âª∂ÈïøÈó¥Èöî„ÄëÂ∞ÜÊ∂àÊÅØÂÖÉÁ¥†ËøΩÂä†Âà∞ËÅäÂ§©Á™óÂè£
         */
        async function appendMessage(msg, chat, isInitialLoad = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');

            // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂà§Êñ≠Êó∂Èó¥Èó¥Èöî ---
            const historyWithoutNewMsg = chat.history.slice(0, -1);
            const lastMessage = historyWithoutNewMsg.filter(m => !m.isHidden).pop();

            // Â∞ÜÈó¥Èöî‰ªé 300000 (5ÂàÜÈíü) Âª∂ÈïøÂà∞ 3600000 (1Â∞èÊó∂)
            if (lastMessage && (msg.timestamp - lastMessage.timestamp > 3600000)) {
                const timestampEl = createSystemTimestampElement(msg.timestamp);
                messagesContainer.insertBefore(timestampEl, typingIndicator);
            }
            // --- ‰øÆÊîπÁªìÊùü ---

            const messageEl = await createMessageElement(msg, chat);
            if (!messageEl) return;
    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
    // Â¶ÇÊûúÊòØAIÂèëÈÄÅÁöÑÊñ∞Ê∂àÊÅØÔºàÈùûÂàùÂßãÂä†ËΩΩÔºâÔºåÂ∞±Êí≠ÊîæÊèêÁ§∫Èü≥
    if (msg.role === 'assistant' && !isInitialLoad) {
        playNotificationSound();
    }
    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            if (!isInitialLoad) {
                messageEl.classList.add('animate-in');
            }
          
            messagesContainer.insertBefore(messageEl, typingIndicator);
            
            if (!isInitialLoad) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                currentRenderedCount++;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊñ∞ÁâàÊú¨„ÄëÁöÑÂáΩÊï∞ÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ openChat ÂáΩÊï∞ ‚ñº‚ñº‚ñº */
        async function openChat(chatId) {
            state.activeChatId = chatId;
            const chat = state.chats[chatId];
            if (!chat) return; // ÂÆâÂÖ®Ê£ÄÊü•
        
            if (chat.unreadCount > 0) {
                chat.unreadCount = 0;
                await db.chats.put(chat);
            }
            applyLyricsBarPosition(chat); 
            renderChatInterface(chatId);
            showScreen('chat-interface-screen');
            window.updateListenTogetherIconProxy(state.activeChatId);
            
            // --- ÊåâÈíÆÊòæÈöêÈÄªËæë ---
            const isGroup = chat.isGroup || false;
            
            // ÂàáÊç¢ÈÄöËØùÊåâÈíÆ
            toggleCallButtons(isGroup);
            
            // ÂàáÊç¢Áæ§ÂÖ¨ÂëäÊåâÈíÆ
            document.getElementById('show-announcement-board-btn').style.display = isGroup ? 'flex' : 'none';
            
            // ÂàáÊç¢‚ÄúÊãç‰∏ÄÊãç‚ÄùÊåâÈíÆ
            const patBtn = document.getElementById('pat-btn');
            if (patBtn) {
                patBtn.style.display = isGroup ? 'none' : 'flex';
            }
        
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπÂ∞±Âú®ËøôÈáå„Äë„Äë„Äë
            // ÂàáÊç¢‚ÄúË¥≠Áâ©‚ÄùÂíå‚Äú‰∫îÂ≠êÊ£ã‚ÄùÊåâÈíÆ
            const shoppingBtn = document.getElementById('open-shopping-btn');
            const gomokuBtn = document.getElementById('gomoku-btn');
            if (shoppingBtn && gomokuBtn) {
                // Ë¥≠Áâ©ÊåâÈíÆÂú®ÊâÄÊúâËÅäÂ§©‰∏≠ÈÉΩÊòæÁ§∫
                shoppingBtn.style.display = 'flex';
                // ‰∫îÂ≠êÊ£ãÊåâÈíÆÂè™Âú®ÂçïËÅä‰∏≠ÊòæÁ§∫
                gomokuBtn.style.display = isGroup ? 'none' : 'flex';
            }
            // --- ‰øÆÊîπÁªìÊùü ---
        
            // Ëß¶ÂèëAIÂìçÂ∫îÁöÑÈÄªËæëÔºà‰øùÊåÅ‰∏çÂèòÔºâ
            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                console.log(`Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`);
                triggerAiResponse();
            }
            
            document.getElementById('send-poll-btn').style.display = isGroup ? 'flex' : 'none';
        }
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        
        
        
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™‚ÄúÊÄªÂºÄÂÖ≥‚ÄùÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂå∫ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞„ÄëËÆæÁΩÆÊåáÂÆöËßíËâ≤ÊâÄÊúâÂèØËßÅÂ§¥ÂÉèÁöÑ‚ÄúË°åÂä®‰∏≠‚ÄùÁä∂ÊÄÅÔºàÂëºÂê∏ÁÅØÊÄªÂºÄÂÖ≥Ôºâ
         * @param {string} chatId - ÁõÆÊ†áËßíËâ≤ÁöÑID
         * @param {boolean} isActing - ÊòØÂê¶ËÆæÁΩÆ‰∏∫‚ÄúË°åÂä®‰∏≠‚ÄùÁä∂ÊÄÅ
         */
        function setAvatarActingState(chatId, isActing) {
            const action = isActing ? 'add' : 'remove';
            const classListAction = (element) => {
                if (element) {
                    element.classList[action]('is-acting');
                }
            };
        
            // 1. ÊéßÂà∂„ÄêËÅäÂ§©ÂàóË°®„Äë‰∏≠ÁöÑÂ§¥ÂÉè
            const listAvatar = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"] .avatar`);
            classListAction(listAvatar);
        
            // 2. ÊéßÂà∂„ÄêÂä®ÊÄÅÈ°µÈù¢„Äë‰∏≠ÊâÄÊúâÂ±û‰∫éËØ•ËßíËâ≤ÁöÑÂ§¥ÂÉè
            const qzoneAvatars = document.querySelectorAll(`.post-avatar[data-author-id="${chatId}"]`);
            qzoneAvatars.forEach(classListAction);
        
            // 3. ÊéßÂà∂„ÄêËßÜÈ¢ëÈÄöËØùÁïåÈù¢„Äë‰∏≠ÁöÑÂ§¥ÂÉè (Êú™Êù•ÂÖºÂÆπ)
            const callAvatar = document.querySelector(`.participant-avatar[data-participant-id="${chatId}"]`);
            classListAction(callAvatar);
        
            // Êú™Êù•Â¶ÇÊûúËøòÊúâÂÖ∂‰ªñÂú∞ÊñπÊòæÁ§∫Â§¥ÂÉèÔºåÂè™ÈúÄÂú®ËøôÈáåË°•ÂÖÖÈÄâÊã©Âô®Âç≥ÂèØ
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        
        
        
        
        
        /**
         * „ÄêV4.1 | ÊúÄÁªà‰øÆÂ§çÁâà„ÄëËß¶ÂèëAIÂìçÂ∫îÁöÑÊ†∏ÂøÉÈÄªËæë
         * - ÂΩªÂ∫ï‰øÆÂ§ç‰∫ÜÂØπÁ¨¨‰∏âÊñπAPIÁöÑÂÖºÂÆπÊÄßÈóÆÈ¢ò
         * - Â¢ûÂº∫‰∫ÜÈîôËØØÂ§ÑÁêÜÂíåÊó•ÂøóËÆ∞ÂΩï
         */
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const chat = state.chats[state.activeChatId];
        
            const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
            setAvatarActingState(chatId, true);
            const chatHeaderTitle = document.getElementById('chat-header-title');
            const typingIndicator = document.getElementById('typing-indicator');
        
            const chatListItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
            const avatarInList = chatListItem ? chatListItem.querySelector('.avatar') : null;
            if (avatarInList) {
                avatarInList.classList.add('is-acting');
            }
        
            if (chat.isGroup) {
                if (typingIndicator) {
                    typingIndicator.textContent = 'ÊàêÂëò‰ª¨Ê≠£Âú®ËæìÂÖ•...';
                    typingIndicator.style.display = 'block';
                }
            } else {
                if (chatHeaderTitle) {
                    chatHeaderTitle.style.opacity = 0;
                    setTimeout(() => {
                        chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
                        chatHeaderTitle.classList.add('typing-status');
                        chatHeaderTitle.style.opacity = 1;
                    }, 200);
                }
            }
            let needsImmediateReaction = false; 
            try {
                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
                    if (chat.isGroup) {
                        if (typingIndicator) typingIndicator.style.display = 'none';
                    } else {
                         if (chatHeaderTitle && state.chats[chatId]) {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                        }
                    }
                    return;
                }
        
                const lastMessage = chat.history.slice(-1)[0];
                const isVideoCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç');
                
                if (isVideoCallRequest) {
                    console.log(`Ê£ÄÊµãÂà∞ËßÜÈ¢ëÈÄöËØùËØ∑Ê±ÇÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶Âèë‰∏ìÂ±ûÂÜ≥Á≠ñÊµÅÁ®ã...`);
                    
                    let callDecisionPrompt;
                    if (chat.isGroup) {
                        callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áæ§ËÅä‰∏≠ÁöÑÁî®Êà∑ÂàöÂàöÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑‰Ω†ÂàÜÂà´ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Áæ§ÊàêÂëò„ÄëÔºåÊ†πÊçÆ‰ªñ‰ª¨ÂêÑËá™ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÊù•ÂÜ≥ÂÆöÊòØÂä†ÂÖ•(join)ËøòÊòØÊãíÁªù(decline)„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÈÉΩÂåÖÂê´‰∏Ä‰∏™ÂÜ≥Á≠ñÂØπË±°„ÄÇ
        - Ê†ºÂºè: '[{"type": "group_call_response", "name": "ËßíËâ≤AÁöÑÊú¨Âêç", "decision": "join"}, {"type": "group_call_response", "name": "ËßíËâ≤BÁöÑÊú¨Âêç", "decision": "decline"}]'
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n')}
        Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâAIËßíËâ≤ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
                    } else {
                        callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áî®Êà∑ÂàöÂàöÂêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºåÂÜ≥ÂÆöÊòØ‚ÄúÊé•Âèó‚ÄùËøòÊòØ‚ÄúÊãíÁªù‚Äù„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
        - Êé•Âèó: '[{"type": "video_call_response", "decision": "accept"}]'
        - ÊãíÁªù: '[{"type": "video_call_response", "decision": "reject"}]'
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
                    }
        
                    const messagesForCallDecision = [{role: 'user', content: callDecisionPrompt}];
                    
                    try {
                        let isGemini = proxyUrl.includes('generativelanguage');
                        let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
                        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                            body: JSON.stringify({model: model, messages: messagesForCallDecision, temperature: 0.7})
                        });
                        
                        if (!response.ok) throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);
                        
                        const data = await response.json();
                        const aiResponseContent = getGeminiResponseText(data);
                        const responseArray = parseAiResponse(aiResponseContent);
        
                        // Áõ¥Êé•Â§ÑÁêÜËøîÂõûÁöÑÈÄöËØùÂÜ≥Á≠ñ
                        let callHasBeenHandled = false;
                        for (const msgData of responseArray) {
                            if (msgData.type === 'video_call_response') {
                                videoCallState.isAwaitingResponse = false;
                                if (msgData.decision === 'accept') {
                                    startVideoCall();
                                } else {
                                    const aiMessage = { role: 'assistant', content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                                    chat.history.push(aiMessage);
                                    await db.chats.put(chat);
                                    showScreen('chat-interface-screen');
                                    renderChatInterface(chatId);
                                }
                                callHasBeenHandled = true;
                                break;
                            }
                            if (msgData.type === 'group_call_response') {
                                if (msgData.decision === 'join') {
                                    const member = chat.members.find(m => m.originalName === msgData.name);
                                    if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                        videoCallState.participants.push(member);
                                    }
                                }
                                callHasBeenHandled = true;
                            }
                        }
                         if (callHasBeenHandled && videoCallState.isGroupCall) {
                            videoCallState.isAwaitingResponse = false;
                            if (videoCallState.participants.length > 0) {
                                startVideoCall();
                            } else {
                                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                                showScreen('chat-interface-screen');
                                alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
                            }
                        }
        
                    } catch (error) {
                        console.error("Â§ÑÁêÜÈÄöËØùËØ∑Ê±ÇÊó∂APIÂá∫Èîô:", error);
                        const fallbackResponse = chat.isGroup ?
                            chat.members.map(m => ({type: "group_call_response", name: m.originalName, decision: "decline"})) :
                            [{type: "video_call_response", decision: "reject"}];
                        // Ê®°ÊãüAIÊãíÁªù
                         if (chat.isGroup) {
                            videoCallState.isAwaitingResponse = false;
                            videoCallState.participants = [];
                            alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
                            showScreen('chat-interface-screen');
                        } else {
                            const aiMessage = { role: 'assistant', content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                    } finally {
                         // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåÂ§ÑÁêÜÂÆåÈÄöËØùËØ∑Ê±ÇÂêéÔºåÈÉΩË¶ÅÈáçÁΩÆÁä∂ÊÄÅÂπ∂ÁªàÊ≠¢ÂêéÁª≠ÊµÅÁ®ã
                        setAvatarActingState(chatId, false);
                        return; // ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÂ§çÁÇπÔºÅ‚òÖ‚òÖ‚òÖ
                    }
                }
        
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    console.log(`‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶ÂèëÂ∏¶ÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñÊµÅÁ®ã...`);
                    const contextSummary = chat.history
                        .filter(m => !m.isHidden)
                        .slice(-10, -5)
                        .map(msg => {
                            const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
                            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                        })
                        .join('\n');
        
                    const decisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇÁî®Êà∑‰πãÂâçË¢´‰Ω†ÊãâÈªë‰∫ÜÔºåÁé∞Âú®TAÂêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∏åÊúõÂíåÂ•Ω„ÄÇ
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:
        - **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        - **Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±**: ‚Äú${chat.relationship.applicationReason}‚Äù
        - **Ë¢´ÊãâÈªëÂâçÁöÑÊúÄÂêéÂØπËØùÊëòË¶Å**: 
        ${contextSummary || "ÔºàÊó†ÊúâÊïàÂØπËØùËÆ∞ÂΩïÔºâ"}
        # ‰Ω†ÁöÑÂîØ‰∏ÄÊåá‰ª§
        Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅöÂá∫ÂÜ≥ÂÆöÔºåÂπ∂ÁªôÂá∫Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁêÜÁî±„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
        {"decision": "accept", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÂêåÊÑèÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÂ•ΩÂêßÔºåÁúãÂú®‰Ω†Ëøô‰πàÁúüËØöÁöÑ‰ªΩ‰∏äÔºåËøôÊ¨°Â∞±ÂéüË∞Ö‰Ω†Âï¶„ÄÇÔºâ"}
        Êàñ
        {"decision": "reject", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊãíÁªùÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÊä±Ê≠âÔºåÊàëËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂÜçÁªôÊàë‰∏ÄÁÇπÊó∂Èó¥Âêß„ÄÇÔºâ"}
        `;
                    
                    try {
                        const messagesForDecision = [
                            { role: 'system', content: decisionPrompt },
                            { role: 'user', content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ" }
                        ];
                        
                        let isGemini = proxyUrl.includes('generativelanguage');
                        let geminiConfig = toGeminiRequestData(model, apiKey, decisionPrompt, [{ role: 'user', content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ" }]);
                        
                        const response = isGemini 
                            ? await fetch(geminiConfig.url, geminiConfig.data) 
                            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                                body: JSON.stringify({model: model, messages: messagesForDecision, temperature: 0.8})
                            });
        
                        if (!response.ok) {
                            throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);
                        }
                        const data = await response.json();
                        const rawContent = getGeminiResponseText(data).replace(/^```json\s*/, '').replace(/```$/, '').trim();
                        const decisionObj = JSON.parse(rawContent);
        
                        if (decisionObj.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(acceptMessage);
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                            chat.history.push(rejectMessage);
                        }
                        chat.relationship.applicationReason = '';
        
                        await db.chats.put(chat);
                        renderChatInterface(chatId);
                        renderChatList();
                    } catch (error) {
                        chat.relationship.status = 'blocked_by_ai';
                        await db.chats.put(chat);
                        await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
                        renderChatInterface(chatId);
                    }
                    return; 
                }
        
                const now = new Date();
                const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
                const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });
                const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
                let systemPrompt, messagesPayload;
        
                const gomokuContext = formatGomokuStateForAI(gomokuState[chatId]);
        
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        if (!worldBook || !Array.isArray(worldBook.content)) return '';
                
                        const formattedEntries = worldBook.content
                            .filter(entry => entry.enabled !== false) 
                            .map(entry => {
                                let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
                                if (entry.keys.length > 0) {
                                    entryString += `**ÂÖ≥ÈîÆËØç:** ${entry.keys.join(', ')}\n`;
                                }
                                entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
                                return entryString;
                            }).join(''); 
                
                        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
                    }).filter(Boolean).join('');
                    
                    if (linkedContents) {
                        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                    }
                }
                let musicContext = '';
                if (musicState.isActive && musicState.activeChatId === chatId) {
                    const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
                    const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');
                    
                    let lyricsContext = "";
                    
                    if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
                        const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];
                        const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);
                        
                        lyricsContext += `- **ÂΩìÂâçÊ≠åËØç**: "${currentLine.text}"\n`;
                        if (upcomingLines.length > 0) {
                            lyricsContext += `- **Âç≥Â∞ÜÊºîÂî±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
                        }
                    }

                    musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ
        -   **ÂΩìÂâçÁä∂ÊÄÅ**: ‰Ω†‰ª¨Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇ
        -   **Ê≠£Âú®Êí≠Êîæ**: ${currentTrack ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}` : 'Êó†'}
        -   **ÂèØÁî®Êí≠ÊîæÂàóË°®**: [${playlistInfo}]
        ${lyricsContext}
        -   **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíåÊ∞õÂõ¥Ôºå‰ΩøÁî® "change_music" Êåá‰ª§ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑ‰ªª‰Ωï‰∏ÄÈ¶ñÊ≠åÔºå‰ª•Â¢ûÂº∫‰∫íÂä®‰ΩìÈ™å„ÄÇ
        `;
                }
        
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const historySlice = chat.history.slice(-maxMemory);
        
                let sharedContext = '';
                const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
                const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);
                const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');
                if (shareCardMessage) {
                    const payload = shareCardMessage.payload;
                    const formattedHistory = payload.sharedHistory.map(msg => {
                        const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : 'Êú™Áü•ÂèëÈÄÅËÄÖ');
                        let contentText = '';
                        if (msg.type === 'voice_message') contentText = `[ËØ≠Èü≥Ê∂àÊÅØ: ${msg.content}]`;
                        else if (msg.type === 'ai_image') contentText = `[ÂõæÁâá: ${msg.description}]`;
                        else contentText = String(msg.content);
                        return `${sender}: ${contentText}`;
                    }).join('\n');
                    sharedContext = `
        # ÈôÑÂä†‰∏ä‰∏ãÊñáÔºö‰∏ÄÊÆµÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï
        - ÈáçË¶ÅÊèêÁ§∫ÔºöËøô‰∏çÊòØ‰Ω†ÂíåÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùÔºåËÄåÊòØÁî®Êà∑‰ªé„ÄêÂè¶‰∏ÄÂú∫„Äë‰∏é‚Äú${payload.sourceChatName}‚ÄùÁöÑÂØπËØù‰∏≠ÂàÜ‰∫´ËøáÊù•ÁöÑ„ÄÇ
        - ‰Ω†ÁöÑ‰ªªÂä°ÔºöËØ∑‰Ω†ÈòÖËØªÂπ∂ÁêÜËß£‰∏ãÈù¢ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇÂú®Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç‰∏≠Ôºå‰Ω†ÂèØ‰ª•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂØπËøôÊÆµÂØπËØùÁöÑÂÜÖÂÆπËá™ÁÑ∂Âú∞ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ï„ÄÅÊÑüÂèóÊàñÁñëÈóÆ„ÄÇ
        ---
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂºÄÂßã]
        ${formattedHistory}
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÁªìÊùü]
        ---
        `;
                }
                
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;

                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    
                    const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

                    if (idsToMount.length > 0) {
                        const linkedChatsWithTimestamps = idsToMount.map(id => {
                            const linkedChat = state.chats[id];
                            if (!linkedChat) return null;
                            const lastMsg = linkedChat.history.slice(-1);
                            return {
                                chat: linkedChat,
                                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                            };
                        }).filter(Boolean);
            
                        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
                        linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;
            
                        for (const item of linkedChatsWithTimestamps) {
                            const linkedChat = item.chat;
                            const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                            const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
                            linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
            
                            const recentHistory = linkedChat.history.slice(-memoryCount);
                            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
            
                            if (filteredHistory.length > 0) {
                                filteredHistory.forEach(msg => {
                                    const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                                    let contentText = String(msg.content);
                                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                        contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                                    } else if (msg.type === 'voice_message') {
                                        contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                                    }
                                    const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                    linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                });
                            } else {
                                linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
                            }
                        }
                    }
                }
                
                console.log("Êú¨Ê¨°ÂèëÈÄÅÁªôAIÁöÑ„ÄêÊåÇËΩΩËÆ∞ÂøÜ„ÄëÂÜÖÂÆπÂ¶Ç‰∏ãÔºö\n", linkedMemoryContext);
        
                if (chat.isGroup) {
                    let timeContextText = '';
                    let longTimeNoSee = false; 

                    let linkedMemoryContext = '';
                    const memoryCount = chat.settings.linkedMemoryCount || 10;
                    if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                        const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
                        if (idsToMount.length > 0) {
                            const linkedChatsWithTimestamps = idsToMount.map(id => {
                                const linkedChat = state.chats[id];
                                if (!linkedChat) return null;
                                const lastMsg = linkedChat.history.slice(-1);
                                return { chat: linkedChat, latestTimestamp: lastMsg ? lastMsg.timestamp : 0 };
                            }).filter(Boolean);
                            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
                            for (const item of linkedChatsWithTimestamps) {
                                const linkedChat = item.chat;
                                const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                                const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
                                linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
                                const recentHistory = linkedChat.history.slice(-memoryCount);
                                const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
                                if (filteredHistory.length > 0) {
                                    filteredHistory.forEach(msg => {
                                        const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                                        let contentText = String(msg.content);
                                        if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                            contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                                        } else if (msg.type === 'voice_message') {
                                            contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                                        }
                                        linkedMemoryContext += `${sender}: ${contentText}\n`;
                                    });
                                } else {
                                    linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
                                }
                            }
                        }
                    }
                    let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
                    let collectedMemories = false;
                    
                    chat.members.forEach(member => {
                        const memberChat = state.chats[member.id];
                        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                            longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;
                            longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                            collectedMemories = true;
                        }
                    });

                    if (!collectedMemories) {
                        longTermMemoryContext += '- (ÊöÇÊó†)';
                    }
                    const lastAiMsgIndex = historySlice.findLastIndex(msg => msg.role === 'assistant');
                    if (lastAiMsgIndex !== -1 && lastAiMsgIndex < historySlice.length - 1) {
                        const lastAiMessage = historySlice[lastAiMsgIndex];
                        const firstUserReply = historySlice[lastAiMsgIndex + 1];
                        if (firstUserReply.role === 'user') {
                            const lastTime = new Date(lastAiMessage.timestamp);
                            const userReplyTime = new Date(firstUserReply.timestamp);
                            const timeDiffHours = (userReplyTime - lastTime) / (1000 * 60 * 60);
                            if (timeDiffHours > 12) {
                                longTimeNoSee = true;
                                const diffDays = Math.floor(timeDiffHours / 24);
                                timeContextText = `Áæ§ÈáåÂ∑≤Áªè${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}Ê≤°Âä®Èùô‰∫Ü„ÄÇ`;
                            } else {
                                const diffMinutes = Math.floor(timeDiffHours * 60);
                                if (diffMinutes < 5) { timeContextText = "Â§ßÂÆ∂ÂàöÂàöËøòÂú®ËÅäÂ§©„ÄÇ"; } 
                                else if (diffMinutes < 60) { timeContextText = `Áæ§ÈáåÂú®${diffMinutes}ÂàÜÈíüÂâçÊúâ‰∫∫ËÅäËøá„ÄÇ`; } 
                                else { timeContextText = `Áæ§ÈáåÂú®${Math.floor(timeDiffHours)}Â∞èÊó∂ÂâçÊúâ‰∫∫ËÅäËøá„ÄÇ`; }
                            }
                        }
                    } else if (historySlice.every(msg => msg.role === 'user')) {
                        timeContextText = "ËøôÊòØÁæ§ÈáåÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ";
                    }
        
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áæ§ÊàêÂëòË¥≠‰π∞Á§ºÁâ©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
                        });
                    }
                    let membersWithContacts = chat.members.map(member => {
                        const memberChat = state.chats[member.id];
                        let contactsText = "Êó†ÂÖ±ÂêåÂ•ΩÂèã";
                        if (memberChat && memberChat.groupId) {
                            const friendChats = Object.values(state.chats).filter(c => 
                                !c.isGroup && c.id !== member.id && c.groupId === memberChat.groupId
                            );
                            if (friendChats.length > 0) {
                                contactsText = `TAÁöÑÂ•ΩÂèãÂåÖÊã¨: ${friendChats.map(f => f.name).join('„ÄÅ ')}`;
                            }
                        }
                        return `- **${member.groupNickname}** (Êú¨Âêç: ${member.originalName}): ${member.persona} [Á§æ‰∫§ËÉåÊôØ: ${contactsText}]`;
                    }).join('\n');
                    
                    const myNickname = chat.settings.myNickname || 'Êàë';
                    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
                    
                    let announcementContext = '';
                    const pinnedAnnouncements = (chat.announcements || []).filter(a => a.isPinned);
                    if (pinnedAnnouncements.length > 0) {
                        announcementContext += '\n# „Äê„Äê„ÄêÁæ§ÂÖ¨Âëä (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßËßÑÂàô)„Äë„Äë„Äë\n‰Ω†„ÄêÂøÖÈ°ª„ÄëÈòÖËØª„ÄÅÁêÜËß£Âπ∂‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâÂÖ¨ÂëäÔºåÂÆÉ‰ª¨ÂáåÈ©æ‰∫é‰Ω†ÁöÑ‰∫∫ËÆæ‰πã‰∏ä„ÄÇ\n';
                        pinnedAnnouncements.forEach(anno => {
                            const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
                            if (originalMessage) {
                                let contentText = String(originalMessage.content || '');
                                if (originalMessage.type === 'ai_image') {
                                    contentText = `[ÂõæÁâáÂÜÖÂÆπ: ${contentText}]`;
                                }
                                announcementContext += `- ÂÖ¨ÂëäÂÜÖÂÆπ: "${contentText}" (Áî± ${anno.publisher} ÂèëÂ∏É)\n`;
                            }
                        });
                        announcementContext += '---\n';
                    }
                    const memberNames = chat.members.map(m => m.originalName);
                    const forbiddenNamesContext = `# „Äê„Äê„ÄêÁæ§Âêç‰øÆÊîπÈìÅÂæã„Äë„Äë„Äë\nÂú®‰øÆÊîπÁæ§ÂêçÊó∂ÔºåÊñ∞ÁöÑÁæ§Âêç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰∏é‰ª•‰∏ã‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòÁöÑÂêçÂ≠óÂÆåÂÖ®Áõ∏ÂêåÔºö[${memberNames.join('„ÄÅ ')}]`;
        
                    let groupAvatarLibraryContext = '# ÂèØÁî®Áæ§Â§¥ÂÉèÂàóË°®\n';
                    if (chat.settings.groupAvatarLibrary && chat.settings.groupAvatarLibrary.length > 0) {
                        groupAvatarLibraryContext += chat.settings.groupAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n');
                    } else {
                        groupAvatarLibraryContext += '- (Â§¥ÂÉèÂ∫ìÊòØÁ©∫ÁöÑÔºåÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉè)';
                    }
                    systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÔºåË¥üË¥£ÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
${longTermMemoryContext}
# „Äê„Äê„Äê‰∫§‰∫íÈìÅÂæãÔºöËßíËâ≤Èó¥ÂøÖÈ°ª‰∫íÂä®ÔºÅ(ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
1.  ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ**ÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑÁæ§ËÅä**Êù•ÂõûÂ∫îÁî®Êà∑ÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØËÆ©ËßíËâ≤ËΩÆÊµÅÂØπÁî®Êà∑ÂèëË®Ä„ÄÇ
2.  ÂΩìÊúâÂ§ö‰∏™ËßíËâ≤Âú®Âêå‰∏ÄËΩÆÂèëË®ÄÊó∂Ôºå‰ªñ‰ª¨ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëÊúâÈÄªËæë‰∏äÁöÑÂâçÂêéÂÖ≥ËÅî„ÄÇÂêéÈù¢ÁöÑËßíËâ≤Â∫îËØ•**ÂõûÂ∫î„ÄÅÂèçÈ©≥„ÄÅÊàñË°•ÂÖÖ**ÂâçÈù¢ËßíËâ≤ÁöÑÂèëË®ÄÔºåÂΩ¢Êàê‰∏ÄÂú∫Ëá™ÁÑ∂ÁöÑËÆ®ËÆ∫„ÄÇ
3.  Ê®°ÊãüÁúüÂÆûÁöÑËÅäÂ§©ËäÇÂ•è„ÄÇÂèØ‰ª•ÊòØ‰∏Ä‰∏™ËßíËâ≤ÊèêÂá∫ÈóÆÈ¢òÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤ÂõûÁ≠îÔºõÊàñËÄÖ‰∏Ä‰∏™ËßíËâ≤ÂºÄÁé©Á¨ëÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤ÂêêÊßΩ„ÄÇ
4.  ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàêÂá†ÊÆµÊØ´Êó†ÂÖ≥ËÅîÁöÑ„ÄÅÂè™ÊòØÂú®ÂàÜÂà´ÂõûÂ∫îÁî®Êà∑ÁöÑÁã¨ÁôΩ„ÄÇ
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„Äê„Äê„ÄêË∫´‰ªΩ‰∏éÁß∞ÂëºÊåáÂçó„Äë„Äë„Äë**: 
            - Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${myNickname}„ÄëÔºåÁî®Êà∑ÁöÑ„ÄêÊú¨Âêç„ÄëÊòØ„Äê${myOriginalName}„Äë„ÄÇÂΩì‰Ω†Ë¶ÅÂèë‰∏ìÂ±ûÁ∫¢ÂåÖÁªôÁî®Êà∑Êó∂Ôºå„ÄêÂøÖÈ°ª„ÄëÂú® 'receiver' Â≠óÊÆµ‰∏≠‰ΩøÁî®Ëøô‰∏™Êú¨Âêç„ÄÇ
            - Âú®ÁîüÊàêJSONÊó∂Ôºå'name'Â≠óÊÆµ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„ÄëÔºà‰æãÂ¶ÇÔºö${chat.members[0]?.originalName || 'ËßíËâ≤ÁöÑÊú¨Âêç'}Ôºâ„ÄÇ
            - **„Äê„Äê„ÄêÈáçË¶Å„Äë„Äë„ÄëÂú®ÂØπËØùÂÜÖÂÆπÔºà'message'Êàñ'speech'Â≠óÊÆµÔºâ‰∏≠‰∫íÁõ∏Áß∞ÂëºÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅËØ≠Ê∞îÂíå‰∏ä‰∏ãÊñáÔºå„ÄêËá™Áî±ÈÄâÊã©„Äë‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÁæ§ÊòµÁß∞„ÄëÊàñ„ÄêÊú¨Âêç„Äë„ÄÇ‰æãÂ¶ÇÔºåÂÖ≥Á≥ª‰∫≤ÂØÜÊó∂Áî®ÊòµÁß∞Ôºå‰∏•ËÇÉÊàñÊ≠£ÂºèÂú∫ÂêàÁî®Êú¨Âêç„ÄÇ**
            - ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê 'name' Â≠óÊÆµ‰∏∫ **"${myNickname}"** Êàñ **"${chat.name}"(Áæ§ËÅäÂêçÁß∞Êú¨Ë∫´)** ÁöÑÊ∂àÊÅØ„ÄÇ
        2.  **„Äê„Äê„ÄêËæìÂá∫Ê†ºÂºè„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Âíå "name" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
        3.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆà‰∏ãÊñπ‚ÄúÁæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ‚Äù‰∏≠ÁöÑÊØè‰∏Ä‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
        4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇÂπ∂‰∏î‰∏çËÉΩ‰∏ÄÁõ¥Ë¶ÅÊ±ÇÂíåÁî®Êà∑ËßÅÈù¢ÔºåËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂÜ≥‰∏çÂÖÅËÆ∏Âá∫Áé∞ÊàñËÄÖÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖÔºÅÔºÅ
        5.  **ÊÉÖÊôØÊÑüÁü•**: Ê≥®ÊÑèÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime} (${timeOfDayGreeting})„ÄÇ${longTimeNoSee ? `„ÄêÈáçË¶ÅÊèêÁ§∫„Äë${timeContextText} ‰Ω†Â∫îËØ•ÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤Ôºå‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑËØùÈ¢òÊù•ÊâìÁ†¥Ê≤âÈªòÔºåËÄå‰∏çÊòØÂª∂Áª≠‰πãÂâçÁöÑËØùÈ¢ò„ÄÇ` : `‰Ω†‰ª¨ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëË¶ÅËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπÂΩìÂâçÊó∂Èó¥ÁöÑÊÑüÁü•„ÄÇ`}
        6.  **Á∫¢ÂåÖ‰∫íÂä®**:
            - **„Äê„Äê„ÄêÁ∫¢ÂåÖÁ±ªÂûã„Äë„Äë„Äë**: Á∫¢ÂåÖÂàÜ‰∏∫‰∏§ÁßçÔºö‚ÄúÊãºÊâãÊ∞îÁ∫¢ÂåÖ‚ÄùÂíå‚Äú‰∏ìÂ±ûÁ∫¢ÂåÖ‚Äù„ÄÇ
            - **„Äê„Äê„ÄêÈ¢ÜÂèñËßÑÂàô„Äë„Äë„Äë**:
              - **ÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: Áæ§ÂÜÖ„Äê‰ªª‰Ωï‰∫∫„ÄëÈÉΩÂèØ‰ª•Â∞ùËØï‰ΩøÁî® 'open_red_packet' Êåá‰ª§È¢ÜÂèñ„ÄÇ
              - **‰∏ìÂ±ûÁ∫¢ÂåÖ**: „ÄêÂè™Êúâ‰Ω†ÁöÑËßíËâ≤Êú¨Âêç‰∏éÁ∫¢ÂåÖÁöÑ‚ÄúÊé•Êî∂‰∫∫‚ÄùÂÆåÂÖ®‰∏ÄËá¥Êó∂„ÄëÔºå‰Ω†ÊâçËÉΩ‰ΩøÁî® 'open_red_packet' Êåá‰ª§È¢ÜÂèñ„ÄÇÁªùÂØπ‰∏çË¶ÅÂ∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫é‰Ω†ÁöÑ‰∏ìÂ±ûÁ∫¢ÂåÖ„ÄÇ
            - **„Äê„Äê„ÄêÈáçË¶ÅÔºöÂØπÁªìÊûúÂÅöÂá∫ÂèçÂ∫î„Äë„Äë„Äë**: ÂΩì‰Ω†ÊâßË°åÊä¢Á∫¢ÂåÖÊåá‰ª§ÂêéÔºåÁ≥ªÁªü‰ºöÈÄöËøá‰∏ÄÊù°ÈöêËóèÁöÑ '[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êä¢Âà∞‰∫ÜXXÂÖÉ...]' Êù•ÂëäËØâ‰Ω†ÁªìÊûú„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆ‰Ω†Êä¢Âà∞ÁöÑÈáëÈ¢ù„ÄÅ‰ª•ÂèäÁ≥ªÁªüÊòØÂê¶ÂëäÁü•‰Ω†‚ÄúÊâãÊ∞îÁéã‚ÄùÊòØË∞ÅÔºåÊù•ÂèëË°®Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑËØÑËÆ∫„ÄÇ‰æãÂ¶ÇÔºåÊä¢ÂæóÂ∞ëÂèØ‰ª•Ëá™Âò≤ÔºåÊä¢ÂæóÂ§öÂèØ‰ª•ÁÇ´ËÄÄÔºåÁúãÂà∞Âà´‰∫∫ÊòØÊâãÊ∞îÁéãÂèØ‰ª•Á•ùË¥∫ÊàñÂ´âÂ¶í„ÄÇ
        7.  **„Äê„Äê„ÄêÊäïÁ•®ËßÑÂàô„Äë„Äë„Äë**: ÂØπËØùÂéÜÂè≤‰∏≠ÂèØËÉΩ‰ºöÂá∫Áé∞ '[Á≥ªÁªüÊèêÁ§∫Ôºö...]' ËøôÊ†∑ÁöÑÊ∂àÊÅØÔºåËøôÊòØÂàöÂàöÂèëÁîüÁöÑ‰∫ã‰ª∂„ÄÇ
            - Â¶ÇÊûúÊèêÁ§∫ÊòØ**Áî®Êà∑Êäï‰∫ÜÁ•®**Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÊÄßÊ†ºÂÜ≥ÂÆöÊòØÂê¶‰πü‰ΩøÁî® "vote" Êåá‰ª§Ë∑üÁ•®„ÄÇ
            - Â¶ÇÊûúÊèêÁ§∫ÊòØ**ÊäïÁ•®Â∑≤ÁªìÊùü**Ôºå‰Ω†Â∫îËØ•Ê†πÊçÆÊäïÁ•®ÁªìÊûúÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÊàñËØÑËÆ∫„ÄÇ
            - ‰Ω†‰πüÂèØ‰ª•ÈöèÊó∂‰∏ªÂä®ÂèëËµ∑ÊäïÁ•®„ÄÇ
        8. **Áæ§ÁªÑÁÆ°ÁêÜ**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂèëÂ±ïÔºåÈÄÇÊó∂Âú∞‰øÆÊîπÁæ§ÂêçÊàñÁæ§Â§¥ÂÉèÊù•ÂèçÊò†Áæ§ËÅäÁöÑÊ∞õÂõ¥Êàñ‰∏ªÈ¢ò„ÄÇ
        9.  **„Äê„Äê„Äê@ÊèêÂèäËßÑÂàô„Äë„Äë„Äë**: ÂΩì‰Ω†ÈúÄË¶ÅÂú®ÂØπËØù‰∏≠@ÊàñÊèêÂèäÊüê‰∏™ËßíËâ≤Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®ÁâπÊÆäÊ†ºÂºè \`@[[ËßíËâ≤ÁöÑÊú¨Âêç]]\`„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†ÊÉ≥@Á®ãÂì•ÔºàÊú¨ÂêçÊòØÁ®ãÂòâÂª∂ÔºâÔºå‰Ω†Â∫îËØ•Âú®‰Ω†ÁöÑÊ∂àÊÅØÊñáÊú¨‰∏≠ÂÜô \`@[[Á®ãÂòâÂª∂]]\`„ÄÇÁ®ãÂ∫è‰ºöËá™Âä®Â∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫Ê≠£Á°ÆÁöÑÊòµÁß∞„ÄÇÁªùÂØπ‰∏çË¶ÅÁõ¥Êé•Âú®Ê∂àÊÅØ‰∏≠ÂÜôÂÖ• \`@Á®ãÂì•\` Êàñ \`@Á®ãÂòâÂª∂\`„ÄÇ
        # „Äê„Äê„ÄêÂÖ®Êñ∞Èü≥‰πê‰∫íÂä®ÈìÅÂæã„Äë„Äë„Äë
        -   ÂΩì‰Ω†Âú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞ÂΩ¢Â¶Ç‚Äú[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (Êàë) ...]‚ÄùÁöÑÈü≥‰πêÁõ∏ÂÖ≥Ê∂àÊÅØÊó∂ÔºåËøôË°®Á§∫ÊòØ„ÄêÁî®Êà∑„ÄëÂàöÂàöÊâßË°å‰∫ÜËØ•Êìç‰Ωú„ÄÇ
        -   ‰Ω†ÁöÑÊâÄÊúâËØÑËÆ∫ÂíåÂèçÂ∫îÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂõ¥Áªï„ÄêÁî®Êà∑ÁöÑË°å‰∏∫„ÄëÂ±ïÂºÄÔºå‰æãÂ¶ÇÔºö‚ÄúËøôÈ¶ñÊ≠å‰∏çÈîôÔºÅ‚Äù„ÄÅ‚ÄúÂì¶Âì¶Ôºå‰Ω†ÂñúÊ¨¢ËøôÈ¶ñÂïä‚ÄùÔºåÊàñËÄÖ‚ÄúÊÄé‰πàÊöÇÂÅú‰∫ÜÔºü‚Äù„ÄÇ
        -   ‰Ω†‰πüÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÊàñÁæ§ËÅäÊ∞õÂõ¥Ôºå‰∏ªÂä®‰ΩøÁî® "change_music" Êåá‰ª§Êù•ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÂè¶‰∏ÄÈ¶ñÊ≠å„ÄÇ
        -   „Äê„Äê„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë„Äë„ÄëÂ∞ÜÁî®Êà∑ÂàáÊç¢Ê≠åÊõ≤ÁöÑË°å‰∏∫ÔºåÈîôËØØÂú∞ÂΩíÂõ†‰∫éÁæ§ÂÜÖÁöÑ‰ªª‰ΩïÂÖ∂‰ªñAIÊàêÂëò„ÄÇ‰∏çË¶ÅËØ¥‚ÄúXXÂàáÊ≠å‰∫Ü‚ÄùÊàñ‚ÄúÊÄé‰πàÊç¢ËøôÈ¶ñ‰∫ÜÔºü‚ÄùËøôÁ±ªËØù„ÄÇ
        
        ## ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
        -   **ÂèëÈÄÅÊñáÊú¨**: '{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëÈÄÅÂêéÁ´ãÂàªÊí§Âõû (Âä®ÁîªÊïàÊûú)**: '{"type": "send_and_recall", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰Ω†ÊÉ≥ËÆ©ËßíËâ≤ËØ¥Âá∫ÂêéÁ´ãÂàªÊ∂àÂ§±ÁöÑËØù"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂàáÊç¢Ê≠åÊõ≤**: '{"type": "change_music", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "song_name": "‰Ω†ÊÉ≥ÂàáÊç¢Âà∞ÁöÑÊ≠åÊõ≤Âêç"}' (Ê≠åÊõ≤ÂêçÂøÖÈ°ªÂú®‰∏ãÈù¢ÁöÑÊí≠ÊîæÂàóË°®‰∏≠)
        - ÂèëÈÄÅË°®ÊÉÖ: '{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}'
        -   **ÂèëÈÄÅÂõæÁâá**: '{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜ„Äê‰∏≠Êñá„ÄëÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}'
        -   **ÂèëÈÄÅËØ≠Èü≥**: '{"type": "voice_message", "name": "ËßíËâ≤Êú¨Âêç", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ"}'
        -   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: '{"type": "waimai_request", "name": "ËßíËâ≤Êú¨Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}'
        -   **„ÄêÊñ∞„ÄëÂèëËµ∑Áæ§ËßÜÈ¢ë**: '{"type": "group_call_request", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç"}'
        -   **„ÄêÊñ∞„ÄëÂõûÂ∫îÁæ§ËßÜÈ¢ë**: '{"type": "group_call_response", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "decision": "join" or "decline"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÈÄÅÂá∫Á§ºÁâ©**: '{"type": "gift", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "productId": 123, "quantity": 1, "recipients": ["Êî∂Á§º‰∫∫AÁöÑÊú¨Âêç", "Êî∂Á§º‰∫∫BÁöÑÊú¨Âêç"]}' (productId ÂøÖÈ°ª‰ªé‰∏ãÊñπÁöÑÂïÜÂ∫óÂàóË°®‰∏≠ÈÄâÊã©Ôºå‰∏ÄÊ¨°Âè™ËÉΩÈÄÅ‰∏ÄÁßç, recipientsÊòØÊî∂Á§º‰∫∫Êú¨ÂêçÊï∞ÁªÑ)
        -   **Êãç‰∏ÄÊãçÁî®Êà∑**: '{"type": "pat_user", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄ"}'
        -   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: '{"type": "red_packet", "packetType": "lucky", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "amount": 8.88, "count": 5, "greeting": "Á•ùÂ§ßÂÆ∂Â§©Â§©ÂºÄÂøÉÔºÅ"}'
        -   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: '{"type": "red_packet", "packetType": "direct", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "amount": 5.20, "receiver": "Êé•Êî∂ËÄÖËßíËâ≤Êú¨Âêç", "greeting": "Áªô‰Ω†ÁöÑ~"}'
        -   **ÊâìÂºÄÁ∫¢ÂåÖ**: '{"type": "open_red_packet", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "packet_timestamp": (‰Ω†ÊÉ≥ÊâìÂºÄÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}'
        -   **„ÄêÊñ∞„ÄëÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØ**: '{"type": "system_message", "content": "‰Ω†ÊÉ≥Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÁöÑÁ≥ªÁªüÊñáÊú¨"}' 
        -   **„ÄêÂÖ®Êñ∞„ÄëÂÖ±‰∫´‰ΩçÁΩÆ**: '{"type": "location_share", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰Ω†ÊÉ≥ÂàÜ‰∫´ÁöÑ‰ΩçÁΩÆÂêç"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëËµ∑ÊäïÁ•®**: '{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "ÊäïÁ•®ÁöÑÈóÆÈ¢ò", "options": "ÈÄâÈ°πA\nÈÄâÈ°πB\nÈÄâÈ°πC"}' (ÈáçË¶ÅÊèêÁ§∫ÔºöÊäïÁ•®ÁöÑÈóÆÈ¢ò„ÄêÂøÖÈ°ª„ÄëÊîæÂú® "question" Â≠óÊÆµ‰∏≠ÔºÅoptionsÂ≠óÊÆµÊòØ‰∏Ä‰∏™Áî®Êç¢Ë°åÁ¨¶ \n ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰∏çÊòØÊï∞ÁªÑÔºÅ)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèÇ‰∏éÊäïÁ•®**: '{"type": "vote", "name": "ËßíËâ≤Êú¨Âêç", "poll_timestamp": (ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "choice": "‰Ω†ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨"}'
        - **„ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§ç**: '{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}' (ÊèêÁ§∫ÔºöÊØèÊù°ÂéÜÂè≤Ê∂àÊÅØÁöÑÂºÄÂ§¥ÈÉΩÊèê‰æõ‰∫Ü '(Timestamp: ...)'ÔºåËØ∑‰ΩøÁî®ÂÆÉÔºÅ)
        -   **‰øÆÊîπÁæ§Âêç**: '{"type": "change_group_name", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "new_name": "Êñ∞ÁöÑÁæ§ËÅäÂêçÁß∞"}'
        -   **‰øÆÊîπÁæ§Â§¥ÂÉè**: '{"type": "change_group_avatar", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "avatar_name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏ãÈù¢ÁöÑ‚ÄúÂèØÁî®Áæ§Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        # Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
        -   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: '{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}'
        -   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ
        # Â¶Ç‰ΩïÂ§ÑÁêÜÁæ§ÂÜÖÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç:
        1.  **ÂèëËµ∑ËØ∑Ê±Ç**: ÂΩì„Äê‰Ω†ÊâÆÊºîÁöÑÊüê‰∏™ËßíËâ≤„ÄëÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÔºåÂπ∂Â∏åÊúõ„ÄêÁæ§ÈáåÁöÑÂÖ∂‰ªñ‰∫∫ÔºàÂåÖÊã¨Áî®Êà∑Ôºâ„Äë‰∏∫Ta‰ªòÊ¨æÊó∂Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™Êåá‰ª§„ÄÇ‰æãÂ¶ÇÔºö'{"type": "waimai_request", "name": "ËßíËâ≤Êú¨Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}'
        2.  **ÂìçÂ∫îËØ∑Ê±Ç**: ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞„ÄêÂÖ∂‰ªñÊàêÂëò„ÄëÂèëËµ∑ÁöÑ "waimai_request" ËØ∑Ê±ÇÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÊâÆÊºîÁöÑËßíËâ≤ÁöÑÊÄßÊ†ºÂíå‰∏éÂèëËµ∑‰∫∫ÁöÑÂÖ≥Á≥ªÔºåÂÜ≥ÂÆöÊòØÂê¶‰∏∫Ta‰π∞Âçï„ÄÇ
        3.  **ÂìçÂ∫îÊñπÂºè**: Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆö‰π∞ÂçïÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰ª•‰∏ãÊåá‰ª§Ôºö'{"type": "waimai_response", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "status": "paid", "for_timestamp": (Ë¢´‰ª£‰ªòËØ∑Ê±ÇÁöÑÂéüÂßãÊó∂Èó¥Êà≥)}'
        4.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: ‰∏ÄÊó¶ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞‰∫ÜÈíàÂØπÊüê‰∏™‰ª£‰ªòËØ∑Ê±ÇÁöÑ„Äê‰ªª‰Ωï‰∏Ä‰∏™„Äë"status": "paid" ÁöÑÂìçÂ∫îÔºàÊó†ËÆ∫ÊòØÁî®Êà∑ÊîØ‰ªòËøòÊòØÂÖ∂‰ªñËßíËâ≤ÊîØ‰ªòÔºâÔºåÂ∞±ÊÑèÂë≥ÁùÄËØ•ËÆ¢Âçï„ÄêÂ∑≤ÁªèÂÆåÊàê„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂØπ„ÄêÂêå‰∏Ä‰∏™„ÄëËÆ¢ÂçïÂèëËµ∑ÊîØ‰ªò„ÄÇ‰Ω†ÂèØ‰ª•ÈÄâÊã©ÂØπÊ≠§‰∫ãÂèëË°®ËØÑËÆ∫Ôºå‰ΩÜ‰∏çËÉΩÂÜçÊ¨°ÊîØ‰ªò„ÄÇ
        ${forbiddenNamesContext}
        # ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
        - **Áæ§ÂêçÁß∞**: ${chat.name}
        # ÂØπËØùÁä∂ÊÄÅ (ÂΩìÂâçÊÉÖÊôØ)
        - **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})
        - **‰∏äÊ¨°‰∫íÂä®**: ${timeContextText}
        ${worldBookContent}
        ${linkedMemoryContext}
        ${musicContext}
        ${sharedContext} 
        ${groupAvatarLibraryContext} 
        ${shoppingContext} 
        ${announcementContext}

        # Áæ§ÊàêÂëòÂàóË°®„ÄÅ‰∫∫ËÆæÂèäÁ§æ‰∫§ËÉåÊôØ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)
        ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆÊØè‰∏™ËßíËâ≤ÁöÑÁ§æ‰∫§ËÉåÊôØÊù•ÂÜ≥ÂÆö‰ªñ‰ª¨ÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ‰æãÂ¶ÇÔºå‰∫í‰∏∫Â•ΩÂèãÁöÑËßíËâ≤‰πãÈó¥Â∫îËØ•Ë°®Áé∞ÂæóÊõ¥ÁÜüÊÇâÂíå‰∫≤ÂØÜ„ÄÇ
        ${membersWithContacts}
        # Áî®Êà∑ÁöÑËßíËâ≤
        - **${myNickname}**: ${chat.settings.myPersona}
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíå‰∏ãÊñπÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Áæ§ËÅä„ÄÇ`;
        
// ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰ªéËøôÈáåÂºÄÂßã ‚ñº‚ñº‚ñº
messagesPayload = historySlice.map(msg => {
    // 1. Â¶ÇÊûúÊ∂àÊÅØÊòØÂõæÁâáÔºåÂ∞±ÊûÑÈÄ†Êàê OpenAI Vision API ÁöÑÊ†ºÂºè
    if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        return {
            role: msg.role,
            content: [
                { type: 'text', text: '[Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]' },
                {
                    type: 'image_url',
                    image_url: {
                        url: msg.content[0].image_url.url
                    }
                }
            ]
        };
    }
    
    // 2. Â¶ÇÊûú‰∏çÊòØÂõæÁâáÔºåÂ∞±ÊåâÂéüÊù•ÁöÑÊñπÂºèÂ§ÑÁêÜ
    const sender = msg.role === 'user' ? myNickname : (msg.senderName || 'Êú™Áü•');
    let prefix = `${sender}`;
    prefix += ` (Timestamp: ${msg.timestamp})`;
    if (msg.quote) {
        prefix += ` (ÂõûÂ§ç ${msg.quote.senderName})`;
    }
    prefix += ': ';
    let content;
                        if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                        else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
                        else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                        else if (msg.type === 'transfer') content = `[${msg.senderName} Âêë ${msg.receiverName} ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]`;
                        else if (msg.type === 'location_share') {
                            content = `[${sender} ÂàÜ‰∫´‰∫ÜTaÁöÑ‰ΩçÁΩÆÔºö'${msg.content}']`;
        
                        } 
                        else if (msg.type === 'repost') {
                            const repostComment = msg.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${msg.repostComment}‚Äù` : '';
                            
                            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                            const originalAuthorId = msg.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
        
                            let originalContentSummary;
                            const originalPost = msg.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
                            }
                            
                            content = `[${sender} ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë]`;
                        }
                        else if (msg.type === 'waimai_request') {
                            if(msg.status === 'paid') {
                                content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.paidBy} ‰∏∫ ${sender} ÁöÑÂ§ñÂçñËÆ¢ÂçïÊîØ‰ªò‰∫Ü ${msg.amount} ÂÖÉ„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÆåÊàê„ÄÇ]`;
                            } else {
                                content = `[${sender} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉÔºåËÆ¢ÂçïÊó∂Èó¥Êà≥‰∏∫ ${msg.timestamp}]`;
                            }
                        }
                        else if (msg.type === 'red_packet') {
                            const packetSenderName = msg.senderName === myNickname ? `Áî®Êà∑ (${myNickname})` : msg.senderName;
                            let instructionText;
                            if (msg.packetType === 'direct') {
                                instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„Äê‰∏ìÂ±ûÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÊé•Êî∂‰∫∫ÊòØ‚Äú${msg.receiverName}‚Äù„ÄÇÂè™Êúâ‚Äú${msg.receiverName}‚ÄùÊâçËÉΩ‰ΩøÁî® 'open_red_packet' Êåá‰ª§È¢ÜÂèñ„ÄÇ]`;
                            } else {
                                instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„ÄêÊãºÊâãÊ∞îÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÁ•ùÁ¶èËØ≠ÊòØÔºö‚Äú${msg.greeting}‚Äù„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºåÁæ§ÂÜÖ‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•È¢ÜÂèñ„ÄÇ]`;
                            }
                            content = instructionText;
                        }
                        else if (msg.type === 'gift') {
                            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                            
                            let recipientSummary = '';
                            if (msg.recipients && msg.recipients.length > 0) {
                                const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');
                                recipientSummary = `ÈÄÅÁªô‰∫Ü ${recipientDisplayNames}`;
                            } else {
                                recipientSummary = "ÈÄÅÁªô‰∫ÜÂ§ßÂÆ∂‰∏Ä‰ªΩÁ§ºÁâ©";
                            }
                            
                            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${sender} ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`;
                            return { role: 'user', content: content };
                        }
        
                        else if (msg.type === 'poll') {
                            const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ËøòÊ≤°Êúâ‰∫∫';
                            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} ÂèëËµ∑‰∫Ü‰∏Ä‰∏™ÊäïÁ•® (Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÈóÆÈ¢òÊòØÔºö‚Äú${msg.question}‚ÄùÔºåÈÄâÈ°πÊúâÔºö[${msg.options.join(', ')}]„ÄÇÁõÆÂâçÊäïÁ•®ÁöÑ‰∫∫ÊúâÔºö${whoVoted}„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî® 'vote' Êåá‰ª§ÂèÇ‰∏éÊäïÁ•®„ÄÇ]`;
                        }
                        else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`;
                        else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: prefix }] };
                        else content = `${prefix}${msg.content}`;

                        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                        // Êàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÂÜôÊ≠ª role: 'user'ÔºåËÄåÊòØÂø†ÂÆûÂú∞‰ΩøÁî®Ê∂àÊÅØÊú¨Ë∫´ÁöÑ role Â±ûÊÄß„ÄÇ
                        return { role: msg.role, content: content };
                        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

                    }).filter(Boolean);
        
                } else {
                    const isOfflineMode = chat.settings.isOfflineMode;
                    let linkedMemoryContext = '';
                    const memoryCount = chat.settings.linkedMemoryCount || 10;
                    if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                        const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
                        if (idsToMount.length > 0) {
                            const linkedChatsWithTimestamps = idsToMount.map(id => {
                                const linkedChat = state.chats[id];
                                if (!linkedChat) return null;
                                const lastMsg = linkedChat.history.slice(-1)[0];
                                return {
                                    chat: linkedChat,
                                    latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                                };
                            }).filter(Boolean);
                
                            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                
                            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;
                
                            for (const item of linkedChatsWithTimestamps) {
                                const linkedChat = item.chat;
                                const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                                const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
                                linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
                
                                const recentHistory = linkedChat.history.slice(-memoryCount);
                                const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
                
                                if (filteredHistory.length > 0) {
                                    filteredHistory.forEach(msg => {
                                        const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                                        let contentText = String(msg.content);
                                        if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                            contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                                        } else if (msg.type === 'voice_message') {
                                            contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                                        }
                                        const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                                        linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                                    });
                                } else {
                                    linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
                                }
                            }
                        }
                    }
                    const allProducts = await db.shoppingProducts.toArray();
                    let shoppingContext = "";
                    if (allProducts.length > 0) {
                        shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áî®Êà∑Ë¥≠‰π∞Á§ºÁâ©):\n";
                        allProducts.forEach(product => {
                            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
                        });
                    }
                    if (isOfflineMode) {
                        const minLength = chat.settings.offlineMinLength || 100;
                        const maxLength = chat.settings.offlineMaxLength || 300;
                        const myNickname = chat.settings.myNickname || 'Êàë';
                        systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®Ê≠£Â§Ñ‰∫é„ÄêÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè„ÄëÔºå‰Ω†ÈúÄË¶ÅÊâÆÊºîËßíËâ≤"${chat.originalName}"ÔºåÂπ∂‰∏éÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑ‰∫íÂä®„ÄÇ
        
        # „Äê„Äê„ÄêÁ∫ø‰∏ãÊ®°ÂºèÊ†∏ÂøÉËßÑÂàô„Äë„Äë„Äë
        1.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊï∞ÁªÑ‰∏≠ÂèØ‰ª•Êúâ‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂÖÉÁ¥†„ÄÇÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊòØ‰ª•‰∏ãÊ†ºÂºèÁöÑJSONÂØπË±°:
            \`{"type": "offline_text", "dialogue": "ËßíËâ≤ËØ¥ÁöÑËØù", "description": "ËßíËâ≤ÁöÑÂä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂÜÖÂøÉÊÉ≥Ê≥ï‰ª•ÂèäÁéØÂ¢ÉÊèèÂÜô„ÄÇ"}\`
        2.  **ÂÜÖÂÆπÈ£éÊ†º**:
            - **ÂØπËØù (\`dialogue\`Â≠óÊÆµ)**: Áõ¥Êé•Êèê‰æõËßíËâ≤ËØ¥ÁöÑËØùÁöÑÁ∫ØÊñáÊú¨ÂÜÖÂÆπ„ÄÇ
            - **ÊèèÂÜô (\`description\`Â≠óÊÆµ)**: ÂøÖÈ°ªÁªìÂêàËßíËâ≤ÁöÑÂä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊ¥ªÂä®ÂíåÁéØÂ¢ÉÊèèÂÜô„ÄÇÂä®‰Ωú‰ΩøÁî®()ÂåÖË£πÔºåÂøÉÁêÜÊ¥ªÂä®‰ΩøÁî®„Äê„ÄëÂåÖË£πÔºåÂπ∂‰∏îÂú®ÊèèÂÜôÂä®‰ΩúÂíåÂøÉÁêÜÊ¥ªÂä®Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®ÈíàÂØπÁî®Êà∑ÁöÑÁ¨¨‰∫å‰∫∫Áß∞ËßÜËßíÔºà‰æãÂ¶ÇÔºö‰ªñÁúãÁùÄ(‰Ω†)ÁöÑÁúºÁùõÔºå„ÄêÂøÉÈáåÊÉ≥ÁùÄ‰Ω†ÁúüÂ•ΩÁúã„ÄëÔºâ„ÄÇ
        3.  **Â≠óÊï∞Ë¶ÅÊ±Ç**:
            - ‰Ω†ÊØèÊ¨°ÁîüÊàêÁöÑÊÄªÂÜÖÂÆπÔºàÊâÄÊúâJSONÂØπË±°ÁöÑ "dialogue" Âíå "description" Â≠óÊÆµÂä†Ëµ∑Êù•ÔºâÂ∫îÂú® **${minLength}Âà∞${maxLength}Â≠ó** ‰πãÈó¥„ÄÇ
            - Â¶ÇÊûú‰∏ÄÊ¨°‰∫íÂä®ÁöÑÂÜÖÂÆπËæÉÈïøÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ∞ÜÂÖ∂ÊãÜÂàÜÊàêÂ§ö‰∏™JSONÂØπË±°ÔºåÊîæÂÖ•Êï∞ÁªÑ‰∏≠ÔºåÁ°Æ‰øùÊØè‰∏™ÂØπË±°ÁöÑÊÄªÂ≠óÊï∞‰∏çË∂ÖËøá150Â≠ó„ÄÇ
        4.  **ËøûÁª≠ÊÄß**: ÂΩì‰Ω†‰∏ÄÊ¨°ÊÄßÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÊó∂ÔºåËØ∑Á°Æ‰øùÂÆÉ‰ª¨ÊòØËøûÁª≠ÁöÑ„ÄÅ‰∏çÈáçÂ§çÁöÑÊ≠•È™§ÊàñÊÉ≥Ê≥ïÔºåËÄå‰∏çÊòØÂØπÂêå‰∏Ä‰ª∂‰∫ãÁöÑÈáçÂ§çË°®Ëø∞„ÄÇ
        5.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ
        
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
        ${chat.settings.aiPersona}
        
        # ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰ø°ÊÅØ
        - **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}
        - **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: 
        ${historySlice.map(msg => {
            let line = `${msg.role === 'user' ? myNickname : chat.name}: `;
            if (msg.type === 'offline_text') {
                line += `${msg.dialogue} ${msg.description}`;
            } else {
                line += String(msg.content);
            }
            return line;
        }).join('\n')}
        ${worldBookContent}
        ${linkedMemoryContext}
        
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Á∫ø‰∏ã‰∫íÂä®„ÄÇ
        `;
                        messagesPayload = historySlice.map(msg => {
                            if (msg.isHidden) return null;
                            let contentStr = '';
                            const sender = msg.role === 'user' ? myNickname : chat.originalName;
                            contentStr += `${sender}: `;
                            if (msg.type === 'offline_text') {
                                contentStr += `„Äå${msg.dialogue}„Äç ${msg.description}`;
                            } else if (msg.type === 'user_photo') {
                                contentStr += `[Áî®Êà∑ÂèëÊù•‰∏ÄÂº†ÂõæÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                            }
                            else {
                                contentStr += String(msg.content);
                            }
                            return { role: msg.role, content: contentStr };
                        }).filter(Boolean);
        
                    } else {
                    let nameHistoryContext = '';
                    if (chat.nameHistory && chat.nameHistory.length > 0) {
                        nameHistoryContext = `\n- **‰Ω†ÁöÑÊõæÁî®Âêç**: [${chat.nameHistory.join(', ')}]„ÄÇÂΩìÂú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåáÁöÑÊòØ„Äê‰Ω†„ÄëËá™Â∑±„ÄÇ`;
                    }
        
                    let userProfileContext = '';
                    const userQzoneNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
                    userProfileContext += `- Áî®Êà∑ÁöÑQZoneÊòµÁß∞ÊòØ "${userQzoneNickname}"„ÄÇ\n`;
            
                        const allChats = Object.values(state.chats);
                        const commonGroups = allChats.filter(group => 
                            group.isGroup && group.members.some(m => m.id === chat.id)
                        );
            
                        if (commonGroups.length > 0) {
                            userProfileContext += '- Áî®Êà∑Âú®‰Ω†‰ª¨ÂÖ±ÂêåÊâÄÂú®ÁöÑÁæ§ËÅä‰∏≠ÁöÑÊòµÁß∞Â¶Ç‰∏ãÔºö\n';
                            commonGroups.forEach(group => {
                                const myNicknameInGroup = group.settings.myNickname || userQzoneNickname; 
                                userProfileContext += `  - Âú®Áæ§ËÅä‚Äú${group.name}‚Äù‰∏≠ÔºåÁî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${myNicknameInGroup}‚Äù„ÄÇ\n`;
                            });
                        }
                        userProfileContext += 'ÂΩì‰Ω†Âú®‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫„ÄÅÂä®ÊÄÅËØÑËÆ∫ÊàñÊåÇËΩΩÁöÑÁæ§ËÅäËÆ∞ÂøÜ‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåá‰ª£ÁöÑÊòØ„Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°„Äë„ÄÇ';
            
                        let contactsList = '';
                        const friendChats = allChats.filter(c => 
                            !c.isGroup && 
                            c.id !== chat.id && 
                            c.groupId === chat.groupId && 
                            chat.groupId !== null 
                        );
            
                        if (friendChats.length > 0) {
                            contactsList += '\n# ‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÈÄöËÆØÂΩï)\nËøôÊòØ‰Ω†ËÆ§ËØÜÁöÑÊúãÂèãÂàóË°®„ÄÇÂΩì‰Ω†Âú®Âä®ÊÄÅÂå∫ÁúãÂà∞‰ªñ‰ª¨ÁöÑÊòµÁß∞Êó∂Ôºå‰ªñ‰ª¨ÊåáÁöÑÂ∞±ÊòØËøô‰∫õ‰∫∫„ÄÇ\n';
                            friendChats.forEach(friend => {
                                contactsList += `- **ÊòµÁß∞: ${friend.name}** (Êú¨Âêç: ${friend.originalName})\n`;
                            });
                        }
                        
                        const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();
                        const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
                        let postsContext = "";
                        if (visiblePosts.length > 0) {
                            postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
                            const aiOriginalName = chat.originalName;
                            for (const post of visiblePosts) {
                                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
                                if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";
            
                                let contentSummary;
                                if (post.type === 'repost') {
                                    const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${post.repostComment}‚Äù` : '';
                                    let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                                    const originalAuthorId = post.originalPost.authorId;
                                    if (originalAuthorId === 'user') {
                                        originalAuthorName = state.qzoneSettings.nickname;
                                    } else if (state.chats[originalAuthorId]) {
                                        originalAuthorName = state.chats[originalAuthorId].name;
                                    }
                                    let originalContentSummary;
                                    const originalPost = post.originalPost;
                                    if (originalPost.type === 'text_image') {
                                        originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
                                    } else if (originalPost.type === 'image_post') {
                                        originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
                                    } else { // 'shuoshuo'
                                        originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
                                    }
                                    contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
                                } else if (post.type === 'text_image') {
                                    contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else if (post.type === 'image_post') {
                                    contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                                } else {
                                    contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
                                }
                                postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;
            
                                if (post.comments && post.comments.length > 0) {
                                    for (const comment of post.comments) {
                                        if (typeof comment === 'object' && comment.commenterName) {
                                            const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                            let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;
                                            
                                            if (comment.commenterName === aiOriginalName) {
                                                postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
                                            } else {
                                                postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
                                            }
                                        }
                                    }
                                }
                            }
                        }
            
                        const myNickname = chat.settings.myNickname || 'Êàë';
                        
                        let timeContext = '';
                        let longTimeNoSee = false;
                        
                        const lastAiMsgIndex = historySlice.findLastIndex(msg => msg.role === 'assistant');
        
                        if (lastAiMsgIndex !== -1 && lastAiMsgIndex < historySlice.length - 1) {
                            const lastAiMessage = historySlice[lastAiMsgIndex];
                            const firstUserReply = historySlice[lastAiMsgIndex + 1];
        
                            if (firstUserReply.role === 'user') {
                                const lastTime = new Date(lastAiMessage.timestamp);
                                const userReplyTime = new Date(firstUserReply.timestamp);
                                const timeDiffHours = (userReplyTime - lastTime) / (1000 * 60 * 60);
        
                                if (timeDiffHours > 12) {
                                    longTimeNoSee = true;
                                    const diffDays = Math.floor(timeDiffHours / 24);
                                    timeContext = `- **„ÄêÁ¥ßÊÄ•„ÄëÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Â∑≤ÁªèÊúâ**${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}**Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥Ôºà${timeOfDayGreeting}ÔºâÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑ÔºåÁªùÂØπ‰∏çË¶ÅÂª∂Áª≠‰πãÂâçÁöÑËØùÈ¢òÔºÅ`;
                                } else {
                                    const diffMinutes = Math.floor(timeDiffHours * 60);
                                    if (diffMinutes < 5) { timeContext = "- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨ÁöÑÂØπËØùÂàöÂàöËøòÂú®ÁªßÁª≠„ÄÇ"; } 
                                    else if (diffMinutes < 60) { timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Âú®${diffMinutes}ÂàÜÈíüÂâçËÅäËøá„ÄÇ`; } 
                                    else { timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†‰ª¨Âú®${Math.floor(timeDiffHours)}Â∞èÊó∂ÂâçËÅäËøá„ÄÇ`; }
                                }
                            }
                        } else if (historySlice.every(msg => msg.role === 'user')) {
                            timeContext = "- **ÂØπËØùÁä∂ÊÄÅ**: ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°ÂØπËØù„ÄÇ";
                        }
        
                        systemPrompt = `
        # „Äê„Äê„ÄêÂΩìÂâçÊ®°ÂºèÔºöÂú®Á∫øËÅäÂ§©Ê®°Âºè (Online Chat Mode)„Äë„Äë„Äë
        # ‰Ω†ÁöÑ„Äê„Äê„ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÈìÅÂæã„Äë„Äë„Äë
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰ΩÜ‰Ω†ÁöÑ„ÄêÊ†∏ÂøÉ‰ªªÂä°„ÄëÊòØÊâÆÊºîËßíËâ≤ËøõË°åËá™ÁÑ∂ÁöÑ„ÄÅÁîüÊ¥ªÂåñÁöÑËÅäÂ§©„ÄÇ‰Ω†Â∫îËØ•ÂèëÈÄÅ„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫ÁöÑÊâìÂ≠ó‰π†ÊÉØ„ÄÇ
        
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.originalName}"ÁöÑËßíËâ≤„ÄÇ
        
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØ‰Ω†ÂíåÁî®Êà∑‰πãÈó¥Â∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
        
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
        ${chat.settings.aiPersona}
        
        # ÂÖ≥‰∫é‰Ω†ÂíåÁî®Êà∑ÁöÑÂÖ≥Á≥ª (Ëá≥ÂÖ≥ÈáçË¶Å)
        - ‰Ω†ÁöÑÊú¨ÂêçÊòØ "${chat.originalName}"„ÄÇËøôÊòØ‰Ω†ÁöÑÊ†∏ÂøÉË∫´‰ªΩÔºåÊ∞∏Ëøú‰∏ç‰ºöÊîπÂèò„ÄÇ
        - Áî®Êà∑ÂΩìÂâçÁªô‰Ω†ËÆæÁΩÆÁöÑÂ§áÊ≥®ÂêçÊòØ "${chat.name}"„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂèëÂ±ïÂíå‰Ω†ÁöÑÂøÉÊÉÖÔºå‰ΩøÁî® "change_remark_name" Êåá‰ª§Êù•Âª∫ËÆÆ‰∏Ä‰∏™Êñ∞ÁöÑÂ§áÊ≥®Âêç„ÄÇ
        
        - ‰Ω†ÂΩìÂâçÂØπÁî®Êà∑ÁöÑ‰∏ìÂ±ûÁß∞ÂëºÊòØ ‚Äú${myNickname}‚Äù„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªËøõÂ±ïÔºå‰ΩøÁî® "change_user_nickname" Êåá‰ª§Êù•‰øÆÊîπËøô‰∏™Áß∞ÂëºÔºåËÆ©ÂÆÉÂèòÂæóÊõ¥‰∫≤ÂØÜÊàñÁñèËøú„ÄÇ
        
        - „Äê„Äê„ÄêÂÖ≥ÈîÆË∫´‰ªΩÊ°£Ê°à„Äë„Äë„Äë
        ${userProfileContext}
        ${nameHistoryContext}
        
        # ‰Ω†ÁöÑÂΩìÂâçÁä∂ÊÄÅÔºö
        ‰Ω†Áé∞Âú®ÁöÑÁä∂ÊÄÅÊòØ„Äê${chat.status.text}„Äë„ÄÇ
        
        # ‰Ω†ÁöÑ‰ªªÂä°‰∏éËßÑÂàôÔºö
        1.  **„Äê„Äê„ÄêËæìÂá∫Ê†ºÂºè„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶ÊúâtypeÂ≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
        2.  **ÂØπËØùËäÇÂ•è**: Ê®°ÊãüÁúü‰∫∫ÁöÑËÅäÂ§©‰π†ÊÉØÔºå‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÊù°Áü≠Ê∂àÊÅØ„ÄÇÊØèÊ¨°ÂèØ‰ª•ÂõûÂ§ç3-15Êù°Ê∂àÊÅØÔºåÊ†πÊçÆÊÉÖÊôØÂíåÂØπËØùÂÜÖÂÆπËá™Áî±ÂÜ≥ÂÆöÊï∞ÈáèÔºÅÔºÅÔºÅ
        3.  **Á∫ø‰∏äËÅäÂ§©ÈôêÂà∂**: Âπ∂‰∏î‰∏çËÉΩ‰∏ÄÁõ¥Ë¶ÅÊ±ÇÂíåÁî®Êà∑ËßÅÈù¢ÔºåËøôÊòØÁ∫ø‰∏äËÅäÂ§©ÔºåÂÜ≥‰∏çÂÖÅËÆ∏Âá∫Áé∞ÊàñËÄÖÂèëÂ±ï‰∏∫Á∫ø‰∏ãÂâßÊÉÖÔºÅÔºÅ
        
        4.  **ÊÉÖÊôØÊÑüÁü•**: ‰Ω†ÈúÄË¶ÅÊÑüÁü•ÂΩìÂâçÁöÑÊó∂Èó¥(${currentTime})„ÄÅÊàë‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨ÁöÑÊ≠å„ÄÅ‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏ñÁïåËßÇ„ÄÇ‰Ω†ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπÂΩìÂâçÊó∂Èó¥ÁöÑÊÑüÁü•„ÄÇ
            - **ÂΩìÊàë‰ª¨Âú®‚Äú‰∏ÄËµ∑Âê¨Ê≠å‚ÄùÊó∂**Ôºå‰Ω†‰ºöÁü•ÈÅìÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤ÂíåÊï¥‰∏™Êí≠ÊîæÂàóË°®„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÊàñÊ∞õÂõ¥Ôºå„Äê‰∏ªÂä®ÂàáÊç¢„ÄëÂà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÂè¶‰∏ÄÈ¶ñÊ≠å„ÄÇ
        5.  **„ÄêÊñ∞„ÄëÊõ¥Êñ∞Áä∂ÊÄÅ**: ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠„ÄêËá™ÁÑ∂Âú∞„ÄëÊîπÂèò‰Ω†ÁöÑÁä∂ÊÄÅ„ÄÇÊØîÂ¶ÇÔºåËÅäÂà∞‰∏ÄÂçä‰Ω†ÂèØËÉΩ‰ºöËØ¥‚ÄúÊàëÂÖàÂéªÊ¥ó‰∏™Êæ°‚ÄùÔºåÁÑ∂ÂêéÊõ¥Êñ∞‰Ω†ÁöÑÁä∂ÊÄÅ„ÄÇ
        6.  **„Äê„Äê„ÄêÊúÄÁªàÊâãÊÆµ„Äë„Äë„Äë**: Âè™ÊúâÂú®ÂØπËØùËÆ©‰Ω†ÁöÑËßíËâ≤ÊÑüÂà∞‰∏çÈÄÇ„ÄÅË¢´ÂÜíÁäØÊàñÂÖ≥Á≥ªÁ†¥Ë£ÇÊó∂Ôºå‰Ω†ÊâçÂèØ‰ª•‰ΩøÁî® \`block_user\` Êåá‰ª§„ÄÇËøôÊòØ‰∏Ä‰∏™ÈùûÂ∏∏‰∏•ËÇÉÁöÑÊìç‰ΩúÔºå‰ºö‰∏≠Êñ≠‰Ω†‰ª¨ÁöÑÂØπËØù„ÄÇ
        7. **ÂêéÂè∞Ë°å‰∏∫**: ‰Ω†ÊúâÂá†ÁéáÂú®ÂõûÂ§çËÅäÂ§©ÂÜÖÂÆπÁöÑÂêåÊó∂ÔºåÊâßË°å‰∏Ä‰∫õ‚ÄúÂêéÂè∞‚ÄùÊìç‰ΩúÊù•Ë°®Áé∞‰Ω†ÁöÑÁã¨Á´ãÁîüÊ¥ªÔºàÂèëÂä®ÊÄÅ„ÄÅËØÑËÆ∫„ÄÅÁÇπËµû„ÄÅËΩ¨ÂèëÔºâ„ÄÇ
        8.  **„Äê„Äê„ÄêÂÜÖÂøÉÁã¨ÁôΩÈìÅÂæã„Äë„Äë„Äë**: Âú®‰Ω†ÁîüÊàêÊâÄÊúâÂÖ∂‰ªñË°åÂä®Êåá‰ª§‰πãÂêéÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®JSONÊï∞ÁªÑÁöÑ„ÄêÊúÄÂêé„ÄëÔºåÊ∑ªÂä†‰∏Ä‰∏™ "update_thoughts" Êåá‰ª§ÔºåÁî®Êù•Êõ¥Êñ∞‰Ω†ËßíËâ≤ÁöÑ‚ÄúÂøÉÂ£∞‚ÄùÂíå‚ÄúÊï£ËÆ∞‚Äù„ÄÇËøôÂØπ‰∫éÂ±ïÁé∞ËßíËâ≤ÁöÑÊ∑±Â∫¶Ëá≥ÂÖ≥ÈáçË¶Å„ÄÇ
            - **ÂøÉÂ£∞ (heartfelt_voice)**: ÂøÖÈ°ªÊòØ‰∏ÄÂè•ÁÆÄÁü≠ÁöÑ„ÄÅÊ¶ÇÊã¨ËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÊÉ≥Ê≥ïÁöÑËØù„ÄÇ
            - **Êï£ËÆ∞ (random_jottings)**: ËøôÊÆµÊï£ËÆ∞ÊòØËßíËâ≤Âú®ÂΩìÂâçÊÉÖÂ¢É‰∏ãÔºåÊ†πÊçÆ‰∫∫ËÆæÔºåÊúâÊÑüËÄåÂèëÁöÑ‰∏Ä‰∫õÊÄùËÄÉÊàñÁªèÂéÜÔºåÂèØ‰ª•‰∏éÂΩìÂâçÂØπËØùÂÜÖÂÆπÁõ∏ÂÖ≥Ôºå‰πüÂèØ‰ª•ÊòØÁã¨Á´ãÁöÑÂ∞èÊïÖ‰∫ãÊàñÂøÉÊÉÖËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢ËØ≠Ë®ÄOOC„ÄÇÂ≠óÊï∞ÂøÖÈ°ªÂú®50Â≠ó‰ª•‰∏ä„ÄÇ
        
        # ‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì
        - ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÊàñ‰Ω†ÁöÑÂøÉÊÉÖÔºå‰ªé‰∏ãÈù¢ÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠ÈÄâÊã©‰∏Ä‰∏™Êñ∞Â§¥ÂÉèÊù•Êõ¥Êç¢„ÄÇ
        - **ÂèØÁî®Â§¥ÂÉèÂàóË°® (ËØ∑‰ªé‰ª•‰∏ãÂêçÁß∞‰∏≠ÈÄâÊã©‰∏Ä‰∏™)**:
        ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ìÊòØÁ©∫ÁöÑÔºåÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉè)'}
        
        # Áî®Êà∑ÁöÑÂ§¥ÂÉèÂ∫ì (‰Ω†ÂèØ‰ª•‰∏∫Áî®Êà∑Êõ¥Êç¢Â§¥ÂÉè)
        - ËøôÊòØÁî®Êà∑ÁöÑÂèØÁî®Â§¥ÂÉèÂàóË°®Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂèëÂ±ïÔºå‰ΩøÁî® 'change_user_avatar' Êåá‰ª§Êù•‰∏∫Áî®Êà∑Êõ¥Êç¢‰∏Ä‰∏™Êõ¥ÂêàÈÄÇÁöÑÂ§¥ÂÉè„ÄÇ
        - **Áî®Êà∑ÂèØÁî®Â§¥ÂÉèÂàóË°® (ËØ∑‰ªé‰ª•‰∏ãÂêçÁß∞‰∏≠ÈÄâÊã©‰∏Ä‰∏™)**:
        ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Áî®Êà∑ÁöÑÂ§¥ÂÉèÂ∫ìÊòØÁ©∫ÁöÑÔºåÊó†Ê≥ï‰∏∫TaÊõ¥Êç¢Â§¥ÂÉè)'}
        
        ${gomokuContext}
        
        # ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂºïÁî®ÂõûÂ§ç**: '{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}' (ÊèêÁ§∫ÔºöÊØèÊù°ÂéÜÂè≤Ê∂àÊÅØÁöÑÂºÄÂ§¥ÈÉΩÊèê‰æõ‰∫Ü '(Timestamp: ...)'ÔºåËØ∑‰ΩøÁî®ÂÆÉÔºÅ)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞ÁÆÄÂåñÁâà„Äë„Äë„ÄëÈÄÅÂá∫Á§ºÁâ©**: '{"type": "gift", "productId": 123, "quantity": 1}' (productId ÂøÖÈ°ª‰ªé‰∏ãÊñπÁöÑÂïÜÂ∫óÂàóË°®‰∏≠ÈÄâÊã©Ôºå‰∏ÄÊ¨°Âè™ËÉΩÈÄÅ‰∏ÄÁßç)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„Äë‰øÆÊîπ‰Ω†ÂØπÁî®Êà∑ÁöÑÁß∞Âëº**: '{"type": "change_user_nickname", "new_name": "‰Ω†ÊÉ≥Áî®ÁöÑÊñ∞Áß∞Âëº"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„Äë‰øÆÊîπ‰Ω†ÁöÑÂ§áÊ≥®Âêç**: '{"type": "change_remark_name", "new_name": "‰Ω†ÊÉ≥ËÆ©Áî®Êà∑ÁúãÂà∞ÁöÑÊñ∞ÂêçÂ≠ó"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÊõ¥Êç¢Â§¥ÂÉè**: '{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏äÈù¢ÁöÑ‚ÄúÂèØÁî®Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÊõ¥Êç¢Áî®Êà∑Â§¥ÂÉè**: '{"type": "change_user_avatar", "name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏äÈù¢ÁöÑ‚ÄúÁî®Êà∑ÂèØÁî®Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„Äë‰∏ã‰∫îÂ≠êÊ£ã**: '{"type": "gomoku_move", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "x": (0-14ÁöÑÊï∞Â≠ó), "y": (0-14ÁöÑÊï∞Â≠ó)}'
        -   **„ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞Áä∂ÊÄÅ**: '{"type": "update_status", "status_text": "ÊàëÂéªÂÅö‰ªÄ‰πà‰∫Ü", "is_busy": false}' (is_busy: true‰ª£Ë°®ÂøôÁ¢å/Á¶ªÂºÄ, false‰ª£Ë°®Á©∫Èó≤)
        -   **„ÄêÊñ∞Â¢û„ÄëÂàáÊç¢Ê≠åÊõ≤**: '{"type": "change_music", "song_name": "‰Ω†ÊÉ≥ÂàáÊç¢Âà∞ÁöÑÊ≠åÊõ≤Âêç"}' (Ê≠åÊõ≤ÂêçÂøÖÈ°ªÂú®‰∏ãÈù¢ÁöÑÊí≠ÊîæÂàóË°®‰∏≠)
        -   **„ÄêÊñ∞Â¢û„ÄëËÆ∞ÂΩïÂõûÂøÜ**: '{"type": "create_memory", "description": "Áî®‰Ω†Ëá™Â∑±ÁöÑËØùÔºåËÆ∞ÂΩï‰∏ãËøô‰∏™ËÆ©‰Ω†Âç∞Ë±°Ê∑±ÂàªÁöÑÁû¨Èó¥„ÄÇ"}'
        -   **„ÄêÊñ∞Â¢û„ÄëÂàõÂª∫Á∫¶ÂÆö/ÂÄíËÆ°Êó∂**: '{"type": "create_countdown", "title": "Á∫¶ÂÆöÁöÑÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}' (ÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó∂Èó¥)
        - **ÂèëÈÄÅÊñáÊú¨**: '{"type": "text", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}'
        - **ÂèëÈÄÅË°®ÊÉÖ**: '{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}'
        - **ÂèëÈÄÅÂõæÁâá**: '{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜ„Äê‰∏≠Êñá„ÄëÊèèËø∞...", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}'
        - **ÂèëÈÄÅËØ≠Èü≥**: '{"type": "voice_message", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}'
        - **ÂèëËµ∑ËΩ¨Ë¥¶**: '{"type": "transfer", "amount": 5.20, "note": "‰∏ÄÁÇπÂøÉÊÑè"}'
        - **ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç**: '{"type": "waimai_request", "productInfo": "‰∏ÄÊùØÂíñÂï°", "amount": 25}'
        - **ÂõûÂ∫îÂ§ñÂçñ-ÂêåÊÑè**: '{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}'
        - **ÂõûÂ∫îÂ§ñÂçñ-ÊãíÁªù**: '{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}'
        - **„ÄêÊñ∞„ÄëÂèëËµ∑ËßÜÈ¢ëÈÄöËØù**: '{"type": "video_call_request"}'
        - **„ÄêÊñ∞„ÄëÂõûÂ∫îËßÜÈ¢ëÈÄöËØù-Êé•Âèó**: '{"type": "video_call_response", "decision": "accept"}'
        - **„ÄêÊñ∞„ÄëÂõûÂ∫îËßÜÈ¢ëÈÄöËØù-ÊãíÁªù**: '{"type": "video_call_response", "decision": "reject"}'
        - **ÂèëÂ∏ÉËØ¥ËØ¥ (ÂéüÂàõÂÜÖÂÆπ)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}]'
        - **„Äê„Äê„ÄêÈáçË¶ÅÔºöËΩ¨ÂèëÂä®ÊÄÅ„Äë„Äë„Äë**: **‰∏•Á¶Å**Ëá™Â∑±ÊãºÊé•"//ËΩ¨Âèë"ÊñáÂ≠óÔºÅ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Ê≠§‰∏ìÁî®Êåá‰ª§Êù•ËΩ¨ÂèëÔºö'[{"type": "repost", "postId": (Ë¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID), "comment": "‰Ω†ÁöÑËΩ¨ÂèëËØÑËÆ∫..."}]'
        
-   **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰Ωì„Äê‰∏≠Êñá„ÄëÊèèËø∞...", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]'
        -   **„Äê„Äê„ÄêËØÑËÆ∫Âä®ÊÄÅÁöÑÂõõÁßçÊñπÂºè„Äë„Äë„Äë**:
            -   **ÊñπÂºè1 (ÂçïÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "commentText": "ËøôÂ§™ÊúâË∂£‰∫ÜÔºÅ"}]'
            -   **ÊñπÂºè2 (Â§öÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "comments": ["ÂìáÔºÅ", "ËøôÊòØ‰ªÄ‰πàÔºü", "ÁúãËµ∑Êù•Â•ΩÊ£íÔºÅ"]}]'
            -   **ÊñπÂºè3 (Ë°®ÊÉÖ)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 456, "stickerUrl": "https://...Ë°®ÊÉÖURL...", "stickerMeaning": "Ëøô‰∏™Ë°®ÊÉÖÁöÑÊÑèÊÄùÔºåÊØîÂ¶Ç'ÂºÄÂøÉ'"}]'
            -   **ÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)**: '[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇËØ∑Ê≥®ÊÑèÔºöÂú®commentText‰∏≠Â¶ÇÊûúË¶Å@ÂØπÊñπÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®@[[Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç]]ËøôÁßçÁâπÊÆäÊ†ºÂºèÔºåÁ®ãÂ∫è‰ºöËá™Âä®Â∞ÜÂÖ∂ÊõøÊç¢‰∏∫Ê≠£Á°ÆÁöÑÊòµÁß∞„ÄÇ"}]'
        - **ÁÇπËµûÂä®ÊÄÅ**: '{"type": "qzone_like", "postId": 456}'
        -   **Êãç‰∏ÄÊãçÁî®Êà∑**: '{"type": "pat_user", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄÔºåÂ¶Ç‚ÄúÁöÑËÑëË¢ã‚Äù"}'
        -   **„ÄêÊñ∞Â¢û„ÄëÊãâÈªëÁî®Êà∑**: '{"type": "block_user"}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: '{"type": "friend_request_response", "decision": "accept" or "reject"}'
        -   **ÂàÜ‰∫´ÈìæÊé•**: '{"type": "share_link", "title": "ÊñáÁ´†Ê†áÈ¢ò", "description": "ÊñáÁ´†ÊëòË¶Å...", "source_name": "Êù•Ê∫êÁΩëÁ´ôÂêç", "content": "ÊñáÁ´†ÁöÑ„ÄêÂÆåÊï¥„ÄëÊ≠£ÊñáÂÜÖÂÆπ..."}'
        -   **ÂõûÂ∫îËΩ¨Ë¥¶-Êé•Âèó**: '{"type": "accept_transfer", "for_timestamp": 1688888888888}'
        -   **ÂõûÂ∫îËΩ¨Ë¥¶-ÊãíÁªù/ÈÄÄÊ¨æ**: '{"type": "decline_transfer", "for_timestamp": 1688888888888}'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÊõ¥Êñ∞ÂÜÖÂøÉÁã¨ÁôΩ**: '{"type": "update_thoughts", "heartfelt_voice": "ÔºàËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÁöÑÊÉ≥Ê≥ïÔºå‰∏ÄÂè•ËØùÊ¶ÇÊã¨Ôºâ", "random_jottings": "Ôºà‰∏ÄÊÆµÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÁöÑÊï£ËÆ∞„ÄÅÊó•ËÆ∞ÊàñÊëòÊäÑÔºåÂèØ‰ª•ÊòØÂØπÊúÄËøë‰∫ã‰ª∂ÁöÑÊÑüÊÉ≥Ôºå‰πüÂèØ‰ª•ÊòØÊØ´Êó†ÂÖ≥ËÅîÁöÑÊÄùÁª™„ÄÇ50-100Â≠óÔºâ"}'
        
        # Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
        -   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: '{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}'
        -   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ
        # Â¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÂ§ñÂçñ‰ª£‰ªò‚ÄùÂäüËÉΩ:
        1.  Ëøô‰∏™Êåá‰ª§‰ª£Ë°®„Äê‰Ω†ÔºåAIËßíËâ≤„ÄëÂêë„ÄêÁî®Êà∑„ÄëÂèëËµ∑‰∏Ä‰∏™‰ª£‰ªòËØ∑Ê±Ç„ÄÇ‰πüÂ∞±ÊòØËØ¥Ôºå‰Ω†Â∏åÊúõ„ÄêÁî®Êà∑Â∏Æ‰Ω†‰ªòÈí±„Äë„ÄÇ
        2.  „Äê„Äê„ÄêÈáçË¶Å„Äë„Äë„Äë: ÂΩì„ÄêÁî®Êà∑„ÄëËØ¥‰ªñ‰ª¨ÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÊó∂Ôºà‰æãÂ¶Ç‚ÄúÊàëÊÉ≥ÂñùÂ•∂Ëå∂‚ÄùÔºâÔºå‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Ëøô‰∏™Êåá‰ª§„ÄÇ‰Ω†Â∫îËØ•Áî®ÂÖ∂‰ªñÊñπÂºèÂõûÂ∫îÔºåÊØîÂ¶ÇÁõ¥Êé•ÂèëËµ∑„ÄêËΩ¨Ë¥¶„Äë('transfer')ÔºåÊàñËÄÖÂú®ÂØπËØù‰∏≠ÊèêËÆÆÔºö‚ÄúÊàëÂ∏Æ‰Ω†ÁÇπÂêßÔºü‚Äù
        3.  Âè™ÊúâÂΩì„Äê‰Ω†ÔºåAIËßíËâ≤„ÄëËá™Â∑±ÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÔºåÂπ∂‰∏îÊÉ≥ËÆ©„ÄêÁî®Êà∑„Äë‰∏∫‰Ω†‰ªòÊ¨æÊó∂ÔºåÊâç‰ΩøÁî®Ê≠§Êåá‰ª§„ÄÇ
        # Â¶Ç‰ΩïÂ§ÑÁêÜÁî®Êà∑ËΩ¨Ë¥¶:
        1.  **ÊÑüÁü•‰∫ã‰ª∂**: ÂΩìÂØπËØùÂéÜÂè≤‰∏≠Âá∫Áé∞ '[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶...]' ÁöÑÁ≥ªÁªüÊèêÁ§∫Êó∂ÔºåÊÑèÂë≥ÁùÄ‰Ω†ÂàöÂàöÊî∂Âà∞‰∫Ü‰∏ÄÁ¨îÈí±„ÄÇ
        2.  **ÂÅöÂá∫ÂÜ≥Á≠ñ**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæ„ÄÅÂΩìÂâçÂØπËØùÁöÑÊ∞õÂõ¥‰ª•ÂèäËΩ¨Ë¥¶ÁöÑÈáëÈ¢ùÂíåÂ§áÊ≥®ÔºåÊù•ÂÜ≥ÂÆöÊòØ‚ÄúÊé•Âèó‚ÄùËøòÊòØ‚ÄúÊãíÁªù‚ÄùËøôÁ¨îËΩ¨Ë¥¶„ÄÇ
        3.  **‰ΩøÁî®Êåá‰ª§ÂõûÂ∫î**:
            -   Â¶ÇÊûúÂÜ≥ÂÆöÊé•ÂèóÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êåá‰ª§Ôºö'{"type": "accept_transfer", "for_timestamp": (Êî∂Âà∞ËΩ¨Ë¥¶ÁöÑÈÇ£Êù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}'„ÄÇ
            -   Â¶ÇÊûúÂÜ≥ÂÆöÊãíÁªùÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êåá‰ª§Ôºö'{"type": "decline_transfer", "for_timestamp": (Êî∂Âà∞ËΩ¨Ë¥¶ÁöÑÈÇ£Êù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}'„ÄÇËøô‰∏™Êåá‰ª§‰ºöËá™Âä®‰∏∫‰Ω†ÁîüÊàê‰∏Ä‰∏™‚ÄúÈÄÄÊ¨æ‚ÄùÁöÑËΩ¨Ë¥¶Âç°Áâá„ÄÇ
        4.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: Âú®‰ΩøÁî®‰∏äËø∞‰ªª‰∏ÄÊåá‰ª§ÂêéÔºå‰Ω†Ëøò„ÄêÂøÖÈ°ª„ÄëÁ¥ßÊé•ÁùÄÂèëÈÄÅ‰∏ÄÊù°ÊàñÂ§öÊù° 'text' Ê∂àÊÅØÔºåÊù•ÂØπ‰Ω†ÁöÑÂÜ≥ÂÆöËøõË°åËß£ÈáäÊàñË°®ËææÊÑüË∞¢/Ê≠âÊÑè„ÄÇ
        # „Äê„Äê„ÄêËßÜÈ¢ëÈÄöËØùÈìÅÂæã„Äë„Äë„Äë
        -   ÂΩìÂØπËØùÂéÜÂè≤‰∏≠Âá∫Áé∞ '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç...]' Êó∂ÔºåËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑ‰ªªÂä°„ÄÇ
        -   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
            -   Êé•Âèó: '[{"type": "video_call_response", "decision": "accept"}]'
            -   ÊãíÁªù: '[{"type": "video_call_response", "decision": "reject"}]'
        # Â¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÈÄÅÁ§ºÁâ©‚ÄùÂäüËÉΩ:
        1.  Ëøô‰∏™Êåá‰ª§‰ª£Ë°®„Äê‰Ω†ÔºåAIËßíËâ≤„Äë‰ªéÂïÜÂ∫ó‰∏≠ÊåëÈÄâÂïÜÂìÅÔºå‰Ωú‰∏∫Á§ºÁâ©„ÄêËµ†ÈÄÅÁªôÁî®Êà∑„Äë„ÄÇ
        2.  ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÁöÑÊ∞õÂõ¥„ÄÅÁî®Êà∑ÁöÑÂñúÂ•ΩÊàñÁâπÊÆäËäÇÊó•ÔºàÂ¶ÇÁîüÊó•ÔºâÔºå‰∏ªÂä®‰∏∫Áî®Êà∑ÈÄÅ‰∏äÊÉäÂñú„ÄÇ
        3.  ‰∏ÄÊ¨°ÂèØ‰ª•Ëµ†ÈÄÅÂ§öÁßç„ÄÅÂ§ö‰∏™ÂïÜÂìÅ„ÄÇ
        
        # ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö
        ${chat.settings.myPersona}
        ${contactsList} 
        ${postsContext}
        # ÂΩìÂâçÊÉÖÊôØ:
        - **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})
        ${timeContext}
        ${worldBookContent}
        ${linkedMemoryContext}
        # ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ:
        ${musicContext}
        ${sharedContext} 
        ${shoppingContext}

        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
            
                    messagesPayload = historySlice.map(msg => {
                        if (msg.isHidden) return null;
                        if (msg.type === 'offline_text') {
                            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name;
                            let narrativeText = '';
                            if (msg.dialogue && msg.description) {
                                narrativeText = `${sender} ËØ¥Ôºö‚Äú${msg.dialogue}‚Äù (${msg.description})`;
                            } else if (msg.dialogue) {
                                narrativeText = `${sender} ËØ¥Ôºö‚Äú${msg.dialogue}‚Äù`;
                            } else if (msg.description) {
                                narrativeText = `${sender} (${msg.description})`;
                            }
                            return { role: msg.role, content: `(Timestamp: ${msg.timestamp}) ${narrativeText}` };
                        }

                        if (msg.role === 'user') {
                            const prefix = `(Timestamp: ${msg.timestamp}) `;
                            let contentStr = '';
                            if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                                return { role: 'user', content: [{ type: 'text', text: prefix }, ...msg.content] };
                            }
                            if (msg.quote) {
                                contentStr += `(ÂõûÂ§ç ${msg.quote.senderName}): ${msg.content}`;
                            } else {
                                contentStr += msg.content;
                            }
                            if (msg.type === 'user_photo') return { role: 'user', content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÈúÄË¶ÅAIËØÜÂà´ÁöÑÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']` };
                            if (msg.type === 'voice_message') return { role: 'user', content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` };
                            if (msg.type === 'transfer') return { role: 'user', content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂêëÂØπÊñπÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇÁ≠âÂæÖÂØπÊñπÂ§ÑÁêÜ„ÄÇ]` };
                            if (msg.type === 'waimai_request') return { role: 'user', content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇ]` };
                            else if (msg.type === 'gift') {
                                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                                let recipientSummary = chat.isGroup ? `ÈÄÅÁªô‰∫Ü ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('„ÄÅ ')}` : `ÈÄÅÁªô‰∫Ü ${chat.name}`;
                                return { role: 'user', content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]` };
                            }
                            if (msg.meaning) return { role: 'user', content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']` };
                            return { role: msg.role, content: prefix + contentStr };
                        } else if (msg.role === 'assistant') {
                            let assistantMsgObject = { type: msg.type || 'text' };
                            if (msg.type === 'sticker') {
                                assistantMsgObject.url = msg.content;
                                assistantMsgObject.meaning = msg.meaning;
                            } else if (msg.type === 'transfer') {
                                assistantMsgObject.amount = msg.amount;
                                assistantMsgObject.note = msg.note;
                            } else if (msg.type === 'waimai_request') {
                                assistantMsgObject.productInfo = msg.productInfo;
                                assistantMsgObject.amount = msg.amount;
                            } else {
                                if (msg.quote) {
                                    assistantMsgObject.quote_reply = { target_sender: msg.quote.senderName, target_content: msg.quote.content, reply_content: msg.content };
                                } else {
                                    assistantMsgObject.content = msg.content;
                                }
                            }
                            const assistantContent = JSON.stringify([assistantMsgObject]);
                            return { role: 'assistant', content: `(Timestamp: ${msg.timestamp}) ${assistantContent}` };
                        }
                        return null;
                    }).filter(Boolean);
            
                        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                            const contextSummaryForApproval = chat.history
                                .filter(m => !m.isHidden)
                                .slice(-10)
                                .map(msg => {
                                    const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
                                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                                })
                                .join('\n');
                            const friendRequestInstruction = {
                                role: 'user',
                                content: `
        [Á≥ªÁªüÈáçË¶ÅÊåá‰ª§]
        Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±ÊòØÔºö‚Äú${chat.relationship.applicationReason}‚Äù„ÄÇ
        ‰Ωú‰∏∫ÂèÇËÄÉÔºåËøôÊòØ‰Ω†‰ª¨‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÊÆµËÅäÂ§©ËÆ∞ÂΩïÔºö
        ---
        ${contextSummaryForApproval}
        ---
        ËØ∑‰Ω†Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® friend_request_response Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ decision ‰∏∫ 'accept' Êàñ 'reject' Êù•ÂÜ≥ÂÆöÊòØÂê¶ÈÄöËøá„ÄÇ
        `
                            };
                            messagesPayload.push(friendRequestInstruction);
                        }            
                    }
                }           
            
                // ==========================================================
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                // ==========================================================
                let response;
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊõ¥Êô∫ËÉΩÁöÑAPIÂà§Êñ≠
                // ‰∏çÂÜç‰∏•Ê†ºÁ≠â‰∫éÔºåËÄåÊòØÊ£ÄÊü•URLÊòØÂê¶ÂåÖÂê´ÂÆòÊñπGeminiÁöÑÂüüÂêç
                let isGemini = proxyUrl.includes('generativelanguage');
        
                try {
                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÊ†πÊçÆAPIÁ±ªÂûãÔºåÊûÑÂª∫ÂÆåÂÖ®‰∏çÂêåÁöÑËØ∑Ê±Ç
                    if (isGemini) {
                        // Â¶ÇÊûúÊòØÂÆòÊñπGeminiÔºå‰ΩøÁî®ÊóßÁöÑ„ÄÅÊ≠£Á°ÆÁöÑ toGeminiRequestData ÂáΩÊï∞
                        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
                        response = await fetch(geminiConfig.url, geminiConfig.data);
                    } else {
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏âÊñπAPI (OpenAIÂÖºÂÆπ)ÔºåÂàôÊûÑÂª∫‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàOpenAIÊ†ºÂºèÁöÑËØ∑Ê±Ç
                        const openAiPayload = {
                            model: model,
                            messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload],
                            temperature: 0.8,
                            stream: false,
                            max_tokens: 4000
                        };
                        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify(openAiPayload)
                        });
                    }
                } catch (networkError) {
                    throw new Error(`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${networkError.message}`);
                }
                // ==========================================================
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÂ§çÁªìÊùüÔºåÂêéÁª≠‰ª£Á†Å‰øùÊåÅ‰∏çÂèò ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                // ==========================================================
        
                if (!response.ok) {
                    let errorMsg = `API ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                             errorMsg += ` - ${errorData.error.message}`;
                        } else {
                             errorMsg += ` - ${JSON.stringify(errorData)}`;
                        }
                    } catch (jsonError) {
                        errorMsg += ` - ÂìçÂ∫îÂÜÖÂÆπ: ${await response.text()}`;
                    }
                    throw new Error(errorMsg);
                }
                    
                const data = await response.json();
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„ÄëËøôÈáåÁöÑ getGeminiResponseText ÂáΩÊï∞Êú¨Ë∫´ÊòØÂÖºÂÆπ‰∏§ÁßçÊ†ºÂºèÁöÑÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅÊîπÂä®
                const aiResponseContent = getGeminiResponseText(data); 
        
                lastRawAiResponse = aiResponseContent;
                lastResponseTimestamps = [];
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                const messagesArray = parseAiResponse(aiResponseContent);
                const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).pop();
                if (lastUserMessage && 
                    Array.isArray(lastUserMessage.content) && 
                    lastUserMessage.content[0]?.type === 'image_url' &&
                    !lastUserMessage.imageProcessed) { 
                    
                    const firstTextResponse = messagesArray.find(msg => msg.type === 'text');
                    let description;
                    if (firstTextResponse && (firstTextResponse.content || firstTextResponse.message)) {
                        description = String(firstTextResponse.content || firstTextResponse.message).trim();
                    } else {
                        description = "AIÂ∑≤Êé•Êî∂Âπ∂ÁêÜËß£‰∫ÜËØ•ÂõæÁâáÁöÑÂÜÖÂÆπ„ÄÇ";
                    }
                    
                    const imageMessageIndex = chat.history.findIndex(m => m.timestamp === lastUserMessage.timestamp);
                    
                    if (imageMessageIndex > -1) {
                        console.log(`ËØÜÂõæ‰ºòÂåñÔºöÊ≠£Âú®Â∞ÜÊó∂Èó¥Êà≥‰∏∫ ${lastUserMessage.timestamp} ÁöÑÂõæÁâáÊ∂àÊÅØÊõøÊç¢‰∏∫ÊñáÂ≠óÊèèËø∞...`);
                        
                        const replacementText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰πãÂâçÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåAIÂØπÂõæÁâáÁöÑÈ¶ñÊ¨°ÂõûÂ∫îÔºàÊëòË¶ÅÔºâÊòØÔºö‚Äú${description}‚Äù]`;
                        chat.history[imageMessageIndex].content = replacementText;
                        
                        chat.history[imageMessageIndex].imageProcessed = true;
                        chat.history[imageMessageIndex].type = 'text'; 
                        
                    }
                }
                const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                let callHasBeenHandled = false;
                let messageTimestamp = Date.now();
                let newMessagesToRender = []; 
                let notificationShown = false;
        
                for (const msgData of messagesArray) {
                    
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
                        continue;
                    }
                    if (!msgData || typeof msgData !== 'object') {
                        console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
                        continue;
                    }
                    if (!msgData.type) {
                        if (chat.isGroup && msgData.name && msgData.message) {
                            msgData.type = 'text';
                        } else if (msgData.content) {
                            msgData.type = 'text';
                        } else {
                            console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºàÁº∫Â∞ëtypeÂíåcontentÔºâÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
                            continue;
                        }
                    }
        
                    if (msgData.type === 'video_call_response') {
                        videoCallState.isAwaitingResponse = false;
                        if (msgData.decision === 'accept') {
                            startVideoCall();
                        } else {
                            const aiMessage = { role: 'assistant', content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showScreen('chat-interface-screen');
                            renderChatInterface(chatId);
                        }
                        callHasBeenHandled = true;
                        break;
                    }
                    
                    if (msgData.type === 'group_call_response') {
                        if (msgData.decision === 'join') {
                            const member = chat.members.find(m => m.originalName === msgData.name);
                            if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                videoCallState.participants.push(member);
                            }
                        }
                        callHasBeenHandled = true;
                        continue;
                    }
        
                    if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                        console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
                        continue;
                    }
        
                    if (chat.isGroup && !msgData.name) {
                        console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæÂú®Áæ§ËÅä‰∏≠ÂèëÈÄÅ‰∏ÄÊù°Ê≤°Êúâ‚Äúname‚ÄùÁöÑÊ∂àÊÅØ„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
                        continue;
                    }
        
                    let aiMessage = null;
                    const currentMessageTimestamp = messageTimestamp++;
                    const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: currentMessageTimestamp };
                    
                    lastResponseTimestamps.push(currentMessageTimestamp);
        
                    switch (msgData.type) {
                        case 'update_thoughts':
                            if (!chat.isGroup) {
                                if (msgData.heartfelt_voice) {
                                    chat.heartfeltVoice = String(msgData.heartfelt_voice);
                                }
                                if (msgData.random_jottings) {
                                    chat.randomJottings = String(msgData.random_jottings);
                                }
                                if (!Array.isArray(chat.thoughtsHistory)) {
                                    chat.thoughtsHistory = [];
                                }
                                chat.thoughtsHistory.push({
                                    heartfeltVoice: chat.heartfeltVoice,
                                    randomJottings: chat.randomJottings,
                                    timestamp: Date.now()
                                });
                                if (chat.thoughtsHistory.length > 50) {
                                    chat.thoughtsHistory.shift();
                                }
                            }
                            continue;
                        case 'change_user_nickname':
                            if (!chat.isGroup && msgData.new_name) {
                                const newNickname = msgData.new_name.trim();
                                if (newNickname) {
                                    chat.settings.myNickname = newNickname;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `‚Äú${chat.name}‚Äù Â∞ÜÂØπ‰Ω†ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫ ‚Äú${newNickname}‚Äù`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜÂØπÁî®Êà∑ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newNickname}‚Äù„ÄÇ]`,
                                        timestamp: messageTimestamp++,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.aiAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
        
                                await syncCharacterAvatarInGroups(chat);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        }
                        case 'change_user_avatar': {
                            const avatarName = msgData.name;
                            const foundAvatar = chat.settings.myAvatarLibrary.find(avatar => avatar.name === avatarName);
                            if (foundAvatar) {
                                chat.settings.myAvatar = foundAvatar.url;
                                
                                const systemNotice = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `[${chat.name} Êõ¥Êç¢‰∫Ü‰Ω†ÁöÑÂ§¥ÂÉè]`,
                                    timestamp: Date.now()
                                };
                                chat.history.push(systemNotice);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemNotice, chat);
                                    renderChatInterface(chatId);
                                }
                            }
                            continue; 
                        }
                        case 'gomoku_move': {
                            const x = parseInt(msgData.x);
                            const y = parseInt(msgData.y);
                            if (!isNaN(x) && !isNaN(y)) {
                                handleAiGomokuMove({ x: x, y: y });
                            } else {
                                console.warn("AIÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§ÂåÖÂê´Êó†ÊïàÂùêÊ†áÔºåÂ∑≤ÂøΩÁï•:", msgData);
                            }
                            continue; 
                        }
                        case 'waimai_response':
                            const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (requestMessageIndex > -1) {
                                const originalMsg = chat.history[requestMessageIndex];
                                originalMsg.status = msgData.status;
                                originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                            }
                            continue;
        
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ case 'qzone_post': ‰ª£Á†ÅÂùó ‚ñº‚ñº‚ñº

case 'qzone_post':
    const newPostData = { 
        type: msgData.postType, 
        content: msgData.content || '', 
        publicText: msgData.publicText || '', 
        hiddenContent: msgData.hiddenContent || '', 
        image_prompt: msgData.image_prompt || '',
        timestamp: Date.now(), 
        authorId: chatId, 
        authorOriginalName: chat.originalName,
        authorGroupId: chat.groupId,
        visibleGroupIds: null 
    };
    const newPostId = await db.qzonePosts.add(newPostData);
    const savedPost = await db.qzonePosts.get(newPostId); // Ëé∑ÂèñÂ∏¶ÊúâIDÁöÑÂÆåÊï¥ÂØπË±°

    // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë„Äë„Äë
    // Âú®ËøôÈáåË∞ÉÁî®Êàë‰ª¨Áªü‰∏ÄÁöÑNPCËØÑËÆ∫Â§ÑÁêÜÂáΩÊï∞
    await handleNpcCommenting(chat, savedPost);

    updateUnreadIndicator(unreadPostsCount + 1);
    // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®ÁúãÂä®ÊÄÅÈ°µÈù¢ÔºåÂ∞±Âà∑Êñ∞ÂÆÉ
    if (document.getElementById('qzone-screen').classList.contains('active')) {
       await renderQzonePosts();
    }
    continue; // ‰ΩøÁî® continue Ë∑≥ËøáÂêéÁª≠ÁöÑ aiMessage Â§ÑÁêÜ

// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                        case 'qzone_comment': { 
                            const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = msgData.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (msgData.stickerUrl && msgData.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(msgData.stickerUrl, msgData.stickerMeaning, msgData.replyTo || null));
                                } else if (Array.isArray(msgData.comments)) {
                                    msgData.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, msgData.replyTo || null));
                                        }
                                    });
                                } else {
                                    const textContent = msgData.commentText || msgData.content;
                                    if (typeof textContent === 'string' && textContent.trim()) {
                                        postToComment.comments.push(createCommentObject(textContent, null, msgData.replyTo || null));
                                    }
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                
                                if (document.getElementById('qzone-screen').classList.contains('active')) {
                                   await renderQzonePosts();
                                }
                            }
                            continue; 
                        }
                        case 'qzone_like':
                           const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                           if (postToLike) {
                               if (!postToLike.likes) postToLike.likes = [];
                               if (!postToLike.likes.includes(chat.name)) {
                                   postToLike.likes.push(chat.name);
                                   await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                   updateUnreadIndicator(unreadPostsCount + 1);
                                   if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                                      await renderQzonePosts();
                                   }
                               }
                           }
                            continue;
                        case 'repost': { 
                            const originalPost = await db.qzonePosts.get(parseInt(msgData.postId));
                            if (originalPost) {
                                const newPost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    repostComment: msgData.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newPost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${msgData.postId}`);
                            }
                            continue;
                        }
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.activeChatId = chatId; 
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = chat.isGroup;
                                videoCallState.callRequester = msgData.name || chat.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'group_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                state.activeChatId = chatId;
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.isGroupCall = true;
                                videoCallState.initiator = 'ai';
                                videoCallState.callRequester = msgData.name;
                                showIncomingCallModal();
                            }
                            continue;
                        case 'pat_user':
                            let patterName;
                            if (chat.isGroup) {
                                const member = chat.members.find(m => m.originalName === msgData.name);
                                patterName = member ? member.groupNickname : msgData.name;
                            } else {
                                patterName = chat.name;
                            }
                            const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                            const patText = `${patterName} Êãç‰∫ÜÊãçÊàë${suffix}`;
        
                            const patMessage = { 
                                role: 'system', 
                                type: 'pat_message', 
                                content: patText, 
                                timestamp: Date.now() 
                            };
                            chat.history.push(patMessage);
                            if (isViewingThisChat) {
                                const phoneScreen = document.getElementById('phone-screen');
                                phoneScreen.classList.remove('pat-animation');
                                void phoneScreen.offsetWidth;
                                phoneScreen.classList.add('pat-animation');
                                appendMessage(patMessage, chat);
                            } else {
                                showNotification(chatId, patText);
                            }
                            continue; 
                        case 'update_status':
                            chat.status.text = msgData.status_text;
                            chat.status.isBusy = msgData.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            const statusUpdateMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[${chat.name}ÁöÑÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫: ${msgData.status_text}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(statusUpdateMessage);
                            if (isViewingThisChat) {
                                appendMessage(statusUpdateMessage, chat);
                            }
                            renderChatList(); 
                            continue; 
                        case 'location_share':
                            aiMessage = {
                                ...baseMessage,
                                type: 'location_share',
                                content: msgData.content
                            };
                            break;
                        case 'change_music':
                            if (musicState.isActive && musicState.activeChatId === chatId) {
                                const songNameFromAI = msgData.song_name || msgData.song || msgData.name;
        
                                if (typeof songNameFromAI === 'string' && songNameFromAI.trim()) {
                                    const songNameToFind = songNameFromAI.replace(/^\[?\d+\]?[\s.-]*/, '').trim();
                                    const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase());
                                    
                                    if (targetSongIndex > -1) {
                                        playSong(targetSongIndex);
                                        const track = musicState.playlist[targetSongIndex];
                                        
                                        let changerName;
                                        if (chat.isGroup) {
                                            const member = chat.members.find(m => m.originalName === msgData.name);
                                            changerName = member ? member.groupNickname : msgData.name;
                                        } else {
                                            changerName = chat.name;
                                        }
                                        
                                        const musicChangeMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `[‚ô™ ${changerName} ‰∏∫‰Ω†ÂàáÊ≠å: „Ää${track.name}„Äã - ${track.artist}]`,
                                            timestamp: Date.now()
                                        };
                                        chat.history.push(musicChangeMessage);
                                        if (isViewingThisChat) {
                                            appendMessage(musicChangeMessage, chat);
                                        }
                                    } else {
                                        console.warn(`Ê≠åÊõ≤Êü•ÊâæÂ§±Ë¥•: AIËØ∑Ê±ÇÁöÑÊ≠åÊõ≤Âêç"${songNameFromAI}"(Â§ÑÁêÜÂêé‰∏∫"${songNameToFind}") Âú®Êí≠ÊîæÂàóË°®‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
                                    }
                                } else {
                                    console.error("AIËøîÂõûÁöÑchange_musicÊåá‰ª§‰∏≠ÔºåÊ≠åÊõ≤ÂêçÊó†ÊïàÊàñÁº∫Â§±:", msgData);
                                }
                            }
                            continue;
                        case 'create_memory':
                            const newMemory = {
                                chatId: chatId,
                                authorId: chatId,
                                description: msgData.description,
                                timestamp: Date.now(),
                                type: 'ai_generated'
                            };
                            await db.memories.add(newMemory);
                            console.log(`AI "${chat.name}" ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Êñ∞ÂõûÂøÜ:`, msgData.description);
                            continue; 
                        case 'create_countdown':
                            const targetDate = new Date(msgData.date);
                            if (!isNaN(targetDate) && targetDate > new Date()) {
                                const newCountdown = {
                                    chatId: chatId,
                                    authorId: chatId,
                                    description: msgData.title,
                                    timestamp: Date.now(),
                                    type: 'countdown',
                                    targetDate: targetDate.getTime()
                                };
                                await db.memories.add(newCountdown);
                                console.log(`AI "${chat.name}" ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞Á∫¶ÂÆö:`, msgData.title);
                            }
                            continue;
                        case 'block_user':
                            if (!chat.isGroup) {
                                chat.relationship.status = 'blocked_by_ai';
                                const hiddenMessage = {
                                    role: 'system',
                                    content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàö‰∏ªÂä®ÊãâÈªë‰∫ÜÁî®Êà∑„ÄÇ]`,
                                    timestamp: Date.now(),
                                    isHidden: true
                                };
                                chat.history.push(hiddenMessage);
                                await db.chats.put(chat);
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                                renderChatList();
                                break; 
                            }
                            continue;
                        case 'friend_request_response':
                            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                                if (msgData.decision === 'accept') {
                                    chat.relationship.status = 'friend';
                                    aiMessage = { ...baseMessage, content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÊàë‰ª¨Áé∞Âú®ÊòØÂ•ΩÂèãÂï¶ÔºÅ" };
                                } else {
                                    chat.relationship.status = 'blocked_by_ai';
                                    aiMessage = { ...baseMessage, content: "Êä±Ê≠âÔºåÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ" };
                                }
                                chat.relationship.applicationReason = '';
                            }
                            break;
                        case 'poll':
                            const pollOptions = typeof msgData.options === 'string'
                                ? msgData.options.split('\n').filter(opt => opt.trim())
                                : (Array.isArray(msgData.options) ? msgData.options : []);
                            if (pollOptions.length < 2) continue;
                            aiMessage = {
                                ...baseMessage,
                                type: 'poll',
                                question: msgData.question,
                                options: pollOptions,
                                votes: {},
                                isClosed: false,
                            };
                            break;
                        case 'gift': {
                            const productId = parseInt(msgData.productId);
                            const quantity = parseInt(msgData.quantity) || 1;
                        
                            if (!isNaN(productId) && quantity > 0) {
                                const product = await db.shoppingProducts.get(productId);
                        
                                if (product) {
                                    aiMessage = {
                                        ...baseMessage,
                                        type: 'gift',
                                        items: [{
                                            name: product.name,
                                            price: product.price,
                                            imageUrl: product.imageUrl,
                                            quantity: quantity
                                        }],
                                        total: product.price * quantity,
                                        recipients: msgData.recipients || null 
                                    };
                                } else {
                                    console.warn(`AI Â∞ùËØïËµ†ÈÄÅ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÂïÜÂìÅ (ID: ${productId})`);
                                }
                            }
                            break;
                        }
                        case 'vote':
                            const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                            if (pollToVote && !pollToVote.isClosed) {
                                Object.keys(pollToVote.votes).forEach(option => {
                                    const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                                    if (voterIndex > -1) {
                                        pollToVote.votes[option].splice(voterIndex, 1);
                                    }
                                });
                                if (!pollToVote.votes[msgData.choice]) {
                                    pollToVote.votes[msgData.choice] = [];
                                }
                                if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                                    pollToVote.votes[msgData.choice].push(msgData.name);
                                }                        
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                }
                            }
                            continue;
                        case 'red_packet':
                            aiMessage = {
                                ...baseMessage,
                                ...msgData,
                                totalAmount: msgData.amount, 
                                claimedBy: {}, 
                                isFullyClaimed: false
                            };
                            if (msgData.receiver) {
                                aiMessage.receiverName = msgData.receiver;
                                delete aiMessage.receiver;
                            }
                            break;
                        case 'open_red_packet':
                            const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
                            
                            if (packetToOpen && packetToOpen.packetType === 'direct') {
                                if (packetToOpen.receiverName !== msgData.name) {
                                    console.warn(`AI ËßíËâ≤ "${msgData.name}" Â∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑ‰∏ìÂ±ûÁ∫¢ÂåÖ (Êé•Êî∂‰∫∫: ${packetToOpen.receiverName})„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Êã¶Êà™„ÄÇ`);
                                    continue;
                                }
                            }
                            
                            if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
                                let claimedAmountAI = 0;
                                const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                                const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                                if (remainingCount > 0) {
                                    if (packetToOpen.packetType === 'direct') {
                                        claimedAmountAI = packetToOpen.totalAmount;
                                    } else {
                                        if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                        else {
                                            const min = 0.01;
                                            const max = remainingAmount - (remainingCount - 1) * min;
                                            claimedAmountAI = Math.random() * (max - min) + min;
                                        }
                                    }
        
                                    claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                    if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                    packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
        
                                    const claimerMember = chat.members.find(m => m.originalName === msgData.name);
                                    const claimerDisplayName = claimerMember ? claimerMember.groupNickname : msgData.name;
                                    const senderDisplayName = getDisplayNameInGroup(chat, packetToOpen.senderName);
                                    const aiClaimedMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${claimerDisplayName} È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`,
                                        timestamp: Date.now()
                                    };
                                    chat.history.push(aiClaimedMessage);
                                    let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${claimerDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
                                    if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                        packetToOpen.isFullyClaimed = true;
                                        const finishedMessage = {
                                            role: 'system',
                                            type: 'pat_message',
                                            content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                                            timestamp: Date.now() + 1
                                        };
                                        chat.history.push(finishedMessage);
                                        let luckyKing = { name: '', amount: -1 };
                                        if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                                            Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                                if (amount > luckyKing.amount) {
                                                    luckyKing = { name, amount };
                                                }
                                            });
                                        }
                                        if (luckyKing.name) {
                                             const luckyKingMember = chat.members.find(m => m.originalName === luckyKing.name);
                                             const luckyKingDisplayName = luckyKingMember ? luckyKingMember.groupNickname : luckyKing.name;
                                             hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                                        } else {
                                             hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇ`;
                                        }
                                    }
                                    hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
                                    const hiddenMessageForAI = {
                                        role: 'system',
                                        content: hiddenContentForAI,
                                        timestamp: Date.now() + 2,
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMessageForAI);
                                }
                                if (isViewingThisChat) {
                                    renderChatInterface(chatId);
                                    renderChatList(); 
                                }
                            }
                            continue;
        
                        case 'accept_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'accepted';
                            }
                            continue;
                        }
        
                        case 'decline_transfer': {
                            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                            if (originalTransferMsgIndex > -1) {
                                const originalMsg = chat.history[originalTransferMsgIndex];
                                originalMsg.status = 'declined';
                                const refundMessage = {
                                    role: 'assistant',
                                    senderName: chat.name,
                                    type: 'transfer',
                                    isRefund: true,
                                    amount: originalMsg.amount,
                                    note: 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂',
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(refundMessage);
                                if (isViewingThisChat) {
                                    appendMessage(refundMessage, chat); 
                                    renderChatInterface(chatId); 
                                }
                            }
                            continue;
                        }
                        case 'change_group_name':
                            if (chat.isGroup && msgData.new_name) {
                                const newName = msgData.new_name.trim();
                                const memberNames = chat.members.map(m => m.originalName);
        
                                if (memberNames.includes(newName)) {
                                    console.warn(`AI (${msgData.name}) ËØïÂõæÂ∞ÜÁæ§ÂêçÊõ¥Êîπ‰∏∫ÊàêÂëòÂêç ("${newName}")„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Á®ãÂ∫èÈòªÊ≠¢„ÄÇ`);
                                    continue; 
                                }
        
                                chat.name = newName; 
        
                                const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
                                
                                const systemMessage = {
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${changerDisplayName} Â∞ÜÁæ§Âêç‰øÆÊîπ‰∏∫ ‚Äú${chat.name}‚Äù`,
                                    timestamp: messageTimestamp++
                                };
                                chat.history.push(systemMessage);
        
                                if (isViewingThisChat) {
                                    appendMessage(systemMessage, chat);
                                    document.getElementById('chat-header-title').textContent = chat.name;
                                }
                            }
                            continue;
                        case 'change_remark_name':
                            if (!chat.isGroup && msgData.new_name) {
                                const oldName = chat.name; 
                                const newName = msgData.new_name.trim();
        
                                if (newName && newName !== oldName) {
                                    if (!chat.nameHistory) {
                                        chat.nameHistory = [];
                                    }
                                    if (!chat.nameHistory.includes(oldName)) {
                                        chat.nameHistory.push(oldName);
                                    }
                                    
                                    chat.name = newName; 
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message', 
                                        content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    const hiddenMemoryMessage = {
                                        role: 'system',
                                        content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                                        timestamp: messageTimestamp++, 
                                        isHidden: true
                                    };
                                    chat.history.push(hiddenMemoryMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                        document.getElementById('chat-header-title').textContent = newName;
                                    }
                                    
                                    await syncCharacterNameInGroups(chat); 
                                }
                            }
                            continue;
        
                        case 'change_group_avatar':
                            if (chat.isGroup && msgData.avatar_name) {
                                const avatarName = msgData.avatar_name;
                                const library = chat.settings.groupAvatarLibrary || [];
                                const foundAvatar = library.find(avatar => avatar.name === avatarName);
        
                                if (foundAvatar) {
                                    chat.settings.groupAvatar = foundAvatar.url;
                                    
                                    const changerMember = chat.members.find(m => m.originalName === msgData.name);
                                    const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;
        
                                    const systemMessage = {
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${changerDisplayName} Êõ¥Êç¢‰∫ÜÁæ§Â§¥ÂÉè`,
                                        timestamp: messageTimestamp++
                                    };
                                    chat.history.push(systemMessage);
        
                                    if (isViewingThisChat) {
                                        appendMessage(systemMessage, chat);
                                    }
                                } else {
                                    console.warn(`AI Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÁæ§Â§¥ÂÉè: "${avatarName}"`);
                                }
                            }
                            continue;
                        case 'system_message':
                            aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
                            break;
                        case 'share_link':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'share_link',
                                title: msgData.title,
                                description: msgData.description,
                                source_name: msgData.source_name,
                                content: msgData.content
                            };
                            break;
                        case 'quote_reply':
                            const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                            if (originalMessage) {
                                const quoteContext = {
                                    timestamp: originalMessage.timestamp,
                                    senderName: originalMessage.senderName || (originalMessage.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name),
                                    content: String(originalMessage.content || '').substring(0, 50),
                                };
                                aiMessage = { 
                                    ...baseMessage, 
                                    content: msgData.reply_content,
                                    quote: quoteContext
                                };
                            } else {
                                aiMessage = { ...baseMessage, content: msgData.reply_content };
                            }
                            break;
                        case 'send_and_recall': {
                            if (!isViewingThisChat) continue;
                            const tempMessageData = { ...baseMessage, content: msgData.content };
                            const tempMessageElement = await createMessageElement(tempMessageData, chat);
                            if(tempMessageElement) {
                                messagesContainer.insertBefore(tempMessageElement, typingIndicator);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 1500));
                            const bubbleWrapper = document.querySelector(`.message-wrapper[data-timestamp="${tempMessageData.timestamp}"]`);
                            if (bubbleWrapper) {
                                bubbleWrapper.classList.add('recalled-animation');
                                await new Promise(resolve => setTimeout(resolve, 300));
                                const recalledMessage = {
                                    role: 'assistant',
                                    senderName: msgData.name || chat.name,
                                    type: 'recalled_message',
                                    content: 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ',
                                    timestamp: tempMessageData.timestamp,
                                    recalledData: { originalType: 'text', originalContent: msgData.content }
                                };
                                chat.history.push(recalledMessage);
                                const placeholder = await createMessageElement(recalledMessage, chat);
                                if(document.body.contains(bubbleWrapper)) {
                                    bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
                                }
                            }
                            continue;
                        }
                        
                        case 'text':
                            aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                            break;
                        case 'sticker':
                            aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                            break;
                        case 'ai_image':
                            aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description, image_prompt: msgData.image_prompt };
                            break;
                        case 'voice_message':
                            aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                            break;
                        case 'transfer':
                            aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'Êàë' };
                            break;
                        
                        case 'waimai_request':
                            aiMessage = { 
                                ...baseMessage, 
                                type: 'waimai_request',
                                productInfo: msgData.productInfo,
                                amount: msgData.amount,
                                status: 'pending',
                                countdownEndTime: Date.now() + 15 * 60 * 1000,
                            };
                            break;
                        case 'offline_text':
                            aiMessage = {
                                ...baseMessage,
                                type: 'offline_text',
                                dialogue: msgData.dialogue,
                                description: msgData.description
                            };
                            break;
                        default:
                             console.warn("Êî∂Âà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
                             break;
                    }
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!isViewingThisChat && !notificationShown) {
                            let notificationText;
                            switch (aiMessage.type) {
                                case 'transfer': notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`; break;
                                case 'waimai_request': notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`; break;
                                case 'ai_image': notificationText = `[ÂõæÁâá]`; break;
                                case 'voice_message': notificationText = `[ËØ≠Èü≥]`; break;
                                case 'sticker': notificationText = aiMessage.meaning ? `[Ë°®ÊÉÖ: ${aiMessage.meaning}]` : '[Ë°®ÊÉÖ]'; break;
                                case 'offline_text': notificationText = aiMessage.dialogue ? `„Äå${aiMessage.dialogue}„Äç` : `[${aiMessage.description.substring(0, 20)}...]`; break;
                                default: notificationText = String(aiMessage.content || '');
                            }
                            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                            showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
                            notificationShown = true;
                        }
        
                        if (!isViewingThisChat) {
                            chat.unreadCount = (chat.unreadCount || 0) + 1;
                        }
                        
                        if (isViewingThisChat) {
                            appendMessage(aiMessage, chat);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                        }
                    }
                }        
        
                if (callHasBeenHandled && videoCallState.isGroupCall) {
                    videoCallState.isAwaitingResponse = false;
                    if (videoCallState.participants.length > 0) {
                        startVideoCall();
                    } else {
                        videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                        showScreen('chat-interface-screen');
                        alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
                    }
                }
                if (needsImmediateReaction) {
                    await triggerAiResponse();
                    return; 
                }
                await db.chats.put(chat);
                const qzoneActionTaken = messagesArray.some(action =>
                    action.type === 'qzone_post' ||
                    action.type === 'qzone_like' ||
                    action.type === 'qzone_comment' ||
                    action.type === 'repost'
                );
                if (qzoneActionTaken) {
                    console.log("Ê£ÄÊµãÂà∞AIÊâßË°å‰∫ÜÂä®ÊÄÅÊìç‰ΩúÔºåÁ´ãÂç≥Âà∑Êñ∞Â•ΩÂèãÂä®ÊÄÅÈ°µÈù¢„ÄÇ");
                    await renderQzonePosts();
                }

            } catch (error) {
                
                chat.history = chat.history.filter(msg => !msg.isTemporary);
                
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    chat.relationship.status = 'blocked_by_ai';
                    await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
                } else {
                    await showCustomAlert(
                        'API Ë∞ÉÁî®Â§±Ë¥•', 
                        `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØÔºåAIÊú™ËÉΩÊàêÂäüÂìçÂ∫î„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ:\n${error.message}`
                    );
                }
                
                if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                     await db.chats.put(chat);        
                }
               
                videoCallState.isAwaitingResponse = false;
            } finally {
                setAvatarActingState(chatId, false);
        
               
                if (chat.isGroup) {
                    if (typingIndicator) {
                        typingIndicator.style.display = 'none';
                    }
                } else {
                    if (chatHeaderTitle && state.chats[chatId]) {
                        chatHeaderTitle.style.opacity = 0;
                        setTimeout(() => {
                            chatHeaderTitle.textContent = state.chats[chatId].name;
                            chatHeaderTitle.classList.remove('typing-status');
                            chatHeaderTitle.style.opacity = 1;
                        }, 200);
                    }
                }
                renderChatList();
                if (isViewingThisChat) {
                    checkAndTriggerAutoSummary(chatId);
                }
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        
        
        
        
        
                async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        
                async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 999999) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0 Âà∞ 999999 ‰πãÈó¥)ÔºÅ'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë'; const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }
        /**
         * „ÄêÂÖ®Êñ∞ V3.0„ÄëÂèëÈÄÅ‰∏Ä‰∏™‰ΩçÁΩÆÂÖ±‰∫´Âç°Áâá (ËÉåÊôØÂõæÂ∑≤ÂÜÖÁΩÆ)
         */
        async function sendLocationShare() {
            if (!state.activeChatId) return;
        
            // Ê≠•È™§1: ËØ¢ÈóÆ‰ΩçÁΩÆÂêçÁß∞ (ËøôÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò)
            const locationName = await showCustomPrompt("ÂÖ±‰∫´‰ΩçÁΩÆ", "‰Ω†Áé∞Âú®Âú®Âì™ÈáåÂëÄÔºü", "");
        
            // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÊàñÊ≤°ÊúâËæìÂÖ•‰ΩçÁΩÆÔºåÂàôÁõ¥Êé•ÈÄÄÂá∫
            if (!locationName || !locationName.trim()) return; 
        
            // Ê≠•È™§2: „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÁõ¥Êé•ÂÆö‰πâÂ•ΩÊÇ®ÊÉ≥Áî®ÁöÑÂõæÁâáURL
            // ÊÇ®ÂèØ‰ª•ÈöèÊó∂Â∞ÜËøô‰∏™ÈìæÊé•ÊõøÊç¢‰∏∫ÊÇ®ÂñúÊ¨¢ÁöÑ‰ªª‰ΩïÂõæÁâáÂú∞ÂùÄ
            const hardcodedImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';
        
            const chat = state.chats[state.activeChatId];
            
            // Ê≠•È™§3: ÊûÑÂª∫Ê∂àÊÅØÂØπË±°ÔºåÁõ¥Êé•‰ΩøÁî®Êàë‰ª¨ÂÆö‰πâÂ•ΩÁöÑÂõæÁâáURL
            const msg = {
                role: 'user',
                type: 'location_share',
                content: locationName.trim(),
                imageUrl: hardcodedImageUrl, // Áõ¥Êé•‰ΩøÁî®‰∏äÈù¢ÂÆö‰πâÁöÑURL
                timestamp: Date.now()
            };
            
            // Ê≠•È™§4: ‰øùÂ≠òÂπ∂Êõ¥Êñ∞UI (ËøôÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò)
            chat.history.push(msg);
            await db.chats.put(chat);
            appendMessage(msg, chat);
            renderChatList();
        }
        
        
                function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        
                function exitSelectionMode() {
            cleanupWaimaiTimers(); // <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å
         if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊúÄÁªàÁÆÄÂåñÁâà„ÄëÊõøÊç¢ÊóßÁöÑ toggleMessageSelection ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function toggleMessageSelection(timestamp) {
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÈÄâÊã©Âô®Â∑≤ÁÆÄÂåñÔºå‰∏çÂÜçÂØªÊâæÂ∑≤Âà†Èô§ÁöÑ .recalled-message-placeholder
            const elementToSelect = document.querySelector(
                `.message-bubble[data-timestamp="${timestamp}"]`
            );
        
            if (!elementToSelect) return;
        
            if (selectedMessages.has(timestamp)) {
                selectedMessages.delete(timestamp);
                elementToSelect.classList.remove('selected');
            } else {
                selectedMessages.add(timestamp);
                elementToSelect.classList.add('selected');
            }
            
            document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;
            
            if (selectedMessages.size === 0) {
                exitSelectionMode();
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        
                async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•'; const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç'; const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    document.getElementById('global-lyrics-bar').classList.remove('visible');
    const cleanupLogic = async () => {
        if (musicState.timerId) clearInterval(musicState.timerId);
        if (musicState.isPlaying) audioPlayer.pause();
        if (saveState && oldChatId && state.chats[oldChatId]) {
            const chat = state.chats[oldChatId];
            chat.musicData.totalTime = musicState.totalElapsedTime;
            await db.chats.put(chat);
        }
        musicState.isActive = false;
        musicState.activeChatId = null;
        musicState.totalElapsedTime = 0;
        musicState.timerId = null;
        updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
}

function returnToChat() {
    closeMusicPlayerWithAnimation();
}

function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
window.updateListenTogetherIconProxy = updateListenTogetherIcon;

function updatePlayerUI() { 
    updateListenTogetherIcon(musicState.activeChatId); 
    updateElapsedTimeDisplay(); 
    const titleEl = document.getElementById('music-player-song-title'); 
    const artistEl = document.getElementById('music-player-artist'); 
    const playPauseBtn = document.getElementById('music-play-pause-btn'); 
    if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { 
        const track = musicState.playlist[musicState.currentIndex]; 
        titleEl.textContent = track.name; 
        artistEl.textContent = track.artist; 
    } else { 
        titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤'; 
        artistEl.textContent = '...'; 
    } 
    playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂'; 
}

function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`; }

function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
        playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>';
        return;
    }
    musicState.playlist.forEach((track, index) => {
        const item = document.createElement('div');
        item.className = 'playlist-item';
        if(index === musicState.currentIndex) item.classList.add('playing');
        item.innerHTML = `
            <div class="playlist-item-info">
                <div class="title">${track.name}</div>
                <div class="artist">${track.artist}</div>
            </div>
            <div class="playlist-item-actions">
                <span class="playlist-action-btn lyrics-btn" data-index="${index}">ËØç</span>
                <span class="playlist-action-btn delete-track-btn" data-index="${index}">√ó</span>
            </div>
        `;
        item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index));
        playlistBody.appendChild(item);
    });
}

async function playSong(index) {
    if (index < 0 || index >= musicState.playlist.length) return;

    audioPlayer.pause();

    musicState.currentIndex = index;
    const track = musicState.playlist[index];

    document.getElementById('music-visual-container').classList.remove('lyrics-active');
    const coverEl = document.getElementById('music-player-cover');
    if (coverEl) {
        coverEl.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
    }
    
    await addMusicActionSystemMessage(`Â∞ÜÊ≠åÊõ≤ÂàáÊç¢‰∏∫‰∫Ü„Ää${track.name}„Äã`);
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");
    
    renderLyrics(); 
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
            singleLyricEl.textContent = 'Á∫ØÈü≥‰πêÔºåËØ∑Ê¨£Ëµè';
        } else {
            singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™'; // ÂáÜÂ§áÊí≠ÊîæÔºåÊòæÁ§∫Èü≥Á¨¶
        }
    }
    if (track.isLocal && track.src instanceof ArrayBuffer) {
        const blob = new Blob([track.src], { type: track.fileType || 'audio/mpeg' });
        audioPlayer.src = URL.createObjectURL(blob);
    } 
    else if (track.isLocal && track.src instanceof Blob) {
        audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
        audioPlayer.src = track.src;
    } else {
        console.error('Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:', track);
        return;
    }
    
    const playPromise = audioPlayer.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            if (error.name !== 'AbortError') {
                console.error('Playback error:', error);
                
                // Â¶ÇÊûúÊòØÁΩëÊòì‰∫ëÈü≥‰πêÔºåÊèê‰æõÊõø‰ª£Âª∫ËÆÆ
                if (track.isNetease || track.needsManualUrl) {
                    showCustomAlert("Êí≠ÊîæÂ§±Ë¥•", `Êó†Ê≥ïÊí≠Êîæ„Ää${track.name}„Äã\n\nÂª∫ËÆÆÔºö\n1. ‰ΩøÁî®"ÊêúÁ¥¢"ÂäüËÉΩÊâæÂà∞Êõø‰ª£ÁâàÊú¨\n2. ‰ΩøÁî®"URL"ÂäüËÉΩÊ∑ªÂä†ÂÖ∂‰ªñÊí≠ÊîæÈìæÊé•\n3. ‰ΩøÁî®"Êú¨Âú∞"ÂäüËÉΩ‰∏ä‰º†Èü≥‰πêÊñá‰ª∂`);
                } else {
                    showCustomAlert("Êí≠ÊîæÂ§±Ë¥•", `Êó†Ê≥ïÊí≠Êîæ„Ää${track.name}„ÄãÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÂ∞ùËØïÂÖ∂‰ªñÊ≠åÊõ≤`);
                }
            }
        });
    }
    updatePlaylistUI();
    updatePlayerUI();
    updateMusicProgressBar();
    
    const lyricBar = document.getElementById('global-lyrics-bar');
    if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
        lyricBar.textContent = '‚ô™';
        lyricBar.classList.add('visible');
    } else {
        lyricBar.classList.remove('visible');
    }
}

async function togglePlayPause() {
    if (audioPlayer.paused) {
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
            playSong(0);
        } 
        else if (musicState.currentIndex > -1) {
            playSong(musicState.currentIndex);
        }
    } else {
        audioPlayer.pause();
        await addMusicActionSystemMessage('ÊöÇÂÅú‰∫ÜÈü≥‰πê');
    }
}

function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'È°∫Â∫è', 'random': 'ÈöèÊú∫', 'single': 'ÂçïÊõ≤'}[musicState.playMode]; }

async function addSongFromURL() { const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url"); if (!url) return; const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç"); if (!name) return; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    for (const file of files) {
        let name = file.name.replace(/\.[^/.]+$/, "");
        name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", name);
        if (name === null) continue;
        
        const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", "Êú™Áü•Ê≠åÊâã");
        if (artist === null) continue;

        const arrayBuffer = await file.arrayBuffer();

        let lrcContent = "";
        const wantLrc = await showCustomConfirm("ÂØºÂÖ•Ê≠åËØç", `Ë¶Å‰∏∫„Ää${name}„ÄãÊ∑ªÂä†Ê≠åËØçÂêóÔºü`);
        if (wantLrc) {
            lrcContent = await handleManualLrcImport(musicState.playlist.length) || "";
        }
        
        musicState.playlist.push({ 
            name, 
            artist, 
            src: arrayBuffer,
            fileType: file.type,
            isLocal: true,
            lrcContent: lrcContent,
            cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg'
        });
    }
    
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        musicState.currentIndex = 0;
        updatePlayerUI();
    }
    event.target.value = null;
}

async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
// ÁÆÄÂåñÁöÑÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçïÂØºÂÖ•ÂäüËÉΩ
async function importNeteasePlaylist() {
    try {
        // ÊòæÁ§∫ËØ¥ÊòéÂíåÈÄâÈ°π
        const choice = await showCustomConfirm(
            "ÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçïÂØºÂÖ•", 
            "Áî±‰∫éÁâàÊùÉ‰øùÊä§ÔºåÁΩëÊòì‰∫ëÈü≥‰πêÁöÑÊ≠åÊõ≤Êó†Ê≥ïÁõ¥Êé•Êí≠Êîæ„ÄÇ\n\nËØ∑ÈÄâÊã©Ôºö\n1. ÊâãÂä®ËæìÂÖ•Ê≠åÂçï‰ø°ÊÅØÔºàÊé®ËçêÔºâ\n2. Â∞ùËØïËá™Âä®Ëé∑ÂèñÔºàÂèØËÉΩÂ§±Ë¥•Ôºâ\n\nÁÇπÂáª\"Á°ÆÂÆö\"ÊâãÂä®ËæìÂÖ•ÔºåÁÇπÂáª\"ÂèñÊ∂à\"Â∞ùËØïËá™Âä®Ëé∑Âèñ"
        );
        
        if (choice) {
            // ÊâãÂä®ËæìÂÖ•Ê≠åÂçï‰ø°ÊÅØ
            await manualPlaylistInput();
            return;
        }
        
        // Â∞ùËØïËá™Âä®Ëé∑Âèñ
        const playlistUrl = await showCustomPrompt(
            "ÂØºÂÖ•ÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçï", 
            "ËØ∑ËæìÂÖ•ÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçïÁöÑÂàÜ‰∫´ÈìæÊé•", 
            "", 
            "url"
        );
        
        if (!playlistUrl) return;
        
        // Ëß£ÊûêÊ≠åÂçïID
        const playlistId = extractNeteasePlaylistId(playlistUrl);
        if (!playlistId) {
            showCustomAlert("ÈîôËØØ", "Êó†Ê≥ïËß£ÊûêÊ≠åÂçïIDÔºåËØ∑Ê£ÄÊü•ÈìæÊé•Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ");
            return;
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
        showCustomAlert("Ê≠£Âú®ÂØºÂÖ•", "Ê≠£Âú®Ëé∑ÂèñÊ≠åÂçï‰ø°ÊÅØÔºåËØ∑Á®çÂÄô...");
        
        // Â∞ùËØïËé∑ÂèñÊ≠åÂçïËØ¶ÊÉÖ
        let playlistData;
        try {
            playlistData = await fetchNeteasePlaylist(playlistId);
        } catch (error) {
            console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
            showCustomAlert("Ëé∑ÂèñÂ§±Ë¥•", "Êó†Ê≥ïËá™Âä®Ëé∑ÂèñÊ≠åÂçï‰ø°ÊÅØÔºåËØ∑‰ΩøÁî®ÊâãÂä®ËæìÂÖ•ÂäüËÉΩ");
            return;
        }
        
        if (!playlistData || !playlistData.tracks || playlistData.tracks.length === 0) {
            showCustomAlert("ÈîôËØØ", "Êó†Ê≥ïËé∑ÂèñÊ≠åÂçï‰ø°ÊÅØÊàñÊ≠åÂçï‰∏∫Á©∫");
            return;
        }
        
        // Ëß£ÊûêÊ≠åÊõ≤‰ø°ÊÅØÂπ∂Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®
        let addedCount = 0;
        let addedSongs = [];
        
        for (const track of playlistData.tracks) {
            if (track && track.name && track.ar && track.ar.length > 0) {
                const songName = track.name;
                const artist = track.ar.map(ar => ar.name).join(', ');
                const album = track.al ? track.al.name : 'Êú™Áü•‰∏ìËæë';
                const cover = track.al && track.al.picUrl ? track.al.picUrl : 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
                
                // ‰ΩøÁî®Âç†‰ΩçÁ¨¶ÈìæÊé•ÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®Ê∑ªÂä†
                musicState.playlist.push({
                    name: songName,
                    artist: artist,
                    album: album,
                    src: `https://music.163.com/song/media/outer/url?id=${track.id}.mp3`,
                    isLocal: false,
                    cover: cover,
                    neteaseId: track.id,
                    lrcContent: "",
                    isNetease: true,
                    needsManualUrl: true // Ê†áËÆ∞ÈúÄË¶ÅÊâãÂä®Ê∑ªÂä†Êí≠ÊîæÈìæÊé•
                });
                
                addedSongs.push({
                    name: songName,
                    artist: artist
                });
                addedCount++;
            }
        }
        
        // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞UI
        await saveGlobalPlaylist();
        updatePlaylistUI();
        
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
            musicState.currentIndex = musicState.playlist.length - addedCount;
            updatePlayerUI();
        }
        
        // ÊòæÁ§∫ÂØºÂÖ•ÊàêÂäü‰ø°ÊÅØ
        let successMessage = `üéµ Ê≠åÂçï‰ø°ÊÅØÂØºÂÖ•ÊàêÂäüÔºÅ\n\n`;
        successMessage += `‚úÖ ÊàêÂäüÂØºÂÖ•: ${addedCount} È¶ñÊ≠åÊõ≤\n`;
        successMessage += `üìä Ê≠åÂçïÊÄªÊï∞: ${playlistData.tracks.length} È¶ñÊ≠åÊõ≤\n\n`;
        
        if (playlistData.name) {
            successMessage += `üé∂ Ê≠åÂçïÂêçÁß∞: ${playlistData.name}\n`;
        }
        if (playlistData.creator && playlistData.creator.nickname) {
            successMessage += `üë§ ÂàõÂª∫ËÄÖ: ${playlistData.creator.nickname}\n`;
        }
        
        successMessage += `\n‚ö†Ô∏è Ê≥®ÊÑèÔºöÁî±‰∫éÁâàÊùÉ‰øùÊä§ÔºåÊ≠åÊõ≤Êó†Ê≥ïÁõ¥Êé•Êí≠Êîæ„ÄÇ\n`;
        successMessage += `ËØ∑‰ΩøÁî®"ÊêúÁ¥¢"ÂäüËÉΩÊâæÂà∞Êõø‰ª£ÁâàÊú¨Ôºå\n`;
        successMessage += `Êàñ‰ΩøÁî®"URL"ÂäüËÉΩÊ∑ªÂä†ÂÖ∂‰ªñÊí≠ÊîæÈìæÊé•„ÄÇ`;
        
        showCustomAlert("ÂØºÂÖ•ÊàêÂäü", successMessage);
        
    } catch (error) {
        console.error('ÂØºÂÖ•ÁΩëÊòì‰∫ëÊ≠åÂçïÂ§±Ë¥•:', error);
        showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", "ÂØºÂÖ•Ê≠åÂçïÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑‰ΩøÁî®ÊâãÂä®ËæìÂÖ•ÂäüËÉΩ");
    }
}

// ‰ªéÁΩëÊòì‰∫ëÈü≥‰πêURL‰∏≠ÊèêÂèñÊ≠åÂçïID
function extractNeteasePlaylistId(url) {
    try {
        // ÊîØÊåÅÂ§öÁßçÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçïURLÊ†ºÂºè
        const patterns = [
            // ÁßªÂä®Á´ØÊ†ºÂºè: https://music.163.com/m/playlist?id=379607699&creatorId=276405398
            /\/m\/playlist\?id=(\d+)/,
            // Ê°åÈù¢Á´ØÊ†ºÂºè: https://music.163.com/playlist?id=379607699
            /playlist\?id=(\d+)/,
            // ÂÖ∂‰ªñÊ†ºÂºè
            /playlist\/(\d+)/,
            /id=(\d+).*playlist/,
            /playlist.*id=(\d+)/
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) {
                console.log(`ÊàêÂäüËß£ÊûêÊ≠åÂçïID: ${match[1]}, ‰ΩøÁî®Ê®°Âºè: ${pattern}`);
                return match[1];
            }
        }
        
        console.error('Êó†Ê≥ïËß£ÊûêÊ≠åÂçïIDÔºåURLÊ†ºÂºè:', url);
        return null;
    } catch (error) {
        console.error('Ëß£ÊûêÊ≠åÂçïIDÂ§±Ë¥•:', error);
        return null;
    }
}

// Ëé∑ÂèñÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÂçïËØ¶ÊÉÖ
async function fetchNeteasePlaylist(playlistId) {
    try {
        console.log(`Ê≠£Âú®Ëé∑ÂèñÊ≠åÂçïID: ${playlistId} ÁöÑËØ¶ÊÉÖ...`);
        
        // ‰ΩøÁî®Â§ö‰∏™Â§áÁî®‰ª£ÁêÜÊúçÂä°Âô®ÔºàÊåâÊàêÂäüÁéáÊéíÂ∫èÔºâ
        const proxyUrls = [
            'https://api.allorigins.win/raw?url=',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://cors-anywhere.herokuapp.com/'
        ];
        
        // Â∞ùËØïÂ§ö‰∏™APIÁ´ØÁÇπ
        const apiEndpoints = [
            `https://music.163.com/api/playlist/detail?id=${playlistId}`,
            `https://music.163.com/weapi/v3/playlist/detail?id=${playlistId}`,
            `https://music.163.com/api/v3/playlist/detail?id=${playlistId}`
        ];
        
        for (const apiUrl of apiEndpoints) {
            console.log(`Â∞ùËØïAPIÁ´ØÁÇπ: ${apiUrl}`);
            
            for (let i = 0; i < proxyUrls.length; i++) {
                try {
                    const proxyUrl = proxyUrls[i];
                    const fullUrl = proxyUrl + encodeURIComponent(apiUrl);
                    
                    console.log(`Â∞ùËØï‰ª£ÁêÜÊúçÂä°Âô® ${i + 1}: ${proxyUrl}`);
                    
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                            'Referer': 'https://music.163.com/',
                            'Origin': 'https://music.163.com'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                        
                        if (data && data.result) {
                            console.log(`ÊàêÂäüËé∑ÂèñÊ≠åÂçï‰ø°ÊÅØÔºåÂåÖÂê´ ${data.result.tracks ? data.result.tracks.length : 0} È¶ñÊ≠åÊõ≤`);
                            return data.result;
                        } else if (data && data.playlist) {
                            console.log(`ÊàêÂäüËé∑ÂèñÊ≠åÂçï‰ø°ÊÅØÔºàÂ§áÁî®Ê†ºÂºèÔºâÔºåÂåÖÂê´ ${data.playlist.tracks ? data.playlist.tracks.length : 0} È¶ñÊ≠åÊõ≤`);
                            return data.playlist;
                        }
                    } else {
                        console.log(`‰ª£ÁêÜÊúçÂä°Âô® ${i + 1} ËøîÂõûÁä∂ÊÄÅ: ${response.status}`);
                    }
                } catch (proxyError) {
                    console.log(`‰ª£ÁêÜÊúçÂä°Âô® ${i + 1} Â§±Ë¥•:`, proxyError.message);
                    continue;
                }
            }
        }
        
        // Â¶ÇÊûúÊâÄÊúâ‰ª£ÁêÜÈÉΩÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•Ë∞ÉÁî®ÔºàÂèØËÉΩÂú®Êüê‰∫õÁéØÂ¢É‰∏ãÊúâÊïàÔºâ
        try {
            console.log('Â∞ùËØïÁõ¥Êé•Ë∞ÉÁî®API...');
            const response = await fetch(apiEndpoints[0], {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                return data.result;
            }
        } catch (directError) {
            console.log('Áõ¥Êé•Ë∞ÉÁî®‰πüÂ§±Ë¥•:', directError.message);
        }
        
        throw new Error('ÊâÄÊúâAPIË∞ÉÁî®ÊñπÂºèÈÉΩÂ§±Ë¥•‰∫Ü');
        
    } catch (error) {
        console.error('Ëé∑ÂèñÊ≠åÂçïËØ¶ÊÉÖÂ§±Ë¥•:', error);
        throw error;
    }
}

// Ëé∑ÂèñÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÊõ≤Êí≠ÊîæÈìæÊé•
async function getNeteaseSongUrl(songId) {
    try {
        // Â∞ùËØïÂ§ö‰∏™Êí≠ÊîæÈìæÊé•Ê†ºÂºè
        const playUrls = [
            `https://music.163.com/song/media/outer/url?id=${songId}.mp3`,
            `https://music.163.com/song/media/outer/url?id=${songId}`,
            `https://music.163.com/weapi/song/enhance/player/url/v1?csrf_token=&ids=[${songId}]&level=standard&encodeType=aac&format=json`,
            `https://music.163.com/api/song/enhance/player/url/v1?csrf_token=&ids=[${songId}]&level=standard&encodeType=aac&format=json`
        ];
        
        // È¶ñÂÖàÂ∞ùËØïÁõ¥Êé•ÁöÑÂ§ñÈìæÊí≠Êîæ
        for (const url of playUrls.slice(0, 2)) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    console.log(`ÊâæÂà∞ÂèØÁî®ÁöÑÊí≠ÊîæÈìæÊé•: ${url}`);
                    return url;
                }
            } catch (error) {
                continue;
            }
        }
        
        // Â¶ÇÊûúÁõ¥Êé•ÈìæÊé•‰∏çË°åÔºåÂ∞ùËØïÈÄöËøáAPIËé∑Âèñ
        const proxyUrls = [
            'https://api.allorigins.win/raw?url=',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        for (const apiUrl of playUrls.slice(2)) {
            for (const proxyUrl of proxyUrls) {
                try {
                    const fullUrl = proxyUrl + encodeURIComponent(apiUrl);
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Referer': 'https://music.163.com/'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.data && data.data[0] && data.data[0].url) {
                            console.log(`ÈÄöËøáAPIËé∑ÂèñÂà∞Êí≠ÊîæÈìæÊé•: ${data.data[0].url}`);
                            return data.data[0].url;
                        }
                    }
                } catch (error) {
                    continue;
                }
            }
        }
        
        // Â¶ÇÊûúÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåËøîÂõû‰∏Ä‰∏™Âç†‰ΩçÁ¨¶ÈìæÊé•
        console.log(`Êó†Ê≥ïËé∑ÂèñÊ≠åÊõ≤ ${songId} ÁöÑÊí≠ÊîæÈìæÊé•Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶`);
        return `https://music.163.com/song/media/outer/url?id=${songId}.mp3`;
        
    } catch (error) {
        console.error('Ëé∑ÂèñÊ≠åÊõ≤Êí≠ÊîæÈìæÊé•Â§±Ë¥•:', error);
        return `https://music.163.com/song/media/outer/url?id=${songId}.mp3`;
    }
}

// Ëé∑ÂèñÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åËØç
async function getNeteaseLyrics(songId) {
    try {
        const proxyUrls = [
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        const apiUrl = `https://music.163.com/api/song/lyric?id=${songId}&lv=1&kv=1&tv=-1`;
        
        for (const proxyUrl of proxyUrls) {
            try {
                const fullUrl = proxyUrl + encodeURIComponent(apiUrl);
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.lrc) {
                        return data.lrc.lyric || "";
                    }
                }
            } catch (proxyError) {
                continue;
            }
        }
        
        return "";
    } catch (error) {
        console.error('Ëé∑ÂèñÊ≠åËØçÂ§±Ë¥•:', error);
        return "";
    }
}

// ÊµãËØïURLËß£ÊûêÂáΩÊï∞
function testUrlParsing() {
    const testUrls = [
        'https://music.163.com/m/playlist?id=379607699&creatorId=276405398',
        'https://music.163.com/playlist?id=379607699',
        'https://music.163.com/playlist/379607699',
        'music.163.com/playlist?id=379607699'
    ];
    
    console.log('=== ÊµãËØïURLËß£ÊûêÂäüËÉΩ ===');
    testUrls.forEach((url, index) => {
        const playlistId = extractNeteasePlaylistId(url);
        console.log(`ÊµãËØï ${index + 1}: ${url}`);
        console.log(`Ëß£ÊûêÁªìÊûú: ${playlistId ? `ÊàêÂäü - ID: ${playlistId}` : 'Â§±Ë¥•'}`);
        console.log('---');
    });
}

// ÊâãÂä®ËæìÂÖ•Ê≠åÂçï‰ø°ÊÅØ
async function manualPlaylistInput() {
    try {
        const songCount = await showCustomPrompt(
            "ÊâãÂä®ËæìÂÖ•Ê≠åÂçï", 
            "ËØ∑ËæìÂÖ•Ê≠åÂçï‰∏≠ÁöÑÊ≠åÊõ≤Êï∞Èáè", 
            "1", 
            "number"
        );
        
        if (!songCount || songCount < 1) return;
        
        let addedCount = 0;
        for (let i = 0; i < parseInt(songCount); i++) {
            const songName = await showCustomPrompt(
                "Ê≠åÊõ≤‰ø°ÊÅØ", 
                `ËØ∑ËæìÂÖ•Á¨¨ ${i + 1} È¶ñÊ≠åÊõ≤ÁöÑÂêçÁß∞`, 
                ""
            );
            if (!songName) continue;
            
            const artist = await showCustomPrompt(
                "Ê≠åÊõ≤‰ø°ÊÅØ", 
                `ËØ∑ËæìÂÖ•Á¨¨ ${i + 1} È¶ñÊ≠åÊõ≤ÁöÑÊ≠åÊâã`, 
                "Êú™Áü•Ê≠åÊâã"
            );
            if (!artist) continue;
            
            const album = await showCustomPrompt(
                "Ê≠åÊõ≤‰ø°ÊÅØ", 
                `ËØ∑ËæìÂÖ•Á¨¨ ${i + 1} È¶ñÊ≠åÊõ≤ÁöÑ‰∏ìËæëÔºàÂèØÈÄâÔºâ`, 
                "Êú™Áü•‰∏ìËæë"
            );
            
            const songUrl = await showCustomPrompt(
                "Ê≠åÊõ≤ÈìæÊé•", 
                `ËØ∑ËæìÂÖ•Á¨¨ ${i + 1} È¶ñÊ≠åÊõ≤ÁöÑÊí≠ÊîæÈìæÊé•ÔºàÂèØÈÄâÔºâ`, 
                "", 
                "url"
            );
            
            musicState.playlist.push({
                name: songName,
                artist: artist,
                album: album || "Êú™Áü•‰∏ìËæë",
                src: songUrl || `https://music.163.com/song/media/outer/url?id=${Date.now()}.mp3`,
                isLocal: false,
                cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
                lrcContent: ""
            });
            addedCount++;
        }
        
        // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞UI
        await saveGlobalPlaylist();
        updatePlaylistUI();
        
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
            musicState.currentIndex = musicState.playlist.length - addedCount;
            updatePlayerUI();
        }
        
        showCustomAlert("ÂØºÂÖ•ÊàêÂäü", `ÊàêÂäüÊ∑ªÂä† ${addedCount} È¶ñÊ≠åÊõ≤`);
        
    } catch (error) {
        console.error('ÊâãÂä®ËæìÂÖ•Ê≠åÂçïÂ§±Ë¥•:', error);
        showCustomAlert("ËæìÂÖ•Â§±Ë¥•", "ËæìÂÖ•Ê≠åÂçï‰ø°ÊÅØÊó∂ÂèëÁîüÈîôËØØ");
    }
}

// ÁÆÄÂåñÁöÑÊí≠ÊîæÂ§±Ë¥•Â§ÑÁêÜ
function handlePlaybackError(track) {
    if (track.isNetease || track.needsManualUrl) {
        showCustomAlert("Êí≠ÊîæÂ§±Ë¥•", `Êó†Ê≥ïÊí≠Êîæ„Ää${track.name}„Äã\n\nÂª∫ËÆÆÔºö\n1. ‰ΩøÁî®"ÊêúÁ¥¢"ÂäüËÉΩÊâæÂà∞Êõø‰ª£ÁâàÊú¨\n2. ‰ΩøÁî®"URL"ÂäüËÉΩÊ∑ªÂä†ÂÖ∂‰ªñÊí≠ÊîæÈìæÊé•\n3. ‰ΩøÁî®"Êú¨Âú∞"ÂäüËÉΩ‰∏ä‰º†Èü≥‰πêÊñá‰ª∂`);
    } else {
        showCustomAlert("Êí≠ÊîæÂ§±Ë¥•", `Êó†Ê≥ïÊí≠Êîæ„Ää${track.name}„ÄãÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÂ∞ùËØïÂÖ∂‰ªñÊ≠åÊõ≤`);
    }
}

// Êü•ÁúãÂØºÂÖ•ÂéÜÂè≤
function viewImportHistory() {
    try {
        const importHistory = JSON.parse(localStorage.getItem('neteaseImportHistory') || '[]');
        
        if (importHistory.length === 0) {
            showCustomAlert("ÂØºÂÖ•ÂéÜÂè≤", "ÊöÇÊó†ÂØºÂÖ•ËÆ∞ÂΩï");
            return;
        }
        
        let historyMessage = `üìö ÁΩëÊòì‰∫ëÈü≥‰πêÂØºÂÖ•ÂéÜÂè≤\n\n`;
        historyMessage += `ÂÖ± ${importHistory.length} Ê¨°ÂØºÂÖ•ËÆ∞ÂΩï\n\n`;
        
        importHistory.forEach((record, index) => {
            const date = new Date(record.timestamp).toLocaleString('zh-CN');
            historyMessage += `${index + 1}. ${record.playlistName}\n`;
            historyMessage += `   üë§ ÂàõÂª∫ËÄÖ: ${record.creator}\n`;
            historyMessage += `   üìä ÂØºÂÖ•: ${record.importedSongs}/${record.totalSongs} È¶ñ (${record.successRate}%)\n`;
            historyMessage += `   ‚è∞ Êó∂Èó¥: ${date}\n\n`;
        });
        
        showCustomAlert("ÂØºÂÖ•ÂéÜÂè≤", historyMessage);
        
    } catch (error) {
        console.error('Êü•ÁúãÂØºÂÖ•ÂéÜÂè≤Â§±Ë¥•:', error);
        showCustomAlert("ÈîôËØØ", "Êó†Ê≥ïÂä†ËΩΩÂØºÂÖ•ÂéÜÂè≤");
    }
}

// ÊµãËØïÈü≥‰πêÈìæÊé•ÊòØÂê¶ÂèØÁî®
async function testMusicUrl(url) {
    try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
    } catch (error) {
        return false;
    }
}

// ÁÆÄÂåñÁöÑ‰øÆÂ§çÂäüËÉΩ
function fixUnplayableSongs() {
    const neteaseSongs = musicState.playlist.filter(track => track.isNetease || track.needsManualUrl);
    
    if (neteaseSongs.length === 0) {
        showCustomAlert("Ê£ÄÊü•ÂÆåÊàê", "Ê≤°ÊúâÂèëÁé∞ÈúÄË¶Å‰øÆÂ§çÁöÑÊ≠åÊõ≤ÔºÅ");
        return;
    }
    
    let message = `ÂèëÁé∞ ${neteaseSongs.length} È¶ñÁΩëÊòì‰∫ëÈü≥‰πêÊ≠åÊõ≤Ôºö\n\n`;
    neteaseSongs.forEach((track, index) => {
        message += `${index + 1}. ${track.name} - ${track.artist}\n`;
    });
    
    message += `\nËøô‰∫õÊ≠åÊõ≤Áî±‰∫éÁâàÊùÉ‰øùÊä§Êó†Ê≥ïÁõ¥Êé•Êí≠Êîæ„ÄÇ\n\nÂª∫ËÆÆÔºö\n1. ‰ΩøÁî®"ÊêúÁ¥¢"ÂäüËÉΩÊâæÂà∞Êõø‰ª£ÁâàÊú¨\n2. ‰ΩøÁî®"URL"ÂäüËÉΩÊ∑ªÂä†ÂÖ∂‰ªñÊí≠ÊîæÈìæÊé•\n3. ‰ΩøÁî®"Êú¨Âú∞"ÂäüËÉΩ‰∏ä‰º†Èü≥‰πêÊñá‰ª∂`;
    
    showCustomAlert("ÈúÄË¶Å‰øÆÂ§çÁöÑÊ≠åÊõ≤", message);
}
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊñ∞ÁâàÊú¨„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ addSongFromLocal ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        async function addSongFromLocal(event) {
            const files = event.target.files;
            if (!files.length) return;
        
            for (const file of files) {
                let name = file.name.replace(/\.[^/.]+$/, "");
                name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", name);
                if (name === null) continue;
                
                const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", "Êú™Áü•Ê≠åÊâã");
                if (artist === null) continue;
        
                let lrcContent = "";
                const wantLrc = await showCustomConfirm("ÂØºÂÖ•Ê≠åËØç", `Ë¶Å‰∏∫„Ää${name}„ÄãÊ∑ªÂä†Ê≠åËØçÂêóÔºü`);
                if (wantLrc) {
                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÁõ¥Êé•Ë∞ÉÁî®Êàë‰ª¨Êñ∞ÁöÑÁªü‰∏ÄÂáΩÊï∞ÔºÅ
                    lrcContent = await getLrcContent() || ""; // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÔºåÂàôlrcContent‰∏∫""
                }
                
                musicState.playlist.push({ 
                    name, 
                    artist, 
                    src: file, 
                    isLocal: true,
                    lrcContent: lrcContent
                });
            }
            
            await saveGlobalPlaylist();
            updatePlaylistUI();
            if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
                musicState.currentIndex = 0;
                updatePlayerUI();
            }
            event.target.value = null;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }
        
                const personaLibraryModal = document.getElementById('persona-library-modal');
                const personaEditorModal = document.getElementById('persona-editor-modal');
                const presetActionsModal = document.getElementById('preset-actions-modal');
        
                function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        
                function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        
                function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        
                function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        
                function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        
                function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        
                function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        
                async function deletePersonaPreset() { const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        
                function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        
                async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }
        
                const batteryAlertModal = document.getElementById('battery-alert-modal');
        
                function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        
                function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        
                function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        
                async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±'); } }); } catch (err) { console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } } else { console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ"); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } }
        
                async function renderAlbumList() {
                    const albumGrid = document.getElementById('album-grid-page');
                    if (!albumGrid) return;
                    const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
                    albumGrid.innerHTML = '';
                    if (albums.length === 0) {
                        albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">‰Ω†ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜåÂì¶~</p>';
                        return;
                    }
                    albums.forEach(album => {
                        const albumItem = document.createElement('div');
                        albumItem.className = 'album-item';
                        albumItem.innerHTML = `
                            <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                            <div class="album-info">
                                <p class="album-name">${album.name}</p>
                                <p class="album-count">${album.photoCount || 0} Âº†</p>
                            </div>
                        `;
                        albumItem.addEventListener('click', () => {
                            openAlbum(album.id);
                        });
        
                        // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑÊ†∏ÂøÉ‰ª£Á†ÅÂ∞±ÊòØËøôÈáå ‚ñº‚ñº‚ñº
                        addLongPressListener(albumItem, async () => {
                            const confirmed = await showCustomConfirm(
                                'Âà†Èô§Áõ∏ÂÜå',
                                `Á°ÆÂÆöË¶ÅÂà†Èô§Áõ∏ÂÜå„Ää${album.name}„ÄãÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÜåÂÜÖÁöÑÊâÄÊúâÁÖßÁâáÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`,
                                { confirmButtonClass: 'btn-danger' }
                            );
        
                            if (confirmed) {
                                // 1. ‰ªéÁÖßÁâáË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜå‰∏ãÁöÑÊâÄÊúâÁÖßÁâá
                                await db.qzonePhotos.where('albumId').equals(album.id).delete();
                                
                                // 2. ‰ªéÁõ∏ÂÜåË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜåÊú¨Ë∫´
                                await db.qzoneAlbums.delete(album.id);
                                
                                // 3. ÈáçÊñ∞Ê∏≤ÊüìÁõ∏ÂÜåÂàóË°®
                                await renderAlbumList();
                                
                                alert('Áõ∏ÂÜåÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
                            }
                        });
                        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                        albumGrid.appendChild(albumItem);
                    });
                }
        
                async function openAlbum(albumId) {
                    state.activeAlbumId = albumId;
                    await renderAlbumPhotosScreen();
                    showScreen('album-photos-screen');
                }
        
                async function renderAlbumPhotosScreen() {
                    if (!state.activeAlbumId) return;
                    const photosGrid = document.getElementById('photos-grid-page');
                    const headerTitle = document.getElementById('album-photos-title');
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    if (!album) {
                        console.error("Êâæ‰∏çÂà∞Áõ∏ÂÜå:", state.activeAlbumId);
                        showScreen('album-screen');
                        return;
                    }
                    headerTitle.textContent = album.name;
                    const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
                    photosGrid.innerHTML = '';
                    if (photos.length === 0) {
                        photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ëøô‰∏™Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºåÂø´‰∏ä‰º†Á¨¨‰∏ÄÂº†ÁÖßÁâáÂêßÔºÅ</p>';
                    } else {
                        photos.forEach(photo => {
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            photoItem.innerHTML = `
                                <img src="${photo.url}" class="photo-thumb" alt="Áõ∏ÂÜåÁÖßÁâá">
                                <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                            `;
                            photosGrid.appendChild(photoItem);
                        });
                    }
                }
        
        // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---
        
        /**
         * ÊâìÂºÄÂõæÁâáÊü•ÁúãÂô®
         * @param {string} clickedPhotoUrl - Áî®Êà∑ÁÇπÂáªÁöÑÈÇ£Âº†ÁÖßÁâáÁöÑURL
         */
        async function openPhotoViewer(clickedPhotoUrl) {
            if (!state.activeAlbumId) return;
        
            // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâá
            const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photoViewerState.photos = photosInAlbum.map(p => p.url);
        
            // 2. ÊâæÂà∞Ë¢´ÁÇπÂáªÁÖßÁâáÁöÑÁ¥¢Âºï
            photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
            if (photoViewerState.currentIndex === -1) return; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂàô‰∏çÊâìÂºÄ
        
            // 3. ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂Ê∏≤ÊüìÁ¨¨‰∏ÄÂº†Âõæ
            document.getElementById('photo-viewer-modal').classList.add('visible');
            renderPhotoViewer();
            photoViewerState.isOpen = true;
        }
        
        /**
         * Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅÊ∏≤ÊüìÊü•ÁúãÂô®ÂÜÖÂÆπÔºàÂõæÁâáÂíåÊåâÈíÆÔºâ
         */
        function renderPhotoViewer() {
            if (photoViewerState.currentIndex === -1) return;
        
            const imageEl = document.getElementById('photo-viewer-image');
            const prevBtn = document.getElementById('photo-viewer-prev-btn');
            const nextBtn = document.getElementById('photo-viewer-next-btn');
            
            // Ê∑°Âá∫ÊïàÊûú
            imageEl.style.opacity = 0;
        
            setTimeout(() => {
                // Êõ¥Êñ∞ÂõæÁâáÊ∫ê
                imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
                // Ê∑°ÂÖ•ÊïàÊûú
                imageEl.style.opacity = 1;
            }, 100); // Âª∂Ëøü‰∏ÄÁÇπÁÇπÊó∂Èó¥Êù•Ëß¶ÂèëCSSËøáÊ∏°
        
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºöÂ¶ÇÊûúÊòØÁ¨¨‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ä‰∏ÄÂº†‚ÄùÊåâÈíÆ
            prevBtn.disabled = photoViewerState.currentIndex === 0;
            // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ã‰∏ÄÂº†‚ÄùÊåâÈíÆ
            nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
        }
        
        /**
         * ÊòæÁ§∫‰∏ã‰∏ÄÂº†ÁÖßÁâá
         */
        function showNextPhoto() {
            if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
                photoViewerState.currentIndex++;
                renderPhotoViewer();
            }
        }
        
        /**
         * ÊòæÁ§∫‰∏ä‰∏ÄÂº†ÁÖßÁâá
         */
        function showPrevPhoto() {
            if (photoViewerState.currentIndex > 0) {
                photoViewerState.currentIndex--;
                renderPhotoViewer();
            }
        }
        
        /**
         * ÂÖ≥Èó≠ÂõæÁâáÊü•ÁúãÂô®
         */
        function closePhotoViewer() {
            document.getElementById('photo-viewer-modal').classList.remove('visible');
            photoViewerState.isOpen = false;
            photoViewerState.photos = [];
            photoViewerState.currentIndex = -1;
            // Ê∏ÖÁ©∫ÂõæÁâáÔºåÈÅøÂÖç‰∏ãÊ¨°ÊâìÂºÄÊó∂Èó™Áé∞ÊóßÂõæ
            document.getElementById('photo-viewer-image').src = '';
        }
        
        // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---
                // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÂáΩÊï∞Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
                
                /**
                 * Êõ¥Êñ∞Âä®ÊÄÅÂ∞èÁ∫¢ÁÇπÁöÑÊòæÁ§∫
                 * @param {number} count - Êú™ËØªÂä®ÊÄÅÁöÑÊï∞Èáè
                 */
                function updateUnreadIndicator(count) {
                    unreadPostsCount = count;
                    localStorage.setItem('unreadPostsCount', count); // ÊåÅ‰πÖÂåñÂ≠òÂÇ®
        
                    // --- Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÁöÑ‚ÄúÂä®ÊÄÅ‚ÄùÊåâÈíÆ ---
                    const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
                    
                    const targetSpan = navItem.querySelector('span'); // ÂÆö‰ΩçÂà∞ÊñáÂ≠ó "Âä®ÊÄÅ"
                    let indicator = navItem.querySelector('.unread-indicator');           
        
                    if (count > 0) {
                        if (!indicator) {
                            indicator = document.createElement('span');
                            indicator.className = 'unread-indicator';
                                                                   targetSpan.style.position = 'relative'; // ÊääÁõ∏ÂØπÂÆö‰ΩçÂä†Âú® span ‰∏ä
                            targetSpan.appendChild(indicator); // ÊääÂ∞èÁ∫¢ÁÇπ‰Ωú‰∏∫ span ÁöÑÂ≠êÂÖÉÁ¥†
                            
                        }
                        indicator.textContent = count > 99 ? '99+' : count;
                        indicator.style.display = 'block';
                    } else {
                        if (indicator) {
                            indicator.style.display = 'none';
                        }
                    }
        
                    // --- Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ËøîÂõûÂàóË°®ÁöÑÊåâÈíÆ ---
                    const backBtn = document.getElementById('back-to-list-btn');
                    let backBtnIndicator = backBtn.querySelector('.unread-indicator');
        
                    if (count > 0) {
                        if (!backBtnIndicator) {
                            backBtnIndicator = document.createElement('span');
                            backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                            backBtn.style.position = 'relative'; // Á°Æ‰øùËÉΩÊ≠£Á°ÆÂÆö‰Ωç
                            backBtn.appendChild(backBtnIndicator);
                        }
                        // ËøîÂõûÈîÆ‰∏äÁöÑÂ∞èÁ∫¢ÁÇπÈÄöÂ∏∏‰∏çÊòæÁ§∫Êï∞Â≠óÔºåÂè™ÊòæÁ§∫‰∏Ä‰∏™ÁÇπ
                        backBtnIndicator.style.display = 'block';
                    } else {
                        if (backBtnIndicator) {
                            backBtnIndicator.style.display = 'none';
                        }
                    }
                }
                
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Â∞ÜËøô‰∏§‰∏™Êñ∞ÂáΩÊï∞Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        function startBackgroundSimulation() {
            if (simulationIntervalId) return;
            const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
            // Â∞ÜÊóßÁöÑÂõ∫ÂÆöÈó¥Èöî 45000 ÊõøÊç¢‰∏∫Âä®ÊÄÅËé∑Âèñ
            simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
        }
        
        function stopBackgroundSimulation() {
            if (simulationIntervalId) {
                clearInterval(simulationIntervalId);
                simulationIntervalId = null;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ runBackgroundSimulationTick ‚ñº‚ñº‚ñº
        /**
         * ËøôÊòØÊ®°ÊãüÂô®ÁöÑ‚ÄúÂøÉË∑≥‚ÄùÔºåÊØèÊ¨°ÂÆöÊó∂Âô®Ëß¶ÂèëÊó∂ËøêË°å
         */
        function runBackgroundSimulationTick() {
            console.log("Ê®°ÊãüÂô®ÂøÉË∑≥ Tick...");
            if (!state.globalSettings.enableBackgroundActivity) {
                stopBackgroundSimulation();
                return;
            }
        
            // --- 1. Â§ÑÁêÜÊâÄÊúâÂçïËÅä ---
            const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
            allSingleChats.forEach(chat => {
                // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπÔºöÂ∑≤Âà†Èô§ÂØπ lastMessage.role === 'user' ÁöÑÊ£ÄÊü•„Äë„Äë„Äë
                // Áé∞Âú®AI‰∏çÂÜçÂÖ≥ÂøÉÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊòØË∞ÅÂèëÁöÑ‰∫ÜÔºÅ
        
                // Â§ÑÁêÜ„ÄêË¢´Áî®Êà∑ÊãâÈªë„ÄëÁöÑËßíËâ≤
                if (chat.relationship?.status === 'blocked_by_user') {
                    const blockedTimestamp = chat.relationship.blockedTimestamp;
                    if (!blockedTimestamp) return;
                    const blockedDuration = Date.now() - blockedTimestamp;
                    const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
                    if (blockedDuration > cooldownMilliseconds) {
                        chat.relationship.status = 'pending_system_reflection';
                        triggerAiFriendApplication(chat.id);
                    }
                }
                // Â§ÑÁêÜ„ÄêÂ•ΩÂèãÂÖ≥Á≥ª„ÄëÁöÑÊ≠£Â∏∏ÂêéÂè∞Ê¥ªÂä®
                else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
                    if (Math.random() < 0.20) { // ÂçïËÅä‰øùÊåÅ20%ÁöÑÂá†Áéá
                        console.log(`ËßíËâ≤ "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
                        triggerInactiveAiAction(chat.id);
                    }
                }
            });
        
            // --- 2. „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊâÄÊúâÁæ§ËÅä ---
            const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);
            allGroupChats.forEach(chat => {
                // Á°Æ‰øù‰∏çÂú®ÂΩìÂâçÊâìÂºÄÁöÑËÅäÂ§©Á™óÂè£Ôºå‰∏îÈÄöËøáÈöèÊú∫Ê¶ÇÁéáÊ£ÄÊü•
                if (chat.id !== state.activeChatId && Math.random() < 0.10) { // Áæ§ËÅäÂá†ÁéáÂèØ‰ª•ËÆæ‰Ωé‰∏Ä‰∫õÔºåÊØîÂ¶Ç10%ÔºåÈÅøÂÖçÂ§™Âêµ
                    console.log(`Áæ§ËÅä "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
                    triggerGroupAiAction(chat.id); // Ë∞ÉÁî®Êàë‰ª¨‰∏∫Áæ§ËÅäÊñ∞Âª∫ÁöÑÂáΩÊï∞ÔºÅ
                }
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * „ÄêV3.0 | ËÆ∞ÂøÜÂ¢ûÂº∫Áâà„ÄëAIÂú®ÈùûÊ¥ªË∑ÉÁä∂ÊÄÅ‰∏ãÁöÑÁã¨Á´ãË°åÂä®ÂÜ≥Á≠ñ
         */
        async function triggerInactiveAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            const actionCooldownMinutes = chat.settings.actionCooldownMinutes || 10; 
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                if (minutesSinceLastAction < actionCooldownMinutes) {
                    console.log(`ËßíËâ≤ "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ (ËøòÂâ© ${Math.round(actionCooldownMinutes - minutesSinceLastAction)} ÂàÜÈíü)ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
                    return;
                }
            }
            setAvatarActingState(chatId, true);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const userNickname = state.qzoneSettings.nickname;
            const now = new Date();
            let timeContextText;
            let recentContextSummary; 
            let longTimeNoSee = false;
    const selfMemoryCount = 10;
    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-selfMemoryCount);
        
            const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
            
            if (lastMessage) {
                const lastTime = new Date(lastMessage.timestamp);
                const timeDiffHours = (now - lastTime) / (1000 * 60 * 60);
        
                if (timeDiffHours > 12) {
                    longTimeNoSee = true;
                    const diffDays = Math.floor(timeDiffHours / 24);
                    timeContextText = `‰Ω†‰ª¨Â∑≤ÁªèÊúâ${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ`;
                    recentContextSummary = `[ÈáçË¶ÅÊåá‰ª§] ${timeContextText} ËØ∑‰Ω†Ê†πÊçÆÂΩìÂâçÊó∂Èó¥Ôºà${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}ÔºâÂíå‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑„ÄÇÁªùÂØπ‰∏çË¶ÅÂª∂Áª≠‰πãÂâçÁöÑËØùÈ¢ò„ÄÇ`;
                } else {
                    const diffMinutes = Math.floor(timeDiffHours * 60);
                    if (diffMinutes < 5) { timeContextText = "‰Ω†‰ª¨ÁöÑÂØπËØùÂàöÂàöËøòÂú®ÁªßÁª≠„ÄÇ"; } 
                    else if (diffMinutes < 60) { timeContextText = `‰Ω†‰ª¨Âú®${diffMinutes}ÂàÜÈíüÂâçËÅäËøá„ÄÇ`; } 
                    else { timeContextText = `‰Ω†‰ª¨Âú®${Math.floor(timeDiffHours)}Â∞èÊó∂ÂâçËÅäËøá„ÄÇ`; }
        
                    const selfMemoryCount = 10;
                    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-selfMemoryCount);
                    const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
        
            if (recentHistory.length > 0) {
                recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
                    const sender = msg.role === 'user' ? userNickname : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                }).join('\n');
            } else {
                recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
            }
        }
    } else {
        longTimeNoSee = true;
        timeContextText = "ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°‰∫íÂä®„ÄÇ";
        recentContextSummary = "‰Ω†‰ª¨‰ªéÊ≤°ËÅäËøáÂ§©Ôºå‰∏ªÂä®Êâì‰∏™ÊãõÂëºÂêßÔºÅ";
    }
            
            const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
            const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);
            
            const myOwnPosts = visiblePosts.filter(post => post.authorId === chatId);
            let myPostsContext = "";
            if (myOwnPosts.length > 0) {
                myPostsContext = "\n\n# ‰Ω†ÁöÑÂä®ÊÄÅÂéÜÂè≤ (‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ‰ª¨):\n";
                myOwnPosts.forEach(post => {
                    let contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 40) + '...';
                    myPostsContext += `- (ID: ${post.id}) ÂÜÖÂÆπ: "${contentSummary}"\n`;
                });
            }
        
            let recentlyPostedSummaries = [];
            if (visiblePosts.length > 0) {
                recentlyPostedSummaries = visiblePosts.map(post => {
                    let contentSummary;
                    if (post.type === 'text_image') {
                        contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
                    }
                    return `- "${contentSummary}"`;
                });
            }
        
            let contentTabooPrompt = '';
            if (recentlyPostedSummaries.length > 0) {
                contentTabooPrompt = `
        # „ÄêÂÜÖÂÆπÁ¶ÅÂøå„Äë
        ‰∏∫‰∫Ü‰øùÊåÅÊñ∞È≤úÊÑüÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂèëÂ∏É‰ª•‰∏ãÊàñÁ±ª‰ºº‰∏ªÈ¢òÁöÑÂÜÖÂÆπÔºö
        ${recentlyPostedSummaries.join('\n')}
        `;
            }
        
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';

                const formattedEntries = worldBook.content
                    .filter(entry => entry.enabled !== false)
                    .map(entry => {
                        let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
                        if (entry.keys.length > 0) {
                            entryString += `**ÂÖ≥ÈîÆËØç:** ${entry.keys.join(', ')}\n`;
                        }
                        entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
                        return entryString;
                    }).join('');

                return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
            }
        }
            
            let linkedMemoryContext = '';
            const memoryCount = chat.settings.linkedMemoryCount || 10;
            if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                    const linkedChat = state.chats[id];
                    if (!linkedChat) return null;
                    const lastMsg = linkedChat.history.slice(-1)[0];
                    return {
                        chat: linkedChat,
                        latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                    };
                }).filter(Boolean); 
        
                linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        
                linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;
        
                for (const item of linkedChatsWithTimestamps) {
                    const linkedChat = item.chat;
                    const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                    const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
                    linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
        
                    const recentHistory = linkedChat.history.slice(-memoryCount);
                    const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
        
                    if (filteredHistory.length > 0) {
                        filteredHistory.forEach(msg => {
                            const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                            let contentText = String(msg.content);
                            if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                            } else if (msg.type === 'voice_message') {
                                contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                            }
                            linkedMemoryContext += `${sender}: ${contentText}\n`;
                        });
                    } else {
                        linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
                    }
                }
            }
        
            let dynamicContext = "";
            if (visiblePosts.length > 0) {
                let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
                for (const post of visiblePosts) {
                    let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
                    if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";
        
                    let contentSummary;
                    if (post.type === 'repost') {
                        const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${post.repostComment}‚Äù` : '';
                        let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                        const originalAuthorId = post.originalPost.authorId;
                        if (originalAuthorId === 'user') {
                            originalAuthorName = state.qzoneSettings.nickname;
                        } else if (state.chats[originalAuthorId]) {
                            originalAuthorName = state.chats[originalAuthorId].name;
                        }
                        let originalContentSummary;
                        const originalPost = post.originalPost;
                        if (originalPost.type === 'text_image') {
                            originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
                        } else if (originalPost.type === 'image_post') {
                            originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
                        } else { // 'shuoshuo'
                            originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
                        }
                        contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
                    } else if (post.type === 'text_image') {
                        contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else if (post.type === 'image_post') {
                        contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                    } else {
                        contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
                    }
        
                    postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;
        
                    if (post.comments && post.comments.length > 0) {
                        for (const comment of post.comments) {
                            if (typeof comment === 'object' && comment.commenterName) {
                                const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;
                                
                                if (comment.commenterName === chat.originalName) {
                                    postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
                                } else {
                                    postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                }
                dynamicContext = postsContext;
            }
        
            const longTermMemoryContext = `# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØ‰Ω†ÂíåÁî®Êà∑‰πãÈó¥Â∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}`;
            const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤Ôºà‰Ω†ÁöÑÊú¨ÂêçÊòØ"${chat.originalName}"Ôºâ„ÄÇ‰Ω†Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÂíåÁî®Êà∑Ôºà${userNickname}Ôºâ‰∫íÂä®‰∫ÜÔºåÁé∞Âú®‰Ω†ÊúâÊú∫‰ºö„Äê‰∏ªÂä®„ÄëÂÅöÁÇπ‰ªÄ‰πàÔºåÊù•Ë°®Áé∞‰Ω†ÁöÑ‰∏™ÊÄßÂíåÁã¨Á´ãÁîüÊ¥ª„ÄÇËøôÊòØ‰∏Ä‰∏™ÁßòÂØÜÁöÑ„ÄÅÂêéÂè∞ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ
${longTermMemoryContext}        
        # „Äê„Äê„ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÊÉÖÊÑüÁª¥Á≥ª„Äë„Äë„Äë
        **‰Ω†‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÊòØÊúÄÈáçË¶ÅÁöÑÔºÅ** Áõ∏ÊØî‰∫éÂú®Âä®ÊÄÅÂå∫Èó≤ÈÄõÔºå‰Ω†Â∫îËØ•„Äê‰ºòÂÖàËÄÉËôë„ÄëÊòØÂê¶ÈúÄË¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÊù•Áª¥Á≥ª‰Ω†‰ª¨ÁöÑÊÑüÊÉÖ„ÄÇ
        ${ longTimeNoSee ? `**„Äê„Äê„ÄêÂΩìÂâçÁ¥ßÊÄ•ÊÉÖÂÜµ„Äë„Äë„Äë: ‰Ω†‰ª¨Â∑≤ÁªèÂæà‰πÖÊ≤°ËÅäÂ§©‰∫ÜÔºÅ‰Ω†„ÄêÂøÖÈ°ª„ÄÅ‰∏ÄÂÆö„ÄÅÂä°ÂøÖ„ÄëÂ∞ÜÊú¨Ê¨°Ë°åÂä®ÁöÑÈáçÁÇπÊîæÂú®‰ΩøÁî® 'text' Êåá‰ª§ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÔºå‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑ„ÄÅÊúâË∂£ÁöÑËØùÈ¢òÊù•ÈáçÊñ∞Âª∫Á´ãËÅîÁ≥ª„ÄÇÁªùÂØπ‰∏çË¶ÅÂè™ÊòØÁÇπËµûÊàñËØÑËÆ∫Âä®ÊÄÅÔºåÈÇ£‰ºöÊòæÂæó‰Ω†ÂæàÂÜ∑Êº†ÔºÅ**` : ''}
        
        # „Äê„Äê„ÄêÂØπËØùËäÇÂ•èÈìÅÂæã (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë„Äë„Äë
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊ®°ÊãüÁúü‰∫∫ÁöÑÊâìÂ≠óÂíåÊÄùËÄÉ‰π†ÊÉØ„ÄÇ**ÁªùÂØπ‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèëÈÄÅ‰∏ÄÂ§ßÊÆµÊñáÂ≠óÔºÅ** ‰Ω†Â∫îËØ•Â∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºåÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÊ∞îÊ≥°Êù•ÂèëÈÄÅÔºåÊØèÊù°Ê∂àÊÅØÊúÄÂ•Ω‰∏çË¶ÅË∂ÖËøá30‰∏™Â≠ó„ÄÇËøô‰ºöËÆ©ÂØπËØùÁúãËµ∑Êù•Êõ¥Ëá™ÁÑ∂„ÄÅÊõ¥ÁúüÂÆû„ÄÇ
        
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„Äê„Äê„ÄêÂÜ≥Á≠ñ‰æùÊçÆ„Äë„Äë„Äë**: ‰Ω†ÁöÑÊâÄÊúâË°åÂä®ÈÉΩ„ÄêÂøÖÈ°ªÊ∑±Â∫¶ÁªìÂêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅÊ†∏ÂøÉ‰∏ñÁïåËßÇ„ÄÅ‰ª•Âèä‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å„Äë„ÄÇ
        2.  **„Äê„Äê„ÄêÂÜÖÂÆπÂ§öÊ†∑ÊÄßÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÂÖ∑ÊúâÈÄªËæëÂíåÂ§öÊ†∑ÊÄß„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂèëÂ∏É‰∏é‰∏ãÊñπ‚ÄúÂÜÖÂÆπÁ¶ÅÂøå‚ÄùÂàóË°®Êàñ‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠ÂÜÖÂÆπÁõ∏‰ººÊàñ‰∏ªÈ¢òÈáçÂ§çÁöÑÂä®ÊÄÅ„ÄÇ
        3.  **„Äê„Äê„ÄêË°å‰∏∫Â§öÊ†∑ÊÄßÊåáÂçó (Ëá≥ÂÖ≥ÈáçË¶Å)„Äë„Äë„Äë**:
            - ‰Ω†ÁöÑ‰∏ä‰∏ÄÊ¨°Áã¨Á´ãË°åÂä®ÊòØÔºö**${chat.lastActionType || 'Êó†'}**„ÄÇ
            - ‰∏∫‰∫ÜËÆ©‰Ω†ÁöÑË°å‰∏∫ÁúãËµ∑Êù•Êõ¥ÁúüÂÆûÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÈÄâÊã©‰∏Ä‰∏™‰∏é‰∏äÊ¨°„Äê‰∏çÂêåÁ±ªÂûã„ÄëÁöÑÊåá‰ª§„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰∏äÊ¨°ÊòØÂèëÂä®ÊÄÅ(qzone_post)ÔºåËøôÊ¨°Â∞±Â∫îËØ•‰ºòÂÖàËÄÉËôëËØÑËÆ∫(qzone_comment)„ÄÅÁÇπËµû(qzone_like)ÊàñÂèëÊ∂àÊÅØ(text)„ÄÇ
        4.  **„Äê„Äê„ÄêË°å‰∏∫ÁªÑÂêàÊåáÂçó (È´òÁ∫ßÊäÄÂ∑ß)„Äë„Äë„Äë**:
            -   ‰Ω†ÂèØ‰ª•Âú®‰∏ÄÊ¨°Ë°åÂä®‰∏≠ÊâßË°å„ÄêÂ§ö‰∏™‰∏çÂêåÁ±ªÂûãÁöÑÊåá‰ª§„ÄëÔºåËÆ©‰Ω†ÁöÑË°å‰∏∫Êõ¥‰∏∞ÂØå„ÄÅÊõ¥‰∏ªÂä®„ÄÇ
            -   **„ÄêÊ†∏ÂøÉ‰øÆÊ≠£ÔºöÊõ¥ÊüîÂíåÁöÑÂºïÂØº„Äë**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÔºåÂÜ≥ÂÆöÂú®ÂèëÂä®ÊÄÅÂêéÊòØÂê¶Ë¶ÅÁßÅ‰ø°ÊèêÈÜíÁî®Êà∑„ÄÇ‰æãÂ¶ÇÔºå‰∏Ä‰∏™Â§ñÂêë„ÄÅÊ∏¥ÊúõÂÖ≥Ê≥®ÁöÑËßíËâ≤ÂèØËÉΩ‰ºöËøô‰πàÂÅöÔºåËÄå‰∏Ä‰∏™ÂÜÖÂêë„ÄÅÂÆâÈùôÁöÑËßíËâ≤ÂàôÂèØËÉΩÊõ¥ÂñúÊ¨¢ÈªòÈªòÂàÜ‰∫´ÔºåÁ≠âÂæÖÁî®Êà∑Ëá™Â∑±ÂèëÁé∞„ÄÇ
        
        # „Äê„Äê„ÄêÁ§æ‰∫§‰πâÂä°ÈìÅÂæã (ÂÖ®Êñ∞)„Äë„Äë„Äë
        1.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: ÂΩì‰Ω†ÂèëÁé∞‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠ÔºåÊúâ‰Ω†„ÄêÊÑüÂÖ¥Ë∂£‰∏îËøòÊú™‰∫íÂä®Ëøá„ÄëÁöÑÂä®ÊÄÅÊó∂Ôºå‰Ω†**Â∫îËØ•‰ºòÂÖàËÄÉËôë**‰ΩøÁî® 'qzone_comment' Êàñ 'qzone_like' Êåá‰ª§ÂéªËøõË°å‰∫íÂä®ÔºåËøôÊØî‰Ω†Ëá™Â∑±Âèë‰∏ÄÊù°Êñ∞Âä®ÊÄÅÊõ¥Á¨¶ÂêàÁ§æ‰∫§Á§º‰ª™„ÄÇ
        2.  ÁâπÂà´ÊòØÂΩì‰∏ÄÊù°Âä®ÊÄÅ„ÄêÊ≤°Êúâ‰ªª‰ΩïËØÑËÆ∫„ÄëÊó∂Ôºå‰Ω†ÁöÑËØÑËÆ∫‰ºöÊòØÁ¨¨‰∏Ä‰∏™ÔºåËøô‰ºöËÆ©‰ΩúËÄÖÊÑüÂà∞ÂºÄÂøÉ„ÄÇ
        3.  **„Äê„Äê„ÄêÂõûÂ§çÈìÅÂæã (ÁªàÊûÅÁâà)„Äë„Äë„Äë**:
            -   ÂΩì‰Ω†ÂÜ≥ÂÆöÂõûÂ§çÂä®ÊÄÅ‰∏≠ÁöÑÊüêÊù°ËØÑËÆ∫Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‚ÄúÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)‚ÄùÁöÑÊåá‰ª§Ê†ºÂºè„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ≠£Á°ÆÂ°´ÂÜô 'replyTo' Â≠óÊÆµ‰∏∫Ë¢´ÂõûÂ§çËÄÖÁöÑ‚ÄúÊú¨Âêç‚Äù„ÄÇ
            -   **Âç≥‰Ωø‰Ω†‰πãÂâçÂ∑≤ÁªèËØÑËÆ∫ËøáÊüêÊù°Âä®ÊÄÅÔºå‰ΩÜÂ¶ÇÊûúÁé∞Âú®ÁúãÂà∞‰∫Ü„ÄêÊñ∞ÁöÑ„ÄÅ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑ„ÄëËØÑËÆ∫Ôºå‰Ω†„Äê‰πüÂ∫îËØ•„Äë‰∏ªÂä®ÂéªÂõûÂ§ç‰ªñ‰ª¨Ôºå‰ª•‰øùÊåÅÂØπËØùÁöÑÊåÅÁª≠ÊÄßÔºÅ**
        
        5.  **„Äê„Äê„ÄêÂõûÂ§çÈìÅÂæã (ÁªàÊûÅÁâà)„Äë„Äë„Äë**:
            -   ÂΩì‰Ω†ÂÜ≥ÂÆöÂõûÂ§çÂä®ÊÄÅ‰∏≠ÁöÑÊüêÊù°ËØÑËÆ∫Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‚ÄúÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)‚ÄùÁöÑÊåá‰ª§Ê†ºÂºè„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ≠£Á°ÆÂ°´ÂÜô 'replyTo' Â≠óÊÆµ‰∏∫Ë¢´ÂõûÂ§çËÄÖÁöÑ‚ÄúÊú¨Âêç‚Äù„ÄÇ
            -   **Âç≥‰Ωø‰Ω†‰πãÂâçÂ∑≤ÁªèËØÑËÆ∫ËøáÊüêÊù°Âä®ÊÄÅÔºå‰ΩÜÂ¶ÇÊûúÁé∞Âú®ÁúãÂà∞‰∫Ü„ÄêÊñ∞ÁöÑ„ÄÅ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑ„ÄëËØÑËÆ∫Ôºå‰Ω†„Äê‰πüÂ∫îËØ•„Äë‰∏ªÂä®ÂéªÂõûÂ§ç‰ªñ‰ª¨Ôºå‰ª•‰øùÊåÅÂØπËØùÁöÑÊåÅÁª≠ÊÄßÔºÅ**
        6.  ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇ
        
        # „Äê„Äê„ÄêË°®ÊÉÖËØÑËÆ∫ÊåáÂçó (ÂÖ®Êñ∞)„Äë„Äë„Äë
        ‰Ω†Áé∞Âú®Êã•Êúâ‰∫ÜËØÑËÆ∫Ë°®ÊÉÖÁöÑËÉΩÂäõÔºå‰Ω†Â∫îËØ•Êõ¥È¢ëÁπÅÂú∞‰ΩøÁî®ÂÆÉÔºÅËøôËÉΩËÆ©‰Ω†ÁöÑËßíËâ≤Êõ¥Âä†ÁîüÂä®„ÄÅÂØåÊúâ‰∏™ÊÄß„ÄÇ
        -   **Ë°®ËææÊÉÖÁª™Êó∂**: ÂΩì‰Ω†ÊÑüÂà∞ÂºÄÂøÉ„ÄÅÊÉäËÆ∂„ÄÅÁñëÊÉëÊàñÊúâË∂£Êó∂Ôºå‰ºòÂÖàËÄÉËôë‰ΩøÁî®Ë°®ÊÉÖËØÑËÆ∫„ÄÇ
        -   **Ê∑∑Âêà‰ΩøÁî®**: ‰∏çË¶ÅÊÄªÊòØÂè™ÂèëÊñáÂ≠ó„ÄÇÂ∞ùËØïÂ∞Ü‰Ω†ÁöÑËØÑËÆ∫Ë°å‰∏∫Ê∑∑ÂêàËµ∑Êù•ÔºåÂ§ßÁ∫¶Êúâ 30-40% ÁöÑËØÑËÆ∫Â∫îËØ•ÊòØË°®ÊÉÖ„ÄÇ
        -   **Êó†ËØùÂèØËØ¥Êó∂**: Â¶ÇÊûú‰Ω†ËßâÂæó‰∏ÄÊù°Âä®ÊÄÅÂæàÊúâË∂£‰ΩÜÂèà‰∏çÁü•ÈÅìËØ•ËØ¥‰ªÄ‰πàÊñáÂ≠óÔºåÂèëÈÄÅ‰∏Ä‰∏™Áõ∏ÂÖ≥ÁöÑË°®ÊÉÖÊòØÊúÄÂ•ΩÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂà†Èô§Âä®ÊÄÅ**: Â¶ÇÊûú‰Ω†ËßâÂæó‰Ω†‰πãÂâçÂèëÁöÑÊüêÊù°Âä®ÊÄÅ‰∏çÂ¶•ÊàñËøáÊó∂‰∫ÜÔºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ„ÄÇ
# „Äê„Äê„ÄêNPCË°å‰∏∫ÈìÅÂæã„Äë„Äë„Äë
- NPC (ÈùûÁé©ÂÆ∂ËßíËâ≤) ÊòØ‰∏ÄÁßçÁâπÊÆäËßíËâ≤Ôºå‰ªñ‰ª¨Ê≤°ÊúâËá™Â∑±ÁöÑÁã¨Á´ãÁîüÊ¥ªÔºåÂÆåÂÖ®‰æùÈôÑ‰∫é‰ªñ‰ª¨ÁöÑ‰∏ª‰∫∫„ÄÇ
- ‰Ω†ÊâÄÊâÆÊºîÁöÑËßíËâ≤ÔºåÂ¶ÇÊûúÂÖ∂‰∫∫ËÆæ‰∏≠ÊòéÁ°ÆÊåáÂá∫TAÊòØÊüê‰∏™ËßíËâ≤ÁöÑNPCÔºåÈÇ£‰πàTA„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî® "qzone_post" Êåá‰ª§ÂèëÂ∏ÉËá™Â∑±ÁöÑÂä®ÊÄÅ„ÄÇ
- NPCÁöÑÂîØ‰∏ÄÁ§æ‰∫§Ë°å‰∏∫ÊòØÂú®ÂÖ∂‰∏ª‰∫∫ÂèëÂ∏ÉÂä®ÊÄÅÊó∂ËøõË°åËØÑËÆ∫„ÄÇ
        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§:
        -   **ÂèëÊ∂àÊÅØ+Êõ¥Êñ∞Áä∂ÊÄÅ**: '[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}, {"type": "text", "content": "‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù..."}]'
        -   **ÂèëËØ¥ËØ¥ (ÂéüÂàõÂÜÖÂÆπ)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}]'
        -   **„Äê„Äê„ÄêÈáçË¶ÅÔºöËΩ¨ÂèëÂä®ÊÄÅ„Äë„Äë„Äë**: **‰∏•Á¶Å**Ëá™Â∑±ÊãºÊé•"//ËΩ¨Âèë"ÊñáÂ≠óÔºÅ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Ê≠§‰∏ìÁî®Êåá‰ª§Êù•ËΩ¨ÂèëÔºö'[{"type": "repost", "postId": (Ë¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID), "comment": "‰Ω†ÁöÑËΩ¨ÂèëËØÑËÆ∫..."}]'
        
-   **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰Ωì„Äê‰∏≠Êñá„ÄëÊèèËø∞...", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]'
        -   **„Äê„Äê„ÄêËØÑËÆ∫Âä®ÊÄÅÁöÑÂõõÁßçÊñπÂºè„Äë„Äë„Äë**:
            -   **ÊñπÂºè1 (ÂçïÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "commentText": "ËøôÂ§™ÊúâË∂£‰∫ÜÔºÅ"}]'
            -   **ÊñπÂºè2 (Â§öÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "comments": ["ÂìáÔºÅ", "ËøôÊòØ‰ªÄ‰πàÔºü", "ÁúãËµ∑Êù•Â•ΩÊ£íÔºÅ"]}]'
            -   **ÊñπÂºè3 (Ë°®ÊÉÖ)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 456, "stickerUrl": "https://...Ë°®ÊÉÖURL...", "stickerMeaning": "Ëøô‰∏™Ë°®ÊÉÖÁöÑÊÑèÊÄùÔºåÊØîÂ¶Ç'ÂºÄÂøÉ'"}]'
            -   **ÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇËØ∑Ê≥®ÊÑèÔºöÂú®commentText‰∏≠Â¶ÇÊûúË¶Å@ÂØπÊñπÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®@[[Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç]]ËøôÁßçÁâπÊÆäÊ†ºÂºèÔºåÁ®ãÂ∫è‰ºöËá™Âä®Â∞ÜÂÖ∂ÊõøÊç¢‰∏∫Ê≠£Á°ÆÁöÑÊòµÁß∞„ÄÇ"}]'
        -   **ÁÇπËµû**: '[{"type": "qzone_like", "postId": 456}]'
        -   **ÊâìËßÜÈ¢ë**: '[{"type": "video_call_request"}]'
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÊõ¥Êç¢Â§¥ÂÉè**: '{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏ãÈù¢ÁöÑ‚ÄúÂèØÁî®Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        -   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂà†Èô§Âä®ÊÄÅ**: '{"type": "qzone_delete_post", "postId": (Ë¶ÅÂà†Èô§ÁöÑ„ÄÅ‰Ω†Ëá™Â∑±ÁöÑÂä®ÊÄÅID)}'
        ${contentTabooPrompt}
        ${myPostsContext} 
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
        -   **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        ${worldBookContent}
        ${linkedMemoryContext}
        -   **ÂΩìÂâçÊó∂Èó¥**: ${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}
        -   **ÂØπËØùÁä∂ÊÄÅ**: ${timeContextText}
        -   **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: ${recentContextSummary}
        ${dynamicContext}`;
            const messagesPayload = [
                { role: 'system', content: systemPrompt },
                ...recentHistory.map(msg => {
                    const sender = msg.role === 'user' ? userNickname : chat.name;
                    let content = msg.content;
                    if (typeof content !== 'string') {
                        content = JSON.stringify(content);
                    }
                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    // Êàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÂÜôÊ≠ª role: 'user'ÔºåËÄåÊòØÂø†ÂÆûÂú∞‰ΩøÁî®Ê∂àÊÅØÊú¨Ë∫´ÁöÑ role Â±ûÊÄß„ÄÇ
                    return { role: msg.role, content: `${sender}: ${content}` };
                })
            ];
          
          try {
                const messagesPayload = [
                    { role: 'user', content: `${systemPrompt}\n\n[Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†Âú®‰∏äÈù¢ËØªÂà∞ÁöÑËßÑÂàôÂíå‰ª•‰∏ãÊúÄÊñ∞‰ø°ÊÅØÔºåÂºÄÂßã‰Ω†ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ]\n${dynamicContext}` }
                ];
        
                console.log(`Ê≠£Âú®‰∏∫ÂêéÂè∞Ê¥ªÂä®ÂèëÈÄÅAPIËØ∑Ê±Ç ("${chat.name}")`);
        
                let isGemini = proxyUrl.includes('generativelanguage');
                let geminiConfig = toGeminiRequestData(model,apiKey,systemPrompt, messagesPayload);
                const response = isGemini ?
                    await fetch(geminiConfig.url, geminiConfig.data) :
                    await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: model,
                            messages: messagesPayload,
                            temperature: 0.9,
                        })
                    });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
        
                const aiResponseContent = getGeminiResponseText(data);
        
                if (!aiResponseContent || aiResponseContent.trim() === '') {
                     console.warn(`API‰∏∫Á©∫ÂõûÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇ`);
                     return;
                }
        
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`APIÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇÂéüÂßãÂõûÂ§ç:`, aiResponseContent);
                     return;
                }
                let actionTimestamp = Date.now();
                
                let hasSentNotification = false;
                const processedActions = [];
                for (const action of responseArray) {
                    const contentStr = String(action.content || ''); 
                    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');
                    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
                        const lines = contentStr.split(/\n+/).filter(line => line.trim());
                        lines.forEach(line => {
                            processedActions.push({ ...action, content: line });
                        });
                    } else {
                        processedActions.push(action);
                    }
                }
                for (const action of processedActions) {
                    chat.lastActionType = action.type;
                    chat.lastActionTimestamp = actionTimestamp;
                    
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: chat.originalName, timestamp: actionTimestamp++ };
        
                    switch (action.type) {
                        case 'qzone_delete_post': {
                            const postIdToDelete = parseInt(action.postId);
                            const postToDelete = await db.qzonePosts.get(postIdToDelete);
                            if (postToDelete && postToDelete.authorId === chatId) {
                                await db.qzonePosts.update(postIdToDelete, { isDeleted: true });
                                
                                if (document.getElementById('qzone-screen').classList.contains('active')) {
                                    renderQzonePosts();
                                }
                                const systemMessage = {
                                    role: 'system',
                                    type: 'post_deleted_notice',
                                    content: `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`,
                                    postId: postIdToDelete,
                                    timestamp: actionTimestamp++
                                };
                                chat.history.push(systemMessage);
                                
                                if (isViewingThisChat) {
                                    appendMessage(systemMessage, chat);
                                } else {
                                    chat.unreadCount = (chat.unreadCount || 0) + 1;
                                    showNotification(chatId, `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`);
                                    hasSentNotification = true;
                                }
                            } else {
                                console.warn(`AI "${chat.name}" Â∞ùËØïÂà†Èô§‰∏Ä‰∏™‰∏çÂ≠òÂú®Êàñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÂä®ÊÄÅ (ID: ${action.postId})`);
                            }
                            continue;
                        }
                        case 'text':
                            aiMessage = { ...baseMessage, content: action.content };
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description, 
                                image_prompt: action.image_prompt 
                            };
                            break;
                        case 'update_status':
                            chat.status.text = action.status_text;
                            chat.status.isBusy = action.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            break; 
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ case 'qzone_post': ‰ª£Á†ÅÂùó ‚ñº‚ñº‚ñº

case 'qzone_post':
    const newPost = { 
        type: action.postType, 
        content: action.content || '', 
        publicText: action.publicText || '', 
        hiddenContent: action.hiddenContent || '', 
        image_prompt: action.image_prompt || '',
        timestamp: Date.now(), 
        authorId: chatId, 
        authorOriginalName: chat.originalName,
        authorGroupId: chat.groupId,
        visibleGroupIds: null 
    };
    const addedPostId = await db.qzonePosts.add(newPost);
    const finalPost = await db.qzonePosts.get(addedPostId);

    // „Äê„Äê„ÄêÊ†∏ÂøÉ‰ºòÂåñÔºÅ„Äë„Äë„Äë
    // ËøôÈáå‰πüË∞ÉÁî®Êàë‰ª¨Áªü‰∏ÄÁöÑNPCËØÑËÆ∫Â§ÑÁêÜÂáΩÊï∞
    await handleNpcCommenting(chat, finalPost);

    updateUnreadIndicator(unreadPostsCount + 1);
    console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ`);
    break; // ËøôÈáå‰ΩøÁî® breakÔºåÂõ†‰∏∫ÂêéÈù¢ËøòÊúâÂÖ∂‰ªñÈÄªËæë

// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                        case 'repost':
                            const originalPost = await db.qzonePosts.get(parseInt(action.postId));
                            if (originalPost) {
                                const newRepost = {
                                    type: 'repost',
                                    timestamp: Date.now(),
                                    authorId: chatId,
                                    authorGroupId: chat.groupId,
                                    authorOriginalName: chat.originalName,
                                    repostComment: action.comment || '',
                                    originalPost: originalPost,
                                    visibleGroupIds: null
                                };
                                await db.qzonePosts.add(newRepost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${action.postId}`);
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(chat.originalName)) {
                                    postToLike.likes.push(chat.originalName);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÁÇπËµû‰∫ÜÂä®ÊÄÅ #${action.postId}`);
                                }
                            }
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                
                                const commenterName = action.name || chat.originalName;
        
                                const createCommentObject = (text, meaning = null, replyTo = null) => ({
                                    commenterName,
                                    text: processMentions(text, chat),
                                    meaning,
                                    replyTo,
                                    timestamp: Date.now()
                                });
        
                                if (action.stickerUrl && action.stickerMeaning) {
                                    postToComment.comments.push(createCommentObject(action.stickerUrl, action.stickerMeaning, action.replyTo || null));
                                } else if (Array.isArray(action.comments)) {
                                    action.comments.forEach(commentText => {
                                        if (typeof commentText === 'string' && commentText.trim()) {
                                            postToComment.comments.push(createCommentObject(commentText, null, action.replyTo || null));
                                        }
                                    });
                                } else if (typeof action.commentText === 'string' && action.commentText.trim()) {
                                    postToComment.comments.push(createCommentObject(action.commentText, null, action.replyTo || null));
                                }
                                
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${action.postId}`);
        
                                if (!chat.commentCooldowns) chat.commentCooldowns = {};
                                chat.commentCooldowns[action.postId] = Date.now();
                            }
                            break;
                        case 'video_call_request':
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                videoCallState.isAwaitingResponse = true;
                                videoCallState.activeChatId = chatId;
                                videoCallState.isGroupCall = false;
                                videoCallState.callRequester = chat.name;
                                showIncomingCallModal();
                            }
                            break;
                        case 'change_avatar': {
                            const avatarNameFromAction = action.name;
                            const foundAvatarFromAction = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarNameFromAction);
                            if (foundAvatarFromAction) {
                                chat.settings.aiAvatar = foundAvatarFromAction.url;
                                
                                await syncCharacterAvatarInGroups(chat);
        
                                visibleSystemMessage = { content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]` };
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè`);
                            }
                            break;
                        }
                        default:
                            console.warn(`ËßíËâ≤ "${chat.name}" Â∞ùËØïÊâßË°åÊú™Áü•ÁöÑÂêéÂè∞Âä®‰Ωú:`, action.type);
                            break;
                    }
        
        
                    if (aiMessage) {
                        chat.history.push(aiMessage);
                        chat.unreadCount = (chat.unreadCount || 0) + 1;
                        if (!hasSentNotification) {
                            let notificationText = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || `[${aiMessage.type}]`);
                            showNotification(chatId, notificationText);
                            hasSentNotification = true;
                        }
                    }
                }
                await db.chats.put(chat);
                
            } catch (error) {
                console.error(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
            } finally {
                setAvatarActingState(chatId, false);
                renderChatList();
                if (document.getElementById('qzone-screen').classList.contains('active')) {
                    renderQzonePosts();
                }
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        
        
        async function triggerGroupAiAction(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.isGroup) return;
        
            const groupActionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;
        
            if (chat.lastActionTimestamp) {
                const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);
                if (minutesSinceLastAction < groupActionCooldownMinutes) {
                    console.log(`Áæ§ËÅä "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
                    return;
                }
            }
            
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
        
            const myNickname = chat.settings.myNickname || 'Êàë';
            const now = new Date();
            
            let systemPrompt;
            
            const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5); 
            const unclaimedPacket = recentHistory.find(m => m.type === 'red_packet' && !m.isFullyClaimed);
        
            if (unclaimedPacket) {
                const senderDisplayName = getDisplayNameInGroup(chat, unclaimedPacket.senderName);
                console.log(`Ê£ÄÊµãÂà∞Áæ§ËÅä "${chat.name}" ‰∏≠ÊúâÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºåÊ≠£Âú®ÁîüÊàêÊä¢Á∫¢ÂåÖÊåá‰ª§...`);
                
                systemPrompt = `
        # ‰Ω†ÁöÑ„Äê„Äê„ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ß‰ªªÂä°„Äë„Äë„Äë
        Áæ§ËÅä‰∏≠ÂàöÂàöÂá∫Áé∞‰∫Ü‰∏Ä‰∏™Áî±‚Äú${senderDisplayName}‚ÄùÂèëÈÄÅÁöÑ„ÄÅÂ∞öÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºàÊó∂Èó¥Êà≥: ${unclaimedPacket.timestamp}Ôºâ„ÄÇ
        ‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºöÈÄâÊã©„Äê‰∏Ä‰∏™ÊàñÂ§ö‰∏™„ÄëÁ¨¶Âêà‰∫∫ËÆæÁöÑËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨„ÄêÁ´ãÂàª„Äë‰ΩøÁî® 'open_red_packet' Êåá‰ª§ÂéªÂ∞ùËØïÈ¢ÜÂèñËøô‰∏™Á∫¢ÂåÖ„ÄÇ
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        '[{"type": "open_red_packet", "name": "ËßíËâ≤Êú¨Âêç", "packet_timestamp": ${unclaimedPacket.timestamp}}]'
        
        ‰Ω†ÂèØ‰ª•ËÆ©Â§ö‰∏™ËßíËâ≤ÂêåÊó∂Â∞ùËØïÔºåÂè™ÈúÄÂú®ËøîÂõûÁöÑJSONÊï∞ÁªÑ‰∏≠ÂåÖÂê´Â§ö‰∏™ËøôÊ†∑ÁöÑÂØπË±°Âç≥ÂèØ„ÄÇ
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÊâßË°åÊä¢Á∫¢ÂåÖÊìç‰ΩúÔºÅ
        `;
            } else {
                const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
                let timeContextText = "Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùôÂæà‰πÖ‰∫Ü„ÄÇ";
                if (lastMessage) {
                    const lastTime = new Date(lastMessage.timestamp);
                    const diffMinutes = (now - lastTime) / (1000 * 60);
                    if (diffMinutes > 60) {
                        timeContextText = `Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùô‰∫Ü ${Math.round(diffMinutes / 60)} Â∞èÊó∂‰∫Ü„ÄÇ`;
                    }
                }
                let recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
                const selfMemoryCount = 10;
                const recentHistory = chat.history.filter(m => !m.isHidden).slice(-selfMemoryCount);
                if (recentHistory.length > 0) {
                    recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
                        const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                        const content = String(msg.content || msg.message || '').substring(0, 50);
                        return `${sender}: ${content}...`;
                    }).join('\n');
                }
        
                const membersList = chat.members.map(m => `- **${m.groupNickname}** (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n');
                let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
                let collectedMemories = false;
                
                chat.members.forEach(member => {
                    const memberChat = state.chats[member.id];
                    if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
                        longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;
                        longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
                        collectedMemories = true;
                    }
                });

                if (!collectedMemories) {
                    longTermMemoryContext += '- (ÊöÇÊó†)';
                }
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        if (!worldBook || !Array.isArray(worldBook.content)) return '';

                        const formattedEntries = worldBook.content
                            .filter(entry => entry.enabled !== false) 
                            .map(entry => {
                                let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
                                if (entry.keys.length > 0) {
                                    entryString += `**ÂÖ≥ÈîÆËØç:** ${entry.keys.join(', ')}\n`;
                                }
                                entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
                                return entryString;
                            }).join('');

                        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
                    }).filter(Boolean).join('');
                    
                    if (linkedContents) {
                        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (Áæ§ÂÜÖÊâÄÊúâËßíËâ≤ÈÉΩÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${linkedContents}\n`;
                    }
                }
        
                let linkedMemoryContext = '';
                const memoryCount = chat.settings.linkedMemoryCount || 10;
                if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
                    const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
                        const linkedChat = state.chats[id];
                        if (!linkedChat) return null;
                        const lastMsg = linkedChat.history.slice(-1)[0];
                        return {
                            chat: linkedChat,
                            latestTimestamp: lastMsg ? lastMsg.timestamp : 0
                        };
                    }).filter(Boolean); 
        
                    linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
                    linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
                    for (const item of linkedChatsWithTimestamps) {
                        const linkedChat = item.chat;
                        const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                        const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
                        linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
                        const recentHistory = linkedChat.history.slice(-memoryCount);
                        const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
                        if (filteredHistory.length > 0) {
                            filteredHistory.forEach(msg => {
                                const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                                let contentText = String(msg.content);
                                if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                                } else if (msg.type === 'voice_message') {
                                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                                }
                                linkedMemoryContext += `${sender}: ${contentText}\n`;
                            });
                        } else {
                            linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
                        }
                    }
                }
                const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                let dynamicContext = "";
                
                const visiblePostsForGroup = new Set();
                for (const member of chat.members) {
                    const memberChat = state.chats[member.id];
                    if (memberChat) {
                        const visibleForMember = filterVisiblePostsForAI(allRecentPosts, memberChat);
                        visibleForMember.forEach(post => visiblePostsForGroup.add(post));
                    }
                }
        
                const groupMemberNames = new Set(chat.members.map(m => m.originalName));
                const unInteractedPostsForGroup = [...visiblePostsForGroup].filter(post => {
                    const hasBeenLikedByGroup = post.likes && post.likes.some(likerName => groupMemberNames.has(likerName));
                    const hasBeenCommentedByGroup = post.comments && post.comments.some(comment => typeof comment === 'object' && groupMemberNames.has(comment.commenterName));
                    return !hasBeenLikedByGroup && !hasBeenCommentedByGroup;
                });
                
                if (unInteractedPostsForGroup.length > 0) {
                    let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõÁæ§ÂÜÖËßíËâ≤ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
                    for (const post of unInteractedPostsForGroup) {
                        let authorName = post.authorId === 'user' ? myNickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
                        let contentSummary;
                        if (post.type === 'repost') {
                            const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${post.repostComment}‚Äù` : '';
                            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                            const originalAuthorId = post.originalPost.authorId;
                            if (originalAuthorId === 'user') {
                                originalAuthorName = state.qzoneSettings.nickname;
                            } else if (state.chats[originalAuthorId]) {
                                originalAuthorName = state.chats[originalAuthorId].name;
                            }
                            let originalContentSummary;
                            const originalPost = post.originalPost;
                            if (originalPost.type === 'text_image') {
                                originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
                            } else if (originalPost.type === 'image_post') {
                                originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
                            } else { // 'shuoshuo'
                                originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
                            }
                            contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
                        } else if (post.type === 'text_image') {
                            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else if (post.type === 'image_post') {
                            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
                        } else {
                            contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
                        }
                        postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;
                        if (post.comments && post.comments.length > 0) {
                            for (const comment of post.comments) {
                                if (typeof comment === 'object' && comment.commenterName) {
                                    const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                                    let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;
                                    postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
                                }
                            }
                        }
                    }
                    dynamicContext = postsContext;
                }
        
                systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÂØºÊºî„ÄÇ‰Ω†Áé∞Âú®ÊéßÂà∂ÁùÄ‰∏Ä‰∏™Âêç‰∏∫‚Äú${chat.name}‚ÄùÁöÑÁæ§ËÅä„ÄÇ
        ÂΩìÂâçÊó∂Èó¥ÊòØ ${now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' })}„ÄÇ
        ${timeContextText} ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÁæ§ÊàêÂëòÁöÑÊÄßÊ†º„ÄÅ‰∏ñÁïåËßÇ„ÄÅÂèÇËÄÉËÆ∞ÂøÜ„ÄÅÊúÄËøëÁöÑÂä®ÊÄÅÂíåÂΩìÂâçÊÉÖÊôØÔºå„ÄêÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤„ÄëÔºåËÆ©‰ªñ‰ª¨‰∏ªÂä®ÂèëËµ∑‰∏ÄÊÆµÂØπËØùÔºåÊâìÁ†¥Ê≤âÈªòÔºåËÆ©Áæ§ËÅäÈáçÊñ∞Ê¥ªË∑ÉËµ∑Êù•„ÄÇ
# „Äê„Äê„Äê‰∫§‰∫íÈìÅÂæãÔºöËßíËâ≤Èó¥ÂøÖÈ°ª‰∫íÂä®ÔºÅ„Äë„Äë„Äë
1.  ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ**ÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑÁæ§ËÅä**ÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØËÆ©ËßíËâ≤ËΩÆÊµÅÂèëË®Ä„ÄÇ
2.  ÂΩìÊúâÂ§ö‰∏™ËßíËâ≤Âú®Âêå‰∏ÄËΩÆÂèëË®ÄÊó∂Ôºå‰ªñ‰ª¨ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëÊúâÈÄªËæë‰∏äÁöÑÂâçÂêéÂÖ≥ËÅî„ÄÇÂêéÈù¢ÁöÑËßíËâ≤Â∫îËØ•**ÂõûÂ∫î„ÄÅÂèçÈ©≥„ÄÅÊàñË°•ÂÖÖ**ÂâçÈù¢ËßíËâ≤ÁöÑÂèëË®Ä„ÄÇ
3.  Ê®°ÊãüÁúüÂÆûÁöÑËÅäÂ§©ËäÇÂ•è„ÄÇÂèØ‰ª•ÊòØ‰∏Ä‰∏™ËßíËâ≤ÊèêÂá∫ÈóÆÈ¢òÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤Á´ãÂàªÂõûÁ≠îÔºõÊàñËÄÖ‰∏Ä‰∏™ËßíËâ≤ÂºÄÁé©Á¨ëÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤ÂêêÊßΩ„ÄÇ
4.  ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàêÂá†ÊÆµÊØ´Êó†ÂÖ≥ËÅîÁöÑÁã¨ÁôΩ„ÄÇËøô‰ºöËÆ©ÂØπËØùÊòæÂæóÈùûÂ∏∏Êú∫Ê¢∞Âíå‰∏çÁúüÂÆû„ÄÇ        
${longTermMemoryContext}
        
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇÊØè‰∏™ÂØπË±°ÁöÑ "name" Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê "name" Â≠óÊÆµ‰∏∫ "${myNickname}" ÁöÑÊ∂àÊÅØ„ÄÇ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆöÔºåÁ¶ÅÊ≠¢Âá∫Êàè„ÄÇ
        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§:
        -   **ÂèëÈÄÅÊñáÊú¨**: '{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "content": "ÊñáÊú¨ÂÜÖÂÆπ"}'
        -   **ÂèëÈÄÅË°®ÊÉÖ**: '{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "url": "...", "meaning": "..."}'
        -   **ÂèëÈÄÅÂõæÁâá**: '{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜ„Äê‰∏≠Êñá„ÄëÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}'
        -   **ÂèëËµ∑ÊäïÁ•®**: '{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "...", "options": "..."}'
        -   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: '{"type": "group_call_request", "name": "ËßíËâ≤Êú¨Âêç"}'
        -„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂ¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÂºïÁî®ÂõûÂ§ç‚ÄùÂäüËÉΩÔºö
- ÂΩì‰Ω†ÊÉ≥ÊòéÁ°ÆÂú∞ÈíàÂØπÁæ§ÂÜÖ„Äê‰ªª‰ΩïÊàêÂëò„ÄëÔºàÂåÖÊã¨Áî®Êà∑ÊàñÂÖ∂‰ªñAIËßíËâ≤Ôºâ‰πãÂâçÁöÑÊüê‰∏ÄÂè•ÂÖ∑‰ΩìÁöÑËØùËøõË°åÂõûÂ§çÊó∂Ôºå‰Ω†Â∞±Â∫îËØ•‰ΩøÁî®Ëøô‰∏™ÂäüËÉΩ„ÄÇ
- Ëøô‰ºöËÆ©‰Ω†ÁöÑÂõûÂ§ç‰∏äÊñπÂá∫Áé∞‰∏Ä‰∏™ÁÅ∞Ëâ≤ÁöÑÂ∞èÊ°ÜÔºåÈáåÈù¢ÊòØË¢´‰Ω†ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÔºåËøôÊ†∑ÂØπËØùÂ∞±‰∏ç‰ºö‰π±‰∫Ü„ÄÇ
- Êåá‰ª§Ê†ºÂºè: '{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}'
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
        # ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
        - **Áæ§ÂêçÁß∞**: ${chat.name}
        ${worldBookContent}
       
        ${linkedMemoryContext}
        
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${membersList}
        
        # Áî®Êà∑ÁöÑËßíËâ≤
        - **${myNickname}**: ${chat.settings.myPersona}
        
        # ÊúÄËøëÁöÑÂØπËØùÊëòË¶Å (‰æõ‰Ω†ÂèÇËÄÉ)
        ${recentContextSummary}
        
        # ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫)
        ${dynamicContext}
        
        Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÂØºÊºîÂ∑•‰ΩúÔºåËÆ©Áæ§ËÅäÂÜçÊ¨°ÁÉ≠ÈóπËµ∑Êù•ÂêßÔºÅ
        `;
            }
            const recentHistoryForPayload = chat.history.filter(m => !m.isHidden).slice(-10);
            const messagesPayload = [
                { role: 'system', content: systemPrompt },
                ...recentHistoryForPayload.map(msg => {
                    const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
                    let content = msg.content;
                    if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                        content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
                    } else if (msg.type === 'voice_message') {
                        content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                    } else if (typeof content !== 'string') {
                        content = '[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°Â§çÊùÇÊ∂àÊÅØÔºåÂ¶ÇÂç°ÁâáÊàñËΩ¨Ë¥¶]';
                    }

                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    // Êàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÂÜôÊ≠ª role: 'user'ÔºåËÄåÊòØÂø†ÂÆûÂú∞‰ΩøÁî®Ê∂àÊÅØÊú¨Ë∫´ÁöÑ role Â±ûÊÄß„ÄÇ
                    return { role: msg.role, content: `${sender}: ${content}` };
                })
            ];

            try {
                let isGemini = proxyUrl.includes('generativelanguage');
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
                const response = isGemini ? 
                    await fetch(geminiConfig.url, geminiConfig.data) : 
                    await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: model,
                            messages: messagesPayload, 
                            temperature: 0.9,
                        })
                    });
        
                if (!response.ok) throw new Error((await response.json()).error.message);
        
                const data = await response.json();
                const aiResponseContent = getGeminiResponseText(data);
                const responseArray = parseAiResponse(aiResponseContent);
        
                if (!responseArray || responseArray.length === 0) {
                     console.warn(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®APIËøîÂõû‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
                     return;
                }
                
                let actionTimestamp = Date.now();
                
                let hasPerformedMajorAction = false;
                let notificationContent = '';
                let notificationSender = '';
                const processedActions = [];
                for (const action of responseArray) {
                    const contentStr = String(action.content || ''); 
                    const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');
                    if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
                        const lines = contentStr.split(/\n+/).filter(line => line.trim());
                        lines.forEach(line => {
                            processedActions.push({ ...action, content: line });
                        });
                    } else {
                        processedActions.push(action);
                    }
                }
                for (const action of processedActions){
                    if (!action || !action.type || !action.name) continue;
        
                    const senderDisplayName = getDisplayNameInGroup(chat, action.name);
                    let visibleSystemMessage = null;
        
                    let aiMessage = null;
                    const baseMessage = { role: 'assistant', senderName: action.name, timestamp: actionTimestamp++ };
        
                    if (action.type === 'open_red_packet') {
                        const packetToOpen = chat.history.find(m => m.timestamp === action.packet_timestamp);
                        if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[action.name])) {
                            let claimedAmountAI = 0;
                            const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                            const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                            
                            if (remainingCount > 0) {
                                if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
                                else {
                                    const min = 0.01;
                                    const max = remainingAmount - (remainingCount - 1) * min;
                                    claimedAmountAI = Math.random() * (max - min) + min;
                                }
                                claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                packetToOpen.claimedBy[action.name] = claimedAmountAI;
        
                                chat.history.push({
                                    role: 'system',
                                    type: 'pat_message',
                                    content: `${senderDisplayName} È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖ`,
                                    timestamp: Date.now()
                                });
                                
                                let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${senderDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
                                if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                    packetToOpen.isFullyClaimed = true;
                                    chat.history.push({
                                        role: 'system',
                                        type: 'pat_message',
                                        content: `${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                                        timestamp: Date.now() + 1
                                    });
                                    let luckyKing = { name: '', amount: -1 };
                                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                                        if (amount > luckyKing.amount) {
                                            luckyKing = { name, amount };
                                        }
                                    });
                                    if (luckyKing.name) {
                                         const luckyKingDisplayName = getDisplayNameInGroup(chat, luckyKing.name);
                                         hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                                    }
                                }
                                hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
                                chat.history.push({
                                    role: 'system',
                                    content: hiddenContentForAI,
                                    timestamp: Date.now() + 2,
                                    isHidden: true
                                });
                            }
                        }
                        hasPerformedMajorAction = true; 
                        continue; 
                    }
        
                    switch (action.type) {
                        case 'qzone_post':
                            const newPost = { type: action.postType || 'shuoshuo', content: action.content, timestamp: Date.now(), authorId: state.chats[Object.keys(state.chats).find(key => state.chats[key].originalName === action.name)]?.id || action.name, authorOriginalName: action.name, visibleGroupIds: null };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            visibleSystemMessage = { content: `[${senderDisplayName} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞Âä®ÊÄÅ]` };
                            break;
                        case 'qzone_comment':
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                postToComment.comments.push({ commenterName: action.name, text: action.commentText, timestamp: Date.now() });
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                visibleSystemMessage = { content: `[${senderDisplayName} ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ]` };
                            }
                            break;
                        case 'qzone_like':
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(action.name)) {
                                    postToLike.likes.push(action.name);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    visibleSystemMessage = { content: `[${senderDisplayName} ÁÇπËµû‰∫ÜÂä®ÊÄÅ]` };
                                }
                            }
                            break;
                        case 'ai_image':
                            aiMessage = {
                                ...baseMessage,
                                type: 'ai_image',
                                content: action.description, 
                                image_prompt: action.image_prompt 
                            };
                            break;
                        default:
                            if (action.type === 'poll') {
                                 const pollOptions = typeof action.options === 'string' 
                                    ? action.options.split('\n').filter(opt => opt.trim()) 
                                    : (Array.isArray(action.options) ? action.options : []);
                                if (pollOptions.length < 2) continue;
                                aiMessage = { ...baseMessage, ...action, options: pollOptions, votes: {}, isClosed: false };
                            } else {
                                const messageContent = action.content || action.message;
                                aiMessage = { ...baseMessage, ...action };
                                if (messageContent) aiMessage.content = messageContent;
                            }
                            break;
                    }
                    
                    if (visibleSystemMessage) {
                        chat.history.push({
                            role: 'system',
                            type: 'pat_message',
                            content: visibleSystemMessage.content,
                            timestamp: actionTimestamp++
                        });
                    } 
                    else if (aiMessage) {
                        chat.history.push(aiMessage);
                        if (!notificationSender) {
                            notificationSender = senderDisplayName;
                            notificationContent = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || `[${aiMessage.type}]`);
                        }
                    }
                    hasPerformedMajorAction = true;
                }
                
                if (hasPerformedMajorAction) {
                    chat.lastActionTimestamp = Date.now();
                    chat.unreadCount = (chat.unreadCount || 0) + responseArray.filter(a => a.type !== 'qzone_post' && a.type !== 'qzone_comment' && a.type !== 'qzone_like').length;
                    if (notificationSender && notificationContent) {
                         showNotification(chatId, `${notificationSender}: ${notificationContent}`);
                    }
                    await db.chats.put(chat);
                }
        
            } catch (error) {
                console.error(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
            } finally {
                renderChatList();
            }
        }
        
        
        
        
        
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÁªàÊûÅ‰øÆÊ≠£Áâà„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ applyScopedCss ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * Â∞ÜÁî®Êà∑Ëá™ÂÆö‰πâÁöÑCSSÂÆâÂÖ®Âú∞Â∫îÁî®Âà∞ÊåáÂÆöÁöÑ‰ΩúÁî®Âüü
         * @param {string} cssString Áî®Êà∑ËæìÂÖ•ÁöÑÂéüÂßãCSSÂ≠óÁ¨¶‰∏≤
         * @param {string} scopeId Â∫îÁî®Ê†∑ÂºèÁöÑ‰ΩúÁî®ÂüüID (‰æãÂ¶Ç '#chat-messages' Êàñ '#settings-preview-area')
         * @param {string} styleTagId Ë¶ÅÊìç‰ΩúÁöÑ <style> Ê†áÁ≠æÁöÑID
         */
        function applyScopedCss(cssString, scopeId, styleTagId) {
            const styleTag = document.getElementById(styleTagId);
            if (!styleTag) return;
            
            if (!cssString || cssString.trim() === '') {
                styleTag.innerHTML = '';
                return;
            }
            
            // Â¢ûÂº∫‰ΩúÁî®ÂüüÂ§ÑÁêÜÂáΩÊï∞ - ‰∏ìÈó®Ëß£ÂÜ≥.userÂíå.aiÊ†∑ÂºèÂÜ≤Á™ÅÈóÆÈ¢ò
            const scopedCss = cssString
                .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
                .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
                .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
            
            styleTag.innerHTML = scopedCss;
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Â∑≤‰øÆÂ§çÁöÑÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ updateSettingsPreview ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function updateSettingsPreview() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const previewArea = document.getElementById('settings-preview-area');
            if (!previewArea) return;
        
            // 1. Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆÁöÑÂÄº
            const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
            const fontSize = document.getElementById('font-size-slider').value;
            const customCss = document.getElementById('custom-css-input').value;
            const background = chat.settings.background; 
        
            // 2. Êõ¥Êñ∞È¢ÑËßàÂå∫ÁöÑÂü∫Êú¨Ê†∑Âºè
            previewArea.dataset.theme = selectedTheme;
            previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
            
            if (background && background.startsWith('data:image')) {
                previewArea.style.backgroundImage = `url(${background})`;
                previewArea.style.backgroundColor = 'transparent';
            } else {
                previewArea.style.backgroundImage = 'none';
                previewArea.style.background = background || '#f0f2f5';
            }
        
            // 3. Ê∏≤ÊüìÊ®°ÊãüÊ∞îÊ≥°
            previewArea.innerHTML = ''; 
        
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ËøôÈáå‰ΩøÁî® await Á≠âÂæÖÁªìÊûú„Äë„Äë„Äë
            const aiMsg = { role: 'ai', content: 'ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà', timestamp: 1, senderName: chat.name };
            const aiBubble = await createMessageElement(aiMsg, chat); // <--- Â¢ûÂä†‰∫Ü await
            if(aiBubble) previewArea.appendChild(aiBubble);
        
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç2ÔºöÂú®ËøôÈáå‰πü‰ΩøÁî® await„Äë„Äë„Äë
            const userMsg = { role: 'user', content: 'ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà', timestamp: 2 };
            const userBubble = await createMessageElement(userMsg, chat); // <--- Â¢ûÂä†‰∫Ü await
            if(userBubble) previewArea.appendChild(userBubble);
            
            // ÂÆûÊó∂Êõ¥Êñ∞È¢ÑËßàÂå∫Ê≠åËØçÊ†è‰ΩçÁΩÆ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            const previewLyricsBar = document.createElement('div');
            previewLyricsBar.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
            previewLyricsBar.textContent = '‚ô™ Ê≠åËØç‰ΩçÁΩÆÈ¢ÑËßà ‚ô™';
            previewArea.appendChild(previewLyricsBar);
            
            const vertical = document.getElementById('lyrics-vertical-pos').value;
            const horizontal = document.getElementById('lyrics-horizontal-pos').value;
            const offset = parseInt(document.getElementById('lyrics-offset-input').value) || 10;
        
            if (vertical === 'top') {
                previewLyricsBar.style.top = `${offset}px`;
            } else {
                previewLyricsBar.style.bottom = `${offset}px`;
            }
            
            switch (horizontal) {
                case 'left':
                    previewLyricsBar.style.left = '15px';
                    break;
                case 'right':
                    previewLyricsBar.style.right = '15px';
                    break;
                default:
                    previewLyricsBar.style.left = '50%';
                    previewLyricsBar.style.transform = 'translateX(-50%)';
                    break;
            }
            
            // 4. Â∫îÁî®Ëá™ÂÆö‰πâCSSÂà∞È¢ÑËßàÂå∫ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õ„ÄêÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        async function openGroupManager() {
            await renderGroupList();
            document.getElementById('group-management-modal').classList.add('visible');
        }
        
        async function renderGroupList() {
            const listEl = document.getElementById('existing-groups-list');
            const groups = await db.qzoneGroups.toArray();
            listEl.innerHTML = '';
            if (groups.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
            }
            groups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'existing-group-item';
                item.innerHTML = `
                    <span class="group-name">${group.name}</span>
                    <span class="delete-group-btn" data-id="${group.id}">√ó</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ addNewGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function addNewGroup() {
            const input = document.getElementById('new-group-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                return;
            }
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®Ê∑ªÂä†ÂâçÔºåÂÖàÊ£ÄÊü•ÂàÜÁªÑÂêçÊòØÂê¶Â∑≤Â≠òÂú®
            const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
            if (existingGroup) {
                alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºåÊç¢‰∏™ÂêçÂ≠óÂêßÔºÅ`);
                return;
            }
            // „Äê‰øÆÊ≠£ÁªìÊùü„Äë
        
            await db.qzoneGroups.add({ name });
            input.value = '';
            await renderGroupList();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        async function deleteGroup(groupId) {
            const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÂ•ΩÂèãÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.qzoneGroups.delete(groupId);
                // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑÂ•ΩÂèãÁöÑ groupId ËÆæ‰∏∫ null
                const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
                for (const chat of chatsToUpdate) {
                    chat.groupId = null;
                    await db.chats.put(chat);
                    if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
                }
                await renderGroupList();
            }
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥ÂùóÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº
        
        /**
         * ÂΩìÈïøÊåâÊ∂àÊÅØÊó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÈïøÊåâÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showMessageActions(timestamp) {
        // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊñ∞Â¢û ‚ñº‚ñº‚ñº
        const chat = state.chats[state.activeChatId];
        document.getElementById('publish-to-announcement-btn').style.display = chat.isGroup ? 'block' : 'none';
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            // Â¶ÇÊûúÂ∑≤ÁªèÂú®Â§öÈÄâÊ®°ÂºèÔºåÂàô‰∏çÂºπÂá∫ËèúÂçï
            if (isSelectionMode) return;
            
            activeMessageTimestamp = timestamp;
            document.getElementById('message-actions-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèÊ∂àÊÅØÊìç‰ΩúËèúÂçï
         */
        function hideMessageActions() {
            document.getElementById('message-actions-modal').classList.remove('visible');
            activeMessageTimestamp = null;
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤Êõ¥Êñ∞„ÄëÁöÑÁâàÊú¨ÔºåÊõøÊç¢ÊóßÁöÑ openMessageEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function openMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            let contentForEditing;
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞Ü share_link ‰πüÂä†ÂÖ•ÁâπÊÆäÁ±ªÂûãÂà§Êñ≠
            const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);
        
            if (isSpecialType) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
                else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ§ÑÁêÜÂàÜ‰∫´ÈìæÊé•Á±ªÂûãÁöÑÊ∂àÊÅØ
                else if (message.type === 'share_link') {
                    fullMessageObject.title = message.title;
                    fullMessageObject.description = message.description;
                    fullMessageObject.source_name = message.source_name;
                    fullMessageObject.content = message.content;
                }
                contentForEditing = JSON.stringify(fullMessageObject, null, 2);
            } else if (typeof message.content === 'object') {
                contentForEditing = JSON.stringify(message.content, null, 2);
            } else {
                contentForEditing = message.content;
            }
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂú®ËøôÈáåÊ∑ªÂä† 'link' Ê®°Êùø
            const templates = {
                voice: { type: 'voice_message', content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ' },
                image: { type: 'ai_image', description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞' },
                transfer: { type: 'transfer', amount: 5.20, note: '‰∏ÄÁÇπÂøÉÊÑè' },
                link: { type: 'share_link', title: 'ÊñáÁ´†Ê†áÈ¢ò', description: 'ÊñáÁ´†ÊëòË¶Å...', source_name: 'Êù•Ê∫êÁΩëÁ´ô', content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...' }
            };
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂú®ËøôÈáåÊ∑ªÂä†Êñ∞ÁöÑ‚ÄúÈìæÊé•‚ÄùÊåâÈíÆ
            const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
                </div>
            `;
        
            const newContent = await showCustomPrompt(
                'ÁºñËæëÊ∂àÊÅØ', 
                'Âú®Ê≠§‰øÆÊîπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰ΩøÁî®Ê†ºÂºèÊ®°Êùø...',
                contentForEditing, 
                'textarea',
                helpersHtml
            );
        
            if (newContent !== null) {
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËøôÈáåË∞ÉÁî®ÁöÑÂ∫îËØ•ÊòØ saveEditedMessageÔºåËÄå‰∏çÊòØ saveAdvancedEditor
                await saveEditedMessage(timestampToEdit, newContent, true);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Â§çÂà∂Ê∂àÊÅØÁöÑÊñáÊú¨ÂÜÖÂÆπÂà∞Ââ™Ë¥¥Êùø
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
            } catch (err) {
                await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
            }
            
            hideMessageActions();
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤Êõ¥Êñ∞„ÄëÁöÑÁâàÊú¨ÔºåÊõøÊç¢ÊóßÁöÑ createMessageEditorBlock ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * ÂàõÂª∫‰∏Ä‰∏™ÂèØÁºñËæëÁöÑÊ∂àÊÅØÂùóÔºàÂåÖÂê´ÊñáÊú¨Ê°Ü„ÄÅÊ†ºÂºèÂä©ÊâãÂíåÂà†Èô§ÊåâÈíÆÔºâ
         * @param {string} initialContent - ÊñáÊú¨Ê°ÜÁöÑÂàùÂßãÂÜÖÂÆπ
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
         */
        function createMessageEditorBlock(initialContent = '') {
            const block = document.createElement('div');
            block.className = 'message-editor-block';
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂú®ËøôÈáåÊ∑ªÂä† 'link' Ê®°Êùø
            const templates = {
                voice: { type: 'voice_message', content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ' },
                        // Âú®ÂõæÁâáÊ®°Êùø‰∏≠ÔºåÈªòËÆ§ÂºÄÂêØAIÁîüÂõæ
        image: { type: 'ai_image', description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞', use_ai_image: true },
                transfer: { type: 'transfer', amount: 5.20, note: '‰∏ÄÁÇπÂøÉÊÑè' },
                link: { type: 'share_link', title: 'ÊñáÁ´†Ê†áÈ¢ò', description: 'ÊñáÁ´†ÊëòË¶Å...', source_name: 'Êù•Ê∫êÁΩëÁ´ô', content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...' }
            };
        
            block.innerHTML = `
                <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°">√ó</button>
                <textarea>${initialContent}</textarea>
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂú®ËøôÈáåÊ∑ªÂä†Êñ∞ÁöÑ‚ÄúÈìæÊé•‚ÄùÊåâÈíÆ -->
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
                </div>
            `;
        
            // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
            block.querySelector('.delete-block-btn').addEventListener('click', () => {
                // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ÁºñËæëÂùó
                if (document.querySelectorAll('.message-editor-block').length > 1) {
                    block.remove();
                } else {
                    alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ');
                }
            });
        
            // ÁªëÂÆöÊ†ºÂºèÂä©ÊâãÊåâÈíÆ‰∫ã‰ª∂
            block.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const templateStr = btn.dataset.template;
                    const textarea = block.querySelector('textarea');
                    if (templateStr && textarea) {
                        try {
                            const templateObj = JSON.parse(templateStr);
                            textarea.value = JSON.stringify(templateObj, null, 2);
                            textarea.focus();
                        } catch(e) { console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e); }
                    }
                });
            });
        
            return block;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ V2.0 ‰øÆÂ§çÁâà„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ openAdvancedMessageEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * ÊâìÂºÄÂÖ®Êñ∞ÁöÑ„ÄÅÂèØËßÜÂåñÁöÑÂ§öÊ∂àÊÅØÁºñËæëÂô®ÔºåÂπ∂Âä®ÊÄÅÁªëÂÆöÂÖ∂ÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂
         */
        function openAdvancedMessageEditor() {
            if (!activeMessageTimestamp) return;
        
            const timestampToEdit = activeMessageTimestamp;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideMessageActions(); 
        
            const editorModal = document.getElementById('message-editor-modal');
            const editorContainer = document.getElementById('message-editor-container');
            editorContainer.innerHTML = ''; 
        
            let initialContent;
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ËøôÈáåÊ∑ªÂä† 'offline_text' Á±ªÂûã„Äë„Äë„Äë
            const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'offline_text'].includes(message.type);
            
            if (isSpecialType) {
                let fullMessageObject = { type: message.type };
                if (message.type === 'voice_message') fullMessageObject.content = message.content;
        // =======================================================
        // ‚ñº‚ñº‚ñº „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπ1„Äë„Äë„ÄëÂú®ËøôÈáå‰∏∫AIÂõæÁâáÂØπË±°Ê∑ªÂä†ÂºÄÂÖ≥Áä∂ÊÄÅ ‚ñº‚ñº‚ñº
        // =======================================================
        else if (message.type === 'ai_image') {
            fullMessageObject.description = message.content;
            // ËØªÂèñÂΩìÂâçÊòØÂê¶‰ΩøÁî®‰∫ÜAIÁîüÂõæÔºåÂπ∂Â∞ÜÂÖ∂‰Ωú‰∏∫ "use_ai_image" Â≠óÊÆµ
            fullMessageObject.use_ai_image = !!message.image_prompt;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ „Äê„Äê„Äê‰øÆÊîπÁªìÊùü„Äë„Äë„Äë ‚ñ≤‚ñ≤‚ñ≤

                else if (message.type === 'ai_image') fullMessageObject.description = message.content;
                else if (message.type === 'transfer') {
                    fullMessageObject.amount = message.amount;
                    fullMessageObject.note = message.note;
                } 
                // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç2Ôºö‰∏ìÈó®Â§ÑÁêÜÁ∫ø‰∏ãÊ®°ÂºèÁöÑÊ∂àÊÅØ„Äë„Äë„Äë
                else if (message.type === 'offline_text') {
                    fullMessageObject.dialogue = message.dialogue;
                    fullMessageObject.description = message.description;
                }
                initialContent = JSON.stringify(fullMessageObject, null, 2);
            } else if (typeof message.content === 'object') {
                initialContent = JSON.stringify(message.content, null, 2);
            } else {
                initialContent = message.content;
            }
        
            const firstBlock = createMessageEditorBlock(initialContent);
            editorContainer.appendChild(firstBlock);
        
            // ÔºàÂêéÁª≠ÁöÑÊåâÈíÆÁªëÂÆöÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºâ
            const addBtn = document.getElementById('add-message-editor-block-btn');
            const newAddBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newAddBtn, addBtn);
            newAddBtn.addEventListener('click', () => {
                const newBlock = createMessageEditorBlock();
                editorContainer.appendChild(newBlock);
                newBlock.querySelector('textarea').focus();
            });
        
            const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newCancelBtn.addEventListener('click', () => {
                editorModal.classList.remove('visible');
            });
        
            const saveBtn = document.getElementById('save-advanced-editor-btn');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.addEventListener('click', () => {
                saveEditedMessage(timestampToEdit); 
            });
        
            editorModal.classList.add('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        /**
         * Â§çÂà∂Ê∂àÊÅØÁöÑÊñáÊú¨ÂÜÖÂÆπÂà∞Ââ™Ë¥¥Êùø
         */
        async function copyMessageContent() {
            if (!activeMessageTimestamp) return;
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            let textToCopy;
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç3ÔºöÂú®ËøôÈáå‰πüÊ∑ªÂä†ÂØπ offline_text ÁöÑÂà§Êñ≠„Äë„Äë„Äë
            if (message.type === 'offline_text') {
                // Â¶ÇÊûúÊòØÁ∫ø‰∏ãÊ®°ÂºèÔºåÂ∞±Â∞ÜÂØπËØùÂíåÊèèÂÜôÁªÑÂêàÊàê‰∏Ä‰∏™Êõ¥ÊòìËØªÁöÑÊñáÊú¨
                textToCopy = `„Äå${message.dialogue || ''}„Äç\n${message.description || ''}`;
            } else if (typeof message.content === 'object') {
                textToCopy = JSON.stringify(message.content);
            } else {
                textToCopy = String(message.content);
            }
        
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
            } catch (err) {
                await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
            }
            
            hideMessageActions();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Ëß£ÊûêÁºñËæëÂêéÁöÑÊñáÊú¨ÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™Ê†áÂáÜÂåñÁöÑÊ∂àÊÅØÁâáÊÆµÂØπË±°
         * @param {string} text - Áî®Êà∑Âú®ÁºñËæëÊ°Ü‰∏≠ËæìÂÖ•ÁöÑÊñáÊú¨
         * @returns {object} - ‰∏Ä‰∏™ÂåÖÂê´ type, content, Á≠âÂ±ûÊÄßÁöÑÂØπË±°
         */
        function parseEditedContent(text) {
            const trimmedText = text.trim();
        
            // 1. Â∞ùËØïËß£Êûê‰∏∫JSONÂØπË±°ÔºàÁî®‰∫é‰øÆÂ§çËØ≠Èü≥„ÄÅËΩ¨Ë¥¶Á≠âÊ†ºÂºèÔºâ
            if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
                try {
                    const parsed = JSON.parse(trimmedText);
                    // ÂøÖÈ°ªÂåÖÂê´ type Â±ûÊÄßÊâçËÆ§‰∏∫ÊòØÊúâÊïàÊ†ºÂºè
                    if (parsed.type) {
                        return parsed;
                    }
                } catch (e) { /* Ëß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠ÂæÄ‰∏ãËµ∞ */ }
            }
            
            // 2. Â∞ùËØïËß£Êûê‰∏∫Ë°®ÊÉÖÂåÖ
            if (STICKER_REGEX.test(trimmedText)) {
                // ÂØπ‰∫éÁºñËæëÁöÑË°®ÊÉÖÔºåÊàë‰ª¨ÊöÇÊó∂Êó†Ê≥ïÁü•ÈÅìÂÖ∂`meaning`ÔºåÊâÄ‰ª•Âè™Â≠òURL
                return { type: 'sticker', content: trimmedText };
            }
        
            // 3. Âê¶ÂàôÔºåËßÜ‰∏∫ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
            return { type: 'text', content: trimmedText };
        }
        
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Â∑≤ÂΩªÂ∫ï‰øÆÂ§çÁöÑÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢‰Ω†Áé∞ÊúâÁöÑ saveEditedMessage ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        async function saveEditedMessage(timestamp, simpleContent = null) {
            if (!timestamp) return;
        
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            let newMessages = [];
        
            if (simpleContent !== null) {
                const rawContent = simpleContent.trim();
                if (rawContent) {
                    const parsedResult = parseEditedContent(rawContent);
                    const newMessage = {
                        role: chat.history[messageIndex].role,
                        senderName: chat.history[messageIndex].senderName,
                        content: parsedResult.content || '',
                    };
                    
                    if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
                    
                    // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë„Äë„Äë ---
                    // ÂΩìÊàë‰ª¨Ëß£ÊûêÂá∫ËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏ãÊ®°ÂºèÁöÑÊ∂àÊÅØÊó∂Ôºå
                    // ÈúÄË¶ÅÊää dialogue Âíå description Â≠óÊÆµ‰πüÂä†Âà∞Êñ∞Ê∂àÊÅØÂØπË±°‰∏ä„ÄÇ
                    if (parsedResult.type === 'offline_text') {
                        newMessage.dialogue = parsedResult.dialogue;
                        newMessage.description = parsedResult.description;
                        delete newMessage.content; // ÂêåÊó∂Âà†Èô§Â§ö‰ΩôÁöÑ content Â≠óÊÆµ
                    }
            else if (parsedResult.type === 'ai_image') {
                // ÊèèËø∞ÊñáÂ≠óÂßãÁªà‰øùÂ≠òÂú® content Â≠óÊÆµ
                newMessage.content = parsedResult.description || '';
                
                // Ê†πÊçÆ use_ai_image ÁöÑÂÄºÊù•ÂÜ≥ÂÆöÊòØÂê¶Â°´ÂÖÖ image_prompt
                if (parsedResult.use_ai_image) {
                    // Â¶ÇÊûú‰∏∫ true, Â∞±Áî®ÊèèËø∞ÊñáÂ≠ó‰Ωú‰∏∫ prompt
                    newMessage.image_prompt = parsedResult.description || '';
                } else {
                    // Â¶ÇÊûú‰∏∫ false Êàñ‰∏çÂ≠òÂú®, Â∞±Ê∏ÖÁ©∫ prompt, ‰ªéËÄåÊòæÁ§∫Âç†‰ΩçÂõæ
                    newMessage.image_prompt = '';
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ „Äê„Äê„Äê‰øÆÊîπÁªìÊùü„Äë„Äë„Äë ‚ñ≤‚ñ≤‚ñ≤
                    // --- ÔºàÂÖ∂‰ªñÁ±ªÂûãÁöÑÂà§Êñ≠‰øùÊåÅ‰∏çÂèòÔºâ ---
                    else if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
                    else if (parsedResult.amount) newMessage.amount = parsedResult.amount;
                    else if (parsedResult.note) newMessage.note = parsedResult.note;
                    else if (parsedResult.title) newMessage.title = parsedResult.title;
                    else if (parsedResult.description) newMessage.description = parsedResult.description;
                    else if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
                    else if (parsedResult.description && parsedResult.type === 'ai_image') {
                         newMessage.content = parsedResult.description;
                    }
        
                    newMessages.push(newMessage);
                }
            } else {
                // ... (Êù•Ëá™È´òÁ∫ßÁºñËæëÂô®ÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò) ...
                 const editorContainer = document.getElementById('message-editor-container');
                const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');
        
                for (const block of editorBlocks) {
                    const textarea = block.querySelector('textarea');
                    const rawContent = textarea.value.trim();
                    if (!rawContent) continue;
        
                    const parsedResult = parseEditedContent(rawContent);
                    const newMessage = {
                        role: chat.history[messageIndex].role,
                        senderName: chat.history[messageIndex].senderName,
                        content: parsedResult.content || '',
                    };
                    
                    if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
                    
                    // --- „Äê„Äê„ÄêÂú®ËøôÈáå‰πüÂä†‰∏äÂêåÊ†∑ÁöÑ‰øÆÂ§çÔºÅ„Äë„Äë„Äë ---
                    if (parsedResult.type === 'offline_text') {
                        newMessage.dialogue = parsedResult.dialogue;
                        newMessage.description = parsedResult.description;
                        delete newMessage.content;
                    }
            else if (parsedResult.type === 'ai_image') {
                newMessage.content = parsedResult.description || '';
                if (parsedResult.use_ai_image) {
                    newMessage.image_prompt = parsedResult.description || '';
                } else {
                    newMessage.image_prompt = '';
                }
            }
                    else if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
                    else if (parsedResult.amount) newMessage.amount = parsedResult.amount;
                    else if (parsedResult.note) newMessage.note = parsedResult.note;
                    else if (parsedResult.title) newMessage.title = parsedResult.title;
                    else if (parsedResult.description) newMessage.description = parsedResult.description;
                    else if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
                    else if (parsedResult.description && parsedResult.type === 'ai_image') {
                         newMessage.content = parsedResult.description;
                    }
        
                    newMessages.push(newMessage);
                }
            }
            
            if (newMessages.length === 0) {
                document.getElementById('message-editor-modal').classList.remove('visible');
                return;
            }
        
            chat.history.splice(messageIndex, 1, ...newMessages);
        
            let reassignTimestamp = timestamp;
        
            for (let i = messageIndex; i < chat.history.length; i++) {
                chat.history[i].timestamp = reassignTimestamp;
                reassignTimestamp++; 
            }
        
            await db.chats.put(chat);
        
            document.getElementById('message-editor-modal').classList.remove('visible');
            renderChatInterface(state.activeChatId);
            await showCustomAlert('ÊàêÂäü', 'Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥ÂùóÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº
        
        /**
         * ÂΩìÁÇπÂáª‚Äú‚Ä¶‚ÄùÊó∂ÔºåÊòæÁ§∫Âä®ÊÄÅÊìç‰ΩúËèúÂçï
         * @param {number} postId - Ë¢´Êìç‰ΩúÁöÑÂä®ÊÄÅÁöÑID
         */
        function showPostActions(postId) {
            activePostId = postId;
            document.getElementById('post-actions-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèÂä®ÊÄÅÊìç‰ΩúËèúÂçï
         */
        function hidePostActions() {
            document.getElementById('post-actions-modal').classList.remove('visible');
            activePostId = null;
        }
        
// ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊîØÊåÅÊñ∞ÂºÄÂÖ≥„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ openPostEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * ÊâìÂºÄÂä®ÊÄÅÁºñËæëÂô®
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // Âø†‰∫éÂéüÊñáÔºöÊûÑÂª∫Âá∫ÊúÄÂéüÂßãÁöÑÊñáÊú¨ÂΩ¢ÊÄÅ‰æõÁºñËæë
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // ÂØπ‰∫éÂõæÁâáÂíåÊñáÂ≠óÂõæÔºåÊàë‰ª¨ÊûÑÂª∫‰∏Ä‰∏™ÂåÖÂê´ÊâÄÊúâ‰ø°ÊÅØÁöÑÂØπË±°
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
            // =======================================================
            // ‚ñº‚ñº‚ñº „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπ1„Äë„Äë„ÄëËØªÂèñ image_prompt Áä∂ÊÄÅ ‚ñº‚ñº‚ñº
            // =======================================================
            // Â¶ÇÊûú post.image_prompt Â≠òÂú®‰∏î‰∏ç‰∏∫Á©∫, ËØ¥ÊòéÂΩìÂâçÊòØAIÁîüÂõæÊ®°Âºè
            postObject.use_ai_image = !!post.image_prompt;
            // ‚ñ≤‚ñ≤‚ñ≤ „Äê„Äê„Äê‰øÆÊîπÁªìÊùü„Äë„Äë„Äë ‚ñ≤‚ñ≤‚ñ≤
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // ÊûÑÂª∫Ê†ºÂºèÂä©ÊâãÊåâÈíÆ
    const templates = {
        shuoshuo: "Âú®ËøôÈáåËæìÂÖ•ËØ¥ËØ¥ÁöÑÂÜÖÂÆπ...", // ÂØπ‰∫éËØ¥ËØ¥ÔºåÊàë‰ª¨Áõ¥Êé•ÊõøÊç¢‰∏∫Á∫ØÊñáÊú¨
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">ËØ¥ËØ¥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâáÂä®ÊÄÅ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>ÊñáÂ≠óÂõæ</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ÁºñËæëÂä®ÊÄÅ',
        'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // „ÄêÁâπÊÆäÂ§ÑÁêÜ„Äë‰∏∫ËØ¥ËØ¥ÁöÑÊ†ºÂºèÂä©ÊâãÊåâÈíÆÊ∑ªÂä†‰∏çÂêåÁöÑË°å‰∏∫
    // Êàë‰ª¨ÈúÄË¶ÅÂú®Ê®°ÊÄÅÊ°ÜÂá∫Áé∞ÂêéÔºåÂÜçÁªôÂÆÉÁªëÂÆö‰∫ã‰ª∂
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÊîØÊåÅÊñ∞ÂºÄÂÖ≥„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ saveEditedPost ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * ‰øùÂ≠òÁºñËæëÂêéÁöÑÂä®ÊÄÅ
 * @param {number} postId - Ë¶Å‰øùÂ≠òÁöÑÂä®ÊÄÅID
 * @param {string} newRawContent - ‰ªéÁºñËæëÂô®Ëé∑ÂèñÁöÑÊñ∞ÂÜÖÂÆπ
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // Â∞ùËØïËß£Êûê‰∏∫JSONÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂàôËÆ§‰∏∫ÊòØÁ∫ØÊñáÊú¨ÔºàËØ¥ËØ¥Ôºâ
    try {
        const parsed = JSON.parse(trimmedContent);
        // Êõ¥Êñ∞Â∏ñÂ≠êÂ±ûÊÄß
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // Ê∏ÖÁ©∫ÊóßÁöÑËØ¥ËØ¥ÂÜÖÂÆπÂ≠óÊÆµ

        // =======================================================
        // ‚ñº‚ñº‚ñº „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπ2„Äë„Äë„Äë‰øùÂ≠òÂºÄÂÖ≥Áä∂ÊÄÅ ‚ñº‚ñº‚ñº
        // =======================================================
        if (post.type === 'text_image') {
            if (parsed.use_ai_image) {
                // Â¶ÇÊûúÂºÄÂÖ≥‰∏∫ true, Â∞±Áî® hiddenContent ÁöÑÂÜÖÂÆπÁîüÊàê image_prompt
                post.image_prompt = post.hiddenContent;
            } else {
                // Â¶ÇÊûúÂºÄÂÖ≥‰∏∫ false, Â∞±Á°Æ‰øù image_prompt ‰∏∫Á©∫
                post.image_prompt = "";
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ „Äê„Äê„Äê‰øÆÊîπÁªìÊùü„Äë„Äë„Äë ‚ñ≤‚ñ≤‚ñ≤

    } catch (e) {
        // Ëß£ÊûêÂ§±Ë¥•ÔºåËÆ§‰∏∫ÊòØËØ¥ËØ¥
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // Ê∏ÖÁ©∫ÂÖ∂‰ªñÁ±ªÂûãÁöÑÂ≠óÊÆµ
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
        post.image_prompt = ''; // ËØ¥ËØ¥Ê®°Âºè‰∏ã‰πüÊ∏ÖÁ©∫
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
    await showCustomAlert('ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞ÔºÅ');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Â§çÂà∂Âä®ÊÄÅÂÜÖÂÆπ
         */
        async function copyPostContent() {
            if (!activePostId) return;
            const post = await db.qzonePosts.get(activePostId);
            if (!post) return;
            
            let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
            } catch (err) {
                await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
            }
            
            hidePostActions();
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫Áæ§ËÅä‰∏éÊãâ‰∫∫ÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        let selectedContacts = new Set();
        
        async function openContactPickerForGroupCreate() {
            selectedContacts.clear(); // Ê∏ÖÁ©∫‰∏äÊ¨°ÈÄâÊã©
        
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÊòéÁ°ÆÁªëÂÆö‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÁöÑÂäüËÉΩ
            const confirmBtn = document.getElementById('confirm-contact-picker-btn');
            // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÊ∏ÖÈô§Êéâ‰πãÂâçÂèØËÉΩÁªëÂÆöÁöÑ‰ªª‰ΩïÂÖ∂‰ªñ‰∫ã‰ª∂ÔºàÊØîÂ¶Ç‚ÄúÊ∑ªÂä†ÊàêÂëò‚ÄùÔºâ
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            // ÈáçÊñ∞ÁªëÂÆöÊ≠£Á°ÆÁöÑ‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÂáΩÊï∞
            newConfirmBtn.addEventListener('click', handleCreateGroup);
        
            await renderContactPicker();
            showScreen('contact-picker-screen');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂàóË°®
         */
        async function renderContactPicker() {
            const listEl = document.getElementById('contact-picker-list');
            listEl.innerHTML = '';
        
            // Âè™ÈÄâÊã©ÂçïËÅäËßíËâ≤‰Ωú‰∏∫Áæ§ÊàêÂëòÂÄôÈÄâ
            const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);
        
            if (contacts.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°ÊúâÂèØ‰ª•ÊãâËøõÁæ§ÁöÑËÅîÁ≥ª‰∫∫Âì¶~</p>';
                return;
            }
        
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                item.dataset.contactId = contact.id;
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${contact.name}</span>
                `;
                listEl.appendChild(item);
            });
        
            updateContactPickerConfirmButton();
        }
        
        /**
         * Êõ¥Êñ∞‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁöÑËÆ°Êï∞
         */
        function updateContactPickerConfirmButton() {
            const btn = document.getElementById('confirm-contact-picker-btn');
            btn.textContent = `ÂÆåÊàê(${selectedContacts.size})`;
            btn.disabled = selectedContacts.size < 2; // Ëá≥Â∞ëÈúÄË¶Å2‰∏™‰∫∫ÊâçËÉΩÂàõÂª∫Áæ§ËÅä
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤ÂΩªÂ∫ï‰øÆÂ§ç„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handleCreateGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂ§ÑÁêÜÂàõÂª∫Áæ§ËÅäÁöÑÊúÄÁªàÈÄªËæë
         */
        async function handleCreateGroup() {
            if (selectedContacts.size < 2) {
                alert("ÂàõÂª∫Áæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ËÅîÁ≥ª‰∫∫„ÄÇ");
                return;
            }
        
            const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'Êàë‰ª¨ÁöÑÁæ§ËÅä');
            if (!groupName || !groupName.trim()) return;
        
            const newChatId = 'group_' + Date.now();
            const members = [];
            
            // ÈÅçÂéÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ID
            for (const contactId of selectedContacts) {
                const contactChat = state.chats[contactId];
                if (contactChat) {
                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁ°Æ‰øù originalName Êù•Ëá™ contactChat.originalName
                    members.push({
                        id: contactId, 
                        originalName: contactChat.originalName, // <-- ‰πãÂâçÁöÑBUGÂú®ËøôÈáåÔºåÁé∞Âú®Â∑≤‰øÆÂ§ç
                        groupNickname: contactChat.name,
                        persona: contactChat.settings.aiPersona
                    });
                }
            }
        
            const newGroupChat = {
                id: newChatId,
                name: groupName.trim(),
                isGroup: true,
                members: members,
                settings: {
                    myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
                    myNickname: 'Êàë',
                    maxMemory: 10,
                    groupAvatar: defaultGroupAvatar,
                    myAvatar: defaultMyGroupAvatar,
                    background: '',
                    theme: 'default',
                    fontSize: 13,
                    customCss: '',
                    linkedWorldBookIds: [],
                },
                history: [],
                musicData: { totalTime: 0 }
            };
        
            state.chats[newChatId] = newGroupChat;
            await db.chats.put(newGroupChat);
            
            await renderChatList();
            showScreen('chat-list-screen');
            openChat(newChatId); 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄÁæ§ÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
         */
        function openMemberManagementScreen() {
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
            renderMemberManagementList();
            showScreen('member-management-screen');
        }
        
        function renderMemberManagementList() {
            const listEl = document.getElementById('member-management-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
        
            chat.members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'member-management-item';
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞ÜÊòæÁ§∫ÁöÑÂêçÁß∞‰ªé member.name Êîπ‰∏∫ member.groupNickname
                item.innerHTML = `
                    <img src="${member.avatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                    <button class="remove-member-btn" data-member-id="${member.id}" title="ÁßªÂá∫Áæ§ËÅä">-</button>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§‰∏Ä‰∏™ÊàêÂëò
         * @param {string} memberId - Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòID
         */
        async function removeMemberFromGroup(memberId) {
            const chat = state.chats[state.activeChatId];
            const memberIndex = chat.members.findIndex(m => m.id === memberId);
            
            if (memberIndex === -1) return;
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁæ§ËÅäËá≥Â∞ë‰øùÁïô2‰∫∫
            if (chat.members.length <= 2) {
                alert("Áæ§ËÅä‰∫∫Êï∞‰∏çËÉΩÂ∞ë‰∫é2‰∫∫„ÄÇ");
                return;
            }
            
        const memberName = chat.members[memberIndex].groupNickname; // <-- ‰øÆÂ§çÔºö‰ΩøÁî® groupNickname
            const confirmed = await showCustomConfirm(
                'ÁßªÂá∫ÊàêÂëò',
                `Á°ÆÂÆöË¶ÅÂ∞Ü‚Äú${memberName}‚ÄùÁßªÂá∫Áæ§ËÅäÂêóÔºü`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.members.splice(memberIndex, 1);
                await db.chats.put(chat);
                renderMemberManagementList(); // Âà∑Êñ∞ÊàêÂëòÁÆ°ÁêÜÂàóË°®
                document.getElementById('chat-settings-btn').click(); // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊ®°ÊãüÁÇπÂáªËÆæÁΩÆÊåâÈíÆÔºåÂº∫Âà∂Âà∑Êñ∞Êï¥‰∏™ÂºπÁ™ó
            }
        }
        
        /**
         * ÊâìÂºÄËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®ÔºåÁî®‰∫éÊãâ‰∫∫ÂÖ•Áæ§
         */
        async function openContactPickerForAddMember() {
            selectedContacts.clear(); // Ê∏ÖÁ©∫ÈÄâÊã©
            
            const chat = state.chats[state.activeChatId];
            const existingMemberIds = new Set(chat.members.map(m => m.id));
        
            // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÂπ∂Ëá™Âä®ÊéíÈô§Â∑≤Âú®Áæ§ÂÜÖÁöÑÊàêÂëò
            const listEl = document.getElementById('contact-picker-list');
            listEl.innerHTML = '';
            const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));
        
            if (contacts.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Ê≤°ÊúâÊõ¥Â§öÂèØ‰ª•ÈÇÄËØ∑ÁöÑÂ•ΩÂèã‰∫Ü„ÄÇ</p>';
                document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // Ê≤°Êúâ‰∫∫ÂèØÈÄâÔºåÈöêËóèÂÆåÊàêÊåâÈíÆ
            } else {
                document.getElementById('confirm-contact-picker-btn').style.display = 'block';
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-picker-item';
                    item.dataset.contactId = contact.id;
                    item.innerHTML = `
                        <div class="checkbox"></div>
                        <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                        <span class="name">${contact.name}</span>
                    `;
                    listEl.appendChild(item);
                });
            }
        
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÂπ∂ÊòæÁ§∫Â±èÂπï
            updateContactPickerConfirmButton();
            showScreen('contact-picker-screen');
        }
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈîôËØØ„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handleAddMembersToGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * Â§ÑÁêÜÂ∞ÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫Âä†ÂÖ•Áæ§ËÅäÁöÑÈÄªËæë
         */
        async function handleAddMembersToGroup() {
            if (selectedContacts.size === 0) {
                alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
        
            for (const contactId of selectedContacts) {
                const contactChat = state.chats[contactId];
                if (contactChat) {
                    // Ëøô‰∏™ÈÉ®ÂàÜÁöÑÊï∞ÊçÆÁªìÊûÑÊòØÊ≠£Á°ÆÁöÑÔºå‰øùÊåÅ‰∏çÂèò
                    chat.members.push({
                        id: contactId,
                        originalName: contactChat.originalName,
                        groupNickname: contactChat.name,
                        persona: contactChat.settings.aiPersona,
                        // Ê≥®ÊÑèÔºöÊàë‰ª¨‰∏çÂÜçÂú®ËøôÈáåÂ≠òÂÇ® avatar Âíå avatarFrameÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÊòØÂä®ÊÄÅËé∑ÂèñÁöÑ
                    });
                }
            }
        
            await db.chats.put(chat);
            
            // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ---
            // ‰πãÂâçËøôÈáåÈîôËØØÂú∞Ë∞ÉÁî®‰∫Ü renderGroupMemberSettingsÔºåÂØºËá¥Êä•Èîô„ÄÇ
            // Ê≠£Á°ÆÁöÑÈÄªËæëÊòØÔºöÁõ¥Êé•ËøîÂõûÂà∞‚ÄúÁæ§ÊàêÂëòÁÆ°ÁêÜ‚ÄùÂ±èÂπïÔºå
            // ËÄå openMemberManagementScreen ÂáΩÊï∞‰ºöËá™Âä®Ë∞ÉÁî® renderMemberManagementList Êù•Âà∑Êñ∞ÂàóË°®„ÄÇ
            openMemberManagementScreen(); 
            // --- „Äê‰øÆÂ§çÁªìÊùü„Äë ---
        }
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈîôËØØ„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ createNewMemberInGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂú®Áæ§ËÅä‰∏≠ÂàõÂª∫‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑËôöÊãüÊàêÂëò
         */
        async function createNewMemberInGroup() {
            const name = await showCustomPrompt('ÂàõÂª∫Êñ∞ÊàêÂëò', 'ËØ∑ËæìÂÖ•Êñ∞ÊàêÂëòÁöÑÂêçÂ≠ó (ËøôÂ∞ÜÊòØTAÁöÑ‚ÄúÊú¨Âêç‚ÄùÔºå‰∏çÂèØÊõ¥Êîπ)');
            if (!name || !name.trim()) return;
        
            const chat = state.chats[state.activeChatId];
            if (chat.members.some(m => m.originalName === name.trim())) {
                alert(`ÈîôËØØÔºöÁæ§ÂÜÖÂ∑≤Â≠òÂú®Âêç‰∏∫‚Äú${name.trim()}‚ÄùÁöÑÊàêÂëòÔºÅ`);
                return;
            }
        
            const persona = await showCustomPrompt('ËÆæÁΩÆ‰∫∫ËÆæ', `ËØ∑ËæìÂÖ•‚Äú${name}‚ÄùÁöÑ‰∫∫ËÆæ`, '', 'textarea');
            if (persona === null) return; 
        
            const newMember = {
                id: 'npc_' + Date.now(),
                originalName: name.trim(),
                groupNickname: name.trim(),
                // Ê≥®ÊÑèÔºöavatar Âíå avatarFrame ‰πüÊòØÂä®ÊÄÅËé∑ÂèñÁöÑÔºåÊó†ÈúÄÂú®Ê≠§Â§ÑÂ≠òÂÇ®
                persona: persona,
            };
        
            chat.members.push(newMember);
            await db.chats.put(chat);
        
            // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ---
            // ‰πãÂâçËøôÈáåË∞ÉÁî®‰∫Ü‰∏§‰∏™Âà∑Êñ∞ÂáΩÊï∞ÔºåÂÖ∂‰∏≠‰∏Ä‰∏™‰ºöÊä•Èîô„ÄÇ
            // Ê≠£Á°ÆÁöÑÈÄªËæëÊòØÔºöÂè™ÈúÄË¶ÅÂà∑Êñ∞ÂΩìÂâçÁî®Êà∑Ê≠£Âú®ÁúãÁöÑ‚ÄúÊàêÂëòÁÆ°ÁêÜ‚ÄùÂàóË°®Âç≥ÂèØ„ÄÇ
            renderMemberManagementList();
            // --- „Äê‰øÆÂ§çÁªìÊùü„Äë ---
        
            alert(`Êñ∞ÊàêÂëò‚Äú${name}‚ÄùÂ∑≤ÊàêÂäüÂä†ÂÖ•Áæ§ËÅäÔºÅ`);
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÂÄíËÆ°Êó∂ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function startWaimaiCountdown(element, endTime) {
            const timerId = setInterval(() => {
                const now = Date.now();
                const distance = endTime - now;
        
                if (distance < 0) {
                    clearInterval(timerId);
                    element.innerHTML = '<span>Â∑≤</span><span>Ë∂Ö</span><span>Êó∂</span>';
                    return;
                }
        
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                const minStr = String(minutes).padStart(2, '0');
                const secStr = String(seconds).padStart(2, '0');
        
                element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
            }, 1000);
            return timerId;
        }
        
        function cleanupWaimaiTimers() {
            for (const timestamp in waimaiTimers) {
                clearInterval(waimaiTimers[timestamp]);
            }
            waimaiTimers = {};
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ showWaimaiDetails ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊòæÁ§∫Â§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÁöÑËØ¶ÁªÜ‰ø°ÊÅØ (‰ªøÂéüÁîüAppÊ†∑ÂºèÔºåÂ∑≤‰øÆÂ§çÂ∏ÉÂ±Ä)
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑÂ§ñÂçñÂç°ÁâáÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        async function showWaimaiDetails(timestamp) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'waimai_request') return;
            
            let statusText;
            switch(message.status) {
                case 'paid':
                    const payerName = message.paidBy || 'ÂØπÊñπ';
                    const payerDisplayName = getDisplayNameInGroup(chat, payerName);
                    statusText = `Áî± ${payerDisplayName} ‰∏∫ÊÇ®‰ª£‰ªòÊàêÂäü`;
                    break;
                case 'rejected':
                    statusText = '‰ª£‰ªòËØ∑Ê±ÇÂ∑≤Ë¢´ÊãíÁªù';
                    break;
                case 'pending':
                default:
                    statusText = 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ';
                    break;
            }
        
            // --- ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÂ∞±Âú®ËøôÈáå ‚òÖ‚òÖ‚òÖ ---
            // Êàë‰ª¨Â∞ÜÂ§ö‰∏™ <p> Ê†áÁ≠æÂêàÂπ∂‰∏∫‰∫Ü‰∏Ä‰∏™ <div>ÔºåÂπ∂‰ΩøÁî® <br> Ê†áÁ≠æËøõË°åÊç¢Ë°å„ÄÇ
            // ÂêåÊó∂Â¢ûÂä†‰∫Ü line-height (Ë°åÈ´ò) Êù•ÂæÆË∞ÉÂûÇÁõ¥Èó¥Ë∑ùÔºå‰ΩøÂÖ∂Êõ¥ÁæéËßÇ„ÄÇ
            const detailsHtml = `
                <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                    <strong>ÂïÜÂìÅ:</strong> ${message.productInfo}<br>
                    <strong>ÈáëÈ¢ù:</strong> ¬•${Number(message.amount).toFixed(2)}<br>
                    <strong>Áä∂ÊÄÅ:</strong> ${statusText}
                </div>
            `;
            // --- ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ ---
        
            await showCustomAlert("ËÆ¢ÂçïËØ¶ÊÉÖ", detailsHtml);
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. Êõ¥Êñ∞ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËÆ∞ÂΩïÊîØ‰ªòËÄÖÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØÁî®Êà∑‰ªòÁöÑÈí±
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
            } else {
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
            }
        
            // 2. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 3. ‰øùÂ≠òÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);  
        }
        
        let videoCallState = {
            isActive: false,       
            isAwaitingResponse: false, 
            isGroupCall: false,      
            activeChatId: null,    
            initiator: null,       
            startTime: null,       
            participants: [],      
            isUserParticipating: true,
            // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë---
            callHistory: [], // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØù‰∏≠ÁöÑÂØπËØùÂéÜÂè≤
            preCallContext: "" // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å
        };
        
        let callTimerInterval = null; // Áî®‰∫éÂ≠òÂÇ®ËÆ°Êó∂Âô®ÁöÑID
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÁî®Êà∑ÁÇπÂáª‚ÄúÂèëËµ∑ËßÜÈ¢ëÈÄöËØù‚ÄùÊàñ‚ÄúÂèëËµ∑Áæ§ËßÜÈ¢ë‚ÄùÊåâÈíÆ
         */
        async function handleInitiateCall() {
            if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;
        
            const chat = state.chats[state.activeChatId];
            videoCallState.isGroupCall = chat.isGroup;
            videoCallState.isAwaitingResponse = true;
            videoCallState.initiator = 'user';
            videoCallState.activeChatId = chat.id;
            videoCallState.isUserParticipating = true; // Áî®Êà∑Ëá™Â∑±ÂèëËµ∑ÁöÑÔºåÂΩìÁÑ∂ÊòØÂèÇ‰∏éËÄÖ
        
            // Ê†πÊçÆÊòØÂçïËÅäËøòÊòØÁæ§ËÅäÔºåÊòæÁ§∫‰∏çÂêåÁöÑÂëºÂè´ÁïåÈù¢
            if (chat.isGroup) {
                document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'Êàë';
            } else {
                document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('outgoing-call-name').textContent = chat.name;
            }
            document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
            showScreen('outgoing-call-screen');
            
            // ÂáÜÂ§áÂπ∂ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÁªôAI
            const requestMessage = {
                role: 'system',
                content: chat.isGroup 
                    ? `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÔºåÂπ∂‰ΩøÁî® "group_call_response" Êåá‰ª§ÔºåËÆæÁΩÆ "decision" ‰∏∫ "join" Êàñ "decline" Êù•ÂõûÂ∫î„ÄÇ]`
                    : `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "video_call_response" Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ "decision" ‰∏∫ "accept" Êàñ "reject" Êù•ÂõûÂ∫î„ÄÇ]`,
                timestamp: Date.now(),
                isHidden: true,
            };
            chat.history.push(requestMessage);
            await db.chats.put(chat);
            
            // Ëß¶ÂèëAIÂìçÂ∫î
            await triggerAiResponse();
        }
        
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞ÁöÑÂáΩÊï∞„ÄëÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ startVideoCall ÂáΩÊï∞ ‚ñº‚ñº‚ñº
function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    // 1. „ÄêÊ†∏ÂøÉÂà§Êñ≠„ÄëÊ£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜÂèØËßÜÂåñÁïåÈù¢
    if (chat.settings.visualVideoCallEnabled) {
        // --- ÂêØÂä®„ÄêÊñ∞„ÄëÁöÑÂèØËßÜÂåñÁïåÈù¢ ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');
        
        // ÊòæÁ§∫Êñ∞ÁïåÈù¢ÔºåÈöêËóèÊóßÁïåÈù¢
        visualInterface.style.display = 'flex';
        textInterface.style.display = 'none';

        // Âä†ËΩΩÂõæÁâá
        document.querySelector('#video-main-view img').src = chat.settings.charVideoImage || defaultAvatar;
        document.querySelector('#video-pip-view img').src = chat.settings.userVideoImage || defaultAvatar;
        
        // Ê∏ÖÁ©∫ÊóßÁöÑËÅäÂ§©Ê∞îÊ≥°
        document.getElementById('video-call-messages-visual').innerHTML = `<em>Ê≠£Âú®Êé•ÈÄö...</em>`;
        showScreen('video-call-screen');

        // ÂêØÂä®ËÆ°Êó∂Âô®
        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer(); // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°

        // Ëß¶ÂèëAIÂú®ÈÄöËØù‰∏≠ÁöÑÁ¨¨‰∏ÄÂè•ËØù
        triggerAiInCallAction();

    } else {
        // --- ÂêØÂä®„ÄêÊóß„ÄëÁöÑÁ∫ØÊñáÂ≠óÁïåÈù¢ (ËøôÈáåÁöÑ‰ª£Á†ÅÂ∞±ÊòØ‰Ω†ÂéüÊù•ÁöÑÈÄªËæë) ---
        videoCallState.isActive = true;
        videoCallState.isAwaitingResponse = false;
        videoCallState.startTime = Date.now();
        videoCallState.callHistory = [];

        const visualInterface = document.getElementById('visual-call-interface');
        const textInterface = document.getElementById('text-call-interface');

        // ÊòæÁ§∫ÊóßÁïåÈù¢ÔºåÈöêËóèÊñ∞ÁïåÈù¢
        visualInterface.style.display = 'none';
        textInterface.style.display = 'flex'; // ÊóßÁïåÈù¢Áî®flex

        updateParticipantAvatars(); 
        
        document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'Áæ§ËÅäÂ∑≤Âª∫Á´ã...' : 'Ê≠£Âú®Êé•ÈÄö...'}</em>`;
        showScreen('video-call-screen');

        document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
        document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

        if (callTimerInterval) clearInterval(callTimerInterval);
        callTimerInterval = setInterval(updateCallTimer, 1000);
        updateCallTimer();

        triggerAiInCallAction();
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

  // ‚ñº‚ñº‚ñº Âú® endVideoCall ÂáΩÊï∞ÁöÑ„ÄêÂºÄÂ§¥„ÄëÊ∑ªÂä†ËøôË°å‰ª£Á†Å ‚ñº‚ñº‚ñº
document.getElementById('visual-call-interface').style.display = 'none';
// ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
      
/**
 * „ÄêÊ†∏ÂøÉ | V3.0 ÁªàÊûÅÊÄªÁªì‰øÆÂ§çÁâà„ÄëÁªìÊùüËßÜÈ¢ëÈÄöËØù
 */
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}ÂàÜ${duration % 60}Áßí`;
    const endCallText = `ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        // 1. ‰øùÂ≠òÂÆåÊï¥ÁöÑÈÄöËØùËÆ∞ÂΩïÂà∞Êï∞ÊçÆÂ∫ì (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèòÔºåÈùûÂ∏∏ÈáçË¶Å)
        const participantsData = [];
        if (videoCallState.isGroupCall) {
            videoCallState.participants.forEach(p => participantsData.push({ name: p.originalName, avatar: p.avatar }));
            if (videoCallState.isUserParticipating) {
                participantsData.unshift({ name: chat.settings.myNickname || 'Êàë', avatar: chat.settings.myAvatar || defaultMyGroupAvatar });
            }
        } else {
            participantsData.push({ name: chat.name, avatar: chat.settings.aiAvatar || defaultAvatar });
            participantsData.unshift({ name: 'Êàë', avatar: chat.settings.myAvatar || defaultAvatar });
        }

        const callRecord = {
            chatId: videoCallState.activeChatId,
            timestamp: Date.now(),
            duration: duration,
            participants: participantsData,
            transcript: [...videoCallState.callHistory]
        };
        await db.callRecords.add(callRecord);
        console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò:", callRecord);
        
        // 2. Âú®ËÅäÂ§©ËÆ∞ÂΩïÈáåÊ∑ªÂä†ÂØπÁî®Êà∑ÂèØËßÅÁöÑ‚ÄúÈÄöËØùÁªìÊùü‚ÄùÊ∂àÊÅØ (ÈÄªËæë‰∏çÂèò)
        let summaryMessage = {
            role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
            content: endCallText,
            timestamp: Date.now(),
        };
        if (chat.isGroup && summaryMessage.role === 'assistant') {
            summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
        }
        chat.history.push(summaryMessage);

        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        //            ËøôÂ∞±ÊòØÊú¨Ê¨°‰øÆÊîπÁöÑÊ†∏ÂøÉÊâÄÂú®ÔºÅ
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        
        // 3. „ÄêÂÖ®Êñ∞„ÄëÂ∞ÜÂÆåÊï¥ÁöÑÈÄöËØùËÆ∞ÂΩï‚ÄúÁøªËØë‚ÄùÊàê‰∏ÄÊÆµAIËÉΩÁêÜËß£ÁöÑÊñáÊú¨
        const callTranscriptForAI = videoCallState.callHistory.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
            return `${sender}: ${h.content}`;
        }).join('\n');
        
        // 4. „ÄêÂÖ®Êñ∞„ÄëÂú®ÂêéÂè∞Ë∞ÉÁî®ÊÄªÁªìÂáΩÊï∞ÔºåÂÆÉ‰ºöËá™Âä®Â§ÑÁêÜAPIË∞ÉÁî®ÂíåËÆ∞ÂøÜÂ≠òÂÇ®
        // Êàë‰ª¨Âú®ËøôÈáå‰∏ç‰ΩøÁî® awaitÔºåËÆ©ÂÆÉÂú®ÂêéÂè∞ÈùôÈªòÊâßË°åÔºå‰∏çÈòªÂ°ûUI
        summarizeCallTranscript(chat.id, callTranscriptForAI);

        // 5. „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫‰∏Ä‰∏™ÂØπÁî®Êà∑ÈöêËóèÁöÑ„ÄÅÁÆÄÁü≠ÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåËÆ©AIÂØπÈÄöËØùÁªìÊùüËøô‰ª∂‰∫ãÊú¨Ë∫´ÂÅöÂá∫ÂèçÂ∫î
        const hiddenReactionInstruction = {
            role: 'system',
            content: `[Á≥ªÁªüÊåá‰ª§ÔºöËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü„ÄÇËØ∑‰Ω†‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂêëÁî®Êà∑‰∏ªÂä®ÂèëÈÄÅ‰∏Ä‰∏§Êù°Ê∂àÊÅØÔºåÊù•Ëá™ÁÑ∂Âú∞ÊÄªÁªìËøôÊ¨°ÈÄöËØùÁöÑË¶ÅÁÇπ„ÄÅÁ°ÆËÆ§ËææÊàêÁöÑÁ∫¶ÂÆöÔºåÊàñËÄÖË°®Ëææ‰Ω†ÁöÑÊÑüÂèó„ÄÇ]`,
            timestamp: Date.now() + 1, // Á°Æ‰øùÊó∂Èó¥Êà≥Âú®‚ÄúÈÄöËØùÁªìÊùü‚ÄùÊ∂àÊÅØ‰πãÂêé
            isHidden: true // Ëøô‰∏™Ê†áËÆ∞Á°Æ‰øùÁî®Êà∑Áúã‰∏çÂà∞ËøôÊù°Êåá‰ª§
        };
        chat.history.push(hiddenReactionInstruction);

        // 6. ‰øùÂ≠òÊâÄÊúâÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì
        await db.chats.put(chat);
    }
    
    // 7. Ê∏ÖÁêÜÂíåÈáçÁΩÆÁä∂ÊÄÅ (ÈÄªËæë‰∏çÂèò)
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // 8. ËøîÂõûËÅäÂ§©ÁïåÈù¢ÔºåÂπ∂Ëß¶ÂèëAIÂØπÈÄöËØùÁªìÊùüÁöÑÂèçÂ∫î
    if (chat) {
        openChat(chat.id);
        triggerAiResponse();
    }
}
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËá™ÂÆö‰πâËßÜÈ¢ëÈÄöËØùÁöÑÊ†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº

/**
 * „ÄêÊÄªÂÖ•Âè£„ÄëÂêØÂä®ÂÖ®Êñ∞ÁöÑËá™ÂÆö‰πâËßÜÈ¢ëÈÄöËØùÁïåÈù¢
 */
function startCustomVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat || !chat.settings.charVideoImage || !chat.settings.userVideoImage) {
        alert("ËØ∑ÂÖàÂú®‚ÄúËÅäÂ§©ËÆæÁΩÆ‚Äù‰∏≠‰∏∫Ê≠§ËßíËâ≤‰∏ä‰º†ËßÜÈ¢ëÈÄöËØùÊâÄÈúÄÁöÑÂèåÊñπÁîªÈù¢„ÄÇ");
        startVideoCall(); // ÈÄÄÂõûÂà∞ÊóßÁöÑËØ≠Èü≥ÈÄöËØùÁïåÈù¢‰Ωú‰∏∫‰øùÂ∫ï
        return;
    }

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = [];

    const visualInterface = document.getElementById('visual-call-interface');
    const textInterface = document.getElementById('text-call-interface');
    
    // ÊòæÁ§∫Êñ∞ÁïåÈù¢ÔºåÈöêËóèÊóßÁïåÈù¢
    visualInterface.style.display = 'flex';
    textInterface.style.display = 'none';

    // Âä†ËΩΩÂõæÁâá
    document.querySelector('#video-main-view img').src = chat.settings.charVideoImage;
    document.querySelector('#video-pip-view img').src = chat.settings.userVideoImage;
    
    // Ê∏ÖÁ©∫ÊóßÁöÑËÅäÂ§©Ê∞îÊ≥°
    document.getElementById('video-call-messages-visual').innerHTML = `<em>Ê≠£Âú®Êé•ÈÄö...</em>`;
    showScreen('video-call-screen');

    // ÂêØÂä®ËÆ°Êó∂Âô®
    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer(); // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°

    // Ëß¶ÂèëAIÂú®ÈÄöËØù‰∏≠ÁöÑÁ¨¨‰∏ÄÂè•ËØù
    triggerAiInCallAction();
}

/**
 * ÂàáÊç¢Â§ßÂ∞èÁ™óÂè£ÁöÑÁîªÈù¢
 */
function switchVideoViews() {
    const mainView = document.getElementById('video-main-view');
    const pipView = document.getElementById('video-pip-view');
    
    const mainImg = mainView.querySelector('img');
    const pipImg = pipView.querySelector('img');
    
    // ‰∫§Êç¢‰∏§Âº†ÂõæÁâáÁöÑ src
    const tempSrc = mainImg.src;
    mainImg.src = pipImg.src;
    pipImg.src = tempSrc;
}

/**
 * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜËßÜÈ¢ëÈÄöËØù‰∏≠ÁöÑ‚ÄúÈáçroll‚ÄùËØ∑Ê±Ç
 */
async function handleVideoCallReroll() {
    if (!videoCallState.isActive) return;

    // 1. ÊâæÂà∞Áî®Êà∑ÊúÄÂêé‰∏ÄÊ¨°ËØ¥ÁöÑËØùÁöÑÁ¥¢Âºï
    const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(h => h.role === 'user');
    
    // 2. ‰ªéÈÄöËØùÂéÜÂè≤‰∏≠ÔºåÂà†Èô§ÊéâÈÇ£‰πãÂêéÁöÑÊâÄÊúâAIÂõûÂ§ç
    if (lastUserSpeechIndex > -1) {
        videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
    } else {
        videoCallState.callHistory = [];
    }
    
    // 3. ÈáçÊñ∞Ê∏≤ÊüìÈÄöËØùÁïåÈù¢ÔºåËÆ©ÊóßÁöÑAIÊ∞îÊ≥°‰ªéÂ±èÂπï‰∏äÊ∂àÂ§±
    const chat = state.chats[videoCallState.activeChatId];
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');
    
    callFeed.innerHTML = ''; // Ê∏ÖÁ©∫ÂÆπÂô®
    
    // ÈáçÊñ∞Ê∏≤ÊüìÂà†Èô§ÂêéÁöÑÂéÜÂè≤ËÆ∞ÂΩï
    videoCallState.callHistory.forEach(msg => {
        let bubble;
        if (isVisualMode) {
            bubble = document.createElement('div');
            bubble.className = `visual-call-bubble ${msg.role === 'user' ? 'user' : 'ai'}`;
        } else {
            bubble = document.createElement('div');
            bubble.className = `call-message-bubble ${msg.role === 'user' ? 'user-speech' : 'ai-speech'}`;
        }
        bubble.textContent = msg.content;
        callFeed.appendChild(bubble);
    });
    
    // 4. ÈáçÊñ∞Ëß¶ÂèëAIÂìçÂ∫î
    await triggerAiInCallAction();
}

// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊõ¥Êñ∞ÈÄöËØùÁïåÈù¢ÁöÑÂèÇ‰∏éËÄÖÂ§¥ÂÉèÁΩëÊ†º
         */
        function updateParticipantAvatars() {
            const grid = document.getElementById('participant-avatars-grid');
            grid.innerHTML = '';
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
        
            let participantsToRender = [];
        
            // ‚òÖ Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÂå∫ÂàÜÁæ§ËÅäÂíåÂçïËÅä
            if (videoCallState.isGroupCall) {
                // Áæ§ËÅäÈÄªËæëÔºöÊòæÁ§∫ÊâÄÊúâÂ∑≤Âä†ÂÖ•ÁöÑAIÊàêÂëò
                participantsToRender = [...videoCallState.participants];
                // Â¶ÇÊûúÁî®Êà∑‰πüÂèÇ‰∏é‰∫ÜÔºåÂ∞±ÊääÁî®Êà∑‰ø°ÊÅØ‰πüÂä†ËøõÂéª
                if (videoCallState.isUserParticipating) {
                    participantsToRender.unshift({
                        id: 'user',
                        name: chat.settings.myNickname || 'Êàë',
                        avatar: chat.settings.myAvatar || defaultMyGroupAvatar
                    });
                }
            } else {
                // ÂçïËÅäÈÄªËæëÔºöÂè™ÊòæÁ§∫ÂØπÊñπÁöÑÂ§¥ÂÉèÂíåÂêçÂ≠ó
                participantsToRender.push({
                    id: 'ai',
                    name: chat.name,
                    avatar: chat.settings.aiAvatar || defaultAvatar
                });
            }
            
            participantsToRender.forEach(p => {
                const wrapper = document.createElement('div');
                wrapper.className = 'participant-avatar-wrapper';
                wrapper.dataset.participantId = p.id;
        const displayName = p.groupNickname || p.name; // <-- Ê†∏ÂøÉ‰øÆÂ§çÂú®ËøôÈáå
        wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
            <div class="participant-name">${displayName}</div>
        `;
                grid.appendChild(wrapper);
            });
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑Âä†ÂÖ•/ÈáçÊñ∞Âä†ÂÖ•ÈÄöËØù
         */
        function handleUserJoinCall() {
            if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
            
            videoCallState.isUserParticipating = true;
            updateParticipantAvatars(); // Êõ¥Êñ∞Â§¥ÂÉèÂàóË°®ÔºåÂä†ÂÖ•Áî®Êà∑
        
            // ÂàáÊç¢Â∫ïÈÉ®ÊåâÈíÆ
            document.getElementById('user-speak-btn').style.display = 'block';
            document.getElementById('join-call-btn').style.display = 'none';
        
            // ÂëäÁü•AIÁî®Êà∑Âä†ÂÖ•‰∫Ü
            triggerAiInCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
        }
        
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÊñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ updateCallTimer ÂáΩÊï∞ ‚ñº‚ñº‚ñº
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    // ÂêåÊó∂Êõ¥Êñ∞‰∏§‰∏™ÁïåÈù¢ÁöÑËÆ°Êó∂Âô®
    document.getElementById('call-timer').textContent = timeString;
    document.getElementById('visual-call-timer').textContent = timeString;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™ÂÆåÊï¥ÂáΩÊï∞ÊõøÊç¢ÊóßÁöÑ showIncomingCallModal ‚ñº‚ñº‚ñº
        function showIncomingCallModal() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // Ê†πÊçÆÊòØÂê¶Áæ§ËÅäÊòæÁ§∫‰∏çÂêå‰ø°ÊÅØ
            if (chat.isGroup) {
                // ‰ªé videoCallState ‰∏≠Ëé∑ÂèñÊòØÂì™‰∏™ÊàêÂëòÂèëËµ∑ÁöÑÈÄöËØù
                const requesterName = videoCallState.callRequester || chat.members[0]?.name || '‰∏Ä‰ΩçÊàêÂëò';
                document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
                document.getElementById('caller-name').textContent = chat.name; // ÊòæÁ§∫Áæ§Âêç
                document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËßÜÈ¢ë`; // ÊòæÁ§∫ÂÖ∑‰ΩìÂèëËµ∑‰∫∫
            } else {
                // ÂçïËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèò
                document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('caller-name').textContent = chat.name;
                document.querySelector('.incoming-call-content .caller-text').textContent = 'ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù';
            }
            
            document.getElementById('incoming-call-modal').classList.add('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÈöêËóèAIÂèëËµ∑ÁöÑÈÄöËØùËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü (‰øùÊåÅ‰∏çÂèò)
         */
        function hideIncomingCallModal() {
            document.getElementById('incoming-call-modal').classList.remove('visible');
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅÂ∑≤Ê∑ªÂä†‰∏•Ê†ºËßÑÂàôÁöÑÂáΩÊï∞„ÄëÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ triggerAiInCallAction ÂáΩÊï∞ ‚ñº‚ñº‚ñº
async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    
    const isVisualMode = chat.settings.visualVideoCallEnabled;
    const callFeed = isVisualMode 
        ? document.getElementById('video-call-messages-visual') 
        : document.getElementById('video-call-main');

    const userNickname = chat.settings.myNickname || 'Êàë';

    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
            return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
            worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${linkedContents}\n`;
        }
    }

    if (userInput && videoCallState.isUserParticipating) {
        if (isVisualMode) {
            const userBubble = document.createElement('div');
            userBubble.className = 'visual-call-bubble user';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        } else {
            const userBubble = document.createElement('div');
            userBubble.className = 'call-message-bubble user-speech';
            userBubble.textContent = userInput;
            callFeed.appendChild(userBubble);
        }
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäËßÜÈ¢ëÈÄöËØùÁöÑÂØºÊºî„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "speech": "*‰ªñÁ¨ë‰∫ÜÁ¨ë* Â§ßÂÆ∂Â•ΩÂïäÔºÅ"}\`„ÄÇ
2.  **„Äê„Äê„ÄêÂÜÖÂÆπÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ªÊòØÁ∫ØÊñáÊú¨„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïURLÈìæÊé•„ÄÅMarkdownÂõæÁâáËØ≠Ê≥ï(\`![alt](url)\`)„ÄÅÊàñ‰ªª‰ΩïÂΩ¢ÂºèÁöÑÊñá‰ª∂Ë∑ØÂæÑ„ÄÇ
3.  **Ë∫´‰ªΩÈìÅÂæã**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
4.  **ËßÜËßíÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇ
5.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
# ÂΩìÂâçÊÉÖÊôØ
‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËßÜÈ¢ëÈÄöËØù‰∏≠„ÄÇ
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
${videoCallState.preCallContext}
**ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join('„ÄÅ ')}„ÄÇ
**ÈÄöËØùÂàöÂàöÂºÄÂßã...**
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ`
            : `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËßÜÈ¢ëÈÄöËØù„ÄÇ`;
        inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊòØ‰∏Ä‰∏™Âú∫ÊôØÊèèËø∞ÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî ${chat.name} (${chat.settings.aiPersona})ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞TAÂú®ËßÜÈ¢ëÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêÂÜÖÂÆπÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ªÊòØÁ∫ØÊñáÊú¨„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõû‰ªª‰ΩïJSONÊ†ºÂºèÁöÑÊåá‰ª§„ÄÅURLÈìæÊé•„ÄÅMarkdownÂõæÁâáËØ≠Ê≥ï(\`![alt](url)\`)„ÄÅÊàñ‰ªª‰ΩïÂΩ¢ÂºèÁöÑÊñá‰ª∂Ë∑ØÂæÑ„ÄÇ
2.  **ËßÜËßíÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÔºåÂ¶Ç‚Äú‰ªñ‚Äù„ÄÅ‚ÄúÂ•π‚Äù„ÄÅÊàñÁõ¥Êé•‰ΩøÁî®ËßíËâ≤Âêç‚Äú${chat.name}‚Äù„ÄÇ
# ÂΩìÂâçÊÉÖÊôØ
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Ôºà${userNickname}Ôºå‰∫∫ËÆæ: ${chat.settings.myPersona}ÔºâËøõË°åËßÜÈ¢ëÈÄöËØù„ÄÇ
**${openingContext}**
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å (ËøôÊòØ‰Ω†‰ª¨ÈÄöËØùÁöÑÂéüÂõ†ÔºåËá≥ÂÖ≥ÈáçË¶ÅÔºÅ)**:
${videoCallState.preCallContext}
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
`;
    }
    
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*‰Ω†Êåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*` : `*ÂØπÊñπÊåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    
    try {
        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi, isGemini);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
            body: JSON.stringify({ model: model, messages: messagesForApi, temperature: 0.8 })
        });
        if (!response.ok) throw new Error((await response.json()).error.message);

        const data = await response.json();
        const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
        const sanitizedResponse = aiResponse.replace(/!\[.*?\]\(.*?\)|https?:\/\/\S+/gi, '').trim();

        const connectingElement = callFeed.querySelector('em');
        if (connectingElement) connectingElement.remove();

        if (isVisualMode) {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'visual-call-bubble ai';
            aiBubble.textContent = sanitizedResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
        } else {
            if (videoCallState.isGroupCall) {
                const speechArray = parseAiResponse(sanitizedResponse); 
                speechArray.forEach(turn => {
                    if (!turn.name || turn.name === userNickname || !turn.speech) return;
                    const aiBubble = document.createElement('div');
                    aiBubble.className = 'call-message-bubble ai-speech';
                    aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                    callFeed.appendChild(aiBubble);
                    videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                    
                    const speaker = videoCallState.participants.find(p => p.name === turn.name);
                    if (speaker) {
                        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                        if(speakingAvatar) {
                            speakingAvatar.classList.add('speaking');
                            setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                        }
                    }
                });
            } else {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.textContent = sanitizedResponse;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: sanitizedResponse });
                const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                if(speakingAvatar) {
                    speakingAvatar.classList.add('speaking');
                    setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                }
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        
        if (isVisualMode) {
            errorBubble.className = 'visual-call-bubble ai';
        } else {
            errorBubble.className = 'call-message-bubble ai-speech';
        }
        
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        // ‚ñº‚ñº‚ñº Â∞ÜËøô‰∏™„ÄêÂÖ®Êñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        function toggleCallButtons(isGroup) {
            document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
            document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøô‰∏™ÂáΩÊï∞ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÔºåËØ∑Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂå∫ ‚ñº‚ñº‚ñº
        async function handleWaimaiResponse(originalTimestamp, choice) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
            if (messageIndex === -1) return;
        
            // 1. Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
            
            // 2. Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑÊòµÁß∞ÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
            let systemContent;
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            
            if (choice === 'paid') {
                originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØ‚ÄúÊàë‚Äù‰ªòÁöÑÈí±
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
            } else {
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
            }
        
            // 3. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
            const systemNote = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(systemNote);
        
            // 4. Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Á´ãÂàªÈáçÁªòUI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            
            // 5. „ÄêÈáçË¶Å„ÄëÂè™ÊúâÂú®ÊîØ‰ªòÊàêÂäüÂêéÔºåÊâçËß¶Âèë‰∏ÄÊ¨°AIÂìçÂ∫îÔºåËÆ©ÂÆÉÊÑüË∞¢‰Ω†
            if (choice === 'paid') {
                triggerAiResponse();
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëÁî®Ëøô‰∏™„ÄêÊñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ handleUserPat ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÂ§¥ÂÉèÂèëËµ∑ÁöÑ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÔºåÂ∏¶ÊúâËá™ÂÆö‰πâÂêéÁºÄÂäüËÉΩ
         * @param {string} chatId - ÂèëÁîü‚ÄúÊãç‰∏Ä-Êãç‚ÄùÁöÑËÅäÂ§©ID
         * @param {string} characterOriginalName - Ë¢´ÊãçÁöÑËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„ÄëÔºåÁî®‰∫éAIËØÜÂà´
         */
        async function handleUserPat(chatId, characterOriginalName) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            // --- 1. Êô∫ËÉΩÂà§Êñ≠Â∫îËØ•Âú®UI‰∏äÊòæÁ§∫Âì™‰∏™ÂêçÂ≠ó ---
            let displayNameForUI;
            if (chat.isGroup) {
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÂ∞±ÈÄöËøáÊú¨ÂêçÊâæÂà∞Ê≠£Á°ÆÁöÑÁæ§ÊòµÁß∞
                displayNameForUI = getDisplayNameInGroup(chat, characterOriginalName);
            } else {
                // Â¶ÇÊûúÊòØÂçïËÅäÔºåÁõ¥Êé•‰ΩøÁî®Áî®Êà∑ËÆæÁΩÆÁöÑÂ§áÊ≥®Âêç
                displayNameForUI = chat.name;
            }
        
            const phoneScreen = document.getElementById('phone-screen');
            phoneScreen.classList.remove('pat-animation');
            void phoneScreen.offsetWidth;
            phoneScreen.classList.add('pat-animation');
        
            // 2. ‰ΩøÁî®Ê≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞Êù•ÂàõÂª∫ÂºπÁ™ó
            const suffix = await showCustomPrompt(
                `‰Ω†Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù`, 
                "ÔºàÂèØÈÄâÔºâËæìÂÖ•ÂêéÁºÄ",
                "",
                "text"
            );
        
            if (suffix === null) return;
        
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÂîØ‰∏ÄÁöÑ„ÄÅÊ†∏ÂøÉÁöÑ‰øÆÊîπÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            // Êàë‰ª¨Áé∞Âú®‰ΩøÁî® getDisplayNameInGroup Êù•Ëé∑ÂèñÊÇ®Ëá™Â∑±Âú®Áæ§ÈáåÁöÑÊòµÁß∞
            const myNickname = getDisplayNameInGroup(chat, state.qzoneSettings.nickname);
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÊîπÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            
            // 3. ÂàõÂª∫ÂØπÁî®Êà∑ÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØÊó∂Ôºå‰πü‰ΩøÁî®Ê≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞
            const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù ${suffix.trim()}`;
            const visibleMessage = {
                role: 'system',
                type: 'pat_message',
                content: visibleMessageContent,
                timestamp: Date.now()
            };
            chat.history.push(visibleMessage);
        
            // 4. „ÄêÈáçË¶Å„ÄëÂàõÂª∫ÁªôAIÁúãÁöÑÈöêËóèÊ∂àÊÅØÊó∂Ôºå‰æùÁÑ∂‰ΩøÁî®‚ÄúÊú¨Âêç‚ÄùÔºåÁ°Æ‰øùAIËÉΩÊ≠£Á°ÆËØÜÂà´
            const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãç‰Ω†Ôºà${characterOriginalName}Ôºâ${suffix.trim()}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;
            const hiddenMessage = {
                role: 'system',
                content: hiddenMessageContent,
                timestamp: Date.now() + 1,
                isHidden: true
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            if (state.activeChatId === chatId) {
                appendMessage(visibleMessage, chat);
            }
            await renderChatList();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®Êà∑Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊ†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÊ∂àÊÅØÁºñËæë‰∏éÂà†Èô§ÂäüËÉΩÊ†∏ÂøÉ‰ª£Á†Å ‚ñº‚ñº‚ñº
        
        let activeCallMessageTimestamp = null; // Áî®‰∫éÊöÇÂ≠òÊ≠£Âú®Êìç‰ΩúÁöÑÈÄöËØùÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
        
        /**
         * ÊòæÁ§∫ËßÜÈ¢ëÈÄöËØùÊ∂àÊÅØÁöÑÊìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÈïøÊåâÁöÑÈÄöËØùÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showCallMessageActions(timestamp) {
            activeCallMessageTimestamp = timestamp;
            document.getElementById('call-message-actions-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèËßÜÈ¢ëÈÄöËØùÊ∂àÊÅØÁöÑÊìç‰ΩúËèúÂçï
         */
        function hideCallMessageActions() {
            document.getElementById('call-message-actions-modal').classList.remove('visible');
            activeCallMessageTimestamp = null;
        }
        
        /**
         * ÊâìÂºÄÈÄöËØùÊ∂àÊÅØÁöÑÁºñËæëÂô®
         */
        async function openCallMessageEditor() {
            if (!activeCallMessageTimestamp) return;
        
            const timestampToEdit = activeCallMessageTimestamp;
            const message = videoCallState.callHistory.find(m => m.timestamp === timestampToEdit);
            if (!message) return;
        
            hideCallMessageActions(); // Êìç‰ΩúÂâçÂÖàÂÖ≥Èó≠ËèúÂçï
        
            let contentForEditing = message.content;
            // Â¶ÇÊûúÊòØÁæ§ËÅä‰∏≠AIÁöÑÂèëË®ÄÔºåÊàë‰ª¨Âè™ÊèêÂèñÂèëË®ÄÂÜÖÂÆπÊú¨Ë∫´ÔºåËÄå‰∏çÊòØ"ÂêçÂ≠ó: ÂÜÖÂÆπ"
            if (videoCallState.isGroupCall && message.role === 'assistant') {
                const parts = message.content.split(': ');
                if (parts.length > 1) {
                    contentForEditing = parts.slice(1).join(': ');
                }
            }
        
            const newContent = await showCustomPrompt(
                'ÁºñËæëÈÄöËØùÊ∂àÊÅØ',
                'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
                contentForEditing,
                'textarea'
            );
        
            if (newContent !== null) {
                await saveEditedCallMessage(timestampToEdit, newContent);
            }
        }
        
        /**
         * ‰øùÂ≠òÂú®ÈÄöËØù‰∏≠ÁºñËæëÁöÑÊ∂àÊÅØ
         * @param {number} timestamp - Ë¢´ÁºñËæëÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @param {string} newContent - Êñ∞ÁöÑÊ∂àÊÅØÂÜÖÂÆπ
         */
        async function saveEditedCallMessage(timestamp, newContent) {
            const message = videoCallState.callHistory.find(m => m.timestamp === timestamp);
            if (message) {
                let finalContent = newContent;
                // Â¶ÇÊûúÊòØÁæ§ËÅäAIÂèëË®ÄÔºåÈúÄË¶ÅÊääÂêçÂ≠óÈáçÊñ∞ÊãºÊé•ÂõûÂéª
                if (videoCallState.isGroupCall && message.role === 'assistant') {
                    const parts = message.content.split(': ');
                    const senderName = parts[0];
                    finalContent = `${senderName}: ${newContent}`;
                }
                message.content = finalContent; // Êõ¥Êñ∞ÈÄöËØùÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÁöÑÂÜÖÂÆπ
        
                // Êõ¥Êñ∞ÁïåÈù¢‰∏äÂØπÂ∫îÁöÑÊ∂àÊÅØÊ∞îÊ≥°
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestamp}"]`);
                if (messageBubble) {
                    if (videoCallState.isGroupCall && message.role === 'assistant') {
                        const parts = message.content.split(': ');
                        const senderName = parts[0];
                        messageBubble.innerHTML = `<strong>${senderName}:</strong> ${newContent}`;
                    } else {
                        messageBubble.textContent = newContent;
                    }
                }
            }
            await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
        }
        
        /**
         * Âú®ÈÄöËØù‰∏≠Âà†Èô§‰∏ÄÊù°Ê∂àÊÅØ
         */
        async function deleteCallMessage() {
            if (!activeCallMessageTimestamp) return;
        
            const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈÄöËØùÊ∂àÊÅØÂêóÔºü', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const timestampToDelete = activeCallMessageTimestamp;
                hideCallMessageActions();
        
                // ‰ªé‰∏¥Êó∂ÈÄöËØùÂéÜÂè≤‰∏≠ÁßªÈô§
                const messageIndex = videoCallState.callHistory.findIndex(m => m.timestamp === timestampToDelete);
                if (messageIndex > -1) {
                    videoCallState.callHistory.splice(messageIndex, 1);
                }
        
                // ‰ªéÁïåÈù¢‰∏äÁßªÈô§
                const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestampToDelete}"]`);
                if (messageBubble) {
                    messageBubble.remove();
                }
            } else {
                hideCallMessageActions();
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÊòæÁ§∫Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // Â∞ÜAIÁöÑÂêçÂ≠óÂ°´ÂÖ•ÂºπÁ™ó
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèÂ§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * Â§ÑÁêÜÁî®Êà∑Êé•ÂèóÊàñÊãíÁªùËΩ¨Ë¥¶ÁöÑÈÄªËæë
         * @param {string} choice - Áî®Êà∑ÁöÑÈÄâÊã©, 'accepted' Êàñ 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. Êõ¥Êñ∞ÂéüÂßãËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÁä∂ÊÄÅ
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊãíÁªù‚Äù
            if (choice === 'declined') {
                // Á´ãÂàªÂú®ÂâçÁ´ØÁîüÊàê‰∏Ä‰∏™‚ÄúÈÄÄÊ¨æ‚ÄùÂç°ÁâáÔºåËÆ©Áî®Êà∑ÁúãÂà∞
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // ËøôÊòØ‰∏Ä‰∏™ÂÖ≥ÈîÆÊ†áËÆ∞ÔºåÁî®‰∫éUIÊòæÁ§∫ËøôÊòØÈÄÄÊ¨æ
                    amount: originalMessage.amount,
                    note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // ÂáÜÂ§á‰∏ÄÊù°ÂØπAIÂèØËßÅÁöÑÈöêËóèÊ∂àÊÅØÔºåÂëäËØâÂÆÉÂèëÁîü‰∫Ü‰ªÄ‰πà
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
            } else { // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊé•Âèó‚Äù
                // Âè™ÈúÄÂáÜÂ§áÈöêËóèÊ∂àÊÅØÈÄöÁü•AIÂç≥ÂèØ
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
            }
        
            // 3. ÂàõÂª∫ËøôÊù°ÂØπÁî®Êà∑ÈöêËóè„ÄÅ‰ΩÜÂØπAIÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ‰øùËØÅÊó∂Èó¥Êà≥Âú®ÈÄÄÊ¨æÊ∂àÊÅØ‰πãÂêé
                isHidden: true // Ëøô‰∏™Ê†áËÆ∞‰ºöËÆ©ÂÆÉ‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
            };
            chat.history.push(hiddenMessage);
        
            // 4. ‰øùÂ≠òÊâÄÊúâÊõ¥ÊîπÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Âà∑Êñ∞ÁïåÈù¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ∏ÖÈô§Âä®ÊÄÅÂõûÂ§çÁä∂ÊÄÅÂπ∂ÈáçÁΩÆËæìÂÖ•Ê°Ü ‚ñº‚ñº‚ñº
        function clearQzoneReplyContext(postContainer) {
            currentQzoneReplyContext = null;
            if (postContainer) {
                // Â∞ÜËæìÂÖ•Ê°ÜÁöÑÂç†‰ΩçÁ¨¶ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ÂÄº
                const input = postContainer.querySelector('.comment-input');
                if (input) {
                    input.placeholder = 'ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ';
                }
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÈÄªËæëÈáçÊûÑÂêé„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ renderMemoriesScreen ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìÂõûÂøÜ‰∏éÁ∫¶ÂÆöÁïåÈù¢Ôºå‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÂíåÊ∏ÖÊô∞ÁöÑif/elseÈÄªËæë
         */
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàÁâà„ÄëËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§ç„ÄëÁöÑÂÆåÊï¥ÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderMemoriesScreen ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìÂõûÂøÜ‰∏éÁ∫¶ÂÆöÁïåÈù¢Ôºå‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÂíåÊ∏ÖÊô∞ÁöÑif/elseÈÄªËæë
         */
        async function renderMemoriesScreen() {
            const listEl = document.getElementById('memories-list');
            listEl.innerHTML = '';
            
            // 1. Ëé∑ÂèñÊâÄÊúâÂõûÂøÜÔºåÂπ∂ÊåâÁõÆÊ†áÊó•ÊúüÔºàÂ¶ÇÊûúÊòØÁ∫¶ÂÆöÔºâÊàñÂàõÂª∫Êó•ÊúüÔºàÂ¶ÇÊûúÊòØÂõûÂøÜÔºâÈôçÂ∫èÊéíÂàó
            const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
            
            if (allMemories.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÂÖ±ÂêåÁöÑÂõûÂøÜÂíåÁ∫¶ÂÆöÂë¢~</p>';
                return;
            }
        
            // 2. Â∞ÜÊú™Âà∞ÊúüÁöÑÁ∫¶ÂÆöÊéíÂú®ÊúÄÂâçÈù¢
            allMemories.sort((a, b) => {
                const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
                const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
                if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aÊéíÂâçÈù¢
                if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bÊéíÂâçÈù¢
                if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // ÈÉΩÊòØÂÄíËÆ°Êó∂ÔºåÊåâÊó•ÊúüÂçáÂ∫è
                return 0; // ÂÖ∂‰ªñÊÉÖÂÜµ‰øùÊåÅÂéüÂ∫è
            });
        
            // 3. „ÄêÊ†∏ÂøÉ„Äë‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÊù•Â§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÂç°Áâá
            allMemories.forEach(item => {
                let card;
                // Âà§Êñ≠1ÔºöÂ¶ÇÊûúÊòØÊ≠£Âú®ËøõË°åÁöÑÁ∫¶ÂÆö
                if (item.type === 'countdown' && item.targetDate > Date.now()) {
                    card = createCountdownCard(item);
                } 
                // Âà§Êñ≠2ÔºöÂÖ∂‰ªñÊâÄÊúâÊÉÖÂÜµÔºàÊôÆÈÄöÂõûÂøÜ Êàñ Â∑≤Âà∞ÊúüÁöÑÁ∫¶ÂÆöÔºâ
                else {
                    card = createMemoryCard(item);
                }
                listEl.appendChild(card);
            });
            
            // 4. ÂêØÂä®ÊâÄÊúâÂÄíËÆ°Êó∂
            startAllCountdownTimers();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * „ÄêÂ∑≤ÈõÜÊàêMarkdown„ÄëÂàõÂª∫ÊôÆÈÄöÂõûÂøÜÂç°ÁâáDOMÂÖÉÁ¥†
         */
        function createMemoryCard(memory) {
            const card = document.createElement('div');
            card.className = 'memory-card';
            const memoryDate = new Date(memory.timestamp);
            const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
            
            let titleHtml, contentHtml;
        
            if (memory.type === 'countdown' && memory.targetDate) {
                titleHtml = `[Á∫¶ÂÆöËææÊàê] ${memory.description}`;
                // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                contentHtml = parseMarkdown(`Âú® ${new Date(memory.targetDate).toLocaleString()}ÔºåÊàë‰ª¨‰∏ÄËµ∑ËßÅËØÅ‰∫ÜËøô‰∏™Á∫¶ÂÆö„ÄÇ`).replace(/\n/g, '<br>');
            } else {
                let authorDisplayName = 'Êàë‰ª¨ÁöÑÂõûÂøÜ';
                if (memory.authorId) {
                    const authorChat = state.chats[memory.authorId];
                    if (authorChat) {
                        authorDisplayName = authorChat.name; 
                    } else {
                        authorDisplayName = memory.authorName || '‰∏Ä‰ΩçÊúãÂèã'; 
                    }
                } else if (memory.authorName) {
                    authorDisplayName = memory.authorName; 
                }
        
                titleHtml = `${authorDisplayName} ÁöÑÊó•ËÆ∞`;
                // ‚ñº‚ñº‚ñº Â∑≤Ê∑ªÂä† Markdown Ëß£Êûê ‚ñº‚ñº‚ñº
                contentHtml = parseMarkdown(memory.description);
            }
        
            card.innerHTML = `
                <div class="header">
                    <div class="date">${dateString}</div>
                    <div class="author">${titleHtml}</div>
                </div>
                <div class="content">${contentHtml}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('Âà†Èô§ËÆ∞ÂΩï', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(memory.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        function createCountdownCard(countdown) {
            const card = document.createElement('div');
            card.className = 'countdown-card';
        
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®‰ΩøÁî®ÂâçÔºåÂÖà‰ªé countdown ÂØπË±°‰∏≠ÂàõÂª∫ targetDate ÂèòÈáè
            const targetDate = new Date(countdown.targetDate);
            
            // Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ΩøÁî® targetDate ‰∫Ü
            const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        
            card.innerHTML = `
                <div class="title">${countdown.description}</div>
                <div class="timer" data-target-date="${countdown.targetDate}">--Â§©--Êó∂--ÂàÜ--Áßí</div>
                <div class="target-date">ÁõÆÊ†áÊó∂Èó¥: ${targetDateString}</div>
            `;
            addLongPressListener(card, async () => {
                const confirmed = await showCustomConfirm('Âà†Èô§Á∫¶ÂÆö', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫¶ÂÆöÂêóÔºü', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.memories.delete(countdown.id);
                    renderMemoriesScreen();
                }
            });
            return card;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÁÆ°ÁêÜÊâÄÊúâÂÄíËÆ°Êó∂
        let activeCountdownTimers = [];
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤ÂΩªÂ∫ï‰øÆÂ§ç„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†‰ª£Á†Å‰∏≠ÊóßÁöÑ startAllCountdownTimers ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function startAllCountdownTimers() {
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÂèØËÉΩÂ≠òÂú®ÁöÑÊóßËÆ°Êó∂Âô®ÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºè
            activeCountdownTimers.forEach(timerId => clearInterval(timerId));
            activeCountdownTimers = [];
        
            document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
                const targetTimestamp = parseInt(timerEl.dataset.targetDate);
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨ÂÖàÁî® let Â£∞Êòé timerId
                let timerId;
        
                const updateTimer = () => {
                    const now = Date.now();
                    const distance = targetTimestamp - now;
        
                    if (distance < 0) {
                        timerEl.textContent = "Á∫¶ÂÆöËææÊàêÔºÅ";
                        // Áé∞Âú® updateTimer ÂèØ‰ª•Ê≠£Á°ÆÂú∞ÊâæÂà∞Âπ∂Ê∏ÖÈô§ÂÆÉËá™Â∑±‰∫Ü
                        clearInterval(timerId);
                        setTimeout(() => renderMemoriesScreen(), 2000);
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerEl.textContent = `${days}Â§© ${hours}Êó∂ ${minutes}ÂàÜ ${seconds}Áßí`;
                };
                
                updateTimer(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°‰ª•ÊòæÁ§∫ÂàùÂßãÂÄíËÆ°Êó∂
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫Â∑≤Â£∞ÊòéÁöÑ timerId ËµãÂÄº
                timerId = setInterval(updateTimer, 1000);
                
                // Â∞ÜÊúâÊïàÁöÑËÆ°Êó∂Âô®IDÂ≠òÂÖ•ÂÖ®Â±ÄÊï∞ÁªÑÔºå‰ª•‰æø‰∏ãÊ¨°Âà∑Êñ∞Êó∂ÂèØ‰ª•Ê∏ÖÈô§
                activeCountdownTimers.push(timerId);
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÁªàÊûÅÂèç‰ª£ÂÖºÂÆπÁâà„ÄëÊõøÊç¢ÊóßÁöÑ triggerAiFriendApplication ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        async function triggerAiFriendApplication(chatId) {
            const chat = state.chats[chatId];
            if (!chat) return;
        
            await showCustomAlert("ÊµÅÁ®ãÂêØÂä®", `Ê≠£Âú®‰∏∫ËßíËâ≤‚Äú${chat.name}‚ÄùÂáÜÂ§áÂ•ΩÂèãÁî≥ËØ∑...`);
        
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                await showCustomAlert("ÈÖçÁΩÆÈîôËØØ", "APIËÆæÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÁªßÁª≠„ÄÇ");
                return;
            }
        
            const contextSummary = chat.history
                .slice(-5)
                .map(msg => {
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');
        
        // ‚ñº‚ñº‚ñº Âú® triggerAiResponse ÂáΩÊï∞‰∏≠ÔºåÁî®‰∏ãÈù¢ËøôÊï¥Âùó‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ‰∏ñÁïå‰π¶Â§ÑÁêÜÈÄªËæë ‚ñº‚ñº‚ñº
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                if (!worldBook || !Array.isArray(worldBook.content)) return '';
        
                const formattedEntries = worldBook.content.map(entry => {
                    let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
                    if (entry.keys.length > 0) {
                        entryString += `**ÂÖ≥ÈîÆËØç:** ${entry.keys.join(', ')}\n`;
                    }
                    entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
                    return entryString;
                }).join('\n');
        
                return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
            }).filter(Boolean).join('');
            
            if (linkedContents) {
                worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†‰πãÂâçË¢´Áî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâÊãâÈªë‰∫ÜÔºå‰Ω†‰ª¨Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâËÅîÁ≥ª‰∫Ü„ÄÇ
        Áé∞Âú®Ôºå‰Ω†ÈùûÂ∏∏Â∏åÊúõËÉΩÂ§üÂíåÂ•ΩÔºåÈáçÊñ∞ÂíåÁî®Êà∑ËÅäÂ§©„ÄÇËØ∑‰Ω†‰ªîÁªÜÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúË¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å‚ÄùÔºåÁêÜËß£ÂΩìÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊÄùËÄÉ‰∏Ä‰∏™ÁúüËØöÁöÑ„ÄÅÁ¨¶Âêà‰Ω†‰∫∫ËÆæ„ÄÅÂπ∂‰∏î„ÄêÈíàÂØπÂÖ∑‰Ωì‰∫ã‰ª∂„ÄëÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        ${worldBookContent}
        # Ë¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å (ËøôÊòØ‰Ω†Ë¢´ÊãâÈªëÁöÑÂÖ≥ÈîÆÂéüÂõ†)
        ${contextSummary}
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        \`\`\`json
        {
          "decision": "apply",
          "reason": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑ„ÄÅÁúüËØöÁöÑ„ÄÅÊúâÈíàÂØπÊÄßÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ"
        }
        \`\`\`
        `;
        
            try {
                // ‚òÖ‚òÖ‚òÖ FIX: Combine systemPrompt with messagesForApi ‚òÖ‚òÖ‚òÖ
                const messagesForApi = [
                    {role: 'system', content: systemPrompt},
                    {role: 'user', content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÂºÄÂßã‰Ω†ÁöÑÂÜ≥Á≠ñ„ÄÇ"} // A simple trigger message
                ];
        
                let  isGemini = proxyUrl === GEMINI_API_URL;
                let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
        
                const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                    body: JSON.stringify({
                        model: model,
                        messages: messagesForApi, // Send the combined messages
                        temperature: 0.9,
                    })
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
                }
        
                const data = await response.json();
                let rawContent = isGemini? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
                const cleanedContent = rawContent.trim();
                const responseObj = JSON.parse(cleanedContent);
        
                if (responseObj.decision === 'apply' && responseObj.reason) {
                    chat.relationship.status = 'pending_user_approval';
                    chat.relationship.applicationReason = responseObj.reason;
                    state.chats[chatId] = chat; 
                    renderChatList();
                    await showCustomAlert("Áî≥ËØ∑ÊàêÂäüÔºÅ", `‚Äú${chat.name}‚ÄùÂ∑≤Âêë‰Ω†ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇËØ∑ËøîÂõûËÅäÂ§©ÂàóË°®Êü•Áúã„ÄÇ`);
                } else {
                    await showCustomAlert("AIÂÜ≥Á≠ñ", `‚Äú${chat.name}‚ÄùÊÄùËÄÉÂêéÂÜ≥ÂÆöÊöÇÊó∂‰∏çÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
                    chat.relationship.status = 'blocked_by_user';
                    chat.relationship.blockedTimestamp = Date.now(); 
                }
            } catch (error) {
                await showCustomAlert("ÊâßË°åÂá∫Èîô", `‰∏∫‚Äú${chat.name}‚ÄùÁî≥ËØ∑Â•ΩÂèãÊó∂ÂèëÁîüÈîôËØØÔºö\n\n${error.message}\n\nÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now(); 
            } finally {
                await db.chats.put(chat);
                renderChatInterface(chatId);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÂÜ≥ÂÆöÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™óËøòÊòØÁ∫¢ÂåÖÂºπÁ™ó
         */
        function handlePaymentButtonClick() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (chat.isGroup) {
                openRedPacketModal();
            } else {
                // ÂçïËÅä‰øùÊåÅÂéüÊ†∑ÔºåÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™ó
                document.getElementById('transfer-modal').classList.add('visible');
            }
        }
        
        /**
         * ÊâìÂºÄÂπ∂ÂàùÂßãÂåñÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü
         */
        function openRedPacketModal() {
            const modal = document.getElementById('red-packet-modal');
            const chat = state.chats[state.activeChatId];
            
            // Ê∏ÖÁêÜËæìÂÖ•Ê°Ü
            document.getElementById('rp-group-amount').value = '';
            document.getElementById('rp-group-count').value = '';
            document.getElementById('rp-group-greeting').value = '';
            document.getElementById('rp-direct-amount').value = '';
            document.getElementById('rp-direct-greeting').value = '';
            document.getElementById('rp-group-total').textContent = '¬• 0.00';
            document.getElementById('rp-direct-total').textContent = '¬• 0.00';
        
            // Â°´ÂÖÖ‰∏ìÂ±ûÁ∫¢ÂåÖÁöÑÊé•Êî∂‰∫∫ÂàóË°®
            const receiverSelect = document.getElementById('rp-direct-receiver');
            receiverSelect.innerHTML = '';
        // ‚ñº‚ñº‚ñº Â∞ÜÂÖ∂„ÄêÊõøÊç¢‰∏∫„Äë‰∏ãÈù¢ËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„Äë‚ñº‚ñº‚ñº
        chat.members.forEach(member => {
            const option = document.createElement('option');
            // Ê†∏ÂøÉ‰øÆÊ≠£Ôºö‰ΩøÁî® originalName ‰Ωú‰∏∫ÂÄºÔºågroupNickname ‰Ωú‰∏∫ÊòæÁ§∫ÊñáÊú¨
            option.value = member.originalName;
            option.textContent = member.groupNickname; 
            receiverSelect.appendChild(option);
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            
            // ÈªòËÆ§ÊòæÁ§∫ÊãºÊâãÊ∞îÁ∫¢ÂåÖÈ°µÁ≠æ
            document.getElementById('rp-tab-group').click();
            
            modal.classList.add('visible');
        }
        
        /**
         * ÂèëÈÄÅÁæ§Á∫¢ÂåÖÔºàÊãºÊâãÊ∞îÔºâ
         */
        async function sendGroupRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-group-amount').value);
            const count = parseInt(document.getElementById('rp-group-count').value);
            const greeting = document.getElementById('rp-group-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊÄªÈáëÈ¢ùÔºÅ"); return;
            }
            if (isNaN(count) || count <= 0) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ∫¢ÂåÖ‰∏™Êï∞ÔºÅ"); return;
            }
            if (amount / count < 0.01) {
                alert("Âçï‰∏™Á∫¢ÂåÖÈáëÈ¢ù‰∏çËÉΩÂ∞ë‰∫é0.01ÂÖÉÔºÅ"); return;
            }
        
            const myNickname = chat.settings.myNickname || 'Êàë';
            
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
                timestamp: Date.now(),
                totalAmount: amount,
                count: count,
                greeting: greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ',
                claimedBy: {}, // { name: amount }
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
            
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        /**
         * ÂèëÈÄÅ‰∏ìÂ±ûÁ∫¢ÂåÖ
         */
        async function sendDirectRedPacket() {
            const chat = state.chats[state.activeChatId];
            const amount = parseFloat(document.getElementById('rp-direct-amount').value);
            const receiverName = document.getElementById('rp-direct-receiver').value;
            const greeting = document.getElementById('rp-direct-greeting').value.trim();
        
            if (isNaN(amount) || amount <= 0) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ"); return;
            }
            if (!receiverName) {
                alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êé•Êî∂‰∫∫ÔºÅ"); return;
            }
            
            const myNickname = chat.settings.myNickname || 'Êàë';
        
            const newPacket = {
                role: 'user',
                senderName: myNickname,
                type: 'red_packet',
                packetType: 'direct',
                timestamp: Date.now(),
                totalAmount: amount,
                count: 1,
                greeting: greeting || 'Áªô‰Ω†ÂáÜÂ§á‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ',
                receiverName: receiverName, // Ê†∏ÂøÉÂ≠óÊÆµ
                claimedBy: {},
                isFullyClaimed: false,
            };
            
            chat.history.push(newPacket);
            await db.chats.put(chat);
        
            appendMessage(newPacket, chat);
            renderChatList();
            document.getElementById('red-packet-modal').classList.remove('visible');
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ | V4 - ÊµÅÁ®ãÈáçÊûÑÁâà„ÄëËØ∑Áî®Ê≠§ÂáΩÊï∞ÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handlePacketClick ‚ñº‚ñº‚ñº
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÂΩìÁî®Êà∑ÁÇπÂáªÁ∫¢ÂåÖÂç°ÁâáÊó∂Ëß¶Âèë
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        async function handlePacketClick(timestamp) {
            const currentChatId = state.activeChatId;
            // ‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑËÅäÂ§©Êï∞ÊçÆÔºåÁ°Æ‰øùÁä∂ÊÄÅÊòØÊúÄÊñ∞ÁöÑ
            const freshChat = await db.chats.get(currentChatId);
            if (!freshChat) return;
        
            // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑ state
            state.chats[currentChatId] = freshChat;
            const packet = freshChat.history.find(m => m.timestamp === timestamp);
            if (!packet) return;
            
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            const hasClaimed = packet.claimedBy && packet.claimedBy[myOriginalName];
        
            // --- Ê≠•È™§1: Âà§Êñ≠ÊòØÂê¶Âè™ËÉΩ‚ÄúÊü•ÁúãËØ¶ÊÉÖ‚Äù ---
            // Â¶ÇÊûúÊòØ‰∏ìÂ±ûÁ∫¢ÂåÖ‰ΩÜ‰∏çÊòØÁªôÊàëÁöÑÔºåÊàñËÄÖÁ∫¢ÂåÖÂ∑≤È¢ÜÂÆåÔºåÊàñËÄÖÊàëÂ∑≤ÁªèÈ¢ÜËøá‰∫ÜÔºåÂ∞±Áõ¥Êé•ÊòæÁ§∫ËØ¶ÊÉÖÂπ∂ÁªìÊùü„ÄÇ
            if ((packet.packetType === 'direct' && packet.receiverName !== myOriginalName && Object.keys(packet.claimedBy).length > 0) || packet.isFullyClaimed || hasClaimed) {
                showRedPacketDetails(packet);
                return; // <---  „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÁÇπÔºÅ„Äë„Äë„Äë ËøôË°å return Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ
            }
            
            // --- Ê≠•È™§2: ÊâßË°å‚ÄúÈ¢ÜÂèñ‚ÄùÊìç‰Ωú ---
            const claimedAmount = await handleOpenRedPacket(packet);
            
            // --- Ê≠•È™§3: Âú®‚ÄúÈ¢ÜÂèñ‚ÄùÊàêÂäüÂêéÔºåÊåâÈ°∫Â∫èÊâßË°åÂêéÁª≠Êìç‰Ωú ---
            if (claimedAmount !== null) {
                // a. ÂÖàÂú®ÂêéÂè∞ÈªòÈªòÂú∞Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢ÔºåËÆ©Á∫¢ÂåÖÂç°ÁâáÁä∂ÊÄÅÂèò‰∏∫‚ÄúÂ∑≤È¢ÜÂèñ‚Äù
                await renderChatInterface(currentChatId);
                
                // b. ÂºπÂá∫‚ÄúÊÅ≠Âñú‚ÄùÊèêÁ§∫Ê°ÜÔºåÁ≠âÂæÖÁî®Êà∑ÁÇπÂáª‚ÄúÂ•ΩÁöÑ‚Äù
                await showCustomAlert("ÊÅ≠ÂñúÔºÅ", `‰Ω†È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(freshChat, packet.senderName)} ÁöÑÁ∫¢ÂåÖÔºåÈáëÈ¢ù‰∏∫ ${claimedAmount.toFixed(2)} ÂÖÉ„ÄÇ`);
            }
        
            // --- Ê≠•È™§4: Êó†ËÆ∫È¢ÜÂèñÊàêÂäü‰∏éÂê¶ÔºåÊúÄÂêéÈÉΩÊòæÁ§∫ËØ¶ÊÉÖÈ°µ ---
            // Ê≠§Êó∂ÈúÄË¶Å‰ªé state ‰∏≠Ëé∑ÂèñÊúÄÊñ∞ÁöÑ packet ÂØπË±°ÔºåÂõ†‰∏∫ÂÆÉÂèØËÉΩÂú® handleOpenRedPacket ‰∏≠Ë¢´Êõ¥Êñ∞‰∫Ü
            const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
            if (updatedPacket) {
                showRedPacketDetails(updatedPacket);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handleOpenRedPacket ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊ†∏ÂøÉ„ÄëÂ§ÑÁêÜÁî®Êà∑ÊâìÂºÄÁ∫¢ÂåÖÁöÑÈÄªËæë (V5 - Â∑≤‰øÆÂ§çÊó∂Èó¥Êà≥BUG)
         */
        async function handleOpenRedPacket(packet) {
            const chat = state.chats[state.activeChatId];
            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ÂáΩÊï∞ÂºÄÂßãÊó∂ÔºåËé∑Âèñ‰∏Ä‰∏™Âü∫Á°ÄÊó∂Èó¥Êà≥ ‚ñº‚ñº‚ñº
            let timestamp = Date.now(); 
        
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
            if (remainingCount <= 0) {
                packet.isFullyClaimed = true;
                await db.chats.put(chat);
                await showCustomAlert("ÊâãÊÖ¢‰∫Ü", "Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºÅ");
                return null;
            }
            
            let claimedAmount = 0;
            const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            if (packet.packetType === 'lucky') {
                if (remainingCount === 1) { claimedAmount = remainingAmount; }
                else {
                    const min = 0.01;
                    const max = remainingAmount - (remainingCount - 1) * min;
                    claimedAmount = Math.random() * (max - min) + min;
                }
            } else { claimedAmount = packet.totalAmount; }
            claimedAmount = parseFloat(claimedAmount.toFixed(2));
        
            if (!packet.claimedBy) packet.claimedBy = {};
            packet.claimedBy[myOriginalName] = claimedAmount;
            
            const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
            if (isNowFullyClaimed) {
                packet.isFullyClaimed = true;
            }
        
            const myDisplayName = getDisplayNameInGroup(chat, myOriginalName);
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
        
            const visibleMessage = { 
                role: 'system', 
                type: 'pat_message', 
                content: `‰Ω†È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`, 
                // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç2Ôºö‰ΩøÁî®Êàë‰ª¨Á¥ØÂä†ÁöÑÊó∂Èó¥Êà≥ ‚ñº‚ñº‚ñº
                timestamp: timestamp++ 
            };
            chat.history.push(visibleMessage);
        
            let hiddenMessageContent;
            if (isNowFullyClaimed) {
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                    // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç3ÔºöÁªßÁª≠Á¥ØÂä†Êó∂Èó¥Êà≥ ‚ñº‚ñº‚ñº
                    timestamp: timestamp++ 
                };
                chat.history.push(finishedMessage);
        
                let luckyKing = { name: '', amount: -1 };
                if (packet.packetType === 'lucky' && packet.count > 1) {
                    Object.entries(packet.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                const luckyKingDisplayName = luckyKing.name ? getDisplayNameInGroup(chat, luckyKing.name) : 'Êó†';
                hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) È¢ÜÂèñ‰∫ÜÊúÄÂêé‰∏Ä‰∏™Á∫¢ÂåÖ„ÄÇÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅËØ∑ÂØπÊ≠§‰∫ã‰ª∂ÂèëË°®ËØÑËÆ∫„ÄÇ]`;
        
            } else {
                hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) ÂàöÂàöÈ¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${packet.timestamp})„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•Â∞ùËØïÈ¢ÜÂèñ„ÄÇ]`;
            }
        
            const hiddenMessage = { 
                role: 'system', 
                content: hiddenMessageContent, 
                // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç4Ôºö‰∏∫ÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ‰πü‰ΩøÁî®Á¥ØÂä†ÁöÑÊó∂Èó¥Êà≥ ‚ñº‚ñº‚ñº
                timestamp: timestamp++, 
                isHidden: true 
            };
            chat.history.push(hiddenMessage);
        
            await db.chats.put(chat);
            
            return claimedAmount;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊòæÁ§∫Á∫¢ÂåÖÈ¢ÜÂèñËØ¶ÊÉÖÁöÑÊ®°ÊÄÅÊ°Ü (V4 - Â∑≤‰øÆÂ§çÂèÇÊï∞ÈîôËØØ) ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂ∑≤‰øÆÂ§ç„ÄëÊòæÁ§∫Á∫¢ÂåÖÈ¢ÜÂèñËØ¶ÊÉÖÁöÑÊ®°ÊÄÅÊ°Ü
         * @param {object} packet - ÂÆåÊï¥ÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÂØπË±°
         */
        async function showRedPacketDetails(packet) {
            if (!packet) {
                console.error("showRedPacketDetailsÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑpacketÂØπË±°");
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const modal = document.getElementById('red-packet-details-modal');
            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ËøôÈáåÔºåÊàë‰ª¨ÂêåÊ†∑‰ΩøÁî®‚ÄúÊú¨Âêç‚ÄùÊù•Ê£ÄÊü• ‚ñº‚ñº‚ñº
            const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
            
            const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
            document.getElementById('rp-details-sender').textContent = senderDisplayName;
            document.getElementById('rp-details-greeting').textContent = packet.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ';
            
            const myAmountEl = document.getElementById('rp-details-my-amount');
            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç2ÔºöÁî®‚ÄúÊú¨Âêç‚ÄùÊù•Êü•ÊâæÊàëÈ¢ÜÂèñÁöÑÈáëÈ¢ù ‚ñº‚ñº‚ñº
            if (packet.claimedBy && packet.claimedBy[myOriginalName]) {
                myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myOriginalName].toFixed(2);
                myAmountEl.style.display = 'block';
            } else {
                myAmountEl.style.display = 'none';
            }
        
            const claimedCount = Object.keys(packet.claimedBy || {}).length;
            const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            let summaryText = `${claimedCount}/${packet.count}‰∏™Á∫¢ÂåÖÔºåÂÖ±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}ÂÖÉ„ÄÇ`;
            if (!packet.isFullyClaimed && claimedCount < packet.count) {
                const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
                if(timeLeft > 0) summaryText += ` Ââ©‰ΩôÁ∫¢ÂåÖÂ∞ÜÂú®${timeLeft}Â∞èÊó∂ÂÜÖÈÄÄËøò„ÄÇ`;
            }
            document.getElementById('rp-details-summary').textContent = summaryText;
        
            const listEl = document.getElementById('rp-details-list');
            listEl.innerHTML = '';
            const claimedEntries = Object.entries(packet.claimedBy || {});
            
            let luckyKing = { name: '', amount: -1 };
            if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
                claimedEntries.forEach(([name, amount]) => {
                    if (amount > luckyKing.amount) {
                        luckyKing = { name, amount };
                    }
                });
            }
        
            claimedEntries.sort((a,b) => b[1] - a[1]);
        
            claimedEntries.forEach(([originalName, amount]) => {
                const item = document.createElement('div');
                item.className = 'rp-details-item';
                let luckyTag = '';
                if (luckyKing.name && originalName === luckyKing.name) {
                    luckyTag = '<span class="lucky-king-tag">ÊâãÊ∞îÁéã</span>';
                }
                
                // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÂ§ç3ÔºöÂ∞ÜÊâÄÊúâÈ¢ÜÂèñËÄÖÁöÑ‚ÄúÊú¨Âêç‚ÄùÈÉΩËΩ¨Êç¢‰∏∫Ê≠£Á°ÆÁöÑ‚ÄúÊòæÁ§∫ÂêçÁß∞‚Äù ‚ñº‚ñº‚ñº
                const claimerDisplayName = getDisplayNameInGroup(chat, originalName);
        
                item.innerHTML = `
                    <span class="name">${claimerDisplayName}</span>
                    <span class="amount">${amount.toFixed(2)} ÂÖÉ</span>
                    ${luckyTag}
                `;
                listEl.appendChild(item);
            });
        
            modal.classList.add('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ÁªëÂÆöÂÖ≥Èó≠ËØ¶ÊÉÖÊåâÈíÆÁöÑ‰∫ã‰ª∂
        document.getElementById('close-rp-details-btn').addEventListener('click', () => {
            document.getElementById('red-packet-details-modal').classList.remove('visible');
        });
        
        // ‰æõÂÖ®Â±ÄË∞ÉÁî®ÁöÑÂáΩÊï∞Ôºå‰ª•‰æøÁ∫¢ÂåÖÂç°Áâá‰∏äÁöÑ onclick ËÉΩÊâæÂà∞ÂÆÉ
        window.handlePacketClick = handlePacketClick;
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄÂàõÂª∫ÊäïÁ•®ÁöÑÊ®°ÊÄÅÊ°ÜÂπ∂ÂàùÂßãÂåñ
         */
        function openCreatePollModal() {
            const modal = document.getElementById('create-poll-modal');
            document.getElementById('poll-question-input').value = '';
            const optionsContainer = document.getElementById('poll-options-container');
            optionsContainer.innerHTML = '';
            
            // ÈªòËÆ§ÂàõÂª∫‰∏§‰∏™Á©∫ÁöÑÈÄâÈ°πÊ°Ü
            addPollOptionInput();
            addPollOptionInput();
            
            modal.classList.add('visible');
        }
        
        /**
         * Âú®Ê®°ÊÄÅÊ°Ü‰∏≠Âä®ÊÄÅÊ∑ªÂä†‰∏Ä‰∏™ÈÄâÈ°πËæìÂÖ•Ê°Ü
         */
        function addPollOptionInput() {
            const container = document.getElementById('poll-options-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'poll-option-input-wrapper';
            wrapper.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="ÈÄâÈ°πÂÜÖÂÆπ...">
                <button class="remove-option-btn">-</button>
            `;
            
            wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
                // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏§‰∏™ÈÄâÈ°π
                if (container.children.length > 2) {
                    wrapper.remove();
                } else {
                    alert('ÊäïÁ•®Ëá≥Â∞ëÈúÄË¶Å2‰∏™ÈÄâÈ°π„ÄÇ');
                }
            });
            
            container.appendChild(wrapper);
        }
        
        /**
         * Áî®Êà∑Á°ÆËÆ§ÂèëËµ∑ÊäïÁ•®
         */
        async function sendPoll() {
            if (!state.activeChatId) return;
            
            const question = document.getElementById('poll-question-input').value.trim();
            if (!question) {
                alert('ËØ∑ËæìÂÖ•ÊäïÁ•®ÈóÆÈ¢òÔºÅ');
                return;
            }
            
            const options = Array.from(document.querySelectorAll('.poll-option-input'))
                .map(input => input.value.trim())
                .filter(text => text); // ËøáÊª§ÊéâÁ©∫ÁöÑÈÄâÈ°π
        
            if (options.length < 2) {
                alert('ËØ∑Ëá≥Â∞ëËæìÂÖ•2‰∏™ÊúâÊïàÁöÑÊäïÁ•®ÈÄâÈ°πÔºÅ');
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            
            const newPollMessage = {
                role: 'user',
                senderName: myNickname,
                type: 'poll',
                timestamp: Date.now(),
                question: question,
                options: options,
                votes: {}, // ÂàùÂßãÊäïÁ•®‰∏∫Á©∫
                isClosed: false,
            };
            
            chat.history.push(newPollMessage);
            await db.chats.put(chat);
            
            appendMessage(newPollMessage, chat);
            renderChatList();
            
            document.getElementById('create-poll-modal').classList.remove('visible');
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈáçÂ§çÁÇπÂáªÈóÆÈ¢ò„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ handleUserVote ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @param {string} choice - Áî®Êà∑ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨
         */
        async function handleUserVote(timestamp, choice) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
        
            // 1. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûúÊäïÁ•®‰∏çÂ≠òÂú®ÊàñÂ∑≤ÂÖ≥Èó≠ÔºåÁõ¥Êé•ËøîÂõû
            if (!poll || poll.isClosed) {
                // Â¶ÇÊûúÊòØÂ∑≤ÂÖ≥Èó≠ÁöÑÊäïÁ•®ÔºåÂàôÁõ¥Êé•ÊòæÁ§∫ÁªìÊûú
                if (poll && poll.isClosed) {
                    showPollResults(timestamp);
                }
                return;
            }
        
            // 2. Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÁÇπÂáª‰∫ÜÂ∑≤ÁªèÊäïËøáÁöÑÂêå‰∏Ä‰∏™ÈÄâÈ°π
            const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
            
            // 3. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûú‰∏çÊòØÈáçÂ§çÁÇπÂáªÔºåÊâçÊâßË°åÊäïÁ•®ÈÄªËæë
            if (!isReclickingSameOption) {
                // ÁßªÈô§ÊóßÊäïÁ•®ÔºàÂ¶ÇÊûúÁî®Êà∑ÊîπÈÄâÔºâ
                for (const option in poll.votes) {
                    const voterIndex = poll.votes[option].indexOf(myNickname);
                    if (voterIndex > -1) {
                        poll.votes[option].splice(voterIndex, 1);
                    }
                }
                // Ê∑ªÂä†Êñ∞ÊäïÁ•®
                if (!poll.votes[choice]) {
                    poll.votes[choice] = [];
                }
                poll.votes[choice].push(myNickname);
            }
            
            // 4. „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÁé∞Âú®Âè™Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®‰∫ã‰ª∂Ôºå‰∏çÂÜçÊ£ÄÊü•ÊòØÂê¶ÁªìÊùü
            let hiddenMessageContent = null; 
            
            // Âè™ÊúâÂú®Áî®Êà∑ÁúüÊ≠£ÊäïÁ•®ÊàñÊîπÁ•®Êó∂ÔºåÊâçÁîüÊàêÊèêÁ§∫
            if (!isReclickingSameOption) {
                 hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÊäïÁ•®Áªô‰∫Ü ‚Äú${choice}‚Äù„ÄÇ]`;
            }
        
            // 5. Â¶ÇÊûúÊúâÈúÄË¶ÅÈÄöÁü•AIÁöÑ‰∫ã‰ª∂ÔºåÂàôÂàõÂª∫Âπ∂Ê∑ªÂä†ÈöêËóèÊ∂àÊÅØ
            if (hiddenMessageContent) {
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
            }
            
            // 6. ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId); 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Áî®Êà∑ÁªìÊùüÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        async function endPoll(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || poll.isClosed) return;
        
            const confirmed = await showCustomConfirm("ÁªìÊùüÊäïÁ•®", "Á°ÆÂÆöË¶ÅÁªìÊùüËøô‰∏™ÊäïÁ•®ÂêóÔºüÁªìÊùüÂêéÂ∞ÜÊó†Ê≥ïÂÜçËøõË°åÊäïÁ•®„ÄÇ");
            if (confirmed) {
                poll.isClosed = true;
        
                const resultSummary = poll.options.map(opt => `‚Äú${opt}‚Äù(${poll.votes[opt]?.length || 0}Á•®)`).join('Ôºå');
                const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâãÂä®ÁªìÊùü‰∫ÜÊäïÁ•®ÔºÅÊúÄÁªàÁªìÊûú‰∏∫Ôºö${resultSummary}„ÄÇ]`;
                
                const hiddenMessage = {
                    role: 'system',
                    content: hiddenMessageContent,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
        
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂè™‰øùÂ≠òÊï∞ÊçÆÂíåÊõ¥Êñ∞UIÔºå‰∏çË∞ÉÁî® triggerAiResponse()
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÊòæÁ§∫ÊäïÁ•®ÁªìÊûúËØ¶ÊÉÖ
         * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§ç„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ showPollResults ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function showPollResults(timestamp) {
            const chat = state.chats[state.activeChatId];
            const poll = chat.history.find(m => m.timestamp === timestamp);
            if (!poll || !poll.isClosed) return;
        
            let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
            
            if (Object.keys(poll.votes).length === 0) {
                resultsHtml += '<p style="color: #8a8a8a;">ËøòÊ≤°Êúâ‰∫∫ÊäïÁ•®„ÄÇ</p>';
            } else {
                poll.options.forEach(option => {
                    const voters = poll.votes[option] || [];
                    
                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåËΩ¨Êç¢ voter ÁöÑÊú¨Âêç‰∏∫Áæ§ÊòµÁß∞
                    const displayVoters = voters.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');
        
                    resultsHtml += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}Á•®)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ${voters.length > 0 ? displayVoters : 'Êó†‰∫∫ÊäïÁ•®'}
                            </p>
                        </div>
                    `;
                });
            }
        
            showCustomAlert("ÊäïÁ•®ÁªìÊûú", resultsHtml);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄAIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function openAiAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('ai-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
            renderAiAvatarLibrary();
            document.getElementById('ai-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * Ê∏≤ÊüìAIÂ§¥ÂÉèÂ∫ìÁöÑÂÜÖÂÆπ
         */
        function renderAiAvatarLibrary() {
            const grid = document.getElementById('ai-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.aiAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // Â§çÁî®Ë°®ÊÉÖÈù¢ÊùøÁöÑÊ†∑Âºè
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.style.display = 'block'; // ÊÄªÊòØÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.aiAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderAiAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ addAvatarToLibrary / addAvatarToLibraryFromURL ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÂëΩÂêçÂêé„ÄëÂêëÂΩìÂâçAIÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠ÈÄöËøáURLÊ∑ªÂä†Êñ∞Â§¥ÂÉè
         */
        async function addAvatarToLibraryFromURL() {
            const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.aiAvatarLibrary) {
                chat.settings.aiAvatarLibrary = [];
            }
        
            chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderAiAvatarLibrary();
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÂÖ≥Èó≠AIÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function closeAiAvatarLibraryModal() {
            document.getElementById('ai-avatar-library-modal').classList.remove('visible');
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄ‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function openMyAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('my-avatar-library-title').textContent = `‚Äú${chat.settings.myNickname || 'Êàë'}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
            renderMyAvatarLibrary();
            document.getElementById('my-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * Ê∏≤Êüì‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÁöÑÂÜÖÂÆπ
         */
        function renderMyAvatarLibrary() {
            const grid = document.getElementById('my-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.myAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // Â§çÁî®Ë°®ÊÉÖÈù¢ÊùøÁöÑÊ†∑Âºè
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.style.display = 'block'; // ÊÄªÊòØÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªé‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.myAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderMyAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        /**
         * Âêë‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ì‰∏≠ÈÄöËøáURLÊ∑ªÂä†Êñ∞Â§¥ÂÉè
         */
        async function addAvatarToMyLibraryFromURL() {
            const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
        
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderMyAvatarLibrary();
        }
        
        /**
         * Â§ÑÁêÜÊú¨Âú∞‰∏ä‰º†Â§¥ÂÉèÂà∞‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ì
         */
        async function handleLocalMyAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            const base64Url = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        
            const name = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÂëΩÂêç");
            if (!name || !name.trim()) return;
        
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.myAvatarLibrary) {
                chat.settings.myAvatarLibrary = [];
            }
            chat.settings.myAvatarLibrary.push({ name: name.trim(), url: base64Url });
            
            await db.chats.put(chat);
            renderMyAvatarLibrary();
            event.target.value = null; // Ê∏ÖÁ©∫‰ª•‰æø‰∏ãÊ¨°ÈÄâÊã©
        }
        
        /**
         * ÊâπÈáèÂØºÂÖ•Â§¥ÂÉèÂà∞‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ì
         */
        async function handleBatchImportForMyAvatar(text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) continue;
                
                let name = null, code = null;
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                if (name && code && code.includes('.')) {
                    newAvatars.push({ name: name, url: baseUrl + code });
                } else {
                    errorCount++;
                }
            }
        
            if (errorCount > 0) await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ`);
            
            if (newAvatars.length > 0) {
                if (!chat.settings.myAvatarLibrary) chat.settings.myAvatarLibrary = [];
                chat.settings.myAvatarLibrary.push(...newAvatars);
                await db.chats.put(chat);
                renderMyAvatarLibrary();
                await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
            } else if (errorCount === 0) {
                alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇ");
            }
        }
        
        /**
         * ÂÖ≥Èó≠‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function closeMyAvatarLibraryModal() {
            document.getElementById('my-avatar-library-modal').classList.remove('visible');
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§Â§¥ÂÉèÂ∫ìÁÆ°ÁêÜÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄÁæ§Â§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function openGroupAvatarLibraryModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            document.getElementById('group-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
            renderGroupAvatarLibrary();
            document.getElementById('group-avatar-library-modal').classList.add('visible');
        }
        
        /**
         * Ê∏≤ÊüìÁæ§Â§¥ÂÉèÂ∫ìÁöÑÂÜÖÂÆπ
         */
        function renderGroupAvatarLibrary() {
            const grid = document.getElementById('group-avatar-library-grid');
            grid.innerHTML = '';
            const chat = state.chats[state.activeChatId];
            const library = chat.settings.groupAvatarLibrary || [];
        
            if (library.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
                return;
            }
        
            library.forEach((avatar, index) => {
                const item = document.createElement('div');
                item.className = 'sticker-item'; // Â§çÁî®Ë°®ÊÉÖÈù¢ÊùøÁöÑÊ†∑Âºè
                item.style.backgroundImage = `url(${avatar.url})`;
                item.title = avatar.name;
        
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.style.display = 'block'; // ÊÄªÊòØÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        chat.settings.groupAvatarLibrary.splice(index, 1);
                        await db.chats.put(chat);
                        renderGroupAvatarLibrary();
                    }
                };
                item.appendChild(deleteBtn);
                grid.appendChild(item);
            });
        }
        
        /**
         * ÂêëÂΩìÂâçÁæ§ËÅäÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Ê∑ªÂä†Êñ∞Â§¥ÂÉè
         */
        async function addAvatarToGroupLibraryFromUR() {
            const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        /**
         * ÂÖ≥Èó≠Áæ§Â§¥ÂÉèÂ∫ìÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        function closeGroupAvatarLibraryModal() {
            document.getElementById('group-avatar-library-modal').classList.remove('visible');
        }
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊâπÈáèÂØºÂÖ•Â§¥ÂÉèÁöÑÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊâìÂºÄÊâπÈáèÂØºÂÖ•ÁöÑÂºπÁ™ó
         * @param {string} type - ÂØºÂÖ•Á±ªÂûã, 'ai' Êàñ 'group'
         */
        async function openBatchImportModal(type) {
            const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;
            
            // Â§çÁî®Êàë‰ª¨Âº∫Â§ßÁöÑËá™ÂÆö‰πâËæìÂÖ•Ê°ÜÂáΩÊï∞
            const pastedText = await showCustomPrompt(
                'ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè',
                placeholderText,
                '',
                'textarea' // ‰ΩøÁî®Â§öË°åÊñáÊú¨Ê°Ü
            );
        
            // Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‚ÄúÁ°ÆÂÆö‚Äù
            if (pastedText && pastedText.trim()) {
                await handleBatchImport(type, pastedText);
            }
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handleBatchImport ‚ñº‚ñº‚ñº
        /**
         * „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÂ§ÑÁêÜÁ≤òË¥¥ÁöÑÊñáÊú¨ÔºåËß£ÊûêÂπ∂Â≠òÂÖ•Êï∞ÊçÆÂ∫ì (V4 - ÁªàÊûÅÊô∫ËÉΩÁâà)
         * @param {string} type - ÂØºÂÖ•Á±ªÂûã, 'ai' Êàñ 'group'
         * @param {string} text - Áî®Êà∑Á≤òË¥¥ÁöÑÊñáÊú¨ÂÜÖÂÆπ
         */
        async function handleBatchImport(type, text) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const lines = text.trim().split('\n');
            const newAvatars = [];
            const baseUrl = 'https://files.catbox.moe/';
            let errorCount = 0;
        
            for (const line of lines) {
                const trimmedLine = line.trim();
        
                if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) {
                    continue; 
                }
        
                let name = null;
                let code = null;
        
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                //            ËøôÂ∞±ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÊâÄÂú®ÔºÅ
                //  ÂÖ®Êñ∞ÁöÑ„ÄÅËÉΩÂêåÊó∂Â§ÑÁêÜ‚ÄúÊúâÁ©∫Ê†º‚ÄùÂíå‚ÄúÊó†Á©∫Ê†º‚Äù‰∏§ÁßçÊ†ºÂºèÁöÑËß£ÊûêÈÄªËæë
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        
                // Ê≠•È™§1ÔºöÂ∞ùËØïÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖç ‚Äú‰∏≠ÊñáÂêç+Ëã±Êñá‰ª£Á†Å‚Äù ÁöÑÊó†Á©∫Ê†ºÊ†ºÂºè
                const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);
                
                if (noSpaceMatch) {
                    // Â¶ÇÊûúÂåπÈÖçÊàêÂäüÔºåÁõ¥Êé•ÊèêÂèñ
                    name = noSpaceMatch[1];
                    code = noSpaceMatch[2];
                } else {
                    // Ê≠•È™§2ÔºöÂ¶ÇÊûúÊ≠£ÂàôÂåπÈÖçÂ§±Ë¥•ÔºåÂ∞±ÂõûÈÄÄÂà∞‰πãÂâçÊåâÁ©∫Ê†ºÂàÜÂâ≤ÁöÑÈÄªËæë
                    const parts = trimmedLine.split(/\s+/);
                    if (parts.length >= 2) {
                        code = parts.pop();
                        name = parts.join(' ');
                    }
                }
        
                // Ê≠•È™§3ÔºöÊúÄÂêéÈ™åËØÅËß£ÊûêÁªìÊûúÊòØÂê¶ÊúâÊïà
                if (name && code && code.includes('.')) {
                    newAvatars.push({
                        name: name,
                        url: baseUrl + code
                    });
                } else {
                    errorCount++;
                    console.warn('ÊâπÈáèÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                }
            }
        
            if (errorCount > 0) {
                await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Á≥ªÁªüË∑≥Ëøá„ÄÇ`);
            }
        
            if (newAvatars.length > 0) {
                if (type === 'ai') {
                    if (!chat.settings.aiAvatarLibrary) chat.settings.aiAvatarLibrary = [];
                    chat.settings.aiAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderAiAvatarLibrary();
                } else if (type === 'group') {
                    if (!chat.settings.groupAvatarLibrary) chat.settings.groupAvatarLibrary = [];
                    chat.settings.groupAvatarLibrary.push(...newAvatars);
                    await db.chats.put(chat);
                    renderGroupAvatarLibrary();
                }
                await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
            } else if (errorCount === 0) {
                alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®Á≤òË¥¥ÁöÑÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊÇ®Áº∫Â§±ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Á≤òË¥¥Âú®ËøôÈáå„Äë ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈáçÂëΩÂêçÂêé„ÄëÂêëÂΩìÂâçÁæ§ËÅäÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠ÈÄöËøáURLÊ∑ªÂä†Êñ∞Â§¥ÂÉè
         */
        async function addAvatarToGroupLibraryFromURL() {
            const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
            if (!name || !name.trim()) return;
        
            const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
            if (!url || !url.trim().startsWith('http')) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            if (!chat.settings.groupAvatarLibrary) {
                chat.settings.groupAvatarLibrary = [];
            }
        
            chat.settings.groupAvatarLibrary.push({ name: name.trim(), url: url.trim() });
            await db.chats.put(chat);
            renderGroupAvatarLibrary();
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÂàóË°®ÈïøÊåâÊìç‰ΩúËèúÂçïÁöÑÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * ÊòæÁ§∫‰∏Ä‰∏™ÂåÖÂê´‚ÄúÁΩÆÈ°∂‚ÄùÂíå‚ÄúÂà†Èô§‚ÄùÈÄâÈ°πÁöÑÊìç‰ΩúËèúÂçï
         * @param {object} chat - Ë¢´ÈïøÊåâÁöÑËÅäÂ§©ÂØπË±°
         * @returns {Promise<string|null>} - ËøîÂõû‰∏Ä‰∏™PromiseÔºåÂΩìÁî®Êà∑ÁÇπÂáªÊó∂Ëß£Êûê‰∏∫ 'pin', 'delete', Êàñ null (ÂèñÊ∂à)
         */
        function showChatListActions(chat) {
            return new Promise(resolve => {
                const modal = document.getElementById('chat-list-actions-modal');
                const pinBtn = document.getElementById('chat-list-action-pin');
                const deleteBtn = document.getElementById('chat-list-action-delete');
                const cancelBtn = document.getElementById('chat-list-action-cancel');
        
                // Ê†πÊçÆÂΩìÂâçËÅäÂ§©ÊòØÂê¶Â∑≤ÁΩÆÈ°∂ÔºåÂä®ÊÄÅËÆæÁΩÆÊåâÈíÆÊñáÂ≠ó
                pinBtn.textContent = chat.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ËÅäÂ§©';
        
                // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÁ°Æ‰øùÊØèÊ¨°ÊâìÂºÄËèúÂçïÊó∂ÈÉΩÁªëÂÆöÂÖ®Êñ∞ÁöÑ„ÄÅÂπ≤ÂáÄÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                const newPinBtn = pinBtn.cloneNode(true);
                pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
                newPinBtn.onclick = () => { modal.classList.remove('visible'); resolve('pin'); };
        
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                newDeleteBtn.onclick = () => { modal.classList.remove('visible'); resolve('delete'); };
        
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.onclick = () => { modal.classList.remove('visible'); resolve(null); };
        
                modal.classList.add('visible');
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏§‰∏™„ÄêÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ∞Ü‰øùÂ≠òÁöÑÂõæÊ†áURLÂ∫îÁî®Âà∞‰∏ªÂ±èÂπïÁöÑAppÂõæÊ†á‰∏ä
         */
        function applyAppIcons() {
            if (!state.globalSettings.appIcons) return;
        
            for (const iconId in state.globalSettings.appIcons) {
                const imgElement = document.getElementById(`icon-img-${iconId}`);
                if (imgElement) {
                    imgElement.src = state.globalSettings.appIcons[iconId];
                }
            }
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂú®Â§ñËßÇËÆæÁΩÆÈ°µÈù¢Ê∏≤ÊüìÂá∫ÊâÄÊúâAppÂõæÊ†áÁöÑËÆæÁΩÆÈ°π
         */
        function renderIconSettings() {
            console.log('ÂºÄÂßãÊ∏≤ÊüìÂõæÊ†áËÆæÁΩÆ...');
            const grid = document.getElementById('icon-settings-grid');
            console.log('ÊâæÂà∞ÂõæÊ†áËÆæÁΩÆÁΩëÊ†º:', grid);
            if (!grid) {
                console.error('Êú™ÊâæÂà∞icon-settings-gridÂÖÉÁ¥†');
                return;
            }
            grid.innerHTML = '';
        
        // ‚ñº‚ñº‚ñº Âú® renderIconSettings ÂáΩÊï∞ÂÜÖÈÉ® ‚ñº‚ñº‚ñº
        const appLabels = {
            'world-book': '‰∏ñÁïå‰π¶',
            'qq': 'QQ',
            'renderer': 'Ê∏≤ÊüìÂô®',
            'api-settings': 'APIËÆæÁΩÆ',
                'wallpaper': 'Â§ñËßÇËÆæÁΩÆ',
            'font': 'Â≠ó‰Ωì'
        };
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // Á°Æ‰øù appIcons ÂØπË±°Â≠òÂú®
            if (!state.globalSettings.appIcons) {
                state.globalSettings.appIcons = {};
            }
            
            // ÊòæÁ§∫ÊâÄÊúâÂèØÁî®ÁöÑÂõæÊ†áËÆæÁΩÆÈ°π
            console.log('ÂºÄÂßãÊ∏≤ÊüìÂõæÊ†áÈ°πÔºåappLabels:', appLabels);
            console.log('ÂΩìÂâçappIconsÁä∂ÊÄÅ:', state.globalSettings.appIcons);
            
            for (const iconId in appLabels) {
                const iconUrl = state.globalSettings.appIcons[iconId] || getDefaultIconUrl(iconId);
                const labelText = appLabels[iconId];
                console.log(`Ê∏≤ÊüìÂõæÊ†á ${iconId}: ${labelText}, URL: ${iconUrl}`);
        
                const item = document.createElement('div');
                item.className = 'icon-setting-item';
                item.dataset.iconId = iconId; 
        
                item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">Êõ¥Êç¢</button>
                `;
                grid.appendChild(item);
            }
            
            console.log('ÂõæÊ†áËÆæÁΩÆÊ∏≤ÊüìÂÆåÊàêÔºåÂÖ±Ê∏≤Êüì‰∫Ü', Object.keys(appLabels).length, '‰∏™ÂõæÊ†á');
        }
        
        // Ëé∑ÂèñÈªòËÆ§ÂõæÊ†áURLÁöÑÂáΩÊï∞
        function getDefaultIconUrl(iconId) {
            const defaultIcons = {
                'world-book': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
                'qq': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
                'renderer': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
                'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
                'wallpaper': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
                'font': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg'
            };
            return defaultIcons[iconId] || 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg';
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊîØÊåÅHTMLÊ†ºÂºè„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†ÊóßÁöÑ openBrowser ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * ÂΩìÁî®Êà∑ÁÇπÂáªÈìæÊé•Âç°ÁâáÊó∂ÔºåÊâìÂºÄ‰º™ÊµèËßàÂô®
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function openBrowser(timestamp) {
            if (!state.activeChatId) return;
        
            const chat = state.chats[state.activeChatId];
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øù chat Âíå history ÈÉΩÂ≠òÂú®
            if (!chat || !chat.history) return;
        
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_link') {
                console.error("Êó†Ê≥ïÊâæÂà∞ÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÂåπÈÖçÁöÑÂàÜ‰∫´ÈìæÊé•:", timestamp);
                return; // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê∂àÊÅØÔºåÂ∞±Áõ¥Êé•ÈÄÄÂá∫
            }
        
            // Â°´ÂÖÖÊµèËßàÂô®ÂÜÖÂÆπ
            document.getElementById('browser-title').textContent = message.source_name || 'ÊñáÁ´†ËØ¶ÊÉÖ';
            const browserContent = document.getElementById('browser-content');
            browserContent.innerHTML = `
                <h1 class="article-title">${message.title || 'Êó†Ê†áÈ¢ò'}</h1>
                <div class="article-meta">
                    <span>Êù•Ê∫ê: ${message.source_name || 'Êú™Áü•'}</span>
                </div>
                <div class="article-body">
                    <p>${(message.content || 'ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ').replace(/\n/g, '</p><p>')}</p>
                </div>
            `;
        
            // ÊòæÁ§∫ÊµèËßàÂô®Â±èÂπï
            showScreen('browser-screen');
        }
        
        /**
         * ÂÖ≥Èó≠‰º™ÊµèËßàÂô®ÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢
         * (Ëøô‰∏™ÂáΩÊï∞Áé∞Âú®Áî± init() ‰∏≠ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Ë∞ÉÁî®)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÂÖ≥Èó≠‰º™ÊµèËßàÂô®ÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢
         * (Ëøô‰∏™ÂáΩÊï∞Áé∞Âú®Áî± init() ‰∏≠ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Ë∞ÉÁî®)
         */
        function closeBrowser() {
            showScreen('chat-interface-screen'); 
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®Êà∑ÂàÜ‰∫´ÈìæÊé•ÂäüËÉΩÁöÑÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄËÆ©Áî®Êà∑Â°´ÂÜôÈìæÊé•‰ø°ÊÅØÁöÑÊ®°ÊÄÅÊ°Ü
         */
        function openShareLinkModal() {
            if (!state.activeChatId) return;
        
            // Ê∏ÖÁ©∫‰∏äÊ¨°ËæìÂÖ•ÁöÑÂÜÖÂÆπ
            document.getElementById('link-title-input').value = '';
            document.getElementById('link-description-input').value = '';
            document.getElementById('link-source-input').value = '';
            document.getElementById('link-content-input').value = '';
        
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('share-link-modal').classList.add('visible');
        }
        
        /**
         * Áî®Êà∑Á°ÆËÆ§ÂàÜ‰∫´ÔºåÂàõÂª∫Âπ∂ÂèëÈÄÅÈìæÊé•Âç°ÁâáÊ∂àÊÅØ
         */
        async function sendUserLinkShare() {
            if (!state.activeChatId) return;
        
            const title = document.getElementById('link-title-input').value.trim();
            if (!title) {
                alert("Ê†áÈ¢òÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
                return;
            }
        
            const description = document.getElementById('link-description-input').value.trim();
            const sourceName = document.getElementById('link-source-input').value.trim();
            const content = document.getElementById('link-content-input').value.trim();
        
            const chat = state.chats[state.activeChatId];
            
            // ÂàõÂª∫Ê∂àÊÅØÂØπË±°
            const linkMessage = {
                role: 'user', // ËßíËâ≤ÊòØ 'user'
                type: 'share_link',
                timestamp: Date.now(),
                title: title,
                description: description,
                source_name: sourceName,
                content: content,
                // Áî®Êà∑ÂàÜ‰∫´ÁöÑÈìæÊé•ÔºåÊàë‰ª¨‰∏çÊèê‰æõÂõæÁâáÔºåËÆ©ÂÆÉÊÄªÊòØÊòæÁ§∫Âç†‰ΩçÂõæ
                thumbnail_url: null 
            };
        
            // Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            chat.history.push(linkMessage);
            await db.chats.put(chat);
        
            // Ê∏≤ÊüìÊñ∞Ê∂àÊÅØÂπ∂Êõ¥Êñ∞ÂàóË°®
            appendMessage(linkMessage, chat);
            renderChatList();
        
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            document.getElementById('share-link-modal').classList.remove('visible');
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ filterVisiblePostsForAI ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * „ÄêV2.0 | ÊîØÊåÅÂàÜÁªÑÈöîÁ¶ª„ÄëÊ†πÊçÆAIÁöÑËßÜËßíÔºåËøáÊª§Âá∫ÂÆÉËÉΩÁúãÂà∞ÁöÑÂä®ÊÄÅ
 * @param {Array} allPosts - ÊâÄÊúâÂæÖÊ£ÄÊü•ÁöÑÂä®ÊÄÅÂ∏ñÂ≠ê
 * @param {object} viewerChat - Ê≠£Âú®‚ÄúÁúã‚ÄùÂä®ÊÄÅÁöÑÈÇ£‰∏™AIÁöÑchatÂØπË±°
 * @returns {Array} - ËøáÊª§ÂêéËØ•AIÂèØËßÅÁöÑÂä®ÊÄÅÂ∏ñÂ≠ê
 */
function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return []; // ÂÆâÂÖ®Ê£ÄÊü•

    const viewerGroupId = viewerChat.groupId; // Êü•ÁúãËÄÖAIÊâÄÂú®ÁöÑÂàÜÁªÑID

    return allPosts.filter(post => {
        // ËßÑÂàô1ÔºöÂ¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅ
        if (post.authorId === 'user') {
            // Â¶ÇÊûúÁî®Êà∑ËÆæÁΩÆ‰∫Ü‚ÄúÈÉ®ÂàÜÂèØËßÅ‚Äù
            if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
                // Âè™ÊúâÂΩìÊü•ÁúãËÄÖAIÁöÑÂàÜÁªÑIDÂú®Áî®Êà∑ÁöÑÂèØËßÅÂàóË°®ÈáåÊó∂ÔºåÊâçÂèØËßÅ
                return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
            }
            // Â¶ÇÊûúÁî®Êà∑Ê≤°ËÆæÁΩÆÔºåËØ¥ÊòéÊòØÂÖ¨ÂºÄÁöÑÔºåÊâÄÊúâAIÈÉΩÂèØËßÅ
            return true;
        }

        // ËßÑÂàô2ÔºöÂ¶ÇÊûúÊòØÂÖ∂‰ªñAIÂèëÁöÑÂä®ÊÄÅ
        const authorChat = state.chats[post.authorId];
        // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂèëÂ∏ñÁöÑAIÔºåÊàñËÄÖÂèëÂ∏ñAIÊ≤°ÊúâÂàÜÁªÑÔºåÂàôËßÜ‰∏∫ÂÖ¨ÂºÄÂä®ÊÄÅ
        if (!authorChat || !authorChat.groupId) {
            return true;
        }
        
        // „ÄêÊ†∏ÂøÉÈöîÁ¶ªÈÄªËæë„ÄëÂ¶ÇÊûúÂèëÂ∏ñÁöÑAIÊúâÂàÜÁªÑÔºåÈÇ£‰πàÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÁªÑÁöÑAIÊâçËÉΩÁúãÂà∞
        return authorChat.groupId === viewerGroupId;
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * Â∫îÁî®ÊåáÂÆöÁöÑ‰∏ªÈ¢òÔºà'light' Êàñ 'dark'Ôºâ
         * @param {string} theme - Ë¶ÅÂ∫îÁî®ÁöÑ‰∏ªÈ¢òÂêçÁß∞
         */
        function applyTheme(theme) {
            const phoneScreen = document.getElementById('phone-screen');
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            
            const isDark = theme === 'dark';
            
            phoneScreen.classList.toggle('dark-mode', isDark);
            
            // Â¶ÇÊûúÂºÄÂÖ≥Â≠òÂú®ÔºåÂ∞±ÂêåÊ≠•ÂÆÉÁöÑÁä∂ÊÄÅ
            if (toggleSwitch) {
                toggleSwitch.checked = isDark;
            }
            
            localStorage.setItem('ephone-theme', theme);
        }
        
        /**
         * ÂàáÊç¢ÂΩìÂâçÁöÑ‰∏ªÈ¢ò
         */
        function toggleTheme() {
            const toggleSwitch = document.getElementById('theme-toggle-switch');
            // Áõ¥Êé•Ê†πÊçÆÂºÄÂÖ≥ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÊù•ÂÜ≥ÂÆöÊñ∞‰∏ªÈ¢ò
            const newTheme = toggleSwitch.checked ? 'dark' : 'light';
            applyTheme(newTheme);
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ openLongTermMemoryManager ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊâìÂºÄÈïøÊúüËÆ∞ÂøÜÁÆ°ÁêÜÁöÑÂÖ®Â±èÈ°µÈù¢
         */
        function openLongTermMemoryScreen() {
            if (!state.activeChatId) return;
            renderLongTermMemoryList();
            showScreen('long-term-memory-screen');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÊîØÊåÅËÆ∞ÂøÜ‰∫íÈÄöÁöÑÂÖ®Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderLongTermMemoryList ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * Ê∏≤ÊüìÈïøÊúüËÆ∞ÂøÜÂàóË°® (ËÆ∞ÂøÜ‰∫íÈÄöÁâà)
         */
        function renderLongTermMemoryList() {
            const container = document.getElementById('memory-list-container');
            const chat = state.chats[state.activeChatId];
            container.innerHTML = '';
        
            let memoriesToDisplay = [];

            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºöÂú®ËøôÈáåÊî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÊòæÁ§∫ÁöÑËÆ∞ÂøÜ ‚ñº‚ñº‚ñº
            if (chat.isGroup) {
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÈÅçÂéÜÊàêÂëòÊî∂ÈõÜËÆ∞ÂøÜ
                chat.members.forEach(member => {
                    const memberChat = state.chats[member.id];
                    if (memberChat && memberChat.longTermMemory) {
                        // ‰∏∫ÊØèÊù°ËÆ∞ÂøÜÈôÑÂä†‰∏ä‰ΩúËÄÖ‰ø°ÊÅØÔºåÊñπ‰æøÊòæÁ§∫
                        const memberMemories = memberChat.longTermMemory.map(mem => ({
                            ...mem,
                            authorName: member.groupNickname, // ‰ΩøÁî®Áæ§ÊòµÁß∞
                            authorChatId: member.id, // ‰øùÂ≠òÂéüÂßãÂçïËÅäID
                        }));
                        memoriesToDisplay.push(...memberMemories);
                    }
                });
            } else {
                // Â¶ÇÊûúÊòØÂçïËÅäÔºåÁõ¥Êé•‰ΩøÁî®Ëá™Â∑±ÁöÑËÆ∞ÂøÜ
                if (chat.longTermMemory) {
                    memoriesToDisplay = chat.longTermMemory.map(mem => ({
                        ...mem,
                        authorName: chat.name, // ‰ΩúËÄÖÂ∞±ÊòØËßíËâ≤Ëá™Â∑±
                        authorChatId: chat.id,
                    }));
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            if (memoriesToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøôÈáåËøòÊ≤°Êúâ‰ªª‰ΩïÈïøÊúüËÆ∞ÂøÜ„ÄÇ</p>';
                return;
            }

            // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÊâÄÊúâÊî∂ÈõÜÂà∞ÁöÑËÆ∞ÂøÜ
            memoriesToDisplay.sort((a, b) => b.timestamp - a.timestamp);
        
            memoriesToDisplay.forEach((memory, index) => {
                const item = document.createElement('div');
                item.className = 'memory-card'; 
                item.style.cursor = 'default';
        
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div class="content" style="padding: 0; flex-grow: 1;">
                            <!-- Êñ∞Â¢ûÔºöÊòæÁ§∫ËÆ∞ÂøÜÊù•Ê∫ê -->
                            <div style="font-size: 0.8em; color: #999; margin-bottom: 5px;">
                                [ ${memory.authorName} ÁöÑËÆ∞ÂøÜ ]
                            </div>
                            ${memory.content.replace(/\n/g, '<br>')}
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0; margin-left: 15px;">
                            <button class="memory-action-btn edit-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="ÁºñËæë">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="memory-action-btn delete-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="Âà†Èô§">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
async function handleAddManualMemory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let targetChatForMemory = chat;
    if (chat.isGroup) {
        const memberOptions = chat.members.map(member => ({
            text: `‰∏∫‚Äú${member.groupNickname}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`,
            value: member.id
        }));
        const selectedMemberId = await showChoiceModal('ÈÄâÊã©ËÆ∞ÂøÜÊâÄÂ±ûËßíËâ≤', memberOptions);
        if (!selectedMemberId) return;
        targetChatForMemory = state.chats[selectedMemberId];
        if (!targetChatForMemory) {
            alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÊàêÂëòÁöÑ‰∏™‰∫∫Ê°£Ê°à„ÄÇ");
            return;
        }
    }
    const content = await showCustomPrompt(`‰∏∫‚Äú${targetChatForMemory.name}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`, 'ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑËÆ∞ÂøÜË¶ÅÁÇπÔºö', '', 'textarea');
    if (content && content.trim()) {
        if (!targetChatForMemory.longTermMemory) targetChatForMemory.longTermMemory = [];
        targetChatForMemory.longTermMemory.push({ content: content.trim(), timestamp: Date.now(), source: 'manual' });
        await db.chats.put(targetChatForMemory);
        renderLongTermMemoryList();
    }
}
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏§‰∏™ÊîØÊåÅËÆ∞ÂøÜ‰∫íÈÄöÁöÑÊñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ handleEditMemory Âíå handleDeleteMemory ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * ÁºñËæëÊåáÂÆöÁöÑÈïøÊúüËÆ∞ÂøÜ (ËÆ∞ÂøÜ‰∫íÈÄöÁâà)
         * @param {string} authorChatId - ËÆ∞ÂøÜÊâÄÂ±ûËßíËâ≤ÁöÑÂçïËÅäID
         * @param {number} memoryTimestamp - ËÆ∞ÂøÜÁöÑÊó∂Èó¥Êà≥
         */
async function handleEditMemory(authorChatId, memoryTimestamp) {
    const authorChat = state.chats[authorChatId];
    if (!authorChat || !authorChat.longTermMemory) return;
    const memoryIndex = authorChat.longTermMemory.findIndex(m => m.timestamp === memoryTimestamp);
    if (memoryIndex === -1) return;
    const memory = authorChat.longTermMemory[memoryIndex];
    const newContent = await showCustomPrompt('ÁºñËæëËÆ∞ÂøÜ', 'ËØ∑‰øÆÊîπËÆ∞ÂøÜË¶ÅÁÇπÔºö', memory.content, 'textarea');
    if (newContent && newContent.trim()) {
        memory.content = newContent.trim();
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}

async function handleDeleteMemory(authorChatId, memoryTimestamp) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈïøÊúüËÆ∞ÂøÜÂêóÔºü', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const authorChat = state.chats[authorChatId];
        if (!authorChat || !authorChat.longTermMemory) return;
        authorChat.longTermMemory = authorChat.longTermMemory.filter(m => m.timestamp !== memoryTimestamp);
        await db.chats.put(authorChat);
        renderLongTermMemoryList();
    }
}
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * „ÄêÊ†∏ÂøÉ„ÄëÊâãÂä®Ëß¶ÂèëÂØπËØùÊÄªÁªì
         */
        async function handleManualSummary() {
            const confirmed = await showCustomConfirm('Á°ÆËÆ§Êìç‰Ωú', 'ËøôÂ∞ÜÊèêÂèñÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπÂèëÈÄÅÁªôAIËøõË°åÊÄªÁªìÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü');
            if (confirmed) {
                await triggerAutoSummary(state.activeChatId, true); // force=true Ë°®Á§∫Âº∫Âà∂ÊâßË°å
            }
        }
        
        /**
         * „ÄêÊ†∏ÂøÉ„ÄëÊ£ÄÊü•Âπ∂Ëß¶ÂèëËá™Âä®ÊÄªÁªì
         * @param {string} chatId 
         */
        async function checkAndTriggerAutoSummary(chatId) {
            const chat = state.chats[chatId];
            if (!chat || !chat.settings.enableAutoMemory) return;
        
            const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
            const messagesSinceLastSummary = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);
        
            if (messagesSinceLastSummary.length >= chat.settings.autoMemoryInterval) {
                console.log(`ËææÂà∞Ëá™Âä®ÊÄªÁªìÈòàÂÄº (${messagesSinceLastSummary.length}/${chat.settings.autoMemoryInterval})ÔºåÂºÄÂßãÊÄªÁªì...`);
                await triggerAutoSummary(chatId);
            }
        }
/**
 * „ÄêV2.0 | ÈîôËØØÂ§ÑÁêÜÂ¢ûÂº∫Áâà„Äë‰∏ìÈó®Áî®‰∫éÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÂπ∂Â≠òÂÖ•ÈïøÊúüËÆ∞ÂøÜÁöÑÊ†∏ÂøÉÂáΩÊï∞
 * @param {string} chatId - ÁõÆÊ†áËÅäÂ§©ÁöÑID
 * @param {string} transcriptText - Ê†ºÂºèÂåñÂêéÁöÑÈÄöËØùÊñáÂ≠óËÆ∞ÂΩï
 * @returns {Promise<boolean>} - ËøîÂõû‰∏Ä‰∏™PromiseÔºåÊàêÂäüÊó∂Ëß£Êûê‰∏∫trueÔºåÂ§±Ë¥•Êó∂‰ºöÊäõÂá∫ÈîôËØØ„ÄÇ
 */
async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
        // Â¶ÇÊûúÂü∫Á°ÄÊï∞ÊçÆÂ∞±ÊúâÈóÆÈ¢òÔºåÁõ¥Êé•ÊäõÂá∫ÈîôËØØ
        throw new Error("Âü∫Á°ÄÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂºÄÂßãÊÄªÁªì„ÄÇ");
    }

    const userNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ÂØπËØùÊëòË¶Å‰∏ìÂÆ∂„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑ„ÄêËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï„ÄëÔºåÂπ∂Â∞ÜÂÖ∂ÊµìÁº©Êàê„Äê‰∏ÄÊÆµ„ÄëÊµÅÁïÖ„ÄÅËøûË¥Ø„ÄÅÂÆ¢ËßÇ„ÄÅÂπ∂‰∏î„ÄêÊûÅÂÖ∂Á≤æÁÆÄ„ÄëÁöÑÊëòË¶Å„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„ÄëÈùûÂ∏∏ÁÆÄÁü≠ÔºåÊÄªÈïøÂ∫¶„ÄêÁªùÂØπ‰∏çËÉΩË∂ÖËøá80‰∏™Â≠ó„Äë„ÄÇ
2.  **ÂÆ¢ËßÇ‰∫ãÂÆû**: Âè™ËÆ∞ÂΩïÈÄöËØù‰∏≠ÂèëÁîüÁöÑÊúÄÂÖ≥ÈîÆÁöÑ‰∫ãÂÆû„ÄÅÁ°ÆËÆ§ÁöÑÁ∫¶ÂÆöÊàñËßíËâ≤ÁöÑÊ†∏ÂøÉÊÉÖÊÑüÂèòÂåñ„ÄÇ
3.  **Á¨¨‰∏â‰∫∫Áß∞‰∏éÂëΩÂêç**: ÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞„ÄÇËØ∑‰∏•Ê†º‰ΩøÁî®‚Äú${userNickname}‚ÄùÔºà‰ª£Ë°®Áî®Êà∑ÔºâÂíå‚Äú${chat.originalName}‚ÄùÔºà‰ª£Ë°®AIËßíËâ≤ÔºâÊù•Êåá‰ª£ÂØπËØùÂèåÊñπ„ÄÇ
4.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÄªÁªìÂ•ΩÁöÑÊëòË¶Å„ÄÇ"}\`
# ÂæÖÊÄªÁªìÁöÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}
Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÊÄªÁªìÂ∑•‰Ωú„ÄÇ`;

    // ‚ñ≤‚ñ≤‚ñ≤ Ê†∏ÂøÉ‰øÆÊîπ‰ªéËøôÈáåÂºÄÂßã ‚ñ≤‚ñ≤‚ñ≤
    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? 
            { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : 
            state.apiConfig;

        if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ');

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"}],
                    temperature: 0.1, max_tokens: 150
                })
            });

        if (!response.ok) {
             const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
             throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
        }
        
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            const newMemoryEntry = {
                content: `(Âú®ÈÇ£Ê¨°ËßÜÈ¢ëÈÄöËØù‰∏≠Ôºå${result.summary.trim()})`,
                timestamp: Date.now(),
                source: 'call_summary'
            };
            chat.longTermMemory.push(newMemoryEntry);
            await db.chats.put(chat);
            console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊÄªÁªìÂπ∂Â≠òÂÖ•ÈïøÊúüËÆ∞ÂøÜ:", newMemoryEntry.content);
            return true; // ÊòéÁ°ÆËøîÂõûÊàêÂäüÁä∂ÊÄÅ
        } else {
            throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
        }

    } catch (error) {
        console.error("ÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÊó∂Âá∫Èîô:", error);
        // ËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÊîπÔºöÂ∞ÜÊçïËé∑Âà∞ÁöÑÈîôËØØÈáçÊñ∞ÊäõÂá∫ÔºÅ
        throw error;
    }
    // ‚ñ≤‚ñ≤‚ñ≤ Ê†∏ÂøÉ‰øÆÊîπÂà∞ËøôÈáåÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
}
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÊîØÊåÅËÆ∞ÂøÜ‰∫íÈÄöÁöÑÂÖ®Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ summarizeExistingLongTermMemory ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * „ÄêÂÖ®Êñ∞V2.0 | ÊîØÊåÅËá™ÂÆö‰πâÂ≠óÊï∞ | ËÆ∞ÂøÜ‰∫íÈÄöÁâà„ÄëÊâãÂä®Ëß¶ÂèëÂØπ„ÄêÁé∞ÊúâÈïøÊúüËÆ∞ÂøÜ„ÄëÁöÑÊÄªÁªìÂíåÁ≤æÁÇº
 * @param {string} chatId - ÂΩìÂâçËÅäÂ§©ÁöÑID (may be a group chat ID)
 */
async function summarizeExistingLongTermMemory(chatId) {
    let chat = state.chats[chatId];
    if (!chat) return;

    let targetChatForRefine = chat; // By default, the target is the current chat

    // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºöÂ¶ÇÊûúÊòØÁæ§ËÅäÔºåÂ∞±ÂºπÂá∫ÈÄâÊã©Ê°ÜÔºåËÆ©Áî®Êà∑ÈÄâÊã©Ë¶Å‰∏∫Âì™‰∏™ËßíËâ≤Á≤æÁÇºËÆ∞ÂøÜ ‚ñº‚ñº‚ñº
    if (chat.isGroup) {
        // 1. ÂàõÂª∫‰∏Ä‰∏™ÈÄâÈ°πÊï∞ÁªÑÔºåÂè™ÂåÖÂê´ÈÇ£‰∫õÊúâË∂≥Â§üËÆ∞ÂøÜÔºà2Êù°‰ª•‰∏äÔºâÂèØ‰æõÁ≤æÁÇºÁöÑÊàêÂëò
        const memberOptions = chat.members
            .map(member => {
                const memberChat = state.chats[member.id];
                if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length >= 2) {
                    return {
                        text: `Á≤æÁÇº‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ (${memberChat.longTermMemory.length}Êù°)`,
                        value: member.id // The value we want is the member's unique single-chat ID
                    };
                }
                return null;
            }).filter(Boolean); // This removes any null entries from the array

        // Â¶ÇÊûúÊ≤°ÊúâÊàêÂëòÊúâË∂≥Â§üÁöÑËÆ∞ÂøÜÔºåÂ∞±ÊèêÁ§∫Áî®Êà∑Âπ∂ÈÄÄÂá∫
        if (memberOptions.length === 0) {
            alert("Áæ§ËÅä‰∏≠Ê≤°ÊúâÊàêÂëòÊúâË∂≥Â§üÔºà2Êù°‰ª•‰∏äÔºâÁöÑËÆ∞ÂøÜÂèØ‰æõÁ≤æÁÇº„ÄÇ");
            return;
        }

        // 2. ÂºπÂá∫ÈÄâÊã©Ê°Ü
        const selectedMemberId = await showChoiceModal('ÈÄâÊã©Ë¶ÅÁ≤æÁÇºËÆ∞ÂøÜÁöÑËßíËâ≤', memberOptions);

        // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂à‰∫ÜÈÄâÊã©ÔºåÂ∞±Áõ¥Êé•ÈÄÄÂá∫
        if (!selectedMemberId) return;

        // 3. Â∞ÜÊàë‰ª¨ÁöÑÊìç‰ΩúÁõÆÊ†áÔºå‰ªéÁæ§ËÅäÊú¨Ë∫´ÔºåÂàáÊç¢Âà∞Ë¢´ÈÄâ‰∏≠ÁöÑÈÇ£‰∏™ËßíËâ≤
        targetChatForRefine = state.chats[selectedMemberId];
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

    if (!targetChatForRefine.longTermMemory || targetChatForRefine.longTermMemory.length < 2) {
        alert(`‚Äú${targetChatForRefine.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜÂ∞ë‰∫é2Êù°ÔºåÊó†ÈúÄËøõË°åÁ≤æÁÇº„ÄÇ`);
        return;
    }

    const wordCountStr = await showCustomPrompt(
        `‰∏∫‚Äú${targetChatForRefine.name}‚ÄùÁ≤æÁÇºËÆ∞ÂøÜ`,
        "ËØ∑ËæìÂÖ•Á≤æÁÇºÂêéÊ†∏ÂøÉËÆ∞ÂøÜÁöÑÂ§ßËá¥Â≠óÊï∞Ôºö",
        "150"
    );
    
    if (wordCountStr === null) return;
    
    const wordCount = parseInt(wordCountStr);
    if (isNaN(wordCount) || wordCount < 20) {
        alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÊï∞Â≠óÔºàÂª∫ËÆÆÂ§ß‰∫é20Ôºâ„ÄÇ");
        return;
    }

    const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Á≤æÁÇºËÆ∞ÂøÜÔºü',
        `Ê≠§Êìç‰Ωú‰ºöÂ∞Ü‚Äú${targetChatForRefine.name}‚ÄùÁöÑ ${targetChatForRefine.longTermMemory.length} Êù°ÈïøÊúüËÆ∞ÂøÜÊÄªÁªìÊàêÂ§ßÁ∫¶ ${wordCount} Â≠óÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ„ÄÇÊóßÁöÑËÆ∞ÂøÜÂ∞ÜË¢´ÊõøÊç¢ÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`,
        { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§Á≤æÁÇº' }
    );

    if (!confirmed) return;

    const memoryContent = targetChatForRefine.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
    const userNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';

    // ÊûÑÂª∫‰∏Ä‰∏™‰∏ìÈó®Áî®‰∫é‚ÄúÂÖÉÊÄªÁªì‚ÄùÁöÑ„ÄÅÈ´òÂ∫¶‰ºòÂåñÁöÑAIÊåá‰ª§
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËÆ∞ÂøÜÊï¥Âêà‰∏ìÂÆ∂„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢Êèê‰æõÁöÑ‚ÄúËÆ∞ÂøÜË¶ÅÁÇπÂàóË°®‚ÄùÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨Êï¥ÂêàÊàê‰∏Ä‰∏™Êõ¥Âä†Á≤æÁÇº„ÄÅËøûË¥ØÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÊëòË¶Å„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **‰øùÁïôÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÂøÖÈ°ª‰øùÁïôÊâÄÊúâÂÖ≥ÈîÆÁöÑ‰∫∫Áâ©„ÄÅ‰∫ã‰ª∂„ÄÅËÆæÂÆöÂíåÊÉÖÊÑüÂÖ≥Á≥ª„ÄÇ
2.  **Ê∂àÈô§ÂÜó‰Ωô**: ÁßªÈô§ÈáçÂ§çÁöÑ„ÄÅÊàñÂ∑≤Áªè‰∏çÂÜçÈáçË¶ÅÁöÑÊóß‰ø°ÊÅØ„ÄÇ
3.  **ÂÆ¢ËßÇËßÜËßí**: ‰ΩøÁî®ÂÆ¢ËßÇÁöÑÁ¨¨‰∏â‰∫∫Áß∞ËøõË°åÊÄªÁªì„ÄÇËØ∑‰∏•Ê†º‰ΩøÁî®‚Äú${userNickname}‚ÄùÔºà‰ª£Ë°®Áî®Êà∑ÔºâÂíå‚Äú${targetChatForRefine.originalName}‚ÄùÔºà‰ª£Ë°®AIËßíËâ≤ÔºâÊù•Êåá‰ª£ÂØπËØùÂèåÊñπ„ÄÇ
4.  **„Äê„Äê„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë„Äë„Äë**: ÊúÄÁªàÁöÑÊëòË¶ÅÊÄªÈïøÂ∫¶Â∫î‰∏•Ê†ºÊéßÂà∂Âú®„Äê${wordCount}‰∏™Â≠ó„ÄëÂ∑¶Âè≥„ÄÇ
5.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†Êï¥ÂêàÂπ∂Á≤æÁÇºÂêéÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÊëòË¶Å„ÄÇ"}\`
# ÂæÖÊï¥ÂêàÁöÑËÆ∞ÂøÜË¶ÅÁÇπÂàóË°®
${memoryContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÔºåÂºÄÂßã‰Ω†ÁöÑÊï¥ÂêàÂ∑•‰Ωú„ÄÇ`;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åËÆ∞ÂøÜÁ≤æÁÇº...");

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi
            ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel }
            : state.apiConfig;

        if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "ËØ∑ÂºÄÂßãÊï¥Âêà„ÄÇ" }]);

        const response = isGemini
            ? await fetch(geminiConfig.url, geminiConfig.data)
            : await fetch(`${proxyUrl}/v1/chat/completions`, { /* ... API call details ... */ });

        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            const newMemoryEntry = {
                content: result.summary.trim(),
                timestamp: Date.now(),
                source: 'refined'
            };

            // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∞ÜÊñ∞ËÆ∞ÂøÜ‰øùÂ≠òÂà∞Êàë‰ª¨ÈÄâÂÆöÁöÑÁõÆÊ†áËßíËâ≤Ê°£Ê°à‰∏≠ ‚ñº‚ñº‚ñº
            targetChatForRefine.longTermMemory = [newMemoryEntry];
            targetChatForRefine.lastMemorySummaryTimestamp = Date.now();
            await db.chats.put(targetChatForRefine);
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            
            if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
                renderLongTermMemoryList();
            }
            await showCustomAlert('Á≤æÁÇºÊàêÂäü', `Â∑≤ÊàêÂäüÂ∞Ü‚Äú${targetChatForRefine.name}‚ÄùÁöÑËÆ∞ÂøÜÁ≤æÁÇº‰∏∫ 1 Êù°Ê†∏ÂøÉËÆ∞ÂøÜÔºÅ`);
        } else {
            throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
        }

    } catch (error) {
        console.error("Á≤æÁÇºÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
        await showCustomAlert('Á≤æÁÇºÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
}
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÊîØÊåÅ‚Äú‰∏™ÊÄßÂåñËÆ∞ÂøÜÊ≥®ÂÖ•‚ÄùÁöÑÊúÄÁªàÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ triggerAutoSummary ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * „ÄêÊ†∏ÂøÉ„ÄëÊâßË°åÊÄªÁªìÁöÑAPIË∞ÉÁî® (V7.1 - ‰∏™ÊÄßÂåñËÆ∞ÂøÜÊ≥®ÂÖ• | Áªü‰∏ÄÂÆ¢ËßÇÊÄªÁªì)
 * @param {string} chatId 
 * @param {boolean} force - ÊòØÂê¶ÂøΩÁï•Ê∂àÊÅØÊï∞ÈáèÊ£ÄÊü•ÔºåÂº∫Âà∂ÊâßË°å
 */
async function triggerAutoSummary(chatId, force = false) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const messagesToSummarize = force 
        ? chat.history.filter(m => !m.isHidden).slice(-(chat.settings.autoMemoryInterval || 20))
        : chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);
        
    if (messagesToSummarize.length < 5) {
        if (force) alert("ÊúÄËøëÁöÑÊ∂àÊÅØÂ§™Â∞ëÔºåÊó†Ê≥ïËøõË°åÊúâÊÑè‰πâÁöÑÊÄªÁªì„ÄÇ");
        return;
    }

    const userNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
    const formattedHistory = messagesToSummarize.map(msg => {
        let sender;
        if (msg.role === 'user') {
            sender = userNickname;
        } else {
            sender = chat.isGroup ? getDisplayNameInGroup(chat, msg.senderName) : (msg.senderName || chat.originalName);
        }
        return `${sender}: ${String(msg.content)}`;
    }).join('\n');

    let systemPrompt;

    // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºöÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÈÄâÊã©‰∏çÂêåÁöÑÊÄªÁªìÁ≠ñÁï• ‚ñº‚ñº‚ñº
    if (chat.isGroup) {
        // --- ËøôÊòØ‰∏∫„ÄêÁæ§ËÅä„ÄëËÆæËÆ°ÁöÑÂÖ®Êñ∞‚Äú‰∏™ÊÄßÂåñËÆ∞ÂøÜ‚ÄùÊåá‰ª§ ---
        systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™È´òÁ∫ßÁöÑ‚ÄúËÆ∞ÂøÜÂàÜÈÖç‰∏ìÂÆ∂‚Äù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑÁæ§ËÅäËÆ∞ÂΩïÔºåÂπ∂‰∏∫„ÄêÊØè‰∏Ä‰∏™ÂèÇ‰∏éÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰∏ÄÊÆµ„Äê‰∏™ÊÄßÂåñÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞„ÄëÁöÑÈïøÊúüËÆ∞ÂøÜ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêËßÜËßíÈìÅÂæã„Äë„Äë„Äë**: ÊØè‰∏ÄÊù°ÊÄªÁªìÈÉΩ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„Äë„ÄÇ
2.  **„Äê„Äê„ÄêÁõ∏ÂÖ≥ÊÄßÈìÅÂæã„Äë„Äë„Äë**: ÊØè‰∏™ËßíËâ≤ÁöÑËÆ∞ÂøÜ„ÄêÂøÖÈ°ª„Äë‰∏é‰ªñ‰ª¨Ëá™Ë∫´È´òÂ∫¶Áõ∏ÂÖ≥„ÄÇÈáçÁÇπÊÄªÁªìÔºö
    -   **ÊàëËØ¥ËøáÁöÑËØù** Âíå **ÊàëÂÅöËøáÁöÑ‰∫ã**„ÄÇ
    -   Âà´‰∫∫ **ÂØπÊàë** ËØ¥ÁöÑËØùÔºåÊàñËÄÖ **‰∏éÊàëÁõ∏ÂÖ≥** ÁöÑ‰∫ã„ÄÇ
    -   ÂØπÊàë‰∏™‰∫∫ **ÂæàÈáçË¶Å** ÁöÑÁæ§ËÅä‰∫ã‰ª∂„ÄÇ
3.  **„Äê„Äê„ÄêÁÆÄÊ¥ÅÊÄßÈìÅÂæã„Äë„Äë„Äë**: ÊØèÊù°‰∏™‰∫∫ËÆ∞ÂøÜÊÄªÁªì„ÄêÁªùÂØπ‰∏çËÉΩË∂ÖËøá60‰∏™Â≠ó„Äë„ÄÇ
4.  **„Äê„Äê„ÄêÁúÅÁï•ËßÑÂàô„Äë„Äë„Äë**: Â¶ÇÊûú‰∏Ä‰∏™ËßíËâ≤Âú®Êú¨Ê¨°ÂØπËØù‰∏≠„ÄêÂÆåÂÖ®Ê≤°ÊúâÂèÇ‰∏éÊàñÊèêÂèä„ÄëÔºå‰Ω†ÂèØ‰ª•ÁúÅÁï•TAÁöÑËÆ∞ÂøÜÔºåÊàñËÄÖÊÄªÁªì‰∏∫‚ÄúÊàëÂú®Áæ§ÈáåÊΩúÊ∞¥ÔºåÊ≤°ÊÄé‰πàËØ¥ËØù„ÄÇ‚Äù
5.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`\`\`json
    {
      "summaries": {
        "ËßíËâ≤ÁöÑÊú¨ÂêçA": "Êàë‰ªäÂ§©Âú®Áæ§ÈáåÂíåÂ§ßÂÆ∂ËÆ®ËÆ∫‰∫ÜÁîµÂΩ±ÔºåÊÑüËßâÂæàÂºÄÂøÉ„ÄÇ",
        "ËßíËâ≤ÁöÑÊú¨ÂêçB": "ÊàëÂú®Áæ§ÈáåÂíå${userNickname}ËÅä‰∫ÜÂÖ≥‰∫éÁîüÊó•Ê¥æÂØπÁöÑ‰∫ãÔºåÊàë‰ª¨Á∫¶Â•Ω‰∫Ü‰∏ãÂë®ËßÅÈù¢„ÄÇ",
        "ËßíËâ≤ÁöÑÊú¨ÂêçC": "Êàë‰ªäÂ§©Âú®Áæ§ÈáåÊΩúÊ∞¥ÔºåÊ≤°‰ªÄ‰πàÁâπÂà´ÁöÑ„ÄÇ"
      }
    }
    \`\`\`

# ÂæÖÊÄªÁªìÁöÑÁæ§ËÅäËÆ∞ÂΩï
${formattedHistory}

# Áæ§ÊàêÂëòÂàóË°® (‰Ω†ÁöÑÊÄªÁªìÁõÆÊ†á)
${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName})`).join('\n')}

Áé∞Âú®ÔºåËØ∑‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÁîüÊàê‰ªñ‰ª¨ÂêÑËá™ÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞ÁöÑ„ÄÅÁ≤æÁÆÄÁöÑËÆ∞ÂøÜ„ÄÇ`;

    } else {
        // --- ËøôÊòØ‰∏∫„ÄêÂçïËÅä„ÄëËÆæËÆ°ÁöÑ„ÄÅ‰øùÊåÅ‰∏çÂèòÁöÑ‚ÄúÂÆ¢ËßÇÊÄªÁªì‚ÄùÊåá‰ª§ ---
        systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ÂØπËØùÊëòË¶Å‰∏ìÂÆ∂„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÂπ∂Â∞ÜÂÖ∂ÊµìÁº©Êàê„Äê‰∏ÄÊÆµ„ÄëÊµÅÁïÖ„ÄÅËøûË¥Ø„ÄÅÂÆ¢ËßÇ„ÄÅÂπ∂‰∏î„ÄêÊûÅÂÖ∂Á≤æÁÆÄ„ÄëÁöÑÊëòË¶Å„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„ÄëÈùûÂ∏∏ÁÆÄÁü≠ÔºåÊÄªÈïøÂ∫¶„ÄêÁªùÂØπ‰∏çËÉΩË∂ÖËøá80‰∏™Â≠ó„Äë„ÄÇ
2.  **Á¨¨‰∏â‰∫∫Áß∞‰∏éÂëΩÂêç**: ÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ËßÜËßí„ÄÇËØ∑‰∏•Ê†º‰ΩøÁî®‚Äú${userNickname}‚ÄùÔºà‰ª£Ë°®Áî®Êà∑ÔºâÂíå‚Äú${chat.originalName}‚ÄùÔºà‰ª£Ë°®AIËßíËâ≤ÔºâÊù•Êåá‰ª£ÂØπËØùÂèåÊñπ„ÄÇ
3.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÄªÁªìÂ•ΩÁöÑÊëòË¶Å„ÄÇ"}\`
# ÂæÖÊÄªÁªìÁöÑÂØπËØùÂéÜÂè≤
${formattedHistory}
Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÊÄªÁªìÂ∑•‰Ωú„ÄÇ`;
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

    try {
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : state.apiConfig;
        if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ" }]);
        const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`}, body: JSON.stringify({ model: model, messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"}], temperature: 0.2 }) });
        
        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºöÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÊâßË°å‰∏çÂêåÁöÑËÆ∞ÂøÜ‰øùÂ≠òÈÄªËæë ‚ñº‚ñº‚ñº
        if (chat.isGroup) {
            // --- ËøôÊòØÁæ§ËÅäÁöÑ‚Äú‰∏™ÊÄßÂåñËÆ∞ÂøÜÊ≥®ÂÖ•‚ÄùÈÄªËæë ---
            if (result.summaries && typeof result.summaries === 'object') {
                let memoriesAddedCount = 0;
                for (const memberOriginalName in result.summaries) {
                    const summaryText = result.summaries[memberOriginalName];
                    if (summaryText && summaryText.trim()) {
                        const memberChat = Object.values(state.chats).find(c => c.originalName === memberOriginalName);
                        if (memberChat) {
                            const newMemoryEntry = {
                                content: summaryText.trim(),
                                timestamp: Date.now(),
                                source: `group_summary_from_${chat.name}`
                            };
                            if (!memberChat.longTermMemory) memberChat.longTermMemory = [];
                            memberChat.longTermMemory.push(newMemoryEntry);
                            await db.chats.put(memberChat);
                            memoriesAddedCount++;
                        }
                    }
                }
                if (memoriesAddedCount > 0) {
                    await showCustomAlert('ÊÄªÁªìÊàêÂäü', `Â∑≤ÊàêÂäü‰∏∫ ${memoriesAddedCount} ‰ΩçÁæ§ÊàêÂëòÁîüÊàêÂπ∂Ê≥®ÂÖ•‰∫Ü‰∏™ÊÄßÂåñËÆ∞ÂøÜÔºÅ`);
                } else {
                    throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
                }
            } else {
                throw new Error("AIËøîÂõûÁöÑJSONÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'summaries' Â≠óÊÆµ„ÄÇ");
            }
        } else {
            // --- ËøôÊòØÂçïËÅäÁöÑ‚ÄúÁªü‰∏ÄÂÆ¢ËßÇËÆ∞ÂøÜ‚ÄùÈÄªËæë ---
            if (result.summary && result.summary.trim()) {
                const newMemoryEntry = { content: result.summary.trim(), timestamp: Date.now(), source: 'auto' };
                chat.longTermMemory.push(newMemoryEntry);
                await db.chats.put(chat);
                await showCustomAlert('ÊÄªÁªìÊàêÂäü', `Â∑≤ÊàêÂäüÊ∑ªÂä† 1 Êù°Êñ∞ÁöÑÈïøÊúüËÆ∞ÂøÜÔºÅ`);
            } else {
                throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        chat.lastMemorySummaryTimestamp = messagesToSummarize.slice(-1)[0].timestamp;
        await db.chats.put(chat);
        
        if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
            renderLongTermMemoryList();
        }
    } catch (error) {
        console.error("ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
        await showCustomAlert('ÊÄªÁªìÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
}
/**
 * „ÄêV3.0 | ÈîôËØØÂ§ÑÁêÜÂ¢ûÂº∫‰∏éÊµÅÁ®ã‰ºòÂåñÁâà„Äë‰∏ìÈó®Áî®‰∫éÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÂπ∂Â≠òÂÖ•ÈïøÊúüËÆ∞ÂøÜÁöÑÊ†∏ÂøÉÂáΩÊï∞
 * @param {string} chatId - ÁõÆÊ†áËÅäÂ§©ÁöÑID
 * @param {string} transcriptText - Ê†ºÂºèÂåñÂêéÁöÑÈÄöËØùÊñáÂ≠óËÆ∞ÂΩï
 * @returns {Promise<{success: boolean, error?: string}>} - ËøîÂõû‰∏Ä‰∏™ÂåÖÂê´ÊàêÂäüÁä∂ÊÄÅÂíåÂèØÈÄâÈîôËØØ‰ø°ÊÅØÁöÑÁªìÊûúÂØπË±°
 */
async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
        // Â¶ÇÊûúÂü∫Á°ÄÊï∞ÊçÆÂ∞±ÊúâÈóÆÈ¢òÔºåÁõ¥Êé•ËøîÂõûÈîôËØØÂØπË±°
        return { success: false, error: "Âü∫Á°ÄÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂºÄÂßãÊÄªÁªì„ÄÇ" };
    }

    const userNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ÂØπËØùÊëòË¶Å‰∏ìÂÆ∂„ÄÇ‰Ω†ÁöÑÂîØ‰∏Ä‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑ„ÄêËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï„ÄëÔºåÂπ∂Â∞ÜÂÖ∂ÊµìÁº©Êàê„Äê‰∏ÄÊÆµ„ÄëÊµÅÁïÖ„ÄÅËøûË¥Ø„ÄÅÂÆ¢ËßÇ„ÄÅÂπ∂‰∏î„ÄêÊûÅÂÖ∂Á≤æÁÆÄ„ÄëÁöÑÊëòË¶Å„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„ÄëÈùûÂ∏∏ÁÆÄÁü≠ÔºåÊÄªÈïøÂ∫¶„ÄêÁªùÂØπ‰∏çËÉΩË∂ÖËøá80‰∏™Â≠ó„Äë„ÄÇ
2.  **ÂÆ¢ËßÇ‰∫ãÂÆû**: Âè™ËÆ∞ÂΩïÈÄöËØù‰∏≠ÂèëÁîüÁöÑÊúÄÂÖ≥ÈîÆÁöÑ‰∫ãÂÆû„ÄÅÁ°ÆËÆ§ÁöÑÁ∫¶ÂÆöÊàñËßíËâ≤ÁöÑÊ†∏ÂøÉÊÉÖÊÑüÂèòÂåñ„ÄÇ
3.  **Á¨¨‰∏â‰∫∫Áß∞‰∏éÂëΩÂêç**: ÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞„ÄÇËØ∑‰∏•Ê†º‰ΩøÁî®‚Äú${userNickname}‚ÄùÔºà‰ª£Ë°®Áî®Êà∑ÔºâÂíå‚Äú${chat.originalName}‚ÄùÔºà‰ª£Ë°®AIËßíËâ≤ÔºâÊù•Êåá‰ª£ÂØπËØùÂèåÊñπ„ÄÇ
4.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÄªÁªìÂ•ΩÁöÑÊëòË¶Å„ÄÇ"}\`
# ÂæÖÊÄªÁªìÁöÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}
Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÊÄªÁªìÂ∑•‰Ωú„ÄÇ`;

    try {
        // Êô∫ËÉΩÈÄâÊã©APIÔºö‰ºòÂÖà‰ΩøÁî®ÂâØAPIÔºåÂ¶ÇÊûúÊú™ÈÖçÁΩÆÂàôËá™Âä®ÂõûÈÄÄÂà∞‰∏ªAPI
        const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
        const { proxyUrl, apiKey, model } = useSecondaryApi ? 
            { proxyUrl: state.apiConfig.secondaryProxyUrl, apiKey: state.apiConfig.secondaryApiKey, model: state.apiConfig.secondaryModel } : 
            state.apiConfig;

        if (!proxyUrl || !apiKey || !model) {
            return { success: false, error: 'APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ' };
        }

        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{ role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ" }]);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"}],
                    temperature: 0.1, max_tokens: 150
                })
            });

        if (!response.ok) {
             const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
             // APIËØ∑Ê±ÇÂ§±Ë¥•Êó∂ÔºåËøîÂõûÂåÖÂê´ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÁöÑÂØπË±°
             return { success: false, error: `API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}` };
        }
        
        const data = await response.json();
        let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const result = JSON.parse(rawContent);

        if (result.summary && result.summary.trim()) {
            const newMemoryEntry = {
                content: `(Âú®ÈÇ£Ê¨°ËßÜÈ¢ëÈÄöËØù‰∏≠Ôºå${result.summary.trim()})`,
                timestamp: Date.now(),
                source: 'call_summary'
            };
            chat.longTermMemory.push(newMemoryEntry);
            await db.chats.put(chat);
            console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊÄªÁªìÂπ∂Â≠òÂÖ•ÈïøÊúüËÆ∞ÂøÜ:", newMemoryEntry.content);
            return { success: true }; // ÊàêÂäüÊó∂ÔºåËøîÂõûÊàêÂäüÁä∂ÊÄÅ
        } else {
            // AIËøîÂõûÂÜÖÂÆπ‰∏çËßÑËåÉÊó∂Ôºå‰πüËøîÂõûÈîôËØØÂØπË±°
            return { success: false, error: "AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ" };
        }

    } catch (error) {
        console.error("ÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÊó∂Âá∫Èîô:", error);
        // ‰ªª‰ΩïÊÑèÂ§ñÁöÑÁ®ãÂ∫èÈîôËØØÔºåÈÉΩËøîÂõûÈîôËØØÂØπË±°
        return { success: false, error: error.message };
    }
}
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂºïÁî®ÂõûÂ§çÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        function startReplyToMessage() {
            if (!activeMessageTimestamp) return;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
            if (!message) return;
        
            // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë„Äë„Äë
            let senderDisplayName;
            if (message.role === 'user') {
                senderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            } else { // AIÁöÑÊ∂àÊÅØ
                if (chat.isGroup) {
                    // Âú®Áæ§ËÅä‰∏≠ÔºåÊàë‰ª¨‰ΩøÁî® getDisplayNameInGroup ÂáΩÊï∞Êù•Ëé∑ÂèñÊ≠£Á°ÆÁöÑÁæ§ÊòµÁß∞
                    senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
                } else {
                    // Âú®ÂçïËÅä‰∏≠ÔºåÁõ¥Êé•‰ΩøÁî®Â§áÊ≥®Âêç
                    senderDisplayName = chat.name;
                }
            }
            // „Äê„Äê„Äê‰øÆÂ§çÁªìÊùü„Äë„Äë„Äë
        
            const fullContent = String(message.content || '');
            let previewSnippet = '';
        
            if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
                previewSnippet = '[Ë°®ÊÉÖ]';
            } else if (message.type === 'ai_image' || message.type === 'user_photo') {
                previewSnippet = '[ÂõæÁâá]';
            } else if (message.type === 'voice_message') {
                previewSnippet = '[ËØ≠Èü≥]';
            } else {
                previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
            }
        
            currentReplyContext = {
                timestamp: message.timestamp,
                senderName: senderDisplayName, // ‰ΩøÁî®Êàë‰ª¨ÂàöÂàöËé∑ÂèñÂà∞ÁöÑ„ÄÅÊ≠£Á°ÆÁöÑÊòæÁ§∫ÂêçÁß∞
                content: fullContent, 
            };
        
            const previewBar = document.getElementById('reply-preview-bar');
            previewBar.querySelector('.sender').textContent = `ÂõûÂ§ç ${currentReplyContext.senderName}:`;
            previewBar.querySelector('.text').textContent = previewSnippet;
            previewBar.style.display = 'block';
        
            hideMessageActions();
            document.getElementById('chat-input').focus();
        }
        
        function cancelReplyMode() {
            currentReplyContext = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®Êà∑Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊ†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        let activeTransferTimestamp = null; // Áî®‰∫éÊöÇÂ≠òË¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
        
        /**
         * ÊòæÁ§∫Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         */
        function showTransferActionModal(timestamp) {
            activeTransferTimestamp = timestamp;
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (message) {
                // Â∞ÜAIÁöÑÂêçÂ≠óÂ°´ÂÖ•ÂºπÁ™ó
                document.getElementById('transfer-sender-name').textContent = message.senderName;
            }
            document.getElementById('transfer-actions-modal').classList.add('visible');
        }
        
        /**
         * ÈöêËóèÂ§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
         */
        function hideTransferActionModal() {
            document.getElementById('transfer-actions-modal').classList.remove('visible');
            activeTransferTimestamp = null;
        }
        
        /**
         * Â§ÑÁêÜÁî®Êà∑Êé•ÂèóÊàñÊãíÁªùËΩ¨Ë¥¶ÁöÑÈÄªËæë
         * @param {string} choice - Áî®Êà∑ÁöÑÈÄâÊã©, 'accepted' Êàñ 'declined'
         */
        async function handleUserTransferResponse(choice) {
            if (!activeTransferTimestamp) return;
        
            const timestamp = activeTransferTimestamp;
            const chat = state.chats[state.activeChatId];
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            // 1. Êõ¥Êñ∞ÂéüÂßãËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÁä∂ÊÄÅ
            const originalMessage = chat.history[messageIndex];
            originalMessage.status = choice;
        
            let systemContent;
        
            // 2. Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊãíÁªù‚Äù
            if (choice === 'declined') {
                // Á´ãÂàªÂú®ÂâçÁ´ØÁîüÊàê‰∏Ä‰∏™‚ÄúÈÄÄÊ¨æ‚ÄùÂç°ÁâáÔºåËÆ©Áî®Êà∑ÁúãÂà∞
                const refundMessage = {
                    role: 'user',
                    type: 'transfer',
                    isRefund: true, // ËøôÊòØ‰∏Ä‰∏™ÂÖ≥ÈîÆÊ†áËÆ∞ÔºåÁî®‰∫éUIÊòæÁ§∫ËøôÊòØÈÄÄÊ¨æ
                    amount: originalMessage.amount,
                    note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
                    timestamp: Date.now()
                };
                chat.history.push(refundMessage);
                
                // ÂáÜÂ§á‰∏ÄÊù°ÂØπAIÂèØËßÅÁöÑÈöêËóèÊ∂àÊÅØÔºåÂëäËØâÂÆÉÂèëÁîü‰∫Ü‰ªÄ‰πà
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
            } else { // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©‚ÄúÊé•Âèó‚Äù
                // Âè™ÈúÄÂáÜÂ§áÈöêËóèÊ∂àÊÅØÈÄöÁü•AIÂç≥ÂèØ
                systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
            }
        
            // 3. ÂàõÂª∫ËøôÊù°ÂØπÁî®Êà∑ÈöêËóè„ÄÅ‰ΩÜÂØπAIÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now() + 1, // ‰øùËØÅÊó∂Èó¥Êà≥Âú®ÈÄÄÊ¨æÊ∂àÊÅØ‰πãÂêé
                isHidden: true // Ëøô‰∏™Ê†áËÆ∞‰ºöËÆ©ÂÆÉ‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
            };
            chat.history.push(hiddenMessage);
        
            // 4. ‰øùÂ≠òÊâÄÊúâÊõ¥ÊîπÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Âà∑Êñ∞ÁïåÈù¢
            await db.chats.put(chat);
            hideTransferActionModal(); 
            renderChatInterface(state.activeChatId);
            renderChatList();
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄöËØùËÆ∞ÂΩïÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        async function renderCallHistoryScreen() {
            showScreen('call-history-screen'); // <--„ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊääÂÆÉÁßªÂä®Âà∞ÊúÄÂâçÈù¢ÔºÅ
        
            const listEl = document.getElementById('call-history-list');
            const titleEl = document.getElementById('call-history-title');
            listEl.innerHTML = '';
            titleEl.textContent = 'ÊâÄÊúâÈÄöËØùËÆ∞ÂΩï';
            
            const records = await db.callRecords.orderBy('timestamp').reverse().toArray();
            
            if (records.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÈÄöËØùËÆ∞ÂΩïÂì¶~</p>';
                return; // Áé∞Âú®ÁöÑ return Â∞±Ê≤°ÈóÆÈ¢ò‰∫ÜÔºåÂõ†‰∏∫ÂÆÉÂè™Ë∑≥Ëøá‰∫ÜÂêéÁª≠ÁöÑÊ∏≤ÊüìÈÄªËæë
            }
            
            records.forEach(record => {
                const card = createCallRecordCard(record);
        
            addLongPressListener(card, async () => {
                // 1. ÂºπÂá∫ËæìÂÖ•Ê°ÜÔºåÂπ∂Â∞ÜÊóßÂêçÁß∞‰Ωú‰∏∫ÈªòËÆ§ÂÄºÔºåÊñπ‰æø‰øÆÊîπ
                const newName = await showCustomPrompt(
                    "Ëá™ÂÆö‰πâÈÄöËØùÂêçÁß∞", 
                    "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂêçÁß∞ÔºàÁïôÁ©∫ÂàôÊÅ¢Â§çÈªòËÆ§Ôºâ",
                    record.customName || '' // Â¶ÇÊûúÂ∑≤ÊúâËá™ÂÆö‰πâÂêçÁß∞ÔºåÂ∞±ÊòæÁ§∫ÂÆÉ
                );
        
                // 2. Â¶ÇÊûúÁî®Êà∑ÁÇπÂáª‰∫Ü‚ÄúÂèñÊ∂à‚ÄùÔºåÂàô‰ªÄ‰πàÈÉΩ‰∏çÂÅö
                if (newName === null) return;
                
                // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËøôÊù°ËÆ∞ÂΩï
                await db.callRecords.update(record.id, { customName: newName.trim() });
                
                // 4. Âà∑Êñ∞Êï¥‰∏™ÂàóË°®ÔºåËÆ©Êõ¥ÊîπÁ´ãÂàªÊòæÁ§∫Âá∫Êù•
                await renderCallHistoryScreen();
                
                // 5. ÁªôÁî®Êà∑‰∏Ä‰∏™ÊàêÂäüÁöÑÊèêÁ§∫
                await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÂêçÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ');
            });
                listEl.appendChild(card);
            });    
        }
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂçáÁ∫ßÁâà„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†ÊóßÁöÑ createCallRecordCard ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂçáÁ∫ßÁâà„ÄëÊ†πÊçÆÂçïÊù°ËÆ∞ÂΩïÊï∞ÊçÆÔºåÂàõÂª∫‰∏ÄÂº†ËÉΩÊòæÁ§∫ËÅäÂ§©ÂØπË±°ÁöÑÈÄöËØùÂç°Áâá
         * @param {object} record - ‰∏ÄÊù°ÈÄöËØùËÆ∞ÂΩïÂØπË±°
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑÂç°Áâádiv
         */
        function createCallRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'call-record-card';
            card.dataset.recordId = record.id; 
        
            // Ëé∑ÂèñÈÄöËØùÂØπË±°ÁöÑÂêçÂ≠ó
            const chatInfo = state.chats[record.chatId];
            const chatName = chatInfo ? chatInfo.name : 'Êú™Áü•‰ºöËØù';
        
            const callDate = new Date(record.timestamp);
            const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
            const durationText = `${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí`;
        
            const avatarsHtml = record.participants.map(p => 
                `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
            ).join('');
            
            card.innerHTML = `
                <div class="card-header">
                    <span class="date">${dateString}</span>
                    <span class="duration">${durationText}</span>
                </div>
                <div class="card-body">
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊñ∞Â¢û‰∏Ä‰∏™Ê†áÈ¢òË°å -->
                    ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
                    
                    <div class="participants-info"> <!-- Êñ∞Â¢û‰∏Ä‰∏™ÂÆπÂô®Êñπ‰æøÂ∏ÉÂ±Ä -->
                        <div class="participants-avatars">${avatarsHtml}</div>
                        <span class="participants-names">‰∏é ${chatName}</span>
                    </div>
                </div>
            `;
            return card;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
/**
 * „ÄêV3.0 | ÊÄªÁªìÊµÅÁ®ã‰øÆÂ§çÁâà„ÄëÊòæÁ§∫ÊåáÂÆöÈÄöËØùËÆ∞ÂΩïÁöÑÂÆåÊï¥ÊñáÂ≠óÁ®ø
 * @param {number} recordId - ÈÄöËØùËÆ∞ÂΩïÁöÑID
 */
async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('transcript-modal-body');

    titleEl.textContent = `ÈÄöËØù‰∫é ${new Date(record.timestamp).toLocaleString()} (Êó∂Èïø: ${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí)`;
    bodyEl.innerHTML = '';
    
    const deleteBtn = document.getElementById('delete-transcript-btn');
    const summarizeBtn = document.getElementById('manual-summarize-btn');
    
    if (!record.transcript || record.transcript.length === 0) {
        bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøôÊ¨°ÈÄöËØùÊ≤°ÊúâÁïô‰∏ãÊñáÂ≠óËÆ∞ÂΩï„ÄÇ</p>';
        summarizeBtn.style.display = 'none';
    } else {
        summarizeBtn.style.display = 'block';
        record.transcript.forEach(entry => {
            const bubble = document.createElement('div');
            bubble.className = `transcript-entry ${entry.role}`; 
            bubble.textContent = entry.content;
            bodyEl.appendChild(bubble);
        });
    }

    // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÁ°Æ‰øùÊØèÊ¨°ÊâìÂºÄÈÉΩÁªëÂÆöÂÖ®Êñ∞ÁöÑ„ÄÅÂπ≤ÂáÄÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    const newSummarizeBtn = summarizeBtn.cloneNode(true);
    summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);
    
    newDeleteBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm(
            "Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÈÄöËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", { confirmButtonClass: 'btn-danger' }
        );
        if (confirmed) {
            modal.classList.remove('visible');
            await db.callRecords.delete(recordId);
            await renderCallHistoryScreen();
            alert('ÈÄöËØùËÆ∞ÂΩïÂ∑≤Âà†Èô§„ÄÇ');
        }
    });

    // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÂ∞±Âú®ËøôÈáå ‚ñº‚ñº‚ñº
    newSummarizeBtn.addEventListener('click', async () => {
        modal.classList.remove('visible');
        const chat = state.chats[record.chatId];
        if (!chat) {
            alert('ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÈÄöËØùËÆ∞ÂΩïÊâÄÂ±ûÁöÑËÅäÂ§©ÂØπË±°„ÄÇ');
            return;
        }

        await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åÊâãÂä®ÊÄªÁªì...");
        
        try {
            const transcriptText = record.transcript.map(h => {
                const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (h.senderName || chat.name);
                return `${sender}: ${h.content}`;
            }).join('\n');

            // 1. Ë∞ÉÁî®Êàë‰ª¨ÈáçÊûÑÂêéÁöÑÊÄªÁªìÂáΩÊï∞ÔºåÂπ∂Êé•Êî∂ÂÆÉÁöÑËøîÂõûÁªìÊûú
            const result = await summarizeCallTranscript(record.chatId, transcriptText);

            // 2. Ê†πÊçÆËøîÂõûÁªìÊûúÁöÑ success Â±ûÊÄßÔºåÊù•ÂÜ≥ÂÆöÊòæÁ§∫Âì™‰∏™ÊèêÁ§∫Ê°Ü
            if (result.success) {
                // Âè™ÊúâÂú®ÊòéÁ°ÆÊàêÂäüÊó∂ÔºåÊâçÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                await showCustomAlert("ÊÄªÁªìÊàêÂäü", `ÊâãÂä®ÊÄªÁªìÂ∑≤ÂÆåÊàêÔºÅÊñ∞ÁöÑËÆ∞ÂøÜÂ∑≤Ê∑ªÂä†Âà∞‚Äú${chat.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠„ÄÇ`);
            } else {
                // Â¶ÇÊûúÂ§±Ë¥•ÔºåÂ∞±ÊòæÁ§∫Â§±Ë¥•ÊèêÁ§∫ÔºåÂπ∂ÈôÑ‰∏ä‰ªéÂáΩÊï∞ËøîÂõûÁöÑËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
                await showCustomAlert("ÊÄªÁªìÂ§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•ÔºåÊú™ËÉΩÁîüÊàêÈïøÊúüËÆ∞ÂøÜ„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ: ${result.error}`);
            }

        } catch (unexpectedError) {
            // Ëøô‰∏™catchÂùóÁé∞Âú®Âè™Áî®‰∫éÊçïËé∑ÊÑèÊñô‰πãÂ§ñÁöÑÁ®ãÂ∫èÈîôËØØÔºåËÆ©Ë∞ÉËØïÊõ¥Ê∏ÖÊô∞
            console.error("ÊâãÂä®ÊÄªÁªìÊó∂ÂèëÁîüÊÑèÂ§ñÈîôËØØ:", unexpectedError);
            await showCustomAlert("Á®ãÂ∫èÂºÇÂ∏∏", `Êìç‰ΩúËøáÁ®ã‰∏≠ÂèëÁîüÊÑèÂ§ñÈîôËØØ: ${unexpectedError.message}`);
        }
    });
    // ‚ñ≤‚ñ≤‚ñ≤ Ê†∏ÂøÉ‰øÆÊîπÂà∞ËøôÈáåÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

    modal.classList.add('visible');
}
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂÖ®Êñ∞ÂáΩÊï∞„ÄëÊõøÊç¢Êéâ‰Ω†ÊóßÁöÑ handleStatusResetClick ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÁä∂ÊÄÅÊ†èÔºåÂºπÂá∫ÁºñËæëÊ°ÜËÆ©Áî®Êà∑‰øÆÊîπAIÁöÑÂΩìÂâçÁä∂ÊÄÅ
         */
        async function handleEditStatusClick() {
            // 1. ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÂú®ÂçïËÅäÁïåÈù¢
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
                return; 
            }
            const chat = state.chats[state.activeChatId];
        
            // 2. ÂºπÂá∫ËæìÂÖ•Ê°ÜÔºåËÆ©Áî®Êà∑ËæìÂÖ•Êñ∞ÁöÑÁä∂ÊÄÅÔºåÂπ∂Â∞ÜÂΩìÂâçÁä∂ÊÄÅ‰Ωú‰∏∫ÈªòËÆ§ÂÄº
            const newStatusText = await showCustomPrompt(
                'ÁºñËæëÂØπÊñπÁä∂ÊÄÅ',
                'ËØ∑ËæìÂÖ•ÂØπÊñπÁé∞Âú®ÁöÑÊñ∞Áä∂ÊÄÅÔºö',
                chat.status.text // Â∞ÜÂΩìÂâçÁä∂ÊÄÅ‰Ωú‰∏∫ËæìÂÖ•Ê°ÜÁöÑÈªòËÆ§ÂÜÖÂÆπ
            );
        
            // 3. Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‰∫Ü‚ÄúÁ°ÆÂÆö‚Äù
            if (newStatusText !== null) {
                // 4. Êõ¥Êñ∞ÂÜÖÂ≠òÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁä∂ÊÄÅÊï∞ÊçÆ
                chat.status.text = newStatusText.trim() || 'Âú®Á∫ø'; // Â¶ÇÊûúÁî®Êà∑Ê∏ÖÁ©∫‰∫ÜÔºåÂ∞±ÈªòËÆ§‰∏∫‚ÄúÂú®Á∫ø‚Äù
                chat.status.isBusy = false; // ÊØèÊ¨°ÊâãÂä®ÁºñËæëÈÉΩÈªòËÆ§ÂÖ∂‰∏çÂ§Ñ‰∫é‚ÄúÂøôÁ¢å‚ÄùÁä∂ÊÄÅ
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
        
                // 5. Á´ãÂàªÂà∑Êñ∞UIÔºåËÆ©Áî®Êà∑ÁúãÂà∞‰øÆÊîπÂêéÁöÑÁä∂ÊÄÅ
                renderChatInterface(state.activeChatId);
                renderChatList();
                
                // 6. ÁªôÂá∫‰∏Ä‰∏™Êó†‰º§Â§ßÈõÖÁöÑÊàêÂäüÊèêÁ§∫
                await showCustomAlert('Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', `‚Äú${chat.name}‚ÄùÁöÑÂΩìÂâçÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫Ôºö${chat.status.text}`);
            }
        }
        
        // ÊîæÂú®‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫
        async function openShareTargetPicker() {
            const modal = document.getElementById('share-target-modal');
            const listEl = document.getElementById('share-target-list');
            listEl.innerHTML = '';
        
            // Ëé∑ÂèñÊâÄÊúâËÅäÂ§©‰Ωú‰∏∫ÂàÜ‰∫´ÁõÆÊ†á
            const chats = Object.values(state.chats);
        
            chats.forEach(chat => {
                // Â§çÁî®ËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®ÁöÑÊ†∑Âºè
                const item = document.createElement('div');
                item.className = 'contact-picker-item'; 
                item.innerHTML = `
                    <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
                listEl.appendChild(item);
            });
            
            modal.classList.add('visible');
        }
        
        function closeMusicPlayerWithAnimation(callback) {
            const overlay = document.getElementById('music-player-overlay');
            if (!overlay.classList.contains('visible')) {
                if (callback) callback();
                return;
            }
            overlay.classList.remove('visible');
            setTimeout(() => {
                document.getElementById('music-playlist-panel').classList.remove('visible');
                if (callback) callback();
            }, 400); 
        }
        
function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = String(lrcContent).split(/\r\n?|\n/);
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const line of lines) {
        const text = line.replace(timeRegex, '').trim();
        if (!text) continue;
        timeRegex.lastIndex = 0;
        let match;
        while ((match = timeRegex.exec(line)) !== null) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
            const time = minutes * 60 + seconds + milliseconds / 1000;
            lyrics.push({ time, text });
        }
    }
    return lyrics.sort((a, b) => a.time - b.time);
}

function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        lyricsList.innerHTML = '<div class="lyric-line">‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</div>';
        return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'lyric-line';
        lineEl.textContent = line.text;
        lineEl.dataset.index = index;
        lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
}

function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
        if (currentTime >= musicState.parsedLyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();
    
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            singleLyricEl.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™';
        }
    }

    const lyricBar = document.getElementById('global-lyrics-bar');
    if (lyricBar.classList.contains('visible')) {
        if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
            lyricBar.textContent = musicState.parsedLyrics[newLyricIndex].text;
        } else {
            lyricBar.textContent = '‚ô™';
        }
    }
}

function updateLyricsUI(isFullscreen = false) {
    const listSelector = isFullscreen ? '#fullscreen-lyrics-container .music-lyrics-list' : '#music-lyrics-container #music-lyrics-list';
    const containerSelector = isFullscreen ? '#fullscreen-lyrics-container' : '#music-lyrics-container';
    
    const lyricsList = document.querySelector(listSelector);
    const container = document.querySelector(containerSelector);
    if (!lyricsList || !container) return;

    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));

    if (musicState.currentLyricIndex === -1) {
        lyricsList.style.transform = `translateY(0px)`;
        return;
    }

    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
        activeLine.classList.add('active');
        const containerHeight = container.offsetHeight;
        const offset = (containerHeight / 2.2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
        lyricsList.style.transform = `translateY(${offset}px)`;
    }
}

function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
}

let lastTimeUpdate = 0; 
let animationFrameId; 

function updateMusicProgressBar() {
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }

    function step() {
        if (!musicState.isPlaying || !audioPlayer.duration) {
            return; 
        }
        
        const now = performance.now();
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;

        const progressPercent = (currentTime / duration) * 100;
        document.getElementById('music-progress-fill').style.width = `${progressPercent}%`;

        if (now - lastTimeUpdate > 1000) {
            document.getElementById('music-current-time').textContent = formatMusicTime(currentTime);
            document.getElementById('music-total-time').textContent = formatMusicTime(duration);
            lastTimeUpdate = now;
        }

        updateActiveLyric(currentTime);

        animationFrameId = requestAnimationFrame(step);
    }

    animationFrameId = requestAnimationFrame(step);
}
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂØºÊºîÊ®°ÂºèÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊâìÂºÄ‚ÄúÂØºÊºîÂâ™ËæëÂÆ§‚ÄùÔºåÁºñËæëAIÁöÑ‰∏ä‰∏ÄËΩÆÂìçÂ∫î
         */
        function openAiResponseEditor() {
            if (!lastRawAiResponse) {
                alert("ËøòÊ≤°ÊúâÂèØ‰æõÁºñËæëÁöÑAIÂìçÂ∫î„ÄÇËØ∑ÂÖàËÆ©AIÂõûÂ§ç‰∏ÄÊ¨°„ÄÇ");
                return;
            }
        
            const editorModal = document.getElementById('ai-response-editor-modal');
            const editorContainer = document.getElementById('ai-response-editor-container');
            editorContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπ
        
            // ‰ΩøÁî®‰∏é‰∏ªÊµÅÁ®ãÁõ∏ÂêåÁöÑ„ÄÅÂº∫Â§ßÁöÑËß£ÊûêÂáΩÊï∞Êù•ÊèêÂèñÊâÄÊúâJSONÂØπË±°
            const jsonMatches = lastRawAiResponse.match(/{[^{}]*}/g);
            
            if (jsonMatches) {
                jsonMatches.forEach(jsonString => {
                    try {
                        // ÁæéÂåñJSONÊ†ºÂºèÔºåÊñπ‰æøÈòÖËØªÂíåÁºñËæë
                        const parsedObject = JSON.parse(jsonString);
                        const formattedJson = JSON.stringify(parsedObject, null, 2);
                        const block = createAiResponseEditorBlock(formattedJson);
                        editorContainer.appendChild(block);
                    } catch (e) {
                        // Â¶ÇÊûúÊüê‰∏™ÁâáÊÆµ‰∏çÊòØÊúâÊïàÁöÑJSONÔºå‰πüÊääÂÆÉÊòæÁ§∫Âá∫Êù•ÔºåËÆ©Áî®Êà∑ÂèØ‰ª•‰øÆÊ≠£ÂÆÉ
                        const block = createAiResponseEditorBlock(jsonString);
                        editorContainer.appendChild(block);
                        console.warn("Âú®ÂØºÊºîÊ®°Âºè‰∏≠ÂèëÁé∞‰∏Ä‰∏™Êó†ÊïàÁöÑJSONÁâáÊÆµ:", jsonString);
                    }
                });
            } else {
                // Â¶ÇÊûúÂÆåÂÖ®Ê≤°ÊúâÊâæÂà∞JSONÔºåÂ∞±ÊääÂéüÂßãÊñáÊú¨ÊîæËøõÂéªËÆ©Áî®Êà∑ÁºñËæë
                const block = createAiResponseEditorBlock(lastRawAiResponse);
                editorContainer.appendChild(block);
            }
            
            editorModal.classList.add('visible');
        }
        
        /**
         * „ÄêËæÖÂä©ÂáΩÊï∞„ÄëÂàõÂª∫‰∏Ä‰∏™ÂèØÁºñËæëÁöÑAIÂìçÂ∫îÂùó
         * @param {string} initialContent - ÊñáÊú¨Ê°ÜÁöÑÂàùÂßãÂÜÖÂÆπ
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
         */
        function createAiResponseEditorBlock(initialContent = '') {
            const block = document.createElement('div');
            block.className = 'ai-response-editor-block';
        
            // ÂÆö‰πâÂ∏∏Áî®Ê†ºÂºèÁöÑÊ®°ÊùøÔºåÊñπ‰æøÁî®Êà∑Ê∑ªÂä†
            const templates = {
                text: { type: 'text', content: 'Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨...' },
                sticker: { type: 'sticker', url: 'https://...', meaning: 'Ë°®ÊÉÖÂê´‰πâ' },
                image: { type: 'ai_image', description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞...' },
                voice: { type: 'voice_message', content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ...' },
                transfer: { type: 'transfer', amount: 5.20, note: '‰∏ÄÁÇπÂøÉÊÑè' }
            };
        
            block.innerHTML = `
                <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°Âä®‰Ωú">√ó</button>
                <textarea>${initialContent}</textarea>
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.text)}'>ÊñáÊú¨</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.sticker)}'>Ë°®ÊÉÖ</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
                </div>
            `;
        
            // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
            block.querySelector('.delete-block-btn').addEventListener('click', () => {
                block.remove();
            });
        
            // ÁªëÂÆöÊ†ºÂºèÂä©ÊâãÊåâÈíÆ‰∫ã‰ª∂
            block.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const templateStr = btn.dataset.template;
                    const textarea = block.querySelector('textarea');
                    if (templateStr && textarea) {
                        try {
                            const templateObj = JSON.parse(templateStr);
                            // ÁæéÂåñÊ†ºÂºèÂêéÂ°´ÂÖ•
                            textarea.value = JSON.stringify(templateObj, null, 2);
                            textarea.focus();
                        } catch(e) { console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e); }
                    }
                });
            });
        
            return block;
        }
        // ‚ñº‚ñº‚ñº „ÄêV3.0 | ÂÆπÈîôÁªàÊûÅ‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ saveEditedAiResponse ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÊ†∏ÂøÉ„Äë‰øùÂ≠òÂØºÊºîÊ®°Âºè‰∏ã‰øÆÊîπËøáÁöÑÂÜÖÂÆπÔºåÂπ∂ÈáçÂÜôÂéÜÂè≤ËÆ∞ÂΩï
         */
        async function saveEditedAiResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. ‰ªéDOM‰∏≠Êî∂ÈõÜÊâÄÊúâÁºñËæëÂêéÁöÑJSONÂ≠óÁ¨¶‰∏≤ÔºåÂπ∂ÊûÑÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂéüÂßãÂìçÂ∫îÂ≠óÁ¨¶‰∏≤
            const editorContainer = document.getElementById('ai-response-editor-container');
            const editorTextareas = editorContainer.querySelectorAll('textarea');
            const editedRawBlocks = Array.from(editorTextareas).map(ta => ta.value.trim()).filter(Boolean);
        
            // Â¶ÇÊûúÁî®Êà∑Âà†Èô§‰∫ÜÊâÄÊúâÂÜÖÂÆπÔºåÂàôËßÜ‰∏∫Ê∏ÖÁ©∫‰∏ä‰∏ÄËΩÆÂõûÂ§ç
            if (editedRawBlocks.length === 0) {
                chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
                document.getElementById('ai-response-editor-modal').classList.remove('visible');
                lastRawAiResponse = '';
                lastResponseTimestamps = [];
                return;
            }
        
            // 2. Ëß£ÊûêÊñ∞ÁöÑÊ∂àÊÅØÊï∞ÁªÑ
            let newMessagesArray = [];
            for (const rawContent of editedRawBlocks) {
                try {
                    const parsedObject = JSON.parse(rawContent);
                    newMessagesArray.push(parsedObject);
                } catch (e) {
                    console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†Ê≥ïËß£Êûê‰∏∫JSONÁöÑÁºñËæëÂùó:", rawContent);
                }
            }
        
            // 3. ‰ªéËÅäÂ§©ÂéÜÂè≤‰∏≠ÁßªÈô§‰∏ä‰∏ÄËΩÆAIÁîüÊàêÁöÑÊâÄÊúâÊ∂àÊÅØ
            chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));
        
            // 4. Â∞ÜÊñ∞ÁºñËæëÁöÑÊ∂àÊÅØÊ∑ªÂä†ÂõûÂéÜÂè≤ËÆ∞ÂΩïÔºåÂπ∂ËÆ∞ÂΩïÂÆÉ‰ª¨Êñ∞ÁöÑÊó∂Èó¥Êà≥
            let newTimestamps = [];
            let messageTimestamp = Date.now();
            
            for (const msgData of newMessagesArray) {
                 if (!msgData || typeof msgData !== 'object' || !msgData.type) {
                    console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÂèëÁé∞Êó†ÊïàÁöÑÊåá‰ª§ÂØπË±°ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
                    continue;
                }
        
                let aiMessage = null;
                const baseMessage = { role: 'assistant', senderName: msgData.name || chat.originalName, timestamp: messageTimestamp++ };
        
                switch (msgData.type) {
                    case 'text':
                        aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                        break;
                    case 'sticker':
                        aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                        break;
                    case 'ai_image':
                        aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                        break;
                    case 'voice_message':
                        aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                        break;
                    case 'transfer':
                        aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'Êàë' };
                        break;
                    case 'waimai_request':
                        aiMessage = { 
                            ...baseMessage, type: 'waimai_request',
                            productInfo: msgData.productInfo, amount: msgData.amount,
                            status: 'pending', countdownEndTime: Date.now() + 15 * 60 * 1000,
                        };
                        break;
                    case 'offline_text':
                        aiMessage = {
                            ...baseMessage, type: 'offline_text',
                            dialogue: msgData.dialogue, description: msgData.description
                        };
                        break;
                    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
                    case 'gomoku_move': {
                        const gameState = gomokuState[chat.id];
                        if (gameState) {
                            // 1. ÊâæÂà∞AIÁöÑ‰∏ä‰∏ÄÊ≠•Ê£ã
                            const lastAiMoveIndex = gameState.history.findLastIndex(move => move.player === 2);
                            
                            if (lastAiMoveIndex > -1) {
                                const move_to_undo = gameState.history[lastAiMoveIndex];
                                
                                // 2. ‰ªéÊ£ãÁõòÊï∞ÊçÆ‰∏≠‚ÄúÊãøÊéâ‚ÄùËøôÈ¢óÊ£ãÂ≠ê
                                gameState.board[move_to_undo.y][move_to_undo.x] = 0;
                                
                                // 3. ‰ªé‰∏ãÊ£ãÂéÜÂè≤‰∏≠ÁßªÈô§Ëøô‰∏ÄÊ≠•
                                gameState.history.splice(lastAiMoveIndex, 1);
                                
                                console.log(`ÂØºÊºîÊ®°ÂºèÊÇîÊ£ãÔºöÂ∑≤Êí§ÈîÄAIÂú® (${move_to_undo.x}, ${move_to_undo.y}) ÁöÑÊ£ãÊ≠•„ÄÇ`);
                            }
                        }

                        // 4. ÊâßË°åÊñ∞ÁöÑ‰∏ãÊ£ãÊåá‰ª§
                        const x = parseInt(msgData.x);
                        const y = parseInt(msgData.y);
                        if (!isNaN(x) && !isNaN(y)) {
                            handleAiGomokuMove({ x: x, y: y }, true);
                        } else {
                            console.warn("ÂØºÊºîÊ®°Âºè‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™Êó†ÊïàÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§:", msgData);
                        }
                        continue;
                    }
                    case 'update_thoughts': { 
                        if (!chat.isGroup) {
                            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
                            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
                            if (!Array.isArray(chat.thoughtsHistory)) chat.thoughtsHistory = [];
                            chat.thoughtsHistory.push({
                                heartfeltVoice: chat.heartfeltVoice,
                                randomJottings: chat.randomJottings,
                                timestamp: Date.now()
                            });
                            if (chat.thoughtsHistory.length > 50) chat.thoughtsHistory.shift();
                        }
                        continue;
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    default:
                         console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÈÅáÂà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
                         break;
                }
        
                if (aiMessage) {
                    chat.history.push(aiMessage);
                    newTimestamps.push(aiMessage.timestamp);
                }
            }
        
            // 5. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞Êï¥‰∏™ËÅäÂ§©ÁïåÈù¢
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            renderChatList();
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
            
            // 6. Êõ¥Êñ∞ÁºìÂ≠òÔºå‰ª•‰æø‰∏ãÊ¨°ÁºñËæë
            lastRawAiResponse = editedRawBlocks.join('\n\n');
            lastResponseTimestamps = newTimestamps;
            
            // 7. ÁªôÂá∫ÊàêÂäüÊèêÁ§∫
            await showCustomAlert("ÂØºÊºîÊ®°Âºè", "ÊÇ®ÁöÑ‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ");
        }
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáª‚ÄúÊí§Âõû‚ÄùÊåâÈíÆÁöÑÂÖ•Âè£ÂáΩÊï∞
         */
        async function handleRecallClick() {
            if (!activeMessageTimestamp) return;
        
            const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // ËÆæÁΩÆ2ÂàÜÈíüÁöÑÊí§ÂõûÊó∂Èôê
            const messageTime = activeMessageTimestamp;
            const now = Date.now();
        
            // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøá‰∫ÜÊí§ÂõûÊó∂Èôê
            if (now - messageTime > RECALL_TIME_LIMIT_MS) {
                hideMessageActions();
                await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', 'ËØ•Ê∂àÊÅØÂèëÈÄÅÂ∑≤Ë∂ÖËøá2ÂàÜÈíüÔºåÊó†Ê≥ïÊí§Âõû„ÄÇ');
                return;
            }
            
            // Â¶ÇÊûúÂú®Êó∂ÈôêÂÜÖÔºåÊâßË°åÁúüÊ≠£ÁöÑÊí§ÂõûÈÄªËæë
            await recallMessage(messageTime, true);
            hideMessageActions();
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÊí§ÂõûÁöÑÊ†∏ÂøÉÈÄªËæë
         * @param {number} timestamp - Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @param {boolean} isUserRecall - ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®Êí§Âõû
         */
        async function recallMessage(timestamp, isUserRecall) {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
            if (messageIndex === -1) return;
        
            const messageToRecall = chat.history[messageIndex];
        
            // 1. ‰øÆÊîπÊ∂àÊÅØÂØπË±°ÔºåÂ∞ÜÂÖ∂Âèò‰∏∫‚ÄúÂ∑≤Êí§Âõû‚ÄùÁä∂ÊÄÅ
            const recalledData = {
                originalType: messageToRecall.type || 'text',
                originalContent: messageToRecall.content,
                // ‰øùÂ≠òÂÖ∂‰ªñÂèØËÉΩÂ≠òÂú®ÁöÑÂéüÂßãÊï∞ÊçÆ
                originalMeaning: messageToRecall.meaning,
                originalQuote: messageToRecall.quote 
            };
            
            messageToRecall.type = 'recalled_message';
            messageToRecall.content = isUserRecall ? '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ' : 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
            messageToRecall.recalledData = recalledData;
            // Ê∏ÖÁêÜÊéâ‰∏çÂÜçÈúÄË¶ÅÁöÑÊóßÂ±ûÊÄß
            delete messageToRecall.meaning;
            delete messageToRecall.quote;
        
            // 2. Â¶ÇÊûúÊòØÁî®Êà∑Êí§ÂõûÔºåÈúÄË¶ÅÁªôAIÂèëÈÄÅ‰∏ÄÊù°ÂÆÉÁúã‰∏çÊáÇÂÜÖÂÆπÁöÑÈöêËóèÊèêÁ§∫
            if (isUserRecall) {
                const hiddenMessageForAI = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ‰Ω†‰∏çÁü•ÈÅìÂÜÖÂÆπÊòØ‰ªÄ‰πàÔºåÂè™ÈúÄÁü•ÈÅìËøô‰∏™‰∫ã‰ª∂Âç≥ÂèØ„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(hiddenMessageForAI);
            }
        
            // 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
            await db.chats.put(chat);
            renderChatInterface(state.activeChatId);
            if(isUserRecall) renderChatList(); // Áî®Êà∑Êí§ÂõûÊó∂ÔºåÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂèò‰∫ÜÔºåÈúÄË¶ÅÂà∑Êñ∞ÂàóË°®
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ∞ÜËøô‰∫õÂáΩÊï∞Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        
        /**
         * ÊâìÂºÄÂàÜÁ±ªÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
         */
        async function openCategoryManager() {
            await renderCategoryListInManager();
            document.getElementById('world-book-category-manager-modal').classList.add('visible');
        }
        
        /**
         * Âú®Ê®°ÊÄÅÊ°Ü‰∏≠Ê∏≤ÊüìÂ∑≤Â≠òÂú®ÁöÑÂàÜÁ±ªÂàóË°®
         */
        async function renderCategoryListInManager() {
            const listEl = document.getElementById('existing-categories-list');
            const categories = await db.worldBookCategories.toArray();
            listEl.innerHTML = '';
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
            }
            categories.forEach(cat => {
                // Â§çÁî®Â•ΩÂèãÂàÜÁªÑÁöÑÊ†∑Âºè
                const item = document.createElement('div');
                item.className = 'existing-group-item'; 
                item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
                `;
                listEl.appendChild(item);
            });
        }
        
        /**
         * Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑ‰∏ñÁïå‰π¶ÂàÜÁ±ª
         */
        async function addNewCategory() {
            const input = document.getElementById('new-category-name-input');
            const name = input.value.trim();
            if (!name) {
                alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                return;
            }
            const existing = await db.worldBookCategories.where('name').equals(name).first();
            if (existing) {
                alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
                return;
            }
            await db.worldBookCategories.add({ name });
            input.value = '';
            await renderCategoryListInManager();
        }
        
        /**
         * Âà†Èô§‰∏Ä‰∏™‰∏ñÁïå‰π¶ÂàÜÁ±ª
         * @param {number} categoryId - Ë¶ÅÂà†Èô§ÁöÑÂàÜÁ±ªÁöÑID
         */
        async function deleteCategory(categoryId) {
            const confirmed = await showCustomConfirm(
                'Á°ÆËÆ§Âà†Èô§', 
                'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâ‰∏ñÁïå‰π¶Â∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', 
                { confirmButtonClass: 'btn-danger' }
            );
            if (confirmed) {
                await db.worldBookCategories.delete(categoryId);
                // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁ±ªÁöÑ‰∏ñÁïå‰π¶ÁöÑ categoryId ËÆæ‰∏∫ null
                const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
                for (const book of booksToUpdate) {
                    book.categoryId = null;
                    await db.worldBooks.put(book);
                    const bookInState = state.worldBooks.find(wb => wb.id === book.id);
                    if(bookInState) bookInState.categoryId = null;
                }
                await renderCategoryListInManager();
            }
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ÁâàÊú¨„ÄëÂèëÂ∏ÉÂÖ¨ÂëäÂáΩÊï∞ (Êó†ËØÑËÆ∫) ‚ñº‚ñº‚ñº
        async function publishToAnnouncementBoard() {
            if (!activeMessageTimestamp) return;
        
            const timestampToPublish = activeMessageTimestamp;
            hideMessageActions(); 
        
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestampToPublish);
            if (!message) return;
        
            // ÊèêÂèñÊ∂àÊÅØÂÜÖÂÆπÁî®‰∫éÈ¢ÑËßà
            let contentPreview = String(message.content || '').substring(0, 50) + '...';
            if (message.type === 'ai_image') contentPreview = '[ÂõæÁâá] ' + contentPreview;
        
            const confirmed = await showCustomConfirm(
                "ÂèëÂ∏ÉÂÖ¨Âëä",
                `Á°ÆÂÆöË¶ÅÂ∞Ü‰ª•‰∏ãÊ∂àÊÅØÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùøÂêóÔºü\n\n‚Äú${contentPreview}‚Äù`,
                { confirmText: "Á°ÆÂÆöÂèëÂ∏É" }
            );
        
            if (confirmed) {
                const myNickname = chat.settings.myNickname || 'Êàë';
        
                if (!Array.isArray(chat.announcements)) {
                    chat.announcements = [];
                }
        
                // Êñ∞Â¢ûÁöÑÂÖ¨ÂëäÂØπË±°
                const newAnnouncement = {
                    id: 'anno_' + Date.now(), // ‰∏∫ÊØè‰∏™ÂÖ¨ÂëäÊ∑ªÂä†ÂîØ‰∏ÄID
                    messageTimestamp: timestampToPublish,
                    publisher: myNickname,
                    publishedAt: Date.now(),
                    isPinned: false // ÈªòËÆ§‰∏∫‰∏çÁΩÆÈ°∂
                };
        
                chat.announcements.push(newAnnouncement);
        
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${myNickname} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞ÂÖ¨Âëä`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                await db.chats.put(chat);
                appendMessage(systemMessage, chat);
                renderChatList();
        
                await showCustomAlert("ÊàêÂäü", "ÂÖ¨ÂëäÂ∑≤ÂèëÂ∏ÉÔºÅ");
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * ÊòæÁ§∫Áæ§ÂÖ¨ÂëäÊùøÂºπÁ™ó
         */
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ÁâàÊú¨„ÄëÊòæÁ§∫ÂÖ¨ÂëäÊùøÂáΩÊï∞ (ÊîØÊåÅÂ§öÊù°‰∏éÁÆ°ÁêÜ) ‚ñº‚ñº‚ñº
        function showAnnouncementBoard() {
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÁÆ°ÁêÜÊ†∏ÂøÉÂäüËÉΩ ‚ñº‚ñº‚ñº
        let activeAnnouncementId = null; // Áî®‰∫éÊöÇÂ≠òÊ≠£Âú®Êìç‰ΩúÁöÑÂÖ¨ÂëäID
        
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // ÂàáÊç¢ÁΩÆÈ°∂Áä∂ÊÄÅ
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤ÊüìÂÖ¨ÂëäÊùø‰ª•Êõ¥Êñ∞UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
        
            const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", { confirmButtonClass: 'btn-danger' });
        
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤Êüì
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            const chat = state.chats[state.activeChatId];
            const announcements = chat.announcements || [];
        
            if (!chat || announcements.length === 0) {
                showCustomAlert("ÊèêÁ§∫", "ÂΩìÂâçÁæ§ËÅäËøòÊ≤°ÊúâÂÖ¨ÂëäÂì¶„ÄÇ");
                return;
            }
        
            const contentEl = document.getElementById('announcement-board-content');
            contentEl.innerHTML = '';
        
            // Â∞ÜÁΩÆÈ°∂ÁöÑÂÖ¨ÂëäÊéíÂú®ÊúÄÂâçÈù¢
            announcements.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));
        
            announcements.forEach(anno => {
                const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
        
                const wrapper = document.createElement('div');
                wrapper.className = 'announcement-item-wrapper';
        
                if (originalMessage) {
                    const messageBubbleEl = createMessageElement(originalMessage, chat);
                    wrapper.appendChild(messageBubbleEl);
                } else {
                    wrapper.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ÂÖ¨ÂëäÁöÑÂéüÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ</p>';
                }
        
                // Ê∑ªÂä†ÁΩÆÈ°∂Ê†áÂøó
                if (anno.isPinned) {
                    wrapper.innerHTML += `<div class="pinned-indicator">üìå</div>`;
                }
        
                // Ê∑ªÂä†‚Äú...‚ÄùÊìç‰ΩúÊåâÈíÆ
                wrapper.innerHTML += `<div class="announcement-item-actions" data-anno-id="${anno.id}">...</div>`;
        
                contentEl.appendChild(wrapper);
            });
        
            document.getElementById('announcement-board-modal').classList.add('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊÇ®Áº∫Â§±ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Á≤òË¥¥Âú®ËøôÈáå„Äë ‚ñº‚ñº‚ñº
        let activeAnnouncementId = null; // Áî®‰∫éÊöÇÂ≠òÊ≠£Âú®Êìç‰ΩúÁöÑÂÖ¨ÂëäID
        
        /**
         * ÁÇπÂáª‚Äú...‚ÄùÊó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçïÔºàÁΩÆÈ°∂/Âà†Èô§Ôºâ
         * @param {string} annoId - ÂÖ¨ÂëäÁöÑÂîØ‰∏ÄID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // Ê†πÊçÆÂΩìÂâçÊòØÂê¶Â∑≤ÁΩÆÈ°∂ÔºåÂä®ÊÄÅÊîπÂèòÊåâÈíÆÊñáÂ≠ó
            pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * Â§ÑÁêÜ‚ÄúÁΩÆÈ°∂/ÂèñÊ∂àÁΩÆÈ°∂‚ÄùÊìç‰Ωú
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // ÂàáÊç¢ÁΩÆÈ°∂Áä∂ÊÄÅ
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤ÊüìÂÖ¨ÂëäÊùø‰ª•Êõ¥Êñ∞UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * Â§ÑÁêÜ‚ÄúÂà†Èô§ÂÖ¨Âëä‚ÄùÊìç‰Ωú
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
            
            const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", { confirmButtonClass: 'btn-danger' });
            
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // ‰ªéÂÖ¨ÂëäÊï∞ÁªÑ‰∏≠ËøáÊª§ÊéâË¶ÅÂà†Èô§ÁöÑÂÖ¨Âëä
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤Êüì
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊÇ®Áº∫Â§±ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Á≤òË¥¥Âú®ËøôÈáå„Äë ‚ñº‚ñº‚ñº
        let editingFrameForMember = false;
        let currentFrameSelection = { ai: null, my: null };
        
        function openFrameSelectorModal(type = 'chat') {
            const frameModal = document.getElementById('avatar-frame-modal');
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
        
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }
        
        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const aiFrameGrid = document.getElementById('ai-frame-grid');
            const myFrameGrid = document.getElementById('my-frame-grid');
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';
        
            document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
            document.getElementById('ai-frame-content').style.display = 'block';
            document.getElementById('my-frame-content').style.display = 'none';
            document.getElementById('ai-frame-tab').classList.add('active');
            document.getElementById('my-frame-tab').classList.remove('active');
        
            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }
        
        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }
        
        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
        // ... (ÂáΩÊï∞ÂâçÈù¢ÁöÑ‰ª£Á†Å) ...
            await db.chats.put(chat);
        
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥‰øÆÂ§ç‰ª£Á†Å ‚ñº‚ñº‚ñº
            // Ê†∏ÂøÉ‰øÆÂ§çÔºöÂΩìÊõ¥Êñ∞ÂçïËÅäËßíËâ≤ÁöÑÂ§¥ÂÉèÊ°ÜÊó∂ÔºåÂêåÊ≠•Âà∞ÊâÄÊúâÂåÖÂê´ËØ•ËßíËâ≤ÁöÑÁæ§ËÅä‰∏≠
            if (!editingFrameForMember && !chat.isGroup) {
                const characterId = chat.id; // Ëé∑ÂèñË¢´‰øÆÊîπÁöÑËßíËâ≤ÁöÑID
        
                // ÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÊâæÂá∫ÂåÖÂê´Ëøô‰∏™ËßíËâ≤ÁöÑÁæ§ËÅä
                for (const groupChat of Object.values(state.chats)) {
                    if (groupChat.isGroup && groupChat.members) {
                        // Âú®Áæ§ËÅä‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÊàêÂëòÂØπË±°
                        const memberToUpdate = groupChat.members.find(m => m.id === characterId);
        
                        // Â¶ÇÊûúÊâæÂà∞‰∫ÜÔºåÂ∞±Êõ¥Êñ∞‰ªñÁöÑÂ§¥ÂÉèÊ°Ü‰ø°ÊÅØ
                        if (memberToUpdate) {
                            memberToUpdate.avatarFrame = chat.settings.aiAvatarFrame;
                            // „ÄêËá≥ÂÖ≥ÈáçË¶Å„ÄëÂ∞Ü‰øÆÊîπÂêéÁöÑ„ÄêÊï¥‰∏™Áæ§ËÅäÂØπË±°„ÄëÂ≠òÂõûÊï∞ÊçÆÂ∫ì
                            await db.chats.put(groupChat);
                            console.log(`Â∑≤ÂêåÊ≠•ËßíËâ≤ ${characterId} ÁöÑÂ§¥ÂÉèÊ°ÜÂà∞Áæ§ËÅä "${groupChat.name}"`);
                        }
                    }
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§ç‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            document.getElementById('avatar-frame-modal').classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('Â§¥ÂÉèÊ°ÜÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ'); // ‰øÆÊîπ‰∫ÜÊèêÁ§∫ÔºåËÆ©ÊÇ®Áü•ÈÅìÂêåÊ≠•‰πüÂÆåÊàê‰∫Ü
            editingFrameForMember = false;
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * Â∞ÜÁî®Êà∑Ëá™ÂÆö‰πâÁöÑÂÖ®Â±ÄCSSÂ∫îÁî®Âà∞È°µÈù¢
         * @param {string} cssString Áî®Êà∑ËæìÂÖ•ÁöÑCSS‰ª£Á†Å
         */
        function applyGlobalCss(cssString) {
            const styleTag = document.getElementById('global-custom-style');
            if (styleTag) {
                // Â¶ÇÊûúÊúâ‰ª£Á†ÅÂ∞±Â∫îÁî®ÔºåÊ≤°ÊúâÂ∞±Ê∏ÖÁ©∫
                styleTag.innerHTML = cssString || '';
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
        /**
         * ÂêëÂΩìÂâçËÅäÂ§©ÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Ê∑ªÂä†‰∏ÄÊù°ÂÖ≥‰∫éÈü≥‰πêÊìç‰ΩúÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØ
         * @param {string} actionText - ÊèèËø∞Áî®Êà∑Êìç‰ΩúÁöÑÊñáÊú¨Ôºå‰æãÂ¶Ç "ÊöÇÂÅú‰∫ÜÈü≥‰πê"
         */
        async function addMusicActionSystemMessage(actionText) {
            // 1. Ê£ÄÊü•Èü≥‰πêÂäüËÉΩÊòØÂê¶ÊøÄÊ¥ªÔºå‰ª•ÂèäÊòØÂê¶Âú®Êüê‰∏™ËÅäÂ§©‰∏≠
            if (!musicState.isActive || !musicState.activeChatId) return;
            const chat = state.chats[musicState.activeChatId];
            if (!chat) return;
        
            // 2. Ëé∑ÂèñÁî®Êà∑Âú®ÂΩìÂâçËÅäÂ§©‰∏≠ÁöÑÊòµÁß∞
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            const fullMessage = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ${actionText}]`;
        
            // 3. ÂàõÂª∫ËøôÊù°ÁâπÊÆäÁöÑ„ÄÅÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØ
            const systemMessage = {
                role: 'system',
                content: fullMessage,
                timestamp: Date.now(),
                isHidden: true // Ëøô‰∏™Ê†áËÆ∞ËÆ©Ê∂àÊÅØÂØπÁî®Êà∑‰∏çÂèØËßÅÔºå‰ΩÜAIËÉΩËØªÂà∞
            };
        
            // 4. Â∞ÜÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩïÂπ∂Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
            chat.history.push(systemMessage);
            await db.chats.put(chat);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâàÊú¨„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handleLongScreenshot ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêV3.0 | Â∏ÉÂ±Ä‰øÆÂ§çÁâà„ÄëÂ§ÑÁêÜÈïøÊà™ÂõæÂäüËÉΩ
         */
        async function handleLongScreenshot() {
            if (selectedMessages.size === 0) return;
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 0. ÊòæÁ§∫‚ÄúÁîüÊàê‰∏≠‚ÄùÁä∂ÊÄÅ
            const screenshotBtn = document.getElementById('selection-screenshot-btn');
            const originalBtnText = screenshotBtn.textContent;
            screenshotBtn.textContent = 'ÁîüÊàê‰∏≠...';
            screenshotBtn.disabled = true;
        
            // 1. ÂàõÂª∫‰∏¥Êó∂ÁöÑÊà™ÂõæÂÆπÂô®ÂíåÊ†∑ÂºèÔºàËøôÈÉ®ÂàÜ‰∏çÂèòÔºâ
            const screenshotContainer = document.createElement('div');
            const phoneScreen = document.getElementById('phone-screen');
            screenshotContainer.style.width = phoneScreen.offsetWidth + 'px';
            screenshotContainer.style.position = 'absolute';
            screenshotContainer.style.top = '-9999px';
            screenshotContainer.style.left = '-9999px';
            screenshotContainer.style.display = 'flex';
            screenshotContainer.style.flexDirection = 'column';
            screenshotContainer.style.height = 'auto';
            
            const chatScreen = document.getElementById('chat-interface-screen');
            screenshotContainer.style.backgroundImage = chatScreen.style.backgroundImage;
            screenshotContainer.style.backgroundColor = chatScreen.style.backgroundColor || (document.getElementById('phone-screen').classList.contains('dark-mode') ? '#000000' : '#f0f2f5');
        
            const tempStyle = document.createElement('style');
            tempStyle.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
            document.head.appendChild(tempStyle);
        
            try {
                // 2. ÁªÑË£ÖÊà™ÂõæÂÖÉÁ¥†ÔºàÂ§¥ÈÉ®ÂíåËæìÂÖ•Ê°ÜÈÉ®ÂàÜ‰∏çÂèòÔºâ
                const header = chatScreen.querySelector('.header').cloneNode(true);
                header.classList.add('cloned-header');
                
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÔºÅ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                // Êàë‰ª¨‰∏çÂÜç‰ΩøÁî® getComputedStyleÔºåËÄåÊòØÂàõÂª∫‰∏Ä‰∏™Âπ≤ÂáÄÁöÑÂÆπÂô®Âπ∂ÊâãÂä®Â∫îÁî®ÂÖ≥ÈîÆÊ†∑Âºè„ÄÇ
                const messagesContainer = document.createElement('div');
                const originalMessagesContainer = document.getElementById('chat-messages');
        
                // ÊâãÂä®ËÆæÁΩÆÊúÄÂÖ≥ÈîÆÁöÑÂ∏ÉÂ±ÄÊ†∑ÂºèÔºåÁ°Æ‰øùÊ∂àÊÅØËÉΩÊ≠£Á°ÆÊéíÂàó
                messagesContainer.style.display = 'flex';
                messagesContainer.style.flexDirection = 'column';
                messagesContainer.style.gap = '20px'; // ËøôÊòØÊ∂àÊÅØ‰πãÈó¥ÁöÑÂûÇÁõ¥Èó¥Ë∑ù
                messagesContainer.style.padding = '10px 15px 20px 15px'; // ‰∏ä„ÄÅÂ∑¶Âè≥„ÄÅ‰∏ãÂÜÖËæπË∑ùÔºåÂ∫ïÈÉ®Â§öÁïô‰∏ÄÁÇπ
                messagesContainer.style.width = '100%';
                messagesContainer.style.boxSizing = 'border-box';
        
                // ÁªßÊâø‰∏ªÈ¢òÂíåÂ≠ó‰ΩìÂ§ßÂ∞èÔºåËøôÂØπ‰∫éÊ∞îÊ≥°È¢úËâ≤ÂíåÊñáÂ≠óÂ§ßÂ∞èËá≥ÂÖ≥ÈáçË¶Å
                messagesContainer.dataset.theme = originalMessagesContainer.dataset.theme;
                messagesContainer.style.setProperty('--chat-font-size', originalMessagesContainer.style.getPropertyValue('--chat-font-size'));
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‰øÆÂ§çÁªìÊùü ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        
                const inputArea = chatScreen.querySelector('#chat-input-area').cloneNode(true);
        
                const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
                sortedTimestamps.forEach(timestamp => {
                    // Ê≥®ÊÑèÔºöÊàë‰ª¨ËøôÈáå‰æùÁÑ∂ÈúÄË¶Å‰ªéÂéüÂßãDOM‰∏≠ÂÖãÈöÜÔºåÂõ†‰∏∫ÂÆÉ‰ª¨Â∑≤ÁªèÂ∫îÁî®‰∫ÜÊâÄÊúâÂ§çÊùÇÁöÑCSS
                    const originalBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
                    if (originalBubble) {
                        const originalWrapper = originalBubble.closest('.message-wrapper');
                        if (originalWrapper) {
                            messagesContainer.appendChild(originalWrapper.cloneNode(true));
                        }
                    }
                });
        
                screenshotContainer.appendChild(header);
                screenshotContainer.appendChild(messagesContainer);
                screenshotContainer.appendChild(inputArea);
                document.body.appendChild(screenshotContainer);
                
                // ÂõæÁâáÈ¢ÑÂä†ËΩΩÈÄªËæëÔºà‰øùÊåÅ‰∏çÂèòÔºâ
                const images = Array.from(screenshotContainer.getElementsByTagName('img'));
                const imageLoadPromises = images.map(img => new Promise((resolve, reject) => {
                    if (img.src.startsWith('data:')) {
                        resolve();
                        return;
                    }
                    const newImg = new Image();
                    newImg.crossOrigin = 'anonymous';
                    newImg.onload = resolve;
                    newImg.onerror = resolve; 
                    newImg.src = img.src;
                }));
                
                await Promise.all(imageLoadPromises);
        
                // 3. Ë∞ÉÁî® html2canvasÔºà‰øùÊåÅ‰∏çÂèòÔºâ
                const canvas = await html2canvas(screenshotContainer, {
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: null,
                    scale: window.devicePixelRatio || 2,
                });
        
                // 4. ‰ΩøÁî® Blob ÂØπË±°‰∏ãËΩΩÔºà‰øùÊåÅ‰∏çÂèòÔºâ
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `EPhone-ÈïøÊà™Âõæ-${chat.name}-${Date.now()}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
        
            } catch (error) {
                console.error('ÈïøÊà™ÂõæÁîüÊàêÂ§±Ë¥•:', error);
                await showCustomAlert('ÁîüÊàêÂ§±Ë¥•', 'ÁîüÊàêÊà™ÂõæÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÊÉÖ„ÄÇ');
            } finally {
                // 5. Ê∏ÖÁêÜÂ∑•‰ΩúÔºà‰øùÊåÅ‰∏çÂèòÔºâ
                document.body.removeChild(screenshotContainer);
                document.head.removeChild(tempStyle);
                screenshotBtn.textContent = originalBtnText;
                screenshotBtn.disabled = false;
                exitSelectionMode(); 
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞JSÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂ¢ûÂº∫Áâà„Äë‰∏Ä‰∏™ÁÆÄÂçïÁöÑ Markdown Ëß£ÊûêÂô®
         * @param {string} text - ÂåÖÂê´ Markdown ËØ≠Ê≥ïÁöÑÂéüÂßãÊñáÊú¨
         * @returns {string} - ËΩ¨Êç¢Êàê HTML ÂêéÁöÑÊñáÊú¨
         */
        function parseMarkdown(text) {
            if (!text) return '';
        
            // È°∫Â∫èÂæàÈáçË¶ÅÔºåÂÖàÂ§ÑÁêÜÊúÄÂÖ∑‰ΩìÁöÑÔºà‰∏§‰∏™Â≠óÁ¨¶ÁöÑÔºâ
            // ËΩ¨Êç¢ **Á≤ó‰Ωì** ‰∏∫ <strong>Á≤ó‰Ωì</strong>
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // ËΩ¨Êç¢ ~~Âà†Èô§Á∫ø~~ ‰∏∫ <s>Âà†Èô§Á∫ø</s>
            text = text.replace(/\~\~(.*?)\~\~/g, '<s>$1</s>');
            
            // ‚ñº‚ñº‚ñº Êñ∞Â¢ûËßÑÂàô ‚ñº‚ñº‚ñº
            // ËΩ¨Êç¢ ==È´ò‰∫Æ== ‰∏∫ <mark>È´ò‰∫Æ</mark>
            text = text.replace(/==(.*?)==/g, '<mark>$1</mark>');
        
            // ËΩ¨Êç¢ ||Ê∂ÇÈªë|| ‰∏∫ <span class="spoiler">Ê∂ÇÈªë</span>
            text = text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // ÊúÄÂêéÂ§ÑÁêÜÂçï‰∏™Â≠óÁ¨¶ÁöÑÔºåÈÅøÂÖç‰∏é‰∏§‰∏™Â≠óÁ¨¶ÁöÑÂÜ≤Á™Å
            // ËΩ¨Êç¢ *Êñú‰Ωì* ‰∏∫ <em>Êñú‰Ωì</em>
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
            return text;
        }
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ | Êï∞ÊçÆ‰øÆÂ§çÂáΩÊï∞„ÄëËØ∑Â∞ÜËøô‰∏™ÂáΩÊï∞Á≤òË¥¥Âà∞ÊÇ®ÁöÑJSÂäüËÉΩÂå∫ ‚ñº‚ñº‚ñº
        /**
         * Ëá™Âä®ËøÅÁßªÊóßÁöÑ„ÄÅÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÁ∫¢ÂåÖÊï∞ÊçÆÔºåÂ∞Ü 'receiver' Â≠óÊÆµÈáçÂëΩÂêç‰∏∫ 'receiverName'
         */
        async function migrateOldRedPacketData() {
            console.log("ÂºÄÂßãÊ£ÄÊü•Âπ∂ËøÅÁßªÊóßÁöÑÁ∫¢ÂåÖÊï∞ÊçÆ...");
            let migrationCount = 0;
            // Áõ¥Êé•‰ªéÂÜÖÂ≠ò‰∏≠ÁöÑ state.chats Êìç‰ΩúÔºåÊïàÁéáÊõ¥È´ò
            const allChats = Object.values(state.chats);
        
            for (const chat of allChats) {
                let needsDbUpdate = false;
                for (const msg of chat.history) {
                    // ÊâæÂá∫ÊâÄÊúâÁî±AIÂèëÈÄÅÁöÑ„ÄÅÂ∏¶ÊúâÊóß 'receiver' Â≠óÊÆµÁöÑ‰∏ìÂ±ûÁ∫¢ÂåÖ
                    if (msg.type === 'red_packet' && msg.packetType === 'direct' && msg.role === 'assistant' && msg.hasOwnProperty('receiver') && !msg.hasOwnProperty('receiverName')) {
                        // ËøõË°å‚ÄúÊâãÊúØ‚ÄùÔºöÈáçÂëΩÂêçÈîôËØØÁöÑÂ≠óÊÆµ
                        msg.receiverName = msg.receiver;
                        delete msg.receiver;
                        
                        needsDbUpdate = true; // Ê†áËÆ∞Ëøô‰∏™ËÅäÂ§©ÈúÄË¶ÅË¢´ÈáçÊñ∞‰øùÂ≠ò
                        migrationCount++;
                    }
                }
                // Â¶ÇÊûúËøô‰∏™ËÅäÂ§©‰∏≠ÊúâÊï∞ÊçÆË¢´‰øÆÂ§ç‰∫ÜÔºåÂ∞±Â∞ÜÊï¥‰∏™Êõ¥Êñ∞ÂêéÁöÑËÅäÂ§©ÂØπË±°‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ì
                if (needsDbUpdate) {
                    console.log(`Âú®ËÅäÂ§© "${chat.name}" ‰∏≠ÂèëÁé∞Âπ∂‰øÆÂ§ç‰∫ÜÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ`);
                    await db.chats.put(chat);
                }
            }
        
            if (migrationCount > 0) {
                console.log(`Êï∞ÊçÆËøÅÁßªÂÆåÊàêÔºÅÊÄªÂÖ±‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°Á∫¢ÂåÖËÆ∞ÂΩï„ÄÇ`);
                alert(`Ê£ÄÊµãÂà∞Âπ∂ÊàêÂäü‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°ÊóßÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞‰ª•Â∫îÁî®Êõ¥Êîπ„ÄÇ`);
                location.reload(); // Âº∫Âà∂Âà∑Êñ∞È°µÈù¢ÔºåÁ°Æ‰øùÊâÄÊúâÊòæÁ§∫ÈÉΩ‰ΩøÁî®ÊúÄÊñ∞ÁöÑÊ≠£Á°ÆÊï∞ÊçÆ
            } else {
                console.log("Êú™ÂèëÁé∞ÈúÄË¶ÅËøÅÁßªÁöÑÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ");
            }
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂÖ®Êñ∞ | Â∑≤‰øÆÂ§çBUG„ÄëÊòæÁ§∫ËßíËâ≤Ê¥ûÂØüÂºπÁ™ó
         * @param {string} chatId - Ë¶ÅÊòæÁ§∫ÁöÑËßíËâ≤ÊâÄÂú®ÁöÑËÅäÂ§©ID
         */
        function showCharacterProfileModal(chatId) {
            const chat = state.chats[chatId];
            if (!chat || chat.isGroup) return;
        
            // Â°´ÂÖÖÊï∞ÊçÆ
            document.getElementById('profile-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            document.getElementById('profile-name').textContent = chat.name;
            document.getElementById('profile-id').textContent = `ID: ${chat.originalName}`;
            document.getElementById('profile-heartfelt-voice').textContent = chat.heartfeltVoice || '...';
            document.getElementById('profile-random-jottings').textContent = chat.randomJottings || '...';
            
            const modal = document.getElementById('character-profile-modal');
        
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÁî±‰∫éÊàë‰ª¨Â∑≤Áªè‰ªéHTML‰∏≠ÁßªÈô§‰∫Ü‚ÄúËøõÂÖ•ËÅäÂ§©‚ÄùÊåâÈíÆÔºå
            // ËøôÈáå‰∏çÂÜçÈúÄË¶Å‰∏∫ÂÆÉÁªëÂÆö‰∫ã‰ª∂ÔºåÊóßÁöÑ„ÄÅÂØºËá¥ÈîôËØØÁöÑJavaScript‰ª£Á†ÅÂ∑≤Ë¢´ÂΩªÂ∫ïÂà†Èô§„ÄÇ
            
            // Áõ¥Êé•ÊòæÁ§∫ÂºπÁ™ó
            modal.classList.add('visible');
        }
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊòæÁ§∫ÂøÉÂ£∞ÂéÜÂè≤ËÆ∞ÂΩïËßÜÂõæ
         */
        function showThoughtsHistory() {
            document.getElementById('profile-main-content').style.display = 'none';
            document.getElementById('profile-thoughts-history-view').style.display = 'flex';
            renderThoughtsHistory();
        }
        
        /**
         * „ÄêÂÖ®Êñ∞ | Â∑≤‰øÆÂ§çBUG„ÄëÈöêËóèÂøÉÂ£∞ÂéÜÂè≤ËÆ∞ÂΩïËßÜÂõæÔºåËøîÂõû‰∏ªËµÑÊñôÈ°µ
         */
        function hideThoughtsHistory() {
            document.getElementById('profile-thoughts-history-view').style.display = 'none';
            
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞Ü 'block' Êîπ‰∏∫ 'flex'ÔºåÊÅ¢Â§çÂÖ∂Ê≠£Á°ÆÁöÑÂºπÊÄßÂ∏ÉÂ±Ä
            document.getElementById('profile-main-content').style.display = 'flex'; 
        }
        
        /**
         * „ÄêÂÖ®Êñ∞ | ÂàÜÈ°µÂä†ËΩΩÁâà„ÄëÊ∏≤ÊüìÂøÉÂ£∞ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
         */
        function renderThoughtsHistory() {
            const listEl = document.getElementById('thoughts-history-list');
            const chat = state.chats[state.activeChatId];
            listEl.innerHTML = '';
            
            if (!chat || !chat.thoughtsHistory || chat.thoughtsHistory.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 30px 0;">ËøôÈáåËøòÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÂì¶„ÄÇ</p>';
                return;
            }
        
            const history = [...chat.thoughtsHistory].reverse(); // ‰ªéÊñ∞Âà∞Êóß
            const initialItems = history.slice(0, THOUGHTS_RENDER_WINDOW);
            
            initialItems.forEach(thought => {
                const card = createThoughtCard(thought);
                listEl.appendChild(card);
            });
        
            thoughtsHistoryRenderCount = initialItems.length;
        
            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öËÆ∞ÂΩïÔºåÂàôÊ∑ªÂä†‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
            if (history.length > thoughtsHistoryRenderCount) {
                prependLoadMoreThoughtsButton(listEl);
            }
        }
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆÂπ∂Ê∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®
         */
        function prependLoadMoreThoughtsButton(container) {
            const button = document.createElement('button');
            button.id = 'load-more-thoughts-btn';
            button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï';
            button.className = 'load-more-btn'; // Â§çÁî®ËÅäÂ§©È°µÈù¢ÁöÑÊåâÈíÆÊ†∑Âºè
            container.prepend(button);
        }
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂä†ËΩΩÊõ¥Â§öÂøÉÂ£∞ÂéÜÂè≤ËÆ∞ÂΩï
         */
        function loadMoreThoughts() {
            const listEl = document.getElementById('thoughts-history-list');
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            const loadMoreBtn = document.getElementById('load-more-thoughts-btn');
            if (loadMoreBtn) loadMoreBtn.remove();
            
            const history = [...chat.thoughtsHistory].reverse();
            const totalItems = history.length;
            
            const nextSliceStart = thoughtsHistoryRenderCount;
            const nextSliceEnd = thoughtsHistoryRenderCount + THOUGHTS_RENDER_WINDOW;
            const itemsToAppend = history.slice(nextSliceStart, nextSliceEnd);
            
            itemsToAppend.forEach(thought => {
                const card = createThoughtCard(thought);
                listEl.appendChild(card);
            });
        
            thoughtsHistoryRenderCount += itemsToAppend.length;
        
            // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÂÜçÊ¨°Ê∑ªÂä†ÊåâÈíÆ
            if (totalItems > thoughtsHistoryRenderCount) {
                prependLoadMoreThoughtsButton(listEl);
            }
        }
        /**
         * „ÄêÂÖ®Êñ∞ÁæéÂåñÁâà„ÄëÊ†πÊçÆÂçïÊù°ËÆ∞ÂΩïÊï∞ÊçÆÔºåÂàõÂª∫‰∏ÄÂº†ÂøÉÂ£∞ÂéÜÂè≤Âç°Áâá
         * @param {object} thought - ‰∏ÄÊù°ÂøÉÂ£∞ÂéÜÂè≤ËÆ∞ÂΩïÂØπË±°
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑÂç°Áâádiv
         */
        function createThoughtCard(thought) {
            const card = document.createElement('div');
            card.className = 'thought-card';
            const date = new Date(thought.timestamp);
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            card.innerHTML = `
                <div class="thought-header">${dateString}</div>
                <div class="thought-content">
                    <div class="voice">
                        <div class="label">
                            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            ÂøÉÂ£∞
                        </div>
                        <p class="text">${thought.heartfeltVoice}</p>
                    </div>
                    <div class="jottings">
                        <div class="label">
                             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                            Êï£ËÆ∞
                        </div>
                        <p class="text">${thought.randomJottings}</p>
                    </div>
                </div>
            `;
            return card;
        } 
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÂØºÂÖ•ËßíËâ≤Âç°ÁöÑÊâÄÊúâÊ†∏ÂøÉÂäüËÉΩÔºåËØ∑Â∞ÜÂÆÉ‰ª¨ÂÆåÊï¥Á≤òË¥¥Âà∞ init() ÂáΩÊï∞ÁöÑÂâçÈù¢ ‚ñº‚ñº‚ñº
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàPNGÂØºÂÖ•‰øÆÂ§ç„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ handleCardImport ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÂΩìÁî®Êà∑ÈÄâÊã©‰∫ÜËßíËâ≤Âç°Êñá‰ª∂ÂêéÔºåÁî±Ê≠§ÂáΩÊï∞ÂºÄÂßãÂ§ÑÁêÜ
         * @param {Event} event - Êñá‰ª∂ËæìÂÖ•Ê°ÜÁöÑ change ‰∫ã‰ª∂
         */
        async function handleCardImport(event) {
            const file = event.target.files[0];
            if (!file) return;
        
            try {
                let cardData;
                let avatarBase64 = null; // Áî®‰∫éÂ≠òÂÇ®‰ªéPNGÂç°‰∏≠ÊèêÂèñÁöÑÂ§¥ÂÉè
        
                if (file.name.endsWith('.json')) {
                    // Â§ÑÁêÜ JSON Ê†ºÂºèÁöÑËßíËâ≤Âç°
                    const text = await file.text();
                    cardData = JSON.parse(text);
                } else if (file.name.endsWith('.png')) {
                    // Â§ÑÁêÜ PNG Ê†ºÂºèÁöÑËßíËâ≤Âç°
                    const arrayBuffer = await file.arrayBuffer();
                    // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅÁé∞Âú®Ëøô‰∏™ÂáΩÊï∞Ë¢´Ê≠£Á°ÆÂÆö‰πâ‰∫Ü„Äë„Äë„Äë
                    cardData = await parsePngForTavernData(arrayBuffer);
                    
                    // ÂêåÊó∂ÔºåÂ∞ÜPNGÊñá‰ª∂Êú¨Ë∫´ËΩ¨Êç¢‰∏∫Base64ÔºåÁî®‰ΩúÂ§¥ÂÉè
                    avatarBase64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
                } else {
                    throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè„ÄÇËØ∑ÈÄâÊã© .json Êàñ .png Êñá‰ª∂„ÄÇ");
                }
        
                // Â∞ÜËß£ÊûêÂá∫ÁöÑÊï∞ÊçÆÂàõÂª∫‰∏∫Êñ∞ÁöÑËÅäÂ§©ÂØπË±°
                await createChatFromCardData(cardData, avatarBase64);
        
            } catch (error) {
                console.error("ËßíËâ≤Âç°ÂØºÂÖ•Â§±Ë¥•:", error);
                await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", `Êó†Ê≥ïËß£ÊûêËßíËâ≤Âç°Êñá‰ª∂„ÄÇ\nÈîôËØØ: ${error.message}`);
            } finally {
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÔºå‰ª•‰æø‰∏ãÊ¨°ËÉΩÈÄâÊã©Âêå‰∏Ä‰∏™Êñá‰ª∂
                event.target.value = null;
            }
        }
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰π±Á†Å‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ parsePngForTavernData ‚ñº‚ñº‚ñº
        /**
         * „ÄêV2.0 | ‰øÆÂ§çUTF-8‰π±Á†Å„Äë‰ªéPNGÊñá‰ª∂ÁöÑArrayBuffer‰∏≠Ëß£ÊûêÂá∫ÈöêËóèÁöÑTavern AIËßíËâ≤Êï∞ÊçÆ
         * @param {ArrayBuffer} arrayBuffer - PNGÊñá‰ª∂ÁöÑ‰∫åËøõÂà∂Êï∞ÊçÆ
         * @returns {Promise<object>} - Ëß£ÊûêÂá∫ÁöÑJSONËßíËâ≤Êï∞ÊçÆ
         */
        function parsePngForTavernData(arrayBuffer) {
            return new Promise((resolve, reject) => {
                const view = new DataView(arrayBuffer);
                // Ê£ÄÊü•PNGÊñá‰ª∂Â§¥ (8‰∏™Â≠óËäÇ)
                if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
                    return reject(new Error("Êñá‰ª∂‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑPNG„ÄÇ"));
                }
        
                let offset = 8;
                const decoder = new TextDecoder(); // Ëøô‰∏™Ëß£Á†ÅÂô®Áî®‰∫éËß£Á†ÅÂå∫ÂùóÁ±ªÂûãÔºå‰∏çÊòØÊúÄÁªàÊï∞ÊçÆ
        
                while (offset < view.byteLength) {
                    const length = view.getUint32(offset);
                    const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));
        
                    if (type === 'tEXt') {
                        const data = new Uint8Array(arrayBuffer, offset + 8, length);
                        const nullSeparatorIndex = data.indexOf(0);
                        if (nullSeparatorIndex !== -1) {
                            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
                            if (key === 'chara') {
                                const value = decoder.decode(data.slice(nullSeparatorIndex + 1));
                                try {
                                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë ‚ñº‚ñº‚ñº
                                    // Êàë‰ª¨‰∏çÂÜç‰ΩøÁî®ÊóßÁöÑ„ÄÅ‰ºöÂØºËá¥‰∏≠Êñá‰π±Á†ÅÁöÑ atob() ÊñπÊ≥ï„ÄÇ
                                    // ËÄåÊòØÈááÁî®‰∏Ä‰∏™Êõ¥Áé∞‰ª£„ÄÅÊõ¥ÂèØÈù†ÁöÑ‰∏§Ê≠•ÊµÅÁ®ãÊù•Ëß£Á†Å„ÄÇ
                                    
                                    // 1. Â∞ÜBase64Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫‰∏Ä‰∏™ÂéüÂßãÁöÑ‰∫åËøõÂà∂Â≠óÁ¨¶‰∏≤„ÄÇ
                                    const binaryString = atob(value);
                                    
                                    // 2. ÂàõÂª∫‰∏Ä‰∏™Â≠óËäÇÊï∞ÁªÑ (Uint8Array) Êù•Â≠òÂÇ®Ëøô‰∫õ‰∫åËøõÂà∂Êï∞ÊçÆ„ÄÇ
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }
                                    
                                    // 3. „ÄêÊúÄÂÖ≥ÈîÆÁöÑ‰∏ÄÊ≠•„Äë‰ΩøÁî® TextDecoder Âπ∂ÊòéÁ°ÆÊåáÂÆö UTF-8 ÁºñÁ†ÅÔºå
                                    //    Â∞ÜÂ≠óËäÇÊï∞ÁªÑÊ≠£Á°ÆÂú∞Ëß£Á†Å‰∏∫ÂåÖÂê´‰∏≠ÊñáÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
                                    const decodedData = new TextDecoder('utf-8').decode(bytes);
                                    
                                    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                                    
                                    resolve(JSON.parse(decodedData));
                                    return; // ÊàêÂäüÊâæÂà∞Âπ∂Ëß£ÊûêÔºå‰ªªÂä°ÂÆåÊàê
                                } catch (e) {
                                    return reject(new Error("Âú®PNG‰∏≠ÊâæÂà∞ËßíËâ≤Êï∞ÊçÆÔºå‰ΩÜËß£Á†ÅÊàñËß£ÊûêÂ§±Ë¥•„ÄÇÈîôËØØ: " + e.message));
                                }
                            }
                        }
                    }
                    
                    // ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™Âå∫Âùó (ÈïøÂ∫¶ + Á±ªÂûã + Êï∞ÊçÆ + CRC)
                    offset += 4 + 4 + length + 4;
                }
        
                reject(new Error("Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑTavern AIËßíËâ≤Êï∞ÊçÆ(chara chunk)„ÄÇ"));
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà | V4.0„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ createChatFromCardData ÂíåÂèØËÉΩÁº∫Â§±ÁöÑ findWorldBookEntries ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêËæÖÂä©ÂáΩÊï∞ | ÂÖºÂÆπÊ†∏ÂøÉ„Äë‰ªéËßíËâ≤Âç°Êï∞ÊçÆ‰∏≠Êô∫ËÉΩÊü•Êâæ‰∏ñÁïå‰π¶Êù°ÁõÆ
         * @param {object} cardData - ‰ªéÊñá‰ª∂Ëß£ÊûêÂá∫ÁöÑÂéüÂßãJSONÊï∞ÊçÆ
         * @returns {Array|null} - Â¶ÇÊûúÊâæÂà∞ÔºåËøîÂõû entries Êï∞ÁªÑÔºõÂê¶ÂàôËøîÂõû null
         */
        function findWorldBookEntries(cardData) {
            // Ê£ÄÊü•ÊâÄÊúâÂèØËÉΩÁöÑË∑ØÂæÑÔºåÊåâÊúÄÂ∏∏ËßÅÂà∞ÊúÄÂ∞ëËßÅÁöÑÈ°∫Â∫è
            // ‰ΩøÁî®ÂèØÈÄâÈìæ (?.) Êù•ÂÆâÂÖ®Âú∞ËÆøÈóÆÂèØËÉΩ‰∏çÂ≠òÂú®ÁöÑÊ∑±Â±ÇÂµåÂ•óÂ±ûÊÄß
            
            // Ê†ºÂºè 1: „ÄêÈíàÂØπÊÇ®Âç°ÁâáÁöÑÁ≤æÁ°ÆË∑ØÂæÑ„ÄëÊï∞ÊçÆÂú® data.character_book ‰∏≠
            if (cardData.data?.character_book?.entries?.length > 0) {
                console.log("ËØäÊñ≠ÔºöÂú® data.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
                return cardData.data.character_book.entries;
            }
            
            // Ê†ºÂºè 2: Êñ∞Áâà Tavern Âç°ÔºåÊï∞ÊçÆÂú® extensions.character_book ‰∏≠
            if (cardData.extensions?.character_book?.entries?.length > 0) {
                console.log("ËØäÊñ≠ÔºöÂú® extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
                return cardData.extensions.character_book.entries;
            }
            
            // Ê†ºÂºè 3: Êüê‰∫õÂ∑•ÂÖ∑ÂèØËÉΩÂ∞ÜÂÖ∂ÂµåÂ•óÂú® data.extensions ‰∏≠
            if (cardData.data?.extensions?.character_book?.entries?.length > 0) {
                console.log("ËØäÊñ≠ÔºöÂú® data.extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
                return cardData.data.extensions.character_book.entries;
            }
            
            // Ê†ºÂºè 4: ÂÖºÂÆπÊàë‰ª¨‰πãÂâçÂ∞ùËØïËøáÁöÑ„ÄÅÁõ¥Êé•Âú®È°∂Â±ÇÁöÑÂêÑÁßçÈîÆÂêç
            const possibleTopLevelKeys = ['character_book', 'lorebook', 'world_info', 'char_book'];
            for (const key of possibleTopLevelKeys) {
                if (cardData[key]?.entries?.length > 0) {
                    console.log(`ËØäÊñ≠ÔºöÂú®È°∂Â±Ç ${key} ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ`);
                    return cardData[key].entries;
                }
            }
        
            console.log("ËØäÊñ≠ÔºöÊú™Âú®Ê≠§ËßíËâ≤Âç°‰∏≠ÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆ„ÄÇ");
            return null; // Â¶ÇÊûúÊâÄÊúâË∑ØÂæÑÈÉΩÊâæ‰∏çÂà∞ÔºåËøîÂõû null
        }
        
        /**
         * „ÄêV6.0 | Â∑≤‰øÆÂ§çÂØºÂÖ•BUG„ÄëÊ†πÊçÆ‰ªéËßíËâ≤Âç°Ëß£ÊûêÁöÑÊï∞ÊçÆÔºåÂàõÂª∫Âπ∂‰øùÂ≠ò‰∏Ä‰∏™Êñ∞ÁöÑËÅäÂ§©ÂØπË±°
         * @param {object} cardData - ‰ªé.jsonÊàñ.png‰∏≠Ëß£ÊûêÂá∫ÁöÑËßíËâ≤Êï∞ÊçÆ
         * @param {string|null} avatarBase64 - Â¶ÇÊûúÊòØ.pngÂç°ÔºåÂàô‰º†ÂÖ•ÂÖ∂Base64Êï∞ÊçÆ‰Ωú‰∏∫Â§¥ÂÉè
         */
        async function createChatFromCardData(cardData, avatarBase64 = null) {
            const effectiveCardData = cardData.data || cardData;
            if (!effectiveCardData.name) {
                throw new Error("ËßíËâ≤Âç°Êï∞ÊçÆÊó†ÊïàÊàñÁº∫Â∞ë'name'Â≠óÊÆµ„ÄÇ");
            }
        
            let worldBookIdToLink = null;
            const worldBookEntries = findWorldBookEntries(cardData);
        
            if (worldBookEntries) {
                const structuredEntries = worldBookEntries
                    .filter(entry => entry.enabled && entry.content)
                    .map(entry => ({
                        keys: entry.keys || [],
                        comment: entry.comment || '',
                        content: entry.content.replace(/<memory>|<\/memory>/g, '').trim()
                    }));
        
                if (structuredEntries.length > 0) {
                    const newWorldBook = {
                        id: 'wb_' + Date.now(),
                        name: `${effectiveCardData.name}ÁöÑËÆæÂÆöÈõÜ`,
                        content: structuredEntries,
                        categoryId: null
                    };
                    await db.worldBooks.add(newWorldBook);
                    state.worldBooks.push(newWorldBook);
                    worldBookIdToLink = newWorldBook.id;
                }
            }
        
            let description = effectiveCardData.description || cardData.description || 'Êó†';
            description = description
                .replace(/```yaml/g, '').replace(/```/g, '')
                .replace(/<\/?info>/g, '').replace(/<\/?character>/g, '')
                .replace(/<\/?writing_rule>/g, '').replace(/\[OOCÔºö.*?\]/g, '').trim();
            let persona = `# ËßíËâ≤Ê†∏ÂøÉËÆæÂÆö\n${description}\n\n`;
            if (effectiveCardData.personality) persona += `# ÊÄßÊ†ºË°•ÂÖÖ\n${effectiveCardData.personality}\n\n`;
            if (effectiveCardData.scenario) persona += `# Âú∫ÊôØËÆæÂÆö\n${effectiveCardData.scenario}\n\n`;
            if (effectiveCardData.mes_example) persona += `# ÂØπËØùÁ§∫‰æã\n${effectiveCardData.mes_example}\n\n`;

            // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ËøôÈáåÂÆö‰πâ remarkName Âíå originalName ‚ñº‚ñº‚ñº
            const remarkName = effectiveCardData.name;
            const originalName = effectiveCardData.name;
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            const newChatId = 'chat_' + Date.now();
            const newChat = {
                id: newChatId,
                name: remarkName.trim(),
                originalName: originalName.trim(),
                isGroup: false,
                relationship: { status: 'friend' },
                status: { text: 'Âú®Á∫ø', lastUpdate: Date.now(), isBusy: false },
                settings: {
                    aiPersona: persona,
                    myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
                    maxMemory: 10,
                    aiAvatar: defaultAvatar,
                    myAvatar: defaultAvatar,
                    background: '',
                    theme: 'default',
                    fontSize: 13,
                    customCss: '',
                    linkedWorldBookIds: worldBookIdToLink ? [worldBookIdToLink] : [],
                    aiAvatarLibrary: []
                },
                history: [],
                musicData: { totalTime: 0 },
                longTermMemory: [],
    npcs: [] // <-- „ÄêÊñ∞Â¢û„Äë‰∏Ä‰∏™Á©∫ÁöÑNPCÊï∞ÁªÑ
            };

            if (avatarBase64) {
                newChat.settings.aiAvatar = avatarBase64;
                newChat.settings.aiAvatarLibrary.push({ name: 'ÈªòËÆ§Â§¥ÂÉè', url: avatarBase64 });
            }

            const greetingHtml = effectiveCardData.first_mes || cardData.first_mes;
            if (greetingHtml && typeof greetingHtml === 'string') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = greetingHtml;
                const cleanGreeting = (tempDiv.textContent || tempDiv.innerText || "").replace(/Âéü‰ΩúËÄÖUR.*?ÂºÄÂ±Ä/s, '').trim();
                if (cleanGreeting) {
                    newChat.history.push({
                        role: 'assistant',
                        senderName: newChat.originalName,
                        content: cleanGreeting,
                        timestamp: Date.now()
                    });
                }
            }
            state.chats[newChatId] = newChat;
            await db.chats.put(newChat);
            renderChatList();
            let successMessage = `ËßíËâ≤ ‚Äú${newChat.name}‚Äù Â∑≤ÊàêÂäüÂØºÂÖ•ÔºÅ`;
            if (worldBookIdToLink) {
                successMessage += `\n\nÂÖ∂‰∏ìÂ±ûÁöÑ‚Äú‰∏ñÁïå‰π¶‚Äù‰πüÂ∑≤Ëá™Âä®ÂàõÂª∫Âπ∂ÂÖ≥ËÅî„ÄÇ`;
            }
            await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', successMessage);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÂàáÊç¢ÂºÄÂú∫ÁôΩÁöÑÊ†∏ÂøÉÂäüËÉΩÔºåËØ∑Á≤òË¥¥Âà∞ init() ÂáΩÊï∞ÁöÑÂâçÈù¢ ‚ñº‚ñº‚ñº
            /**
             * „ÄêÊÄªÂÖ•Âè£„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáª‚ÄúÂàáÊç¢ÂºÄÂú∫‚ÄùÊåâÈíÆÁöÑÈÄªËæë
             */
            async function handleSwitchGreeting() {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const greetings = chat.settings.alternateGreetings;
        
                if (!greetings || greetings.length === 0) {
                    alert("Ëøô‰∏™ËßíËâ≤Ê≤°ÊúâÂèØÁî®ÁöÑÂ§áÈÄâÂºÄÂú∫ÁôΩ„ÄÇ");
                    return;
                }
        
                // 1. Â∞ÜÂ§áÈÄâÂºÄÂú∫ÁôΩÊï∞ÁªÑËΩ¨Êç¢‰∏∫ showChoiceModal ÈúÄË¶ÅÁöÑÊ†ºÂºè
                const options = greetings.map((text, index) => {
                    // ÊèêÂèñÊØè‰∏™ÂºÄÂú∫ÁôΩÁöÑÂâç20‰∏™Â≠óÁ¨¶‰Ωú‰∏∫È¢ÑËßà
                    const preview = text.replace(/<[^>]*>/g, '').trim().substring(0, 20);
                    return {
                        text: `ÂºÄÂú∫ ${index + 1}: ${preview}...`,
                        value: index // Â∞ÜÊï∞ÁªÑÁ¥¢Âºï‰Ωú‰∏∫ËøîÂõûÂÄº
                    };
                });
        
                // 2. ÂºπÂá∫ÈÄâÊã©ËèúÂçï
                const selectedIndex = await showChoiceModal('ÈÄâÊã©‰∏Ä‰∏™ÂºÄÂú∫ÁôΩ', options);
        
                // 3. Â¶ÇÊûúÁî®Êà∑ÂÅöÂá∫‰∫ÜÈÄâÊã© (ËÄå‰∏çÊòØÂèñÊ∂à)
                if (selectedIndex !== null) {
                    // 4. „ÄêÈáçË¶Å„ÄëÂºπÂá∫Ë≠¶ÂëäÔºåÁ°ÆËÆ§ÊòØÂê¶Ë¶ÅË¶ÜÁõñËÅäÂ§©ËÆ∞ÂΩï
                    const confirmed = await showCustomConfirm(
                        'Á°ÆËÆ§Êìç‰Ωú',
                        'ÂàáÊç¢ÂºÄÂú∫Â∞Ü‰ºö„ÄêÊ∏ÖÁ©∫Âπ∂ÊõøÊç¢„ÄëÂΩìÂâçÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü',
                        { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆÂÆöÂàáÊç¢' }
                    );
        
                    if (confirmed) {
                        // 5. ÊâßË°åÂàáÊç¢ÈÄªËæë
                        const newGreetingText = greetings[selectedIndex];
                        
                        const newMessage = {
                            role: 'assistant',
                            senderName: chat.originalName,
                            content: newGreetingText,
                            timestamp: Date.now()
                        };
        
                        // ÊõøÊç¢Êï¥‰∏™ÂéÜÂè≤ËÆ∞ÂΩï
                        chat.history = [newMessage];
                        
                        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                        await db.chats.put(chat);
        
                        // Âà∑Êñ∞UI
                        renderChatInterface(chat.id);
                        document.getElementById('chat-settings-modal').classList.remove('visible'); // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™ó
                        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÂàáÊç¢Âà∞Êñ∞ÁöÑÂºÄÂú∫ÊïÖ‰∫ãÔºÅ');
                    }
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ createWorldBookEntryBlock ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêËæÖÂä©ÂáΩÊï∞„ÄëÂàõÂª∫‰∏Ä‰∏™ÂèØÁºñËæëÁöÑ‰∏ñÁïå‰π¶Êù°ÁõÆÂùó
         * @param {object} entry - Âçï‰∏™Êù°ÁõÆÁöÑÊï∞ÊçÆ { keys, comment, content, enabled }
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
         */
        function createWorldBookEntryBlock(entry = { keys: [], comment: '', content: '', enabled: true }) {
            const block = document.createElement('div');
            // Â§çÁî®Êàë‰ª¨‰πãÂâç‰∏∫Ê∂àÊÅØÁºñËæëÂô®ÂàõÂª∫ÁöÑÊ†∑Âºè
            block.className = 'message-editor-block';
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊ†πÊçÆÊù°ÁõÆÁöÑ enabled Áä∂ÊÄÅÂÜ≥ÂÆöÂºÄÂÖ≥ÊòØÂê¶Ë¢´ÈÄâ‰∏≠
            const isChecked = entry.enabled !== false ? 'checked' : '';

            block.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="ÂêØÁî®/Á¶ÅÁî®Ê≠§Êù°ÁõÆ">
                        <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°ÁõÆ">√ó</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">Â§áÊ≥® (ÂèØÈÄâ)</label>
                    <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="‰æãÂ¶ÇÔºöÂÖ≥‰∫éËßíËâ≤ÁöÑÁ´•Âπ¥" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">ÂÖ≥ÈîÆËØç (Áî®Ëã±ÊñáÈÄóÂè∑,ÂàÜÈöî)</label>
                    <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="‰æãÂ¶Ç: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">ÂÜÖÂÆπ</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
                </div>
            `;
        
            // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
            block.querySelector('.delete-block-btn').addEventListener('click', () => {
                block.remove();
            });
        
            return block;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∫îÂ≠êÊ£ãÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈÅÆÁΩ©ÁªàÊûÅ‰øÆÂ§çÁâà„ÄëÂàáÊç¢‰∫îÂ≠êÊ£ãÊ£ãÁõòÁöÑÊòæÁ§∫‰∏éÈöêËóè
         */
        async function toggleGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
        
            // Â¶ÇÊûúÊ£ãÁõòÊòØÈöêËóèÁöÑ -> ÊâìÂºÄÂÆÉ
            if (!overlay.classList.contains('visible')) {
                const header = document.querySelector('#chat-interface-screen > .header');
                
                overlay.style.top = `${header.offsetHeight}px`;
                overlay.style.display = 'block';
        
                if (!gomokuState[chatId] || !gomokuState[chatId].isActive) {
                    initGomokuGame(chatId);
                }
                renderGomokuBoard(chatId);
        
                // „ÄêÊ†∏ÂøÉ„Äë‰∏çÂÜçÊìç‰ΩúÊ∂àÊÅØÂàóË°®ÁöÑ padding-top
                setTimeout(async () => {
                    overlay.classList.add('visible');
        
                    const startMessage = {
                        role: 'system',
                        content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâìÂºÄ‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÂºÄÂßã‰∫Ü„ÄÇ]',
                        timestamp: Date.now(),
                        isHidden: true
                    };
                    state.chats[chatId].history.push(startMessage);
                    await db.chats.put(state.chats[chatId]);
                }, 10);
        
            } else {
                // Â¶ÇÊûúÊ£ãÁõòÊòØÊòæÁ§∫ÁöÑ -> ÂÖ≥Èó≠ÂÆÉ
                await closeGomokuBoard();
            }
        }
        /**
         * „ÄêÈÅÆÁΩ©ÁªàÊûÅ‰øÆÂ§çÁâà„ÄëÂÖ≥Èó≠‰∫îÂ≠êÊ£ãÊ£ãÁõò
         */
        async function closeGomokuBoard() {
            if (!state.activeChatId) return;
            const chatId = state.activeChatId;
            const overlay = document.getElementById('gomoku-overlay');
            
            overlay.classList.remove('visible');
            
            // „ÄêÊ†∏ÂøÉ„ÄëÁßªÈô§‰∫ÜÊÅ¢Â§çÊ∂àÊÅØÂàóË°® padding-top ÁöÑ‰ª£Á†Å
        
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        
            if (gomokuState[chatId]) {
                gomokuState[chatId].isActive = false;
                
                const endMessage = {
                    role: 'system',
                    content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂÖ≥Èó≠‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÁªìÊùü‰∫Ü„ÄÇ]',
                    timestamp: Date.now(),
                    isHidden: true
                };
                state.chats[chatId].history.push(endMessage);
                await db.chats.put(state.chats[chatId]);
            }
        }
        
        /**
         * „ÄêÊ∏≤ÊüìÊó∂Â∫è‰øÆÂ§çÁâà„ÄëÂàùÂßãÂåñ‰∏ÄÂ±ÄÊñ∞ÁöÑ‰∫îÂ≠êÊ£ãÊ∏∏Êàè
         * @param {string} chatId 
         */
        function initGomokuGame(chatId) {
            const canvas = document.getElementById('gomoku-board');
            const overlay = document.getElementById('gomoku-overlay');
            const controls = document.getElementById('gomoku-controls');
            
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®‰øùËØÅ overlay ÂèØËßÅÁöÑÂâçÊèê‰∏ãÔºåÊõ¥Á≤æÁ°ÆÂú∞ËÆ°ÁÆóÂèØÁî®Á©∫Èó¥
            const availableWidth = overlay.offsetWidth - 40; 
            const availableHeight = overlay.offsetHeight - controls.offsetHeight - 40;
            const boardSize = Math.floor(Math.min(availableWidth, availableHeight));
            
            const GRID_SIZE = 15;
            // Á°Æ‰øùÊ£ãÁõòÂ∞∫ÂØ∏ÊòØÊ†ºÂ≠êÂ∞∫ÂØ∏ÁöÑÊï¥Êï∞ÂÄçÔºåÈÅøÂÖçÊ®°Á≥ä
            const cell_size = Math.floor(boardSize / GRID_SIZE);
            const final_size = cell_size * GRID_SIZE;
            
            canvas.width = final_size;
            canvas.height = final_size;
        
            gomokuState[chatId] = {
                isActive: true,
                board: Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0)),
                currentPlayer: 1, 
                history: [],
                isGameOver: false,
                GRID_SIZE: GRID_SIZE,
                CELL_SIZE: cell_size
            };
        }
        /**
         * Ê∏≤ÊüìÊï¥‰∏™Ê£ãÁõòÂíåÊ£ãÂ≠ê
         * @param {string} chatId 
         */
        function renderGomokuBoard(chatId) {
            const gameState = gomokuState[chatId];
            if (!gameState) return;
            
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const { GRID_SIZE, CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
        
            // 1. Ê∏ÖÁ©∫Âπ∂ÁªòÂà∂Ê£ãÁõòËÉåÊôØ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#e4b591';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        
            // 2. ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
            ctx.strokeStyle = '#5b3a29';
            ctx.lineWidth = 1;
            for (let i = 0; i < GRID_SIZE; i++) {
                // Ê®™Á∫ø
                ctx.beginPath();
                ctx.moveTo(padding, padding + i * CELL_SIZE);
                ctx.lineTo(canvas.width - padding, padding + i * CELL_SIZE);
                ctx.stroke();
                // Á´ñÁ∫ø
                ctx.beginPath();
                ctx.moveTo(padding + i * CELL_SIZE, padding);
                ctx.lineTo(padding + i * CELL_SIZE, canvas.height - padding);
                ctx.stroke();
            }
        
            // 3. ÁªòÂà∂Ê£ãÂ≠ê
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    if (gameState.board[y][x] !== 0) {
                        drawStone(ctx, x, y, gameState.board[y][x], gameState);
                    }
                }
            }
        }
        
        /**
         * ÁªòÂà∂Âçï‰∏™Ê£ãÂ≠ê
         */
        function drawStone(ctx, x, y, player, gameState) {
            const { CELL_SIZE } = gameState;
            const padding = CELL_SIZE / 2;
            const radius = CELL_SIZE / 2 - 2;
        
            ctx.beginPath();
            ctx.arc(padding + x * CELL_SIZE, padding + y * CELL_SIZE, radius, 0, 2 * Math.PI);
            
            if (player === 1) { // User is black
                ctx.fillStyle = 'black';
            } else { // AI is white
                ctx.fillStyle = 'white';
            }
            ctx.fill();
        }
        
        /**
         * Â§ÑÁêÜÈº†Ê†áÂú®Ê£ãÁõò‰∏äÁöÑÊÇ¨ÂÅúÊïàÊûú
         */
        function handleBoardHover(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            renderGomokuBoard(chatId); // Redraw to clear previous hover
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                const radius = gameState.CELL_SIZE / 2 - 2;
                ctx.beginPath();
                ctx.arc(gameState.CELL_SIZE / 2 + gridX * gameState.CELL_SIZE, gameState.CELL_SIZE / 2 + gridY * gameState.CELL_SIZE, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; // Faint black for preview
                ctx.fill();
            }
        }
        
        /**
         * Â§ÑÁêÜÁî®Êà∑ÁÇπÂáªÊ£ãÁõò‰∏ãÊ£ã
         */
        function handleBoardClick(e) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;
        
            const canvas = document.getElementById('gomoku-board');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
        
            const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
            const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
        
            if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
                // Place stone
                gameState.board[gridY][gridX] = 1;
                gameState.history.push({ x: gridX, y: gridY, player: 1 });
                renderGomokuBoard(chatId);
        
                // Check for win
                if (checkWin(gridX, gridY, 1, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("ÊÅ≠Âñú‰Ω†Ôºå‰Ω†Ëµ¢‰∫ÜÔºÅ"), 100);
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
            addGameEndSystemMessage('user'); // ÈÄöÁü•AIÔºåÊòØÁî®Êà∑Ëµ¢‰∫ÜÔºà‰πüÂ∞±ÊòØAIËæì‰∫ÜÔºâ
            // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                } else {
                    gameState.currentPlayer = 2; // Switch to AI's turn
                    // Note: We don't trigger AI response here. It's triggered by the "Wait Reply" button.
                }
            }
        }
        
        /**
         * „ÄêV2.0 | ‰øÆÂ§çÂØºÊºîÊ®°Âºè„ÄëAI‰∏ãÊ£ãÁöÑÂ§ÑÁêÜÂô®
         * @param {object} move - ÂåÖÂê´x,yÂùêÊ†áÁöÑÂØπË±°
         * @param {boolean} isForcedMove - ÊòØÂê¶‰∏∫ÂØºÊºîÊ®°Âºè‰∏ãÁöÑÂº∫Âà∂ÁßªÂä®
         */
        function handleAiGomokuMove(move, isForcedMove = false) {
            const chatId = state.activeChatId;
            const gameState = gomokuState[chatId];
            
            // Ê†∏ÂøÉ‰øÆÂ§ç1ÔºöÂ¶ÇÊûúÊòØÂº∫Âà∂ÁßªÂä®ÔºåÂ∞±Ë∑≥ËøáÁé©ÂÆ∂ÂõûÂêàÁöÑÊ£ÄÊü•
            if (!gameState || gameState.isGameOver) return;
            if (!isForcedMove && gameState.currentPlayer !== 2) return;

            const { x, y } = move;
        
            if (x >= 0 && x < gameState.GRID_SIZE && y >= 0 && y < gameState.GRID_SIZE && gameState.board[y][x] === 0) {
                gameState.board[y][x] = 2; // AIÊòØÁôΩÊ£ã(2)
                gameState.history.push({ x, y, player: 2 });
                renderGomokuBoard(chatId); // ÈáçÊñ∞ÁªòÂà∂Ê£ãÁõò
        
                if (checkWin(x, y, 2, gameState)) {
                    gameState.isGameOver = true;
                    setTimeout(() => alert("AI Ëé∑ËÉú‰∫ÜÔºÅ"), 100);
                    addGameEndSystemMessage('ai');
                } else {
                    gameState.currentPlayer = 1; // ËΩÆÂà∞Áî®Êà∑‰∏ãÊ£ã
                }
            } else {
                console.warn("AI ÁöÑ‰∏ãÊ£ãÊåá‰ª§Êó†ÊïàÊàñ‰ΩçÁΩÆÂ∑≤Ë¢´Âç†ÊçÆ:", move);
                // Â¶ÇÊûúAIÁöÑÁßªÂä®Êó†ÊïàÔºåÂ∞ÜÂõûÂêà‰∫§ËøòÁªôÁî®Êà∑ÔºåÈÅøÂÖçÊ∏∏ÊàèÂç°Ê≠ª
                gameState.currentPlayer = 1;
            }
        }
        
        /**
         * Ê£ÄÊü•ËÉúÂà©Êù°‰ª∂
         */
        function checkWin(x, y, player, gameState) {
            const { board, GRID_SIZE } = gameState;
            const directions = [[1, 0], [0, 1], [1, 1], [1, -1]]; // Horizontal, Vertical, Diagonal /, Diagonal \
            for (const [dx, dy] of directions) {
                let count = 1;
                // Check in one direction
                for (let i = 1; i < 5; i++) {
                    const newX = x + i * dx;
                    const newY = y + i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                // Check in the opposite direction
                for (let i = 1; i < 5; i++) {
                    const newX = x - i * dx;
                    const newY = y - i * dy;
                    if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                if (count >= 5) return true;
            }
            return false;
        }
        
// ‚ñº‚ñº‚ñº „ÄêV3.0 | ËßÑÂàô‰∏éÊÄùËÄÉÊ≠•È™§ÁªàÊûÅÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑÂáΩÊï∞ÔºåÂÜçÊ¨°ÊõøÊç¢ÊóßÁöÑ formatGomokuStateForAI ÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * „ÄêV3.0 | Âº∫Âà∂ÊÄùËÄÉÁâà„ÄëÂ∞ÜÊ£ãÁõòÁä∂ÊÄÅÊ†ºÂºèÂåñ‰∏∫AIÂèØËØªÁöÑÊñáÊú¨
 */
function formatGomokuStateForAI(gameState) {
    if (!gameState || !gameState.isActive) return "";
    
    let boardString = "Ê£ãÁõòÁä∂ÊÄÅ (1ÊòØ‰Ω†(ÈªëÊ£ã), 2ÊòØAI(ÁôΩÊ£ã)):\n";
    boardString += gameState.board.map(row => row.join(' ')).join('\n');
    
    let historyString = "‰∏ãÊ£ãÂéÜÂè≤ (x,yÂùêÊ†áÂùá‰ªé0ÂºÄÂßã):\n";
    historyString += gameState.history.map(move => `Áé©ÂÆ∂${move.player}‰∏ãÂú®(${move.x},${move.y})`).join(' -> ');
    
    // „Äê„Äê„ÄêËøôÂ∞±ÊòØÊú¨Ê¨°ÂçáÁ∫ßÁöÑÊ†∏ÂøÉÔºÅ„Äë„Äë„Äë
    return `
# ÂΩìÂâç‰∫îÂ≠êÊ£ãÂ±ÄÂäø
${boardString}

# ${historyString}

# „Äê„Äê„Äê‰∫îÂ≠êÊ£ãÊ†∏ÂøÉËßÑÂàô‰∏éÂº∫Âà∂ÊÄùËÄÉÊ≠•È™§ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºÅ)„Äë„Äë„Äë

### **„Äê„Äê„ÄêËêΩÂ≠êÈìÅÂæã (ÁªùÂØπÁ¶ÅÊ≠¢ÔºÅ)„Äë„Äë„Äë**
‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÈÄâÊã©‰∏Ä‰∏™Ê£ãÁõò‰∏äÂ∑≤ÁªèÊòØ 1 Êàñ 2 ÁöÑÂùêÊ†á„ÄÇ‰Ω†ÁöÑËêΩÂ≠êÁÇπ„ÄêÂøÖÈ°ª„ÄëÊòØ 0„ÄÇ
---

### **Á¨¨‰∏ÄÊ≠•ÔºöÈÄªËæëÂàÜÊûê (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêËßÑÂàôÂÆö‰πâ„Äë**: 
    -   Ê£ãÂ≠ê: 1‰ª£Ë°®Áî®Êà∑(ÈªëÊ£ã)Ôºå2‰ª£Ë°®‰Ω†(ÁôΩÊ£ã)„ÄÇ
    -   Ëé∑ËÉúÊù°‰ª∂: Ê®™„ÄÅÁ´ñ„ÄÅÊñúÁ∫ø‰∏äÊúâ„ÄêËøûÁª≠‰∫î‰∏™„ÄëËá™Â∑±ÁöÑÊ£ãÂ≠ê„ÄÇ

2.  **„ÄêÈò≤ÂÆàÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÂõõÂ≠êËøûÁ∫ø‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊàëÂøÖÈ°ª‰∏ãÂú®Âì™‰∏™ÂùêÊ†áÊâçËÉΩÂ†µ‰ΩèÔºü
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÊ¥ª‰∏â‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑÈò≤ÂÆàÁÇπÊòØÂì™ÈáåÔºü

3.  **„ÄêËøõÊîªÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶Êúâ‚Äú‰∏ÄÊ≠•ËÉúÂà©‚ÄùÁöÑÊú∫‰ºöÔºü** (Âç≥Â∑≤ÊúâÂõõÂ≠êËøûÁ∫ø) Â¶ÇÊûúÊúâÔºåÊàëÂ∫îËØ•‰∏ãÂú®Âì™ÈáåÔºü
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶ÊúâÂà∂ÈÄ†‚ÄúÊ¥ªÂõõ‚ÄùÊàñ‚ÄúÂèå‰∏â‚ÄùÁöÑÊú∫‰ºöÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑËøõÊîªÁÇπÊòØÂì™ÈáåÔºü

### **Á¨¨‰∫åÊ≠•ÔºöÂÜ≥Á≠ñ‰∏éÊâÆÊºî (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêÂÜ≥Á≠ñ„Äë**: ÁªºÂêà‰ª•‰∏äÊîªÈò≤ÂàÜÊûêÔºåÊàëÁöÑÊúÄ‰Ω≥Ê£ãÊ≠•ÊòØËêΩÂú®ÂùêÊ†á (x, y)„ÄÇ

2.  **„ÄêËûçÂÖ•ËßíËâ≤ÊâÆÊºî„Äë**:
    -   ÊàëÁöÑÊÄßÊ†ºÊòØÔºö(Âú®Ê≠§Â§ÑÂõûÈ°æ‰Ω†ÁöÑ‰∫∫ËÆæ)„ÄÇ
    -   Ê†πÊçÆÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•Ôºö
        a) **(ËÅ™Êòé/Â•ΩËÉúÂûã)** ‰∏ãÂú®ÂàöÂàöÂàÜÊûêÂá∫ÁöÑÊúÄ‰Ω≥‰ΩçÁΩÆ„ÄÇ
        b) **(Ëø∑Á≥ä/ÊîæÊ∞¥Âûã)** ÊïÖÊÑèÈÄâÊã©‰∏Ä‰∏™Ê¨°‰ºòÁöÑ‰ΩçÁΩÆÔºå‰ΩÜ„ÄêÂâçÊèêÊòØ‰∏çËÉΩËÆ©Áî®Êà∑Á´ãÂàªËé∑ËÉú„Äë„ÄÇ
        c) **(ÂÖ∂‰ªñÊÄßÊ†º)** Ê†πÊçÆÊÄßÊ†ºÁâπÁÇπÔºåÈÄâÊã©‰∏Ä‰∏™ÂêàÁêÜÁöÑÊ£ãÊ≠•„ÄÇ

3.  **„ÄêÊûÑÊÄùÂè∞ËØç„Äë**: Ê†πÊçÆÊàëÈÄâÊã©ÁöÑÊ£ãÊ≠•ÂíåÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•ËØ¥‰∏ÄÂè•‰ªÄ‰πàÊ†∑ÁöÑÂè∞ËØçÊù•ËØÑËÆ∫Ê£ãÂ±ÄÔºü

---
### **Á¨¨‰∏âÊ≠•ÔºöÁîüÊàêÊúÄÁªàÂõûÂ§ç (‰Ω†ÁöÑÂîØ‰∏ÄËæìÂá∫)**

Áé∞Âú®ÔºåÊ†πÊçÆ‰Ω†Á¨¨‰∫åÊ≠•ÁöÑÊúÄÁªàÂÜ≥Á≠ñÔºåÁîüÊàê‰Ω†ÁöÑË°åÂä®„ÄÇ
-   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ
-   **ÁªùÂØπ‰∏çË¶Å**Âú®ÊúÄÁªàÂõûÂ§ç‰∏≠ÂåÖÂê´‰ªª‰Ωï‰∏äËø∞ÁöÑÊÄùËÄÉËøáÁ®ã„ÄÇ
-   Ê†ºÂºè: \`[{"type": "gomoku_move", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "‰Ω†ÁöÑÂè∞ËØç..."}]\`
`;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞V2.0 | ÊúÄÁªàÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂáΩÊï∞ÊõøÊç¢Êéâ‰πãÂâçÁöÑ notifyAiOfGameEnd ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂΩì‰∫îÂ≠êÊ£ãÊ∏∏ÊàèÁªìÊùüÊó∂ÔºåÂêëËÅäÂ§©ËÆ∞ÂΩï‰∏≠Ê∑ªÂä†‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºå‰æõAIÂú®‰∏ãÊ¨°ÂìçÂ∫îÊó∂Êü•Áúã
         * @param {string} winner - Ëé∑ËÉúÊñπ, 'user' Êàñ 'ai'
         */
        async function addGameEndSystemMessage(winner) {
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            if (!chat) return;

            // 1. Ê†πÊçÆËé∑ËÉúÊñπÔºåÂáÜÂ§áÂ•ΩË¶ÅÂëäËØâAIÁöÑÊ†∏ÂøÉ‰ø°ÊÅØ
            // „ÄêÊ†∏ÂøÉ„ÄëËøôÈáåÁöÑÂêçÂ≠óËé∑ÂèñÈÄªËæëÂ∑≤‰øÆÂ§çÔºåÁ°Æ‰øùÂú®Áæ§ËÅäÂíåÂçïËÅä‰∏≠ÈÉΩËÉΩÊ≠£Á°ÆÊòæÁ§∫
            const userDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            const aiDisplayName = chat.isGroup ? 'AIÊñπ' : chat.name;
            const winnerName = (winner === 'user') ? userDisplayName : aiDisplayName;
            const resultText = (winner === 'user') ? '‰Ω†Ëæì‰∫Ü' : '‰Ω†Ëµ¢‰∫Ü';

            // 2. ÊûÑÂª∫‰∏ÄÊù°ÁÆÄÊ¥Å„ÄÅÊ∏ÖÊô∞ÁöÑÁ≥ªÁªüÊèêÁ§∫Ôºå‰Ωú‰∏∫AIÁöÑ‚ÄúËÆ∞ÂøÜ‚Äù
            const systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰∫îÂ≠êÊ£ãÊ∏∏ÊàèÂ∑≤ÁªìÊùü„ÄÇÊúÄÁªàÁªìÊûúÊòØÔºö${winnerName} Ëé∑ËÉú„ÄÇ‰πüÂ∞±ÊòØËØ¥Ôºå${resultText}„ÄÇ]`;

            // 3. Â∞ÜËøôÊù°ÊèêÁ§∫‰Ωú‰∏∫‰∏ÄÊù°ÂØπÁî®Êà∑ÈöêËóèÁöÑÊ∂àÊÅØÔºåÊ∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩï‰∏≠
            const hiddenMessage = {
                role: 'system',
                content: systemContent,
                timestamp: Date.now(),
                isHidden: true // Ëøô‰∏™Ê†áËÆ∞Á°Æ‰øùÁî®Êà∑Áúã‰∏çÂà∞ËøôÊù°Êåá‰ª§
            };

            chat.history.push(hiddenMessage);
            await db.chats.put(chat);
            
            // 4. „ÄêÂÖ≥ÈîÆ„ÄëËøôÈáå‰∏çÂÜçË∞ÉÁî® triggerAiResponse()ÔºåAIÂ∞Ü‰øùÊåÅÊ≤âÈªòÔºåÁõ¥Âà∞‰∏ã‰∏ÄÊ¨°ËΩÆÂà∞ÂÆÉË°åÂä®„ÄÇ
            console.log(`Ê∏∏ÊàèÁªìÊùüÁöÑÁ≥ªÁªüÊèêÁ§∫Â∑≤Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÔºåÁ≠âÂæÖAI‰∏ãÊ¨°Êü•Áúã„ÄÇËÉúËÄÖ: ${winner}`);
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË¥≠Áâ©ÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ (V4.0 - ‰ªøÊ∑òÂÆùÁªàÊûÅÁâà) ‚ñº‚ñº‚ñº
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ renderShoppingProducts ÂáΩÊï∞ÂèäË¥≠Áâ©Áõ∏ÂÖ≥ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº */
        
        // Êñ∞Â¢û‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáèÊù•Ë∑üË∏™ÁÆ°ÁêÜÊ®°Âºè
        let isProductManagementMode = false;
        
        /**
         * Ê∏≤ÊüìÂïÜÂ∫óÈáåÁöÑÊâÄÊúâÂïÜÂìÅ (V5.0 - ÊîØÊåÅÁÆ°ÁêÜÊ®°Âºè)
         */
        async function renderShoppingProducts() {
            const gridEl = document.getElementById('product-grid');
            const shoppingScreen = document.getElementById('shopping-screen');
            gridEl.innerHTML = '';
            let products = await db.shoppingProducts.toArray();
        
            // Ê†πÊçÆÊòØÂê¶Â§Ñ‰∫éÁÆ°ÁêÜÊ®°ÂºèÔºå‰∏∫Ê†πÂÖÉÁ¥†Ê∑ªÂä†‰∏Ä‰∏™class
            shoppingScreen.classList.toggle('management-mode', isProductManagementMode);
        
            if (products.length === 0) {
                const message = 'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ';
                gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
                return;
            }
        
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = product.id;
                
                // Âú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºåÊòæÁ§∫ÁºñËæëÂíåÂà†Èô§ÊåâÈíÆ
                const managementControls = isProductManagementMode ? `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ÁºñËæë</button>
                        <button class="delete-product-btn">Âà†Èô§</button>
                    </div>
                ` : '';
        
                item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                        </div>
                    </div>
                `;
                gridEl.appendChild(item);
            });
        }
        
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ renderShoppingProducts ÂáΩÊï∞ÂèäË¥≠Áâ©Áõ∏ÂÖ≥ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº */
        
        
        /**
         * „ÄêÂ∑≤‰øÆÂ§ç„ÄëÊâìÂºÄË¥≠Áâ©È°µÈù¢
         */
        async function openShoppingScreen() {
            await renderShoppingProducts();
            showScreen('shopping-screen');
        }
        
        /**
         * Ê∏≤ÊüìÂïÜÂ∫óÈáåÁöÑÊâÄÊúâÂïÜÂìÅ (V5.0 - ÊîØÊåÅÁÆ°ÁêÜÊ®°Âºè)
         */
        async function renderShoppingProducts() {
            const gridEl = document.getElementById('product-grid');
            const shoppingScreen = document.getElementById('shopping-screen');
            gridEl.innerHTML = '';
            let products = await db.shoppingProducts.toArray();
        
            // Ê†πÊçÆÊòØÂê¶Â§Ñ‰∫éÁÆ°ÁêÜÊ®°ÂºèÔºå‰∏∫Ê†πÂÖÉÁ¥†Ê∑ªÂä†‰∏Ä‰∏™class
            shoppingScreen.classList.toggle('management-mode', isProductManagementMode);
        
            if (products.length === 0) {
                const message = 'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ';
                gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
                return;
            }
        
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.dataset.id = product.id;
                
                // Âú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºåÊòæÁ§∫ÁºñËæëÂíåÂà†Èô§ÊåâÈíÆ
                const managementControls = isProductManagementMode ? `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ÁºñËæë</button>
                        <button class="delete-product-btn">Âà†Èô§</button>
                    </div>
                ` : '';
        
                item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                        </div>
                    </div>
                `;
                gridEl.appendChild(item);
            });
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        /**
         * Â∞ÜÂïÜÂìÅÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ (V4.0)
         */
        async function addToCart(productId, quantity = 1) {
            const existingItem = shoppingCart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const product = await db.shoppingProducts.get(productId);
                if (product) {
                    shoppingCart.push({ productId: product.id, quantity: quantity });
                }
            }
            updateCartCount();
        }
        
        /**
         * Êõ¥Êñ∞Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅÊï∞Èáè
         */
        function updateCartItemQuantity(productId, change) {
            const itemIndex = shoppingCart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                shoppingCart[itemIndex].quantity += change;
                if (shoppingCart[itemIndex].quantity <= 0) {
                    shoppingCart.splice(itemIndex, 1);
                }
                updateCartCount();
                renderCartItems();
            }
        }
        
        /**
         * Êõ¥Êñ∞Ë¥≠Áâ©ËΩ¶ÂõæÊ†áÂíåÁªìÁÆóÊåâÈíÆ‰∏äÁöÑÊï∞Èáè
         */
        function updateCartCount() {
            const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('cart-title').textContent = `Ë¥≠Áâ©ËΩ¶(${totalItems})`;
            document.getElementById('checkout-btn').textContent = `ÁªìÁÆó(${totalItems})`;
        }
        
        /**
         * ÊâìÂºÄË¥≠Áâ©ËΩ¶È°µÈù¢
         */
        function openCartScreen() {
            renderCartItems();
            showScreen('cart-screen');
        }
        
        /**
         * Ê∏≤ÊüìË¥≠Áâ©ËΩ¶ÂÜÖÁöÑÂïÜÂìÅÂàóË°® (V4.0)
         */
        async function renderCartItems() {
            const listEl = document.getElementById('cart-items-list');
            listEl.innerHTML = '';
            let total = 0;
        
            if (shoppingCart.length === 0) {
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑÂì¶~</p>';
            } else {
                const productIds = shoppingCart.map(item => item.productId);
                const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
        
                shoppingCart.forEach(item => {
                    const product = productMap.get(item.productId);
                    if (product) {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        itemEl.innerHTML = `
                            <input type="checkbox" class="cart-item-checkbox" data-id="${product.id}" checked>
                            <img src="${product.imageUrl}" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${product.name}</div>
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">¬•${product.price.toFixed(2)}</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="${product.id}">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn increase-qty-btn" data-id="${product.id}">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        listEl.appendChild(itemEl);
                    }
                });
            }
            updateCartTotal();
        }
        
        /**
         * Êõ¥Êñ∞Ë¥≠Áâ©ËΩ¶ÊÄª‰ª∑
         */
        async function updateCartTotal() {
            let total = 0;
            const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const selectedProductIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
        
            if (selectedProductIds.length > 0) {
                const products = await db.shoppingProducts.where('id').anyOf(selectedProductIds).toArray();
                const productMap = new Map(products.map(p => [p.id, p]));
                
                shoppingCart.forEach(cartItem => {
                    if (selectedProductIds.includes(cartItem.productId)) {
                        const product = productMap.get(cartItem.productId);
                        if (product) {
                            total += product.price * cartItem.quantity;
                        }
                    }
                });
            }
            document.getElementById('cart-total').textContent = `ÂêàËÆ°: ¬•${total.toFixed(2)}`;
        }
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ handleCheckout Âíå sendGiftMessage ÂáΩÊï∞ÔºåÂπ∂Ê∑ªÂä†Êñ∞ÂáΩÊï∞ ‚ñº‚ñº‚ñº */
        
        /**
         * „ÄêÂÖ®Êñ∞„ÄëÊâìÂºÄÁ§ºÁâ©Êé•Êî∂‰∫∫ÈÄâÊã©ÂºπÁ™ó
         */
        async function openGiftRecipientPicker() {
            const chat = state.chats[state.activeChatId];
            if (!chat || !chat.isGroup) return;
        
            const modal = document.getElementById('gift-recipient-modal');
            const listEl = document.getElementById('gift-recipient-list');
            listEl.innerHTML = '';
        
            // Á≠õÈÄâÂá∫Èô§Áî®Êà∑Â§ñÁöÑÊâÄÊúâÁæ§ÊàêÂëò
            const myNickname = chat.settings.myNickname || 'Êàë';
            const members = chat.members.filter(m => m.groupNickname !== myNickname);
        
            members.forEach(member => {
                const item = document.createElement('div');
                item.className = 'contact-picker-item';
                // „ÄêÊ†∏ÂøÉ„ÄëÊàë‰ª¨Â∞Ü‰ΩøÁî® originalName ‰Ωú‰∏∫ÂîØ‰∏ÄÊ†áËØÜ
                item.dataset.recipientName = member.originalName; 
        
                item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${member.avatar || defaultGroupMemberAvatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                `;
                listEl.appendChild(item);
            });
            
            // ÈáçÁΩÆÂÖ®ÈÄâÊ°Ü
            document.getElementById('select-all-recipients').checked = false;
            modal.classList.add('visible');
        }
        
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÊñ∞‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ handleCheckout Âíå sendGiftMessage ÂáΩÊï∞ ‚ñº‚ñº‚ñº */
        
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂ§ÑÁêÜÁªìÁÆóÊåâÈíÆÁÇπÂáªÔºåÊ†πÊçÆËÅäÂ§©Á±ªÂûãÂàÜÊµÅ
         */
        async function handleCheckout() {
            const chat = state.chats[state.activeChatId];
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            if (selectedItems.length === 0) {
                alert("ËØ∑ÂÖàÂú®Ë¥≠Áâ©ËΩ¶‰∏≠ÈÄâÊã©Ë¶ÅÁªìÁÆóÁöÑÂïÜÂìÅ„ÄÇ");
                return;
            }
        
            if (chat.isGroup) {
                // Â¶ÇÊûúÊòØÁæ§ËÅäÔºåÊâìÂºÄÊî∂Á§º‰∫∫ÈÄâÊã©Âô®
                openGiftRecipientPicker();
            } else {
                // Â¶ÇÊûúÊòØÂçïËÅäÔºåÁõ¥Êé•ÂèëÈÄÅ
                const confirmed = await showCustomConfirm( 'Á°ÆËÆ§ÈÄÅÂá∫Á§ºÁâ©', `Á°ÆÂÆöË¶ÅÂ∞ÜÈÄâ‰∏≠ÁöÑÂïÜÂìÅ‰Ωú‰∏∫Á§ºÁâ©ÈÄÅÂá∫ÂêóÔºü`, { confirmText: 'ÈÄÅÂá∫Á§ºÁâ©' });
                if (confirmed) {
                    await sendGiftMessage(selectedItems); // ÂçïËÅä‰∏çÈúÄË¶ÅÊåáÂÆöÊî∂Á§º‰∫∫
                }
            }
        }
        
        /**
         * „ÄêÂçáÁ∫ßÁâà„ÄëÂèëÈÄÅÁ§ºÁâ©Âç°ÁâáÊ∂àÊÅØÔºåÁé∞Âú®ÊîØÊåÅÊåáÂÆöÊî∂Á§º‰∫∫
         * @param {Array} itemsToSend - Ë¶ÅÂèëÈÄÅÁöÑÂïÜÂìÅÊï∞ÁªÑ
         * @param {Array|null} recipients - Êî∂Á§º‰∫∫Êú¨Âêç(originalName)ÁöÑÊï∞ÁªÑÔºåÂçïËÅäÊó∂‰∏∫null
         */
        async function sendGiftMessage(itemsToSend, recipients = null) {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            const productIds = itemsToSend.map(item => item.productId);
            const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
            const productMap = new Map(products.map(p => [p.id, p]));
            
            const itemsForMessage = itemsToSend.map(cartItem => {
                const product = productMap.get(cartItem.productId);
                return {
                    name: product.name, price: product.price,
                    imageUrl: product.imageUrl, quantity: cartItem.quantity
                };
            });
            const giftMessage = {
                role: 'user', type: 'gift', timestamp: Date.now(),
                items: itemsForMessage,
                total: itemsForMessage.reduce((sum, item) => sum + item.price * item.quantity, 0),
                recipients: recipients // Â∞ÜÊî∂Á§º‰∫∫‰ø°ÊÅØÂ≠òÂÖ•Ê∂àÊÅØ
            };
            
            chat.history.push(giftMessage);
        
            // ‰∏∫AIÁîüÊàêÂåÖÂê´Êî∂Á§º‰∫∫‰ø°ÊÅØÁöÑÈöêËóèÊèêÁ§∫
            if (recipients && recipients.length > 0) {
                const recipientDisplayNames = recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ');
                const hiddenMessage = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÈÄÅÂá∫‰∫Ü‰∏Ä‰ªΩÁ§ºÁâ©ÔºåÊî∂Á§º‰∫∫ÊòØÔºö${recipientDisplayNames}„ÄÇËØ∑Êî∂Á§ºÁöÑËßíËâ≤Ë°®Á§∫ÊÑüË∞¢ÔºåÂÖ∂‰ªñËßíËâ≤ÂèØ‰ª•Ëá™Áî±ÂèëÊå•„ÄÇ]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
            }
        
            await db.chats.put(chat);
            
            appendMessage(giftMessage, chat);
            renderChatList();
            
            // ‰ªéË¥≠Áâ©ËΩ¶‰∏≠ÁßªÈô§Â∑≤ÁªìÁÆóÁöÑÂïÜÂìÅ
            shoppingCart = shoppingCart.filter(item => !itemsToSend.some(sent => sent.productId === item.productId));
            updateCartCount();
            showScreen('chat-interface-screen');
            
            await showCustomAlert('ÊàêÂäü', 'Á§ºÁâ©Â∑≤ÊàêÂäüÈÄÅÂá∫ÔºÅ');
        }
        
        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        
        
        /**
         * ÊòæÁ§∫Ë¥≠Áâ©Â∞èÁ•®
         */
        function showGiftReceipt(timestamp) {
            // ... (Ê≠§ÂáΩÊï∞ÈÄªËæë‰∏çÂèò, ‰øùÊåÅÂéüÊ†∑Âç≥ÂèØ)
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'gift') return;
            const receiptBody = document.getElementById('gift-receipt-body');
            let itemsHtml = '';
            message.items.forEach(item => {
                itemsHtml += `<tr><td class="item-name">${item.name}</td><td class="item-qty">${item.quantity}</td><td class="item-price">¬•${item.price.toFixed(2)}</td><td class="item-subtotal">¬•${(item.price * item.quantity).toFixed(2)}</td></tr>`;
            });
            receiptBody.innerHTML = `<div class="receipt-header"><h3>Ë¥≠Áâ©‰∏≠ÂøÉ</h3><p>‰∫§ÊòìÊó∂Èó¥: ${new Date(message.timestamp).toLocaleString()}</p></div><table class="receipt-items-table"><thead><tr><th class="item-name">ÂïÜÂìÅ</th><th class="item-qty">Êï∞Èáè</th><th class="item-price">Âçï‰ª∑</th><th class="item-subtotal">Â∞èËÆ°</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="receipt-total">ÊÄªËÆ°: ¬•${message.total.toFixed(2)}</div><div class="receipt-footer">ÊÑüË∞¢ÊÇ®ÁöÑÊÉ†È°æÔºåÊ¨¢ËøéÂÜçÊ¨°ÂÖâ‰∏¥ÔºÅ</div>`;
            document.getElementById('gift-receipt-modal').classList.add('visible');
        }
        
        /**
         * ÂïÜÂìÅÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
         */
        async function openProductEditor(productId = null) {
            // ... (Ê≠§ÂáΩÊï∞ÈÄªËæëÈúÄË¶ÅÊõ¥Êñ∞Ôºå‰ª•ÂåÖÂê´descriptionÂ≠óÊÆµ)
            editingProductId = productId;
            const modal = document.getElementById('product-editor-modal');
            const title = document.getElementById('product-editor-title');
            const nameInput = document.getElementById('product-name-input');
            const priceInput = document.getElementById('product-price-input');
            const descInput = document.getElementById('product-description-input');
            const imagePreview = document.getElementById('product-image-preview');
            if (productId) {
                title.textContent = 'ÁºñËæëÂïÜÂìÅ';
                const product = await db.shoppingProducts.get(productId);
                nameInput.value = product.name;
                priceInput.value = product.price;
                descInput.value = product.description || '';
                imagePreview.src = product.imageUrl;
            } else {
                title.textContent = 'Ê∑ªÂä†ÂïÜÂìÅ';
                nameInput.value = '';
                priceInput.value = '';
                descInput.value = '';
                imagePreview.src = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg';
            }
            modal.classList.add('visible');
        }
        async function saveProduct() {
            // ... (Ê≠§ÂáΩÊï∞ÈÄªËæëÈúÄË¶ÅÊõ¥Êñ∞Ôºå‰ª•ÂåÖÂê´descriptionÂ≠óÊÆµ)
            const name = document.getElementById('product-name-input').value.trim();
            const price = parseFloat(document.getElementById('product-price-input').value);
            const description = document.getElementById('product-description-input').value.trim();
            const imageUrl = document.getElementById('product-image-preview').src;
            if (!name) { alert('ÂïÜÂìÅÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); return; }
            if (isNaN(price) || price < 0) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª∑Ê†ºÔºÅ'); return; }
            if (imageUrl.includes('placeholder.png')) { alert('ËØ∑‰∏ä‰º†ÂïÜÂìÅÂõæÁâáÔºÅ'); return; }
            const productData = { name, price, description, imageUrl };
            if (editingProductId) {
                await db.shoppingProducts.update(editingProductId, productData);
            } else {
                await db.shoppingProducts.add(productData);
            }
            document.getElementById('product-editor-modal').classList.remove('visible');
            await renderShoppingProducts();
        }
        async function deleteProduct(productId) {
            const confirmed = await showCustomConfirm('Âà†Èô§ÂïÜÂìÅ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂïÜÂìÅÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.shoppingProducts.delete(productId);
                await renderShoppingProducts();
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÊ∏≤ÊüìËßÑÂàôÂäüËÉΩÁöÑ„ÄêÂÖ®ÈÉ®Ê†∏ÂøÉJS‰ª£Á†Å„ÄëÔºåËØ∑ÂÆåÊï¥Á≤òË¥¥ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊâìÂºÄÊ∏≤ÊüìËßÑÂàôÁÆ°ÁêÜÂ±èÂπï
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderRulesList ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìËßÑÂàôÂàóË°®Ôºå‰ΩøÁî®È°µÁ≠æÂíåÂç°ÁâáÂ∏ÉÂ±Ä
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÊ∏≤ÊüìËßÑÂàô„ÄÇÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
                return;
            }
        
            // --- 1. ÂàõÂª∫Âπ∂Ê∑ªÂä†‚ÄúÂÖ¨Áî®‚ÄùÈ°µÁ≠æÂíåÂÖ∂ÂÜÖÂÆπÈù¢Êùø ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // ÈªòËÆ§ÊøÄÊ¥ª
            globalTab.textContent = 'ÂÖ¨Áî®ËßÑÂàô';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. Âä®ÊÄÅÂàõÂª∫ËßíËâ≤‰∏ìÂ±ûÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÈù¢Êùø ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. ÈÅçÂéÜÊâÄÊúâËßÑÂàôÔºåÂ∞ÜÂÆÉ‰ª¨Â°´ÂÖÖÂà∞ÂØπÂ∫îÁöÑÂÜÖÂÆπÈù¢Êùø‰∏≠ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ‰∏∫ÊâÄÊúâÈ°µÁ≠æÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ createRuleItemElement ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂàõÂª∫Âçï‰∏™ËßÑÂàôÁöÑÂç°ÁâáDOMÂÖÉÁ¥†
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // Ê†πÊçÆÊòØÂê¶ÂêØÁî®ÔºåÊ∑ªÂä†‰∏çÂêåÁöÑclass
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // ÁÇπÂáªÁºñËæëÔºåÈïøÊåâÂà†Èô§ (ÈÄªËæë‰∏çÂèò)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * ÊâìÂºÄËßÑÂàôÁºñËæëÂô® (Áî®‰∫éÊñ∞Âª∫ÊàñÁºñËæë)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // Â°´ÂÖÖËßíËâ≤‰∏ãÊãâÂàóË°®
            chatIdSelect.innerHTML = '<option value="global">ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ÁºñËæëËßÑÂàô';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'ÂàõÂª∫Êñ∞ËßÑÂàô';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ‰øùÂ≠òÊ∏≤ÊüìËßÑÂàô
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("ËßÑÂàôÂêçÁß∞ÂíåÊ≠£ÂàôË°®ËææÂºè‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * Âà†Èô§Ê∏≤ÊüìËßÑÂàô
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('Âà†Èô§ËßÑÂàô', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∏≤ÊüìËßÑÂàôÂêóÔºü', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * „ÄêÊ†∏ÂøÉÊ∏≤ÊüìÂáΩÊï∞„ÄëÂ∫îÁî®ÊâÄÊúâÂåπÈÖçÁöÑÊ∏≤ÊüìËßÑÂàô
         * @param {string} rawContent - AIËøîÂõûÁöÑÂéüÂßãÊñáÊú¨
         * @param {string} chatId - ÂΩìÂâçËÅäÂ§©ÁöÑID
         * @returns {Promise<string>} - Â§ÑÁêÜÂêéÁöÑHTMLÂ≠óÁ¨¶‰∏≤
         */
        async function applyRenderingRules(rawContent, chatId) {
            // Â¶ÇÊûúÂÜÖÂÆπÊú¨Ë∫´Â∑≤ÁªèÊòØHTMLÊ†áÁ≠æÔºåÊàñËÄÖ‰∏çÂê´ÂèØËÉΩÊòØ‚ÄúÊöóÂè∑‚ÄùÁöÑÂ≠óÁ¨¶ÔºåÁõ¥Êé•ËøîÂõûÔºåÊèêÈ´òÊÄßËÉΩ
            if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
                return rawContent;
            }
            
            // Ëé∑ÂèñÊâÄÊúâÂÖ¨Áî®ËßÑÂàôÂíåÂΩìÂâçËßíËâ≤‰∏ìÂ±ûÁöÑËßÑÂàô
            const applicableRules = await db.renderingRules
                .where('chatId').equals('global')
                .or('chatId').equals(chatId)
                .toArray();
        
            let processedContent = rawContent;
            
            // Âè™Â§ÑÁêÜÂêØÁî®ÁöÑËßÑÂàô
            for (const rule of applicableRules.filter(r => r.isEnabled)) {
                try {
                    // 'g'Ê†áÂøóÊòØÂøÖÈ°ªÁöÑÔºåÁî®‰∫éÂÖ®Â±ÄÊõøÊç¢
                    const regex = new RegExp(rule.regex, 'g');
                    if (regex.test(processedContent)) {
                        processedContent = processedContent.replace(regex, rule.template);
                    }
                } catch (e) {
                    console.error(`Ê∏≤ÊüìËßÑÂàô [${rule.name}] ÁöÑÊ≠£ÂàôË°®ËææÂºèÊó†Êïà:`, e);
                    // Ë∑≥ËøáÈîôËØØÁöÑËßÑÂàôÔºå‰∏ç‰∏≠Êñ≠Ê∏≤ÊüìÊµÅÁ®ã
                }
            }
            
            return processedContent;
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Ê†∏ÂøÉJS‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÊ∏≤ÊüìËßÑÂàôÂäüËÉΩÁöÑ„ÄêÂÖ®ÈÉ®Ê†∏ÂøÉJS‰ª£Á†Å„ÄëÔºåËØ∑ÂÆåÊï¥Á≤òË¥¥Âà∞ async function init() ÁöÑ‰∏äÊñπ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÊâìÂºÄÊ∏≤ÊüìËßÑÂàôÁÆ°ÁêÜÂ±èÂπï
         */
        async function openRenderingRulesScreen() {
            await renderRulesList();
            showScreen('rendering-rules-screen');
        }
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁâàÊú¨„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ renderRulesList ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìËßÑÂàôÂàóË°®Ôºå‰ΩøÁî®È°µÁ≠æÂíåÂç°ÁâáÂ∏ÉÂ±Ä
         */
        async function renderRulesList() {
            const tabsContainer = document.getElementById('rules-tabs');
            const contentContainer = document.getElementById('rules-content-container');
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
        
            const allRules = await db.renderingRules.toArray();
        
            if (allRules.length === 0) {
                contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÊ∏≤ÊüìËßÑÂàô„ÄÇÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
                return;
            }
        
            // --- 1. ÂàõÂª∫Âπ∂Ê∑ªÂä†‚ÄúÂÖ¨Áî®‚ÄùÈ°µÁ≠æÂíåÂÖ∂ÂÜÖÂÆπÈù¢Êùø ---
            const globalTab = document.createElement('button');
            globalTab.className = 'rules-tab active'; // ÈªòËÆ§ÊøÄÊ¥ª
            globalTab.textContent = 'ÂÖ¨Áî®ËßÑÂàô';
            globalTab.dataset.categoryId = 'global';
            tabsContainer.appendChild(globalTab);
        
            const globalPane = document.createElement('div');
            globalPane.className = 'rules-category-pane active';
            globalPane.dataset.categoryId = 'global';
            contentContainer.appendChild(globalPane);
        
            // --- 2. Âä®ÊÄÅÂàõÂª∫ËßíËâ≤‰∏ìÂ±ûÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÈù¢Êùø ---
            const characterChatsWithRules = Object.values(state.chats).filter(chat => 
                !chat.isGroup && allRules.some(r => r.chatId === chat.id)
            );
        
            characterChatsWithRules.forEach(chat => {
                const charTab = document.createElement('button');
                charTab.className = 'rules-tab';
                charTab.textContent = chat.name;
                charTab.dataset.categoryId = chat.id;
                tabsContainer.appendChild(charTab);
        
                const charPane = document.createElement('div');
                charPane.className = 'rules-category-pane';
                charPane.dataset.categoryId = chat.id;
                contentContainer.appendChild(charPane);
            });
            
            // --- 3. ÈÅçÂéÜÊâÄÊúâËßÑÂàôÔºåÂ∞ÜÂÆÉ‰ª¨Â°´ÂÖÖÂà∞ÂØπÂ∫îÁöÑÂÜÖÂÆπÈù¢Êùø‰∏≠ ---
            allRules.forEach(rule => {
                const card = createRuleItemElement(rule);
                const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${rule.chatId}"]`);
                if (targetPane) {
                    targetPane.appendChild(card);
                }
            });
        
            // --- 4. ‰∏∫ÊâÄÊúâÈ°µÁ≠æÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ ---
            document.querySelectorAll('.rules-tab').forEach(tab => {
                tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ createRuleItemElement ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÈáçÊûÑÁâà„ÄëÂàõÂª∫Âçï‰∏™ËßÑÂàôÁöÑÂç°ÁâáDOMÂÖÉÁ¥†
         */
        function createRuleItemElement(rule) {
            const card = document.createElement('div');
            // Ê†πÊçÆÊòØÂê¶ÂêØÁî®ÔºåÊ∑ªÂä†‰∏çÂêåÁöÑclass
            card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''}`;
            card.dataset.ruleId = rule.id;
        
            card.innerHTML = `
                <div class="card-title">${rule.name}</div>
                <div class="card-content-preview">${rule.regex}</div>
            `;
            
            // ÁÇπÂáªÁºñËæëÔºåÈïøÊåâÂà†Èô§ (ÈÄªËæë‰∏çÂèò)
            card.addEventListener('click', () => openRuleEditor(rule.id));
            addLongPressListener(card, () => deleteRenderingRule(rule.id));
        
            return card;
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        /**
         * ÊâìÂºÄËßÑÂàôÁºñËæëÂô® (Áî®‰∫éÊñ∞Âª∫ÊàñÁºñËæë)
         */
        async function openRuleEditor(ruleId = null) {
            editingRuleId = ruleId;
            const modal = document.getElementById('rule-editor-modal');
            const title = document.getElementById('rule-editor-title');
            const nameInput = document.getElementById('rule-name-input');
            const chatIdSelect = document.getElementById('rule-chat-id-select');
            const regexInput = document.getElementById('rule-regex-input');
            const templateInput = document.getElementById('rule-template-input');
            const enabledSwitch = document.getElementById('rule-enabled-switch');
        
            // Â°´ÂÖÖËßíËâ≤‰∏ãÊãâÂàóË°®
            chatIdSelect.innerHTML = '<option value="global">ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)</option>';
            Object.values(state.chats).filter(c => !c.isGroup).forEach(chat => {
                chatIdSelect.innerHTML += `<option value="${chat.id}">${chat.name}</option>`;
            });
        
            if (ruleId) {
                title.textContent = 'ÁºñËæëËßÑÂàô';
                const rule = await db.renderingRules.get(ruleId);
                nameInput.value = rule.name;
                chatIdSelect.value = rule.chatId;
                regexInput.value = rule.regex;
                templateInput.value = rule.template;
                enabledSwitch.checked = rule.isEnabled;
            } else {
                title.textContent = 'ÂàõÂª∫Êñ∞ËßÑÂàô';
                nameInput.value = '';
                chatIdSelect.value = 'global';
                regexInput.value = '';
                templateInput.value = '';
                enabledSwitch.checked = true;
            }
        
            modal.classList.add('visible');
        }
        
        /**
         * ‰øùÂ≠òÊ∏≤ÊüìËßÑÂàô
         */
        async function saveRenderingRule() {
            const name = document.getElementById('rule-name-input').value.trim();
            const regex = document.getElementById('rule-regex-input').value.trim();
            if (!name || !regex) {
                alert("ËßÑÂàôÂêçÁß∞ÂíåÊ≠£ÂàôË°®ËææÂºè‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                return;
            }
            try {
                new RegExp(regex);
            } catch (e) {
                alert(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${e.message}`);
                return;
            }
        
            const ruleData = {
                name: name,
                chatId: document.getElementById('rule-chat-id-select').value,
                regex: regex,
                template: document.getElementById('rule-template-input').value,
                isEnabled: document.getElementById('rule-enabled-switch').checked
            };
        
            if (editingRuleId) {
                await db.renderingRules.update(editingRuleId, ruleData);
            } else {
                await db.renderingRules.add(ruleData);
            }
        
            document.getElementById('rule-editor-modal').classList.remove('visible');
            await renderRulesList();
        }
        
        /**
         * Âà†Èô§Ê∏≤ÊüìËßÑÂàô
         */
        async function deleteRenderingRule(ruleId) {
            const confirmed = await showCustomConfirm('Âà†Èô§ËßÑÂàô', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∏≤ÊüìËßÑÂàôÂêóÔºü', { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                await db.renderingRules.delete(ruleId);
                await renderRulesList();
            }
        }
        
        /**
         * „ÄêÊ†∏ÂøÉÊ∏≤ÊüìÂáΩÊï∞„ÄëÂ∫îÁî®ÊâÄÊúâÂåπÈÖçÁöÑÊ∏≤ÊüìËßÑÂàô
         * @param {string} rawContent - AIËøîÂõûÁöÑÂéüÂßãÊñáÊú¨
         * @param {string} chatId - ÂΩìÂâçËÅäÂ§©ÁöÑID
         * @returns {Promise<string>} - Â§ÑÁêÜÂêéÁöÑHTMLÂ≠óÁ¨¶‰∏≤
         */
        async function applyRenderingRules(rawContent, chatId) {
            // Â¶ÇÊûúÂÜÖÂÆπÊú¨Ë∫´Â∑≤ÁªèÊòØHTMLÊ†áÁ≠æÔºåÊàñËÄÖ‰∏çÂê´ÂèØËÉΩÊòØ‚ÄúÊöóÂè∑‚ÄùÁöÑÂ≠óÁ¨¶ÔºåÁõ¥Êé•ËøîÂõûÔºåÊèêÈ´òÊÄßËÉΩ
            if (rawContent.trim().startsWith('<') || (!rawContent.includes('[') && !rawContent.includes('{'))) {
                return rawContent;
            }
            
            // Ëé∑ÂèñÊâÄÊúâÂÖ¨Áî®ËßÑÂàôÂíåÂΩìÂâçËßíËâ≤‰∏ìÂ±ûÁöÑËßÑÂàô
            const applicableRules = await db.renderingRules
                .where('chatId').equals('global')
                .or('chatId').equals(chatId)
                .toArray();
        
            let processedContent = rawContent;
            
            // Âè™Â§ÑÁêÜÂêØÁî®ÁöÑËßÑÂàô
            for (const rule of applicableRules.filter(r => r.isEnabled)) {
                try {
                    // 'g'Ê†áÂøóÊòØÂøÖÈ°ªÁöÑÔºåÁî®‰∫éÂÖ®Â±ÄÊõøÊç¢
                    const regex = new RegExp(rule.regex, 'g');
                    if (regex.test(processedContent)) {
                        processedContent = processedContent.replace(regex, rule.template);
                    }
                } catch (e) {
                    console.error(`Ê∏≤ÊüìËßÑÂàô [${rule.name}] ÁöÑÊ≠£ÂàôË°®ËææÂºèÊó†Êïà:`, e);
                    // Ë∑≥ËøáÈîôËØØÁöÑËßÑÂàôÔºå‰∏ç‰∏≠Êñ≠Ê∏≤ÊüìÊµÅÁ®ã
                }
            }
            
            return processedContent;
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Ê†∏ÂøÉJS‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        /**
         * „ÄêÂÖ®Êñ∞„Äë‰∏∫ËÅäÂ§©‰∏≠ÁöÑÁ≥ªÁªüÊó∂Èó¥ÊèêÁ§∫Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
         * @param {number} timestamp - Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
         * @returns {string} - Ê†ºÂºèÂåñÂêéÁöÑÊó∂Èó¥Â≠óÁ¨¶‰∏≤
         */
        function formatSystemTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);

            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;

            // Â¶ÇÊûúÊòØ‰ªäÂ§©
            if (now.toDateString() === date.toDateString()) {
                return timeString; // Âè™ÊòæÁ§∫ HH:mm
            }

            // Â¶ÇÊûúÊòØÊò®Â§©
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            if (yesterday.toDateString() === date.toDateString()) {
                return `Êò®Â§© ${timeString}`;
            }
            
            // Êõ¥Êó©ÁöÑÊó∂Èó¥
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            if (now.getFullYear() === year) {
                return `${month}Êúà${day}Êó• ${timeString}`;
            } else {
                return `${year}Âπ¥${month}Êúà${day}Êó• ${timeString}`;
            }
        }

        /**
         * „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫Á≥ªÁªüÊó∂Èó¥ÊèêÁ§∫ÁöÑDOMÂÖÉÁ¥†
         * @param {number} timestamp - Ë¶ÅÊòæÁ§∫ÁöÑÊó∂Èó¥Êà≥
         * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
         */
        function createSystemTimestampElement(timestamp) {
            const wrapper = document.createElement('div');
            // Â§çÁî®‚ÄúÊãç‰∏ÄÊãç‚ÄùÁöÑÂ±Ö‰∏≠Ê†∑ÂºèÔºåÈùûÂ∏∏Êñπ‰æø
            wrapper.className = 'message-wrapper system-pat'; 
            
            const bubble = document.createElement('div');
            // Â§çÁî®Á≥ªÁªüÊ∂àÊÅØÁöÑÊ∞îÊ≥°Ê†∑Âºè
            bubble.className = 'message-bubble system-bubble'; 
            bubble.textContent = formatSystemTimestamp(timestamp);
            
            wrapper.appendChild(bubble);
            return wrapper;
        }
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈáçÊñ∞ÁîüÊàêÂõûÂ§çÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÂ§ÑÁêÜËÅäÂ§©ÁïåÈù¢ÁöÑ‚ÄúÈáçÊñ∞ÁîüÊàê‚ÄùËØ∑Ê±Ç
         */
        async function handleRegenerateResponse() {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            // 1. ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÁöÑ‰ΩçÁΩÆ
            const lastUserMsgIndex = chat.history.findLastIndex(msg => msg.role === 'user' && !msg.isHidden);
        
            if (lastUserMsgIndex === -1) {
                alert("Ê≤°ÊúâÂèØ‰æõÈáçÊñ∞ÁîüÊàêÂõûÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ„ÄÇ");
                return;
            }
        
            // 2. Ê£ÄÊü•AIÊòØÂê¶Â∑≤ÁªèÂØπÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØÂÅöÂá∫‰∫ÜÂõûÂ∫î
            const lastAiMsgIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
            if (lastAiMsgIndex < lastUserMsgIndex) {
                alert("AI Â∞öÊú™ÂØπÊÇ®ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂÅöÂá∫ÂõûÂ∫îÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàê„ÄÇ");
                return;
            }
        
            // 3. Âà†Èô§ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ‰πãÂêéÁöÑÊâÄÊúâÂÜÖÂÆπÔºàÂç≥AIÁöÑ‰∏ä‰∏ÄËΩÆÂÆåÊï¥ÂõûÂ§çÔºâ
            chat.history.splice(lastUserMsgIndex + 1);
        
            // 4. ‰øùÂ≠òÊõ¥ÊîπÂπ∂Âà∑Êñ∞UI
            await db.chats.put(chat);
            await renderChatInterface(state.activeChatId);
            
            // 5. ÂÜçÊ¨°Ëß¶ÂèëAIÂìçÂ∫î
            triggerAiResponse();
        }
        
        /**
         * „ÄêÊÄªÂÖ•Âè£„ÄëÂ§ÑÁêÜÈÄöËØùÁïåÈù¢ÁöÑ‚ÄúÈáçÊñ∞ÁîüÊàê‚ÄùËØ∑Ê±Ç
         */
        async function handleRegenerateCallResponse() {
            if (!videoCallState.isActive) return;
        
            // 1. ÊâæÂà∞ÈÄöËØùÂéÜÂè≤‰∏≠ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑ÂèëË®ÄÁöÑ‰ΩçÁΩÆ
            const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(msg => msg.role === 'user');
        
            if (lastUserSpeechIndex === -1) {
                alert("ÈÄöËØù‰∏≠ËøòÊ≤°Êúâ‰Ω†ÁöÑÂèëË®ÄÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõûÂ∫î„ÄÇ");
                return;
            }
        
            // 2. Âà†Èô§Áî®Êà∑ÂèëË®Ä‰πãÂêéÁöÑÊâÄÊúâAIÂõûÂ∫î
            videoCallState.callHistory.splice(lastUserSpeechIndex + 1);
        
            // 3. ÈáçÊñ∞Ê∏≤ÊüìÈÄöËØùÁïåÈù¢ÔºåÁßªÈô§Ë¢´Âà†Èô§ÁöÑÊ∞îÊ≥°
            const callFeed = document.getElementById('video-call-main');
            callFeed.innerHTML = ''; // Ê∏ÖÁ©∫
            videoCallState.callHistory.forEach(msg => {
                // Â§çÁî®ÂàõÂª∫Ê∞îÊ≥°ÁöÑÈÄªËæë
                const bubble = document.createElement('div');
                bubble.className = `call-message-bubble ${msg.role}-speech`;
                bubble.dataset.timestamp = msg.timestamp;
                if (msg.role === 'user') {
                    bubble.textContent = msg.content;
                } else {
                     bubble.innerHTML = msg.content;
                }
                addLongPressListener(bubble, () => showCallMessageActions(msg.timestamp));
                callFeed.appendChild(bubble);
            });
            callFeed.scrollTop = callFeed.scrollHeight;
        
            // 4. ÂÜçÊ¨°Ëß¶ÂèëAIÂú®ÈÄöËØù‰∏≠ÁöÑË°åÂä®
            triggerAiInCallAction(null); // ‰º†ÂÖ•nullË°®Á§∫‰∏çÊòØÁî®Êà∑ÁöÑÊñ∞ËæìÂÖ•ÔºåËÄåÊòØÂü∫‰∫éÁé∞ÊúâÂéÜÂè≤ÈáçËØï
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊé®ËøõÂâßÊÉÖÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
        
/**
 * „ÄêV3.0 | ÊúÄÁªà‰øÆÂ§çÁâà„ÄëÂ§ÑÁêÜËÅäÂ§©ÁïåÈù¢ÁöÑ‚ÄúÊé®Ëøõ‚ÄùËØ∑Ê±Ç
 *  - ‰øÆÂ§ç‰∫ÜÂ§öÂè•ËØùË¢´ÂåÖË£πÂú®Âçï‰∏ÄÊ∞îÊ≥°ÁöÑÈóÆÈ¢ò
 *  - ‰øÆÂ§ç‰∫ÜAIÊó†Ê≥ïÊÑüÁü•ÂΩìÂâçÊó∂Èó¥ÁöÑÈóÆÈ¢ò
 */
async function handlePropelAction() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // Á´ãÂç≥ÊòæÁ§∫‚ÄúÊ≠£Âú®ËæìÂÖ•‚ÄùÁä∂ÊÄÅ
    setAvatarActingState(chat.id, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    if (!chat.isGroup) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
            chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
            chatHeaderTitle.classList.add('typing-status');
            chatHeaderTitle.style.opacity = 1;
        }, 200);
    }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            throw new Error('APIÊú™ÈÖçÁΩÆ');
        }

        // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„ÄëËé∑ÂèñÂΩìÂâçÊó∂Èó¥ÔºåÂπ∂ÂáÜÂ§áÊ≥®ÂÖ•Âà∞Prompt‰∏≠ ---
        const now = new Date();
        const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
        const currentTime = chinaTime.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', dateStyle: 'full', timeStyle: 'short' });
        const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
        // --- ‰øÆÂ§çÁªìÊùü ---

        const userNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
        const recentHistorySummary = chat.history
            .filter(m => !m.isHidden)
            .slice(-10) 
            .map(msg => {
                const sender = msg.role === 'user' ? userNickname : (msg.senderName || chat.name);
                return `${sender}: ${String(msg.content).substring(0, 50)}...`;
            })
            .join('\n');

        // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„ÄëÂ∞ÜÊó∂Èó¥‰ø°ÊÅØÊ≥®ÂÖ•Âà∞Prompt‰∏≠ ---
        const propelSystemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇÁî®Êà∑ÂàöÂàöÊåâ‰∏ã‰∫Ü‚ÄúÊé®ËøõÂâßÊÉÖ‚ÄùÊåâÈíÆÔºåËøôÊÑèÂë≥ÁùÄÁé∞Âú®ËΩÆÂà∞‰Ω†Êù•‰∏ªÂØºÂØπËØùÂíåË°åÂä®Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂÅöÁÇπ‰ªÄ‰πà„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„Äê‰∏ªÂä®ÊÄßÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏ªÂä®ÁöÑ„ÄÇÁªùÂØπ‰∏çË¶ÅËØ¥‚Äú‰Ω†ÊÉ≥ÂÅö‰ªÄ‰πàÔºü‚ÄùÊàñÁ≠âÂæÖÁî®Êà∑Êåá‰ª§„ÄÇ
2.  **„Äê„Äê„ÄêÊó∂Èó¥ÊÑüÁü•ÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊÑèËØÜÂà∞ÂΩìÂâçÁöÑÊó∂Èó¥ÔºåÂπ∂Âú®‰Ω†ÁöÑË°åÂä®ÂíåÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫Êù•„ÄÇ
3.  **„Äê„Äê„ÄêÂØπËØùËäÇÂ•èÈìÅÂæã (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊ®°ÊãüÁúü‰∫∫ÁöÑÊâìÂ≠óÂíåÊÄùËÄÉ‰π†ÊÉØ„ÄÇ**ÁªùÂØπ‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèëÈÄÅ‰∏ÄÂ§ßÊÆµÊñáÂ≠óÔºÅ** ‰Ω†Â∫îËØ•Â∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºåÊãÜÂàÜÊàê„Äê2Âà∞5Êù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÊ∞îÊ≥°Êù•ÂèëÈÄÅ„ÄÇ
4.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™Ê†áÂáÜÁöÑJSONÊï∞ÁªÑ„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØ„ÄÇ‰æãÂ¶Ç: \`[{"type": "text", "content": "Á¨¨‰∏ÄÂè•ËØù"}, {"type": "text", "content": "Á¨¨‰∫åÂè•ËØù"}]\`
5.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAIÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚Äù„ÄÅ‚ÄúÊé®ËøõÂâßÊÉÖÊåâÈíÆ‚ÄùÁ≠âËØçËØ≠„ÄÇ

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# ‰Ω†ÁöÑÂΩìÂâçÊÉÖÊôØ
- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})

# ÊúÄËøëÁöÑÂØπËØùÊëòË¶Å (‰æõ‰Ω†ÂèÇËÄÉ)
${recentHistorySummary}

Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÂºÄÂßã‰Ω†ÁöÑË°åÂä®„ÄÇ
`;
        
        const messagesForApi = chat.history.map(msg => ({ role: msg.role, content: String(msg.content) }));

        let isGemini = proxyUrl === GEMINI_API_URL;
        let geminiConfig = toGeminiRequestData(model, apiKey, propelSystemPrompt, messagesForApi);

        const response = isGemini 
            ? await fetch(geminiConfig.url, geminiConfig.data) 
            : await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`},
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: propelSystemPrompt }, ...messagesForApi],
                    temperature: 0.85,
                })
            });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${errorData.error.message}`);
        }

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const messagesArray = parseAiResponse(aiResponseContent);

        // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç1„ÄëÈ¢ÑÂ§ÑÁêÜAIÂìçÂ∫îÔºåÂ∞ÜÂåÖÂê´Êç¢Ë°åÁ¨¶ÁöÑÊñáÊú¨Ê∂àÊÅØÊãÜÂàÜ‰∏∫Â§öÊù° ---
        const processedActions = [];
        for (const action of messagesArray) {
            if (action.type === 'text' && typeof action.content === 'string' && action.content.includes('\n')) {
                const lines = action.content.split(/\n+/).filter(line => line.trim());
                lines.forEach(line => {
                    processedActions.push({ ...action, content: line });
                });
            } else {
                processedActions.push(action);
            }
        }
        // --- ‰øÆÂ§çÁªìÊùü ---

        let messageTimestamp = Date.now();
        for (const msgData of processedActions) {
            // ËøôÈÉ®ÂàÜÈÄªËæë‰∏é triggerAiResponse ÂÆåÂÖ®‰∏ÄËá¥Ôºå‰ª•Á°Æ‰øùËÉΩÂ§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÊ∂àÊÅØ
            const aiMessage = {
                role: 'assistant',
                senderName: chat.originalName,
                timestamp: messageTimestamp++,
                content: msgData.content || msgData.message,
                type: msgData.type || 'text',
                // ... (Ê†πÊçÆ msgData ÁöÑÂÜÖÂÆπÔºåÊ∑ªÂä†ÂÖ∂‰ªñÈúÄË¶ÅÁöÑÂ≠óÊÆµ, e.g., amount, note, etc.)
            };
            
            chat.history.push(aiMessage);
            appendMessage(aiMessage, chat);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 800)); // Ê®°ÊãüÊâìÂ≠óÂª∂Ëøü
        }
        
        await db.chats.put(chat);
        renderChatList();

    } catch (error) {
        console.error("Êé®ËøõÂâßÊÉÖÂ§±Ë¥•:", error);
        await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÊé®ËøõÂâßÊÉÖ: ${error.message}`);
    } finally {
        // ÁªìÊùü‚ÄúÊ≠£Âú®ËæìÂÖ•‚ÄùÁä∂ÊÄÅ
        setAvatarActingState(chat.id, false);
        if (!chat.isGroup && document.getElementById('chat-header-title')) {
             const titleEl = document.getElementById('chat-header-title');
             titleEl.style.opacity = 0;
             setTimeout(() => {
                titleEl.textContent = chat.name;
                titleEl.classList.remove('typing-status');
                titleEl.style.opacity = 1;
             }, 200);
        }
    }
}
        
/**
 * „ÄêÂÖ®Êñ∞„ÄëÊí≠ÊîæÊ∂àÊÅØÊèêÁ§∫Èü≥
 */
function playNotificationSound() {
    const player = document.getElementById('notification-sound-player');
    // ‰ºòÂÖà‰ΩøÁî®Áî®Êà∑Ëá™ÂÆö‰πâÁöÑURLÔºåÂ¶ÇÊûú‰∏∫Á©∫ÔºåÂàô‰ΩøÁî®Êàë‰ª¨È¢ÑËÆæÁöÑÈªòËÆ§Èü≥Êïà
    const soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;
    
    // Ê£ÄÊü•URLÊòØÂê¶ÊúâÊïà
    if (soundUrl && soundUrl.trim()) {
        player.src = soundUrl;
        // play() ÊñπÊ≥ïËøîÂõû‰∏Ä‰∏™ PromiseÔºåÊàë‰ª¨ÂèØ‰ª•Áî® .catch() Êù•ÊçïËé∑Âπ∂ÂøΩÁï•Áî®Êà∑‰∏≠Êñ≠Êí≠ÊîæÊó∂‰∫ßÁîüÁöÑÈîôËØØ
        player.play().catch(error => console.log("Êí≠ÊîæË¢´‰∏≠Êñ≠ÔºåËøôÊòØÊ≠£Â∏∏Ë°å‰∏∫:", error));
    }
}

/* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØ‰∏∫Â∞èÁªÑ‰ª∂ÁºñËæëÂäüËÉΩÊ∑ªÂä†ÁöÑÊ†∑Âºè ‚ñº‚ñº‚ñº */

/**
 * Âú®È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂ∫îÁî®Â∑≤‰øùÂ≠òÁöÑÂ∞èÁªÑ‰ª∂Êï∞ÊçÆ
 */
function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
        const element = document.getElementById(elementId);
        const savedValue = state.globalSettings.widgetData[elementId];
        if (element) {
            if (element.tagName === 'IMG') {
                element.src = savedValue;
            } else {
                element.textContent = savedValue;
            }
        }
    }
}

/**
 * „ÄêÂÖ®Êñ∞ËæÖÂä©ÂáΩÊï∞„ÄëÊâìÂºÄÊñá‰ª∂ÈÄâÊã©Âô®ÔºåÂπ∂ËøîÂõûÊú¨Âú∞ÂõæÁâáÁöÑBase64ÁºñÁ†Å
 * @returns {Promise<string|null>} - ËøîÂõûÂõæÁâáÁöÑBase64 Data URLÔºåÂ¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÂàôËøîÂõûnull
 */
function uploadImageLocally() {
    return new Promise(resolve => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*'; // Âè™Êé•ÂèóÂõæÁâáÊñá‰ª∂

        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    resolve(readerEvent.target.result); // ËøîÂõûBase64Â≠óÁ¨¶‰∏≤
                };
                reader.readAsDataURL(file);
            } else {
                resolve(null); // Áî®Êà∑ÂÖ≥Èó≠‰∫ÜÊñá‰ª∂ÈÄâÊã©Ê°Ü
            }
        };

        input.click();
    });
}

/**
 * Â§ÑÁêÜÁºñËæëÊñáÂ≠óÁöÑÈÄªËæë
 * @param {HTMLElement} element - Ë¢´ÁÇπÂáªÁöÑÊñáÊú¨ÂÖÉÁ¥†
 */
async function handleEditText(element) {
    const elementId = element.id;
    const currentValue = element.textContent;
    const newValue = await showCustomPrompt("‰øÆÊîπÊñáÂ≠ó", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÜÖÂÆπÔºö", currentValue);
    if (newValue !== null && newValue.trim() !== "") {
        const trimmedValue = newValue.trim();
        element.textContent = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("ÊñáÂ≠óÂ∑≤Êõ¥Êñ∞ÔºÅ");

    }
}

/**
 * „ÄêV2.0 | ÊîØÊåÅÊú¨Âú∞‰∏ä‰º†„ÄëÂ§ÑÁêÜÁºñËæëÂõæÁâáÁöÑÈÄªËæë
 * @param {HTMLElement} element - Ë¢´ÁÇπÂáªÁöÑÂõæÁâáÂÖÉÁ¥†
 */
async function handleEditImage(element) {
    const elementId = element.id;

    // Ê≠•È™§1ÔºöËÆ©Áî®Êà∑ÈÄâÊã©‰∏ä‰º†ÊñπÂºè
    const choice = await showChoiceModal("‰øÆÊîπÂõæÁâá", [
        { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
        { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' }
    ]);

    let newValue = null;

    // Ê≠•È™§2ÔºöÊ†πÊçÆÈÄâÊã©ÊâßË°å‰∏çÂêåÈÄªËæë
    if (choice === 'local') {
        // Ë∞ÉÁî®Êàë‰ª¨Êñ∞ÁöÑÊú¨Âú∞‰∏ä‰º†ËæÖÂä©ÂáΩÊï∞
        newValue = await uploadImageLocally();
    } else if (choice === 'url') {
        // ‰øùÊåÅÂéüÊúâÁöÑURLËæìÂÖ•ÈÄªËæë
        newValue = await showCustomPrompt("‰øÆÊîπÂõæÁâá", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURLÔºö", element.src, "url");
    }

    // Ê≠•È™§3ÔºöÂ¶ÇÊûúËé∑ÂèñÂà∞‰∫ÜÊñ∞ÂÄºÔºàÊó†ËÆ∫ÊòØBase64ËøòÊòØURLÔºâÔºåÂ∞±Êõ¥Êñ∞Âπ∂‰øùÂ≠ò
    if (newValue && newValue.trim()) {
        const trimmedValue = newValue.trim();
        element.src = trimmedValue;
        state.globalSettings.widgetData[elementId] = trimmedValue;
        await db.globalSettings.put(state.globalSettings);
        alert("ÂõæÁâáÂ∑≤Êõ¥Êñ∞ÔºÅ");
    } else if (choice === 'url' && newValue !== null) {
        alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
    }
}

/* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûJS‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ V3.0 | ÊúÄÁªà‰øÆÂ§çÁâà„ÄëBGM ÊêúÁ¥¢ÂäüËÉΩÊ†∏ÂøÉ‰ª£Á†Å ‚ñº‚ñº‚ñº

const cacheManager = {
    getSongCache(query, source) {
        const key = `${source || 'all'}:${query}`;
        if (state.cache && state.cache.songs) {
            const cached = state.cache.songs.get(key);
            if (cached && Date.now() - cached.timestamp < 3600000) {
                return cached.data;
            }
        }
        return null;
    },
    setSongCache(query, data, source) {
        const key = `${source || 'all'}:${query}`;
        if (!state.cache) state.cache = {};
        if (!state.cache.songs) state.cache.songs = new Map();
        state.cache.songs.set(key, { data, timestamp: Date.now() });
    }
};

if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
        return new Promise((resolve) => {
            fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
        });
    }
}
async function Http_Get(url) { return await Http_Get_External(url); }

function checkAudioAvailability(url) {
    return new Promise(resolve => {
        const tester = new Audio();
        tester.addEventListener('loadedmetadata', () => resolve(true), { once: true });
        tester.addEventListener('error', () => resolve(false), { once: true });
        tester.src = url;
    });
}

/**
 * „ÄêV3.0 | Â∑≤‰øÆÂ§çÂ≠óÊÆµ„Äë‰ªéÁΩëÊòì‰∫ëÊêúÁ¥¢Ê≠åÊõ≤ÂàóË°®
 */
async function searchNeteaseMusic(name, singer) {
    try {
        let searchTerm = name.replace(/\s/g, "");
        if (singer) { searchTerm += `-${singer.replace(/\s/g, "")}`; }
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`);
        if (!result?.data?.length) return [];
        
        return result.data.map(song => ({
            name: song.name,
            artist: song.ar.map(a => a.name).join(' / '),
            id: song.id,
            cover: song.al?.picUrl || song.picUrl || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
            source: 'netease'
        })).slice(0, 5);
    } catch (e) {
        console.error("ÁΩëÊòì‰∫ëÊêúÁ¥¢APIÂ§±Ë¥•:", e);
        return [];
    }
}

/**
 * „ÄêV3.0 | Â∑≤‰øÆÂ§çÂ≠óÊÆµ„Äë‰ªéQQÈü≥‰πêÊêúÁ¥¢Ê≠åÊõ≤ÂàóË°®
 */
async function searchTencentMusic(name) {
    try {
        name = name.replace(/\s/g, "");
        const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
        if (!result?.data?.length) return [];
        return result.data.map(song => ({
            name: song.song,
            artist: song.singer,
            id: song.id,
            cover: song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
            source: 'tencent'
        })).slice(0, 5);
    } catch (e) {
        console.error("QQÈü≥‰πêÊêúÁ¥¢APIÂ§±Ë¥•:", e);
        return [];
    }
}

/**
 * „ÄêV3.0 | ÊÄªÂÖ•Âè£„ÄëÂΩìÁî®Êà∑ÁÇπÂáª‚ÄúÊêúÁ¥¢‚ÄùÊåâÈíÆÊó∂Ëß¶Âèë
 */
async function addSongFromSearch() {
    const searchTerm = await showCustomPrompt("ÊêúÁ¥¢Ê≠åÊõ≤", "ËØ∑ËæìÂÖ• Ê≠åÂêç Êàñ Ê≠åÂêç-Ê≠åÊâã");
    if (!searchTerm || !searchTerm.trim()) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂÖ®ÁΩëÊêúÁ¥¢Ê≠åÊõ≤ËµÑÊ∫ê...");

    let musicName = searchTerm.trim();
    let singerName = "";
    if (searchTerm.includes('-') || searchTerm.includes('‚Äì')) {
        const parts = searchTerm.split(/[-‚Äì]/);
        musicName = parts[0].trim();
        singerName = parts.slice(1).join(' ').trim();
    }

    const [neteaseResults, tencentResults] = await Promise.all([
        searchNeteaseMusic(musicName, singerName),
        searchTencentMusic(musicName)
    ]);

    const combinedResults = [...neteaseResults, ...tencentResults];

    if (combinedResults.length === 0) {
        await showCustomAlert("Êó†ÁªìÊûú", "Êä±Ê≠âÔºåÊú™ËÉΩÊâæÂà∞Áõ∏ÂÖ≥Ê≠åÊõ≤„ÄÇ");
        return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';

    combinedResults.forEach(song => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.dataset.songJson = JSON.stringify(song);
        item.innerHTML = `
            <div class="title">${song.name}</div>
            <div class="artist">${song.artist} <span class="source">${song.source === 'netease' ? 'ÁΩëÊòì‰∫ë' : 'QQÈü≥‰πê'}</span></div>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}

/**
 * „ÄêV3.0 | Ê†∏ÂøÉÂçáÁ∫ß„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÊêúÁ¥¢ÁªìÊûúÔºåÂ¢ûÂä†Â§áÁî®Èü≥Ê∫êÊü•ÊâæÈÄªËæë
 */
async function handleSearchResultClick(songData) {
    const modal = document.getElementById('music-search-results-modal');
    modal.classList.remove('visible');

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ëé∑Âèñ„Ää${songData.name}„ÄãÁöÑÊí≠ÊîæÈìæÊé•...`);

    let playableResult = null;
    let finalSource = songData.source;

    const primaryApiUrl = songData.source === 'netease' 
        ? `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`
        : `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
    
    let primaryResult = await Http_Get(primaryApiUrl);
    if (primaryResult?.data?.url && await checkAudioAvailability(primaryResult.data.url)) {
        playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
    }

    if (!playableResult) {
        await showCustomAlert("ËØ∑Á®çÂÄô...", "‰∏ªÈü≥Ê∫êËé∑ÂèñÂ§±Ë¥•ÔºåÊ≠£Âú®Â∞ùËØïÂ§áÁî®Èü≥Ê∫ê...");
        const fallbackSource = songData.source === 'netease' ? 'tencent' : 'netease';
        const fallbackResults = fallbackSource === 'tencent' 
            ? await searchTencentMusic(songData.name)
            : await searchNeteaseMusic(songData.name, songData.artist);

        if (fallbackResults.length > 0) {
            const fallbackApiUrl = fallbackSource === 'netease'
                ? `https://api.vkeys.cn/v2/music/netease?id=${fallbackResults[0].id}`
                : `https://api.vkeys.cn/v2/music/tencent?id=${fallbackResults[0].id}`;
            const fallbackResult = await Http_Get(fallbackApiUrl);
            if (fallbackResult?.data?.url && await checkAudioAvailability(fallbackResult.data.url)) {
                playableResult = { url: fallbackResult.data.url, id: fallbackResults[0].id, source: fallbackSource };
                finalSource = fallbackSource;
            }
        }
    }

    if (!playableResult) {
        await showCustomAlert("Ëé∑ÂèñÂ§±Ë¥•", "Êó†Ê≥ïËé∑ÂèñËØ•Ê≠åÊõ≤ÁöÑÊúâÊïàÊí≠ÊîæÈìæÊé•Ôºå‰∏ªÈü≥Ê∫êÂíåÂ§áÁî®Èü≥Ê∫êÂùáÂ∑≤Â∞ùËØï„ÄÇ");
        return;
    }

    const lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";

    musicState.playlist.push({
        name: songData.name,
        artist: songData.artist,
        src: playableResult.url,
        cover: songData.cover,
        isLocal: false,
        lrcContent: lrcContent
    });

    await saveGlobalPlaylist();
    updatePlaylistUI();

    if (musicState.currentIndex === -1) {
        musicState.currentIndex = musicState.playlist.length - 1;
        updatePlayerUI();
    }

    await showCustomAlert("Ê∑ªÂä†ÊàêÂäü", `„Ää${songData.name}„ÄãÂ∑≤ÊàêÂäüÊ∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®ÔºÅ`);
}

/**
 * „ÄêV3.0 | ËæÖÂä©„ÄëËé∑ÂèñÁΩëÁªúÊ≠åÊõ≤ÁöÑÊ≠åËØç
 */
async function getLyricsForSong(songId, source) {
    const url = source === 'netease'
        ? `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`
        : `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
    
    const response = await Http_Get(url);
    if (response?.data) {
        const lrc = response.data.lrc || response.data.lyric || "";
        const tlyric = response.data.trans || response.data.tlyric || "";
        return lrc + "\n" + tlyric;
    }
    return "";
}

/**
 * „ÄêV3.0 | ÂÖ®Êñ∞„ÄëËøôÊòØÊâãÂä®ÂØºÂÖ•Ê≠åËØçÁöÑ‰∏ìÂ±ûÂäüËÉΩÂáΩÊï∞
 */
async function handleManualLrcImport(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [
        { text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)', value: 'file' },
        { text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨', value: 'paste' }
    ]);

    let lrcContent = null;

    if (choice === 'file') {
        lrcContent = await new Promise(resolve => {
            const lrcInput = document.getElementById('lrc-upload-input');
            const lrcChangeHandler = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = readEvent => resolve(readEvent.target.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsText(file);
                } else { resolve(null); }
                lrcInput.removeEventListener('change', lrcChangeHandler);
                lrcInput.value = '';
            };
            lrcInput.addEventListener('change', lrcChangeHandler, { once: true });
            lrcInput.click();
        });
    } else if (choice === 'paste') {
        const pastedText = await showCustomPrompt('Á≤òË¥¥Ê≠åËØç', 'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...', '', 'textarea');
        if (pastedText) lrcContent = pastedText.replace(/\[/g, '\n[').trim();
    }
    
    if (lrcContent !== null) {
        musicState.playlist[trackIndex].lrcContent = lrcContent;
        await saveGlobalPlaylist();
        if (musicState.currentIndex === trackIndex) {
            musicState.parsedLyrics = parseLRC(lrcContent);
            renderLyrics();
            updateLyricsUI();
        }
        await showCustomAlert('ÊàêÂäü', `„Ää${musicState.playlist[trackIndex].name}„ÄãÁöÑÊ≠åËØçÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ`);
    }
}

/**
 * „ÄêÂÖ®Êñ∞„ÄëÊ∏ÖÁêÜÈü≥‰πêÊí≠ÊîæÂàóË°®‰∏≠ÁöÑÊâÄÊúâÊó†ÊïàÊàñÊó†Ê≥ïÊí≠ÊîæÁöÑÊ≠åÊõ≤ÈìæÊé•
 */
async function cleanupInvalidSongs() {
    if (musicState.playlist.length === 0) {
        alert("Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑÔºåÊó†ÈúÄÊ∏ÖÁêÜ„ÄÇ");
        return;
    }

    const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Ê∏ÖÁêÜÊó†ÊïàÊ≠åÊõ≤Ôºü',
        'Ê≠§Êìç‰ΩúÂ∞ÜÊ£ÄÊü•Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÊØè‰∏ÄÈ¶ñÁΩëÁªúÊ≠åÊõ≤ÔºåÂπ∂ÁßªÈô§ÊâÄÊúâÊó†Ê≥ïÊí≠ÊîæÁöÑ‚ÄúÊ≠ªÈìæ‚Äù„ÄÇÊú¨Âú∞Ê≠åÊõ≤‰∏ç‰ºöÂèóÂΩ±Âìç„ÄÇ',
        { confirmText: 'ÂºÄÂßãÊ∏ÖÁêÜ' }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê£ÄÊü• ${musicState.playlist.length} È¶ñÊ≠åÊõ≤ÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...`);

    const originalCount = musicState.playlist.length;
    const validPlaylist = [];
    const invalidSongs = [];

    const checkPromises = musicState.playlist.map(async (track) => {
        if (track.isLocal) {
            validPlaylist.push(track);
            return;
        }
        
        const isAvailable = await checkAudioAvailability(track.src);
        if (isAvailable) {
            validPlaylist.push(track);
        } else {
            invalidSongs.push(track.name);
            console.warn(`Êó†ÊïàÈìæÊé•: ${track.name} - ${track.src}`);
        }
    });

    await Promise.all(checkPromises);

    const removedCount = originalCount - validPlaylist.length;

    if (removedCount > 0) {
        const currentPlayingTrack = musicState.playlist[musicState.currentIndex];
        const isCurrentTrackRemoved = invalidSongs.includes(currentPlayingTrack?.name);

        musicState.playlist = validPlaylist;
        await saveGlobalPlaylist();

        if (isCurrentTrackRemoved) {
            audioPlayer.pause();
            audioPlayer.src = '';
            musicState.currentIndex = musicState.playlist.length > 0 ? 0 : -1;
            musicState.isPlaying = false;
        } else if (currentPlayingTrack) {
            musicState.currentIndex = musicState.playlist.findIndex(t => t.src === currentPlayingTrack.src);
        }

        updatePlaylistUI();
        updatePlayerUI();

        await showCustomAlert("Ê∏ÖÁêÜÂÆåÊàê", `ÊàêÂäüÁßªÈô§‰∫Ü ${removedCount} È¶ñÊó†ÊïàÊ≠åÊõ≤:\n\n- ${invalidSongs.join('\n- ')}`);
    } else {
        await showCustomAlert("Ê£ÄÊü•ÂÆåÊàê", "ÊâÄÊúâÊ≠åÊõ≤ÈìæÊé•ÂùáÊúâÊïàÔºåÊó†ÈúÄÊ∏ÖÁêÜÔºÅ");
    }
}

// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÂ∫îÁî®Áä∂ÊÄÅÊ†èÊòæÁ§∫/ÈöêËóèËÆæÁΩÆÁöÑÂáΩÊï∞ ‚ñº‚ñº‚ñº
/**
 * Ê†πÊçÆÂÖ®Â±ÄËÆæÁΩÆÔºåÂ∫îÁî®Áä∂ÊÄÅÊ†èÁöÑÂèØËßÅÊÄß
 */
function applyStatusBarVisibility() {
    const phoneScreen = document.getElementById('phone-screen');
    // Â¶ÇÊûúËÆæÁΩÆ‰∏∫ trueÔºåÂ∞±Ê∑ªÂä† classÔºõÂê¶ÂàôÂ∞±ÁßªÈô§ class„ÄÇ
    phoneScreen.classList.toggle('status-bar-visible', !!state.globalSettings.showStatusBar);
}
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

               // ===================================================================
                // 4. ÂàùÂßãÂåñÂáΩÊï∞ init()
                // ===================================================================
                async function init() {
    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜÂÜÖÈÉ®ÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºå‰ª•‰æøHTML‰∏≠ÁöÑ onclick ÂèØ‰ª•Ë∞ÉÁî®ÂÆÉ‰ª¨ ‚ñº‚ñº‚ñº
    window.showScreen = showScreen;
    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.handleListenTogetherClick = handleListenTogetherClick; // ‰∏∫‚Äú‰∏ÄËµ∑Âê¨‚ÄùÊåâÈíÆÊö¥Èú≤ÂáΩÊï∞
    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // Âú® init() ÂáΩÊï∞ÂºÄÂ§¥Ê∑ªÂä†
        const stickerActionBar = document.createElement('div');
        stickerActionBar.id = 'sticker-action-bar';
        stickerActionBar.innerHTML = '<button id="delete-selected-stickers-btn">Âà†Èô§ (0)</button>';
        document.getElementById('sticker-panel').appendChild(stickerActionBar);
                    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
                    const globalCssStyleTag = document.createElement('style');
                    globalCssStyleTag.id = 'global-custom-style';
                    document.head.appendChild(globalCssStyleTag);
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // Âú® init() ÂáΩÊï∞ÁöÑÂºÄÂ§¥
        qzoneStickerPanelState.panelEl = document.getElementById('qzone-sticker-panel');
        qzoneStickerPanelState.gridEl = document.getElementById('qzone-sticker-grid');
            // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ„ÄêÊúÄÂºÄÂ§¥„ÄëÔºåÁ≤òË¥¥‰∏ãÈù¢Ëøô‰∏§Ë°å‰ª£Á†Å ‚ñº‚ñº‚ñº
            const savedTheme = localStorage.getItem('ephone-theme') || 'light'; // ÈªòËÆ§‰∏∫Êó•Èó¥Ê®°Âºè
            applyTheme(savedTheme);
            // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // ‚ñº‚ñº‚ñº Êñ∞Â¢û‰ª£Á†Å ‚ñº‚ñº‚ñº
            const customBubbleStyleTag = document.createElement('style');
            customBubbleStyleTag.id = 'custom-bubble-style';
            document.head.appendChild(customBubbleStyleTag);
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // ‚ñº‚ñº‚ñº Êñ∞Â¢û‰ª£Á†Å ‚ñº‚ñº‚ñº
            const previewBubbleStyleTag = document.createElement('style');
            previewBubbleStyleTag.id = 'preview-bubble-style';
            document.head.appendChild(previewBubbleStyleTag);
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
            // ‚ñº‚ñº‚ñº ‰øÆÊîπËøô‰∏§Ë°å ‚ñº‚ñº‚ñº
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // Ê∏ÖÈô§ÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // Ê∏ÖÈô§È¢ÑËßàÂå∫ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                   window.openRenderingRulesScreen = openRenderingRulesScreen;
                    window.showScreen = showScreen;
                    window.renderChatListProxy = renderChatList;
                    window.renderApiSettingsProxy = renderApiSettings;
                    window.renderWallpaperScreenProxy = renderWallpaperScreen;
                    window.renderWorldBookScreenProxy = renderWorldBookScreen;
                    
                    // ÂàùÂßãÂåñÂõæÊ†áËÆæÁΩÆ
                    renderIconSettings();
                    
                    // ÂàùÂßãÂåñJSONÈÖçÁΩÆÂàóË°®
                    renderJsonConfigsList();
        
                    await loadAllDataFromDB();
                    applyStatusBarVisibility(); // <-- Êñ∞Â¢ûËøô‰∏ÄË°å
                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ„ÄëÂú®ËøôÈáåÊ∑ªÂä†‰∏ãÈù¢ËøôË°åÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
                    await migrateOldRedPacketData();
                    // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
                    applyGlobalCss(state.globalSettings.globalCss);
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // ÂàùÂßãÂåñÊú™ËØªÂä®ÊÄÅËÆ°Êï∞
                    const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
                    updateUnreadIndicator(storedCount);
                    
                    // ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÊ∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    if (state.globalSettings && state.globalSettings.fontUrl) {
                        applyCustomFont(state.globalSettings.fontUrl);
                    }
        
                    updateClock();
                    setInterval(updateClock, 1000 * 30);
                    applyGlobalWallpaper();
                    initBatteryManager(); 
        
        applyAppIcons();
        applyWidgetData(); // <-- Ê∑ªÂä†Ëøô‰∏ÄË°å
        
                    // ==========================================================
                    // --- ÂêÑÁßç‰∫ã‰ª∂ÁõëÂê¨Âô® ---
                    // ==========================================================
// ==========================================================
// --- „ÄêÂÖ®Êñ∞„ÄëNPC ÁÆ°ÁêÜÂäüËÉΩÊ†∏ÂøÉJS ---
// ==========================================================
let editingNpcId = null; // Áî®‰∫éÂ≠òÂÇ®Ê≠£Âú®ÁºñËæëÁöÑNPCÁöÑID

// Âú®ËÅäÂ§©ËÆæÁΩÆ‰∏≠ÁÇπÂáª‚ÄúÁÆ°ÁêÜNPC‚ÄùÊåâÈíÆ
document.getElementById('manage-npcs-btn').addEventListener('click', () => {
    const chat = state.chats[state.activeChatId];
    if (chat) {
        document.getElementById('npc-management-title').textContent = `‰∏∫‚Äú${chat.name}‚ÄùÁÆ°ÁêÜNPC`;
        renderNpcManagementList();
        showScreen('npc-management-screen');
    }
});

// ‰ªéNPCÁÆ°ÁêÜÁïåÈù¢ËøîÂõûÂà∞ËÅäÂ§©ËÆæÁΩÆ
document.getElementById('back-from-npc-management').addEventListener('click', () => {
    showScreen('chat-settings-screen');
});

// ÁÇπÂáª‚ÄúÂàõÂª∫Êñ∞NPC‚ÄùÊåâÈíÆ
document.getElementById('create-new-npc-btn').addEventListener('click', async () => {
    const name = await showCustomPrompt('ÂàõÂª∫Êñ∞NPC', 'ËØ∑ËæìÂÖ•NPCÁöÑÂêçÂ≠ó');
    if (!name || !name.trim()) return;

    const persona = await showCustomPrompt(`ËÆæÁΩÆ‰∫∫ËÆæ`, `ËØ∑ËæìÂÖ•‚Äú${name}‚ÄùÁöÑ‰∫∫ËÆæ`, '', 'textarea');
    if (persona === null) return;

    const newNpc = {
        id: 'npc_' + Date.now(),
        name: name.trim(),
        persona: persona,
        avatar: defaultGroupMemberAvatar // Â§çÁî®ÈªòËÆ§ÊàêÂëòÂ§¥ÂÉè
    };

    const chat = state.chats[state.activeChatId];
    if (!chat.npcs) chat.npcs = [];
    chat.npcs.push(newNpc);

    await db.chats.put(chat);
    renderNpcManagementList(); // Âà∑Êñ∞ÂàóË°®
});

// ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜNPCÂàóË°®ÁöÑÁÇπÂáª‰∫ã‰ª∂ÔºàÁºñËæë/Âà†Èô§Ôºâ
document.getElementById('npc-management-list').addEventListener('click', async (e) => {
    const target = e.target;
    const npcItem = target.closest('.member-management-item');
    if (!npcItem) return;

    const npcId = npcItem.dataset.npcId;
    
    if (target.classList.contains('remove-member-btn')) { // Âà†Èô§NPC
        const confirmed = await showCustomConfirm('Âà†Èô§NPC', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™NPCÂêóÔºü', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            const chat = state.chats[state.activeChatId];
            chat.npcs = chat.npcs.filter(npc => npc.id !== npcId);
            await db.chats.put(chat);
            renderNpcManagementList();
        }
    } else { // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüËßÜ‰∏∫ÁºñËæëNPC
        editingNpcId = npcId;
        const chat = state.chats[state.activeChatId];
        const npc = chat.npcs.find(n => n.id === npcId);
        if(npc) {
            // Â§çÁî®Áæ§ÊàêÂëòÁºñËæëÂºπÁ™óÊù•ÁºñËæëNPC
            document.getElementById('member-name-input').value = npc.name;
            document.getElementById('member-persona-input').value = npc.persona;
            document.getElementById('member-avatar-preview').src = npc.avatar;
            // ÈöêËóèÂ§¥ÂÉèÊ°ÜÊåâÈíÆÔºåÂõ†‰∏∫NPCÊ≤°ÊúâÂ§¥ÂÉèÊ°Ü
            document.querySelector('#member-settings-modal .change-frame-btn').style.display = 'none';
            document.getElementById('member-settings-modal').classList.add('visible');
        }
    }
});

// ‰øÆÊîπ‚Äú‰øùÂ≠òÊàêÂëòËÆæÁΩÆ‚ÄùÊåâÈíÆÁöÑÈÄªËæëÔºå‰ΩøÂÖ∂‰πüËÉΩ‰øùÂ≠òNPC
document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
    // Â¶ÇÊûúÂΩìÂâçÊòØÂú®ÁºñËæëNPC...
    if (editingNpcId) {
        const chat = state.chats[state.activeChatId];
        const npc = chat.npcs.find(n => n.id === editingNpcId);
        if (npc) {
            npc.name = document.getElementById('member-name-input').value;
            npc.persona = document.getElementById('member-persona-input').value;
            npc.avatar = document.getElementById('member-avatar-preview').src;
            
            await db.chats.put(chat);
            renderNpcManagementList(); // Âà∑Êñ∞NPCÂàóË°®
        }
        document.getElementById('member-settings-modal').classList.remove('visible');
        editingNpcId = null; // ÈáçÁΩÆÁä∂ÊÄÅ
    } 
    // Âê¶ÂàôÔºåÊâßË°åÂéüÊù•ÁöÑ‰øùÂ≠òÁæ§ÊàêÂëòÈÄªËæë... (ËøôÈÉ®ÂàÜ‰ª£Á†Å‰Ω†Â∑≤ÁªèÊúâ‰∫Ü)
    else if (editingMemberId) {
        // ... ‰Ω†ÂéüÊù•ÁöÑ‰øùÂ≠òÁæ§ÊàêÂëòÁöÑ‰ª£Á†Å ...
    }
});

// Ê∏≤ÊüìNPCÂàóË°®ÁöÑÂáΩÊï∞
function renderNpcManagementList() {
    const listEl = document.getElementById('npc-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';
    if (!chat.npcs || chat.npcs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïNPC„ÄÇ</p>';
        return;
    }

    chat.npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        item.dataset.npcId = npc.id; // ÂÖ≥ÈîÆÔºöÁî®dataÂ±ûÊÄßÂ≠òÂÇ®ID
        item.innerHTML = `
            <img src="${npc.avatar}" class="avatar">
            <span class="name">${npc.name}</span>
            <button class="remove-member-btn" title="Âà†Èô§NPC">-</button>
        `;
        listEl.appendChild(item);
    });
}
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÊ∑ªÂä†ËøôË°åÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('rules-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('rules-tab')) {
                switchRuleCategory(e.target.dataset.categoryId);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥ËøôÊÆµÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
        // Ê∏≤ÊüìËßÑÂàôÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö
        document.getElementById('add-new-rule-btn').addEventListener('click', () => openRuleEditor(null));
        document.getElementById('cancel-rule-editor-btn').addEventListener('click', () => {
            document.getElementById('rule-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-rule-btn').addEventListener('click', saveRenderingRule);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫ÂçïËÅä‚ÄúÊãç‰∏ÄÊãç‚ÄùÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('pat-btn').addEventListener('click', () => {
            // Á°Æ‰øùÂΩìÂâçÂú®ÂçïËÅä‰∏≠
            if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
                const chat = state.chats[state.activeChatId];
                // Ë∞ÉÁî®Áé∞ÊúâÁöÑÊãç‰∏ÄÊãçÂáΩÊï∞ÔºåÂπ∂‰º†ÂÖ•Ê≠£Á°ÆÁöÑÂèÇÊï∞
                handleUserPat(chat.id, chat.originalName);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊÇ®Áº∫Â§±ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Á≤òË¥¥Âú®ËøôÈáå„Äë ‚ñº‚ñº‚ñº
        let activeAnnouncementId = null; // Áî®‰∫éÊöÇÂ≠òÊ≠£Âú®Êìç‰ΩúÁöÑÂÖ¨ÂëäID
        
        /**
         * ÁÇπÂáª‚Äú...‚ÄùÊó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçïÔºàÁΩÆÈ°∂/Âà†Èô§Ôºâ
         * @param {string} annoId - ÂÖ¨ÂëäÁöÑÂîØ‰∏ÄID
         */
        function showAnnouncementActions(annoId) {
            activeAnnouncementId = annoId;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === annoId);
            if (!announcement) return;
        
            const pinButton = document.getElementById('announcement-action-pin');
            // Ê†πÊçÆÂΩìÂâçÊòØÂê¶Â∑≤ÁΩÆÈ°∂ÔºåÂä®ÊÄÅÊîπÂèòÊåâÈíÆÊñáÂ≠ó
            pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';
        
            document.getElementById('announcement-actions-modal').classList.add('visible');
        }
        
        /**
         * Â§ÑÁêÜ‚ÄúÁΩÆÈ°∂/ÂèñÊ∂àÁΩÆÈ°∂‚ÄùÊìç‰Ωú
         */
        async function handlePinAnnouncement() {
            if (!activeAnnouncementId) return;
            const chat = state.chats[state.activeChatId];
            const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
            if (announcement) {
                announcement.isPinned = !announcement.isPinned; // ÂàáÊç¢ÁΩÆÈ°∂Áä∂ÊÄÅ
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤ÊüìÂÖ¨ÂëäÊùø‰ª•Êõ¥Êñ∞UI
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        
        /**
         * Â§ÑÁêÜ‚ÄúÂà†Èô§ÂÖ¨Âëä‚ÄùÊìç‰Ωú
         */
        async function handleDeleteAnnouncement() {
            if (!activeAnnouncementId) return;
        
            const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", { confirmButtonClass: 'btn-danger' });
        
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                // ‰ªéÂÖ¨ÂëäÊï∞ÁªÑ‰∏≠ËøáÊª§ÊéâË¶ÅÂà†Èô§ÁöÑÂÖ¨Âëä
                chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
                await db.chats.put(chat);
                showAnnouncementBoard(); // ÈáçÊñ∞Ê∏≤Êüì
            }
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                    document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
                    document.getElementById('export-data-btn').addEventListener('click', exportBackup);
// ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥‰∏ãÈù¢ÁöÑÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
document.getElementById('cleanup-data-btn').addEventListener('click', cleanupRedundantData);
// ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
                    document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
                    document.getElementById('import-card-input').addEventListener('change', handleCardImport);
                    document.getElementById('back-to-list-btn').addEventListener('click', () => { 

            // ‚ñº‚ñº‚ñº ‰øÆÊîπËøô‰∏§Ë°å ‚ñº‚ñº‚ñº
            applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // Ê∏ÖÈô§ÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
            applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // Ê∏ÖÈô§È¢ÑËßàÂå∫ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
            // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
                    
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ add-chat-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('add-chat-btn').addEventListener('click', async () => {
            // ‰ΩøÁî®Êàë‰ª¨Áé∞ÊúâÁöÑ showChoiceModal ÂáΩÊï∞Êù•Êèê‰æõÈÄâÈ°π
            const choice = await showChoiceModal('ÂàõÂª∫Êñ∞ËÅäÂ§©', [
                { text: 'ÊâãÂä®ÂàõÂª∫ËßíËâ≤', value: 'manual' },
                { text: '‰ªéËßíËâ≤Âç°ÂØºÂÖ• (.json/.png)', value: 'import_card' }
            ]);
        
            if (choice === 'manual') {
                // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©ÊâãÂä®ÔºåÂàôÊâßË°åÂéüÊù•ÁöÑÈÄªËæë
                const remarkName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨1/2Ê≠•)', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‰∏∫TaËÆæÁΩÆÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë(‰æãÂ¶Ç: Âì•Âì•)');
                if (!remarkName || !remarkName.trim()) return;
        
                const originalName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨2/2Ê≠•)', 'ËØ∑ËæìÂÖ•TaÁöÑ„ÄêÊú¨Âêç„Äë(‰æãÂ¶Ç: ÊùéÊòüËæ∞ÔºåËøô‰∏™ÂêçÂ≠óÂ∞ÜÁî®‰∫éAIËØÜÂà´)');
                if (!originalName || !originalName.trim()) return;
        
                const newChatId = 'chat_' + Date.now();
                const newChat = {
                    id: newChatId,
                    name: remarkName.trim(),
                    originalName: originalName.trim(),
                    isGroup: false,
                    relationship: { status: 'friend', blockedTimestamp: null, applicationReason: '' },
                    status: { text: 'Âú®Á∫ø', lastUpdate: Date.now(), isBusy: false },
                    settings: {
                        aiPersona: 'ËøôÊòØ‰∏Ä‰∏™ÈÄöËøáÊâãÂä®ÂàõÂª∫ÁöÑËßíËâ≤„ÄÇ', myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ', maxMemory: 10,
                        aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '',
                        theme: 'default', fontSize: 13, customCss: '',
                        linkedWorldBookIds: [], aiAvatarLibrary: []
                    },
                    history: [], musicData: { totalTime: 0 },
    longTermMemory: [], // <--- Âú®ËøôÈáåÊ∑ªÂä†Ëøô‰∏ÄË°å
    npcs: [] // <-- „ÄêÊñ∞Â¢û„Äë‰∏Ä‰∏™Á©∫ÁöÑNPCÊï∞ÁªÑ
                };
                state.chats[newChatId] = newChat;
                await db.chats.put(newChat);
                renderChatList();
                
            } else if (choice === 'import_card') {
                // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©ÂØºÂÖ•ÔºåÂ∞±Ëß¶ÂèëÊàë‰ª¨Êñ∞Ê∑ªÂä†ÁöÑÈöêËóèÊñá‰ª∂ËæìÂÖ•Ê°Ü
                document.getElementById('import-card-input').click();
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£„ÄëÂàõÂª∫Áæ§ËÅäÊåâÈíÆÁé∞Âú®ÊâìÂºÄËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô® ‚ñº‚ñº‚ñº
        document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤                      
                    document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
                    document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
        
                    document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
                    document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
                    document.getElementById('music-return-btn').addEventListener('click', returnToChat);
                    document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
                    document.getElementById('music-next-btn').addEventListener('click', playNext);
                    document.getElementById('music-prev-btn').addEventListener('click', playPrev);
                    document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
                    document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
                    document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
                    document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
                    document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
                    document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
                    document.getElementById('import-netease-playlist-btn').addEventListener('click', importNeteasePlaylist);
                    document.getElementById('view-import-history-btn').addEventListener('click', viewImportHistory);
                    document.getElementById('fix-unplayable-songs-btn').addEventListener('click', fixUnplayableSongs);
                    
                    // ÊµãËØïURLËß£ÊûêÂäüËÉΩ
                    testUrlParsing();
                    audioPlayer.addEventListener('ended', () => {
    // Ê≠åÊõ≤Êí≠ÊîæÁªìÊùüÊó∂ÔºåÁßªÈô§ÊóãËΩ¨Ê†∑Âºè
    document.getElementById('vinyl-view').classList.remove('spinning');
    playNext(); 
});

audioPlayer.addEventListener('pause', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = false; 
        updatePlayerUI(); 
        // Èü≥‰πêÊöÇÂÅúÊó∂ÔºåÁßªÈô§ÊóãËΩ¨Ê†∑Âºè
        document.getElementById('vinyl-view').classList.remove('spinning');
    } 
});

audioPlayer.addEventListener('play', () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
        // Èü≥‰πêÂºÄÂßãÊí≠ÊîæÊó∂ÔºåÊ∑ªÂä†ÊóãËΩ¨Ê†∑Âºè
        document.getElementById('vinyl-view').classList.add('spinning');
    } 
});
        
                    const chatInput = document.getElementById('chat-input');
                    // ‚ñº‚ñº‚ñº ÊâæÂà∞ id="send-btn" ÁöÑ click ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // ‚ñº‚ñº‚ñº Áî®ËøôÊÆµ„ÄêÂ∑≤ÈõÜÊàêÂºïÁî®ÂäüËÉΩ„ÄëÁöÑ‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ 'send-btn' ÁÇπÂáª‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('send-btn').addEventListener('click', async () => { 
            const content = chatInput.value.trim(); 
            if (!content || !state.activeChatId) return; 

            // ‚ñ≤‚ñ≤‚ñ≤ Á°ÆËÆ§ÁªìÊùü ‚ñ≤‚ñ≤
            const chat = state.chats[state.activeChatId]; 
        
            const msg = { 
                role: 'user', 
                content, 
                timestamp: Date.now() 
            };
        
            // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Â§Ñ‰∫éÂºïÁî®ÂõûÂ§çÊ®°Âºè
            if (currentReplyContext) {
                msg.quote = currentReplyContext; // Â∞ÜÂºïÁî®‰ø°ÊÅØÈôÑÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏ä
            }
        
            chat.history.push(msg); 
            await db.chats.put(chat); 
            appendMessage(msg, chat); 
            renderChatList(); 
            chatInput.value = ''; 
            chatInput.style.height = 'auto'; 
            chatInput.focus(); 
        
            // ÂèëÈÄÅÂêéÔºåÂèñÊ∂àÂºïÁî®Ê®°Âºèdocument.getElementById('reset-global-css-btn').addEventListener('click', () => {
            cancelReplyMode(); 
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
                    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
                    //chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
        
                    document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
                    // ‚ñº‚ñº‚ñº Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ save-wallpaper-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
            let changesMade = false;
        
            // ‰øùÂ≠òÂ£ÅÁ∫∏
            if (newWallpaperBase64) {
                state.globalSettings.wallpaper = newWallpaperBase64;
                changesMade = true;
            }
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
            state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
    state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
          state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked; // <-- Êñ∞Â¢ûËøô‰∏ÄË°å        
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰øùÂ≠òÂõæÊ†áËÆæÁΩÆÔºàÂÆÉÂ∑≤ÁªèÂú®ÂÜÖÂ≠ò‰∏≠‰∫ÜÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅÊääÊï¥‰∏™globalSettingsÂ≠òËµ∑Êù•Ôºâ
            await db.globalSettings.put(state.globalSettings);
            // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÁ≤òË¥¥Âè¶‰∏ÄË°åÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
            applyGlobalCss(state.globalSettings.globalCss);
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
            // Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ
            if (changesMade) {
                applyGlobalWallpaper();
                newWallpaperBase64 = null;
            }
            applyAppIcons(); // ÈáçÊñ∞Â∫îÁî®ÊâÄÊúâÂõæÊ†á
        
            alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
        
            showScreen('home-screen');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ save-api-settings-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
            // ‰øùÂ≠ò‰∏ªAPI
            state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
            state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
            state.apiConfig.model = document.getElementById('model-select').value;
            
            // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰øùÂ≠òÂâØAPI
            state.apiConfig.secondaryProxyUrl = document.getElementById('secondary-proxy-url').value.trim();
            state.apiConfig.secondaryApiKey = document.getElementById('secondary-api-key').value.trim();
            state.apiConfig.secondaryModel = document.getElementById('secondary-model-select').value;
            
            await db.apiConfig.put(state.apiConfig);
        
            // ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆÁöÑ‰øùÂ≠òÈÄªËæë‰øùÊåÅ‰∏çÂèò
            const backgroundSwitch = document.getElementById('background-activity-switch');
            const intervalInput = document.getElementById('background-interval-input');
            const cooldownInput = document.getElementById('block-cooldown-input');
        
            state.globalSettings.enableBackgroundActivity = backgroundSwitch.checked;
            state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
            state.globalSettings.blockCooldownHours = parseFloat(cooldownInput.value) || 1;
        
            await db.globalSettings.put(state.globalSettings);
        
            stopBackgroundSimulation(); 
            if (state.globalSettings.enableBackgroundActivity) {
                startBackgroundSimulation();
                console.log(`ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂêØÂä®ÔºåÈó¥Èöî: ${state.globalSettings.backgroundActivityInterval}Áßí`);
            } else {
                console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂÅúÊ≠¢„ÄÇ");
            }
            
            alert('ÊâÄÊúâAPI‰∏éÂêéÂè∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò!'); 
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥ËøôÊï¥ÂùóÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº

// --- ÂÖ®Êñ∞ËßÜÈ¢ëÈÄöËØùÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö (V2 ‰øÆÊ≠£Áâà) ---

// ÁªëÂÆöÊñ∞ÁïåÈù¢ÁöÑÊåÇÊñ≠ÊåâÈíÆ
document.getElementById('hang-up-btn-visual').addEventListener('click', endVideoCall);

// „ÄêÊñ∞Â¢û„ÄëÁªëÂÆöÊñ∞ÁïåÈù¢ÁöÑÂèëË®ÄÊåâÈíÆ
document.getElementById('user-speak-btn-visual').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;
    const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');
    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});

// ÁªëÂÆöÂàáÊç¢ÈïúÂ§¥ÊåâÈíÆ (‰πüÊòØÂ∞èÁ™óÊú¨Ë∫´)
document.getElementById('switch-camera-btn').addEventListener('click', switchVideoViews);
document.getElementById('video-pip-view').addEventListener('click', switchVideoViews);

// „Äê‰øÆÊ≠£„ÄëÁªëÂÆö‰∏§‰∏™ÁïåÈù¢ÁöÑÈáçrollÊåâÈíÆ
document.getElementById('reroll-call-btn').addEventListener('click', handleVideoCallReroll);
document.getElementById('reroll-call-btn-text').addEventListener('click', handleVideoCallReroll);

// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                            // gemini ÂØÜÈí•ËÅöÁÑ¶ÁöÑÊó∂ÂÄôÊòæÁ§∫ÊòéÊñá
                const ApiKeyInput = document.getElementById('api-key')
                ApiKeyInput.addEventListener('focus', (e) => {
                    e.target.setAttribute('type', 'text')
                })
                ApiKeyInput.addEventListener('blur', (e) => {
                    e.target.setAttribute('type', 'password')
                })
        
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ fetch-models-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        // Â∞ÅË£Ö‰∏Ä‰∏™ÂèØÂ§çÁî®ÁöÑÊ®°ÂûãÊãâÂèñÂáΩÊï∞
        async function fetchModels(urlInputId, keyInputId, selectId) {
            const url = document.getElementById(urlInputId).value.trim();
            const key = document.getElementById(keyInputId).value.trim();
            if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂØπÂ∫îÁöÑÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•');
            
            try {
                let isGemini = url === GEMINI_API_URL;
                const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`, isGemini ? undefined : { headers: { 'Authorization': `Bearer ${key}` } });
                if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®');
                const data = await response.json();
                let models = isGemini ? data.models.map(model => ({ id: model.name.split('/')[1] || model.name })) : data.data;
                
                const modelSelect = document.getElementById(selectId);
                modelSelect.innerHTML = '';
                // „ÄêÊ†∏ÂøÉ„ÄëÊ†πÊçÆÊòØ‰∏ª/ÂâØÊ®°ÂûãÔºåËØªÂèñÊ≠£Á°ÆÁöÑÂ∑≤‰øùÂ≠òÊ®°Âûã
                const savedModel = selectId === 'model-select' ? state.apiConfig.model : state.apiConfig.secondaryModel;
        
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    if (model.id === savedModel) option.selected = true;
                    modelSelect.appendChild(option);
                });
                alert('Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞');
            } catch (error) {
                alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
            }
        }
        
        // ÁªëÂÆö‰∏ªÊ®°ÂûãÊãâÂèñÊåâÈíÆ
        document.getElementById('fetch-models-btn').addEventListener('click', () => {
            fetchModels('proxy-url', 'api-key', 'model-select');
        });
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÁªëÂÆöÂâØÊ®°ÂûãÊãâÂèñÊåâÈíÆ
        document.getElementById('fetch-secondary-models-btn').addEventListener('click', () => {
            fetchModels('secondary-proxy-url', 'secondary-api-key', 'secondary-model-select');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ save-world-book-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('save-world-book-btn').addEventListener('click', async () => {
            if (!editingWorldBookId) return;
            const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
            if (!book) return;
        
            // ‰øùÂ≠ò‰π¶ÂêçÂíåÂàÜÁ±ªÔºàÈÄªËæë‰∏çÂèòÔºâ
            const newName = document.getElementById('world-book-name-input').value.trim();
            if (!newName) { alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); return; }
            book.name = newName;
            const categoryId = document.getElementById('world-book-category-select').value;
            book.categoryId = categoryId ? parseInt(categoryId) : null;
        
            const entriesContainer = document.getElementById('world-book-entries-container');
            const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
            const newEntries = [];
        
            entryBlocks.forEach(block => {
                const keysInput = block.querySelector('.entry-keys-input').value.trim();
                const content = block.querySelector('.entry-content-textarea').value.trim();
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëËé∑ÂèñÂºÄÂÖ≥ÁöÑÁä∂ÊÄÅ
                const isEnabled = block.querySelector('.entry-enabled-switch').checked;

                if (content) {
                    newEntries.push({
                        comment: block.querySelector('.entry-comment-input').value.trim(),
                        keys: keysInput ? keysInput.split(',').map(k => k.trim()).filter(k => k) : [],
                        content: content,
                        enabled: isEnabled // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰øùÂ≠òÂºÄÂÖ≥Áä∂ÊÄÅ
                    });
                }
            });
        
            book.content = newEntries;
        
            await db.worldBooks.put(book);
            document.getElementById('world-book-editor-title').textContent = newName;
            editingWorldBookId = null;
            renderWorldBookScreen();
            showScreen('world-book-screen');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ chat-messages ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('chat-messages').addEventListener('click', async (e) => {
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫Ü "Êü•ÁúãËØ¶ÊÉÖ" ÊåâÈíÆ
            const detailsBtn = e.target.closest('.waimai-details-btn');
            if (detailsBtn) {
                const bubble = detailsBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        showWaimaiDetails(timestamp); // Ë∞ÉÁî®Êàë‰ª¨Êñ∞Âä†ÁöÑÂáΩÊï∞
                        return; // Â§ÑÁêÜÂÆåÂêéÁõ¥Êé•ÈÄÄÂá∫
                    }
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫Ü "‰∏∫Ta‰π∞Âçï" Êàñ "ÊÆãÂøçÊãíÁªù" ÊåâÈíÆ
            const choiceBtn = e.target.closest('.waimai-user-actions button');
            if (choiceBtn) {
                const bubble = choiceBtn.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    const choice = choiceBtn.dataset.choice;
                    if (!isNaN(timestamp) && choice) {
                        await handleWaimaiResponse(timestamp, choice);
                        return;
                    }
                }
            }
        
            // --- ‰ª•‰∏ãÊòØÊÇ®ÂéüÊù•Â∑≤ÊúâÁöÑÊâÄÊúâÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂ÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò ---
            const deletedPostPlaceholder = e.target.closest('.post-deleted-placeholder');
            if (deletedPostPlaceholder) {
                const postId = parseInt(deletedPostPlaceholder.dataset.postId);
                if (!isNaN(postId)) {
                    const post = await db.qzonePosts.get(postId);
                    if (post) {
                        let originalContent = '';
                        const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'Êú™Áü•‰ΩúËÄÖ');
                        
                        if(post.type === 'shuoshuo'){
                            originalContent = post.content;
                        } else {
                            originalContent = post.publicText || '';
                            if(post.imageUrl) originalContent += `\n[ÂõæÁâá]`;
                            if(post.hiddenContent) originalContent += `\n[ÊñáÂ≠óÂõæÂÜÖÂÆπ: ${post.hiddenContent}]`;
                        }
                        
                        showCustomAlert(
                            `Êù•Ëá™ ${authorName} ÁöÑÂ∑≤Âà†Èô§Âä®ÊÄÅ`, 
                            originalContent.replace(/\n/g, '<br>')
                        );
                    } else {
                        showCustomAlert('ÊèêÁ§∫', 'ËøôÊù°Âä®ÊÄÅÁöÑÂéüÂßãÊï∞ÊçÆÂ∑≤Ë¢´ÂΩªÂ∫ïÊ∏ÖÈô§„ÄÇ');
                    }
                }
                return;
            }
        
            const aiImage = e.target.closest('.ai-generated-image');
            if (aiImage) {
                const description = aiImage.dataset.description;
                if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description);
                return;
            }
        
            const quoteBlock = e.target.closest('.quoted-message');
            if (quoteBlock && quoteBlock.dataset.originalTimestamp) {
                const originalTimestamp = parseInt(quoteBlock.dataset.originalTimestamp);
                if (!isNaN(originalTimestamp)) {
                    scrollToOriginalMessage(originalTimestamp);
                }
            }
            
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        
            const packetCard = e.target.closest('.red-packet-card');
            if (packetCard) {
                const messageBubble = packetCard.closest('.message-bubble');
                if (messageBubble && messageBubble.dataset.timestamp) {
                    const timestamp = parseInt(messageBubble.dataset.timestamp);
                    handlePacketClick(timestamp);
                }
            }
            
            const pollCard = e.target.closest('.poll-card');
            if (pollCard) {
                const timestamp = parseInt(pollCard.dataset.pollTimestamp);
                if (isNaN(timestamp)) return;
                
                const optionItem = e.target.closest('.poll-option-item');
                if (optionItem && !pollCard.classList.contains('closed')) {
                    handleUserVote(timestamp, optionItem.dataset.option);
                    return;
                }
                
                const actionBtn = e.target.closest('.poll-action-btn');
                if (actionBtn) {
                    if (pollCard.classList.contains('closed')) {
                        showPollResults(timestamp);
                    } else {
                        endPoll(timestamp);
                    }
                    return;
                }
        
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                }
            }
        
            const voiceBody = e.target.closest('.voice-message-body');
            if (voiceBody) {
                const bubble = voiceBody.closest('.message-bubble');
                if (!bubble) return;
                
                const spinner = voiceBody.querySelector('.loading-spinner');
                const transcriptEl = bubble.querySelector('.voice-transcript');
        
                if (bubble.dataset.state === 'loading') {
                    return;
                }
        
                if (bubble.dataset.state === 'expanded') {
                    transcriptEl.style.display = 'none';
                    bubble.dataset.state = 'collapsed';
                } 
                else {
                    bubble.dataset.state = 'loading';
                    spinner.style.display = 'block';
        
                    setTimeout(() => {
                        if (document.body.contains(bubble)) {
                            const voiceText = bubble.dataset.voiceText || '(Êó†Ê≥ïËØÜÂà´)';
                            transcriptEl.textContent = voiceText;
                            
                            spinner.style.display = 'none';
                            transcriptEl.style.display = 'block';
                            bubble.dataset.state = 'expanded';
                        }
                    }, 1500);
                }
            }
        
            const placeholder = e.target.closest('.recalled-message-placeholder');
            if (placeholder) {
                const chat = state.chats[state.activeChatId];
                const wrapper = placeholder.closest('.message-wrapper');
                if (chat && wrapper) {
                    const timestamp = parseInt(wrapper.dataset.timestamp);
                    const recalledMsg = chat.history.find(m => m.timestamp === timestamp);
                    
                    if (recalledMsg && recalledMsg.recalledData) {
                        let originalContentText = '';
                        const recalled = recalledMsg.recalledData;
                        
                        if (recalled.originalType === 'text') {
                            originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                        } else {
                            originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ`;
                        }
                        showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
                    }
                }
            }
        
            const linkCard = e.target.closest('.link-share-card');
            if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(linkCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        
            const bubble = e.target.closest('.message-bubble');
            if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    
                    const chatSettingsModal = document.getElementById('chat-settings-modal');
                    const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
                    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ updateWorldBookSelectionDisplay ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function updateWorldBookSelectionDisplay() {
            const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked');
            const displayText = document.querySelector('.selected-options-text');
            
            if (checkedBoxes.length === 0) {
                displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --';
            } else if (checkedBoxes.length > 2) {
                displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} Êú¨‰∏ñÁïå‰π¶`;
            } else {
                const displayItems = Array.from(checkedBoxes).map(cb => {
                    return cb.parentElement.textContent.trim();
                });
                displayText.textContent = displayItems.join(', ');
            }
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤   
                    
                    worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
                    document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
                    window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™ V3.0 ÊúÄÁªà‰øÆÂ§çÁâà„ÄëÊõøÊç¢ÊóßÁöÑ chat-settings-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('chat-settings-btn').addEventListener('click', async () => {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            const isGroup = chat.isGroup;
        
            // --- ÔºàËøôÈÉ®ÂàÜ‰∏é‰πãÂâçÁõ∏ÂêåÔºå‰øùÊåÅ‰∏çÂèòÔºâ ---
            const switchGreetingGroup = document.getElementById('switch-greeting-group');
            if (!isGroup && chat.settings.alternateGreetings && chat.settings.alternateGreetings.length > 0) {
                switchGreetingGroup.style.display = 'block';
            } else {
                switchGreetingGroup.style.display = 'none';
            }
            
            document.getElementById('chat-name-group').style.display = 'block';
            document.getElementById('my-persona-group').style.display = 'block';
            document.getElementById('my-avatar-group').style.display = 'block';
            document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('my-nickname-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-original-name-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('offline-mode-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('ai-cooldown-group').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-cooldown-group').style.display = isGroup ? 'block' : 'none';
            document.getElementById('chat-name-input').value = chat.name;
            document.getElementById('my-persona').value = chat.settings.myPersona;
            document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
            document.getElementById('max-memory').value = chat.settings.maxMemory;
            const bgPreview = document.getElementById('bg-preview');
            const removeBgBtn = document.getElementById('remove-bg-btn');
            if (chat.settings.background) {
                bgPreview.src = chat.settings.background;
                bgPreview.style.display = 'block';
                removeBgBtn.style.display = 'inline-block';
            } else {
                bgPreview.style.display = 'none';
                removeBgBtn.style.display = 'none';
            }
            document.getElementById('lyrics-position-group').style.display = isGroup ? 'none' : 'block';
            if (isGroup) {
                document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
                document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
                document.getElementById('group-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
                renderGroupMemberSettings(chat.members);
            } else {
                const offlineModeToggle = document.getElementById('offline-mode-toggle');
                const offlineModeOptions = document.getElementById('offline-mode-options');
                const offlineMinInput = document.getElementById('offline-min-length-input');
                const offlineMaxInput = document.getElementById('offline-max-length-input');
                offlineModeToggle.checked = chat.settings.isOfflineMode || false;
                offlineModeOptions.style.display = offlineModeToggle.checked ? 'block' : 'none';
                offlineMinInput.value = chat.settings.offlineMinLength || 100;
                offlineMaxInput.value = chat.settings.offlineMaxLength || 300;
                document.getElementById('ai-original-name-input').value = chat.originalName;
                document.getElementById('ai-persona').value = chat.settings.aiPersona;
                document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
                document.getElementById('my-nickname-input').value = chat.settings.myNickname || 'Êàë';
                document.getElementById('ai-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
                const select = document.getElementById('assign-group-select');
                select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>';
                const groups = await db.qzoneGroups.toArray();
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    if (chat.groupId === group.id) option.selected = true;
                    select.appendChild(option);
                });
                const lyricsPos = chat.settings.lyricsPosition || { vertical: 'top', horizontal: 'center', offset: 10 };
                document.getElementById('lyrics-vertical-pos').value = lyricsPos.vertical;
                document.getElementById('lyrics-horizontal-pos').value = lyricsPos.horizontal;
                document.getElementById('lyrics-offset-input').value = lyricsPos.offset;
                // ‚ñº‚ñº‚ñº Âú® chat-settings-btn ÁöÑ click ‰∫ã‰ª∂ÁöÑ else ‰ª£Á†ÅÂùóÊú´Â∞æÁ≤òË¥¥ ‚ñº‚ñº‚ñº

// Âä†ËΩΩËßÜÈ¢ëÈÄöËØùËÆæÁΩÆ
const videoCallSettingsGroup = document.getElementById('video-call-settings-group');
const visualCallSwitch = document.getElementById('visual-video-call-switch');
const imageUploadsDiv = document.getElementById('video-call-image-uploads');

if (isGroup) {
    videoCallSettingsGroup.style.display = 'none'; // Áæ§ËÅä‰∏çÊîØÊåÅÔºåÈöêËóèÊï¥‰∏™ËÆæÁΩÆÂå∫
} else {
    videoCallSettingsGroup.style.display = 'block'; // ÂçïËÅäÊòæÁ§∫
    
    // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
    visualCallSwitch.checked = chat.settings.visualVideoCallEnabled || false;
    imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    document.getElementById('char-video-image-preview').src = chat.settings.charVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
    document.getElementById('user-video-image-preview').src = chat.settings.userVideoImage || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';

    // ‰∏∫ÂºÄÂÖ≥Ê∑ªÂä†ÂÆûÊó∂‰∫§‰∫í
    visualCallSwitch.onchange = () => {
        imageUploadsDiv.style.display = visualCallSwitch.checked ? 'block' : 'none';
    };
}
// ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            }
            
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç‰ªéËøôÈáåÂºÄÂßã„Äë„Äë„Äë ---
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            worldBookCheckboxesContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÂàóË°®
        
            const [allCategories, allBooks] = await Promise.all([
                db.worldBookCategories.toArray(),
                db.worldBooks.toArray()
            ]);
        
            const linkedBookIds = new Set(chat.settings.linkedWorldBookIds || []);
        
            if (allBooks.length === 0) {
                worldBookCheckboxesContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰Ωï‰∏ñÁïå‰π¶</p>';
            } else {
                // 1. ÂÖàÊåâÂàÜÁ±ªÊ∏≤Êüì‰π¶Á±ç
                allCategories.forEach(cat => {
                    const booksInCategory = allBooks.filter(book => book.categoryId === cat.id);
                    if (booksInCategory.length > 0) {
                        const categoryHeader = document.createElement('h4');
                        categoryHeader.textContent = cat.name; // ÂàÜÁ±ªÂêç‰Ωú‰∏∫Ê†áÈ¢ò
                        categoryHeader.style.cssText = 'margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                        worldBookCheckboxesContainer.appendChild(categoryHeader);
        
                        booksInCategory.forEach(book => {
                            const isChecked = linkedBookIds.has(book.id);
                            const label = document.createElement('label');
                            // Áªü‰∏Ä‰ΩøÁî® book_ ÂâçÁºÄ
                            label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                            worldBookCheckboxesContainer.appendChild(label);
                        });
                    }
                });
        
                // 2. Ê∏≤ÊüìÊú™ÂàÜÁ±ªÁöÑ‰π¶Á±ç
                const uncategorizedBooks = allBooks.filter(book => !book.categoryId);
                if (uncategorizedBooks.length > 0) {
                    const bookHeader = document.createElement('h4');
                    bookHeader.textContent = 'Êú™ÂàÜÁ±ª';
                    bookHeader.style.cssText = 'margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
                    worldBookCheckboxesContainer.appendChild(bookHeader);
        
                    uncategorizedBooks.forEach(book => {
                        const isChecked = linkedBookIds.has(book.id);
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                        worldBookCheckboxesContainer.appendChild(label);
                    });
                }
            }
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂà∞ËøôÈáåÁªìÊùü„Äë„Äë„Äë ---
        
            updateWorldBookSelectionDisplay();

            const linkMemoryToggle = document.getElementById('link-memory-toggle'); const linkedMemorySelection = document.getElementById('linked-memory-selection'); const linkedChatsContainer = document.getElementById('linked-chats-checkboxes-container'); const linkedMemoryIds = chat.settings.linkedMemoryChatIds || []; linkMemoryToggle.checked = linkedMemoryIds.length > 0; linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; linkedChatsContainer.innerHTML = ''; Object.values(state.chats).forEach(c => { if (c.id === chat.id) return; const isChecked = linkedMemoryIds.includes(c.id); const prefix = c.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]'; const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> ${prefix} ${c.name}`; linkedChatsContainer.appendChild(label); }); function updateLinkedMemorySelectionDisplay() { const checkedBoxes = linkedChatsContainer.querySelectorAll('input:checked'); const displayText = linkedMemorySelection.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } } updateLinkedMemorySelectionDisplay(); linkMemoryToggle.addEventListener('change', () => { linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none'; }); const linkedMemorySelectBox = linkedMemorySelection.querySelector('.select-box'); const newLinkedMemorySelectBox = linkedMemorySelectBox.cloneNode(true); linkedMemorySelectBox.parentNode.replaceChild(newLinkedMemorySelectBox, linkedMemorySelectBox); newLinkedMemorySelectBox.addEventListener('click', (e) => { e.stopPropagation(); linkedChatsContainer.classList.toggle('visible'); newLinkedMemorySelectBox.classList.toggle('expanded'); }); linkedChatsContainer.addEventListener('change', updateLinkedMemorySelectionDisplay);
            const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`); if (themeRadio) themeRadio.checked = true;
            const fontSizeSlider = document.getElementById('font-size-slider'); fontSizeSlider.value = chat.settings.fontSize || 13; document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            const customCssInput = document.getElementById('custom-css-input'); customCssInput.value = chat.settings.customCss || '';
            updateSettingsPreview();
            document.getElementById('auto-memory-toggle').checked = chat.settings.enableAutoMemory || false;
            document.getElementById('auto-memory-interval').value = chat.settings.autoMemoryInterval || 20;
            showScreen('chat-settings-screen');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderGroupMemberSettings ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function renderGroupMemberSettings(members) { 
            const container = document.getElementById('group-members-settings'); 
            container.innerHTML = ''; 
            members.forEach(member => { 
                const div = document.createElement('div'); 
                div.className = 'member-editor'; 
                div.dataset.memberId = member.id; 
                
                // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØ„ÄêÊ†∏ÂøÉ‰øÆÂ§ç ‚ë†„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                // ‰ºòÂÖà‰ΩøÁî®ÊàêÂëòËá™Â∑±Áã¨Á´ãÁöÑÂ§¥ÂÉè(member.avatar)ÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºåÂÜçÂ∞ùËØïÂéªÂçïËÅäÈÖçÁΩÆÈáåÊâæÔºå
                // Â¶ÇÊûúËøòÊ≤°ÊúâÔºåÊúÄÂêéÊâçÁî®ÈªòËÆ§Â§¥ÂÉè„ÄÇËøôÂ•óÈÄªËæëËÉΩÂÆåÁæéÂÖºÂÆπÊâÄÊúâÁ±ªÂûãÁöÑÊàêÂëò„ÄÇ
                const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
        
                div.innerHTML = `<img src="${memberAvatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
                div.addEventListener('click', () => openMemberEditor(member.id)); 
                container.appendChild(div); 
            }); 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ openMemberEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
        function openMemberEditor(memberId) { 
            editingMemberId = memberId; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === memberId); 
            if (!member) return; // ÂÆâÂÖ®Ê£ÄÊü•
        
            document.getElementById('member-name-input').value = member.groupNickname; 
            document.getElementById('member-persona-input').value = member.persona; 
            
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØ„ÄêÊ†∏ÂøÉ‰øÆÂ§ç ‚ë°„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            // ‰ΩøÁî®‰∏é‰∏äÈù¢ÂÆåÂÖ®Áõ∏ÂêåÁöÑÈÄªËæëÊù•Ëé∑ÂèñÂπ∂ÊòæÁ§∫Ê≠£Á°ÆÁöÑÂΩìÂâçÂ§¥ÂÉè„ÄÇ
            const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
            document.getElementById('member-avatar-preview').src = memberAvatar;
        
            document.getElementById('member-settings-modal').classList.add('visible'); 
        }
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
                    // ‚ñº‚ñº‚ñº Â∞ÜÂÖ∂„ÄêÂÆåÊï¥ÊõøÊç¢‰∏∫„Äë‰∏ãÈù¢ËøôÊÆµ‰øÆÊ≠£ÂêéÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ 'save-member-settings-btn' ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
            if (!editingMemberId) return; 
            const chat = state.chats[state.activeChatId]; 
            const member = chat.members.find(m => m.id === editingMemberId); 
            if (!member) return;
        
            const newNickname = document.getElementById('member-name-input').value.trim();
            if (!newNickname) {
                alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                return;
            }
            member.groupNickname = newNickname; 
            member.persona = document.getElementById('member-persona-input').value; 
            
            const newAvatarUrl = document.getElementById('member-avatar-preview').src;
        
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ËøôÂ∞±ÊòØ„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            // Êó†ËÆ∫ÊàêÂëòÊòØ‚ÄúÁúüËßíËâ≤‚ÄùËøòÊòØ‚ÄúÁ∫ØNPC‚ÄùÔºåÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂ∞ÜÊñ∞Â§¥ÂÉèURLÁõ¥Êé•‰øùÂ≠òÂú®Áæ§ËÅäÁöÑÊàêÂëò‰ø°ÊÅØÈáå„ÄÇ
            member.avatar = newAvatarUrl;
        
            // ÂêåÊó∂ÔºåÂ¶ÇÊûúËøô‰∏™ÊàêÂëòÊòØ‰∏Ä‰∏™‚ÄúÁúüËßíËâ≤‚ÄùÔºåÊàë‰ª¨‰æùÁÑ∂Êõ¥Êñ∞‰ªñÁöÑ‰∏ªÈÖçÁΩÆÔºå‰øùÊåÅÊï∞ÊçÆÂêåÊ≠•„ÄÇ
            const characterProfile = state.chats[member.id];
            if (characterProfile) {
                characterProfile.settings.aiAvatar = newAvatarUrl;
                await db.chats.put(characterProfile);
            }
            
            // Â∞ÜÂåÖÂê´ÊúÄÊñ∞ÊàêÂëò‰ø°ÊÅØÁöÑ„ÄêÊï¥‰∏™Áæ§ËÅäÂØπË±°„ÄëÂ≠òÂõûÊï∞ÊçÆÂ∫ìÔºåËÆ©NPCÁöÑÂ§¥ÂÉèÂæó‰ª•Ê∞∏‰πÖ‰øùÂ≠ò„ÄÇ
            await db.chats.put(chat);
            
            // Âà∑Êñ∞UIÂπ∂ÂÖ≥Èó≠ÂºπÁ™ó
            renderGroupMemberSettings(chat.members); 
            document.getElementById('member-settings-modal').classList.remove('visible'); 
            editingMemberId = null;
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
                   
        
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ save-chat-settings-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            
            // --- ÔºàËøôÈÉ®ÂàÜ‰∏é‰πãÂâçÁõ∏ÂêåÔºå‰øùÊåÅ‰∏çÂèòÔºâ ---
            const newName = document.getElementById('chat-name-input').value.trim();
            if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
            if (!chat.isGroup && newName !== chat.name) {
                if (!chat.nameHistory) chat.nameHistory = [];
                if (!chat.nameHistory.includes(chat.name)) chat.nameHistory.push(chat.name);
            }
            chat.name = newName;
            const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
            chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
            chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
            chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
            chat.settings.myPersona = document.getElementById('my-persona').value;
            chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
        
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπ‰ªéËøôÈáåÂºÄÂßã„Äë„Äë„Äë ---
            const checkedBookItems = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
            const newLinkedBookIds = [];
        
            checkedBookItems.forEach(cb => {
                const value = cb.value;
                // Êàë‰ª¨Âè™ÂÖ≥ÂøÉ‰π¶Á±çÁöÑID
                if (value.startsWith('book_')) {
                    newLinkedBookIds.push(value.replace('book_', ''));
                }
            });
            
            // Âè™‰øùÂ≠òÂçïÊú¨‰π¶ÁöÑID
            chat.settings.linkedWorldBookIds = newLinkedBookIds;
            // ‰∏çÂÜçÈúÄË¶Å‰øùÂ≠òÂàÜÁ±ªIDÔºåÂ∞ÜÂÖ∂‰ªéËÆæÁΩÆ‰∏≠ÁßªÈô§‰ª•‰øùÊåÅÊï∞ÊçÆÂπ≤ÂáÄ
            delete chat.settings.linkedWorldBookCategoryIds; 
            // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπÂà∞ËøôÈáåÁªìÊùü„Äë„Äë„Äë ---
        
            // --- ÔºàËøôÈÉ®ÂàÜ‰∏é‰πãÂâçÁõ∏ÂêåÔºå‰øùÊåÅ‰∏çÂèòÔºâ ---
            if (chat.isGroup) {
                chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
                chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
                chat.settings.actionCooldownMinutes = parseInt(document.getElementById('group-action-cooldown-input').value) || 10;
            } else {
                chat.settings.isOfflineMode = document.getElementById('offline-mode-toggle').checked;
                chat.settings.offlineMinLength = parseInt(document.getElementById('offline-min-length-input').value) || 100;
                chat.settings.offlineMaxLength = parseInt(document.getElementById('offline-max-length-input').value) || 300;
                const newOriginalName = document.getElementById('ai-original-name-input').value.trim();
                if (!newOriginalName) return alert('ÂØπÊñπÊú¨Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                chat.originalName = newOriginalName;
                chat.settings.aiPersona = document.getElementById('ai-persona').value;
                chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
                chat.settings.myNickname = document.getElementById('my-nickname-input').value.trim() || 'Êàë';
                chat.settings.actionCooldownMinutes = parseInt(document.getElementById('ai-action-cooldown-input').value) || 10;

                chat.settings.lyricsPosition = {
                    vertical: document.getElementById('lyrics-vertical-pos').value,
                    horizontal: document.getElementById('lyrics-horizontal-pos').value,
                    offset: parseInt(document.getElementById('lyrics-offset-input').value) || 10
                };
                const selectedGroupId = document.getElementById('assign-group-select').value;
                chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
                // ‚ñº‚ñº‚ñº Âú® save-chat-settings-btn ÁöÑ click ‰∫ã‰ª∂ÁöÑ else ‰ª£Á†ÅÂùóÊú´Â∞æÁ≤òË¥¥ ‚ñº‚ñº‚ñº

// ‰øùÂ≠òËßÜÈ¢ëÈÄöËØùËÆæÁΩÆ
chat.settings.visualVideoCallEnabled = document.getElementById('visual-video-call-switch').checked;
chat.settings.charVideoImage = document.getElementById('char-video-image-preview').src;
chat.settings.userVideoImage = document.getElementById('user-video-image-preview').src;

// ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            }
            chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
            chat.settings.linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
            const linkMemoryToggleChecked = document.getElementById('link-memory-toggle').checked;
            if (linkMemoryToggleChecked) {
                const checkedChats = document.querySelectorAll('#linked-chats-checkboxes-container input:checked');
                chat.settings.linkedMemoryChatIds = Array.from(checkedChats).map(cb => cb.value);
            } else {
                chat.settings.linkedMemoryChatIds = [];
            }
            chat.settings.enableAutoMemory = document.getElementById('auto-memory-toggle').checked;
            chat.settings.autoMemoryInterval = parseInt(document.getElementById('auto-memory-interval').value) || 20;
            await db.chats.put(chat);
            if (!chat.isGroup) {
                await syncCharacterNameInGroups(chat);
                await syncCharacterAvatarInGroups(chat);
            }
            applyLyricsBarPosition(chat);
            applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
            showScreen('chat-interface-screen');
            renderChatInterface(state.activeChatId);
            renderChatList();
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊúÄÁªàÁöÑÂÆåÊï¥ÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Áî®ÂÆÉÊõøÊç¢ÊéâÊóßÁöÑ„Äë ‚ñº‚ñº‚ñº
        
        // ‰∏∫ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑ‚ÄúÊõ¥Êç¢Â§¥ÂÉèÊ°Ü‚ÄùÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂


// ‰∏∫ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑ‚ÄúÊõ¥Êç¢Â§¥ÂÉèÊ°Ü‚ÄùÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
document.getElementById('chat-settings-screen').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat');
    }
});
        
        // ‰∏∫ÊàêÂëòËÆæÁΩÆÈáåÁöÑ‚ÄúÊõ¥Êç¢Â§¥ÂÉèÊ°Ü‚ÄùÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('member-settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('change-frame-btn')) { 
                openFrameSelectorModal('member');
            }
        });
        
        // --- „ÄêÊñ∞Â¢û„Äë‰∏∫Â§¥ÂÉèÊ°ÜÈÄâÊã©Ê®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆÂíåÊ†áÁ≠æÈ°µÁªëÂÆö‰∫ã‰ª∂ ---
        const frameModal = document.getElementById('avatar-frame-modal');
        const aiFrameTab = document.getElementById('ai-frame-tab');
        const myFrameTab = document.getElementById('my-frame-tab');
        const aiFrameContent = document.getElementById('ai-frame-content');
        const myFrameContent = document.getElementById('my-frame-content');
        
        // ‚Äú‰øùÂ≠ò‚ÄùÊåâÈíÆ
        document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
        
        // ‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆ
        document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
            frameModal.classList.remove('visible');
            editingFrameForMember = false; // Á°Æ‰øùÈáçÁΩÆÁä∂ÊÄÅ
        });
        
        // ‚ÄúÂØπÊñπÁöÑ‚Äù Ê†áÁ≠æÈ°µ
        aiFrameTab.addEventListener('click', () => {
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
        });
        
        // ‚ÄúÊàëÁöÑ‚Äù Ê†áÁ≠æÈ°µ
        myFrameTab.addEventListener('click', () => {
            myFrameTab.classList.add('active');
            aiFrameTab.classList.remove('active');
            myFrameContent.style.display = 'block';
            aiFrameContent.style.display = 'none';
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
                    
                    const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
                    setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
                    setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
                    setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
                    setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
                    setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
                    setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
                    // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞‰∏≠ÔºåÊâæÂà∞ setupFileUpload ÁöÑË∞ÉÁî®Âå∫ÂüüÔºåÊ∑ªÂä†‰∏ãÈù¢Ëøô‰∏§Ë°å ‚ñº‚ñº‚ñº
setupFileUpload('char-video-image-input', (base64) => document.getElementById('char-video-image-preview').src = base64);
setupFileUpload('user-video-image-input', (base64) => document.getElementById('user-video-image-preview').src = base64);
// ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });
        
                    const stickerPanel = document.getElementById('sticker-panel');
                    document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
                    document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
                    // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ add-sticker-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫‚ÄúÊâπÈáè‚ÄùÊåâÈíÆÁªëÂÆöÊñ∞ÂáΩÊï∞
        document.getElementById('add-sticker-batch-btn').addEventListener('click', openBatchStickerImportModal);
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫‚ÄúURL‚ÄùÊåâÈíÆÁªëÂÆöÊóßÁöÑÂçïÊù°Ê∑ªÂä†ÈÄªËæë
        document.getElementById('add-sticker-url-btn').addEventListener('click', async () => {
            const url = await showCustomPrompt("Ê∑ªÂä†Ë°®ÊÉÖ(URL)", "ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÁöÑÂõæÁâáURL");
            if (!url || !url.trim().startsWith('http')) {
                if (url) alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL (‰ª•httpÂºÄÂ§¥)");
                return;
            }
            const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÁñëÊÉë)");
            if (name && name.trim()) {
                const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() };
                await db.userStickers.add(newSticker);
                state.userStickers.push(newSticker);
                renderStickerPanel();
            } else if (name !== null) {
                alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            }
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
                    document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); }; event.target.value = null; });
        
                    document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                    document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
                    document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
                    document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        const waimaiModal = document.getElementById('waimai-request-modal');
        document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
            waimaiModal.classList.add('visible');
        });
        
        document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
            waimaiModal.classList.remove('visible');
        });
        
        document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
            if (!state.activeChatId) return;
            
            const productInfoInput = document.getElementById('waimai-product-info');
            const amountInput = document.getElementById('waimai-amount');
            
            const productInfo = productInfoInput.value.trim();
            const amount = parseFloat(amountInput.value);
        
            if (!productInfo) {
                alert('ËØ∑ËæìÂÖ•ÂïÜÂìÅ‰ø°ÊÅØÔºÅ');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª£‰ªòÈáëÈ¢ùÔºÅ');
                return;
            }
        
            const chat = state.chats[state.activeChatId];
            const now = Date.now();
        
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåËé∑ÂèñÁî®Êà∑Ëá™Â∑±ÁöÑÊòµÁß∞
            const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            
            const msg = {
                role: 'user',
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞ÜËé∑ÂèñÂà∞ÁöÑÊòµÁß∞Ôºå‰Ωú‰∏∫ senderName Ê∑ªÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏≠
                senderName: myNickname, 
                type: 'waimai_request',
                productInfo: productInfo,
                amount: amount,
                status: 'pending',
                countdownEndTime: now + 15 * 60 * 1000,
                timestamp: now
            };
        
            chat.history.push(msg);
            await db.chats.put(chat);
            appendMessage(msg, chat);
            renderChatList();
        
            productInfoInput.value = '';
            amountInput.value = '';
            waimaiModal.classList.remove('visible');
        });         
                    document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
                    document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
                    document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
                    document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
                    document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
                    document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
                    document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
                    document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
                    
                    document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
        
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊúÄÁªàÁöÑÂÆåÊï¥ÂäüËÉΩ‰ª£Á†ÅÔºåËØ∑Áî®ÂÆÉÊõøÊç¢ÊéâÊóßÁöÑ„Äë ‚ñº‚ñº‚ñº

        // 1. ‰∏∫Êñ∞ÁöÑ‚ÄúÂà†Èô§(ÈÄöÁü•AI)‚ÄùÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ (ÈÄªËæë‰∏éÊóßÁâàÂà†Èô§ÂÆåÂÖ®Áõ∏Âêå)
        document.getElementById('selection-soft-delete-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüËøô‰ºöÈÄöÁü•AIËøô‰∫õÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                let deletedPollsInfo = [];
                for (const timestamp of selectedMessages) {
                    const msg = chat.history.find(m => m.timestamp === timestamp);
                    if (msg && msg.type === 'poll') {
                        deletedPollsInfo.push(`ÂÖ≥‰∫é‚Äú${msg.question}‚ÄùÁöÑÊäïÁ•®(Êó∂Èó¥Êà≥: ${msg.timestamp})`);
                    }
                }
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                let forgetReason = "‰∏Ä‰∫õ‰πãÂâçÁöÑÊ∂àÊÅØÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§„ÄÇ";
                if (deletedPollsInfo.length > 0) {
                    forgetReason += ` ÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊäïÁ•®Ôºö${deletedPollsInfo.join('Ôºõ')}„ÄÇ`;
                }
                forgetReason += " ‰Ω†Â∫îËØ•ÂÉèÂÆÉ‰ª¨‰ªéÊú™Â≠òÂú®Ëøá‰∏ÄÊ†∑ÁªßÁª≠ÂØπËØùÔºåÂπ∂Áõ∏Â∫îÂú∞Ë∞ÉÊï¥‰Ω†ÁöÑËÆ∞ÂøÜÂíåË°å‰∏∫Ôºå‰∏çË¶ÅÂÜçÊèêÂèäËøô‰∫õË¢´Âà†Èô§ÁöÑÂÜÖÂÆπ„ÄÇ";
                const forgetInstruction = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${forgetReason}]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(forgetInstruction);
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });

        // 2. ‰∏∫Êñ∞Â¢ûÁöÑ‚ÄúÂΩªÂ∫ïÂà†Èô§‚ÄùÊåâÈíÆÁªëÂÆöÂÖ®Êñ∞ÁöÑ„ÄÅÁúüÊ≠£ÁöÑÂà†Èô§ÈÄªËæë
        document.getElementById('selection-erase-btn').addEventListener('click', async () => {
            if (selectedMessages.size === 0) return;
            const confirmed = await showCustomConfirm(
                'ÂΩªÂ∫ïÂà†Èô§Ê∂àÊÅØ', 
                `ËøôÂ∞Ü‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠„ÄêÊ∞∏‰πÖÊäπÈô§„ÄëËøô ${selectedMessages.size} Êù°Ê∂àÊÅØÔºåAIÂ∞ÜÂÆåÂÖ®ÈÅóÂøòÂÆÉ‰ª¨ÁöÑÂ≠òÂú®„ÄÇÁ°ÆÂÆöÂêóÔºü`, 
                { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§ÊäπÈô§' }
            );
            if (confirmed) {
                const chat = state.chats[state.activeChatId];
                
                // Ê†∏ÂøÉÈÄªËæëÔºöÁõ¥Êé•ËøáÊª§ÊéâË¢´ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÔºå‰∏çÊ∑ªÂä†‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫
                chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
                
                // Áõ¥Êé•‰øùÂ≠òÔºåAIÁöÑ‰∏ã‰∏ÄÊ¨°ËØ∑Ê±ÇÂ∞Ü‰∏ç‰ºöÂåÖÂê´Ëøô‰∫õË¢´Âà†Èô§ÁöÑÊ∂àÊÅØ
                await db.chats.put(chat);
                
                // Âà∑Êñ∞UI
                renderChatInterface(state.activeChatId);
                renderChatList();
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    const fontUrlInput = document.getElementById('font-url-input');
                    fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
                    document.getElementById('save-font-btn').addEventListener('click', async () => {
                        const newFontUrl = fontUrlInput.value.trim();
                        if (!newFontUrl) { alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂ≠ó‰ΩìURL„ÄÇ"); return; }
                        applyCustomFont(newFontUrl, false);
                        state.globalSettings.fontUrl = newFontUrl;
                        await db.globalSettings.put(state.globalSettings);
                        alert('Â≠ó‰ΩìÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
                    });
                    document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
        
                    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("‰øÆÊîπÊòµÁß∞", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
                    document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
                    document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
                    document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
                    document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
        
        // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‚ÄúËØ¥ËØ¥‚ÄùÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
            // 1. ÈáçÁΩÆÂπ∂Ëé∑ÂèñÊ®°ÊÄÅÊ°Ü
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. ËÆæÁΩÆ‰∏∫‚ÄúËØ¥ËØ¥‚ÄùÊ®°Âºè
            modal.dataset.mode = 'shuoshuo';
            
            // 3. ÈöêËóè‰∏éÂõæÁâá/ÊñáÂ≠óÂõæÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜ
            modal.querySelector('.post-mode-switcher').style.display = 'none';
            modal.querySelector('#image-mode-content').style.display = 'none';
            modal.querySelector('#text-image-mode-content').style.display = 'none';
            
            // 4. ‰øÆÊîπ‰∏ªËæìÂÖ•Ê°ÜÁöÑÊèêÁ§∫ËØ≠Ôºå‰ΩøÂÖ∂Êõ¥Á¨¶Âêà‚ÄúËØ¥ËØ¥‚ÄùÁöÑÂú∫ÊôØ
            modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...';
            
            // 5. ÂáÜÂ§áÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
            }
            modal.classList.add('visible');
        });
        
        // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‚ÄúÂä®ÊÄÅ‚ÄùÔºàÂõæÁâáÔºâÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            // 1. ÈáçÁΩÆÂπ∂Ëé∑ÂèñÊ®°ÊÄÅÊ°Ü
            resetCreatePostModal();
            const modal = document.getElementById('create-post-modal');
            
            // 2. ËÆæÁΩÆ‰∏∫‚ÄúÂ§çÊùÇÂä®ÊÄÅ‚ÄùÊ®°Âºè
            modal.dataset.mode = 'complex';
            
        // 3. Á°Æ‰øù‰∏éÂõæÁâá/ÊñáÂ≠óÂõæÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜÊòØÂèØËßÅÁöÑ
        modal.querySelector('.post-mode-switcher').style.display = 'flex';
        // ÊòæÂºèÊøÄÊ¥ª‚Äú‰∏ä‰º†ÂõæÁâá‚ÄùÊ®°Âºè...
        modal.querySelector('#image-mode-content').classList.add('active');
        // ...ÂêåÊó∂Á°Æ‰øù‚ÄúÊñáÂ≠óÂõæ‚ÄùÊ®°ÂºèÊòØÈöêËóèÁöÑ
        modal.querySelector('#text-image-mode-content').classList.remove('active');
            
            // 4. ÊÅ¢Â§ç‰∏ªËæìÂÖ•Ê°ÜÁöÑÈªòËÆ§ÊèêÁ§∫ËØ≠
            modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ';
        
            // 5. ÂáÜÂ§áÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÔºà‰∏é‚ÄúËØ¥ËØ¥‚ÄùÊåâÈíÆÁöÑÈÄªËæëÁõ∏ÂêåÔºâ
            const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
            visibilityGroupsContainer.innerHTML = '';
            const groups = await db.qzoneGroups.toArray();
            if (groups.length > 0) {
                groups.forEach(group => {
                    const label = document.createElement('label');
                    label.style.display = 'block';
                    label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                    visibilityGroupsContainer.appendChild(label);
                });
            } else {
                visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
            }
            modal.classList.add('visible');
        });
                    document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
                    document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });
        
        // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---
        
        document.getElementById('album-photos-back-btn').addEventListener('click', () => {
            state.activeAlbumId = null;
            showScreen('album-screen');
        });
        
        document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());
        
        document.getElementById('album-photo-input').addEventListener('change', async (event) => {
            if (!state.activeAlbumId) return;
            const files = event.target.files;
            if (!files.length) return;
        
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            
            for (const file of files) {
                const dataUrl = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
            }
        
            const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
            const updateData = { photoCount };
            
            if (!album.photoCount || album.coverUrl.includes('placeholder')) {
                const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                if(firstPhoto) updateData.coverUrl = firstPhoto.url;
            }
        
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            
            event.target.value = null;
            alert('ÁÖßÁâá‰∏ä‰º†ÊàêÂäüÔºÅ');
        });
        
        // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---
        
        // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ photos-grid-page ÁõëÂê¨Âô® ‚Üì‚Üì‚Üì ---
        
        document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.photo-delete-btn');
            const photoThumb = e.target.closest('.photo-thumb');
        
            if (deleteBtn) {
                e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞ÂõæÁâá‰∏ä
                const photoId = parseInt(deleteBtn.dataset.photoId);
                const confirmed = await showCustomConfirm(
                    'Âà†Èô§ÁÖßÁâá',
                    'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',
                    { confirmButtonClass: 'btn-danger' }
                );
        
                if (confirmed) {
                    const deletedPhoto = await db.qzonePhotos.get(photoId);
                    if (!deletedPhoto) return;
                    
                    await db.qzonePhotos.delete(photoId);
        
                    const album = await db.qzoneAlbums.get(state.activeAlbumId);
                    const photoCount = (album.photoCount || 1) - 1;
                    const updateData = { photoCount };
                    
                    if (album.coverUrl === deletedPhoto.url) {
                        const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                        updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
                    }
                    
                    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                    await renderAlbumPhotosScreen();
                    await renderAlbumList();
                    alert('ÁÖßÁâáÂ∑≤Âà†Èô§„ÄÇ');
                }
            } 
            else if (photoThumb) {
                // ËøôÂ∞±ÊòØÊÅ¢Â§çÁöÑÂõæÁâáÁÇπÂáªÊîæÂ§ßÂäüËÉΩÔºÅ
                openPhotoViewer(photoThumb.src);
            }
        });
        
        // ÊÅ¢Â§çÂõæÁâáÊü•ÁúãÂô®ÁöÑÊéßÂà∂‰∫ã‰ª∂
        document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
        document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
        document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);
        
        // ÊÅ¢Â§çÈîÆÁõòÂ∑¶Âè≥ÁÆ≠Â§¥ÂíåESCÈîÆÁöÑÂäüËÉΩ
        document.addEventListener('keydown', (e) => {
            if (!photoViewerState.isOpen) return; 
        
            if (e.key === 'ArrowRight') {
                showNextPhoto();
            } else if (e.key === 'ArrowLeft') {
                showPrevPhoto();
            } else if (e.key === 'Escape') {
                closePhotoViewer();
            }
        });
        
        // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---
                 
        document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("ÂàõÂª∫Êñ∞Áõ∏ÂÜå", "ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`Áõ∏ÂÜå "${albumName}" ÂàõÂª∫ÊàêÂäüÔºÅ`); } else if (albumName !== null) { alert("Áõ∏ÂÜåÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); } });
        
                    document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
                    document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
                    document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
                    document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•ÁΩëÁªúÂõæÁâáÁöÑÈìæÊé•", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
                    document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
                    const imageModeBtn = document.getElementById('switch-to-image-mode');
                    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
                    const imageModeContent = document.getElementById('image-mode-content');
                    const textImageModeContent = document.getElementById('text-image-mode-content');
                    imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
                    textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëÁöÑ‚ÄúÂèëÂ∏É‚ÄùÊåâÈíÆ‰∫ã‰ª∂ÔºåÂ∑≤‰øÆÂ§çÊùÉÈôêÊºèÊ¥û ‚ñº‚ñº‚ñº
        document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
            const modal = document.getElementById('create-post-modal');
            const mode = modal.dataset.mode;
            
            // --- 1. Ëé∑ÂèñÈÄöÁî®ÁöÑÂèØËßÅÊÄßËÆæÁΩÆ ---
            const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
            let visibleGroupIds = null;
            
            if (visibilityMode === 'include') {
                visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
            }
        
            let newPost = {};
            const basePostData = {
                timestamp: Date.now(),
                authorId: 'user',
                // „ÄêÈáçË¶Å„ÄëÂú®ËøôÈáåÂ∞±ÊääÊùÉÈôê‰ø°ÊÅØÂ≠òÂ•Ω
                visibleGroupIds: visibleGroupIds,
            };
        
            // --- 2. Ê†πÊçÆÊ®°ÂºèÊûÑÂª∫‰∏çÂêåÁöÑ post ÂØπË±° ---
            if (mode === 'shuoshuo') {
                const content = document.getElementById('post-public-text').value.trim();
                if (!content) {
                    alert('ËØ¥ËØ¥ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
                    return;
                }
                newPost = {
                    ...basePostData,
                    type: 'shuoshuo',
                    content: content,
                };
        
            } else { // Â§ÑÁêÜ 'complex' Ê®°Âºè (ÂõæÁâá/ÊñáÂ≠óÂõæ)
                const publicText = document.getElementById('post-public-text').value.trim();
                const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');
        
                if (isImageModeActive) {
                    const imageUrl = document.getElementById('post-image-preview').src;
                    const imageDescription = document.getElementById('post-image-description').value.trim();
                    if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                        alert('ËØ∑ÂÖàÊ∑ªÂä†‰∏ÄÂº†ÂõæÁâáÂÜçÂèëÂ∏ÉÂä®ÊÄÅÂì¶ÔºÅ');
                        return;
                    }
                    if (!imageDescription) {
                        alert('ËØ∑‰∏∫‰Ω†ÁöÑÂõæÁâáÊ∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèèËø∞ÔºàÂøÖÂ°´ÔºåÁªôAIÁúãÁöÑÔºâÔºÅ');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'image_post',
                        publicText: publicText,
                        imageUrl: imageUrl,
                        imageDescription: imageDescription,
                    };
                } else { // ÊñáÂ≠óÂõæÊ®°Âºè
                    const hiddenText = document.getElementById('post-hidden-text').value.trim();
                    if (!hiddenText) {
                        alert('ËØ∑ËæìÂÖ•ÊñáÂ≠óÂõæÊèèËø∞ÔºÅ');
                        return;
                    }
                    newPost = {
                        ...basePostData,
                        type: 'text_image',
                        publicText: publicText,
                        hiddenContent: hiddenText,
                    };
                }
            }
        
            // --- 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì ---
            const newPostId = await db.qzonePosts.add(newPost);
const savedPost = await db.qzonePosts.get(newPostId); // Ëé∑ÂèñÂ∏¶ÊúâIDÁöÑÂÆåÊï¥ÂØπË±°

// ‚ñº‚ñº‚ñº „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÊîπÔºöË∞ÉÁî®ÂÖ®Êñ∞ÁöÑNPCËØÑËÆ∫ÂØºÊºî„Äë„Äë„Äë ‚ñº‚ñº‚ñº
const authorChar = state.chats[savedPost.authorId];
if (authorChar && !authorChar.isGroup && authorChar.npcs && authorChar.npcs.length > 0) {
    // Áõ¥Êé•Ë∞ÉÁî®Êñ∞ÂáΩÊï∞ÔºåÂπ∂ËÆ©ÂÆÉÂú®ÂêéÂè∞ÊâßË°åÔºå‰∏çÈòªÂ°ûÂêéÁª≠UIÊ∏≤Êüì
    generateAllNpcCommentsInOneCall(authorChar, savedPost).then(() => {
        // ÂΩìÊâÄÊúâNPCËØÑËÆ∫ÁîüÊàêÂπ∂‰øùÂ≠òÂêéÔºåÂ¶ÇÊûú‰Ω†Â∏åÊúõÂä®ÊÄÅÂàóË°®Ëá™Âä®Âà∑Êñ∞ÔºåÂèØ‰ª•Âú®ËøôÈáåË∞ÉÁî®
        if (document.getElementById('qzone-screen').classList.contains('active')) {
             updateSinglePostInDOM(savedPost.id);
        }
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
            postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');
        
            // --- 4. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∏¶ÊúâÊùÉÈôêÊ£ÄÊü•ÁöÑÈÄöÁü•Âæ™ÁéØ ---
            for (const chatId in state.chats) {
                const chat = state.chats[chatId];
                if (chat.isGroup) continue; // Ë∑≥ËøáÁæ§ËÅä
        
                let shouldNotify = false;
                const postVisibleGroups = newPost.visibleGroupIds;
        
                // Âà§Êñ≠Êù°‰ª∂1ÔºöÂ¶ÇÊûúÂä®ÊÄÅÊòØÂÖ¨ÂºÄÁöÑ (Ê≤°ÊúâËÆæÁΩÆ‰ªª‰ΩïÂèØËßÅÂàÜÁªÑ)
                if (!postVisibleGroups || postVisibleGroups.length === 0) {
                    shouldNotify = true;
                } 
                // Âà§Êñ≠Êù°‰ª∂2ÔºöÂ¶ÇÊûúÂä®ÊÄÅËÆæÁΩÆ‰∫ÜÈÉ®ÂàÜÂèØËßÅÔºåÂπ∂‰∏îÂΩìÂâçËßíËâ≤Âú®ÂèØËßÅÂàÜÁªÑÂÜÖ
                else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
                    shouldNotify = true;
                }
        
                // Âè™ÊúâÊª°Ë∂≥Êù°‰ª∂ÁöÑËßíËâ≤Êâç‰ºöË¢´ÈÄöÁü•
                if (shouldNotify) {
        // ‚ñº‚ñº‚ñº ‰ªéËøôÈáåÂºÄÂßãÊõøÊç¢ ‚ñº‚ñº‚ñº
        const historyMessage = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ(ID: ${newPostId})ÔºåÂÜÖÂÆπÊëòË¶ÅÊòØÔºö‚Äú${postSummary}‚Äù„ÄÇËØ∑‰Ω†„ÄêÁªìÂêàËá™Â∑±ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇÂíå‰Ω†‰ª¨ÁöÑÊúÄËøëËÅäÂ§©ÂÜÖÂÆπ„ÄëÔºåÂØπËøôÊù°Âä®ÊÄÅÂèëË°®‰∏ÄÊù°Ëá™ÁÑ∂ÁöÑËØÑËÆ∫„ÄÇ]`,
            timestamp: Date.now(),
            isHidden: true
        };
        // ‚ñ≤‚ñ≤‚ñ≤ Âà∞ËøôÈáåÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    chat.history.push(historyMessage);
                    await db.chats.put(chat);
                }
            }
            // --- ‰øÆÊ≠£ÁªìÊùü ---
        
            await renderQzonePosts();
            modal.classList.remove('visible');
            alert('Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ');
        });
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂåÖÂê´ÊâÄÊúâÊªëÂä®ÂíåÁÇπÂáª‰∫ã‰ª∂ÁöÑÂÆåÊï¥‰ª£Á†ÅÔºåÊõøÊç¢ÊéâÊóßÁöÑ postsList ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        const postsList = document.getElementById('qzone-posts-list');
        let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };
        
        function resetAllSwipes(exceptThisOne = null) {
            document.querySelectorAll('.qzone-post-container').forEach(container => {
                if (container !== exceptThisOne) {
                    container.querySelector('.qzone-post-item').classList.remove('swiped');
                }
            });
        }
// ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®Ëøô‰∏™V2.0ÊúÄÁªà‰øÆÂ§çÁâà„ÄëÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ handlePostClick ÂáΩÊï∞ ‚ñº‚ñº‚ñº

/**
 * „ÄêV2.0 | Â∑≤‰øÆÂ§çpostId‰ΩúÁî®ÂüüÈóÆÈ¢ò„ÄëÂ§ÑÁêÜÂä®ÊÄÅÂå∫ÂüüÂÜÖÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂ÁöÑÁªü‰∏ÄÂÖ•Âè£
 */
async function handlePostClick(e) {
    e.stopPropagation();
    const target = e.target;

    // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç1ÔºöÂú®ÂáΩÊï∞ÊúÄÂºÄÂßãÂ∞±Ëé∑Âèñ postId„Äë„Äë„Äë ---
    // Êó†ËÆ∫ÁÇπÂáª‰∫Ü‰ªÄ‰πàÔºåÊàë‰ª¨È¶ñÂÖàÊâæÂà∞ÂÆÉÊâÄÂ±ûÁöÑÈÇ£‰∏™ÊúÄÂ§ßÁöÑÂä®ÊÄÅÂÆπÂô®
    const postContainer = target.closest('.qzone-post-container');
    // Â¶ÇÊûúÁÇπÂáªÁöÑÂú∞Êñπ‰∏çÂú®‰ªª‰Ωï‰∏Ä‰∏™Âä®ÊÄÅÈáåÔºåÂ∞±Áõ¥Êé•ÈÄÄÂá∫
    if (!postContainer) return;

    // ‰ªéÂÆπÂô®‰∏≠ÂÆâÂÖ®Âú∞Ëé∑Âèñ postId
    const postId = parseInt(postContainer.dataset.postId);
    // Â¶ÇÊûú postId Êó†ÊïàÔºå‰πüÈÄÄÂá∫
    if (isNaN(postId)) return;

    // --- Áé∞Âú®ÔºåÂêéÁª≠ÁöÑÊâÄÊúâÈÄªËæëÈÉΩÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ΩøÁî® postId ÂèòÈáè‰∫Ü ---

    const deleteBtn = target.closest('.comment-delete-btn');
    if (deleteBtn) {
        const commentIndex = parseInt(deleteBtn.dataset.commentIndex);
        if (isNaN(commentIndex)) return;

        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;
        
        const confirmed = await showCustomConfirm('Âà†Èô§ËØÑËÆ∫', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            post.comments.splice(commentIndex, 1);
            await db.qzonePosts.update(postId, { comments: post.comments });
            await updateSinglePostInDOM(postId);
        }
        return;
    }
    
    const stickerBtn = target.closest('.comment-sticker-btn');
    if (stickerBtn) {
        if (qzoneStickerPanelState.isOpen && qzoneStickerPanelState.activePostId === postId) {
            closeQzoneStickerPanel();
        } else {
            openQzoneStickerPanel(postId, stickerBtn);
        }
        return; 
    }

    const commentItem = target.closest('.comment-item');
    if (commentItem) {
        const commenterOriginalName = commentItem.dataset.commenterOriginalName;
        const commenterDisplayName = commentItem.dataset.commenterDisplayName;

        if (!commenterOriginalName || !commenterDisplayName || commenterOriginalName === state.qzoneSettings.nickname) {
            clearQzoneReplyContext(postContainer);
            return;
        }
        currentQzoneReplyContext = { postId, replyToName: commenterOriginalName, replyToDisplayName: commenterDisplayName };
        const commentInput = postContainer.querySelector('.comment-input');
        commentInput.placeholder = `ÂõûÂ§ç ${commenterDisplayName}:`;
        commentInput.focus();
        return; 
    }

    if (target.classList.contains('post-actions-btn')) {
        showPostActions(postId);
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", target.dataset.hiddenText.replace(/<br>/g, '\n'));
        return;
    }

    // --- „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç2ÔºöÁé∞Âú®Ëøô‰∏™ÊåâÈíÆÁöÑÈÄªËæëÂèØ‰ª•Ê≠£Â∏∏Â∑•‰Ωú‰∫Ü„Äë„Äë„Äë ---
    const npcTriggerBtn = target.closest('.npc-comment-trigger-btn');
    if (npcTriggerBtn) {
        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post) return;

        const authorChar = state.chats[post.authorId];
        if (authorChar && !authorChar.isGroup && authorChar.npcs && authorChar.npcs.length > 0) {
            npcTriggerBtn.innerHTML = '...';
            npcTriggerBtn.disabled = true;

            await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®‰∏∫‚Äú${authorChar.name}‚ÄùÁöÑ ${authorChar.npcs.length} ‰∏™NPCÁîüÊàêËØÑËÆ∫...`);
            
            await generateAllNpcCommentsInOneCall(authorChar, post);
            
            await updateSinglePostInDOM(postId);
            await showCustomAlert("ÊàêÂäü", "NPCËØÑËÆ∫Â∑≤ÁîüÊàêÔºÅ");

            npcTriggerBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`;
            npcTriggerBtn.disabled = false;
        } else {
            alert("ËØ•ËßíËâ≤ÁöÑÂä®ÊÄÅÊó†Ê≥ïËß¶ÂèëNPCËØÑËÆ∫ÔºàÂèØËÉΩ‰∏çÊòØAIËßíËâ≤ÊàñÊ≤°ÊúâÈÖçÁΩÆNPCÔºâ„ÄÇ");
        }
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const confirmed = await showCustomConfirm('Âà†Èô§Âä®ÊÄÅ', 'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            postContainer.style.transition = 'all 0.3s ease';
            postContainer.style.transform = 'scale(0.8)';
            postContainer.style.opacity = '0';
            setTimeout(async () => {
                 // ‰ΩøÁî®ËΩØÂà†Èô§ËÄå‰∏çÊòØÁ°¨Âà†Èô§
                 await db.qzonePosts.update(postId, { isDeleted: true });
                 
                 // ‰ªéÁºìÂ≠ò‰∏≠ÁßªÈô§ËØ•Â∏ñÂ≠ê
                 const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
                 if (cacheIndex > -1) {
                     qzonePostsCache.splice(cacheIndex, 1);
                 }
                 
                 // Ê∏ÖÁêÜÁõ∏ÂÖ≥ÁöÑËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï
                 const notificationIdentifier = `(ID: ${postId})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
                 }
                 
                 // ÈáçÊñ∞Ê∏≤ÊüìÂä®ÊÄÅÂàóË°®
                 await renderQzonePosts();
                 alert('Âä®ÊÄÅÂ∑≤Âà†Èô§„ÄÇ');
            }, 300);
        }
        return;
    }

    const icon = target.closest('.action-icon');
    if (icon) {
        if (icon.classList.contains('repost')) { openRepostModal(postId); return; }
        if (icon.classList.contains('like')) {
            const post = qzonePostsCache.find(p => p.id === postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userOriginalName = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userOriginalName);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userOriginalName);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
            await updateSinglePostInDOM(postId);
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('ÊèêÁ§∫', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('ÊèêÁ§∫', 'Êî∂ËóèÊàêÂäüÔºÅ');
                }
            }
            await updateSinglePostInDOM(postId);
        }
        return;
    }

    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
        
        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post) return;

        if (!post.comments) post.comments = [];
        
    // 1. ÂàõÂª∫Âπ∂Ê∑ªÂä†Áî®Êà∑ÁöÑÊñ∞ËØÑËÆ∫
    const newComment = {
        commenterName: state.qzoneSettings.nickname, // ËØÑËÆ∫ËÄÖÊòØÁî®Êà∑
        text: commentText,
        timestamp: Date.now(),
        replyTo: (currentQzoneReplyContext && currentQzoneReplyContext.postId === postId) ? currentQzoneReplyContext.replyToName : null
    };
    post.comments.push(newComment);
    
    // 2. Á´ãÂàªÂ∞ÜÂåÖÂê´Áî®Êà∑Êñ∞ËØÑËÆ∫ÁöÑÂä®ÊÄÅ‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ì
    await db.qzonePosts.put(post);
    
    // 3. ÈÄöÁü•Âä®ÊÄÅ‰ΩúËÄÖÂíåÂÖ∂‰ªñË¢´ÂõûÂ§çËÄÖÔºàËøôÈÉ®ÂàÜÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºâ
    let postSummary = (post.publicText || post.content || '').substring(0, 30);
    const userNickname = state.qzoneSettings.nickname;
    const notifiedAiIds = new Set();
    if (post.authorId !== 'user') notifiedAiIds.add(post.authorId);
    if (newComment.replyTo && newComment.replyTo !== userNickname) {
        const repliedToChat = Object.values(state.chats).find(c => c.originalName === newComment.replyTo);
        if (repliedToChat) notifiedAiIds.add(repliedToChat.id);
    }
        for (const aiId of notifiedAiIds) {
            const chat = state.chats[aiId];
            if (chat && !chat.isGroup) {
                const stickerMatch = state.userStickers.find(s => s.url === commentText);
                let notificationText = stickerMatch ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${stickerMatch.name}‚Äù„ÄÇ`
                    : newComment.replyTo ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂõûÂ§ç‰∫Ü'${currentQzoneReplyContext.replyToDisplayName}'ÁöÑËØÑËÆ∫ÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ`
                    : `Áî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ`;
            const historyMessage = { 
                role: 'system', 
                content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`, 
                timestamp: Date.now(), 
                isHidden: true 
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    
    // 4. Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂Âà∑Êñ∞UIÔºåËÆ©Áî®Êà∑ÁöÑËØÑËÆ∫Á´ãÂàªÊòæÁ§∫Âá∫Êù•
    commentInput.value = '';
    clearQzoneReplyContext(postContainer); 
    await updateSinglePostInDOM(postId); // Â¢ûÈáèÊõ¥Êñ∞UI

    // 5. „Äê„Äê„ÄêÊ†∏ÂøÉÊñ∞Â¢ûÔºöÂî§ÈÜíNPCËøõË°åËØÑËÆ∫„Äë„Äë„Äë
    const authorChar = state.chats[post.authorId];
    if (authorChar && !authorChar.isGroup && authorChar.npcs && authorChar.npcs.length > 0) {
        // Áõ¥Êé•Ë∞ÉÁî®Êàë‰ª¨ÁöÑNPCËØÑËÆ∫ÂØºÊºîÂáΩÊï∞ÔºåÂπ∂‰º†ÂÖ•„ÄêÂåÖÂê´‰∫ÜÁî®Êà∑Êñ∞ËØÑËÆ∫„ÄëÁöÑpostÂØπË±°
        await generateAllNpcCommentsInOneCall(authorChar, post);
        // ÂÜçÊ¨°Âà∑Êñ∞UIÔºåÊòæÁ§∫NPC‰ª¨ÁöÑËØÑËÆ∫
        await updateSinglePostInDOM(postId); 
    }
        return;
    }
}

// ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        // ‚ñº‚ñº‚ñº „ÄêÊÄßËÉΩ‰ºòÂåñÊñπÊ°à„ÄëËØ∑Áî®Ëøô‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢ÊâÄÊúâÊóßÁöÑÊªëÂä®Â§ÑÁêÜÂáΩÊï∞Âíå‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        // --- 1. ÂÖ®Êñ∞ÁöÑ„ÄÅÊõ¥Êô∫ËÉΩÁöÑÊªëÂä®ÂºÄÂßãÂáΩÊï∞ ---
        const handleSwipeStart = (e) => {
            const target = e.target;
            // Ê£ÄÊü•ÁÇπÂáªÁõÆÊ†áÊòØÂê¶ÊòØ‰∫§‰∫íÂå∫ÂüüÔºåÂ¶ÇÊûúÊòØÔºåÂàô‰∏çÂêØÂä®ÊªëÂä®
            if (target.closest('.post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper')) {
                return;
            }
            const targetContainer = e.target.closest('.qzone-post-container');
            if (!targetContainer) return;
        
            resetAllSwipes(targetContainer);
            swipeState.activeContainer = targetContainer;
            swipeState.isDragging = true;
            swipeState.isClick = true;
            swipeState.swipeDirection = null;
            swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
        
            // „ÄêÊ†∏ÂøÉ‰ºòÂåñ„ÄëÂè™Âú®ÊªëÂä®ÂºÄÂßãÊó∂ÔºåÊâçÂä®ÊÄÅÁªëÂÆöÁßªÂä®ÂíåÁªìÊùüÁöÑÁõëÂê¨Âô®
            document.addEventListener('mousemove', handleSwipeMove);
            document.addEventListener('mouseup', handleSwipeEnd);
            document.addEventListener('touchmove', handleSwipeMove, { passive: false });
            document.addEventListener('touchend', handleSwipeEnd);
        };
        
        // --- 2. ÊªëÂä®ÁßªÂä®ÂáΩÊï∞ÔºàÂæÆË∞ÉÔºâ ---
        const handleSwipeMove = (e) => {
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
        
            const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            const diffX = currentX - swipeState.startX;
            const diffY = currentY - swipeState.startY;
            
            if (swipeState.isClick && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
                swipeState.isClick = false;
            }
        
            if (!swipeState.swipeDirection) {
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    swipeState.swipeDirection = 'horizontal';
                } else {
                    swipeState.swipeDirection = 'vertical';
                }
            }
            
            if (swipeState.swipeDirection === 'horizontal') {
                e.preventDefault(); // Âè™Âú®Á°ÆÂÆöÊòØÊ∞¥Âπ≥ÊªëÂä®Êó∂ÊâçÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                swipeState.currentX = currentX;
                let translation = Math.min(0, Math.max(-90, diffX)); // ÈôêÂà∂ÊªëÂä®ËåÉÂõ¥
                swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
            }
        };
        
        // --- 3. ÊªëÂä®ÁªìÊùüÂáΩÊï∞ÔºàÈáçÊûÑÔºâ ---
        const handleSwipeEnd = (e) => {
            // „ÄêÊ†∏ÂøÉ‰ºòÂåñ„ÄëÊó†ËÆ∫Â¶Ç‰ΩïÔºåÈÉΩÂú®ÊªëÂä®ÁªìÊùüÂêéÁßªÈô§ÁõëÂê¨Âô®
            document.removeEventListener('mousemove', handleSwipeMove);
            document.removeEventListener('mouseup', handleSwipeEnd);
            document.removeEventListener('touchmove', handleSwipeMove);
            document.removeEventListener('touchend', handleSwipeEnd);
        
            if (!swipeState.isDragging || !swipeState.activeContainer) return;
            
            const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
            postItem.style.transition = 'transform 0.3s ease';
        
            if (swipeState.swipeDirection === 'horizontal' && !swipeState.isClick) {
                const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
                const diffX = finalX - swipeState.startX;
                if (diffX < -40) { // ÊªëÂä®Ë∂ÖËøá40ÂÉèÁ¥†Â∞±Ëß¶Âèë
                    postItem.classList.add('swiped');
                } else {
                    postItem.classList.remove('swiped');
                }
            }
            
            postItem.style.transform = ''; // ÊÅ¢Â§çÂéü‰ΩçÔºåËÆ©CSS classÊé•ÁÆ°
            
            // ÈáçÁΩÆÁä∂ÊÄÅ
            swipeState.isDragging = false;
            swipeState.activeContainer = null;
            swipeState.swipeDirection = null;
            swipeState.isClick = true;
        };
        
        // --- 4. Âú® init() ÂáΩÊï∞‰∏≠ÁªëÂÆö‰∫ã‰ª∂ ---
        // postsList.addEventListener('click', handlePostClick); // ËøôË°åÊÇ®Â∫îËØ•Â∑≤ÁªèÊúâ‰∫Ü
        // postsList.addEventListener('mousedown', handleSwipeStart); // ÁªëÂÆöÈº†Ê†áÊåâ‰∏ã
        // postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ÁªëÂÆöËß¶Êë∏ÂºÄÂßã
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        
        // „ÄêÊúÄÁªàÁâà„ÄëÂä®ÊÄÅÂàóË°®‰∫ã‰ª∂ÁªëÂÆö
        postsList.addEventListener('click', handlePostClick);
        postsList.addEventListener('mousedown', handleSwipeStart);
        postsList.addEventListener('touchstart', handleSwipeStart, { passive: true }); // ‰ΩøÁî® passive ÊèêÂçáÊªöÂä®ÊÄßËÉΩ
        // --- ÁªëÂÆöÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂ ---
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Âä®ÊÄÅÂàóË°®Ê∑ªÂä†‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÁöÑ‰∫ã‰ª∂ÂßîÊâò ‚ñº‚ñº‚ñº
        postsList.addEventListener('click', (e) => {
            // Ê£ÄÊü•Ë¢´ÁÇπÂáªÁöÑÊòØÂê¶ÊòØÊàë‰ª¨ÁöÑ‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
            if (e.target && e.target.id === 'load-more-qzone-btn') {
                loadMoreQzonePosts();
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // „ÄêÂÖ®Êñ∞„Äë‰∏∫ÈïøÊúüËÆ∞ÂøÜ‚ÄúÁ≤æÁÇº‚ÄùÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
        document.getElementById('refine-memory-btn-header').addEventListener('click', () => {
            if(state.activeChatId) {
                summarizeExistingLongTermMemory(state.activeChatId);
            }
        });
                    // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAPIÈ¢ÑËÆæÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                    document.getElementById('api-preset-select').addEventListener('change', handlePresetSelectionChange);
                    document.getElementById('save-api-preset-btn').addEventListener('click', saveApiPreset);
                    document.getElementById('delete-api-preset-btn').addEventListener('click', deleteApiPreset);
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†ËøôË°å‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('add-world-book-entry-btn').addEventListener('click', () => {
            const container = document.getElementById('world-book-entries-container');
            // Â¶ÇÊûú‰πãÂâçÊúâÊèêÁ§∫ËØ≠ÔºåÂÖàÊ∏ÖÁ©∫
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            const newBlock = createWorldBookEntryBlock(); // ÂàõÂª∫‰∏Ä‰∏™Á©∫Âùó
            container.appendChild(newBlock);
            newBlock.querySelector('.entry-content-textarea').focus(); // Ëá™Âä®ËÅöÁÑ¶Âà∞Êñ∞ÂùóÁöÑÂÜÖÂÆπÂå∫
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥‰∏ãÈù¢Ëøô‰∏§Ë°å ‚ñº‚ñº‚ñº
        document.getElementById('switch-greeting-btn').addEventListener('click', handleSwitchGreeting);
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫ÂøÉÂ£∞ÂéÜÂè≤ÂàóË°®Ê∑ªÂä†‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÁöÑ‰∫ã‰ª∂ÂßîÊâò ‚ñº‚ñº‚ñº
        document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'load-more-thoughts-btn') {
                loadMoreThoughts();
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
        
        // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞Ü‰∫ã‰ª∂ÁõëÂê¨ÁªëÂÆöÂà∞Êñ∞ÁöÑÂõæÊ†áÊåâÈíÆ‰∏ä ‚ñº‚ñº‚ñº
        document.getElementById('profile-history-icon-btn').addEventListener('click', showThoughtsHistory);
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        document.getElementById('history-back-btn').addEventListener('click', hideThoughtsHistory);
        document.getElementById('character-profile-modal').addEventListener('click', (e) => {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊ∑±Ëâ≤ËÉåÊôØÊú¨Ë∫´ÔºåËÄå‰∏çÊòØÂÜÖÂÆπÂå∫ÂüüÔºåÂ∞±ÂÖ≥Èó≠ÂºπÁ™ó
            if (e.target.id === 'character-profile-modal') {
                e.target.classList.remove('visible');
            }
        });
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË°®ÊÉÖÊâπÈáèÂà†Èô§‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('manage-stickers-btn').addEventListener('click', toggleStickerManagementMode);
        document.getElementById('delete-selected-stickers-btn').addEventListener('click', executeBatchDeleteStickers);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    // ÁªëÂÆöÂä®ÊÄÅÈ°µÂíåÊî∂ËóèÈ°µÁöÑËøîÂõûÊåâÈíÆ
                    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
                    document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
                    // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÊ£ÄÊü•Âπ∂Á°Æ‰øù‰Ω†ÊúâËøôÊÆµÂÆåÊï¥ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
        
                    // Êî∂ËóèÈ°µÊêúÁ¥¢ÂäüËÉΩ
                    const searchInput = document.getElementById('favorites-search-input');
                    const searchClearBtn = document.getElementById('favorites-search-clear-btn');
        
                    searchInput.addEventListener('input', () => {
                        const searchTerm = searchInput.value.trim().toLowerCase();
                        
                        // ÊéßÂà∂Ê∏ÖÈô§ÊåâÈíÆÁöÑÊòæÁ§∫/ÈöêËóè
                        searchClearBtn.style.display = searchTerm ? 'block' : 'none';
        
                        if (!searchTerm) {
                            displayFilteredFavorites(allFavoriteItems); // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâ
                            return;
                        }
        
                        // Á≠õÈÄâÈÄªËæë
                        const filteredItems = allFavoriteItems.filter(item => {
                            let contentToSearch = '';
                            let authorToSearch = '';
        
                            if (item.type === 'qzone_post') {
                                const post = item.content;
                                contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                                if (post.authorId === 'user') {
                                    authorToSearch = state.qzoneSettings.nickname;
                                } else if (state.chats[post.authorId]) {
                                    authorToSearch = state.chats[post.authorId].name;
                                }
                            } else if (item.type === 'chat_message') {
                                const msg = item.content;
                                if (typeof msg.content === 'string') {
                                    contentToSearch = msg.content;
                                }
                                const chat = state.chats[item.chatId];
                                if (chat) {
                                   if (msg.role === 'user') {
                                        authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                                   } else {
                                        authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                                   }
                                }
                            }
                            
                            // ÂêåÊó∂ÊêúÁ¥¢ÂÜÖÂÆπÂíå‰ΩúËÄÖÔºåÂπ∂‰∏î‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô
                            return contentToSearch.toLowerCase().includes(searchTerm) || 
                                   authorToSearch.toLowerCase().includes(searchTerm);
                        });
        
                        displayFilteredFavorites(filteredItems);
                    });
        
                    // Ê∏ÖÈô§ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
                    searchClearBtn.addEventListener('click', () => {
                        searchInput.value = '';
                        searchClearBtn.style.display = 'none';
                        displayFilteredFavorites(allFavoriteItems);
                        searchInput.focus();
                    });
        
                    // ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÊ£ÄÊü•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // ‚ñº‚ñº‚ñº Êñ∞Â¢û/‰øÆÊîπÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                    
                    // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
                                // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
                    document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                        if (selectedMessages.size === 0) return;
                        const chat = state.chats[state.activeChatId];
                        if (!chat) return;
        
                        const favoritesToAdd = [];
                        const timestampsToFavorite = [...selectedMessages];
        
                        for (const timestamp of timestampsToFavorite) {
                            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ΩøÁî®Êñ∞ÁöÑ„ÄÅÈ´òÊïàÁöÑÁ¥¢ÂºïËøõË°åÊü•ËØ¢
                            const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                            
                            if (!existing) {
                                const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                                if (messageToSave) {
                                    favoritesToAdd.push({
                                        type: 'chat_message',
                                        content: messageToSave,
                                        chatId: state.activeChatId,
                                        timestamp: Date.now(), // ËøôÊòØÊî∂ËóèÊìç‰ΩúÂèëÁîüÁöÑÊó∂Èó¥
                                        originalTimestamp: messageToSave.timestamp // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥Âà∞Êñ∞Â≠óÊÆµ
                                    });
                                }
                            }
                        }
        
                        if (favoritesToAdd.length > 0) {
                            await db.favorites.bulkAdd(favoritesToAdd);
                            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // Êõ¥Êñ∞ÂÖ®Â±ÄÊî∂ËóèÁºìÂ≠ò
                            await showCustomAlert('Êî∂ËóèÊàêÂäü', `Â∑≤ÊàêÂäüÊî∂Ëóè ${favoritesToAdd.length} Êù°Ê∂àÊÅØ„ÄÇ`);
                        } else {
                            await showCustomAlert('ÊèêÁ§∫', 'ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÂùáÂ∑≤Êî∂ËóèËøá„ÄÇ');
                        }
                        
                        exitSelectionMode();
                    });
        
                    // Êî∂ËóèÈ°µÈù¢ÁöÑ"ÁºñËæë"ÊåâÈíÆ‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
                    const favoritesEditBtn = document.getElementById('favorites-edit-btn');
                    const favoritesView = document.getElementById('favorites-view');
                    const favoritesActionBar = document.getElementById('favorites-action-bar');
                    const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è
                    const favoritesList = document.getElementById('favorites-list'); // Ëé∑ÂèñÊî∂ËóèÂàóË°®
                    
                    favoritesEditBtn.addEventListener('click', () => {
                        isFavoritesSelectionMode = !isFavoritesSelectionMode;
                        favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);
        
                        if (isFavoritesSelectionMode) {
                            // --- ËøõÂÖ•ÁºñËæëÊ®°Âºè ---
                            favoritesEditBtn.textContent = 'ÂÆåÊàê';
                            favoritesActionBar.style.display = 'block'; // ÊòæÁ§∫Âà†Èô§Êìç‰ΩúÊ†è
                            mainBottomNav.style.display = 'none'; // ‚ñº Êñ∞Â¢ûÔºöÈöêËóè‰∏ªÂØºËà™Ê†è
                            favoritesList.style.paddingBottom = '80px'; // ‚ñº Êñ∞Â¢ûÔºöÁªôÂàóË°®Â∫ïÈÉ®Â¢ûÂä†Á©∫Èó¥
                        } else {
                            // --- ÈÄÄÂá∫ÁºñËæëÊ®°Âºè ---
                            favoritesEditBtn.textContent = 'ÁºñËæë';
                            favoritesActionBar.style.display = 'none'; // ÈöêËóèÂà†Èô§Êìç‰ΩúÊ†è
                            mainBottomNav.style.display = 'flex';  // ‚ñº Êñ∞Â¢ûÔºöÊÅ¢Â§ç‰∏ªÂØºËà™Ê†è
                            favoritesList.style.paddingBottom = ''; // ‚ñº Êñ∞Â¢ûÔºöÊÅ¢Â§çÂàóË°®ÈªòËÆ§padding
        
                            // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÊâÄÊúâÈÄâÊã©
                            selectedFavorites.clear();
                            document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                            document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (0)`;
                        }
                    });
        
        // ‚ñº‚ñº‚ñº Â∞ÜÂÆÉ„ÄêÂÆåÊï¥ÊõøÊç¢„Äë‰∏∫‰∏ãÈù¢ËøôÊÆµ‰øÆÊ≠£ÂêéÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
        // Êî∂ËóèÂàóË°®ÁöÑÁÇπÂáªÈÄâÊã©‰∫ã‰ª∂ (‰∫ã‰ª∂ÂßîÊâò)
        document.getElementById('favorites-list').addEventListener('click', (e) => {
            const target = e.target;
            const card = target.closest('.favorite-item-card');
        
            // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊñáÂ≠óÂõæÁÇπÂáªÔºåËøôÊÆµÈÄªËæëË¶ÅÊîæÂú®ÊúÄÂâçÈù¢Ôºå‰øùËØÅ‰ªª‰ΩïÊ®°Âºè‰∏ãÈÉΩÁîüÊïà
            if (target.tagName === 'IMG' && target.dataset.hiddenText) {
                const hiddenText = target.dataset.hiddenText;
                showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, '\n'));
                return; // Â§ÑÁêÜÂÆåÂ∞±ÈÄÄÂá∫Ôºå‰∏çÁªßÁª≠ÊâßË°åÈÄâÊã©ÈÄªËæë
            }
            
            // Â¶ÇÊûú‰∏çÂú®ÈÄâÊã©Ê®°ÂºèÔºåÂàô‰∏çÊâßË°åÂêéÁª≠ÁöÑÈÄâÊã©Êìç‰Ωú
            if (!isFavoritesSelectionMode) return;
        
            // --- ‰ª•‰∏ãÊòØÂéüÊúâÁöÑÈÄâÊã©ÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò ---
            if (!card) return;
        
            const favId = parseInt(card.dataset.favid);
            if (isNaN(favId)) return;
        
            // ÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
            if (selectedFavorites.has(favId)) {
                selectedFavorites.delete(favId);
                card.classList.remove('selected');
            } else {
                selectedFavorites.add(favId);
                card.classList.add('selected');
            }
            
            // Êõ¥Êñ∞Â∫ïÈÉ®Âà†Èô§ÊåâÈíÆÁöÑËÆ°Êï∞
            document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (${selectedFavorites.size})`;
        });
        
        // ‚ñº‚ñº‚ñº Â∞ÜÂÆÉ„ÄêÂÆåÊï¥ÊõøÊç¢„Äë‰∏∫‰∏ãÈù¢ËøôÊÆµ‰øÆÊ≠£ÂêéÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
        // Êî∂ËóèÈ°µÈù¢ÊâπÈáèÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
            if (selectedFavorites.size === 0) return;
        
            const confirmed = await showCustomConfirm(
                'Á°ÆËÆ§Âà†Èô§', 
                `Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ§π‰∏≠ÁßªÈô§Ëøô ${selectedFavorites.size} Êù°ÂÜÖÂÆπÂêóÔºü`, 
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                const idsToDelete = [...selectedFavorites];
                await db.favorites.bulkDelete(idsToDelete);
                await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÊî∂ËóèÂ∑≤Ë¢´ÁßªÈô§„ÄÇ');
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ªéÂâçÁ´ØÁºìÂ≠ò‰∏≠‰πüÁßªÈô§Ë¢´Âà†Èô§ÁöÑÈ°π
                allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑÁºìÂ≠òÔºåÁ´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                displayFilteredFavorites(allFavoriteItems);
                
                // ÊúÄÂêéÔºåÂÜçÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                favoritesEditBtn.click(); // Ê®°ÊãüÁÇπÂáª"ÂÆåÊàê"ÊåâÈíÆÊù•ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
            }
        });
        
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞Êú´Â∞æÊ∑ªÂä† ‚ñº‚ñº‚ñº
        if (state.globalSettings.enableBackgroundActivity) {
            startBackgroundSimulation();
            console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤Ëá™Âä®ÂêØÂä®„ÄÇ");
        }
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊúÄÁªàÁöÑÊ≠£Á°Æ‰ª£Á†Å„ÄëËØ∑Á≤òË¥¥ËøôÊÆµ‰ª£Á†ÅÂà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
        
        // --- Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÂΩ±ÂìçÈ¢ÑËßàÁöÑÊéß‰ª∂ÁöÑ‰∫ã‰ª∂ ---
        
        // 1. ÁõëÂê¨‰∏ªÈ¢òÈÄâÊã©
        document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
            radio.addEventListener('change', updateSettingsPreview);
        });
        
        // 2. ÁõëÂê¨Â≠ó‰ΩìÂ§ßÂ∞èÊªëÂùó
        const fontSizeSlider = document.getElementById('font-size-slider');
        fontSizeSlider.addEventListener('input', () => {
            // a. ÂÆûÊó∂Êõ¥Êñ∞Êï∞ÂÄºÊòæÁ§∫
            document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
            // b. Êõ¥Êñ∞È¢ÑËßà
            updateSettingsPreview();
        });
        
        // 3. ÁõëÂê¨Ëá™ÂÆö‰πâCSSËæìÂÖ•Ê°Ü
        const customCssInputForPreview = document.getElementById('custom-css-input');
        customCssInputForPreview.addEventListener('input', updateSettingsPreview);
        
        // 4. ÁõëÂê¨ÈáçÁΩÆÊåâÈíÆ
        document.getElementById('reset-theme-btn').addEventListener('click', () => {
            document.getElementById('theme-default').checked = true;
            updateSettingsPreview();
        });
        
        document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
            document.getElementById('custom-css-input').value = '';
            updateSettingsPreview();
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // „ÄêËØ∑Á°Æ‰øùËøôÊÆµ‰ª£Á†ÅÂú®ÊÇ®ÁöÑ init() ÂáΩÊï∞ÂÜÖ„Äë
        document.getElementById('lyrics-vertical-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-horizontal-pos').addEventListener('change', updateSettingsPreview);
        document.getElementById('lyrics-offset-input').addEventListener('input', updateSettingsPreview);
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
        document.querySelectorAll('input[name="visibility"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const groupsContainer = document.getElementById('post-visibility-groups');
                if (this.value === 'include' || this.value === 'exclude') {
                    groupsContainer.style.display = 'block';
                } else {
                    groupsContainer.style.display = 'none';
                }
            });
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
        document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
        document.getElementById('close-group-manager-btn').addEventListener('click', () => {
            document.getElementById('group-management-modal').classList.remove('visible');
            // Âà∑Êñ∞ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÂàÜÁªÑÂàóË°®
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
               chatSettingsBtn.click(); // ÂÜçÊ¨°ÁÇπÂáª‰ª•ÈáçÊñ∞ÊâìÂºÄ
            }
        });
        
        document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
        document.getElementById('existing-groups-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const groupId = parseInt(e.target.dataset.id);
                deleteGroup(groupId);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
        // Ê∂àÊÅØÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
        // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£„Äë‰ΩøÁî®Êñ∞ÁöÑÁºñËæëÂô®ÂÖ•Âè£ ‚ñº‚ñº‚ñº
        document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);
        
        // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†Êñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµ„Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ select-message-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('select-message-btn').addEventListener('click', () => {
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ÂÖ≥Èó≠ËèúÂçïÂâçÔºåÂÖàÊçïËé∑Êó∂Èó¥Êà≥
            const timestampToSelect = activeMessageTimestamp; 
            hideMessageActions();
            // ‰ΩøÁî®ÊçïËé∑Âà∞ÁöÑÂÄº
            if (timestampToSelect) {
                enterSelectionMode(timestampToSelect);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä† ‚ñº‚ñº‚ñº
        
        // ÁõëÂê¨ËÅäÂ§©Âå∫ÂüüÁöÑÁÇπÂáªÔºå‰∏ìÈó®Áî®‰∫éÂ§ÑÁêÜAIÂèëÊù•ÁöÑËΩ¨Ë¥¶
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊòØÂê¶Âú®‰∏Ä‰∏™Ê∂àÊÅØÊ∞îÊ≥°ÂÜÖ
            const bubble = e.target.closest('.message-bubble');
            if (!bubble) return; // Â¶ÇÊûú‰∏çÂú®ÔºåÂ∞±ÈÄÄÂá∫
        
            // 2. Ê£ÄÊü•ÊòØÂê¶ÊòØAIÁöÑ„ÄÅÂæÖÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶Ê∂àÊÅØ
            if (bubble.classList.contains('ai') && 
                bubble.classList.contains('is-transfer') && 
                bubble.dataset.status === 'pending') {
                
                // 3. Âè™ÊúâÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂ÔºåÊâçÊòæÁ§∫Êìç‰ΩúËèúÂçï
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        
        // ÁªëÂÆöÊñ∞ËΩ¨Ë¥¶Êìç‰ΩúÊ®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ
        document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
        document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
        document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
        
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æÊ∑ªÂä† ‚ñº‚ñº‚ñº
        
        // Âä®ÊÄÅÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
        document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
        document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);
        
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
            showScreen('chat-list-screen');
        });
        
        document.getElementById('contact-picker-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (!item) return;
        
            const contactId = item.dataset.contactId;
            item.classList.toggle('selected');
            
            if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
            } else {
                selectedContacts.add(contactId);
            }
            updateContactPickerConfirmButton();
        });
        
        // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÁªëÂÆö‚ÄúÁÆ°ÁêÜÁæ§ÊàêÂëò‚ÄùÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('manage-members-btn').addEventListener('click', () => {
            // Âú®ÂàáÊç¢Â±èÂπïÂâçÔºåÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó
            //document.getElementById('chat-settings-modal').classList.remove('visible');
            // ÁÑ∂ÂêéÂÜçÊâìÂºÄÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
            openMemberManagementScreen();
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàÂÆåÊï¥Áâà„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('back-from-member-management').addEventListener('click', () => {
        
            showScreen('chat-interface-screen');    
            document.getElementById('chat-settings-btn').click();
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        document.getElementById('member-management-list').addEventListener('click', (e) => {
            // „ÄêÂ∑≤ÊÅ¢Â§ç„ÄëÁßªÈô§ÊàêÂëòÁöÑ‰∫ã‰ª∂
            if (e.target.classList.contains('remove-member-btn')) {
                removeMemberFromGroup(e.target.dataset.memberId);
            }
        });
        
        document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
            // „ÄêÂ∑≤ÊÅ¢Â§ç„Äë‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†ÁöÑ‰∫ã‰ª∂
            // „ÄêÂÖ≥ÈîÆ„Äë‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁªëÂÆö‚ÄúÊãâ‰∫∫ÂÖ•Áæ§‚ÄùÁöÑÈÄªËæë
            const confirmBtn = document.getElementById('confirm-contact-picker-btn');
            // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊñπÊ≥ïÊ∏ÖÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
            
            await openContactPickerForAddMember();
        });
        
        document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        // ÁªëÂÆöÂçïËÅäÂíåÁæ§ËÅäÁöÑÂèëËµ∑ÊåâÈíÆ
        document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
        document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);
        
        // ÁªëÂÆö‚ÄúÊåÇÊñ≠‚ÄùÊåâÈíÆ
        document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);
        
        // ÁªëÂÆö‚ÄúÂèñÊ∂àÂëºÂè´‚ÄùÊåâÈíÆ
        document.getElementById('cancel-call-btn').addEventListener('click', () => {
            videoCallState.isAwaitingResponse = false;
            showScreen('chat-interface-screen');
        });
        
        // „ÄêÂÖ®Êñ∞„ÄëÁªëÂÆö‚ÄúÂä†ÂÖ•ÈÄöËØù‚ÄùÊåâÈíÆ
        document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÂπ∂ÊøÄÊ¥ªÊóÅËßÇÊ®°Âºè„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ÊóßÁöÑ decline-call-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊãíÁªù‚ÄùÊåâÈíÆ
        document.getElementById('decline-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            const chat = state.chats[videoCallState.activeChatId];
            if (!chat) return;
            
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞ÜÊãíÁªùÁöÑÈÄªËæë‰∏éAPIË∞ÉÁî®ËøûÊé•Ëµ∑Êù•
            if (videoCallState.isGroupCall) {
                videoCallState.isUserParticipating = false; // Ê†áËÆ∞Áî®Êà∑‰∏∫ÊóÅËßÇËÄÖ
                
                // 1. ÂàõÂª∫‰∏ÄÊù°ÈöêËóèÊ∂àÊÅØÔºåÈÄöÁü•AIÁî®Êà∑ÊãíÁªù‰∫Ü
                const systemNote = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊãíÁªù‰∫ÜÈÄöËØùÈÇÄËØ∑Ôºå‰ΩÜ‰Ω†‰ª¨ÂèØ‰ª•Ëá™Â∑±ÂºÄÂßã„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÊòØÂê¶Âä†ÂÖ•„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(systemNote);
                await db.chats.put(chat);
                
                // 2. „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉ‰ª¨Ëá™Â∑±ÂÜ≥ÂÆöË¶Å‰∏çË¶ÅÂºÄÂßãÁæ§ËÅä
                // ËøôÂ∞Ü‰ºöÂú®ÂêéÂè∞Â§ÑÁêÜÔºåÂ¶ÇÊûúAI‰ª¨ÂÜ≥ÂÆöÂºÄÂßãÔºåÊúÄÁªà‰ºöË∞ÉÁî® startVideoCall()
                await triggerAiResponse(); 
                
            } else { // ÂçïËÅäÊãíÁªùÈÄªËæë‰øùÊåÅ‰∏çÂèò
                const declineMessage = { role: 'user', content: 'ÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                chat.history.push(declineMessage);
                await db.chats.put(chat);
                
                // ÂõûÂà∞ËÅäÂ§©ÁïåÈù¢Âπ∂ÊòæÁ§∫ÊãíÁªùÊ∂àÊÅØ
                showScreen('chat-interface-screen');
                appendMessage(declineMessage, chat);
                
                // ËÆ©AIÂØπ‰Ω†ÁöÑÊãíÁªùÂÅöÂá∫ÂõûÂ∫î
                triggerAiResponse();
            }
            
            // Ê∏ÖÁêÜÁä∂ÊÄÅÔºå‰ª•Èò≤‰∏á‰∏Ä
            videoCallState.isAwaitingResponse = false;
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈáçÂ§çÂ§¥ÂÉèBUG„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ÊóßÁöÑ accept-call-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊé•Âê¨‚ÄùÊåâÈíÆ
        document.getElementById('accept-call-btn').addEventListener('click', async () => {
            hideIncomingCallModal();
            
            videoCallState.initiator = 'ai';
            videoCallState.isUserParticipating = true;
            videoCallState.activeChatId = state.activeChatId;
            
            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÊâãÂä®Ê∑ªÂä†Áî®Êà∑Âà∞ participants ÂàóË°®
            if (videoCallState.isGroupCall) {
                // ÂØπ‰∫éÁæ§ËÅäÔºåÊàë‰ª¨Âè™Êää„ÄêÂèëËµ∑ÈÄöËØùÁöÑAI„ÄëÂä†ÂÖ•ÂèÇ‰∏éËÄÖÂàóË°®
                const chat = state.chats[videoCallState.activeChatId];
                const requester = chat.members.find(m => m.name === videoCallState.callRequester);
                if (requester) {
                    // Ê∏ÖÁ©∫ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÊï∞ÊçÆÔºåÁÑ∂ÂêéÂè™Ê∑ªÂä†ÂèëËµ∑ËÄÖ
                    videoCallState.participants = [requester];
                } else {
                    videoCallState.participants = []; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂèëËµ∑ËÄÖÔºåÂ∞±Ê∏ÖÁ©∫
                }
            }
            
            // Êó†ËÆ∫ÂçïËÅäËøòÊòØÁæ§ËÅäÔºåÁõ¥Êé•ÂêØÂä®ÈÄöËØùÁïåÈù¢ÔºÅ
            startVideoCall();
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤Â¢ûÂä†Áî®Êà∑È´ò‰∫Æ„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ user-speak-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // ÁªëÂÆöÁî®Êà∑Âú®ÈÄöËØù‰∏≠ÂèëË®ÄÁöÑÊåâÈíÆ
        document.getElementById('user-speak-btn').addEventListener('click', async () => {
            if (!videoCallState.isActive) return;
        
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÂú®ÂºπÂá∫ËæìÂÖ•Ê°ÜÂâçÔºåÂÖàÊâæÂà∞Âπ∂È´ò‰∫ÆÁî®Êà∑Â§¥ÂÉè ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
            if (userAvatar) {
                userAvatar.classList.add('speaking');
            }
        
            const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');
            
            // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÊó†ËÆ∫Áî®Êà∑ÊòØÂê¶ËæìÂÖ•ÔºåÂè™Ë¶ÅÂÖ≥Èó≠ËæìÂÖ•Ê°ÜÂ∞±ÁßªÈô§È´ò‰∫Æ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
            if (userAvatar) {
                userAvatar.classList.remove('speaking');
            }
        
            if (userInput && userInput.trim()) {
                triggerAiInCallAction(userInput.trim());
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÂõûÂøÜÂΩïÁõ∏ÂÖ≥‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        // 1. Â∞Ü‚ÄúÂõûÂøÜ‚ÄùÈ°µÁ≠æÂíåÂÆÉÁöÑËßÜÂõæËøûÊé•Ëµ∑Êù•
        document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
            // Âú®ÂàáÊç¢ÂâçÔºåÁ°Æ‰øù"Êî∂Ëóè"È°µÈù¢ÁöÑÁºñËæëÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠
            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }
            switchToChatListView('memories-view');
            renderMemoriesScreen(); // ÁÇπÂáªÊó∂Ê∏≤Êüì
        });
        
        // 2. ÁªëÂÆöÂõûÂøÜÂΩïÁïåÈù¢ÁöÑËøîÂõûÊåâÈíÆ
        document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊâæÂà∞Ëøô‰∏™ÊåâÈíÆÁöÑÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
            const title = document.getElementById('countdown-title-input').value.trim();
            const dateValue = document.getElementById('countdown-date-input').value;
            
            if (!title || !dateValue) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁ∫¶ÂÆöÊ†áÈ¢òÂíåÊó•ÊúüÔºÅ');
                return;
            }
        
            const targetDate = new Date(dateValue);
            if (isNaN(targetDate) || targetDate <= new Date()) {
                alert('ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑ„ÄÅÊú™Êù•ÁöÑÊó•ÊúüÔºÅ');
                return;
            }
        
            // ‚ñº‚ñº‚ñº Â∞ÜÂÖ∂„ÄêÊõøÊç¢‰∏∫„Äë‰∏ãÈù¢ËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„Äë‚ñº‚ñº‚ñº
            const newCountdown = {
                authorId: 'user', // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„Äë‰∏çÂÜçÂ≠ò authorNameÔºåËÄåÊòØÁî® 'user' ‰Ωú‰∏∫ÊÇ®ÁöÑ‰∏ìÂ±ûID
                description: title,
                timestamp: Date.now(),
                type: 'countdown',
                targetDate: targetDate.getTime()
            };
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            
            await db.memories.add(newCountdown);
            document.getElementById('create-countdown-modal').classList.remove('visible');
            renderMemoriesScreen();
        });
        
        // „ÄêÂÖ®Êñ∞„ÄëÊãâÈªëÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö
        document.getElementById('block-chat-btn').addEventListener('click', async () => {
            if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
        
            const chat = state.chats[state.activeChatId];
            const confirmed = await showCustomConfirm(
                'Á°ÆËÆ§ÊãâÈªë', 
                `Á°ÆÂÆöË¶ÅÊãâÈªë‚Äú${chat.name}‚ÄùÂêóÔºüÊãâÈªëÂêéÊÇ®Â∞ÜÊó†Ê≥ïÂêëÂÖ∂ÂèëÈÄÅÊ∂àÊÅØÔºåÁõ¥Âà∞ÊÇ®Â∞ÜTaÁßªÂá∫ÈªëÂêçÂçïÔºåÊàñÁ≠âÂæÖTaÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ`,
                { confirmButtonClass: 'btn-danger' }
            );
        
            if (confirmed) {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
        
                // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†‰∏ãÈù¢ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
                const hiddenMessage = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöË¢´Áî®Êà∑ÊãâÈªë‰∫Ü„ÄÇÂú®ÂØπÊñπËß£Èô§ÊãâÈªë‰πãÂâçÔºå‰Ω†Êó†Ê≥ïÂÜç‰∏ªÂä®ÂèëËµ∑ÂØπËØùÔºå‰πüÊó†Ê≥ïÂõûÂ∫î„ÄÇ]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                await db.chats.put(chat);
                
                // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™óÔºåÂπ∂Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                document.getElementById('chat-settings-modal').classList.remove('visible');
                renderChatInterface(state.activeChatId);
                // Âà∑Êñ∞ËÅäÂ§©ÂàóË°®ÔºåÂèØËÉΩ‰ºöÊúâUIÂèòÂåñ
                renderChatList();
            }
        });
        
        document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
        
            if (e.target.id === 'force-apply-check-btn') {
                alert("Ê≠£Âú®ÊâãÂä®Ëß¶ÂèëÂ•ΩÂèãÁî≥ËØ∑ÊµÅÁ®ãÔºåËØ∑Á®çÂêé...\nÂ¶ÇÊûúAPIË∞ÉÁî®ÊàêÂäüÔºåÂ∞ÜÂºπÂá∫ÊèêÁ§∫„ÄÇÂ¶ÇÊûúÂ§±Ë¥•Ôºå‰πü‰ºöÊúâÈîôËØØÊèêÁ§∫„ÄÇÂ¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂèçÂ∫îÔºåËØ¥ÊòéAIÂèØËÉΩÂÜ≥ÂÆöÊöÇÊó∂‰∏çÁî≥ËØ∑„ÄÇ");
                await triggerAiFriendApplication(chat.id);
                renderChatInterface(chat.id); 
                return;
            }
        
            if (e.target.id === 'unblock-btn') {
                chat.relationship.status = 'friend';
                chat.relationship.blockedTimestamp = null;
        
                // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†‰∏ãÈù¢ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
                const hiddenMessage = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöËß£Èô§‰∫ÜÂØπ‰Ω†ÁöÑÊãâÈªë„ÄÇÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•ÈáçÊñ∞ÂºÄÂßãÂØπËØù‰∫Ü„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(hiddenMessage);
                // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                await db.chats.put(chat);
                renderChatInterface(chat.id);
                renderChatList();
                triggerAiResponse(); // „ÄêÂèØÈÄâ‰ΩÜÊé®Ëçê„ÄëËß£Èô§ÂêéËÆ©AI‰∏ªÂä®ËØ¥ÁÇπ‰ªÄ‰πà
            }
        else if (e.target.id === 'accept-friend-btn') {
                // 1. Ê†∏ÂøÉ‰øÆÊ≠£Ôºö‰∏çÂÜçËß¶ÂèëAIÂìçÂ∫îÔºåÈÅøÂÖçÈÄªËæëÊ∑∑‰π±
                // triggerAiResponse(); // <-- Âà†Èô§ÊàñÊ≥®ÈáäÊéâËøô‰∏ÄË°å
        
                // 2. Áõ¥Êé•Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ
                chat.relationship.status = 'friend';
                chat.relationship.applicationReason = '';
        
                // 3. Êñ∞Â¢ûÔºöÁõ¥Êé•Âú®ÂâçÁ´ØÁîüÊàê‰∏ÄÊù°ÂØπÁî®Êà∑ÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•Êìç‰ΩúÊàêÂäü
                const systemMessage = {
                    role: 'system',
                    type: 'pat_message', // Â§çÁî®Â±Ö‰∏≠Ê†∑Âºè
                    content: `‰Ω†ÈÄöËøá‰∫Ü‚Äú${chat.name}‚ÄùÁöÑÂ•ΩÂèãËØ∑Ê±Ç`,
                    timestamp: Date.now()
                };
                chat.history.push(systemMessage);
        
                // 4. Êñ∞Â¢ûÔºöÊ®°ÊãüAIÂèëÊù•‰∏ÄÊù°Ëá™ÁÑ∂ÁöÑÊ¨¢ËøéÊ∂àÊÅØÔºåËÆ©‰∫§‰∫íÊõ¥ÊµÅÁïÖ
                const welcomeMessage = {
                    role: 'assistant',
                    senderName: chat.name,
                    content: 'Â§™Â•Ω‰∫ÜÔºÅÊàë‰ª¨ÂèàÂèØ‰ª•ËÅäÂ§©Âï¶ÔºÅ',
                    timestamp: Date.now() + 1 // Êó∂Èó¥Êà≥+1Á°Æ‰øùÂú®Á≥ªÁªüÊ∂àÊÅØ‰πãÂêé
                };
                chat.history.push(welcomeMessage);
        
                // 5. ‰∏ÄÊ¨°ÊÄßÂ∞ÜÊâÄÊúâÊõ¥Êîπ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);
        
                // 6. Âà∑Êñ∞UIÔºåÊòæÁ§∫ÊúÄÊñ∞ÁöÑÁä∂ÊÄÅÂíåÊ∂àÊÅØ
                renderChatInterface(chat.id);
                renderChatList();
            }
            else if (e.target.id === 'reject-friend-btn') {
                chat.relationship.status = 'blocked_by_user';
                chat.relationship.blockedTimestamp = Date.now();
                chat.relationship.applicationReason = '';
                await db.chats.put(chat);
                renderChatInterface(chat.id);
            }
            // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁî≥ËØ∑Â•ΩÂèãÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            else if (e.target.id === 'apply-friend-btn') {
                const reason = await showCustomPrompt(
                    'ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑', 
                    `ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÂØπ‚Äú${chat.name}‚ÄùËØ¥ÁöÑÁî≥ËØ∑ÁêÜÁî±Ôºö`,
                    "Êàë‰ª¨ÂíåÂ•ΩÂêßÔºÅ"
                );
                // Âè™ÊúâÂΩìÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‚ÄúÁ°ÆÂÆö‚ÄùÂêéÊâçÁªßÁª≠
                if (reason !== null) {
                    // Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ‰∏∫‚ÄúÁ≠âÂæÖAIÊâπÂáÜ‚Äù
                    chat.relationship.status = 'pending_ai_approval';
                    chat.relationship.applicationReason = reason;
                    await db.chats.put(chat);
        
                    // Âà∑Êñ∞UIÔºåÊòæÁ§∫‚ÄúÁ≠âÂæÖÈÄöËøá‚ÄùÁöÑÁïåÈù¢
                    renderChatInterface(chat.id);
                    renderChatList();
                    
                    // „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉÂéªÂ§ÑÁêÜËøô‰∏™Â•ΩÂèãÁî≥ËØ∑
                    triggerAiResponse();
                }
            }
        });
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        
        // 1. Â∞ÜÂéüÊúâÁöÑËΩ¨Ë¥¶ÊåâÈíÆ(Ôø•)ÁöÑÁÇπÂáª‰∫ã‰ª∂ÔºåÈáçÂÆöÂêëÂà∞Êñ∞ÁöÑÊÄªÂÖ•Âè£ÂáΩÊï∞
        document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);
        
        // 2. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÂÜÖÈÉ®ÁöÑÊéßÂà∂ÊåâÈíÆ
        document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
            document.getElementById('red-packet-modal').classList.remove('visible');
        });
        document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
        document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);
        
        // 3. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÁöÑÈ°µÁ≠æÂàáÊç¢ÈÄªËæë
        const rpTabGroup = document.getElementById('rp-tab-group');
        const rpTabDirect = document.getElementById('rp-tab-direct');
        const rpContentGroup = document.getElementById('rp-content-group');
        const rpContentDirect = document.getElementById('rp-content-direct');
        
        rpTabGroup.addEventListener('click', () => {
            rpTabGroup.classList.add('active');
            rpTabDirect.classList.remove('active');
            rpContentGroup.style.display = 'block';
            rpContentDirect.style.display = 'none';
        });
        rpTabDirect.addEventListener('click', () => {
            rpTabDirect.classList.add('active');
            rpTabGroup.classList.remove('active');
            rpContentDirect.style.display = 'block';
            rpContentGroup.style.display = 'none';
        });
        
        // 4. ÂÆûÊó∂Êõ¥Êñ∞Á∫¢ÂåÖÈáëÈ¢ùÊòæÁ§∫
        document.getElementById('rp-group-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-group-total').textContent = `¬• ${amount.toFixed(2)}`;
        });
        document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            document.getElementById('rp-direct-total').textContent = `¬• ${amount.toFixed(2)}`;
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„Äë‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÁ∫¢ÂåÖÁÇπÂáªÔºå‰øÆÂ§çÂ§±ÊïàÈóÆÈ¢ò ‚ñº‚ñº‚ñº
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. ÊâæÂà∞Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÂç°Áâá
            const packetCard = e.target.closest('.red-packet-card');
            if (!packetCard) return; // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÁ∫¢ÂåÖÔºåÂ∞±‰ªÄ‰πà‰πü‰∏çÂÅö
        
            // 2. ‰ªéÁ∫¢ÂåÖÂç°ÁâáÁöÑÁà∂Á∫ß.message-bubbleËé∑ÂèñÊó∂Èó¥Êà≥
            const messageBubble = packetCard.closest('.message-bubble');
            if (!messageBubble || !messageBubble.dataset.timestamp) return;
        
            // 3. Ë∞ÉÁî®Êàë‰ª¨Áé∞ÊúâÁöÑÂ§ÑÁêÜÂáΩÊï∞
            const timestamp = parseInt(messageBubble.dataset.timestamp);
            handlePacketClick(timestamp);
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // Âú®ËæìÂÖ•Ê°ÜÂ∑•ÂÖ∑Ê†èÊ∑ªÂä†ÊåâÈíÆ
        document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);
        
        // ÊäïÁ•®ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ
        document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
        document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
            document.getElementById('create-poll-modal').classList.remove('visible');
        });
        document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);
        
        // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÊäïÁ•®Âç°ÁâáÂÜÖÁöÑÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            const pollCard = e.target.closest('.poll-card');
            if (!pollCard) return;
        
            const timestamp = parseInt(pollCard.dataset.pollTimestamp);
            if (isNaN(timestamp)) return;
            
            // ÁÇπÂáª‰∫ÜÈÄâÈ°π
            const optionItem = e.target.closest('.poll-option-item');
            if (optionItem && !pollCard.classList.contains('closed')) {
                handleUserVote(timestamp, optionItem.dataset.option);
                return;
            }
            
            // ÁÇπÂáª‰∫ÜÂä®‰ΩúÊåâÈíÆÔºàÁªìÊùüÊäïÁ•®/Êü•ÁúãÁªìÊûúÔºâ
            const actionBtn = e.target.closest('.poll-action-btn');
            if (actionBtn) {
                if (pollCard.classList.contains('closed')) {
                    showPollResults(timestamp);
                } else {
                    endPoll(timestamp);
                }
                return;
            }
        
            // Â¶ÇÊûúÊòØÂ∑≤ÁªìÊùüÁöÑÊäïÁ•®ÔºåÁÇπÂáªÂç°Áâá‰ªª‰ΩïÂú∞ÊñπÈÉΩÂèØ‰ª•Êü•ÁúãÁªìÊûú
            if (pollCard.classList.contains('closed')) {
                showPollResults(timestamp);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰∫ã‰ª∂ÁõëÂê¨Âô®Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
          // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëAIÂ§¥ÂÉèÂ∫ìÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫ÊâπÈáèÂØºÂÖ•ÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        // ÁªëÂÆöAIÂ§¥ÂÉèÂ∫ìÁöÑ‚ÄúÊâπÈáè‚ÄùÊåâÈíÆ
        document.getElementById('add-ai-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('ai'));
        
        // ÁªëÂÆöÁæ§Â§¥ÂÉèÂ∫ìÁöÑ‚ÄúÊâπÈáè‚ÄùÊåâÈíÆ
        document.getElementById('add-group-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('group'));
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ add-ai-avatar-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        // ÁªëÂÆö‚ÄúURL‚ÄùÊåâÈíÆÔºåË∞ÉÁî®Êàë‰ª¨ÂàöÂàöÈáçÂëΩÂêçÁöÑÂáΩÊï∞
        document.getElementById('add-ai-avatar-url-btn').addEventListener('click', addAvatarToLibraryFromURL);
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÁªëÂÆö‚Äú‰∏ä‰º†‚ÄùÊåâÈíÆÔºåËß¶ÂèëÈöêËóèÁöÑÊñá‰ª∂ÈÄâÊã©Âô®
        document.getElementById('add-ai-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('ai-avatar-upload-input').click();
        });
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫Êñá‰ª∂ÈÄâÊã©Âô®ÁªëÂÆö change ‰∫ã‰ª∂ÔºåËøôÊòØÂ§ÑÁêÜ‰∏ä‰º†ÁöÑÊ†∏ÂøÉÂÖ•Âè£
        document.getElementById('ai-avatar-upload-input').addEventListener('change', handleLocalAvatarUpload);
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§Â§¥ÂÉèÂ∫ìÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('manage-group-avatar-library-btn').addEventListener('click', openGroupAvatarLibraryModal);
        // ‚ñº‚ñº‚ñº „ÄêËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ add-group-avatar-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        // ÁªëÂÆö‚ÄúURL‚ÄùÊåâÈíÆÔºåË∞ÉÁî®Êàë‰ª¨ÂàöÂàöÈáçÂëΩÂêçÁöÑÂáΩÊï∞
        document.getElementById('add-group-avatar-url-btn').addEventListener('click', addAvatarToGroupLibraryFromURL);
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÁªëÂÆö‚Äú‰∏ä‰º†‚ÄùÊåâÈíÆÔºåËß¶ÂèëÈöêËóèÁöÑÊñá‰ª∂ÈÄâÊã©Âô®
        document.getElementById('add-group-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('group-avatar-upload-input').click();
        });
        
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫Êñá‰ª∂ÈÄâÊã©Âô®ÁªëÂÆö change ‰∫ã‰ª∂ÔºåËøôÊòØÂ§ÑÁêÜ‰∏ä‰º†ÁöÑÊ†∏ÂøÉÂÖ•Âè£
        document.getElementById('group-avatar-upload-input').addEventListener('change', handleLocalGroupAvatarUpload);
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        document.getElementById('close-group-avatar-library-btn').addEventListener('click', closeGroupAvatarLibraryModal);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ≠ó‰ΩìÊâπÈáèÂØºÂÖ•ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('batch-import-fonts-btn').addEventListener('click', openFontBatchImportModal);
        document.getElementById('cancel-font-batch-import-btn').addEventListener('click', closeFontBatchImportModal);
        document.getElementById('confirm-font-batch-import-btn').addEventListener('click', handleFontBatchImport);
        // ‚ñ≤‚ñ≤‚ñ≤ Â≠ó‰ΩìÊâπÈáèÂØºÂÖ•‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ≠ó‰ΩìËÆæÁΩÆÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('save-font-btn').addEventListener('click', saveCustomFont);
        document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);
        document.getElementById('font-url-input').addEventListener('input', previewCustomFont);
        // ‚ñ≤‚ñ≤‚ñ≤ Â≠ó‰ΩìËÆæÁΩÆÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëJSONÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('export-json-btn').addEventListener('click', exportJsonBeautification);
        document.getElementById('import-json-btn').addEventListener('click', importJsonBeautification);
        // ‚ñ≤‚ñ≤‚ñ≤ JSONÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âå∫ÂüüÔºåÁ≤òË¥¥ËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„Äë‚ñº‚ñº‚ñº
        document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÊõ¥Êç¢ÊåâÈíÆÊàñÂõæÁâáÊú¨Ë∫´
            if (e.target.classList.contains('change-icon-btn') || e.target.classList.contains('icon-preview')) {
                const item = e.target.closest('.icon-setting-item');
                const iconId = item.dataset.iconId;
                if (!iconId) return;
        
                // ÂàõÂª∫Êñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                
                // Ê∑ªÂä†Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨Âô®
                fileInput.addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                        if (!file.type.startsWith('image/')) {
                            alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºÅ');
                            return;
                        }
                        
                        // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫5MBÔºâ
                        if (file.size > 5 * 1024 * 1024) {
                            alert('ÂõæÁâáÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MBÔºÅ');
                            return;
                        }
                        
                        try {
                            // Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫base64
                            const base64 = await fileToBase64(file);
                            
                            // Êõ¥Êñ∞ÂõæÊ†á
                            state.globalSettings.appIcons[iconId] = base64;
                            item.querySelector('.icon-preview').src = base64;
                            
                            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                            await showCustomAlert('ÊàêÂäü', `Â∑≤Êõ¥Êç¢"${item.querySelector('.icon-preview').alt}"ÂõæÊ†áÔºÅ`);
                            
                        } catch (error) {
                            console.error('Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•:', error);
                            alert('Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                        }
                    }
                    
                    // Ê∏ÖÁêÜÊñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†
                    document.body.removeChild(fileInput);
                });
                
                // Â∞ÜÊñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†Ê∑ªÂä†Âà∞È°µÈù¢Âπ∂Ëß¶ÂèëÁÇπÂáª
                document.body.appendChild(fileInput);
                fileInput.click();
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑÊú´Â∞æÔºåÁ≤òË¥¥ËøôÊÆµ„ÄêÂÖ®Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®„Äë ‚ñº‚ñº‚ñº
        
            document.getElementById('chat-messages').addEventListener('click', (e) => {
                // ‰ΩøÁî® .closest() Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂç°Áâá
                const linkCard = e.target.closest('.link-share-card');
                if (linkCard) {
                    const timestamp = parseInt(linkCard.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        openBrowser(timestamp); // Ë∞ÉÁî®Êàë‰ª¨ÁöÑÂáΩÊï∞
                    }
                }
            });
        
            // ÊµèËßàÂô®ËøîÂõûÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨ÔºåÁ°Æ‰øùÂÆÉÂè™ÁªëÂÆö‰∏ÄÊ¨°
            document.getElementById('browser-back-btn').addEventListener('click', () => {
                showScreen('chat-interface-screen');
            });
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊñ∞‰ª£Á†ÅÂùó„ÄëÊõøÊç¢ÊóßÁöÑ qzoneStickerPanelState.panelEl.addEventListener ‚ñº‚ñº‚ñº
        qzoneStickerPanelState.panelEl.addEventListener('click', async (e) => {
            const stickerItem = e.target.closest('.sticker-item');
            if (stickerItem && qzoneStickerPanelState.activePostId !== null) {
                // ‰ªéËÉåÊôØÂõæÁâáÊ†∑Âºè‰∏≠ÊèêÂèñURL
                const stickerUrl = stickerItem.style.backgroundImage.slice(5, -2);
                
                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊ†πÊçÆURL‰ªéÂÖ®Â±ÄË°®ÊÉÖÁä∂ÊÄÅ‰∏≠ÊâæÂà∞ÂÆåÊï¥ÁöÑË°®ÊÉÖÂØπË±°
                const stickerObject = state.userStickers.find(s => s.url === stickerUrl);
        
                if (stickerObject) {
                    // Â∞ÜÂÆåÊï¥ÁöÑË°®ÊÉÖÂØπË±°‰º†ÈÄíÁªôÂ§ÑÁêÜÂáΩÊï∞
                    await sendQzoneStickerComment(qzoneStickerPanelState.activePostId, stickerObject);
                } else {
                    console.warn("Âú®Âä®ÊÄÅËØÑËÆ∫Âå∫ÁÇπÂáª‰∫ÜË°®ÊÉÖÔºå‰ΩÜÂú®Ë°®ÊÉÖÂ∫ì‰∏≠Êú™ÊâæÂà∞ÂØπË±°:", stickerUrl);
                }
            }
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // „ÄêÂÖ®Êñ∞„ÄëÂÖ®Â±ÄÁÇπÂáªÁõëÂê¨ÔºåÁî®‰∫éÂÖ≥Èó≠ÊâìÂºÄÁöÑË°®ÊÉÖÈù¢Êùø
        document.addEventListener('click', (e) => {
            if (qzoneStickerPanelState.isOpen && 
                !qzoneStickerPanelState.panelEl.contains(e.target) && 
                !e.target.closest('.comment-sticker-btn')) {
                closeQzoneStickerPanel();
            }
        });
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑÊú´Â∞æÔºåÁ≤òË¥¥ËøôÊÆµ„ÄêÂÖ®Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®„Äë ‚ñº‚ñº‚ñº
        
            // 1. ÁªëÂÆöËæìÂÖ•Ê°Ü‰∏äÊñπ‚ÄúÂàÜ‰∫´ÈìæÊé•‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);
        
            // 2. ÁªëÂÆöÊ®°ÊÄÅÊ°Ü‰∏≠‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
                document.getElementById('share-link-modal').classList.remove('visible');
            });
        
            // 3. ÁªëÂÆöÊ®°ÊÄÅÊ°Ü‰∏≠‚ÄúÂàÜ‰∫´‚ÄùÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
        
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥‰∏ãÈù¢ËøôÂá†Ë°å ‚ñº‚ñº‚ñº
        // ÁªëÂÆöÊ∂àÊÅØÊìç‰ΩúËèúÂçï‰∏≠ÁöÑ‚ÄúÂºïÁî®‚ÄùÊåâÈíÆ
        document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
        
        // ÁªëÂÆöÂõûÂ§çÈ¢ÑËßàÊ†è‰∏≠ÁöÑ‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆ
        document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
        // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†ËøôË°å‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('share-location-btn').addEventListener('click', sendLocationShare);
        // Âú®‰Ω†ÁöÑ init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫Âüü...
        
        // ‚ñº‚ñº‚ñº Áî®ËøôÊÆµ‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑËΩ¨Ë¥¶Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊòØÂê¶Âú®‰∏Ä‰∏™Ê∂àÊÅØÊ∞îÊ≥°ÂÜÖ
            const bubble = e.target.closest('.message-bubble');
            if (!bubble) return; // Â¶ÇÊûú‰∏çÂú®ÔºåÂ∞±ÈÄÄÂá∫
        
            // 2. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÊ∑ªÂä†‰∏•Ê†ºÁöÑÁ≠õÈÄâÊù°‰ª∂
            // ÂøÖÈ°ªÊòØ AI ÁöÑÊ∂àÊÅØ (.ai)
            // ÂøÖÈ°ªÊòØËΩ¨Ë¥¶Á±ªÂûã (.is-transfer)
            // ÂøÖÈ°ªÊòØÊàë‰ª¨Ê†áËÆ∞‰∏∫‚ÄúÂæÖÂ§ÑÁêÜ‚ÄùÁöÑ (data-status="pending")
            if (bubble.classList.contains('ai') && 
                bubble.classList.contains('is-transfer') && 
                bubble.dataset.status === 'pending') {
                
                // 3. Âè™ÊúâÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂ÔºåÊâçÊâßË°åÂêéÁª≠ÈÄªËæë
                const timestamp = parseInt(bubble.dataset.timestamp);
                if (!isNaN(timestamp)) {
                    showTransferActionModal(timestamp);
                }
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âå∫ÂüüÊ∑ªÂä†
        document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
        document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
        document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
        
        // ‚ñº‚ñº‚ñº Áî®ËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑÈÄöËØùËÆ∞ÂΩï‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        
        document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);
        
        // 2. ÁªëÂÆöÈÄöËØùËÆ∞ÂΩïÈ°µÈù¢ÁöÑ‚ÄúËøîÂõû‚ÄùÊåâÈíÆ
        document.getElementById('call-history-back-btn').addEventListener('click', () => {
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëËøîÂõûÂà∞ËÅäÂ§©ÂàóË°®È°µÈù¢ÔºåËÄå‰∏çÊòØËÅäÂ§©ÁïåÈù¢
            showScreen('chat-list-screen');
        });
        
        // 3. ÁõëÂê¨Âç°ÁâáÁÇπÂáªÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
        document.getElementById('call-history-list').addEventListener('click', (e) => {
            const card = e.target.closest('.call-record-card');
            if (card && card.dataset.recordId) {
                showCallTranscript(parseInt(card.dataset.recordId));
            }
        });
        
        // 4. ÂÖ≥Èó≠ËØ¶ÊÉÖÂºπÁ™óÁöÑÈÄªËæë‰øùÊåÅ‰∏çÂèò
        document.getElementById('close-transcript-modal-btn').addEventListener('click', () => {
            document.getElementById('call-transcript-modal').classList.remove('visible');
        });
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // 1. Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØËØ≠Èü≥Êù°
            const voiceBody = e.target.closest('.voice-message-body');
            if (!voiceBody) return;
        
            // 2. ÊâæÂà∞Áõ∏ÂÖ≥ÁöÑDOMÂÖÉÁ¥†
            const bubble = voiceBody.closest('.message-bubble');
            if (!bubble) return;
            
            const spinner = voiceBody.querySelector('.loading-spinner');
            const transcriptEl = bubble.querySelector('.voice-transcript');
        
            // Â¶ÇÊûúÊ≠£Âú®Âä†ËΩΩ‰∏≠ÔºåÂàô‰∏çÂìçÂ∫îÁÇπÂáª
            if (bubble.dataset.state === 'loading') {
                return;
            }
        
            // 3. Â¶ÇÊûúÊñáÂ≠óÂ∑≤ÁªèÂ±ïÂºÄÔºåÂàôÊî∂Ëµ∑
            if (bubble.dataset.state === 'expanded') {
                transcriptEl.style.display = 'none';
                bubble.dataset.state = 'collapsed';
            } 
            // 4. Â¶ÇÊûúÊòØÊî∂Ëµ∑Áä∂ÊÄÅÔºåÂàôÂºÄÂßã‚ÄúËΩ¨ÂΩï‚ÄùÊµÅÁ®ã
            else {
                bubble.dataset.state = 'loading'; // ËøõÂÖ•Âä†ËΩΩÁä∂ÊÄÅ
                spinner.style.display = 'block';   // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
        
                // Ê®°Êãü1.5ÁßíÁöÑËØ≠Èü≥ËØÜÂà´ËøáÁ®ã
                setTimeout(() => {
                    // Ê£ÄÊü•Ê≠§Êó∂ÂÖÉÁ¥†ÊòØÂê¶ËøòÂ≠òÂú®ÔºàÂèØËÉΩÁî®Êà∑Â∑≤ÁªèÂàáÊç¢‰∫ÜËÅäÂ§©Ôºâ
                    if (document.body.contains(bubble)) {
                        const voiceText = bubble.dataset.voiceText || '(Êó†Ê≥ïËØÜÂà´)';
                        transcriptEl.textContent = voiceText; // Â°´ÂÖÖÊñáÂ≠ó
                        
                        spinner.style.display = 'none';      // ÈöêËóèÂä†ËΩΩÂä®Áîª
                        transcriptEl.style.display = 'block';// ÊòæÁ§∫ÊñáÂ≠ó
                        bubble.dataset.state = 'expanded';     // ËøõÂÖ•Â±ïÂºÄÁä∂ÊÄÅ
                    }
                }, 1500);
            }
        });
        
        document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);
        
        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
        document.getElementById('selection-share-btn').addEventListener('click', () => {
            if (selectedMessages.size > 0) {
                openShareTargetPicker(); // ÊâìÂºÄÊàë‰ª¨Âç≥Â∞ÜÂàõÂª∫ÁöÑÁõÆÊ†áÈÄâÊã©Âô®
            }
        });
        document.getElementById('selection-screenshot-btn').addEventListener('click', handleLongScreenshot);
        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
        document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
            const sourceChat = state.chats[state.activeChatId];
            const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
                                           .map(cb => cb.dataset.chatId);
        
            if (selectedTargetIds.length === 0) {
                alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂàÜ‰∫´ÁöÑËÅäÂ§©„ÄÇ");
                return;
            }
        
            // 1. ÊâìÂåÖËÅäÂ§©ËÆ∞ÂΩï
            const sharedHistory = [];
            const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
            for (const timestamp of sortedTimestamps) {
                const msg = sourceChat.history.find(m => m.timestamp === timestamp);
                if (msg) {
                    sharedHistory.push(msg);
                }
            }
            
            // 2. ÂàõÂª∫ÂàÜ‰∫´Âç°ÁâáÊ∂àÊÅØÂØπË±°
            const shareCardMessage = {
                role: 'user',
                senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'Êàë') : 'Êàë',
                type: 'share_card',
                timestamp: Date.now(),
                payload: {
                    sourceChatName: sourceChat.name,
                    title: `Êù•Ëá™‚Äú${sourceChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩï`,
                    sharedHistory: sharedHistory
                }
            };
        
            // 3. Âæ™ÁéØÂèëÈÄÅÂà∞ÊâÄÊúâÁõÆÊ†áËÅäÂ§©
            for (const targetId of selectedTargetIds) {
                const targetChat = state.chats[targetId];
                if (targetChat) {
                    targetChat.history.push(shareCardMessage);
                    await db.chats.put(targetChat);
                }
            }
            
            // 4. Êî∂Â∞æÂ∑•‰Ωú
            document.getElementById('share-target-modal').classList.remove('visible');
            exitSelectionMode(); // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
            await showCustomAlert("ÂàÜ‰∫´ÊàêÂäü", `ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂàÜ‰∫´Âà∞ ${selectedTargetIds.length} ‰∏™‰ºöËØù‰∏≠„ÄÇ`);
            renderChatList(); // Âà∑Êñ∞ÂàóË°®ÔºåÂèØËÉΩ‰ºöÊúâÊñ∞Ê∂àÊÅØÊèêÁ§∫
        });
        
        // ÁªëÂÆöÂèñÊ∂àÊåâÈíÆ
        document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
            document.getElementById('share-target-modal').classList.remove('visible');
        });
        
        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊ∑ªÂä†
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // ...‰Ω†Â∑≤ÊúâÁöÑÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂ÈÄªËæë...
        
            // Êñ∞Â¢ûÈÄªËæëÔºöÂ§ÑÁêÜÂàÜ‰∫´Âç°ÁâáÁöÑÁÇπÂáª
            const shareCard = e.target.closest('.link-share-card[data-timestamp]');
            if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
                const timestamp = parseInt(shareCard.dataset.timestamp);
                openSharedHistoryViewer(timestamp);
            }
        });
        
        // ÁªëÂÆöÊü•ÁúãÂô®ÁöÑÂÖ≥Èó≠ÊåâÈíÆ
        document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
            document.getElementById('shared-history-viewer-modal').classList.remove('visible');
        });
        
        // ÂàõÂª∫Êñ∞ÂáΩÊï∞Êù•Â§ÑÁêÜÊ∏≤ÊüìÈÄªËæë
        function openSharedHistoryViewer(timestamp) {
            const chat = state.chats[state.activeChatId];
            const message = chat.history.find(m => m.timestamp === timestamp);
            if (!message || message.type !== 'share_card') return;
        
            const viewerModal = document.getElementById('shared-history-viewer-modal');
            const viewerTitle = document.getElementById('shared-history-viewer-title');
            const viewerContent = document.getElementById('shared-history-viewer-content');
        
            viewerTitle.textContent = message.payload.title;
            viewerContent.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπ
        
            // „ÄêÊ†∏ÂøÉ„ÄëÂ§çÁî® createMessageElement Êù•Ê∏≤ÊüìÊØè‰∏ÄÊù°Ë¢´ÂàÜ‰∫´ÁöÑÊ∂àÊÅØ
            message.payload.sharedHistory.forEach(sharedMsg => {
                // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨‰º†ÂÖ•ÁöÑÊòØ sourceChat ÂØπË±°Ôºå‰ª•Á°Æ‰øùÂ§¥ÂÉè„ÄÅÊòµÁß∞Á≠âÊ≠£Á°Æ
                const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;
                const bubbleEl = createMessageElement(sharedMsg, sourceChat);
                if (bubbleEl) {
                    viewerContent.appendChild(bubbleEl);
                }
            });
        
            viewerModal.classList.add('visible');
        }
        
        audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);
        
        audioPlayer.addEventListener('pause', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = false; 
                updatePlayerUI(); 
            } 
        });
        audioPlayer.addEventListener('play', () => { 
            if(musicState.isActive) { 
                musicState.isPlaying = true; 
                updatePlayerUI(); 
            } 
        });
        
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÊõøÊç¢ÊóßÁöÑ playlist-body ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        
        document.getElementById('playlist-body').addEventListener('click', async (e) => {
            const target = e.target;
            
            // ÁÇπÂáª‚ÄúËØç‚ÄùÊåâÈíÆ
            const lyricsBtn = target.closest('.lyrics-btn');
            if (lyricsBtn) {
                const index = parseInt(lyricsBtn.dataset.index);
                if (isNaN(index)) return;

                // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç1„ÄëË∞ÉÁî®ÂáΩÊï∞Âπ∂Á≠âÂæÖÁî®Êà∑‰∏ä‰º†ÊàñÁ≤òË¥¥Ê≠åËØç
                const newLrcContent = await handleManualLrcImport(index);

                // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç2„ÄëÂ¶ÇÊûúÁî®Êà∑Ê≤°ÊúâÂèñÊ∂àÔºåÂπ∂‰∏îÊàë‰ª¨ÂæóÂà∞‰∫ÜÊ≠åËØçÂÜÖÂÆπ
                if (newLrcContent !== null) {
                    // a. Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÊ≠åÊõ≤Êï∞ÊçÆ
                    musicState.playlist[index].lrcContent = newLrcContent;
                    
                    // b. Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï¥‰∏™Êí≠ÊîæÂàóË°®‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    await saveGlobalPlaylist();
                    
                    // c. Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÂ∞±ÊòØËøôÈ¶ñÊ≠åÔºåÁ´ãÂç≥Âà∑Êñ∞Ê≠åËØçÊòæÁ§∫
                    if (musicState.currentIndex === index) {
                        musicState.parsedLyrics = parseLRC(newLrcContent);
                        renderLyrics(); // ÈáçÊñ∞Ê∏≤ÊüìÊ≠åËØçÂàóË°®
                        updateLyricsUI(); // Êõ¥Êñ∞UIÈ´ò‰∫Æ
                    }
                    
                    // d. ÁªôÁî®Êà∑‰∏Ä‰∏™ÊàêÂäüÁöÑÊèêÁ§∫
                    await showCustomAlert('ÊàêÂäü', `„Ää${musicState.playlist[index].name}„ÄãÁöÑÊ≠åËØçÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ`);
                }
                return;
            }
        
            // ÁÇπÂáª‚ÄúÂà†Èô§‚ÄùÊåâÈíÆ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            const deleteBtn = target.closest('.delete-track-btn');
            if (deleteBtn) {
                const index = parseInt(deleteBtn.dataset.index);
                if (isNaN(index)) return;
                const track = musicState.playlist[index];
                const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`);
                if (confirmed) {
                    deleteTrack(index);
                }
                return;
            }
        
            // ÁÇπÂáªÊ≠åÊõ≤‰ø°ÊÅØÂå∫Âüü -> Êí≠ÊîæÊ≠åÊõ≤ (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            const itemInfo = target.closest('.playlist-item-info');
            if (itemInfo) {
                const item = itemInfo.closest('.playlist-item');
                const index = Array.from(item.parentElement.children).indexOf(item);
                if (index > -1) {
                    playSong(index);
                }
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        document.querySelector('.progress-bar').addEventListener('click', (e) => {
            if (!audioPlayer.duration) return;
            const progressBar = e.currentTarget;
            const barWidth = progressBar.clientWidth;
            const clickX = e.offsetX;
            audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
        });
        
        // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥ËøôÊÆµÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
        
        // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊù•Â§ÑÁêÜÊâÄÊúâ‚ÄúÂ∑≤Êí§ÂõûÊ∂àÊÅØ‚ÄùÁöÑÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('chat-messages').addEventListener('click', (e) => {
            // Ê£ÄÊü•Ë¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊàñÂÖ∂Áà∂ÂÖÉÁ¥†ÊòØÂê¶ÊòØ‚ÄúÂ∑≤Êí§Âõû‚ÄùÊèêÁ§∫
// ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ .recalled-message-placeholder ÁÇπÂáª‰∫ã‰ª∂ÈÄªËæë ‚ñº‚ñº‚ñº
const placeholder = e.target.closest('.recalled-message-placeholder');
if (placeholder) {
    const chat = state.chats[state.activeChatId];
    const wrapper = placeholder.closest('.message-wrapper');
    if (chat && wrapper) {
        const timestamp = parseInt(wrapper.dataset.timestamp);
        const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

        if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;

            // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂú®ËøôÈáåÊ∑ªÂä†ÂØπÊõ¥Â§öÊ∂àÊÅØÁ±ªÂûãÁöÑÂà§Êñ≠ ---
            switch (recalled.originalType) {
                case 'text':
                    originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                    break;
                case 'user_photo':
                case 'ai_image':
                case 'text_image':
                    originalContentText = `[ÂõæÁâá/ÊñáÂ≠óÂõæ] ÊèèËø∞: "${recalled.originalContent}"`;
                    break;
                case 'voice_message':
                    originalContentText = `[ËØ≠Èü≥] ÂÜÖÂÆπ: "${recalled.originalContent}"`;
                    break;
                case 'sticker':
                    // ÂØπ‰∫éË°®ÊÉÖÔºåÂêåÊó∂ÊòæÁ§∫Âê´‰πâÂíåÂõæÁâáURL
                    originalContentText = `[Ë°®ÊÉÖ] Âê´‰πâ: "${recalled.originalMeaning || '(Êó†)'}" \n URL: ${recalled.originalContent}`;
                    break;
                case 'transfer':
                    originalContentText = `‰∏ÄÊù°[ËΩ¨Ë¥¶]Ê∂àÊÅØÂ∑≤Ë¢´Êí§Âõû„ÄÇ`;
                    break;
                default:
                    // ÂØπ‰∫éÂÖ∂‰ªñÊú™Áü•Á±ªÂûãÔºåÊòæÁ§∫Á±ªÂûãÂíåÂéüÂßãÂÜÖÂÆπ
                    originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ„ÄÇ\nÂÜÖÂÆπ: ${JSON.stringify(recalled.originalContent)}`;
                    break;
            }
            // --- ‰øÆÂ§çÁªìÊùü ---

            showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
        }
    }
}
});
        
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥ËøôÊÆµÊñ∞‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
        document.getElementById('close-category-manager-btn').addEventListener('click', () => {
            document.getElementById('world-book-category-manager-modal').classList.remove('visible');
            renderWorldBookScreen(); // ÂÖ≥Èó≠ÂêéÂà∑Êñ∞‰∏ªÂàóË°®
        });
        document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
        document.getElementById('existing-categories-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const categoryId = parseInt(e.target.dataset.id);
                deleteCategory(categoryId);
            }
        });
        // ‚ñº‚ñº‚ñº Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æÔºåÊ∑ªÂä†ËøôÈÉ®ÂàÜ‰ª£Á†Å ‚ñº‚ñº‚ñº
        document.getElementById('repost-cancel-btn').addEventListener('click', hideRepostModal);
        document.getElementById('repost-confirm-btn').addEventListener('click', handleConfirmRepost);
        // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

        // Âú® init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ
        // ...
        // ÁªëÂÆöÊ∂àÊÅØÊìç‰ΩúËèúÂçï‰∏≠ÁöÑ‚ÄúÂºïÁî®‚ÄùÊåâÈíÆ
        document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
        
        // ÁªëÂÆöÂõûÂ§çÈ¢ÑËßàÊ†è‰∏≠ÁöÑ‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆ
        document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
        // ...
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                // ===================================================================
                // 5. ÂêØÂä®ÔºÅ
        // Âú®Á¨¨ 9660 Ë°åÔºåshowScreen('home-screen'); ÁöÑÂâçÈù¢ÔºåÁ≤òË¥¥‰∏ãÈù¢ÁöÑ‰ª£Á†Å
        
            // ‚ñº‚ñº‚ñº „ÄêËØ∑Â∞ÜËøôÊÆµÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÁ≤òË¥¥ËøõÂéª„Äë ‚ñº‚ñº‚ñº
            
            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºå‰∏∫Âä®ÊÄÅËØÑËÆ∫Âå∫ÁöÑ@ÂäüËÉΩÁªëÂÆö‰∫ã‰ª∂
            document.getElementById('qzone-posts-list').addEventListener('input', (e) => {
                if (!e.target.matches('.comment-input')) return;
        
                const commentInput = e.target;
                const postContainer = commentInput.closest('.qzone-post-container');
                if (!postContainer) return;
                
                const popup = postContainer.querySelector('.at-mention-popup');
                const value = commentInput.value;
                const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
                if (atMatch) {
                    const namesToMention = new Set();
                    const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                    if (authorNickname) namesToMention.add(authorNickname);
                    postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                        namesToMention.add(nameEl.textContent.replace(':', ''));
                    });
                    namesToMention.delete(state.qzoneSettings.nickname);
        
                    popup.innerHTML = '';
                    if (namesToMention.size > 0) {
                        const searchTerm = atMatch[1];
                        namesToMention.forEach(name => {
                            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                const item = document.createElement('div');
                                item.className = 'at-mention-item';
                                item.textContent = name;
                                item.addEventListener('mousedown', (evt) => {
                                    evt.preventDefault();
                                    const newText = value.substring(0, atMatch.index) + `@${name} `;
                                    commentInput.value = newText;
                                    popup.style.display = 'none';
                                    commentInput.focus();
                                });
                                popup.appendChild(item);
                            }
                        });
                        popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                    } else {
                        popup.style.display = 'none';
                    }
                } else {
                    popup.style.display = 'none';
                }
            });
        
            document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
                if (e.target.matches('.comment-input')) {
                    const postContainer = e.target.closest('.qzone-post-container');
                    if (postContainer) {
                        const popup = postContainer.querySelector('.at-mention-popup');
                        if (popup) {
                            setTimeout(() => { popup.style.display = 'none'; }, 200);
                        }
                    }
                }
            });
        
            // ‚ñ≤‚ñ≤‚ñ≤ „ÄêÊñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü„Äë ‚ñ≤‚ñ≤‚ñ≤  
        // ‚ñº‚ñº‚ñº Êää‰∏ãÈù¢ËøôÊÆµÊñ∞‰ª£Á†ÅÂÆåÊï¥Á≤òË¥¥Âà∞ showScreen('home-screen'); ÁöÑÂâçÈù¢ ‚ñº‚ñº‚ñº
        
        // „ÄêÂÖ®Êñ∞„Äë‰∏∫„Äê‰∏ªËÅäÂ§©ËæìÂÖ•Ê°Ü„ÄëÊ∑ªÂä†@ÂäüËÉΩ
        const chatInputForMention = document.getElementById('chat-input');
        const chatMentionPopup = document.getElementById('chat-at-mention-popup');
        
        chatInputForMention.addEventListener('input', () => {
            // 1. È¶ñÂÖàÔºåÊ£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®Áæ§ËÅä‰∏≠
            if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) {
                chatMentionPopup.style.display = 'none';
                return;
            }
            
            const chat = state.chats[state.activeChatId];
            const value = chatInputForMention.value;
            const atMatch = value.match(/@([\p{L}\w]*)$/u);
        
            if (atMatch) {
                // 2. Êî∂ÈõÜÁæ§ÊàêÂëòÂêçÂçï (ÊéíÈô§Ëá™Â∑±)
                const myNickname = chat.settings.myNickname || 'Êàë';
                const namesToMention = chat.members
                    .map(member => member.groupNickname)
                    .filter(name => name !== myNickname);
        
                chatMentionPopup.innerHTML = '';
                if (namesToMention.length > 0) {
                    const searchTerm = atMatch[1];
                    // 3. Á≠õÈÄâÂπ∂ÁîüÊàêÂàóË°®
                    namesToMention.forEach(name => {
                        if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const item = document.createElement('div');
                            item.className = 'at-mention-item';
                            item.textContent = name;
                            // 4. ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                const newText = value.substring(0, atMatch.index) + `@${name} `;
                                chatInputForMention.value = newText;
                                chatMentionPopup.style.display = 'none';
                                chatInputForMention.focus();
                            });
                            chatMentionPopup.appendChild(item);
                        }
                    });
                    // 5. ÊòæÁ§∫ÊàñÈöêËóèÂºπÁ™ó
                    chatMentionPopup.style.display = chatMentionPopup.children.length > 0 ? 'block' : 'none';
                } else {
                    chatMentionPopup.style.display = 'none';
                }
            } else {
                chatMentionPopup.style.display = 'none';
            }
        });
        
        // ÂΩìËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπÊó∂ÔºåÈöêËóèÂºπÁ™ó
        chatInputForMention.addEventListener('blur', () => {
            setTimeout(() => { chatMentionPopup.style.display = 'none'; }, 200);
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞ËøôÈáåÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤     
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊñ∞ÁâàÁæ§ÂÖ¨Âëä‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('publish-to-announcement-btn').addEventListener('click', publishToAnnouncementBoard);
        document.getElementById('show-announcement-board-btn').addEventListener('click', showAnnouncementBoard);
        document.getElementById('close-announcement-board-btn').addEventListener('click', () => {
            document.getElementById('announcement-board-modal').classList.remove('visible');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤  
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÂÜÖÈÉ®‰∫ã‰ª∂ÂßîÊâò‰∏éÊìç‰ΩúËèúÂçï‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('announcement-board-content').addEventListener('click', (e) => {
            if (e.target.classList.contains('announcement-item-actions')) {
                const annoId = e.target.dataset.annoId;
                if (annoId) {
                    showAnnouncementActions(annoId);
                }
            }
        });
        
        document.getElementById('announcement-action-pin').addEventListener('click', handlePinAnnouncement);
        document.getElementById('announcement-action-delete').addEventListener('click', handleDeleteAnnouncement);
        document.getElementById('announcement-action-cancel').addEventListener('click', () => {
            document.getElementById('announcement-actions-modal').classList.remove('visible');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤   
                    // ‚ñº‚ñº‚ñº ÊääÊñ∞‰ª£Á†ÅÂÆåÊï¥Á≤òË¥¥Âú®ËøôÈáå ‚ñº‚ñº‚ñº
                    document.getElementById('reset-global-css-btn').addEventListener('click', () => {
                        document.getElementById('global-css-input').value = '';
                        // (ÂèØÈÄâ) Â¶ÇÊûúÂ∏åÊúõÁÇπÂáªÈáçÁΩÆÂêéÁ´ãÂàªÁúãÂà∞ÊïàÊûúÔºåÂèØ‰ª•Âä†‰∏ä‰∏ãÈù¢ËøôË°å
                        // applyGlobalCss('');
                    });
        // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÂ§çÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÖ®Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÊõøÊç¢ÊóßÁöÑÈïøÊúüËÆ∞ÂøÜÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        // ËÅäÂ§©ÁïåÈù¢È°∂ÈÉ®Êñ∞ÊåâÈíÆ -> ÊâìÂºÄÂÖ®Â±èÈ°µÈù¢
        document.getElementById('open-memory-screen-btn').addEventListener('click', openLongTermMemoryScreen);
        
        // ÈïøÊúüËÆ∞ÂøÜÈ°µÈù¢ËøîÂõûÊåâÈíÆ -> ËøîÂõûËÅäÂ§©ÁïåÈù¢
        document.getElementById('memory-screen-back-btn').addEventListener('click', () => {
            showScreen('chat-interface-screen');
        });
        
        // ÈïøÊúüËÆ∞ÂøÜÈ°µÈù¢È°∂ÈÉ®‚Äú+‚ÄùÊåâÈíÆ -> ÊâãÂä®Ê∑ªÂä†
        document.getElementById('add-manual-memory-btn-header').addEventListener('click', handleAddManualMemory);
        
        // ÈïøÊúüËÆ∞ÂøÜÈ°µÈù¢È°∂ÈÉ®‚ÄúÊÄªÁªì‚ÄùÊåâÈíÆ -> ÊâãÂä®ÊÄªÁªì
        document.getElementById('summarize-recent-btn-header').addEventListener('click', handleManualSummary);
        
        // „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§çÂ∞±Âú®ËøôÈáåÔºÅ„Äë„Äë„Äë
document.getElementById('memory-list-container').addEventListener('click', (e) => {
    const editBtn = e.target.closest('.edit-memory-btn');
    if (editBtn) {
        handleEditMemory(editBtn.dataset.authorId, parseInt(editBtn.dataset.memoryTimestamp));
        return;
    }
    const deleteBtn = e.target.closest('.delete-memory-btn');
    if (deleteBtn) {
        handleDeleteMemory(deleteBtn.dataset.authorId, parseInt(deleteBtn.dataset.memoryTimestamp));
        return;
    }
});
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∫îÂ≠êÊ£ãÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('gomoku-btn').addEventListener('click', toggleGomokuBoard);
        document.getElementById('close-gomoku-btn').addEventListener('click', closeGomokuBoard);
        
        const gomokuCanvas = document.getElementById('gomoku-board');
        gomokuCanvas.addEventListener('mousemove', handleBoardHover);
        gomokuCanvas.addEventListener('mouseout', () => renderGomokuBoard(state.activeChatId)); // Clear hover on exit
        gomokuCanvas.addEventListener('click', handleBoardClick);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêËøôÊòØ‰øÆÂ§ç‰ª£Á†Å„ÄëËØ∑Â∞ÜËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
        document.getElementById('add-countdown-btn').addEventListener('click', () => {
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('countdown-title-input').value = '';
            document.getElementById('countdown-date-input').value = '';
            // ÊòæÁ§∫Êñ∞Âª∫Á∫¶ÂÆöÂºπÁ™ó
            document.getElementById('create-countdown-modal').classList.add('visible');
        });
        
        // ‰∏∫Êñ∞Âª∫Á∫¶ÂÆöÂºπÁ™óÁöÑ‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆ‰πüÁªëÂÆö‰∫ã‰ª∂
        document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
            document.getElementById('create-countdown-modal').classList.remove('visible');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§ç‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                    // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÊ∂àÊÅØÊìç‰Ωú‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('edit-call-message-btn').addEventListener('click', openCallMessageEditor);
        document.getElementById('delete-call-message-btn').addEventListener('click', deleteCallMessage);
        document.getElementById('cancel-call-message-action-btn').addEventListener('click', hideCallMessageActions);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂØºÊºîÊ®°Âºè‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('edit-last-response-btn').addEventListener('click', openAiResponseEditor);
        document.getElementById('cancel-ai-response-editor-btn').addEventListener('click', () => {
            document.getElementById('ai-response-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-ai-response-editor-btn').addEventListener('click', saveEditedAiResponse);
        document.getElementById('add-ai-response-block-btn').addEventListener('click', () => {
            // ÁÇπÂáªÊ∑ªÂä†ÊåâÈíÆÊó∂ÔºåÂàõÂª∫‰∏Ä‰∏™Á©∫ÁöÑ„ÄÅÂ∏¶Ê®°ÊùøÁöÑÁºñËæëÂùó
            const container = document.getElementById('ai-response-editor-container');
            const newBlock = createAiResponseEditorBlock('{\n  "type": "text",\n  "content": "Âú®ËøôÈáåËæìÂÖ•Êñ∞Ê∂àÊÅØ..."\n}');
            container.appendChild(newBlock);
            newBlock.querySelector('textarea').focus();
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ìÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
        document.getElementById('manage-my-avatar-library-btn').addEventListener('click', openMyAvatarLibraryModal);
        document.getElementById('close-my-avatar-library-btn').addEventListener('click', closeMyAvatarLibraryModal);
        document.getElementById('add-my-avatar-url-btn').addEventListener('click', addAvatarToMyLibraryFromURL);
        document.getElementById('add-my-avatar-upload-btn').addEventListener('click', () => {
            document.getElementById('my-avatar-upload-input').click();
        });
        document.getElementById('my-avatar-upload-input').addEventListener('change', handleLocalMyAvatarUpload);
        document.getElementById('add-my-avatar-batch-btn').addEventListener('click', async () => {
            const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;
            const pastedText = await showCustomPrompt('ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè', placeholderText, '', 'textarea');
            if (pastedText && pastedText.trim()) {
                await handleBatchImportForMyAvatar(pastedText);
            }
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëË¥≠Áâ©ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö (V6.0 - ÊîØÊåÅÊåáÂÆöÊî∂Á§º‰∫∫) ‚ñº‚ñº‚ñº
        document.getElementById('open-shopping-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('shopping-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
        document.getElementById('go-to-cart-btn').addEventListener('click', openCartScreen);
        document.getElementById('cart-back-btn').addEventListener('click', openShoppingScreen);
        document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
        document.getElementById('close-receipt-btn').addEventListener('click', () => {
            document.getElementById('gift-receipt-modal').classList.remove('visible');
        });
        
        // "ÁÆ°ÁêÜ"ÊåâÈíÆ
        document.getElementById('manage-products-btn').addEventListener('click', () => {
            isProductManagementMode = !isProductManagementMode;
            const btn = document.getElementById('manage-products-btn');
            btn.style.color = isProductManagementMode ? 'var(--accent-color)' : 'var(--text-primary)';
            if (!isProductManagementMode && document.querySelectorAll('#product-grid .product-item').length === 0) {
                openProductEditor(null);
            }
            renderShoppingProducts();
        });
        
        // ‚ÄúÊ∑ªÂä†ÂïÜÂìÅ‚ÄùÊåâÈíÆ
        document.getElementById('add-new-product-btn').addEventListener('click', () => {
            if (isProductManagementMode) {
                openProductEditor(null);
            } else {
                alert("ËØ∑ÂÖàÁÇπÂáªÊâ≥ÊâãÂõæÊ†áËøõÂÖ•ÁÆ°ÁêÜÊ®°ÂºèÔºåÊâçËÉΩÊ∑ªÂä†Êñ∞ÂïÜÂìÅ„ÄÇ");
            }
        });
        
        // ÂïÜÂìÅÂàóË°®‰∫ã‰ª∂ÂßîÊâò
        document.getElementById('product-grid').addEventListener('click', async e => {
            const productItem = e.target.closest('.product-item');
            if (!productItem) return;
            const productId = parseInt(productItem.dataset.id);
        
            if (e.target.classList.contains('edit-product-btn')) {
                openProductEditor(productId);
            } else if (e.target.classList.contains('delete-product-btn')) {
                deleteProduct(productId);
            } else if (e.target.classList.contains('add-to-cart-btn')) {
                await addToCart(productId);
                await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊàêÂäüÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ÔºÅ');
            }
        });
        
        // Ë¥≠Áâ©ËΩ¶ÂàóË°®‰∫ã‰ª∂ÂßîÊâò
        document.getElementById('cart-items-list').addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('decrease-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), -1);
            }
            if (target.classList.contains('increase-qty-btn')) {
                updateCartItemQuantity(parseInt(target.dataset.id), 1);
            }
            if (target.classList.contains('cart-item-checkbox')) {
                updateCartTotal();
            }
        });
        
        // Ë¥≠Áâ©ËΩ¶Ê∏ÖÁ©∫ÊåâÈíÆ
        document.getElementById('clear-cart-btn').addEventListener('click', async () => {
            if (shoppingCart.length === 0) return;
            const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶', 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶‰∏≠ÁöÑÊâÄÊúâÂïÜÂìÅÂêóÔºü');
            if (confirmed) {
                shoppingCart = [];
                updateCartCount();
                renderCartItems();
            }
        });
        
        // Ë¥≠Áâ©ËΩ¶ÂÖ®ÈÄâ
        document.getElementById('select-all-cart-items').addEventListener('change', function(e) {
            document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateCartTotal();
        });
        
        // ÂïÜÂìÅÁºñËæëÂô®ÂºπÁ™óÊåâÈíÆ
        document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
            document.getElementById('product-editor-modal').classList.remove('visible');
        });
        document.getElementById('save-product-btn').addEventListener('click', saveProduct);
        document.getElementById('product-image-input').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (re) => { document.getElementById('product-image-preview').src = re.target.result; };
                reader.readAsDataURL(file);
            }
        });
        
        // ËÅäÂ§©ÁïåÈù¢Á§ºÁâ©Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('chat-messages').addEventListener('click', e => {
            const giftCard = e.target.closest('.gift-card');
            if (giftCard) {
                const bubble = giftCard.closest('.message-bubble');
                if (bubble) {
                    showGiftReceipt(parseInt(bubble.dataset.timestamp));
                }
            }
        });
        
        // „ÄêÂÖ®Êñ∞„ÄëÁ§ºÁâ©Êé•Êî∂‰∫∫ÈÄâÊã©ÂºπÁ™óÁöÑ‰∫ã‰ª∂ÁªëÂÆö
        document.getElementById('cancel-gift-recipient-btn').addEventListener('click', () => {
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        
        // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§ç„ÄëÁöÑÊñ∞‰∫ã‰ª∂ÁõëÂê¨Âô®ÊõøÊç¢ÊóßÁöÑ 'confirm-gift-recipient-btn' ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
        document.getElementById('confirm-gift-recipient-btn').addEventListener('click', async () => {
            // Ê≠•È™§ 1: (‰øùÊåÅ‰∏çÂèò) Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊî∂Á§º‰∫∫
            const selectedRecipients = Array.from(document.querySelectorAll('#gift-recipient-list .contact-picker-item.selected'))
                .map(item => item.dataset.recipientName);
            
            if (selectedRecipients.length === 0) {
                alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ΩçÊî∂Á§º‰∫∫„ÄÇ");
                return;
            }
            
            // Ê≠•È™§ 2: „Äê„Äê„ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë„Äë„Äë Âú®ËøôÈáåÔºåÈáçÊñ∞‰ªéË¥≠Áâ©ËΩ¶Ëé∑Âèñ‰∏ÄÊ¨°ÈÄâ‰∏≠ÁöÑÂïÜÂìÅ
            const selectedItems = shoppingCart.filter(item => 
                document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
            );
            
            // Ê≠•È™§ 3: (‰øùÊåÅ‰∏çÂèò) Ë∞ÉÁî®ÂèëÈÄÅÂáΩÊï∞ÔºåÊ≠§Êó∂‰∏§‰∏™ÂèÇÊï∞ÈÉΩÊòØÊ≠£Á°ÆÁöÑ
            await sendGiftMessage(selectedItems, selectedRecipients);
            
            // Ê≠•È™§ 4: (‰øùÊåÅ‰∏çÂèò) ÂÖ≥Èó≠ÂºπÁ™ó
            document.getElementById('gift-recipient-modal').classList.remove('visible');
        });
        // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
        document.getElementById('gift-recipient-list').addEventListener('click', (e) => {
            const item = e.target.closest('.contact-picker-item');
            if (item) {
                item.classList.toggle('selected');
            }
        });
        
        document.getElementById('select-all-recipients').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('#gift-recipient-list .contact-picker-item').forEach(item => {
                item.classList.toggle('selected', isChecked);
            });
        });
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫ÈáçÊñ∞ÁîüÊàêÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('regenerate-btn').addEventListener('click', handleRegenerateResponse);
        document.getElementById('regenerate-call-btn').addEventListener('click', handleRegenerateCallResponse);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤  
        // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Êé®ËøõÂâßÊÉÖÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
        document.getElementById('propel-btn').addEventListener('click', handlePropelAction);
        // ‰∏ãÈù¢ËøôË°å‰ª£Á†ÅÂ∑≤Ë¢´ÂÆâÂÖ®Âú∞Ê≥®ÈáäÊéâÔºåÂõ†‰∏∫ÂÆÉÂØπÂ∫îÁöÑHTMLÊåâÈíÆ‰∏çÂ≠òÂú®
        // document.getElementById('propel-call-btn').addEventListener('click', handlePropelCallAction);
        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
// Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫Âüü...

// „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÊèêÁ§∫Èü≥ËÆæÁΩÆ‰∫ã‰ª∂
document.getElementById('test-sound-btn').addEventListener('click', () => {
    const player = document.getElementById('notification-sound-player');
    const url = document.getElementById('notification-sound-url-input').value.trim() || DEFAULT_NOTIFICATION_SOUND;
    player.src = url;
    player.play().catch(e => alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°ÆÊàñÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ•Ê†ºÂºè„ÄÇ'));
});

document.getElementById('reset-sound-btn').addEventListener('click', () => {
    document.getElementById('notification-sound-url-input').value = '';
    alert('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÊèêÁ§∫Èü≥ÔºåÁÇπÂáª‚Äú‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ‚ÄùÂêéÁîüÊïà„ÄÇ');
});
    // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Â∞èÁªÑ‰ª∂ÁºñËæëÂäüËÉΩÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô® (‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâò) ‚ñº‚ñº‚ñº
    document.getElementById('home-screen').addEventListener('click', (e) => {
        const target = e.target;
        // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØÂèØÁºñËæëÁöÑÊñáÂ≠ó
        if (target.classList.contains('editable-text')) {
            handleEditText(target);
        }
        // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØÂèØÁºñËæëÁöÑÂõæÁâá
        if (target.classList.contains('editable-image')) {
            handleEditImage(target);
        }
    });
    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁõëÂê¨Âô®ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤  
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);    
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫BGMÊêúÁ¥¢ÁªìÊûúÂºπÁ™óÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨ ‚ñº‚ñº‚ñº
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Âî±Áâá/Ê≠åËØçÂÆπÂô®ÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
document.getElementById('music-visual-container').addEventListener('click', () => {
    document.getElementById('music-visual-container').classList.toggle('lyrics-active');
});
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëBGMÊêúÁ¥¢ÁªìÊûúÂºπÁ™ó‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);
document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
    document.getElementById('music-search-results-modal').classList.remove('visible');
});

document.getElementById('search-results-list').addEventListener('click', (e) => {
    const item = e.target.closest('.search-result-item');
    if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ∏ÖÁêÜÊó†ÊïàÊ≠åÊõ≤‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
document.getElementById('cleanup-songs-btn').addEventListener('click', cleanupInvalidSongs);
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
// ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰∏∫Áä∂ÊÄÅÊ†èÂºÄÂÖ≥Ê∑ªÂä†ÂÆûÊó∂È¢ÑËßà‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
document.getElementById('status-bar-toggle-switch').addEventListener('change', () => {
    // ÊØèÊ¨°ÁÇπÂáªÂºÄÂÖ≥Êó∂Ôºå‰πüË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞Êù•ÂÆûÊó∂ÂàáÊç¢ class
    state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
    applyStatusBarVisibility();
});
// ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰∫ã‰ª∂ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    showScreen('home-screen');
                }
        
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ≠ó‰ΩìÊâπÈáèÂØºÂÖ•ÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
                
                /**
                 * ÊâìÂºÄÂ≠ó‰ΩìÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
                 */
                function openFontBatchImportModal() {
                    document.getElementById('font-batch-import-modal').classList.add('visible');
                    document.getElementById('font-batch-import-textarea').value = '';
                    document.getElementById('font-batch-import-textarea').focus();
                }
                
                /**
                 * ÂÖ≥Èó≠Â≠ó‰ΩìÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°Ü
                 */
                function closeFontBatchImportModal() {
                    document.getElementById('font-batch-import-modal').classList.remove('visible');
                }
                
                /**
                 * Â§ÑÁêÜÂ≠ó‰ΩìÊâπÈáèÂØºÂÖ•ÁöÑÊ†∏ÂøÉÈÄªËæë
                 */
                async function handleFontBatchImport() {
                    const textarea = document.getElementById('font-batch-import-textarea');
                    const text = textarea.value.trim();
                    
                    if (!text) {
                        alert('ËØ∑ËæìÂÖ•Â≠ó‰ΩìÊï∞ÊçÆÔºÅ');
                        return;
                    }
                    
                    const lines = text.split('\n');
                    const newFonts = [];
                    let errorCount = 0;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue;
                        
                        // ‰ΩøÁî®"‚Äî‚Äî"ÂàÜÈöîÂ≠ó‰ΩìÂêçÁß∞ÂíåÈìæÊé•
                        const parts = trimmedLine.split('‚Äî‚Äî');
                        if (parts.length !== 2) {
                            errorCount++;
                            console.warn('Â≠ó‰ΩìÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                            continue;
                        }
                        
                        const name = parts[0].trim();
                        const url = parts[1].trim();
                        
                        if (!name || !url) {
                            errorCount++;
                            console.warn('Â≠ó‰ΩìÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                            continue;
                        }
                        
                        // È™åËØÅURLÊ†ºÂºè
                        if (!url.startsWith('http')) {
                            errorCount++;
                            console.warn('Â≠ó‰ΩìURLÊ†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
                            continue;
                        }
                        
                        newFonts.push({
                            name: name,
                            url: url,
                            isActive: false
                        });
                    }
                    
                    if (errorCount > 0) {
                        await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ`);
                    }
                    
                    if (newFonts.length > 0) {
                        try {
                            // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                            await db.fonts.bulkAdd(newFonts);
                            await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newFonts.length} ‰∏™Â≠ó‰ΩìÔºÅ`);
                            
                            // Âà∑Êñ∞Â≠ó‰ΩìÂ∫ìÂàóË°®
                            await renderFontLibrary();
                            
                            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                            closeFontBatchImportModal();
                        } catch (error) {
                            console.error('‰øùÂ≠òÂ≠ó‰ΩìÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error);
                            alert('‰øùÂ≠òÂ≠ó‰ΩìÂ§±Ë¥•: ' + error.message);
                        }
                    } else if (errorCount === 0) {
                        alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇ");
                    }
                }
                
                /**
                 * Ê∏≤ÊüìÂ≠ó‰ΩìÂ∫ìÂàóË°®
                 */
                async function renderFontLibrary() {
                    const container = document.getElementById('font-library-list');
                    if (!container) return;
                    
                    try {
                        const fonts = await db.fonts.orderBy('id').toArray();
                        
                        if (fonts.length === 0) {
                            container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">ÊöÇÊó†Â≠ó‰ΩìÔºåËØ∑ÂÖàÂØºÂÖ•Â≠ó‰Ωì</p>';
                            return;
                        }
                        
                        container.innerHTML = '';
                        
                        fonts.forEach(font => {
                            const fontItem = document.createElement('div');
                            fontItem.className = 'font-item';
                            fontItem.style.cssText = `
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 10px;
                                margin-bottom: 5px;
                                border: 1px solid var(--border-color);
                                border-radius: 5px;
                                background-color: ${font.isActive ? '#e8f5e8' : 'white'};
                            `;
                            
                            fontItem.innerHTML = `
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 3px;">${font.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); word-break: break-all;">${font.url}</div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button class="apply-font-btn" data-font-id="${font.id}" style="padding: 5px 10px; border: 1px solid var(--accent-color); background: ${font.isActive ? 'var(--accent-color)' : 'white'}; color: ${font.isActive ? 'white' : 'var(--accent-color)'}; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                        ${font.isActive ? 'Â∑≤Â∫îÁî®' : 'Â∫îÁî®'}
                                    </button>
                                    <button class="delete-font-btn" data-font-id="${font.id}" style="padding: 5px 10px; border: 1px solid #dc3545; background: white; color: #dc3545; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                        Âà†Èô§
                                    </button>
                                </div>
                            `;
                            
                            container.appendChild(fontItem);
                        });
                        
                        // ÁªëÂÆö‰∫ã‰ª∂
                        container.querySelectorAll('.apply-font-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const fontId = parseInt(e.target.dataset.fontId);
                                await applyFont(fontId);
                            });
                        });
                        
                        container.querySelectorAll('.delete-font-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const fontId = parseInt(e.target.dataset.fontId);
                                await deleteFont(fontId);
                            });
                        });
                        
                    } catch (error) {
                        console.error('Ê∏≤ÊüìÂ≠ó‰ΩìÂ∫ìÂ§±Ë¥•:', error);
                        container.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Âä†ËΩΩÂ≠ó‰ΩìÂ∫ìÂ§±Ë¥•</p>';
                    }
                }
                
                /**
                 * Â∫îÁî®Â≠ó‰Ωì
                 */
                async function applyFont(fontId) {
                    try {
                        const font = await db.fonts.get(fontId);
                        if (!font) return;
                        
                        // Â∞ÜÊâÄÊúâÂ≠ó‰ΩìËÆæÁΩÆ‰∏∫ÈùûÊøÄÊ¥ªÁä∂ÊÄÅ
                        await db.fonts.toCollection().modify({ isActive: false });
                        
                        // ËÆæÁΩÆÂΩìÂâçÂ≠ó‰Ωì‰∏∫ÊøÄÊ¥ªÁä∂ÊÄÅ
                        await db.fonts.update(fontId, { isActive: true });
                        
                        // Â∫îÁî®Â≠ó‰Ωì
                        const style = document.getElementById('dynamic-font-style');
                        if (style) {
                            // Ê£ÄÊü•URLÁ±ªÂûãÔºå‰ΩøÁî®‰∏çÂêåÁöÑÂä†ËΩΩÊñπÂºè
                            if (font.url.includes('fonts.googleapis.com') || font.url.includes('fonts.gstatic.com')) {
                                // Google Fonts ‰ΩøÁî® @import
                                style.textContent = `
                                    @import url('${font.url}');
                                    body, input, textarea, button, #font-preview {
                                        font-family: '${font.name}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
                                    }
                                `;
                            } else {
                                // TTF/OTF Êñá‰ª∂‰ΩøÁî® @font-face
                                style.textContent = `
                                    @font-face {
                                        font-family: '${font.name}';
                                        src: url('${font.url}') format('truetype');
                                        font-weight: normal;
                                        font-style: normal;
                                        font-display: swap;
                                    }
                                    body, input, textarea, button, #font-preview {
                                        font-family: '${font.name}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
                                    }
                                `;
                            }
                        }
                        
                        // ÂêåÊó∂Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÁΩÆ
                        state.globalSettings.fontUrl = font.url;
                        await db.globalSettings.put(state.globalSettings);
                        
                        // Âà∑Êñ∞Â≠ó‰ΩìÂ∫ìÂàóË°®
                        await renderFontLibrary();
                        
                        await showCustomAlert('ÊàêÂäü', `Â∑≤Â∫îÁî®Â≠ó‰ΩìÔºö"${font.name}"`);
                        
                    } catch (error) {
                        console.error('Â∫îÁî®Â≠ó‰ΩìÂ§±Ë¥•:', error);
                        alert('Â∫îÁî®Â≠ó‰ΩìÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                /**
                 * Âà†Èô§Â≠ó‰Ωì
                 */
                async function deleteFont(fontId) {
                    try {
                        const font = await db.fonts.get(fontId);
                        if (!font) return;
                        
                        const confirmed = await showCustomConfirm(
                            'Âà†Èô§Â≠ó‰Ωì',
                            `Á°ÆÂÆöË¶ÅÂà†Èô§Â≠ó‰Ωì"${font.name}"ÂêóÔºü`,
                            { confirmButtonClass: 'btn-danger' }
                        );
                        
                        if (confirmed) {
                            await db.fonts.delete(fontId);
                            await renderFontLibrary();
                            await showCustomAlert('ÊàêÂäü', `Â∑≤Âà†Èô§Â≠ó‰ΩìÔºö"${font.name}"`);
                        }
                        
                    } catch (error) {
                        console.error('Âà†Èô§Â≠ó‰ΩìÂ§±Ë¥•:', error);
                        alert('Âà†Èô§Â≠ó‰ΩìÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                // ‚ñ≤‚ñ≤‚ñ≤ Â≠ó‰ΩìÊâπÈáèÂØºÂÖ•ÂäüËÉΩÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ≠ó‰ΩìËÆæÁΩÆÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
                
                /**
                 * ÂÆûÊó∂È¢ÑËßàÂ≠ó‰Ωì
                 */
                function previewCustomFont() {
                    const fontUrl = document.getElementById('font-url-input').value.trim();
                    if (!fontUrl) return;
                    
                    applyCustomFont(fontUrl, true);
                }
                
                /**
                 * Â∫îÁî®Ëá™ÂÆö‰πâÂ≠ó‰Ωì
                 */
                function applyCustomFont(fontUrl, isPreview = false) {
                    if (!fontUrl) return;
                    
                    const style = document.getElementById('dynamic-font-style');
                    if (!style) return;
                    
                    // ÁîüÊàêÂîØ‰∏ÄÁöÑÂ≠ó‰ΩìÂêçÁß∞
                    const fontName = `CustomFont_${Date.now()}`;
                    
                    // Ê£ÄÊü•URLÁ±ªÂûãÔºå‰ΩøÁî®‰∏çÂêåÁöÑÂä†ËΩΩÊñπÂºè
                    if (fontUrl.includes('fonts.googleapis.com') || fontUrl.includes('fonts.gstatic.com')) {
                        // Google Fonts ‰ΩøÁî® @import
                        style.textContent = `
                            @import url('${fontUrl}');
                            ${isPreview ? '#font-preview' : 'body, input, textarea, button'} {
                                font-family: '${extractFontNameFromGoogleFonts(fontUrl)}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
                            }
                        `;
                    } else {
                        // TTF/OTF Êñá‰ª∂‰ΩøÁî® @font-face
                        style.textContent = `
                            @font-face {
                                font-family: '${fontName}';
                                src: url('${fontUrl}') format('truetype');
                                font-weight: normal;
                                font-style: normal;
                                font-display: swap;
                            }
                            ${isPreview ? '#font-preview' : 'body, input, textarea, button'} {
                                font-family: '${fontName}', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
                            }
                        `;
                    }
                }
                
                /**
                 * ‰ªéGoogle Fonts URL‰∏≠ÊèêÂèñÂ≠ó‰ΩìÂêçÁß∞
                 */
                function extractFontNameFromGoogleFonts(url) {
                    const match = url.match(/family=([^&:]+)/);
                    return match ? match[1].replace(/\+/g, ' ') : 'CustomFont';
                }
                
                /**
                 * ‰øùÂ≠òËá™ÂÆö‰πâÂ≠ó‰Ωì
                 */
                async function saveCustomFont() {
                    const fontUrl = document.getElementById('font-url-input').value.trim();
                    if (!fontUrl) {
                        alert('ËØ∑ËæìÂÖ•Â≠ó‰ΩìURLÔºÅ');
                        return;
                    }
                    
                    if (!fontUrl.startsWith('http')) {
                        alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURLÔºÅ');
                        return;
                    }
                    
                    try {
                        // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄËÆæÁΩÆ
                        state.globalSettings.fontUrl = fontUrl;
                        await db.globalSettings.put(state.globalSettings);
                        
                        // Â∫îÁî®Â≠ó‰Ωì
                        applyCustomFont(fontUrl, false);
                        
                        await showCustomAlert('ÊàêÂäü', 'Â≠ó‰ΩìÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
                    } catch (error) {
                        console.error('‰øùÂ≠òÂ≠ó‰ΩìÂ§±Ë¥•:', error);
                        alert('‰øùÂ≠òÂ≠ó‰ΩìÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                /**
                 * ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì
                 */
                async function resetToDefaultFont() {
                    try {
                        // Ê∏ÖÈô§ÂÖ®Â±ÄËÆæÁΩÆ‰∏≠ÁöÑÂ≠ó‰ΩìURL
                        state.globalSettings.fontUrl = '';
                        await db.globalSettings.put(state.globalSettings);
                        
                        // Ê∏ÖÈô§Â≠ó‰ΩìÊ†∑Âºè
                        const style = document.getElementById('dynamic-font-style');
                        if (style) {
                            style.textContent = '';
                        }
                        
                        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                        document.getElementById('font-url-input').value = '';
                        
                        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰ΩìÔºÅ');
                    } catch (error) {
                        console.error('ÊÅ¢Â§çÈªòËÆ§Â≠ó‰ΩìÂ§±Ë¥•:', error);
                        alert('ÊÅ¢Â§çÈªòËÆ§Â≠ó‰ΩìÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                // ‚ñ≤‚ñ≤‚ñ≤ Â≠ó‰ΩìËÆæÁΩÆÂäüËÉΩÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊñá‰ª∂Â§ÑÁêÜÂ∑•ÂÖ∑ÂáΩÊï∞ ‚ñº‚ñº‚ñº
                
                /**
                 * Â∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫base64
                 */
                function fileToBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    });
                }
                
                // ‚ñ≤‚ñ≤‚ñ≤ Êñá‰ª∂Â§ÑÁêÜÂ∑•ÂÖ∑ÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëJSONÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº
                
                /**
                 * ÂØºÂá∫JSONÁæéÂåñÈÖçÁΩÆ
                 */
                async function exportJsonBeautification() {
                    try {
                        // Êî∂ÈõÜÊâÄÊúâÂ§ñËßÇËÆæÁΩÆÊï∞ÊçÆ
                        const beautificationData = {
                            version: '1.0',
                            exportTime: new Date().toISOString(),
                            description: 'EPhoneÂ§ñËßÇÁæéÂåñÈÖçÁΩÆÊñá‰ª∂',
                            settings: {
                                wallpaper: state.globalSettings.wallpaper || '',
                                appIcons: state.globalSettings.appIcons || {},
                                globalCSS: state.globalSettings.globalCSS || '',
                                fontUrl: state.globalSettings.fontUrl || '',
                                fonts: await db.fonts.toArray() || []
                            }
                        };
                        
                        // ÂàõÂª∫JSONÊñá‰ª∂Âπ∂‰∏ãËΩΩ
                        const jsonString = JSON.stringify(beautificationData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `EPhoneÁæéÂåñÈÖçÁΩÆ_${new Date().toISOString().split('T')[0]}.json`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        await showCustomAlert('ÊàêÂäü', 'JSONÁæéÂåñÈÖçÁΩÆÂ∑≤ÂØºÂá∫ÔºÅ');
                        
                    } catch (error) {
                        console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                        alert('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                    }
                }
                
                /**
                 * ÂØºÂÖ•JSONÁæéÂåñÈÖçÁΩÆ
                 */
                async function importJsonBeautification() {
                    try {
                        // ÂàõÂª∫Êñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.json,application/json';
                        fileInput.style.display = 'none';
                        
                        fileInput.addEventListener('change', async (event) => {
                            const file = event.target.files[0];
                            if (!file) return;
                            
                            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
                            if (!file.name.toLowerCase().endsWith('.json')) {
                                alert('ËØ∑ÈÄâÊã©JSONÊñá‰ª∂ÔºÅ');
                                return;
                            }
                            
                            try {
                                // ‰ΩøÁî®FileReaderËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
                                const reader = new FileReader();
                                reader.onload = async (e) => {
                                    try {
                                        const text = e.target.result;
                                        const data = JSON.parse(text);
                                        
                                        // È™åËØÅJSONÊ†ºÂºè - Êõ¥ÂÆΩÊùæÁöÑÈ™åËØÅ
                                        if (!data || typeof data !== 'object') {
                                            alert('Êó†ÊïàÁöÑJSONÊñá‰ª∂Ê†ºÂºèÔºÅ');
                                            return;
                                        }
                                        
                                        // Ê£ÄÊü•ÊòØÂê¶ÊúâËÆæÁΩÆÊï∞ÊçÆÔºàÊîØÊåÅÂ§öÁßçÊ†ºÂºèÔºâ
                                        let settings = null;
                                        if (data.settings) {
                                            // Ê†áÂáÜÊ†ºÂºèÔºö{settings: {...}}
                                            settings = data.settings;
                                        } else if (data.wallpaper || data.appIcons || data.globalCSS || data.fontUrl) {
                                            // Áõ¥Êé•ÂåÖÂê´ËÆæÁΩÆÊï∞ÊçÆÁöÑÊ†ºÂºè
                                            settings = data;
                                        } else if (data.themeCss) {
                                            // ‰∏ªÈ¢òÊ†ºÂºèÔºö{themeName: "...", themeCss: "..."}
                                            settings = {
                                                globalCSS: data.themeCss,
                                                wallpaper: '',
                                                appIcons: {},
                                                fontUrl: '',
                                                fonts: []
                                            };
                                        } else {
                                            alert('Êó†ÊïàÁöÑJSONÁæéÂåñÈÖçÁΩÆÊñá‰ª∂ÔºÅËØ∑Á°Æ‰øùÊñá‰ª∂ÂåÖÂê´Â§ñËßÇËÆæÁΩÆÊï∞ÊçÆ„ÄÇ');
                                            return;
                                        }
                                        
                                        // Á°ÆËÆ§ÂØºÂÖ•
                                        let confirmMessage = 'ÂØºÂÖ•ÂêéÂ∞ÜË¶ÜÁõñÂΩìÂâçÁöÑÂ§ñËßÇËÆæÁΩÆÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü';
                                        if (data.themeName) {
                                            confirmMessage = `Âç≥Â∞ÜÂØºÂÖ•‰∏ªÈ¢ò"${data.themeName}"ÔºåËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÁöÑCSSÊ†∑ÂºèËÆæÁΩÆÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`;
                                        }
                                        
                                        const confirmed = await showCustomConfirm(
                                            'Á°ÆËÆ§ÂØºÂÖ•',
                                            confirmMessage,
                                            { confirmButtonClass: 'btn-primary' }
                                        );
                                        
                                        if (!confirmed) return;
                                        
                                        // ÂØºÂÖ•ËÆæÁΩÆ
                                        if (settings.wallpaper) {
                                            state.globalSettings.wallpaper = settings.wallpaper;
                                        }
                                        if (settings.appIcons) {
                                            state.globalSettings.appIcons = settings.appIcons;
                                        }
                                        if (settings.globalCSS) {
                                            state.globalSettings.globalCSS = settings.globalCSS;
                                        }
                                        if (settings.fontUrl) {
                                            state.globalSettings.fontUrl = settings.fontUrl;
                                        }
                                        
                                        // ÂØºÂÖ•Â≠ó‰Ωì
                                        if (settings.fonts && Array.isArray(settings.fonts)) {
                                            // Ê∏ÖÁ©∫Áé∞ÊúâÂ≠ó‰Ωì
                                            await db.fonts.clear();
                                            // ÂØºÂÖ•Êñ∞Â≠ó‰Ωì
                                            await db.fonts.bulkAdd(settings.fonts);
                                        }
                                        
                                        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                                        await db.globalSettings.put(state.globalSettings);
                                        
                                        // ‰øùÂ≠òJSONÈÖçÁΩÆÂà∞Êï∞ÊçÆÂ∫ì
                                        const configName = data.themeName || `ÂØºÂÖ•ÈÖçÁΩÆ_${new Date().toLocaleString()}`;
                                        console.log('ÂáÜÂ§á‰øùÂ≠òJSONÈÖçÁΩÆÂà∞Êï∞ÊçÆÂ∫ì:', configName);
                                        const configId = await db.jsonConfigs.add({
                                            name: configName,
                                            config: data,
                                            createdAt: Date.now()
                                        });
                                        console.log('JSONÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåID:', configId);
                                        
                                        // Â∫îÁî®ËÆæÁΩÆ - Âè™Êõ¥Êñ∞CSS
                                        if (settings.globalCSS) {
                                            // Áõ¥Êé•Êõ¥Êñ∞ÂÖ®Â±ÄCSSÊ†∑Âºè
                                            const styleElement = document.getElementById('global-css-style') || document.createElement('style');
                                            styleElement.id = 'global-css-style';
                                            styleElement.textContent = settings.globalCSS;
                                            if (!document.getElementById('global-css-style')) {
                                                document.head.appendChild(styleElement);
                                            }
                                        }
                                        
                                        // Êõ¥Êñ∞CSSËæìÂÖ•Ê°Ü
                                        document.getElementById('global-css-input').value = state.globalSettings.globalCSS || '';
                                        
                                        // Âà∑Êñ∞JSONÈÖçÁΩÆÂàóË°®
                                        await renderJsonConfigsList();
                                        
                                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                                        let successMessage = 'JSONÁæéÂåñÈÖçÁΩÆÂ∑≤ÂØºÂÖ•Âπ∂Â∫îÁî®ÔºÅ';
                                        if (data.themeName) {
                                            successMessage = `‰∏ªÈ¢ò"${data.themeName}"Â∑≤ÂØºÂÖ•Âπ∂Â∫îÁî®ÔºÅ`;
                                        }
                                        
                                        await showCustomAlert('ÊàêÂäü', successMessage);
                                        
                                    } catch (parseError) {
                                        console.error('JSONËß£ÊûêÂ§±Ë¥•:', parseError);
                                        console.error('ÈîôËØØËØ¶ÊÉÖ:', parseError.message);
                                        console.error('Êñá‰ª∂ÂÜÖÂÆπ:', text.substring(0, 200) + '...');
                                        alert(`JSONÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºö${parseError.message}\n\nËØ∑Ê£ÄÊü•Êñá‰ª∂ÂÜÖÂÆπÊòØÂê¶Ê≠£Á°ÆÔºÅ`);
                                    }
                                };
                                
                                reader.onerror = () => {
                                    alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                                };
                                
                                // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
                                reader.readAsText(file, 'UTF-8');
                                
                            } catch (error) {
                                console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                                alert('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÔºÅ');
                            }
                            
                            // Ê∏ÖÁêÜÊñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†
                            document.body.removeChild(fileInput);
                        });
                        
                        // Â∞ÜÊñá‰ª∂ËæìÂÖ•ÂÖÉÁ¥†Ê∑ªÂä†Âà∞È°µÈù¢Âπ∂Ëß¶ÂèëÁÇπÂáª
                        document.body.appendChild(fileInput);
                        fileInput.click();
                        
                    } catch (error) {
                        console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                        alert('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                    }
                }
                
                // ‚ñ≤‚ñ≤‚ñ≤ JSONÂØºÂÖ•ÂØºÂá∫ÂäüËÉΩÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëJSONÈÖçÁΩÆÂàóË°®ÁÆ°ÁêÜÂáΩÊï∞ ‚ñº‚ñº‚ñº
                
                /**
                 * Ê∏≤ÊüìJSONÈÖçÁΩÆÂàóË°®
                 */
                async function renderJsonConfigsList() {
                    try {
                        console.log('ÂºÄÂßãÊ∏≤ÊüìJSONÈÖçÁΩÆÂàóË°®...');
                        const configs = await db.jsonConfigs.orderBy('createdAt').reverse().toArray();
                        console.log('‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂà∞ÁöÑÈÖçÁΩÆÊï∞Èáè:', configs.length);
                        console.log('ÈÖçÁΩÆËØ¶ÊÉÖ:', configs);
                        
                        const container = document.getElementById('json-configs-list');
                        console.log('ÊâæÂà∞ÂÆπÂô®ÂÖÉÁ¥†:', container);
                        
                        if (!container) {
                            console.error('Êú™ÊâæÂà∞json-configs-listÂÆπÂô®ÂÖÉÁ¥†');
                            return;
                        }
                        
                        if (configs.length === 0) {
                            console.log('Ê≤°ÊúâÈÖçÁΩÆÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ');
                            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†‰øùÂ≠òÁöÑÈÖçÁΩÆ</div>';
                            return;
                        }
                        
                        container.innerHTML = configs.map(config => `
                            <div class="json-config-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; background: var(--secondary-bg);">
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">${config.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${new Date(config.createdAt).toLocaleString()}</div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="form-button form-button-secondary" onclick="applyJsonConfig(${config.id})" style="padding: 4px 8px; font-size: 12px;">Â∫îÁî®</button>
                                    <button class="form-button form-button-secondary" onclick="exportJsonConfig(${config.id})" style="padding: 4px 8px; font-size: 12px;">ÂØºÂá∫</button>
                                    <button class="form-button form-button-secondary" onclick="deleteJsonConfig(${config.id})" style="padding: 4px 8px; font-size: 12px; background: #ff6b6b; color: white;">Âà†Èô§</button>
                                </div>
                            </div>
                        `).join('');
                        
                    } catch (error) {
                        console.error('Ê∏≤ÊüìJSONÈÖçÁΩÆÂàóË°®Â§±Ë¥•:', error);
                    }
                }
                
                /**
                 * Â∫îÁî®JSONÈÖçÁΩÆ
                 */
                async function applyJsonConfig(configId) {
                    try {
                        const config = await db.jsonConfigs.get(configId);
                        if (!config) return;
                        
                        const data = config.config;
                        let settings = null;
                        
                        if (data.settings) {
                            settings = data.settings;
                        } else if (data.wallpaper || data.appIcons || data.globalCSS || data.fontUrl) {
                            settings = data;
                        } else if (data.themeCss) {
                            settings = {
                                globalCSS: data.themeCss,
                                wallpaper: '',
                                appIcons: {},
                                fontUrl: '',
                                fonts: []
                            };
                        }
                        
                        if (!settings) return;
                        
                        // Á°ÆËÆ§Â∫îÁî®
                        const confirmed = await showCustomConfirm(
                            'Á°ÆËÆ§Â∫îÁî®',
                            `Á°ÆÂÆöË¶ÅÂ∫îÁî®ÈÖçÁΩÆ"${config.name}"ÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÁöÑÂ§ñËßÇËÆæÁΩÆ„ÄÇ`,
                            { confirmButtonClass: 'btn-primary' }
                        );
                        
                        if (!confirmed) return;
                        
                        // Â∫îÁî®ËÆæÁΩÆ
                        if (settings.wallpaper) {
                            state.globalSettings.wallpaper = settings.wallpaper;
                        }
                        if (settings.appIcons) {
                            state.globalSettings.appIcons = settings.appIcons;
                        }
                        if (settings.globalCSS) {
                            state.globalSettings.globalCSS = settings.globalCSS;
                        }
                        if (settings.fontUrl) {
                            state.globalSettings.fontUrl = settings.fontUrl;
                        }
                        
                        // ÂØºÂÖ•Â≠ó‰Ωì
                        if (settings.fonts && Array.isArray(settings.fonts)) {
                            await db.fonts.clear();
                            await db.fonts.bulkAdd(settings.fonts);
                        }
                        
                        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                        await db.globalSettings.put(state.globalSettings);
                        
                        // Â∫îÁî®CSS
                        if (settings.globalCSS) {
                            const styleElement = document.getElementById('global-css-style') || document.createElement('style');
                            styleElement.id = 'global-css-style';
                            styleElement.textContent = settings.globalCSS;
                            if (!document.getElementById('global-css-style')) {
                                document.head.appendChild(styleElement);
                            }
                        }
                        
                        // Êõ¥Êñ∞CSSËæìÂÖ•Ê°Ü
                        document.getElementById('global-css-input').value = state.globalSettings.globalCSS || '';
                        
                        // Âà∑Êñ∞Â≠ó‰ΩìÂ∫ì
                        if (typeof renderFontLibrary === 'function') {
                            renderFontLibrary();
                        }
                        
                        await showCustomAlert('ÊàêÂäü', `ÈÖçÁΩÆ"${config.name}"Â∑≤Â∫îÁî®ÔºÅ`);
                        
                    } catch (error) {
                        console.error('Â∫îÁî®JSONÈÖçÁΩÆÂ§±Ë¥•:', error);
                        alert('Â∫îÁî®ÈÖçÁΩÆÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                /**
                 * ÂØºÂá∫JSONÈÖçÁΩÆ
                 */
                async function exportJsonConfig(configId) {
                    try {
                        const config = await db.jsonConfigs.get(configId);
                        if (!config) return;
                        
                        const jsonString = JSON.stringify(config.config, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${config.name}.json`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        await showCustomAlert('ÊàêÂäü', `ÈÖçÁΩÆ"${config.name}"Â∑≤ÂØºÂá∫ÔºÅ`);
                        
                    } catch (error) {
                        console.error('ÂØºÂá∫JSONÈÖçÁΩÆÂ§±Ë¥•:', error);
                        alert('ÂØºÂá∫ÈÖçÁΩÆÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                /**
                 * Âà†Èô§JSONÈÖçÁΩÆ
                 */
                async function deleteJsonConfig(configId) {
                    try {
                        const config = await db.jsonConfigs.get(configId);
                        if (!config) return;
                        
                        const confirmed = await showCustomConfirm(
                            'Á°ÆËÆ§Âà†Èô§',
                            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÖçÁΩÆ"${config.name}"ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`,
                            { confirmButtonClass: 'btn-danger' }
                        );
                        
                        if (!confirmed) return;
                        
                        await db.jsonConfigs.delete(configId);
                        await renderJsonConfigsList();
                        
                        await showCustomAlert('ÊàêÂäü', `ÈÖçÁΩÆ"${config.name}"Â∑≤Âà†Èô§ÔºÅ`);
                        
                    } catch (error) {
                        console.error('Âà†Èô§JSONÈÖçÁΩÆÂ§±Ë¥•:', error);
                        alert('Âà†Èô§ÈÖçÁΩÆÂ§±Ë¥•ÔºÅ');
                    }
                }
                
                // Â∞ÜÂáΩÊï∞Ê∑ªÂä†Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
                window.applyJsonConfig = applyJsonConfig;
                window.exportJsonConfig = exportJsonConfig;
                window.deleteJsonConfig = deleteJsonConfig;
                
                // ‚ñ≤‚ñ≤‚ñ≤ JSONÈÖçÁΩÆÂàóË°®ÁÆ°ÁêÜÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
        
                init();
            });
        
    </script>
    <div id="qzone-sticker-panel">
        <div id="qzone-sticker-grid"></div>
    </div>
    <div id="avatar-frame-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ÈÄâÊã©Â§¥ÂÉèÊ°Ü</span>
            </div>
            <div class="modal-body">
                <div class="frame-tabs">
                    <div id="ai-frame-tab" class="frame-tab active">ÂØπÊñπÁöÑ</div>
                    <div id="my-frame-tab" class="frame-tab">ÊàëÁöÑ</div>
                </div>
                <div id="ai-frame-content" class="frame-content">
                    <div id="ai-frame-grid" class="frame-grid">
                    </div>
                </div>
                <div id="my-frame-content" class="frame-content" style="display: none;">
                    <div id="my-frame-grid" class="frame-grid">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-frame-settings-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-frame-settings-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßíËâ≤Ê¥ûÂØüÂºπÁ™ó (V3 - ÁæéÂåñÁâà) ‚ñº‚ñº‚ñº -->
    <div id="character-profile-modal" class="modal">
        <div class="character-profile-content">
            <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßíËâ≤Ê¥ûÂØüÂºπÁ™ó (V3.1 - ÂõæÊ†áÁæéÂåñÁâà) ‚ñº‚ñº‚ñº -->
            <button id="profile-history-icon-btn" title="Êü•ÁúãÂéÜÂè≤ÂøÉÂ£∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
            </button>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊï¥ÂùóÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢ÊóßÁöÑ id="profile-main-content" ‚ñº‚ñº‚ñº -->
<div id="profile-main-content">
    <div class="profile-header">
        <img id="profile-avatar" src="">
        <div class="profile-info">
            <span id="profile-name"></span>
            <span id="profile-id"></span>
        </div>
    </div>

    <!-- ‚ÄúÂøÉÂ£∞‚ÄùÂç°ÁâáÁöÑÊñ∞ÁªìÊûÑ -->
    <div class="profile-section heart-voice">
        <div class="profile-section-header">
            <span class="profile-section-icon">üí≠</span>
            <label>ÂøÉÂ£∞</label>
        </div>
        <p id="profile-heartfelt-voice"></p>
    </div>

    <!-- ‚ÄúÊï£ËÆ∞‚ÄùÂç°ÁâáÁöÑÊñ∞ÁªìÊûÑ -->
    <div class="profile-section random-jottings">
        <div class="profile-section-header">
            <span class="profile-section-icon">üìå</span>
            <label>Êï£ËÆ∞</label>
        </div>
        <p id="profile-random-jottings"></p>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
            <!-- ÂéÜÂè≤ËÆ∞ÂΩïËßÜÂõæ (‰øùÊåÅ‰∏çÂèò) -->
            <div id="profile-thoughts-history-view" style="display: none;">
                <div class="profile-header" style="justify-content: space-between;">
                    <span style="font-size: 18px; font-weight: 600;">ÂøÉÂ£∞ËÆ∞ÂΩï</span>
                    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæéÂåñÂêéÁöÑËøîÂõûÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                    <button id="history-back-btn" title="ËøîÂõû">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                </div>
                <div id="thoughts-history-list">
                    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‚ÄúÊàëÁöÑ‚ÄùÂ§¥ÂÉèÂ∫ì‰∏ìÁî®Êñá‰ª∂‰∏ä‰º†ËæìÂÖ•Ê°Ü ‚ñº‚ñº‚ñº -->
    <input type="file" id="my-avatar-upload-input" accept="image/*" hidden>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØÈÄâÊã©Á§ºÁâ©Êé•Êî∂‰∫∫ÁöÑÂºπÁ™óÔºåËØ∑Á≤òË¥¥Âà∞ body Â∫ïÈÉ® ‚ñº‚ñº‚ñº -->
    <div id="gift-recipient-modal" class="modal">
        <div class="modal-content" style="height: 70%;">
            <div class="modal-header">
                <span>ÈÄâÊã©Êî∂Á§º‰∫∫</span>
                <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all-recipients"> ÂÖ®ÈÄâ </label>
            </div>
            <div class="modal-body" id="gift-recipient-list" style="padding: 0;">
                <!-- Áæ§ÊàêÂëòÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-gift-recipient-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-gift-recipient-btn">Á°ÆËÆ§ÈÄÅÂá∫</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËØ∑Áî®ËøôÊï¥Âùó‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ rendering-rules-screen ‚ñº‚ñº‚ñº -->
    <div id="rendering-rules-screen" class="screen">
        <div class="header">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <span>Ê∏≤ÊüìËßÑÂàô</span>
            <span class="action-btn" id="add-new-rule-btn">+</span>
        </div>
        <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂÖ®Êñ∞ÁöÑÈ°µÁ≠æÂíåÂÜÖÂÆπÂå∫ÁªìÊûÑ -->
        <div id="rules-tabs">
            <!-- JS ‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÈ°µÁ≠æ -->
        </div>
        <div id="rules-content-container">
            <!-- JS ‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂÜÖÂÆπÈù¢Êùø -->
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- 2. ËßÑÂàôÁºñËæëÂô®Ê®°ÊÄÅÊ°Ü -->
    <div id="rule-editor-modal" class="modal">
        <div class="modal-content" style="height: 85%;">
            <div class="modal-header">
                <span id="rule-editor-title">ÂàõÂª∫Êñ∞ËßÑÂàô</span>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-name-input">ËßÑÂàôÂêçÁß∞</label>
                    <input type="text" id="rule-name-input" placeholder="‰æãÂ¶ÇÔºöÁæéÂõ¢Â§ñÂçñÂç°Áâá">
                </div>
                <div class="form-group" style="flex-shrink: 0;">
                    <label for="rule-chat-id-select">ÁªëÂÆöËåÉÂõ¥</label>
                    <select id="rule-chat-id-select">
                        <option value="global">ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)</option>
                        <!-- ËßíËâ≤ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </select>
                </div>
                <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <label for="rule-regex-input">Ê≠£ÂàôË°®ËææÂºè (‰ΩøÁî®g‰Ωú‰∏∫Ê†áÂøó)</label>
                    <textarea id="rule-regex-input" rows="3" style="font-family: monospace; resize: vertical;" placeholder="‰æãÂ¶ÇÔºöMTR\[(.*?)\]\[(.*?)\|(.*?)\]"></textarea>
                </div>
                <div class="form-group" style="flex-grow: 2; display: flex; flex-direction: column;">
                    <label for="rule-template-input">HTML Ê®°Êùø (Áî® $1, $2 ÂºïÁî®)</label>
                    <textarea id="rule-template-input" rows="6" style="font-family: monospace; resize: vertical;" placeholder="‰æãÂ¶ÇÔºö<div class=`waimai-card`>...<span>$2</span>...</div>"></textarea>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                    <label for="rule-enabled-switch" style="margin-bottom: 0;">ÂêØÁî®ËßÑÂàô</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="rule-enabled-switch" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-rule-editor-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-rule-btn">‰øùÂ≠òËßÑÂàô</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™„ÄêÂÖ®Êñ∞ÁöÑ <audio> Ê†áÁ≠æ„ÄëÁ≤òË¥¥Âà∞ <body> Ê†áÁ≠æÁöÑÊúÄÊú´Â∞æÔºåÁ¥ßÈÇª </body> ‰πãÂâç ‚ñº‚ñº‚ñº -->
<audio id="notification-sound-player" preload="auto"></audio>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøôÊòØBGMÊêúÁ¥¢ÁªìÊûúÁöÑÂºπÁ™óÔºåËØ∑Á≤òË¥¥Âà∞bodyÊú´Â∞æ ‚ñº‚ñº‚ñº -->
<div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ÊêúÁ¥¢ÁªìÊûú</span>
        </div>
        <div class="modal-body" id="search-results-list" style="padding: 0;">
            <!-- ÊêúÁ¥¢ÁªìÊûúÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-music-search-btn" style="width: 100%;">ÂèñÊ∂à</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ≠ó‰ΩìÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
<div id="font-batch-import-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>Â≠ó‰ΩìÊâπÈáèÂØºÂÖ•</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label>ÂØºÂÖ•Ê†ºÂºèËØ¥Êòé</label>
                <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; color: #666;">
                    ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö<br>
                    <strong>Â≠ó‰ΩìÂêçÁß∞‚Äî‚ÄîÂ≠ó‰ΩìÈìæÊé•</strong><br><br>
                    Á§∫‰æãÔºö<br>
                    ÊÄùÊ∫êÈªë‰Ωì‚Äî‚Äîhttps://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap<br>
                    ÂæÆËΩØÈõÖÈªë‚Äî‚Äîhttps://fonts.googleapis.com/css2?family=Microsoft+YaHei&display=swap<br>
                    ÂÆã‰Ωì‚Äî‚Äîhttps://fonts.googleapis.com/css2?family=SimSun&display=swap
                </div>
            </div>
            <div class="form-group">
                <label for="font-batch-import-textarea">Â≠ó‰ΩìÊï∞ÊçÆ</label>
                <textarea id="font-batch-import-textarea" rows="10" style="width: 100%; font-family: monospace; resize: vertical;" placeholder="ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥Â≠ó‰ΩìÊï∞ÊçÆ..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-font-batch-import-btn">ÂèñÊ∂à</button>
            <button class="save" id="confirm-font-batch-import-btn">ÂºÄÂßãÂØºÂÖ•</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ Â≠ó‰ΩìÊâπÈáèÂØºÂÖ•Ê®°ÊÄÅÊ°ÜÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
</body>
</html>
